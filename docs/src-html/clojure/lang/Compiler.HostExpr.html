<!DOCTYPE HTML>
<html lang="en">
<head>
<title>Source code</title>
<link rel="stylesheet" type="text/css" href="../../../stylesheet.css" title="Style">
</head>
<body>
<main role="main">
<div class="sourceContainer">
<pre><span class="sourceLineNo">001</span><a id="line.1">/**</a>
<span class="sourceLineNo">002</span><a id="line.2"> *   Copyright (c) Rich Hickey. All rights reserved.</a>
<span class="sourceLineNo">003</span><a id="line.3"> *   The use and distribution terms for this software are covered by the</a>
<span class="sourceLineNo">004</span><a id="line.4"> *   Eclipse Public License 1.0 (http://opensource.org/licenses/eclipse-1.0.php)</a>
<span class="sourceLineNo">005</span><a id="line.5"> *   which can be found in the file epl-v10.html at the root of this distribution.</a>
<span class="sourceLineNo">006</span><a id="line.6"> *   By using this software in any fashion, you are agreeing to be bound by</a>
<span class="sourceLineNo">007</span><a id="line.7"> *       the terms of this license.</a>
<span class="sourceLineNo">008</span><a id="line.8"> *   You must not remove this notice, or any other, from this software.</a>
<span class="sourceLineNo">009</span><a id="line.9"> **/</a>
<span class="sourceLineNo">010</span><a id="line.10"></a>
<span class="sourceLineNo">011</span><a id="line.11">/* rich Aug 21, 2007 */</a>
<span class="sourceLineNo">012</span><a id="line.12"></a>
<span class="sourceLineNo">013</span><a id="line.13">package clojure.lang;</a>
<span class="sourceLineNo">014</span><a id="line.14"></a>
<span class="sourceLineNo">015</span><a id="line.15">//*</a>
<span class="sourceLineNo">016</span><a id="line.16"></a>
<span class="sourceLineNo">017</span><a id="line.17">import clojure.asm.*;</a>
<span class="sourceLineNo">018</span><a id="line.18">import clojure.asm.commons.GeneratorAdapter;</a>
<span class="sourceLineNo">019</span><a id="line.19">import clojure.asm.commons.Method;</a>
<span class="sourceLineNo">020</span><a id="line.20"></a>
<span class="sourceLineNo">021</span><a id="line.21">import java.io.*;</a>
<span class="sourceLineNo">022</span><a id="line.22">import java.lang.reflect.Constructor;</a>
<span class="sourceLineNo">023</span><a id="line.23">import java.lang.reflect.Modifier;</a>
<span class="sourceLineNo">024</span><a id="line.24">import java.util.*;</a>
<span class="sourceLineNo">025</span><a id="line.25">import java.util.regex.Pattern;</a>
<span class="sourceLineNo">026</span><a id="line.26">import java.util.regex.Matcher;</a>
<span class="sourceLineNo">027</span><a id="line.27"></a>
<span class="sourceLineNo">028</span><a id="line.28">//*/</a>
<span class="sourceLineNo">029</span><a id="line.29">/*</a>
<span class="sourceLineNo">030</span><a id="line.30"></a>
<span class="sourceLineNo">031</span><a id="line.31">import org.objectweb.asm.*;</a>
<span class="sourceLineNo">032</span><a id="line.32">import org.objectweb.asm.commons.Method;</a>
<span class="sourceLineNo">033</span><a id="line.33">import org.objectweb.asm.commons.GeneratorAdapter;</a>
<span class="sourceLineNo">034</span><a id="line.34">import org.objectweb.asm.util.TraceClassVisitor;</a>
<span class="sourceLineNo">035</span><a id="line.35">import org.objectweb.asm.util.CheckClassAdapter;</a>
<span class="sourceLineNo">036</span><a id="line.36">//*/</a>
<span class="sourceLineNo">037</span><a id="line.37"></a>
<span class="sourceLineNo">038</span><a id="line.38">public class Compiler implements Opcodes{</a>
<span class="sourceLineNo">039</span><a id="line.39"></a>
<span class="sourceLineNo">040</span><a id="line.40">static final Symbol DEF = Symbol.intern("def");</a>
<span class="sourceLineNo">041</span><a id="line.41">static final Symbol LOOP = Symbol.intern("loop*");</a>
<span class="sourceLineNo">042</span><a id="line.42">static final Symbol RECUR = Symbol.intern("recur");</a>
<span class="sourceLineNo">043</span><a id="line.43">static final Symbol IF = Symbol.intern("if");</a>
<span class="sourceLineNo">044</span><a id="line.44">static final Symbol LET = Symbol.intern("let*");</a>
<span class="sourceLineNo">045</span><a id="line.45">static final Symbol LETFN = Symbol.intern("letfn*");</a>
<span class="sourceLineNo">046</span><a id="line.46">static final Symbol DO = Symbol.intern("do");</a>
<span class="sourceLineNo">047</span><a id="line.47">static final Symbol FN = Symbol.intern("fn*");</a>
<span class="sourceLineNo">048</span><a id="line.48">static final Symbol FNONCE = (Symbol) Symbol.intern("fn*").withMeta(RT.map(Keyword.intern(null, "once"), RT.T));</a>
<span class="sourceLineNo">049</span><a id="line.49">static final Symbol QUOTE = Symbol.intern("quote");</a>
<span class="sourceLineNo">050</span><a id="line.50">static final Symbol THE_VAR = Symbol.intern("var");</a>
<span class="sourceLineNo">051</span><a id="line.51">static final Symbol DOT = Symbol.intern(".");</a>
<span class="sourceLineNo">052</span><a id="line.52">static final Symbol ASSIGN = Symbol.intern("set!");</a>
<span class="sourceLineNo">053</span><a id="line.53">//static final Symbol TRY_FINALLY = Symbol.intern("try-finally");</a>
<span class="sourceLineNo">054</span><a id="line.54">static final Symbol TRY = Symbol.intern("try");</a>
<span class="sourceLineNo">055</span><a id="line.55">static final Symbol CATCH = Symbol.intern("catch");</a>
<span class="sourceLineNo">056</span><a id="line.56">static final Symbol FINALLY = Symbol.intern("finally");</a>
<span class="sourceLineNo">057</span><a id="line.57">static final Symbol THROW = Symbol.intern("throw");</a>
<span class="sourceLineNo">058</span><a id="line.58">static final Symbol MONITOR_ENTER = Symbol.intern("monitor-enter");</a>
<span class="sourceLineNo">059</span><a id="line.59">static final Symbol MONITOR_EXIT = Symbol.intern("monitor-exit");</a>
<span class="sourceLineNo">060</span><a id="line.60">static final Symbol IMPORT = Symbol.intern("clojure.core", "import*");</a>
<span class="sourceLineNo">061</span><a id="line.61">//static final Symbol INSTANCE = Symbol.intern("instance?");</a>
<span class="sourceLineNo">062</span><a id="line.62">static final Symbol DEFTYPE = Symbol.intern("deftype*");</a>
<span class="sourceLineNo">063</span><a id="line.63">static final Symbol CASE = Symbol.intern("case*");</a>
<span class="sourceLineNo">064</span><a id="line.64"></a>
<span class="sourceLineNo">065</span><a id="line.65">//static final Symbol THISFN = Symbol.intern("thisfn");</a>
<span class="sourceLineNo">066</span><a id="line.66">static final Symbol CLASS = Symbol.intern("Class");</a>
<span class="sourceLineNo">067</span><a id="line.67">static final Symbol NEW = Symbol.intern("new");</a>
<span class="sourceLineNo">068</span><a id="line.68">static final Symbol THIS = Symbol.intern("this");</a>
<span class="sourceLineNo">069</span><a id="line.69">static final Symbol REIFY = Symbol.intern("reify*");</a>
<span class="sourceLineNo">070</span><a id="line.70">//static final Symbol UNQUOTE = Symbol.intern("unquote");</a>
<span class="sourceLineNo">071</span><a id="line.71">//static final Symbol UNQUOTE_SPLICING = Symbol.intern("unquote-splicing");</a>
<span class="sourceLineNo">072</span><a id="line.72">//static final Symbol SYNTAX_QUOTE = Symbol.intern("clojure.core", "syntax-quote");</a>
<span class="sourceLineNo">073</span><a id="line.73">static final Symbol LIST = Symbol.intern("clojure.core", "list");</a>
<span class="sourceLineNo">074</span><a id="line.74">static final Symbol HASHMAP = Symbol.intern("clojure.core", "hash-map");</a>
<span class="sourceLineNo">075</span><a id="line.75">static final Symbol VECTOR = Symbol.intern("clojure.core", "vector");</a>
<span class="sourceLineNo">076</span><a id="line.76">static final Symbol IDENTITY = Symbol.intern("clojure.core", "identity");</a>
<span class="sourceLineNo">077</span><a id="line.77"></a>
<span class="sourceLineNo">078</span><a id="line.78">static final Symbol _AMP_ = Symbol.intern("&amp;");</a>
<span class="sourceLineNo">079</span><a id="line.79">static final Symbol ISEQ = Symbol.intern("clojure.lang.ISeq");</a>
<span class="sourceLineNo">080</span><a id="line.80"></a>
<span class="sourceLineNo">081</span><a id="line.81">static final Keyword loadNs = Keyword.intern(null, "load-ns");</a>
<span class="sourceLineNo">082</span><a id="line.82">static final Keyword inlineKey = Keyword.intern(null, "inline");</a>
<span class="sourceLineNo">083</span><a id="line.83">static final Keyword inlineAritiesKey = Keyword.intern(null, "inline-arities");</a>
<span class="sourceLineNo">084</span><a id="line.84">static final Keyword staticKey = Keyword.intern(null, "static");</a>
<span class="sourceLineNo">085</span><a id="line.85">static final Keyword arglistsKey = Keyword.intern(null, "arglists");</a>
<span class="sourceLineNo">086</span><a id="line.86">static final Symbol INVOKE_STATIC = Symbol.intern("invokeStatic");</a>
<span class="sourceLineNo">087</span><a id="line.87"></a>
<span class="sourceLineNo">088</span><a id="line.88">static final Keyword volatileKey = Keyword.intern(null, "volatile");</a>
<span class="sourceLineNo">089</span><a id="line.89">static final Keyword implementsKey = Keyword.intern(null, "implements");</a>
<span class="sourceLineNo">090</span><a id="line.90">static final String COMPILE_STUB_PREFIX = "compile__stub";</a>
<span class="sourceLineNo">091</span><a id="line.91"></a>
<span class="sourceLineNo">092</span><a id="line.92">static final Keyword protocolKey = Keyword.intern(null, "protocol");</a>
<span class="sourceLineNo">093</span><a id="line.93">static final Keyword onKey = Keyword.intern(null, "on");</a>
<span class="sourceLineNo">094</span><a id="line.94">static Keyword dynamicKey = Keyword.intern("dynamic");</a>
<span class="sourceLineNo">095</span><a id="line.95">static final Keyword redefKey = Keyword.intern(null, "redef");</a>
<span class="sourceLineNo">096</span><a id="line.96"></a>
<span class="sourceLineNo">097</span><a id="line.97">static final Symbol NS = Symbol.intern("ns");</a>
<span class="sourceLineNo">098</span><a id="line.98">static final Symbol IN_NS = Symbol.intern("in-ns");</a>
<span class="sourceLineNo">099</span><a id="line.99"></a>
<span class="sourceLineNo">100</span><a id="line.100">//static final Symbol IMPORT = Symbol.intern("import");</a>
<span class="sourceLineNo">101</span><a id="line.101">//static final Symbol USE = Symbol.intern("use");</a>
<span class="sourceLineNo">102</span><a id="line.102"></a>
<span class="sourceLineNo">103</span><a id="line.103">//static final Symbol IFN = Symbol.intern("clojure.lang", "IFn");</a>
<span class="sourceLineNo">104</span><a id="line.104"></a>
<span class="sourceLineNo">105</span><a id="line.105">static final public IPersistentMap specials = PersistentHashMap.create(</a>
<span class="sourceLineNo">106</span><a id="line.106">                DEF, new DefExpr.Parser(),</a>
<span class="sourceLineNo">107</span><a id="line.107">                LOOP, new LetExpr.Parser(),</a>
<span class="sourceLineNo">108</span><a id="line.108">                RECUR, new RecurExpr.Parser(),</a>
<span class="sourceLineNo">109</span><a id="line.109">                IF, new IfExpr.Parser(),</a>
<span class="sourceLineNo">110</span><a id="line.110">                CASE, new CaseExpr.Parser(),</a>
<span class="sourceLineNo">111</span><a id="line.111">                LET, new LetExpr.Parser(),</a>
<span class="sourceLineNo">112</span><a id="line.112">                LETFN, new LetFnExpr.Parser(),</a>
<span class="sourceLineNo">113</span><a id="line.113">                DO, new BodyExpr.Parser(),</a>
<span class="sourceLineNo">114</span><a id="line.114">                FN, null,</a>
<span class="sourceLineNo">115</span><a id="line.115">                QUOTE, new ConstantExpr.Parser(),</a>
<span class="sourceLineNo">116</span><a id="line.116">                THE_VAR, new TheVarExpr.Parser(),</a>
<span class="sourceLineNo">117</span><a id="line.117">                IMPORT, new ImportExpr.Parser(),</a>
<span class="sourceLineNo">118</span><a id="line.118">                DOT, new HostExpr.Parser(),</a>
<span class="sourceLineNo">119</span><a id="line.119">                ASSIGN, new AssignExpr.Parser(),</a>
<span class="sourceLineNo">120</span><a id="line.120">                DEFTYPE, new NewInstanceExpr.DeftypeParser(),</a>
<span class="sourceLineNo">121</span><a id="line.121">                REIFY, new NewInstanceExpr.ReifyParser(),</a>
<span class="sourceLineNo">122</span><a id="line.122">//              TRY_FINALLY, new TryFinallyExpr.Parser(),</a>
<span class="sourceLineNo">123</span><a id="line.123">TRY, new TryExpr.Parser(),</a>
<span class="sourceLineNo">124</span><a id="line.124">THROW, new ThrowExpr.Parser(),</a>
<span class="sourceLineNo">125</span><a id="line.125">MONITOR_ENTER, new MonitorEnterExpr.Parser(),</a>
<span class="sourceLineNo">126</span><a id="line.126">MONITOR_EXIT, new MonitorExitExpr.Parser(),</a>
<span class="sourceLineNo">127</span><a id="line.127">//              INSTANCE, new InstanceExpr.Parser(),</a>
<span class="sourceLineNo">128</span><a id="line.128">//              IDENTICAL, new IdenticalExpr.Parser(),</a>
<span class="sourceLineNo">129</span><a id="line.129">//THISFN, null,</a>
<span class="sourceLineNo">130</span><a id="line.130">CATCH, null,</a>
<span class="sourceLineNo">131</span><a id="line.131">FINALLY, null,</a>
<span class="sourceLineNo">132</span><a id="line.132">//              CLASS, new ClassExpr.Parser(),</a>
<span class="sourceLineNo">133</span><a id="line.133">NEW, new NewExpr.Parser(),</a>
<span class="sourceLineNo">134</span><a id="line.134">//              UNQUOTE, null,</a>
<span class="sourceLineNo">135</span><a id="line.135">//              UNQUOTE_SPLICING, null,</a>
<span class="sourceLineNo">136</span><a id="line.136">//              SYNTAX_QUOTE, null,</a>
<span class="sourceLineNo">137</span><a id="line.137">_AMP_, null</a>
<span class="sourceLineNo">138</span><a id="line.138">);</a>
<span class="sourceLineNo">139</span><a id="line.139"></a>
<span class="sourceLineNo">140</span><a id="line.140">private static final int MAX_POSITIONAL_ARITY = 20;</a>
<span class="sourceLineNo">141</span><a id="line.141">private static final Type OBJECT_TYPE;</a>
<span class="sourceLineNo">142</span><a id="line.142">private static final Type KEYWORD_TYPE = Type.getType(Keyword.class);</a>
<span class="sourceLineNo">143</span><a id="line.143">private static final Type VAR_TYPE = Type.getType(Var.class);</a>
<span class="sourceLineNo">144</span><a id="line.144">private static final Type SYMBOL_TYPE = Type.getType(Symbol.class);</a>
<span class="sourceLineNo">145</span><a id="line.145">//private static final Type NUM_TYPE = Type.getType(Num.class);</a>
<span class="sourceLineNo">146</span><a id="line.146">private static final Type IFN_TYPE = Type.getType(IFn.class);</a>
<span class="sourceLineNo">147</span><a id="line.147">private static final Type AFUNCTION_TYPE = Type.getType(AFunction.class);</a>
<span class="sourceLineNo">148</span><a id="line.148">private static final Type RT_TYPE = Type.getType(RT.class);</a>
<span class="sourceLineNo">149</span><a id="line.149">private static final Type NUMBERS_TYPE = Type.getType(Numbers.class);</a>
<span class="sourceLineNo">150</span><a id="line.150">final static Type CLASS_TYPE = Type.getType(Class.class);</a>
<span class="sourceLineNo">151</span><a id="line.151">final static Type NS_TYPE = Type.getType(Namespace.class);</a>
<span class="sourceLineNo">152</span><a id="line.152">final static Type UTIL_TYPE = Type.getType(Util.class);</a>
<span class="sourceLineNo">153</span><a id="line.153">final static Type REFLECTOR_TYPE = Type.getType(Reflector.class);</a>
<span class="sourceLineNo">154</span><a id="line.154">final static Type THROWABLE_TYPE = Type.getType(Throwable.class);</a>
<span class="sourceLineNo">155</span><a id="line.155">final static Type BOOLEAN_OBJECT_TYPE = Type.getType(Boolean.class);</a>
<span class="sourceLineNo">156</span><a id="line.156">final static Type IPERSISTENTMAP_TYPE = Type.getType(IPersistentMap.class);</a>
<span class="sourceLineNo">157</span><a id="line.157">final static Type IOBJ_TYPE = Type.getType(IObj.class);</a>
<span class="sourceLineNo">158</span><a id="line.158">final static Type TUPLE_TYPE = Type.getType(Tuple.class);</a>
<span class="sourceLineNo">159</span><a id="line.159">final static Method createTupleMethods[] = {Method.getMethod("clojure.lang.IPersistentVector create()"),</a>
<span class="sourceLineNo">160</span><a id="line.160">        Method.getMethod("clojure.lang.IPersistentVector create(Object)"),</a>
<span class="sourceLineNo">161</span><a id="line.161">        Method.getMethod("clojure.lang.IPersistentVector create(Object,Object)"),</a>
<span class="sourceLineNo">162</span><a id="line.162">        Method.getMethod("clojure.lang.IPersistentVector create(Object,Object,Object)"),</a>
<span class="sourceLineNo">163</span><a id="line.163">        Method.getMethod("clojure.lang.IPersistentVector create(Object,Object,Object,Object)"),</a>
<span class="sourceLineNo">164</span><a id="line.164">        Method.getMethod("clojure.lang.IPersistentVector create(Object,Object,Object,Object,Object)"),</a>
<span class="sourceLineNo">165</span><a id="line.165">        Method.getMethod("clojure.lang.IPersistentVector create(Object,Object,Object,Object,Object,Object)")</a>
<span class="sourceLineNo">166</span><a id="line.166">};</a>
<span class="sourceLineNo">167</span><a id="line.167"></a>
<span class="sourceLineNo">168</span><a id="line.168">private static final Type[][] ARG_TYPES;</a>
<span class="sourceLineNo">169</span><a id="line.169">//private static final Type[] EXCEPTION_TYPES = {Type.getType(Exception.class)};</a>
<span class="sourceLineNo">170</span><a id="line.170">private static final Type[] EXCEPTION_TYPES = {};</a>
<span class="sourceLineNo">171</span><a id="line.171"></a>
<span class="sourceLineNo">172</span><a id="line.172">static</a>
<span class="sourceLineNo">173</span><a id="line.173">        {</a>
<span class="sourceLineNo">174</span><a id="line.174">        OBJECT_TYPE = Type.getType(Object.class);</a>
<span class="sourceLineNo">175</span><a id="line.175">        ARG_TYPES = new Type[MAX_POSITIONAL_ARITY + 2][];</a>
<span class="sourceLineNo">176</span><a id="line.176">        for(int i = 0; i &lt;= MAX_POSITIONAL_ARITY; ++i)</a>
<span class="sourceLineNo">177</span><a id="line.177">                {</a>
<span class="sourceLineNo">178</span><a id="line.178">                Type[] a = new Type[i];</a>
<span class="sourceLineNo">179</span><a id="line.179">                for(int j = 0; j &lt; i; j++)</a>
<span class="sourceLineNo">180</span><a id="line.180">                        a[j] = OBJECT_TYPE;</a>
<span class="sourceLineNo">181</span><a id="line.181">                ARG_TYPES[i] = a;</a>
<span class="sourceLineNo">182</span><a id="line.182">                }</a>
<span class="sourceLineNo">183</span><a id="line.183">        Type[] a = new Type[MAX_POSITIONAL_ARITY + 1];</a>
<span class="sourceLineNo">184</span><a id="line.184">        for(int j = 0; j &lt; MAX_POSITIONAL_ARITY; j++)</a>
<span class="sourceLineNo">185</span><a id="line.185">                a[j] = OBJECT_TYPE;</a>
<span class="sourceLineNo">186</span><a id="line.186">        a[MAX_POSITIONAL_ARITY] = Type.getType("[Ljava/lang/Object;");</a>
<span class="sourceLineNo">187</span><a id="line.187">        ARG_TYPES[MAX_POSITIONAL_ARITY + 1] = a;</a>
<span class="sourceLineNo">188</span><a id="line.188"></a>
<span class="sourceLineNo">189</span><a id="line.189"></a>
<span class="sourceLineNo">190</span><a id="line.190">        }</a>
<span class="sourceLineNo">191</span><a id="line.191"></a>
<span class="sourceLineNo">192</span><a id="line.192"></a>
<span class="sourceLineNo">193</span><a id="line.193">//symbol-&gt;localbinding</a>
<span class="sourceLineNo">194</span><a id="line.194">static final public Var LOCAL_ENV = Var.create(null).setDynamic();</a>
<span class="sourceLineNo">195</span><a id="line.195"></a>
<span class="sourceLineNo">196</span><a id="line.196">//vector&lt;localbinding&gt;</a>
<span class="sourceLineNo">197</span><a id="line.197">static final public Var LOOP_LOCALS = Var.create().setDynamic();</a>
<span class="sourceLineNo">198</span><a id="line.198"></a>
<span class="sourceLineNo">199</span><a id="line.199">//Label</a>
<span class="sourceLineNo">200</span><a id="line.200">static final public Var LOOP_LABEL = Var.create().setDynamic();</a>
<span class="sourceLineNo">201</span><a id="line.201"></a>
<span class="sourceLineNo">202</span><a id="line.202">//vector&lt;object&gt;</a>
<span class="sourceLineNo">203</span><a id="line.203">static final public Var CONSTANTS = Var.create().setDynamic();</a>
<span class="sourceLineNo">204</span><a id="line.204"></a>
<span class="sourceLineNo">205</span><a id="line.205">//IdentityHashMap</a>
<span class="sourceLineNo">206</span><a id="line.206">static final public Var CONSTANT_IDS = Var.create().setDynamic();</a>
<span class="sourceLineNo">207</span><a id="line.207"></a>
<span class="sourceLineNo">208</span><a id="line.208">//vector&lt;keyword&gt;</a>
<span class="sourceLineNo">209</span><a id="line.209">static final public Var KEYWORD_CALLSITES = Var.create().setDynamic();</a>
<span class="sourceLineNo">210</span><a id="line.210"></a>
<span class="sourceLineNo">211</span><a id="line.211">//vector&lt;var&gt;</a>
<span class="sourceLineNo">212</span><a id="line.212">static final public Var PROTOCOL_CALLSITES = Var.create().setDynamic();</a>
<span class="sourceLineNo">213</span><a id="line.213"></a>
<span class="sourceLineNo">214</span><a id="line.214">//set&lt;var&gt;</a>
<span class="sourceLineNo">215</span><a id="line.215">static final public Var VAR_CALLSITES = Var.create().setDynamic();</a>
<span class="sourceLineNo">216</span><a id="line.216"></a>
<span class="sourceLineNo">217</span><a id="line.217">//keyword-&gt;constid</a>
<span class="sourceLineNo">218</span><a id="line.218">static final public Var KEYWORDS = Var.create().setDynamic();</a>
<span class="sourceLineNo">219</span><a id="line.219"></a>
<span class="sourceLineNo">220</span><a id="line.220">//var-&gt;constid</a>
<span class="sourceLineNo">221</span><a id="line.221">static final public Var VARS = Var.create().setDynamic();</a>
<span class="sourceLineNo">222</span><a id="line.222"></a>
<span class="sourceLineNo">223</span><a id="line.223">//FnFrame</a>
<span class="sourceLineNo">224</span><a id="line.224">static final public Var METHOD = Var.create(null).setDynamic();</a>
<span class="sourceLineNo">225</span><a id="line.225"></a>
<span class="sourceLineNo">226</span><a id="line.226">//null or not</a>
<span class="sourceLineNo">227</span><a id="line.227">static final public Var IN_CATCH_FINALLY = Var.create(null).setDynamic();</a>
<span class="sourceLineNo">228</span><a id="line.228"></a>
<span class="sourceLineNo">229</span><a id="line.229">static final public Var METHOD_RETURN_CONTEXT = Var.create(null).setDynamic();</a>
<span class="sourceLineNo">230</span><a id="line.230"></a>
<span class="sourceLineNo">231</span><a id="line.231">static final public Var NO_RECUR = Var.create(null).setDynamic();</a>
<span class="sourceLineNo">232</span><a id="line.232"></a>
<span class="sourceLineNo">233</span><a id="line.233">//DynamicClassLoader</a>
<span class="sourceLineNo">234</span><a id="line.234">static final public Var LOADER = Var.create().setDynamic();</a>
<span class="sourceLineNo">235</span><a id="line.235"></a>
<span class="sourceLineNo">236</span><a id="line.236">//String</a>
<span class="sourceLineNo">237</span><a id="line.237">static final public Var SOURCE = Var.intern(Namespace.findOrCreate(Symbol.intern("clojure.core")),</a>
<span class="sourceLineNo">238</span><a id="line.238">                                            Symbol.intern("*source-path*"), "NO_SOURCE_FILE").setDynamic();</a>
<span class="sourceLineNo">239</span><a id="line.239"></a>
<span class="sourceLineNo">240</span><a id="line.240">//String</a>
<span class="sourceLineNo">241</span><a id="line.241">static final public Var SOURCE_PATH = Var.intern(Namespace.findOrCreate(Symbol.intern("clojure.core")),</a>
<span class="sourceLineNo">242</span><a id="line.242">                                                 Symbol.intern("*file*"), "NO_SOURCE_PATH").setDynamic();</a>
<span class="sourceLineNo">243</span><a id="line.243"></a>
<span class="sourceLineNo">244</span><a id="line.244">//String</a>
<span class="sourceLineNo">245</span><a id="line.245">static final public Var COMPILE_PATH = Var.intern(Namespace.findOrCreate(Symbol.intern("clojure.core")),</a>
<span class="sourceLineNo">246</span><a id="line.246">                                                  Symbol.intern("*compile-path*"), null).setDynamic();</a>
<span class="sourceLineNo">247</span><a id="line.247">//boolean</a>
<span class="sourceLineNo">248</span><a id="line.248">static final public Var COMPILE_FILES = Var.intern(Namespace.findOrCreate(Symbol.intern("clojure.core")),</a>
<span class="sourceLineNo">249</span><a id="line.249">                                                   Symbol.intern("*compile-files*"), Boolean.FALSE).setDynamic();</a>
<span class="sourceLineNo">250</span><a id="line.250"></a>
<span class="sourceLineNo">251</span><a id="line.251">static final public Var INSTANCE = Var.intern(Namespace.findOrCreate(Symbol.intern("clojure.core")),</a>
<span class="sourceLineNo">252</span><a id="line.252">                                              Symbol.intern("instance?"));</a>
<span class="sourceLineNo">253</span><a id="line.253"></a>
<span class="sourceLineNo">254</span><a id="line.254">static final public Var ADD_ANNOTATIONS = Var.intern(Namespace.findOrCreate(Symbol.intern("clojure.core")),</a>
<span class="sourceLineNo">255</span><a id="line.255">                                            Symbol.intern("add-annotations"));</a>
<span class="sourceLineNo">256</span><a id="line.256"></a>
<span class="sourceLineNo">257</span><a id="line.257">static final public Keyword disableLocalsClearingKey = Keyword.intern("disable-locals-clearing");</a>
<span class="sourceLineNo">258</span><a id="line.258">static final public Keyword directLinkingKey = Keyword.intern("direct-linking");</a>
<span class="sourceLineNo">259</span><a id="line.259">static final public Keyword elideMetaKey = Keyword.intern("elide-meta");</a>
<span class="sourceLineNo">260</span><a id="line.260"></a>
<span class="sourceLineNo">261</span><a id="line.261">static final public Var COMPILER_OPTIONS;</a>
<span class="sourceLineNo">262</span><a id="line.262"></a>
<span class="sourceLineNo">263</span><a id="line.263">static public Object getCompilerOption(Keyword k){</a>
<span class="sourceLineNo">264</span><a id="line.264">        return RT.get(COMPILER_OPTIONS.deref(),k);</a>
<span class="sourceLineNo">265</span><a id="line.265">}</a>
<span class="sourceLineNo">266</span><a id="line.266"></a>
<span class="sourceLineNo">267</span><a id="line.267">    static</a>
<span class="sourceLineNo">268</span><a id="line.268">    {</a>
<span class="sourceLineNo">269</span><a id="line.269">        Object compilerOptions = null;</a>
<span class="sourceLineNo">270</span><a id="line.270"></a>
<span class="sourceLineNo">271</span><a id="line.271">        for (Map.Entry e : System.getProperties().entrySet())</a>
<span class="sourceLineNo">272</span><a id="line.272">        {</a>
<span class="sourceLineNo">273</span><a id="line.273">            String name = (String) e.getKey();</a>
<span class="sourceLineNo">274</span><a id="line.274">            String v = (String) e.getValue();</a>
<span class="sourceLineNo">275</span><a id="line.275">            if (name.startsWith("clojure.compiler."))</a>
<span class="sourceLineNo">276</span><a id="line.276">            {</a>
<span class="sourceLineNo">277</span><a id="line.277">                compilerOptions = RT.assoc(compilerOptions,</a>
<span class="sourceLineNo">278</span><a id="line.278">                        RT.keyword(null, name.substring(1 + name.lastIndexOf('.'))),</a>
<span class="sourceLineNo">279</span><a id="line.279">                        RT.readString(v));</a>
<span class="sourceLineNo">280</span><a id="line.280">            }</a>
<span class="sourceLineNo">281</span><a id="line.281">        }</a>
<span class="sourceLineNo">282</span><a id="line.282"></a>
<span class="sourceLineNo">283</span><a id="line.283">        COMPILER_OPTIONS = Var.intern(Namespace.findOrCreate(Symbol.intern("clojure.core")),</a>
<span class="sourceLineNo">284</span><a id="line.284">                Symbol.intern("*compiler-options*"), compilerOptions).setDynamic();</a>
<span class="sourceLineNo">285</span><a id="line.285">    }</a>
<span class="sourceLineNo">286</span><a id="line.286"></a>
<span class="sourceLineNo">287</span><a id="line.287">    static Object elideMeta(Object m){</a>
<span class="sourceLineNo">288</span><a id="line.288">        Collection&lt;Object&gt; elides = (Collection&lt;Object&gt;) getCompilerOption(elideMetaKey);</a>
<span class="sourceLineNo">289</span><a id="line.289">        if(elides != null)</a>
<span class="sourceLineNo">290</span><a id="line.290">            {</a>
<span class="sourceLineNo">291</span><a id="line.291">            for(Object k : elides)</a>
<span class="sourceLineNo">292</span><a id="line.292">                {</a>
<span class="sourceLineNo">293</span><a id="line.293">//                System.out.println("Eliding:" + k + " : " + RT.get(m, k));</a>
<span class="sourceLineNo">294</span><a id="line.294">                m = RT.dissoc(m, k);</a>
<span class="sourceLineNo">295</span><a id="line.295">                }</a>
<span class="sourceLineNo">296</span><a id="line.296">//            System.out.println("Remaining: " + RT.keys(m));</a>
<span class="sourceLineNo">297</span><a id="line.297">            }</a>
<span class="sourceLineNo">298</span><a id="line.298">        return m;</a>
<span class="sourceLineNo">299</span><a id="line.299">    }</a>
<span class="sourceLineNo">300</span><a id="line.300"></a>
<span class="sourceLineNo">301</span><a id="line.301">//Integer</a>
<span class="sourceLineNo">302</span><a id="line.302">static final public Var LINE = Var.create(0).setDynamic();</a>
<span class="sourceLineNo">303</span><a id="line.303">static final public Var COLUMN = Var.create(0).setDynamic();</a>
<span class="sourceLineNo">304</span><a id="line.304"></a>
<span class="sourceLineNo">305</span><a id="line.305">static int lineDeref(){</a>
<span class="sourceLineNo">306</span><a id="line.306">        return ((Number)LINE.deref()).intValue();</a>
<span class="sourceLineNo">307</span><a id="line.307">}</a>
<span class="sourceLineNo">308</span><a id="line.308"></a>
<span class="sourceLineNo">309</span><a id="line.309">static int columnDeref(){</a>
<span class="sourceLineNo">310</span><a id="line.310">        return ((Number)COLUMN.deref()).intValue();</a>
<span class="sourceLineNo">311</span><a id="line.311">}</a>
<span class="sourceLineNo">312</span><a id="line.312"></a>
<span class="sourceLineNo">313</span><a id="line.313">//Integer</a>
<span class="sourceLineNo">314</span><a id="line.314">static final public Var LINE_BEFORE = Var.create(0).setDynamic();</a>
<span class="sourceLineNo">315</span><a id="line.315">static final public Var COLUMN_BEFORE = Var.create(0).setDynamic();</a>
<span class="sourceLineNo">316</span><a id="line.316">static final public Var LINE_AFTER = Var.create(0).setDynamic();</a>
<span class="sourceLineNo">317</span><a id="line.317">static final public Var COLUMN_AFTER = Var.create(0).setDynamic();</a>
<span class="sourceLineNo">318</span><a id="line.318"></a>
<span class="sourceLineNo">319</span><a id="line.319">//Integer</a>
<span class="sourceLineNo">320</span><a id="line.320">static final public Var NEXT_LOCAL_NUM = Var.create(0).setDynamic();</a>
<span class="sourceLineNo">321</span><a id="line.321"></a>
<span class="sourceLineNo">322</span><a id="line.322">//Integer</a>
<span class="sourceLineNo">323</span><a id="line.323">static final public Var RET_LOCAL_NUM = Var.create().setDynamic();</a>
<span class="sourceLineNo">324</span><a id="line.324"></a>
<span class="sourceLineNo">325</span><a id="line.325"></a>
<span class="sourceLineNo">326</span><a id="line.326">static final public Var COMPILE_STUB_SYM = Var.create(null).setDynamic();</a>
<span class="sourceLineNo">327</span><a id="line.327">static final public Var COMPILE_STUB_CLASS = Var.create(null).setDynamic();</a>
<span class="sourceLineNo">328</span><a id="line.328"></a>
<span class="sourceLineNo">329</span><a id="line.329"></a>
<span class="sourceLineNo">330</span><a id="line.330">//PathNode chain</a>
<span class="sourceLineNo">331</span><a id="line.331">static final public Var CLEAR_PATH = Var.create(null).setDynamic();</a>
<span class="sourceLineNo">332</span><a id="line.332"></a>
<span class="sourceLineNo">333</span><a id="line.333">//tail of PathNode chain</a>
<span class="sourceLineNo">334</span><a id="line.334">static final public Var CLEAR_ROOT = Var.create(null).setDynamic();</a>
<span class="sourceLineNo">335</span><a id="line.335"></a>
<span class="sourceLineNo">336</span><a id="line.336">//LocalBinding -&gt; Set&lt;LocalBindingExpr&gt;</a>
<span class="sourceLineNo">337</span><a id="line.337">static final public Var CLEAR_SITES = Var.create(null).setDynamic();</a>
<span class="sourceLineNo">338</span><a id="line.338"></a>
<span class="sourceLineNo">339</span><a id="line.339">    public enum C{</a>
<span class="sourceLineNo">340</span><a id="line.340">        STATEMENT,  //value ignored</a>
<span class="sourceLineNo">341</span><a id="line.341">        EXPRESSION, //value required</a>
<span class="sourceLineNo">342</span><a id="line.342">        RETURN,      //tail position relative to enclosing recur frame</a>
<span class="sourceLineNo">343</span><a id="line.343">        EVAL</a>
<span class="sourceLineNo">344</span><a id="line.344">}</a>
<span class="sourceLineNo">345</span><a id="line.345"></a>
<span class="sourceLineNo">346</span><a id="line.346">private class Recur {};</a>
<span class="sourceLineNo">347</span><a id="line.347">static final public Class RECUR_CLASS = Recur.class;</a>
<span class="sourceLineNo">348</span><a id="line.348">    </a>
<span class="sourceLineNo">349</span><a id="line.349">interface Expr{</a>
<span class="sourceLineNo">350</span><a id="line.350">        Object eval() ;</a>
<span class="sourceLineNo">351</span><a id="line.351"></a>
<span class="sourceLineNo">352</span><a id="line.352">        void emit(C context, ObjExpr objx, GeneratorAdapter gen);</a>
<span class="sourceLineNo">353</span><a id="line.353"></a>
<span class="sourceLineNo">354</span><a id="line.354">        boolean hasJavaClass() ;</a>
<span class="sourceLineNo">355</span><a id="line.355"></a>
<span class="sourceLineNo">356</span><a id="line.356">        Class getJavaClass() ;</a>
<span class="sourceLineNo">357</span><a id="line.357">}</a>
<span class="sourceLineNo">358</span><a id="line.358"></a>
<span class="sourceLineNo">359</span><a id="line.359">public static abstract class UntypedExpr implements Expr{</a>
<span class="sourceLineNo">360</span><a id="line.360"></a>
<span class="sourceLineNo">361</span><a id="line.361">        public Class getJavaClass(){</a>
<span class="sourceLineNo">362</span><a id="line.362">                throw new IllegalArgumentException("Has no Java class");</a>
<span class="sourceLineNo">363</span><a id="line.363">        }</a>
<span class="sourceLineNo">364</span><a id="line.364"></a>
<span class="sourceLineNo">365</span><a id="line.365">        public boolean hasJavaClass(){</a>
<span class="sourceLineNo">366</span><a id="line.366">                return false;</a>
<span class="sourceLineNo">367</span><a id="line.367">        }</a>
<span class="sourceLineNo">368</span><a id="line.368">}</a>
<span class="sourceLineNo">369</span><a id="line.369"></a>
<span class="sourceLineNo">370</span><a id="line.370">interface IParser{</a>
<span class="sourceLineNo">371</span><a id="line.371">        Expr parse(C context, Object form) ;</a>
<span class="sourceLineNo">372</span><a id="line.372">}</a>
<span class="sourceLineNo">373</span><a id="line.373"></a>
<span class="sourceLineNo">374</span><a id="line.374">static boolean isSpecial(Object sym){</a>
<span class="sourceLineNo">375</span><a id="line.375">        return specials.containsKey(sym);</a>
<span class="sourceLineNo">376</span><a id="line.376">}</a>
<span class="sourceLineNo">377</span><a id="line.377"></a>
<span class="sourceLineNo">378</span><a id="line.378">static boolean inTailCall(C context) {</a>
<span class="sourceLineNo">379</span><a id="line.379">    return (context == C.RETURN) &amp;&amp; (METHOD_RETURN_CONTEXT.deref() != null) &amp;&amp; (IN_CATCH_FINALLY.deref() == null);</a>
<span class="sourceLineNo">380</span><a id="line.380">}</a>
<span class="sourceLineNo">381</span><a id="line.381"></a>
<span class="sourceLineNo">382</span><a id="line.382">static Symbol resolveSymbol(Symbol sym){</a>
<span class="sourceLineNo">383</span><a id="line.383">        //already qualified or classname?</a>
<span class="sourceLineNo">384</span><a id="line.384">        if(sym.name.indexOf('.') &gt; 0)</a>
<span class="sourceLineNo">385</span><a id="line.385">                return sym;</a>
<span class="sourceLineNo">386</span><a id="line.386">        if(sym.ns != null)</a>
<span class="sourceLineNo">387</span><a id="line.387">                {</a>
<span class="sourceLineNo">388</span><a id="line.388">                Namespace ns = namespaceFor(sym);</a>
<span class="sourceLineNo">389</span><a id="line.389">                if(ns == null || (ns.name.name == null ? sym.ns == null : ns.name.name.equals(sym.ns)))</a>
<span class="sourceLineNo">390</span><a id="line.390">                        return sym;</a>
<span class="sourceLineNo">391</span><a id="line.391">                return Symbol.intern(ns.name.name, sym.name);</a>
<span class="sourceLineNo">392</span><a id="line.392">                }</a>
<span class="sourceLineNo">393</span><a id="line.393">        Object o = currentNS().getMapping(sym);</a>
<span class="sourceLineNo">394</span><a id="line.394">        if(o == null)</a>
<span class="sourceLineNo">395</span><a id="line.395">                return Symbol.intern(currentNS().name.name, sym.name);</a>
<span class="sourceLineNo">396</span><a id="line.396">        else if(o instanceof Class)</a>
<span class="sourceLineNo">397</span><a id="line.397">                return Symbol.intern(null, ((Class) o).getName());</a>
<span class="sourceLineNo">398</span><a id="line.398">        else if(o instanceof Var)</a>
<span class="sourceLineNo">399</span><a id="line.399">                        {</a>
<span class="sourceLineNo">400</span><a id="line.400">                        Var v = (Var) o;</a>
<span class="sourceLineNo">401</span><a id="line.401">                        return Symbol.intern(v.ns.name.name, v.sym.name);</a>
<span class="sourceLineNo">402</span><a id="line.402">                        }</a>
<span class="sourceLineNo">403</span><a id="line.403">        return null;</a>
<span class="sourceLineNo">404</span><a id="line.404"></a>
<span class="sourceLineNo">405</span><a id="line.405">}</a>
<span class="sourceLineNo">406</span><a id="line.406"></a>
<span class="sourceLineNo">407</span><a id="line.407">static class DefExpr implements Expr{</a>
<span class="sourceLineNo">408</span><a id="line.408">        public final Var var;</a>
<span class="sourceLineNo">409</span><a id="line.409">        public final Expr init;</a>
<span class="sourceLineNo">410</span><a id="line.410">        public final Expr meta;</a>
<span class="sourceLineNo">411</span><a id="line.411">        public final boolean initProvided;</a>
<span class="sourceLineNo">412</span><a id="line.412">        public final boolean isDynamic;</a>
<span class="sourceLineNo">413</span><a id="line.413">        public final boolean shadowsCoreMapping;</a>
<span class="sourceLineNo">414</span><a id="line.414">        public final String source;</a>
<span class="sourceLineNo">415</span><a id="line.415">        public final int line;</a>
<span class="sourceLineNo">416</span><a id="line.416">        public final int column;</a>
<span class="sourceLineNo">417</span><a id="line.417">        final static Method bindRootMethod = Method.getMethod("void bindRoot(Object)");</a>
<span class="sourceLineNo">418</span><a id="line.418">        final static Method setTagMethod = Method.getMethod("void setTag(clojure.lang.Symbol)");</a>
<span class="sourceLineNo">419</span><a id="line.419">        final static Method setMetaMethod = Method.getMethod("void setMeta(clojure.lang.IPersistentMap)");</a>
<span class="sourceLineNo">420</span><a id="line.420">        final static Method setDynamicMethod = Method.getMethod("clojure.lang.Var setDynamic(boolean)");</a>
<span class="sourceLineNo">421</span><a id="line.421">        final static Method symintern = Method.getMethod("clojure.lang.Symbol intern(String, String)");</a>
<span class="sourceLineNo">422</span><a id="line.422">        final static Method internVar = Method.getMethod("clojure.lang.Var refer(clojure.lang.Symbol, clojure.lang.Var)");</a>
<span class="sourceLineNo">423</span><a id="line.423"></a>
<span class="sourceLineNo">424</span><a id="line.424">        public DefExpr(String source, int line, int column, Var var, Expr init, Expr meta, boolean initProvided, boolean isDynamic, boolean shadowsCoreMapping){</a>
<span class="sourceLineNo">425</span><a id="line.425">                this.source = source;</a>
<span class="sourceLineNo">426</span><a id="line.426">                this.line = line;</a>
<span class="sourceLineNo">427</span><a id="line.427">                this.column = column;</a>
<span class="sourceLineNo">428</span><a id="line.428">                this.var = var;</a>
<span class="sourceLineNo">429</span><a id="line.429">                this.init = init;</a>
<span class="sourceLineNo">430</span><a id="line.430">                this.meta = meta;</a>
<span class="sourceLineNo">431</span><a id="line.431">                this.isDynamic = isDynamic;</a>
<span class="sourceLineNo">432</span><a id="line.432">                this.shadowsCoreMapping = shadowsCoreMapping;</a>
<span class="sourceLineNo">433</span><a id="line.433">                this.initProvided = initProvided;</a>
<span class="sourceLineNo">434</span><a id="line.434">        }</a>
<span class="sourceLineNo">435</span><a id="line.435"></a>
<span class="sourceLineNo">436</span><a id="line.436">    private boolean includesExplicitMetadata(MapExpr expr) {</a>
<span class="sourceLineNo">437</span><a id="line.437">        for(int i=0; i &lt; expr.keyvals.count(); i += 2)</a>
<span class="sourceLineNo">438</span><a id="line.438">            {</a>
<span class="sourceLineNo">439</span><a id="line.439">                Keyword k  = ((KeywordExpr) expr.keyvals.nth(i)).k;</a>
<span class="sourceLineNo">440</span><a id="line.440">                if ((k != RT.FILE_KEY) &amp;&amp;</a>
<span class="sourceLineNo">441</span><a id="line.441">                    (k != RT.DECLARED_KEY) &amp;&amp;</a>
<span class="sourceLineNo">442</span><a id="line.442">                    (k != RT.LINE_KEY) &amp;&amp;</a>
<span class="sourceLineNo">443</span><a id="line.443">                    (k != RT.COLUMN_KEY))</a>
<span class="sourceLineNo">444</span><a id="line.444">                    return true;</a>
<span class="sourceLineNo">445</span><a id="line.445">            }</a>
<span class="sourceLineNo">446</span><a id="line.446">        return false;</a>
<span class="sourceLineNo">447</span><a id="line.447">    }</a>
<span class="sourceLineNo">448</span><a id="line.448"></a>
<span class="sourceLineNo">449</span><a id="line.449">    public Object eval() {</a>
<span class="sourceLineNo">450</span><a id="line.450">                try</a>
<span class="sourceLineNo">451</span><a id="line.451">                        {</a>
<span class="sourceLineNo">452</span><a id="line.452">                        if(initProvided)</a>
<span class="sourceLineNo">453</span><a id="line.453">                                {</a>
<span class="sourceLineNo">454</span><a id="line.454">//                      if(init instanceof FnExpr &amp;&amp; ((FnExpr) init).closes.count()==0)</a>
<span class="sourceLineNo">455</span><a id="line.455">//                              var.bindRoot(new FnLoaderThunk((FnExpr) init,var));</a>
<span class="sourceLineNo">456</span><a id="line.456">//                      else</a>
<span class="sourceLineNo">457</span><a id="line.457">                                var.bindRoot(init.eval());</a>
<span class="sourceLineNo">458</span><a id="line.458">                                }</a>
<span class="sourceLineNo">459</span><a id="line.459">                        if(meta != null)</a>
<span class="sourceLineNo">460</span><a id="line.460">                                {</a>
<span class="sourceLineNo">461</span><a id="line.461">                IPersistentMap metaMap = (IPersistentMap) meta.eval();</a>
<span class="sourceLineNo">462</span><a id="line.462">                if (initProvided || true)//includesExplicitMetadata((MapExpr) meta))</a>
<span class="sourceLineNo">463</span><a id="line.463">                                    var.setMeta(metaMap);</a>
<span class="sourceLineNo">464</span><a id="line.464">                                }</a>
<span class="sourceLineNo">465</span><a id="line.465">                        return var.setDynamic(isDynamic);</a>
<span class="sourceLineNo">466</span><a id="line.466">                        }</a>
<span class="sourceLineNo">467</span><a id="line.467">                catch(Throwable e)</a>
<span class="sourceLineNo">468</span><a id="line.468">                        {</a>
<span class="sourceLineNo">469</span><a id="line.469">                        if(!(e instanceof CompilerException))</a>
<span class="sourceLineNo">470</span><a id="line.470">                                throw new CompilerException(source, line, column, Compiler.DEF, e);</a>
<span class="sourceLineNo">471</span><a id="line.471">                        else</a>
<span class="sourceLineNo">472</span><a id="line.472">                                throw (CompilerException) e;</a>
<span class="sourceLineNo">473</span><a id="line.473">                        }</a>
<span class="sourceLineNo">474</span><a id="line.474">        }</a>
<span class="sourceLineNo">475</span><a id="line.475"></a>
<span class="sourceLineNo">476</span><a id="line.476">        public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">477</span><a id="line.477">                objx.emitVar(gen, var);</a>
<span class="sourceLineNo">478</span><a id="line.478"></a>
<span class="sourceLineNo">479</span><a id="line.479">                if (shadowsCoreMapping)</a>
<span class="sourceLineNo">480</span><a id="line.480">                {</a>
<span class="sourceLineNo">481</span><a id="line.481">                        gen.dup();</a>
<span class="sourceLineNo">482</span><a id="line.482">                        gen.getField(VAR_TYPE, "ns", NS_TYPE);</a>
<span class="sourceLineNo">483</span><a id="line.483">                        gen.swap();</a>
<span class="sourceLineNo">484</span><a id="line.484">                        gen.dup();</a>
<span class="sourceLineNo">485</span><a id="line.485">                        gen.getField(VAR_TYPE, "sym", SYMBOL_TYPE);</a>
<span class="sourceLineNo">486</span><a id="line.486">                        gen.swap();</a>
<span class="sourceLineNo">487</span><a id="line.487">                        gen.invokeVirtual(NS_TYPE, internVar);</a>
<span class="sourceLineNo">488</span><a id="line.488">                }</a>
<span class="sourceLineNo">489</span><a id="line.489"></a>
<span class="sourceLineNo">490</span><a id="line.490">                if(isDynamic)</a>
<span class="sourceLineNo">491</span><a id="line.491">                        {</a>
<span class="sourceLineNo">492</span><a id="line.492">                        gen.push(isDynamic);</a>
<span class="sourceLineNo">493</span><a id="line.493">                        gen.invokeVirtual(VAR_TYPE, setDynamicMethod);</a>
<span class="sourceLineNo">494</span><a id="line.494">                        }</a>
<span class="sourceLineNo">495</span><a id="line.495">                if(meta != null)</a>
<span class="sourceLineNo">496</span><a id="line.496">                        {</a>
<span class="sourceLineNo">497</span><a id="line.497">            if (initProvided || true)//includesExplicitMetadata((MapExpr) meta))</a>
<span class="sourceLineNo">498</span><a id="line.498">                {</a>
<span class="sourceLineNo">499</span><a id="line.499">                gen.dup();</a>
<span class="sourceLineNo">500</span><a id="line.500">                meta.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">501</span><a id="line.501">                gen.checkCast(IPERSISTENTMAP_TYPE);</a>
<span class="sourceLineNo">502</span><a id="line.502">                gen.invokeVirtual(VAR_TYPE, setMetaMethod);</a>
<span class="sourceLineNo">503</span><a id="line.503">                }</a>
<span class="sourceLineNo">504</span><a id="line.504">                        }</a>
<span class="sourceLineNo">505</span><a id="line.505">                if(initProvided)</a>
<span class="sourceLineNo">506</span><a id="line.506">                        {</a>
<span class="sourceLineNo">507</span><a id="line.507">                        gen.dup();</a>
<span class="sourceLineNo">508</span><a id="line.508">                        if(init instanceof FnExpr)</a>
<span class="sourceLineNo">509</span><a id="line.509">                                {</a>
<span class="sourceLineNo">510</span><a id="line.510">                                ((FnExpr)init).emitForDefn(objx, gen);</a>
<span class="sourceLineNo">511</span><a id="line.511">                                }</a>
<span class="sourceLineNo">512</span><a id="line.512">                        else</a>
<span class="sourceLineNo">513</span><a id="line.513">                                init.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">514</span><a id="line.514">                        gen.invokeVirtual(VAR_TYPE, bindRootMethod);</a>
<span class="sourceLineNo">515</span><a id="line.515">                        }</a>
<span class="sourceLineNo">516</span><a id="line.516"></a>
<span class="sourceLineNo">517</span><a id="line.517">                if(context == C.STATEMENT)</a>
<span class="sourceLineNo">518</span><a id="line.518">                        gen.pop();</a>
<span class="sourceLineNo">519</span><a id="line.519">        }</a>
<span class="sourceLineNo">520</span><a id="line.520"></a>
<span class="sourceLineNo">521</span><a id="line.521">        public boolean hasJavaClass(){</a>
<span class="sourceLineNo">522</span><a id="line.522">                return true;</a>
<span class="sourceLineNo">523</span><a id="line.523">        }</a>
<span class="sourceLineNo">524</span><a id="line.524"></a>
<span class="sourceLineNo">525</span><a id="line.525">        public Class getJavaClass(){</a>
<span class="sourceLineNo">526</span><a id="line.526">                return Var.class;</a>
<span class="sourceLineNo">527</span><a id="line.527">        }</a>
<span class="sourceLineNo">528</span><a id="line.528"></a>
<span class="sourceLineNo">529</span><a id="line.529">        static class Parser implements IParser{</a>
<span class="sourceLineNo">530</span><a id="line.530">                public Expr parse(C context, Object form) {</a>
<span class="sourceLineNo">531</span><a id="line.531">                        //(def x) or (def x initexpr) or (def x "docstring" initexpr)</a>
<span class="sourceLineNo">532</span><a id="line.532">                        String docstring = null;</a>
<span class="sourceLineNo">533</span><a id="line.533">                        if(RT.count(form) == 4 &amp;&amp; (RT.third(form) instanceof String)) {</a>
<span class="sourceLineNo">534</span><a id="line.534">                                docstring = (String) RT.third(form);</a>
<span class="sourceLineNo">535</span><a id="line.535">                                form = RT.list(RT.first(form), RT.second(form), RT.fourth(form));</a>
<span class="sourceLineNo">536</span><a id="line.536">                        }</a>
<span class="sourceLineNo">537</span><a id="line.537">                        if(RT.count(form) &gt; 3)</a>
<span class="sourceLineNo">538</span><a id="line.538">                                throw Util.runtimeException("Too many arguments to def");</a>
<span class="sourceLineNo">539</span><a id="line.539">                        else if(RT.count(form) &lt; 2)</a>
<span class="sourceLineNo">540</span><a id="line.540">                                throw Util.runtimeException("Too few arguments to def");</a>
<span class="sourceLineNo">541</span><a id="line.541">                        else if(!(RT.second(form) instanceof Symbol))</a>
<span class="sourceLineNo">542</span><a id="line.542">                                        throw Util.runtimeException("First argument to def must be a Symbol");</a>
<span class="sourceLineNo">543</span><a id="line.543">                        Symbol sym = (Symbol) RT.second(form);</a>
<span class="sourceLineNo">544</span><a id="line.544">                        Var v = lookupVar(sym, true);</a>
<span class="sourceLineNo">545</span><a id="line.545">                        if(v == null)</a>
<span class="sourceLineNo">546</span><a id="line.546">                                throw Util.runtimeException("Can't refer to qualified var that doesn't exist");</a>
<span class="sourceLineNo">547</span><a id="line.547">                        boolean shadowsCoreMapping = false;</a>
<span class="sourceLineNo">548</span><a id="line.548">                        if(!v.ns.equals(currentNS()))</a>
<span class="sourceLineNo">549</span><a id="line.549">                                {</a>
<span class="sourceLineNo">550</span><a id="line.550">                                if(sym.ns == null)</a>
<span class="sourceLineNo">551</span><a id="line.551">                                        {</a>
<span class="sourceLineNo">552</span><a id="line.552">                                        v = currentNS().intern(sym);</a>
<span class="sourceLineNo">553</span><a id="line.553">                                        shadowsCoreMapping = true;</a>
<span class="sourceLineNo">554</span><a id="line.554">                                        registerVar(v);</a>
<span class="sourceLineNo">555</span><a id="line.555">                                        }</a>
<span class="sourceLineNo">556</span><a id="line.556">//                                      throw Util.runtimeException("Name conflict, can't def " + sym + " because namespace: " + currentNS().name +</a>
<span class="sourceLineNo">557</span><a id="line.557">//                                                          " refers to:" + v);</a>
<span class="sourceLineNo">558</span><a id="line.558">                                else</a>
<span class="sourceLineNo">559</span><a id="line.559">                                        throw Util.runtimeException("Can't create defs outside of current ns");</a>
<span class="sourceLineNo">560</span><a id="line.560">                                }</a>
<span class="sourceLineNo">561</span><a id="line.561">                        IPersistentMap mm = sym.meta();</a>
<span class="sourceLineNo">562</span><a id="line.562">                        boolean isDynamic = RT.booleanCast(RT.get(mm,dynamicKey));</a>
<span class="sourceLineNo">563</span><a id="line.563">                        if(isDynamic)</a>
<span class="sourceLineNo">564</span><a id="line.564">                           v.setDynamic();</a>
<span class="sourceLineNo">565</span><a id="line.565">            if(!isDynamic &amp;&amp; sym.name.startsWith("*") &amp;&amp; sym.name.endsWith("*") &amp;&amp; sym.name.length() &gt; 2)</a>
<span class="sourceLineNo">566</span><a id="line.566">                {</a>
<span class="sourceLineNo">567</span><a id="line.567">                RT.errPrintWriter().format("Warning: %1$s not declared dynamic and thus is not dynamically rebindable, "</a>
<span class="sourceLineNo">568</span><a id="line.568">                                          +"but its name suggests otherwise. Please either indicate ^:dynamic %1$s or change the name. (%2$s:%3$d)\n",</a>
<span class="sourceLineNo">569</span><a id="line.569">                                           sym, SOURCE_PATH.get(), LINE.get());</a>
<span class="sourceLineNo">570</span><a id="line.570">                }</a>
<span class="sourceLineNo">571</span><a id="line.571">                        if(RT.booleanCast(RT.get(mm, arglistsKey)))</a>
<span class="sourceLineNo">572</span><a id="line.572">                                {</a>
<span class="sourceLineNo">573</span><a id="line.573">                                IPersistentMap vm = v.meta();</a>
<span class="sourceLineNo">574</span><a id="line.574">                                //vm = (IPersistentMap) RT.assoc(vm,staticKey,RT.T);</a>
<span class="sourceLineNo">575</span><a id="line.575">                                //drop quote</a>
<span class="sourceLineNo">576</span><a id="line.576">                                vm = (IPersistentMap) RT.assoc(vm,arglistsKey,RT.second(mm.valAt(arglistsKey)));</a>
<span class="sourceLineNo">577</span><a id="line.577">                                v.setMeta(vm);</a>
<span class="sourceLineNo">578</span><a id="line.578">                                }</a>
<span class="sourceLineNo">579</span><a id="line.579">            Object source_path = SOURCE_PATH.get();</a>
<span class="sourceLineNo">580</span><a id="line.580">            source_path = source_path == null ? "NO_SOURCE_FILE" : source_path;</a>
<span class="sourceLineNo">581</span><a id="line.581">            mm = (IPersistentMap) RT.assoc(mm, RT.LINE_KEY, LINE.get()).assoc(RT.COLUMN_KEY, COLUMN.get()).assoc(RT.FILE_KEY, source_path);</a>
<span class="sourceLineNo">582</span><a id="line.582">                        if (docstring != null)</a>
<span class="sourceLineNo">583</span><a id="line.583">                          mm = (IPersistentMap) RT.assoc(mm, RT.DOC_KEY, docstring);</a>
<span class="sourceLineNo">584</span><a id="line.584">//                      mm = mm.without(RT.DOC_KEY)</a>
<span class="sourceLineNo">585</span><a id="line.585">//                                      .without(Keyword.intern(null, "arglists"))</a>
<span class="sourceLineNo">586</span><a id="line.586">//                                      .without(RT.FILE_KEY)</a>
<span class="sourceLineNo">587</span><a id="line.587">//                                      .without(RT.LINE_KEY)</a>
<span class="sourceLineNo">588</span><a id="line.588">//                                      .without(RT.COLUMN_KEY)</a>
<span class="sourceLineNo">589</span><a id="line.589">//                                      .without(Keyword.intern(null, "ns"))</a>
<span class="sourceLineNo">590</span><a id="line.590">//                                      .without(Keyword.intern(null, "name"))</a>
<span class="sourceLineNo">591</span><a id="line.591">//                                      .without(Keyword.intern(null, "added"))</a>
<span class="sourceLineNo">592</span><a id="line.592">//                                      .without(Keyword.intern(null, "static"));</a>
<span class="sourceLineNo">593</span><a id="line.593">            mm = (IPersistentMap) elideMeta(mm);</a>
<span class="sourceLineNo">594</span><a id="line.594">                        Expr meta = mm.count()==0 ? null:analyze(context == C.EVAL ? context : C.EXPRESSION, mm);</a>
<span class="sourceLineNo">595</span><a id="line.595">                        return new DefExpr((String) SOURCE.deref(), lineDeref(), columnDeref(),</a>
<span class="sourceLineNo">596</span><a id="line.596">                                           v, analyze(context == C.EVAL ? context : C.EXPRESSION, RT.third(form), v.sym.name),</a>
<span class="sourceLineNo">597</span><a id="line.597">                                           meta, RT.count(form) == 3, isDynamic, shadowsCoreMapping);</a>
<span class="sourceLineNo">598</span><a id="line.598">                }</a>
<span class="sourceLineNo">599</span><a id="line.599">        }</a>
<span class="sourceLineNo">600</span><a id="line.600">}</a>
<span class="sourceLineNo">601</span><a id="line.601"></a>
<span class="sourceLineNo">602</span><a id="line.602">public static class AssignExpr implements Expr{</a>
<span class="sourceLineNo">603</span><a id="line.603">        public final AssignableExpr target;</a>
<span class="sourceLineNo">604</span><a id="line.604">        public final Expr val;</a>
<span class="sourceLineNo">605</span><a id="line.605"></a>
<span class="sourceLineNo">606</span><a id="line.606">        public AssignExpr(AssignableExpr target, Expr val){</a>
<span class="sourceLineNo">607</span><a id="line.607">                this.target = target;</a>
<span class="sourceLineNo">608</span><a id="line.608">                this.val = val;</a>
<span class="sourceLineNo">609</span><a id="line.609">        }</a>
<span class="sourceLineNo">610</span><a id="line.610"></a>
<span class="sourceLineNo">611</span><a id="line.611">        public Object eval() {</a>
<span class="sourceLineNo">612</span><a id="line.612">                return target.evalAssign(val);</a>
<span class="sourceLineNo">613</span><a id="line.613">        }</a>
<span class="sourceLineNo">614</span><a id="line.614"></a>
<span class="sourceLineNo">615</span><a id="line.615">        public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">616</span><a id="line.616">                target.emitAssign(context, objx, gen, val);</a>
<span class="sourceLineNo">617</span><a id="line.617">        }</a>
<span class="sourceLineNo">618</span><a id="line.618"></a>
<span class="sourceLineNo">619</span><a id="line.619">        public boolean hasJavaClass() {</a>
<span class="sourceLineNo">620</span><a id="line.620">                return val.hasJavaClass();</a>
<span class="sourceLineNo">621</span><a id="line.621">        }</a>
<span class="sourceLineNo">622</span><a id="line.622"></a>
<span class="sourceLineNo">623</span><a id="line.623">        public Class getJavaClass() {</a>
<span class="sourceLineNo">624</span><a id="line.624">                return val.getJavaClass();</a>
<span class="sourceLineNo">625</span><a id="line.625">        }</a>
<span class="sourceLineNo">626</span><a id="line.626"></a>
<span class="sourceLineNo">627</span><a id="line.627">        static class Parser implements IParser{</a>
<span class="sourceLineNo">628</span><a id="line.628">                public Expr parse(C context, Object frm) {</a>
<span class="sourceLineNo">629</span><a id="line.629">                        ISeq form = (ISeq) frm;</a>
<span class="sourceLineNo">630</span><a id="line.630">                        if(RT.length(form) != 3)</a>
<span class="sourceLineNo">631</span><a id="line.631">                                throw new IllegalArgumentException("Malformed assignment, expecting (set! target val)");</a>
<span class="sourceLineNo">632</span><a id="line.632">                        Expr target = analyze(C.EXPRESSION, RT.second(form));</a>
<span class="sourceLineNo">633</span><a id="line.633">                        if(!(target instanceof AssignableExpr))</a>
<span class="sourceLineNo">634</span><a id="line.634">                                throw new IllegalArgumentException("Invalid assignment target");</a>
<span class="sourceLineNo">635</span><a id="line.635">                        return new AssignExpr((AssignableExpr) target, analyze(C.EXPRESSION, RT.third(form)));</a>
<span class="sourceLineNo">636</span><a id="line.636">                }</a>
<span class="sourceLineNo">637</span><a id="line.637">        }</a>
<span class="sourceLineNo">638</span><a id="line.638">}</a>
<span class="sourceLineNo">639</span><a id="line.639"></a>
<span class="sourceLineNo">640</span><a id="line.640">public static class VarExpr implements Expr, AssignableExpr{</a>
<span class="sourceLineNo">641</span><a id="line.641">        public final Var var;</a>
<span class="sourceLineNo">642</span><a id="line.642">        public final Object tag;</a>
<span class="sourceLineNo">643</span><a id="line.643">        final static Method getMethod = Method.getMethod("Object get()");</a>
<span class="sourceLineNo">644</span><a id="line.644">        final static Method setMethod = Method.getMethod("Object set(Object)");</a>
<span class="sourceLineNo">645</span><a id="line.645"></a>
<span class="sourceLineNo">646</span><a id="line.646">    Class jc;</a>
<span class="sourceLineNo">647</span><a id="line.647"></a>
<span class="sourceLineNo">648</span><a id="line.648">        public VarExpr(Var var, Symbol tag){</a>
<span class="sourceLineNo">649</span><a id="line.649">                this.var = var;</a>
<span class="sourceLineNo">650</span><a id="line.650">                this.tag = tag != null ? tag : var.getTag();</a>
<span class="sourceLineNo">651</span><a id="line.651">        }</a>
<span class="sourceLineNo">652</span><a id="line.652"></a>
<span class="sourceLineNo">653</span><a id="line.653">        public Object eval() {</a>
<span class="sourceLineNo">654</span><a id="line.654">                return var.deref();</a>
<span class="sourceLineNo">655</span><a id="line.655">        }</a>
<span class="sourceLineNo">656</span><a id="line.656"></a>
<span class="sourceLineNo">657</span><a id="line.657">        public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">658</span><a id="line.658">                objx.emitVarValue(gen,var);</a>
<span class="sourceLineNo">659</span><a id="line.659">                if(context == C.STATEMENT)</a>
<span class="sourceLineNo">660</span><a id="line.660">                        {</a>
<span class="sourceLineNo">661</span><a id="line.661">                        gen.pop();</a>
<span class="sourceLineNo">662</span><a id="line.662">                        }</a>
<span class="sourceLineNo">663</span><a id="line.663">        }</a>
<span class="sourceLineNo">664</span><a id="line.664"></a>
<span class="sourceLineNo">665</span><a id="line.665">        public boolean hasJavaClass(){</a>
<span class="sourceLineNo">666</span><a id="line.666">                return tag != null;</a>
<span class="sourceLineNo">667</span><a id="line.667">        }</a>
<span class="sourceLineNo">668</span><a id="line.668"></a>
<span class="sourceLineNo">669</span><a id="line.669">        public Class getJavaClass() {</a>
<span class="sourceLineNo">670</span><a id="line.670">        if (jc == null)</a>
<span class="sourceLineNo">671</span><a id="line.671">            jc = HostExpr.tagToClass(tag);</a>
<span class="sourceLineNo">672</span><a id="line.672">                return jc;</a>
<span class="sourceLineNo">673</span><a id="line.673">        }</a>
<span class="sourceLineNo">674</span><a id="line.674"></a>
<span class="sourceLineNo">675</span><a id="line.675">        public Object evalAssign(Expr val) {</a>
<span class="sourceLineNo">676</span><a id="line.676">                return var.set(val.eval());</a>
<span class="sourceLineNo">677</span><a id="line.677">        }</a>
<span class="sourceLineNo">678</span><a id="line.678"></a>
<span class="sourceLineNo">679</span><a id="line.679">        public void emitAssign(C context, ObjExpr objx, GeneratorAdapter gen,</a>
<span class="sourceLineNo">680</span><a id="line.680">                               Expr val){</a>
<span class="sourceLineNo">681</span><a id="line.681">                objx.emitVar(gen, var);</a>
<span class="sourceLineNo">682</span><a id="line.682">                val.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">683</span><a id="line.683">                gen.invokeVirtual(VAR_TYPE, setMethod);</a>
<span class="sourceLineNo">684</span><a id="line.684">                if(context == C.STATEMENT)</a>
<span class="sourceLineNo">685</span><a id="line.685">                        gen.pop();</a>
<span class="sourceLineNo">686</span><a id="line.686">        }</a>
<span class="sourceLineNo">687</span><a id="line.687">}</a>
<span class="sourceLineNo">688</span><a id="line.688"></a>
<span class="sourceLineNo">689</span><a id="line.689">public static class TheVarExpr implements Expr{</a>
<span class="sourceLineNo">690</span><a id="line.690">        public final Var var;</a>
<span class="sourceLineNo">691</span><a id="line.691"></a>
<span class="sourceLineNo">692</span><a id="line.692">        public TheVarExpr(Var var){</a>
<span class="sourceLineNo">693</span><a id="line.693">                this.var = var;</a>
<span class="sourceLineNo">694</span><a id="line.694">        }</a>
<span class="sourceLineNo">695</span><a id="line.695"></a>
<span class="sourceLineNo">696</span><a id="line.696">        public Object eval() {</a>
<span class="sourceLineNo">697</span><a id="line.697">                return var;</a>
<span class="sourceLineNo">698</span><a id="line.698">        }</a>
<span class="sourceLineNo">699</span><a id="line.699"></a>
<span class="sourceLineNo">700</span><a id="line.700">        public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">701</span><a id="line.701">                objx.emitVar(gen, var);</a>
<span class="sourceLineNo">702</span><a id="line.702">                if(context == C.STATEMENT)</a>
<span class="sourceLineNo">703</span><a id="line.703">                        gen.pop();</a>
<span class="sourceLineNo">704</span><a id="line.704">        }</a>
<span class="sourceLineNo">705</span><a id="line.705"></a>
<span class="sourceLineNo">706</span><a id="line.706">        public boolean hasJavaClass(){</a>
<span class="sourceLineNo">707</span><a id="line.707">                return true;</a>
<span class="sourceLineNo">708</span><a id="line.708">        }</a>
<span class="sourceLineNo">709</span><a id="line.709"></a>
<span class="sourceLineNo">710</span><a id="line.710">        public Class getJavaClass() {</a>
<span class="sourceLineNo">711</span><a id="line.711">                return Var.class;</a>
<span class="sourceLineNo">712</span><a id="line.712">        }</a>
<span class="sourceLineNo">713</span><a id="line.713"></a>
<span class="sourceLineNo">714</span><a id="line.714">        static class Parser implements IParser{</a>
<span class="sourceLineNo">715</span><a id="line.715">                public Expr parse(C context, Object form) {</a>
<span class="sourceLineNo">716</span><a id="line.716">                        Symbol sym = (Symbol) RT.second(form);</a>
<span class="sourceLineNo">717</span><a id="line.717">                        Var v = lookupVar(sym, false);</a>
<span class="sourceLineNo">718</span><a id="line.718">                        if(v != null)</a>
<span class="sourceLineNo">719</span><a id="line.719">                                return new TheVarExpr(v);</a>
<span class="sourceLineNo">720</span><a id="line.720">                        throw Util.runtimeException("Unable to resolve var: " + sym + " in this context");</a>
<span class="sourceLineNo">721</span><a id="line.721">                }</a>
<span class="sourceLineNo">722</span><a id="line.722">        }</a>
<span class="sourceLineNo">723</span><a id="line.723">}</a>
<span class="sourceLineNo">724</span><a id="line.724"></a>
<span class="sourceLineNo">725</span><a id="line.725">public static class KeywordExpr extends LiteralExpr{</a>
<span class="sourceLineNo">726</span><a id="line.726">        public final Keyword k;</a>
<span class="sourceLineNo">727</span><a id="line.727"></a>
<span class="sourceLineNo">728</span><a id="line.728">        public KeywordExpr(Keyword k){</a>
<span class="sourceLineNo">729</span><a id="line.729">                this.k = k;</a>
<span class="sourceLineNo">730</span><a id="line.730">        }</a>
<span class="sourceLineNo">731</span><a id="line.731"></a>
<span class="sourceLineNo">732</span><a id="line.732">        Object val(){</a>
<span class="sourceLineNo">733</span><a id="line.733">                return k;</a>
<span class="sourceLineNo">734</span><a id="line.734">        }</a>
<span class="sourceLineNo">735</span><a id="line.735"></a>
<span class="sourceLineNo">736</span><a id="line.736">        public Object eval() {</a>
<span class="sourceLineNo">737</span><a id="line.737">                return k;</a>
<span class="sourceLineNo">738</span><a id="line.738">        }</a>
<span class="sourceLineNo">739</span><a id="line.739"></a>
<span class="sourceLineNo">740</span><a id="line.740">        public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">741</span><a id="line.741">                objx.emitKeyword(gen, k);</a>
<span class="sourceLineNo">742</span><a id="line.742">                if(context == C.STATEMENT)</a>
<span class="sourceLineNo">743</span><a id="line.743">                        gen.pop();</a>
<span class="sourceLineNo">744</span><a id="line.744"></a>
<span class="sourceLineNo">745</span><a id="line.745">        }</a>
<span class="sourceLineNo">746</span><a id="line.746"></a>
<span class="sourceLineNo">747</span><a id="line.747">        public boolean hasJavaClass(){</a>
<span class="sourceLineNo">748</span><a id="line.748">                return true;</a>
<span class="sourceLineNo">749</span><a id="line.749">        }</a>
<span class="sourceLineNo">750</span><a id="line.750"></a>
<span class="sourceLineNo">751</span><a id="line.751">        public Class getJavaClass() {</a>
<span class="sourceLineNo">752</span><a id="line.752">                return Keyword.class;</a>
<span class="sourceLineNo">753</span><a id="line.753">        }</a>
<span class="sourceLineNo">754</span><a id="line.754">}</a>
<span class="sourceLineNo">755</span><a id="line.755"></a>
<span class="sourceLineNo">756</span><a id="line.756">public static class ImportExpr implements Expr{</a>
<span class="sourceLineNo">757</span><a id="line.757">        public final String c;</a>
<span class="sourceLineNo">758</span><a id="line.758">        final static Method forNameMethod = Method.getMethod("Class classForNameNonLoading(String)");</a>
<span class="sourceLineNo">759</span><a id="line.759">        final static Method importClassMethod = Method.getMethod("Class importClass(Class)");</a>
<span class="sourceLineNo">760</span><a id="line.760">        final static Method derefMethod = Method.getMethod("Object deref()");</a>
<span class="sourceLineNo">761</span><a id="line.761"></a>
<span class="sourceLineNo">762</span><a id="line.762">        public ImportExpr(String c){</a>
<span class="sourceLineNo">763</span><a id="line.763">                this.c = c;</a>
<span class="sourceLineNo">764</span><a id="line.764">        }</a>
<span class="sourceLineNo">765</span><a id="line.765"></a>
<span class="sourceLineNo">766</span><a id="line.766">        public Object eval() {</a>
<span class="sourceLineNo">767</span><a id="line.767">                Namespace ns = (Namespace) RT.CURRENT_NS.deref();</a>
<span class="sourceLineNo">768</span><a id="line.768">                ns.importClass(RT.classForNameNonLoading(c));</a>
<span class="sourceLineNo">769</span><a id="line.769">                return null;</a>
<span class="sourceLineNo">770</span><a id="line.770">        }</a>
<span class="sourceLineNo">771</span><a id="line.771"></a>
<span class="sourceLineNo">772</span><a id="line.772">        public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">773</span><a id="line.773">                gen.getStatic(RT_TYPE,"CURRENT_NS",VAR_TYPE);</a>
<span class="sourceLineNo">774</span><a id="line.774">                gen.invokeVirtual(VAR_TYPE, derefMethod);</a>
<span class="sourceLineNo">775</span><a id="line.775">                gen.checkCast(NS_TYPE);</a>
<span class="sourceLineNo">776</span><a id="line.776">                gen.push(c);</a>
<span class="sourceLineNo">777</span><a id="line.777">                gen.invokeStatic(RT_TYPE, forNameMethod);</a>
<span class="sourceLineNo">778</span><a id="line.778">                gen.invokeVirtual(NS_TYPE, importClassMethod);</a>
<span class="sourceLineNo">779</span><a id="line.779">                if(context == C.STATEMENT)</a>
<span class="sourceLineNo">780</span><a id="line.780">                        gen.pop();</a>
<span class="sourceLineNo">781</span><a id="line.781">        }</a>
<span class="sourceLineNo">782</span><a id="line.782"></a>
<span class="sourceLineNo">783</span><a id="line.783">        public boolean hasJavaClass(){</a>
<span class="sourceLineNo">784</span><a id="line.784">                return false;</a>
<span class="sourceLineNo">785</span><a id="line.785">        }</a>
<span class="sourceLineNo">786</span><a id="line.786"></a>
<span class="sourceLineNo">787</span><a id="line.787">        public Class getJavaClass() {</a>
<span class="sourceLineNo">788</span><a id="line.788">                throw new IllegalArgumentException("ImportExpr has no Java class");</a>
<span class="sourceLineNo">789</span><a id="line.789">        }</a>
<span class="sourceLineNo">790</span><a id="line.790"></a>
<span class="sourceLineNo">791</span><a id="line.791">        static class Parser implements IParser{</a>
<span class="sourceLineNo">792</span><a id="line.792">                public Expr parse(C context, Object form) {</a>
<span class="sourceLineNo">793</span><a id="line.793">                        return new ImportExpr((String) RT.second(form));</a>
<span class="sourceLineNo">794</span><a id="line.794">                }</a>
<span class="sourceLineNo">795</span><a id="line.795">        }</a>
<span class="sourceLineNo">796</span><a id="line.796">}</a>
<span class="sourceLineNo">797</span><a id="line.797"></a>
<span class="sourceLineNo">798</span><a id="line.798">public static abstract class LiteralExpr implements Expr{</a>
<span class="sourceLineNo">799</span><a id="line.799">        abstract Object val();</a>
<span class="sourceLineNo">800</span><a id="line.800"></a>
<span class="sourceLineNo">801</span><a id="line.801">        public Object eval(){</a>
<span class="sourceLineNo">802</span><a id="line.802">                return val();</a>
<span class="sourceLineNo">803</span><a id="line.803">        }</a>
<span class="sourceLineNo">804</span><a id="line.804">}</a>
<span class="sourceLineNo">805</span><a id="line.805"></a>
<span class="sourceLineNo">806</span><a id="line.806">static interface AssignableExpr{</a>
<span class="sourceLineNo">807</span><a id="line.807">        Object evalAssign(Expr val) ;</a>
<span class="sourceLineNo">808</span><a id="line.808"></a>
<span class="sourceLineNo">809</span><a id="line.809">        void emitAssign(C context, ObjExpr objx, GeneratorAdapter gen, Expr val);</a>
<span class="sourceLineNo">810</span><a id="line.810">}</a>
<span class="sourceLineNo">811</span><a id="line.811"></a>
<span class="sourceLineNo">812</span><a id="line.812">static public interface MaybePrimitiveExpr extends Expr{</a>
<span class="sourceLineNo">813</span><a id="line.813">        public boolean canEmitPrimitive();</a>
<span class="sourceLineNo">814</span><a id="line.814">        public void emitUnboxed(C context, ObjExpr objx, GeneratorAdapter gen);</a>
<span class="sourceLineNo">815</span><a id="line.815">}</a>
<span class="sourceLineNo">816</span><a id="line.816"></a>
<span class="sourceLineNo">817</span><a id="line.817">static public abstract class HostExpr implements Expr, MaybePrimitiveExpr{</a>
<span class="sourceLineNo">818</span><a id="line.818">        final static Type BOOLEAN_TYPE = Type.getType(Boolean.class);</a>
<span class="sourceLineNo">819</span><a id="line.819">        final static Type CHAR_TYPE = Type.getType(Character.class);</a>
<span class="sourceLineNo">820</span><a id="line.820">        final static Type INTEGER_TYPE = Type.getType(Integer.class);</a>
<span class="sourceLineNo">821</span><a id="line.821">        final static Type LONG_TYPE = Type.getType(Long.class);</a>
<span class="sourceLineNo">822</span><a id="line.822">        final static Type FLOAT_TYPE = Type.getType(Float.class);</a>
<span class="sourceLineNo">823</span><a id="line.823">        final static Type DOUBLE_TYPE = Type.getType(Double.class);</a>
<span class="sourceLineNo">824</span><a id="line.824">        final static Type SHORT_TYPE = Type.getType(Short.class);</a>
<span class="sourceLineNo">825</span><a id="line.825">        final static Type BYTE_TYPE = Type.getType(Byte.class);</a>
<span class="sourceLineNo">826</span><a id="line.826">        final static Type NUMBER_TYPE = Type.getType(Number.class);</a>
<span class="sourceLineNo">827</span><a id="line.827"></a>
<span class="sourceLineNo">828</span><a id="line.828">        final static Method charValueMethod = Method.getMethod("char charValue()");</a>
<span class="sourceLineNo">829</span><a id="line.829">        final static Method booleanValueMethod = Method.getMethod("boolean booleanValue()");</a>
<span class="sourceLineNo">830</span><a id="line.830"></a>
<span class="sourceLineNo">831</span><a id="line.831">        final static Method charValueOfMethod = Method.getMethod("Character valueOf(char)");</a>
<span class="sourceLineNo">832</span><a id="line.832">        final static Method intValueOfMethod = Method.getMethod("Integer valueOf(int)");</a>
<span class="sourceLineNo">833</span><a id="line.833">        final static Method longValueOfMethod = Method.getMethod("Long valueOf(long)");</a>
<span class="sourceLineNo">834</span><a id="line.834">        final static Method floatValueOfMethod = Method.getMethod("Float valueOf(float)");</a>
<span class="sourceLineNo">835</span><a id="line.835">        final static Method doubleValueOfMethod = Method.getMethod("Double valueOf(double)");</a>
<span class="sourceLineNo">836</span><a id="line.836">        final static Method shortValueOfMethod = Method.getMethod("Short valueOf(short)");</a>
<span class="sourceLineNo">837</span><a id="line.837">        final static Method byteValueOfMethod = Method.getMethod("Byte valueOf(byte)");</a>
<span class="sourceLineNo">838</span><a id="line.838"></a>
<span class="sourceLineNo">839</span><a id="line.839">        final static Method intValueMethod = Method.getMethod("int intValue()");</a>
<span class="sourceLineNo">840</span><a id="line.840">        final static Method longValueMethod = Method.getMethod("long longValue()");</a>
<span class="sourceLineNo">841</span><a id="line.841">        final static Method floatValueMethod = Method.getMethod("float floatValue()");</a>
<span class="sourceLineNo">842</span><a id="line.842">        final static Method doubleValueMethod = Method.getMethod("double doubleValue()");</a>
<span class="sourceLineNo">843</span><a id="line.843">        final static Method byteValueMethod = Method.getMethod("byte byteValue()");</a>
<span class="sourceLineNo">844</span><a id="line.844">        final static Method shortValueMethod = Method.getMethod("short shortValue()");</a>
<span class="sourceLineNo">845</span><a id="line.845"></a>
<span class="sourceLineNo">846</span><a id="line.846">        final static Method fromIntMethod = Method.getMethod("clojure.lang.Num from(int)");</a>
<span class="sourceLineNo">847</span><a id="line.847">        final static Method fromLongMethod = Method.getMethod("clojure.lang.Num from(long)");</a>
<span class="sourceLineNo">848</span><a id="line.848">        final static Method fromDoubleMethod = Method.getMethod("clojure.lang.Num from(double)");</a>
<span class="sourceLineNo">849</span><a id="line.849"></a>
<span class="sourceLineNo">850</span><a id="line.850"></a>
<span class="sourceLineNo">851</span><a id="line.851">        //*</a>
<span class="sourceLineNo">852</span><a id="line.852">        public static void emitBoxReturn(ObjExpr objx, GeneratorAdapter gen, Class returnType){</a>
<span class="sourceLineNo">853</span><a id="line.853">                if(returnType.isPrimitive())</a>
<span class="sourceLineNo">854</span><a id="line.854">                        {</a>
<span class="sourceLineNo">855</span><a id="line.855">                        if(returnType == boolean.class)</a>
<span class="sourceLineNo">856</span><a id="line.856">                                {</a>
<span class="sourceLineNo">857</span><a id="line.857">                                Label falseLabel = gen.newLabel();</a>
<span class="sourceLineNo">858</span><a id="line.858">                                Label endLabel = gen.newLabel();</a>
<span class="sourceLineNo">859</span><a id="line.859">                                gen.ifZCmp(GeneratorAdapter.EQ, falseLabel);</a>
<span class="sourceLineNo">860</span><a id="line.860">                                gen.getStatic(BOOLEAN_OBJECT_TYPE, "TRUE", BOOLEAN_OBJECT_TYPE);</a>
<span class="sourceLineNo">861</span><a id="line.861">                                gen.goTo(endLabel);</a>
<span class="sourceLineNo">862</span><a id="line.862">                                gen.mark(falseLabel);</a>
<span class="sourceLineNo">863</span><a id="line.863">                                gen.getStatic(BOOLEAN_OBJECT_TYPE, "FALSE", BOOLEAN_OBJECT_TYPE);</a>
<span class="sourceLineNo">864</span><a id="line.864">//                              NIL_EXPR.emit(C.EXPRESSION, fn, gen);</a>
<span class="sourceLineNo">865</span><a id="line.865">                                gen.mark(endLabel);</a>
<span class="sourceLineNo">866</span><a id="line.866">                                }</a>
<span class="sourceLineNo">867</span><a id="line.867">                        else if(returnType == void.class)</a>
<span class="sourceLineNo">868</span><a id="line.868">                                {</a>
<span class="sourceLineNo">869</span><a id="line.869">                                NIL_EXPR.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">870</span><a id="line.870">                                }</a>
<span class="sourceLineNo">871</span><a id="line.871">                        else if(returnType == char.class)</a>
<span class="sourceLineNo">872</span><a id="line.872">                                        {</a>
<span class="sourceLineNo">873</span><a id="line.873">                                        gen.invokeStatic(CHAR_TYPE, charValueOfMethod);</a>
<span class="sourceLineNo">874</span><a id="line.874">                                        }</a>
<span class="sourceLineNo">875</span><a id="line.875">                                else</a>
<span class="sourceLineNo">876</span><a id="line.876">                                        {</a>
<span class="sourceLineNo">877</span><a id="line.877">                                        if(returnType == int.class)</a>
<span class="sourceLineNo">878</span><a id="line.878">                                                {</a>
<span class="sourceLineNo">879</span><a id="line.879">                                                gen.invokeStatic(INTEGER_TYPE, intValueOfMethod);</a>
<span class="sourceLineNo">880</span><a id="line.880">//                                              gen.visitInsn(I2L);</a>
<span class="sourceLineNo">881</span><a id="line.881">//                                              gen.invokeStatic(NUMBERS_TYPE, Method.getMethod("Number num(long)"));</a>
<span class="sourceLineNo">882</span><a id="line.882">                                                }</a>
<span class="sourceLineNo">883</span><a id="line.883">                                        else if(returnType == float.class)</a>
<span class="sourceLineNo">884</span><a id="line.884">                                                {</a>
<span class="sourceLineNo">885</span><a id="line.885">                                                gen.invokeStatic(FLOAT_TYPE, floatValueOfMethod);</a>
<span class="sourceLineNo">886</span><a id="line.886"></a>
<span class="sourceLineNo">887</span><a id="line.887">//                                              gen.visitInsn(F2D);</a>
<span class="sourceLineNo">888</span><a id="line.888">//                                              gen.invokeStatic(DOUBLE_TYPE, doubleValueOfMethod);</a>
<span class="sourceLineNo">889</span><a id="line.889">                                                }</a>
<span class="sourceLineNo">890</span><a id="line.890">                                        else if(returnType == double.class)</a>
<span class="sourceLineNo">891</span><a id="line.891">                                                        gen.invokeStatic(DOUBLE_TYPE, doubleValueOfMethod);</a>
<span class="sourceLineNo">892</span><a id="line.892">                                        else if(returnType == long.class)</a>
<span class="sourceLineNo">893</span><a id="line.893">                                                        gen.invokeStatic(NUMBERS_TYPE, Method.getMethod("Number num(long)"));</a>
<span class="sourceLineNo">894</span><a id="line.894">                                        else if(returnType == byte.class)</a>
<span class="sourceLineNo">895</span><a id="line.895">                                                        gen.invokeStatic(BYTE_TYPE, byteValueOfMethod);</a>
<span class="sourceLineNo">896</span><a id="line.896">                                        else if(returnType == short.class)</a>
<span class="sourceLineNo">897</span><a id="line.897">                                                        gen.invokeStatic(SHORT_TYPE, shortValueOfMethod);</a>
<span class="sourceLineNo">898</span><a id="line.898">                                        }</a>
<span class="sourceLineNo">899</span><a id="line.899">                        }</a>
<span class="sourceLineNo">900</span><a id="line.900">        }</a>
<span class="sourceLineNo">901</span><a id="line.901"></a>
<span class="sourceLineNo">902</span><a id="line.902">        //*/</a>
<span class="sourceLineNo">903</span><a id="line.903">        public static void emitUnboxArg(ObjExpr objx, GeneratorAdapter gen, Class paramType){</a>
<span class="sourceLineNo">904</span><a id="line.904">                if(paramType.isPrimitive())</a>
<span class="sourceLineNo">905</span><a id="line.905">                        {</a>
<span class="sourceLineNo">906</span><a id="line.906">                        if(paramType == boolean.class)</a>
<span class="sourceLineNo">907</span><a id="line.907">                                {</a>
<span class="sourceLineNo">908</span><a id="line.908">                                gen.checkCast(BOOLEAN_TYPE);</a>
<span class="sourceLineNo">909</span><a id="line.909">                                gen.invokeVirtual(BOOLEAN_TYPE, booleanValueMethod);</a>
<span class="sourceLineNo">910</span><a id="line.910">//                              Label falseLabel = gen.newLabel();</a>
<span class="sourceLineNo">911</span><a id="line.911">//                              Label endLabel = gen.newLabel();</a>
<span class="sourceLineNo">912</span><a id="line.912">//                              gen.ifNull(falseLabel);</a>
<span class="sourceLineNo">913</span><a id="line.913">//                              gen.push(1);</a>
<span class="sourceLineNo">914</span><a id="line.914">//                              gen.goTo(endLabel);</a>
<span class="sourceLineNo">915</span><a id="line.915">//                              gen.mark(falseLabel);</a>
<span class="sourceLineNo">916</span><a id="line.916">//                              gen.push(0);</a>
<span class="sourceLineNo">917</span><a id="line.917">//                              gen.mark(endLabel);</a>
<span class="sourceLineNo">918</span><a id="line.918">                                }</a>
<span class="sourceLineNo">919</span><a id="line.919">                        else if(paramType == char.class)</a>
<span class="sourceLineNo">920</span><a id="line.920">                                {</a>
<span class="sourceLineNo">921</span><a id="line.921">                                gen.checkCast(CHAR_TYPE);</a>
<span class="sourceLineNo">922</span><a id="line.922">                                gen.invokeVirtual(CHAR_TYPE, charValueMethod);</a>
<span class="sourceLineNo">923</span><a id="line.923">                                }</a>
<span class="sourceLineNo">924</span><a id="line.924">                        else</a>
<span class="sourceLineNo">925</span><a id="line.925">                                {</a>
<span class="sourceLineNo">926</span><a id="line.926">//                              System.out.println("NOT fnexpr for defn var: " + var + "init: " + init.getClass());</a>
<span class="sourceLineNo">927</span><a id="line.927">                                Method m = null;</a>
<span class="sourceLineNo">928</span><a id="line.928">                                gen.checkCast(NUMBER_TYPE);</a>
<span class="sourceLineNo">929</span><a id="line.929">                                if(RT.booleanCast(RT.UNCHECKED_MATH.deref()))</a>
<span class="sourceLineNo">930</span><a id="line.930">                                        {</a>
<span class="sourceLineNo">931</span><a id="line.931">                                        if(paramType == int.class)</a>
<span class="sourceLineNo">932</span><a id="line.932">                                                m = Method.getMethod("int uncheckedIntCast(Object)");</a>
<span class="sourceLineNo">933</span><a id="line.933">                                        else if(paramType == float.class)</a>
<span class="sourceLineNo">934</span><a id="line.934">                                                m = Method.getMethod("float uncheckedFloatCast(Object)");</a>
<span class="sourceLineNo">935</span><a id="line.935">                                        else if(paramType == double.class)</a>
<span class="sourceLineNo">936</span><a id="line.936">                                                m = Method.getMethod("double uncheckedDoubleCast(Object)");</a>
<span class="sourceLineNo">937</span><a id="line.937">                                        else if(paramType == long.class)</a>
<span class="sourceLineNo">938</span><a id="line.938">                                                m = Method.getMethod("long uncheckedLongCast(Object)");</a>
<span class="sourceLineNo">939</span><a id="line.939">                                        else if(paramType == byte.class)</a>
<span class="sourceLineNo">940</span><a id="line.940">                                                m = Method.getMethod("byte uncheckedByteCast(Object)");</a>
<span class="sourceLineNo">941</span><a id="line.941">                                        else if(paramType == short.class)</a>
<span class="sourceLineNo">942</span><a id="line.942">                                                m = Method.getMethod("short uncheckedShortCast(Object)");                                       </a>
<span class="sourceLineNo">943</span><a id="line.943">                                        }</a>
<span class="sourceLineNo">944</span><a id="line.944">                                else</a>
<span class="sourceLineNo">945</span><a id="line.945">                                        {</a>
<span class="sourceLineNo">946</span><a id="line.946">                                        if(paramType == int.class)</a>
<span class="sourceLineNo">947</span><a id="line.947">                                                m = Method.getMethod("int intCast(Object)");</a>
<span class="sourceLineNo">948</span><a id="line.948">                                        else if(paramType == float.class)</a>
<span class="sourceLineNo">949</span><a id="line.949">                                                m = Method.getMethod("float floatCast(Object)");</a>
<span class="sourceLineNo">950</span><a id="line.950">                                        else if(paramType == double.class)</a>
<span class="sourceLineNo">951</span><a id="line.951">                                                m = Method.getMethod("double doubleCast(Object)");</a>
<span class="sourceLineNo">952</span><a id="line.952">                                        else if(paramType == long.class)</a>
<span class="sourceLineNo">953</span><a id="line.953">                                                m = Method.getMethod("long longCast(Object)");</a>
<span class="sourceLineNo">954</span><a id="line.954">                                        else if(paramType == byte.class)</a>
<span class="sourceLineNo">955</span><a id="line.955">                                                m = Method.getMethod("byte byteCast(Object)");</a>
<span class="sourceLineNo">956</span><a id="line.956">                                        else if(paramType == short.class)</a>
<span class="sourceLineNo">957</span><a id="line.957">                                                m = Method.getMethod("short shortCast(Object)");</a>
<span class="sourceLineNo">958</span><a id="line.958">                                        }</a>
<span class="sourceLineNo">959</span><a id="line.959">                                gen.invokeStatic(RT_TYPE, m);</a>
<span class="sourceLineNo">960</span><a id="line.960">                                }</a>
<span class="sourceLineNo">961</span><a id="line.961">                        }</a>
<span class="sourceLineNo">962</span><a id="line.962">                else</a>
<span class="sourceLineNo">963</span><a id="line.963">                        {</a>
<span class="sourceLineNo">964</span><a id="line.964">                        gen.checkCast(Type.getType(paramType));</a>
<span class="sourceLineNo">965</span><a id="line.965">                        }</a>
<span class="sourceLineNo">966</span><a id="line.966">        }</a>
<span class="sourceLineNo">967</span><a id="line.967"></a>
<span class="sourceLineNo">968</span><a id="line.968">        static class Parser implements IParser{</a>
<span class="sourceLineNo">969</span><a id="line.969">                public Expr parse(C context, Object frm) {</a>
<span class="sourceLineNo">970</span><a id="line.970">                        ISeq form = (ISeq) frm;</a>
<span class="sourceLineNo">971</span><a id="line.971">                        //(. x fieldname-sym) or</a>
<span class="sourceLineNo">972</span><a id="line.972">                        //(. x 0-ary-method)</a>
<span class="sourceLineNo">973</span><a id="line.973">                        // (. x methodname-sym args+)</a>
<span class="sourceLineNo">974</span><a id="line.974">                        // (. x (methodname-sym args?))</a>
<span class="sourceLineNo">975</span><a id="line.975">                        if(RT.length(form) &lt; 3)</a>
<span class="sourceLineNo">976</span><a id="line.976">                                throw new IllegalArgumentException("Malformed member expression, expecting (. target member ...)");</a>
<span class="sourceLineNo">977</span><a id="line.977">                        //determine static or instance</a>
<span class="sourceLineNo">978</span><a id="line.978">                        //static target must be symbol, either fully.qualified.Classname or Classname that has been imported</a>
<span class="sourceLineNo">979</span><a id="line.979">                        int line = lineDeref();</a>
<span class="sourceLineNo">980</span><a id="line.980">                        int column = columnDeref();</a>
<span class="sourceLineNo">981</span><a id="line.981">                        String source = (String) SOURCE.deref();</a>
<span class="sourceLineNo">982</span><a id="line.982">                        Class c = maybeClass(RT.second(form), false);</a>
<span class="sourceLineNo">983</span><a id="line.983">                        //at this point c will be non-null if static</a>
<span class="sourceLineNo">984</span><a id="line.984">                        Expr instance = null;</a>
<span class="sourceLineNo">985</span><a id="line.985">                        if(c == null)</a>
<span class="sourceLineNo">986</span><a id="line.986">                                instance = analyze(context == C.EVAL ? context : C.EXPRESSION, RT.second(form));</a>
<span class="sourceLineNo">987</span><a id="line.987"></a>
<span class="sourceLineNo">988</span><a id="line.988">                        boolean maybeField = RT.length(form) == 3 &amp;&amp; (RT.third(form) instanceof Symbol);</a>
<span class="sourceLineNo">989</span><a id="line.989"></a>
<span class="sourceLineNo">990</span><a id="line.990">                        if(maybeField &amp;&amp; !(((Symbol)RT.third(form)).name.charAt(0) == '-'))</a>
<span class="sourceLineNo">991</span><a id="line.991">                                {</a>
<span class="sourceLineNo">992</span><a id="line.992">                                Symbol sym = (Symbol) RT.third(form);</a>
<span class="sourceLineNo">993</span><a id="line.993">                                if(c != null)</a>
<span class="sourceLineNo">994</span><a id="line.994">                                        maybeField = Reflector.getMethods(c, 0, munge(sym.name), true).size() == 0;</a>
<span class="sourceLineNo">995</span><a id="line.995">                                else if(instance != null &amp;&amp; instance.hasJavaClass() &amp;&amp; instance.getJavaClass() != null)</a>
<span class="sourceLineNo">996</span><a id="line.996">                                        maybeField = Reflector.getMethods(instance.getJavaClass(), 0, munge(sym.name), false).size() == 0;</a>
<span class="sourceLineNo">997</span><a id="line.997">                                }</a>
<span class="sourceLineNo">998</span><a id="line.998"></a>
<span class="sourceLineNo">999</span><a id="line.999">                        if(maybeField)    //field</a>
<span class="sourceLineNo">1000</span><a id="line.1000">                                {</a>
<span class="sourceLineNo">1001</span><a id="line.1001">                                Symbol sym = (((Symbol)RT.third(form)).name.charAt(0) == '-') ?</a>
<span class="sourceLineNo">1002</span><a id="line.1002">                                        Symbol.intern(((Symbol)RT.third(form)).name.substring(1))</a>
<span class="sourceLineNo">1003</span><a id="line.1003">                                                :(Symbol) RT.third(form);</a>
<span class="sourceLineNo">1004</span><a id="line.1004">                                Symbol tag = tagOf(form);</a>
<span class="sourceLineNo">1005</span><a id="line.1005">                                if(c != null) {</a>
<span class="sourceLineNo">1006</span><a id="line.1006">                                        return new StaticFieldExpr(line, column, c, munge(sym.name), tag);</a>
<span class="sourceLineNo">1007</span><a id="line.1007">                                } else</a>
<span class="sourceLineNo">1008</span><a id="line.1008">                                        return new InstanceFieldExpr(line, column, instance, munge(sym.name), tag, (((Symbol)RT.third(form)).name.charAt(0) == '-'));</a>
<span class="sourceLineNo">1009</span><a id="line.1009">                                }</a>
<span class="sourceLineNo">1010</span><a id="line.1010">                        else</a>
<span class="sourceLineNo">1011</span><a id="line.1011">                                {</a>
<span class="sourceLineNo">1012</span><a id="line.1012">                                ISeq call = (ISeq) ((RT.third(form) instanceof ISeq) ? RT.third(form) : RT.next(RT.next(form)));</a>
<span class="sourceLineNo">1013</span><a id="line.1013">                                if(!(RT.first(call) instanceof Symbol))</a>
<span class="sourceLineNo">1014</span><a id="line.1014">                                        throw new IllegalArgumentException("Malformed member expression");</a>
<span class="sourceLineNo">1015</span><a id="line.1015">                                Symbol sym = (Symbol) RT.first(call);</a>
<span class="sourceLineNo">1016</span><a id="line.1016">                                Symbol tag = tagOf(form);</a>
<span class="sourceLineNo">1017</span><a id="line.1017">                                PersistentVector args = PersistentVector.EMPTY;</a>
<span class="sourceLineNo">1018</span><a id="line.1018">                                boolean tailPosition = inTailCall(context);</a>
<span class="sourceLineNo">1019</span><a id="line.1019">                                for(ISeq s = RT.next(call); s != null; s = s.next())</a>
<span class="sourceLineNo">1020</span><a id="line.1020">                                        args = args.cons(analyze(context == C.EVAL ? context : C.EXPRESSION, s.first()));</a>
<span class="sourceLineNo">1021</span><a id="line.1021">                                if(c != null)</a>
<span class="sourceLineNo">1022</span><a id="line.1022">                                        return new StaticMethodExpr(source, line, column, tag, c, munge(sym.name), args, tailPosition);</a>
<span class="sourceLineNo">1023</span><a id="line.1023">                                else</a>
<span class="sourceLineNo">1024</span><a id="line.1024">                                        return new InstanceMethodExpr(source, line, column, tag, instance, munge(sym.name), args, tailPosition);</a>
<span class="sourceLineNo">1025</span><a id="line.1025">                                }</a>
<span class="sourceLineNo">1026</span><a id="line.1026">                }</a>
<span class="sourceLineNo">1027</span><a id="line.1027">        }</a>
<span class="sourceLineNo">1028</span><a id="line.1028"></a>
<span class="sourceLineNo">1029</span><a id="line.1029">        public static Class maybeClass(Object form, boolean stringOk) {</a>
<span class="sourceLineNo">1030</span><a id="line.1030">                if(form instanceof Class)</a>
<span class="sourceLineNo">1031</span><a id="line.1031">                        return (Class) form;</a>
<span class="sourceLineNo">1032</span><a id="line.1032">                Class c = null;</a>
<span class="sourceLineNo">1033</span><a id="line.1033">                if(form instanceof Symbol)</a>
<span class="sourceLineNo">1034</span><a id="line.1034">                        {</a>
<span class="sourceLineNo">1035</span><a id="line.1035">                        Symbol sym = (Symbol) form;</a>
<span class="sourceLineNo">1036</span><a id="line.1036">                        if(sym.ns == null) //if ns-qualified can't be classname</a>
<span class="sourceLineNo">1037</span><a id="line.1037">                                {</a>
<span class="sourceLineNo">1038</span><a id="line.1038">                                if(Util.equals(sym,COMPILE_STUB_SYM.get()))</a>
<span class="sourceLineNo">1039</span><a id="line.1039">                                        return (Class) COMPILE_STUB_CLASS.get();</a>
<span class="sourceLineNo">1040</span><a id="line.1040">                                if(sym.name.indexOf('.') &gt; 0 || sym.name.charAt(0) == '[')</a>
<span class="sourceLineNo">1041</span><a id="line.1041">                                        c = RT.classForNameNonLoading(sym.name);</a>
<span class="sourceLineNo">1042</span><a id="line.1042">                                else</a>
<span class="sourceLineNo">1043</span><a id="line.1043">                                        {</a>
<span class="sourceLineNo">1044</span><a id="line.1044">                                        Object o = currentNS().getMapping(sym);</a>
<span class="sourceLineNo">1045</span><a id="line.1045">                                        if(o instanceof Class)</a>
<span class="sourceLineNo">1046</span><a id="line.1046">                                                c = (Class) o;</a>
<span class="sourceLineNo">1047</span><a id="line.1047">                                        else if(LOCAL_ENV.deref() != null &amp;&amp; ((java.util.Map)LOCAL_ENV.deref()).containsKey(form))</a>
<span class="sourceLineNo">1048</span><a id="line.1048">                                                return null;</a>
<span class="sourceLineNo">1049</span><a id="line.1049">                                        else</a>
<span class="sourceLineNo">1050</span><a id="line.1050">                                                {</a>
<span class="sourceLineNo">1051</span><a id="line.1051">                                                try{</a>
<span class="sourceLineNo">1052</span><a id="line.1052">                                                c = RT.classForNameNonLoading(sym.name);</a>
<span class="sourceLineNo">1053</span><a id="line.1053">                                                }</a>
<span class="sourceLineNo">1054</span><a id="line.1054">                                                catch(Exception e){</a>
<span class="sourceLineNo">1055</span><a id="line.1055">                                                        // aargh</a>
<span class="sourceLineNo">1056</span><a id="line.1056">                                                        // leave c set to null -&gt; return null</a>
<span class="sourceLineNo">1057</span><a id="line.1057">                                                }</a>
<span class="sourceLineNo">1058</span><a id="line.1058">                                                }</a>
<span class="sourceLineNo">1059</span><a id="line.1059">                                        }</a>
<span class="sourceLineNo">1060</span><a id="line.1060">                                }</a>
<span class="sourceLineNo">1061</span><a id="line.1061">                        }</a>
<span class="sourceLineNo">1062</span><a id="line.1062">                else if(stringOk &amp;&amp; form instanceof String)</a>
<span class="sourceLineNo">1063</span><a id="line.1063">                        c = RT.classForNameNonLoading((String) form);</a>
<span class="sourceLineNo">1064</span><a id="line.1064">                return c;</a>
<span class="sourceLineNo">1065</span><a id="line.1065">        }</a>
<span class="sourceLineNo">1066</span><a id="line.1066"></a>
<span class="sourceLineNo">1067</span><a id="line.1067">        /*</a>
<span class="sourceLineNo">1068</span><a id="line.1068">         private static String maybeClassName(Object form, boolean stringOk){</a>
<span class="sourceLineNo">1069</span><a id="line.1069">                 String className = null;</a>
<span class="sourceLineNo">1070</span><a id="line.1070">                 if(form instanceof Symbol)</a>
<span class="sourceLineNo">1071</span><a id="line.1071">                         {</a>
<span class="sourceLineNo">1072</span><a id="line.1072">                         Symbol sym = (Symbol) form;</a>
<span class="sourceLineNo">1073</span><a id="line.1073">                         if(sym.ns == null) //if ns-qualified can't be classname</a>
<span class="sourceLineNo">1074</span><a id="line.1074">                                 {</a>
<span class="sourceLineNo">1075</span><a id="line.1075">                                 if(sym.name.indexOf('.') &gt; 0 || sym.name.charAt(0) == '[')</a>
<span class="sourceLineNo">1076</span><a id="line.1076">                                         className = sym.name;</a>
<span class="sourceLineNo">1077</span><a id="line.1077">                                 else</a>
<span class="sourceLineNo">1078</span><a id="line.1078">                                         {</a>
<span class="sourceLineNo">1079</span><a id="line.1079">                                         IPersistentMap imports = (IPersistentMap) ((Var) RT.NS_IMPORTS.get()).get();</a>
<span class="sourceLineNo">1080</span><a id="line.1080">                                         className = (String) imports.valAt(sym);</a>
<span class="sourceLineNo">1081</span><a id="line.1081">                                         }</a>
<span class="sourceLineNo">1082</span><a id="line.1082">                                 }</a>
<span class="sourceLineNo">1083</span><a id="line.1083">                         }</a>
<span class="sourceLineNo">1084</span><a id="line.1084">                 else if(stringOk &amp;&amp; form instanceof String)</a>
<span class="sourceLineNo">1085</span><a id="line.1085">                         className = (String) form;</a>
<span class="sourceLineNo">1086</span><a id="line.1086">                 return className;</a>
<span class="sourceLineNo">1087</span><a id="line.1087">         }</a>
<span class="sourceLineNo">1088</span><a id="line.1088"> */</a>
<span class="sourceLineNo">1089</span><a id="line.1089">    public static Class maybeSpecialTag(Symbol sym) {</a>
<span class="sourceLineNo">1090</span><a id="line.1090">                Class c = primClass(sym);</a>
<span class="sourceLineNo">1091</span><a id="line.1091">                if (c != null)</a>
<span class="sourceLineNo">1092</span><a id="line.1092">                        return c;</a>
<span class="sourceLineNo">1093</span><a id="line.1093">                else if(sym.name.equals("objects"))</a>
<span class="sourceLineNo">1094</span><a id="line.1094">                        c = Object[].class;</a>
<span class="sourceLineNo">1095</span><a id="line.1095">                else if(sym.name.equals("ints"))</a>
<span class="sourceLineNo">1096</span><a id="line.1096">                        c = int[].class;</a>
<span class="sourceLineNo">1097</span><a id="line.1097">                else if(sym.name.equals("longs"))</a>
<span class="sourceLineNo">1098</span><a id="line.1098">                        c = long[].class;</a>
<span class="sourceLineNo">1099</span><a id="line.1099">                else if(sym.name.equals("floats"))</a>
<span class="sourceLineNo">1100</span><a id="line.1100">                        c = float[].class;</a>
<span class="sourceLineNo">1101</span><a id="line.1101">                else if(sym.name.equals("doubles"))</a>
<span class="sourceLineNo">1102</span><a id="line.1102">                        c = double[].class;</a>
<span class="sourceLineNo">1103</span><a id="line.1103">                else if(sym.name.equals("chars"))</a>
<span class="sourceLineNo">1104</span><a id="line.1104">                        c = char[].class;</a>
<span class="sourceLineNo">1105</span><a id="line.1105">                else if(sym.name.equals("shorts"))</a>
<span class="sourceLineNo">1106</span><a id="line.1106">                        c = short[].class;</a>
<span class="sourceLineNo">1107</span><a id="line.1107">                else if(sym.name.equals("bytes"))</a>
<span class="sourceLineNo">1108</span><a id="line.1108">                        c = byte[].class;</a>
<span class="sourceLineNo">1109</span><a id="line.1109">                else if(sym.name.equals("booleans"))</a>
<span class="sourceLineNo">1110</span><a id="line.1110">                        c = boolean[].class;</a>
<span class="sourceLineNo">1111</span><a id="line.1111">                return c;</a>
<span class="sourceLineNo">1112</span><a id="line.1112">    }</a>
<span class="sourceLineNo">1113</span><a id="line.1113"></a>
<span class="sourceLineNo">1114</span><a id="line.1114"></a>
<span class="sourceLineNo">1115</span><a id="line.1115">        static Class tagToClass(Object tag) {</a>
<span class="sourceLineNo">1116</span><a id="line.1116">                Class c = null;</a>
<span class="sourceLineNo">1117</span><a id="line.1117">        if(tag instanceof Symbol)</a>
<span class="sourceLineNo">1118</span><a id="line.1118">                        {</a>
<span class="sourceLineNo">1119</span><a id="line.1119">                        Symbol sym = (Symbol) tag;</a>
<span class="sourceLineNo">1120</span><a id="line.1120">                        if(sym.ns == null) //if ns-qualified can't be classname</a>
<span class="sourceLineNo">1121</span><a id="line.1121">                                {</a>
<span class="sourceLineNo">1122</span><a id="line.1122">                                c = maybeSpecialTag(sym);</a>
<span class="sourceLineNo">1123</span><a id="line.1123">                                }</a>
<span class="sourceLineNo">1124</span><a id="line.1124">                        }</a>
<span class="sourceLineNo">1125</span><a id="line.1125">                if(c == null)</a>
<span class="sourceLineNo">1126</span><a id="line.1126">                    c = maybeClass(tag, true);</a>
<span class="sourceLineNo">1127</span><a id="line.1127">                if(c != null)</a>
<span class="sourceLineNo">1128</span><a id="line.1128">                        return c;</a>
<span class="sourceLineNo">1129</span><a id="line.1129">                throw new IllegalArgumentException("Unable to resolve classname: " + tag);</a>
<span class="sourceLineNo">1130</span><a id="line.1130">        }</a>
<span class="sourceLineNo">1131</span><a id="line.1131">}</a>
<span class="sourceLineNo">1132</span><a id="line.1132"></a>
<span class="sourceLineNo">1133</span><a id="line.1133">static abstract class FieldExpr extends HostExpr{</a>
<span class="sourceLineNo">1134</span><a id="line.1134">}</a>
<span class="sourceLineNo">1135</span><a id="line.1135"></a>
<span class="sourceLineNo">1136</span><a id="line.1136">static class InstanceFieldExpr extends FieldExpr implements AssignableExpr{</a>
<span class="sourceLineNo">1137</span><a id="line.1137">        public final Expr target;</a>
<span class="sourceLineNo">1138</span><a id="line.1138">        public final Class targetClass;</a>
<span class="sourceLineNo">1139</span><a id="line.1139">        public final java.lang.reflect.Field field;</a>
<span class="sourceLineNo">1140</span><a id="line.1140">        public final String fieldName;</a>
<span class="sourceLineNo">1141</span><a id="line.1141">        public final int line;</a>
<span class="sourceLineNo">1142</span><a id="line.1142">        public final int column;</a>
<span class="sourceLineNo">1143</span><a id="line.1143">        public final Symbol tag;</a>
<span class="sourceLineNo">1144</span><a id="line.1144">        public final boolean requireField;</a>
<span class="sourceLineNo">1145</span><a id="line.1145">        final static Method invokeNoArgInstanceMember = Method.getMethod("Object invokeNoArgInstanceMember(Object,String,boolean)");</a>
<span class="sourceLineNo">1146</span><a id="line.1146">        final static Method setInstanceFieldMethod = Method.getMethod("Object setInstanceField(Object,String,Object)");</a>
<span class="sourceLineNo">1147</span><a id="line.1147"></a>
<span class="sourceLineNo">1148</span><a id="line.1148">    Class jc;</a>
<span class="sourceLineNo">1149</span><a id="line.1149"></a>
<span class="sourceLineNo">1150</span><a id="line.1150">        public InstanceFieldExpr(int line, int column, Expr target, String fieldName, Symbol tag, boolean requireField) {</a>
<span class="sourceLineNo">1151</span><a id="line.1151">                this.target = target;</a>
<span class="sourceLineNo">1152</span><a id="line.1152">                this.targetClass = target.hasJavaClass() ? target.getJavaClass() : null;</a>
<span class="sourceLineNo">1153</span><a id="line.1153">                this.field = targetClass != null ? Reflector.getField(targetClass, fieldName, false) : null;</a>
<span class="sourceLineNo">1154</span><a id="line.1154">                this.fieldName = fieldName;</a>
<span class="sourceLineNo">1155</span><a id="line.1155">                this.line = line;</a>
<span class="sourceLineNo">1156</span><a id="line.1156">                this.column = column;</a>
<span class="sourceLineNo">1157</span><a id="line.1157">                this.tag = tag;</a>
<span class="sourceLineNo">1158</span><a id="line.1158">                this.requireField = requireField;</a>
<span class="sourceLineNo">1159</span><a id="line.1159">                if(field == null &amp;&amp; RT.booleanCast(RT.WARN_ON_REFLECTION.deref()))</a>
<span class="sourceLineNo">1160</span><a id="line.1160">                        {</a>
<span class="sourceLineNo">1161</span><a id="line.1161">                        if(targetClass == null)</a>
<span class="sourceLineNo">1162</span><a id="line.1162">                                {</a>
<span class="sourceLineNo">1163</span><a id="line.1163">                                RT.errPrintWriter()</a>
<span class="sourceLineNo">1164</span><a id="line.1164">                                        .format("Reflection warning, %s:%d:%d - reference to field %s can't be resolved.\n",</a>
<span class="sourceLineNo">1165</span><a id="line.1165">                                                                        SOURCE_PATH.deref(), line, column, fieldName);</a>
<span class="sourceLineNo">1166</span><a id="line.1166">                                }</a>
<span class="sourceLineNo">1167</span><a id="line.1167">                        else</a>
<span class="sourceLineNo">1168</span><a id="line.1168">                                {</a>
<span class="sourceLineNo">1169</span><a id="line.1169">                                RT.errPrintWriter()</a>
<span class="sourceLineNo">1170</span><a id="line.1170">                                        .format("Reflection warning, %s:%d:%d - reference to field %s on %s can't be resolved.\n",</a>
<span class="sourceLineNo">1171</span><a id="line.1171">                                                                        SOURCE_PATH.deref(), line, column, fieldName, targetClass.getName());</a>
<span class="sourceLineNo">1172</span><a id="line.1172">                                }</a>
<span class="sourceLineNo">1173</span><a id="line.1173">                        }</a>
<span class="sourceLineNo">1174</span><a id="line.1174">        }</a>
<span class="sourceLineNo">1175</span><a id="line.1175"></a>
<span class="sourceLineNo">1176</span><a id="line.1176">        public Object eval() {</a>
<span class="sourceLineNo">1177</span><a id="line.1177">                return Reflector.invokeNoArgInstanceMember(target.eval(), fieldName, requireField);</a>
<span class="sourceLineNo">1178</span><a id="line.1178">        }</a>
<span class="sourceLineNo">1179</span><a id="line.1179"></a>
<span class="sourceLineNo">1180</span><a id="line.1180">        public boolean canEmitPrimitive(){</a>
<span class="sourceLineNo">1181</span><a id="line.1181">                return targetClass != null &amp;&amp; field != null &amp;&amp;</a>
<span class="sourceLineNo">1182</span><a id="line.1182">                       Util.isPrimitive(field.getType());</a>
<span class="sourceLineNo">1183</span><a id="line.1183">        }</a>
<span class="sourceLineNo">1184</span><a id="line.1184"></a>
<span class="sourceLineNo">1185</span><a id="line.1185">        public void emitUnboxed(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">1186</span><a id="line.1186">                if(targetClass != null &amp;&amp; field != null)</a>
<span class="sourceLineNo">1187</span><a id="line.1187">                        {</a>
<span class="sourceLineNo">1188</span><a id="line.1188">                        target.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">1189</span><a id="line.1189">                        gen.visitLineNumber(line, gen.mark());</a>
<span class="sourceLineNo">1190</span><a id="line.1190">                        gen.checkCast(getType(targetClass));</a>
<span class="sourceLineNo">1191</span><a id="line.1191">                        gen.getField(getType(targetClass), fieldName, Type.getType(field.getType()));</a>
<span class="sourceLineNo">1192</span><a id="line.1192">                        }</a>
<span class="sourceLineNo">1193</span><a id="line.1193">                else</a>
<span class="sourceLineNo">1194</span><a id="line.1194">                        throw new UnsupportedOperationException("Unboxed emit of unknown member");</a>
<span class="sourceLineNo">1195</span><a id="line.1195">        }</a>
<span class="sourceLineNo">1196</span><a id="line.1196"></a>
<span class="sourceLineNo">1197</span><a id="line.1197">        public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">1198</span><a id="line.1198">                if(targetClass != null &amp;&amp; field != null)</a>
<span class="sourceLineNo">1199</span><a id="line.1199">                        {</a>
<span class="sourceLineNo">1200</span><a id="line.1200">                        target.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">1201</span><a id="line.1201">                        gen.visitLineNumber(line, gen.mark());</a>
<span class="sourceLineNo">1202</span><a id="line.1202">                        gen.checkCast(getType(targetClass));</a>
<span class="sourceLineNo">1203</span><a id="line.1203">                        gen.getField(getType(targetClass), fieldName, Type.getType(field.getType()));</a>
<span class="sourceLineNo">1204</span><a id="line.1204">                        //if(context != C.STATEMENT)</a>
<span class="sourceLineNo">1205</span><a id="line.1205">                        HostExpr.emitBoxReturn(objx, gen, field.getType());</a>
<span class="sourceLineNo">1206</span><a id="line.1206">                        if(context == C.STATEMENT)</a>
<span class="sourceLineNo">1207</span><a id="line.1207">                                {</a>
<span class="sourceLineNo">1208</span><a id="line.1208">                                gen.pop();</a>
<span class="sourceLineNo">1209</span><a id="line.1209">                                }</a>
<span class="sourceLineNo">1210</span><a id="line.1210">                        }</a>
<span class="sourceLineNo">1211</span><a id="line.1211">                else</a>
<span class="sourceLineNo">1212</span><a id="line.1212">                        {</a>
<span class="sourceLineNo">1213</span><a id="line.1213">                        target.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">1214</span><a id="line.1214">                        gen.visitLineNumber(line, gen.mark());</a>
<span class="sourceLineNo">1215</span><a id="line.1215">                        gen.push(fieldName);</a>
<span class="sourceLineNo">1216</span><a id="line.1216">                        gen.push(requireField);</a>
<span class="sourceLineNo">1217</span><a id="line.1217">                        gen.invokeStatic(REFLECTOR_TYPE, invokeNoArgInstanceMember);</a>
<span class="sourceLineNo">1218</span><a id="line.1218">                        if(context == C.STATEMENT)</a>
<span class="sourceLineNo">1219</span><a id="line.1219">                                gen.pop();</a>
<span class="sourceLineNo">1220</span><a id="line.1220">                        }</a>
<span class="sourceLineNo">1221</span><a id="line.1221">        }</a>
<span class="sourceLineNo">1222</span><a id="line.1222"></a>
<span class="sourceLineNo">1223</span><a id="line.1223">        public boolean hasJavaClass() {</a>
<span class="sourceLineNo">1224</span><a id="line.1224">                return field != null || tag != null;</a>
<span class="sourceLineNo">1225</span><a id="line.1225">        }</a>
<span class="sourceLineNo">1226</span><a id="line.1226"></a>
<span class="sourceLineNo">1227</span><a id="line.1227">        public Class getJavaClass() {</a>
<span class="sourceLineNo">1228</span><a id="line.1228">        if (jc == null)</a>
<span class="sourceLineNo">1229</span><a id="line.1229">            jc = tag != null ? HostExpr.tagToClass(tag) : field.getType();</a>
<span class="sourceLineNo">1230</span><a id="line.1230">        return jc;</a>
<span class="sourceLineNo">1231</span><a id="line.1231">        }</a>
<span class="sourceLineNo">1232</span><a id="line.1232"></a>
<span class="sourceLineNo">1233</span><a id="line.1233">        public Object evalAssign(Expr val) {</a>
<span class="sourceLineNo">1234</span><a id="line.1234">                return Reflector.setInstanceField(target.eval(), fieldName, val.eval());</a>
<span class="sourceLineNo">1235</span><a id="line.1235">        }</a>
<span class="sourceLineNo">1236</span><a id="line.1236"></a>
<span class="sourceLineNo">1237</span><a id="line.1237">        public void emitAssign(C context, ObjExpr objx, GeneratorAdapter gen,</a>
<span class="sourceLineNo">1238</span><a id="line.1238">                               Expr val){</a>
<span class="sourceLineNo">1239</span><a id="line.1239">                if(targetClass != null &amp;&amp; field != null)</a>
<span class="sourceLineNo">1240</span><a id="line.1240">                        {</a>
<span class="sourceLineNo">1241</span><a id="line.1241">                        target.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">1242</span><a id="line.1242">                        gen.checkCast(getType(targetClass));</a>
<span class="sourceLineNo">1243</span><a id="line.1243">                        val.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">1244</span><a id="line.1244">                        gen.visitLineNumber(line, gen.mark());</a>
<span class="sourceLineNo">1245</span><a id="line.1245">                        gen.dupX1();</a>
<span class="sourceLineNo">1246</span><a id="line.1246">                        HostExpr.emitUnboxArg(objx, gen, field.getType());</a>
<span class="sourceLineNo">1247</span><a id="line.1247">                        gen.putField(getType(targetClass), fieldName, Type.getType(field.getType()));</a>
<span class="sourceLineNo">1248</span><a id="line.1248">                        }</a>
<span class="sourceLineNo">1249</span><a id="line.1249">                else</a>
<span class="sourceLineNo">1250</span><a id="line.1250">                        {</a>
<span class="sourceLineNo">1251</span><a id="line.1251">                        target.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">1252</span><a id="line.1252">                        gen.push(fieldName);</a>
<span class="sourceLineNo">1253</span><a id="line.1253">                        val.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">1254</span><a id="line.1254">                        gen.visitLineNumber(line, gen.mark());</a>
<span class="sourceLineNo">1255</span><a id="line.1255">                        gen.invokeStatic(REFLECTOR_TYPE, setInstanceFieldMethod);</a>
<span class="sourceLineNo">1256</span><a id="line.1256">                        }</a>
<span class="sourceLineNo">1257</span><a id="line.1257">                if(context == C.STATEMENT)</a>
<span class="sourceLineNo">1258</span><a id="line.1258">                        gen.pop();</a>
<span class="sourceLineNo">1259</span><a id="line.1259">        }</a>
<span class="sourceLineNo">1260</span><a id="line.1260">}</a>
<span class="sourceLineNo">1261</span><a id="line.1261"></a>
<span class="sourceLineNo">1262</span><a id="line.1262">static class StaticFieldExpr extends FieldExpr implements AssignableExpr{</a>
<span class="sourceLineNo">1263</span><a id="line.1263">        //final String className;</a>
<span class="sourceLineNo">1264</span><a id="line.1264">        public final String fieldName;</a>
<span class="sourceLineNo">1265</span><a id="line.1265">        public final Class c;</a>
<span class="sourceLineNo">1266</span><a id="line.1266">        public final java.lang.reflect.Field field;</a>
<span class="sourceLineNo">1267</span><a id="line.1267">        public final Symbol tag;</a>
<span class="sourceLineNo">1268</span><a id="line.1268">//      final static Method getStaticFieldMethod = Method.getMethod("Object getStaticField(String,String)");</a>
<span class="sourceLineNo">1269</span><a id="line.1269">//      final static Method setStaticFieldMethod = Method.getMethod("Object setStaticField(String,String,Object)");</a>
<span class="sourceLineNo">1270</span><a id="line.1270">        final int line;</a>
<span class="sourceLineNo">1271</span><a id="line.1271">        final int column;</a>
<span class="sourceLineNo">1272</span><a id="line.1272"></a>
<span class="sourceLineNo">1273</span><a id="line.1273">    Class jc;</a>
<span class="sourceLineNo">1274</span><a id="line.1274"></a>
<span class="sourceLineNo">1275</span><a id="line.1275">        public StaticFieldExpr(int line, int column, Class c, String fieldName, Symbol tag) {</a>
<span class="sourceLineNo">1276</span><a id="line.1276">                //this.className = className;</a>
<span class="sourceLineNo">1277</span><a id="line.1277">                this.fieldName = fieldName;</a>
<span class="sourceLineNo">1278</span><a id="line.1278">                this.line = line;</a>
<span class="sourceLineNo">1279</span><a id="line.1279">                this.column = column;</a>
<span class="sourceLineNo">1280</span><a id="line.1280">                //c = Class.forName(className);</a>
<span class="sourceLineNo">1281</span><a id="line.1281">                this.c = c;</a>
<span class="sourceLineNo">1282</span><a id="line.1282">                try</a>
<span class="sourceLineNo">1283</span><a id="line.1283">                        {</a>
<span class="sourceLineNo">1284</span><a id="line.1284">                        field = c.getField(fieldName);</a>
<span class="sourceLineNo">1285</span><a id="line.1285">                        }</a>
<span class="sourceLineNo">1286</span><a id="line.1286">                catch(NoSuchFieldException e)</a>
<span class="sourceLineNo">1287</span><a id="line.1287">                        {</a>
<span class="sourceLineNo">1288</span><a id="line.1288">            for (java.lang.reflect.Method m: c.getMethods())</a>
<span class="sourceLineNo">1289</span><a id="line.1289">                if (fieldName.equals(m.getName()) &amp;&amp; (Modifier.isStatic(m.getModifiers())))</a>
<span class="sourceLineNo">1290</span><a id="line.1290">                    throw new IllegalArgumentException("No matching method " +</a>
<span class="sourceLineNo">1291</span><a id="line.1291">                            fieldName +</a>
<span class="sourceLineNo">1292</span><a id="line.1292">                            " found taking 0 args for " +</a>
<span class="sourceLineNo">1293</span><a id="line.1293">                            c);</a>
<span class="sourceLineNo">1294</span><a id="line.1294">                        throw Util.sneakyThrow(e);</a>
<span class="sourceLineNo">1295</span><a id="line.1295">                        }</a>
<span class="sourceLineNo">1296</span><a id="line.1296">                this.tag = tag;</a>
<span class="sourceLineNo">1297</span><a id="line.1297">        }</a>
<span class="sourceLineNo">1298</span><a id="line.1298"></a>
<span class="sourceLineNo">1299</span><a id="line.1299">        public Object eval() {</a>
<span class="sourceLineNo">1300</span><a id="line.1300">                return Reflector.getStaticField(c, fieldName);</a>
<span class="sourceLineNo">1301</span><a id="line.1301">        }</a>
<span class="sourceLineNo">1302</span><a id="line.1302"></a>
<span class="sourceLineNo">1303</span><a id="line.1303">        public boolean canEmitPrimitive(){</a>
<span class="sourceLineNo">1304</span><a id="line.1304">                return Util.isPrimitive(field.getType());</a>
<span class="sourceLineNo">1305</span><a id="line.1305">        }</a>
<span class="sourceLineNo">1306</span><a id="line.1306"></a>
<span class="sourceLineNo">1307</span><a id="line.1307">        public void emitUnboxed(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">1308</span><a id="line.1308">                gen.visitLineNumber(line, gen.mark());</a>
<span class="sourceLineNo">1309</span><a id="line.1309">                gen.getStatic(Type.getType(c), fieldName, Type.getType(field.getType()));</a>
<span class="sourceLineNo">1310</span><a id="line.1310">        }</a>
<span class="sourceLineNo">1311</span><a id="line.1311"></a>
<span class="sourceLineNo">1312</span><a id="line.1312">        public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">1313</span><a id="line.1313">                gen.visitLineNumber(line, gen.mark());</a>
<span class="sourceLineNo">1314</span><a id="line.1314"></a>
<span class="sourceLineNo">1315</span><a id="line.1315">                gen.getStatic(Type.getType(c), fieldName, Type.getType(field.getType()));</a>
<span class="sourceLineNo">1316</span><a id="line.1316">                //if(context != C.STATEMENT)</a>
<span class="sourceLineNo">1317</span><a id="line.1317">                HostExpr.emitBoxReturn(objx, gen, field.getType());</a>
<span class="sourceLineNo">1318</span><a id="line.1318">                if(context == C.STATEMENT)</a>
<span class="sourceLineNo">1319</span><a id="line.1319">                        {</a>
<span class="sourceLineNo">1320</span><a id="line.1320">                        gen.pop();</a>
<span class="sourceLineNo">1321</span><a id="line.1321">                        }</a>
<span class="sourceLineNo">1322</span><a id="line.1322">//              gen.push(className);</a>
<span class="sourceLineNo">1323</span><a id="line.1323">//              gen.push(fieldName);</a>
<span class="sourceLineNo">1324</span><a id="line.1324">//              gen.invokeStatic(REFLECTOR_TYPE, getStaticFieldMethod);</a>
<span class="sourceLineNo">1325</span><a id="line.1325">        }</a>
<span class="sourceLineNo">1326</span><a id="line.1326"></a>
<span class="sourceLineNo">1327</span><a id="line.1327">        public boolean hasJavaClass(){</a>
<span class="sourceLineNo">1328</span><a id="line.1328">                return true;</a>
<span class="sourceLineNo">1329</span><a id="line.1329">        }</a>
<span class="sourceLineNo">1330</span><a id="line.1330"></a>
<span class="sourceLineNo">1331</span><a id="line.1331">        public Class getJavaClass() {</a>
<span class="sourceLineNo">1332</span><a id="line.1332">                //Class c = Class.forName(className);</a>
<span class="sourceLineNo">1333</span><a id="line.1333">                //java.lang.reflect.Field field = c.getField(fieldName);</a>
<span class="sourceLineNo">1334</span><a id="line.1334">                if (jc == null)</a>
<span class="sourceLineNo">1335</span><a id="line.1335">            jc =tag != null ? HostExpr.tagToClass(tag) : field.getType();</a>
<span class="sourceLineNo">1336</span><a id="line.1336">        return jc;</a>
<span class="sourceLineNo">1337</span><a id="line.1337">        }</a>
<span class="sourceLineNo">1338</span><a id="line.1338"></a>
<span class="sourceLineNo">1339</span><a id="line.1339">        public Object evalAssign(Expr val) {</a>
<span class="sourceLineNo">1340</span><a id="line.1340">                return Reflector.setStaticField(c, fieldName, val.eval());</a>
<span class="sourceLineNo">1341</span><a id="line.1341">        }</a>
<span class="sourceLineNo">1342</span><a id="line.1342"></a>
<span class="sourceLineNo">1343</span><a id="line.1343">        public void emitAssign(C context, ObjExpr objx, GeneratorAdapter gen,</a>
<span class="sourceLineNo">1344</span><a id="line.1344">                               Expr val){</a>
<span class="sourceLineNo">1345</span><a id="line.1345">                val.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">1346</span><a id="line.1346">                gen.visitLineNumber(line, gen.mark());</a>
<span class="sourceLineNo">1347</span><a id="line.1347">                gen.dup();</a>
<span class="sourceLineNo">1348</span><a id="line.1348">                HostExpr.emitUnboxArg(objx, gen, field.getType());</a>
<span class="sourceLineNo">1349</span><a id="line.1349">                gen.putStatic(Type.getType(c), fieldName, Type.getType(field.getType()));</a>
<span class="sourceLineNo">1350</span><a id="line.1350">                if(context == C.STATEMENT)</a>
<span class="sourceLineNo">1351</span><a id="line.1351">                        gen.pop();</a>
<span class="sourceLineNo">1352</span><a id="line.1352">        }</a>
<span class="sourceLineNo">1353</span><a id="line.1353"></a>
<span class="sourceLineNo">1354</span><a id="line.1354"></a>
<span class="sourceLineNo">1355</span><a id="line.1355">}</a>
<span class="sourceLineNo">1356</span><a id="line.1356"></a>
<span class="sourceLineNo">1357</span><a id="line.1357">static Class maybePrimitiveType(Expr e){</a>
<span class="sourceLineNo">1358</span><a id="line.1358">        if(e instanceof MaybePrimitiveExpr &amp;&amp; e.hasJavaClass() &amp;&amp; ((MaybePrimitiveExpr)e).canEmitPrimitive())</a>
<span class="sourceLineNo">1359</span><a id="line.1359">                {</a>
<span class="sourceLineNo">1360</span><a id="line.1360">                Class c = e.getJavaClass();</a>
<span class="sourceLineNo">1361</span><a id="line.1361">                if(Util.isPrimitive(c))</a>
<span class="sourceLineNo">1362</span><a id="line.1362">                        return c;</a>
<span class="sourceLineNo">1363</span><a id="line.1363">                }</a>
<span class="sourceLineNo">1364</span><a id="line.1364">        return null;</a>
<span class="sourceLineNo">1365</span><a id="line.1365">}</a>
<span class="sourceLineNo">1366</span><a id="line.1366"></a>
<span class="sourceLineNo">1367</span><a id="line.1367">static Class maybeJavaClass(Collection&lt;Expr&gt; exprs){</a>
<span class="sourceLineNo">1368</span><a id="line.1368">    Class match = null;</a>
<span class="sourceLineNo">1369</span><a id="line.1369">    try</a>
<span class="sourceLineNo">1370</span><a id="line.1370">    {</a>
<span class="sourceLineNo">1371</span><a id="line.1371">    for (Expr e : exprs)</a>
<span class="sourceLineNo">1372</span><a id="line.1372">        {</a>
<span class="sourceLineNo">1373</span><a id="line.1373">        if (e instanceof ThrowExpr)</a>
<span class="sourceLineNo">1374</span><a id="line.1374">            continue;</a>
<span class="sourceLineNo">1375</span><a id="line.1375">        if (!e.hasJavaClass())</a>
<span class="sourceLineNo">1376</span><a id="line.1376">            return null;</a>
<span class="sourceLineNo">1377</span><a id="line.1377">        Class c = e.getJavaClass();</a>
<span class="sourceLineNo">1378</span><a id="line.1378">        if (match == null)</a>
<span class="sourceLineNo">1379</span><a id="line.1379">            match = c;</a>
<span class="sourceLineNo">1380</span><a id="line.1380">        else if (match != c)</a>
<span class="sourceLineNo">1381</span><a id="line.1381">            return null;</a>
<span class="sourceLineNo">1382</span><a id="line.1382">        }</a>
<span class="sourceLineNo">1383</span><a id="line.1383">    }</a>
<span class="sourceLineNo">1384</span><a id="line.1384">    catch(Exception e)</a>
<span class="sourceLineNo">1385</span><a id="line.1385">    {</a>
<span class="sourceLineNo">1386</span><a id="line.1386">        return null;</a>
<span class="sourceLineNo">1387</span><a id="line.1387">    }</a>
<span class="sourceLineNo">1388</span><a id="line.1388">    return match;</a>
<span class="sourceLineNo">1389</span><a id="line.1389">}</a>
<span class="sourceLineNo">1390</span><a id="line.1390"></a>
<span class="sourceLineNo">1391</span><a id="line.1391"></a>
<span class="sourceLineNo">1392</span><a id="line.1392">static abstract class MethodExpr extends HostExpr{</a>
<span class="sourceLineNo">1393</span><a id="line.1393">        static void emitArgsAsArray(IPersistentVector args, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">1394</span><a id="line.1394">                gen.push(args.count());</a>
<span class="sourceLineNo">1395</span><a id="line.1395">                gen.newArray(OBJECT_TYPE);</a>
<span class="sourceLineNo">1396</span><a id="line.1396">                for(int i = 0; i &lt; args.count(); i++)</a>
<span class="sourceLineNo">1397</span><a id="line.1397">                        {</a>
<span class="sourceLineNo">1398</span><a id="line.1398">                        gen.dup();</a>
<span class="sourceLineNo">1399</span><a id="line.1399">                        gen.push(i);</a>
<span class="sourceLineNo">1400</span><a id="line.1400">                        ((Expr) args.nth(i)).emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">1401</span><a id="line.1401">                        gen.arrayStore(OBJECT_TYPE);</a>
<span class="sourceLineNo">1402</span><a id="line.1402">                        }</a>
<span class="sourceLineNo">1403</span><a id="line.1403">        }</a>
<span class="sourceLineNo">1404</span><a id="line.1404"></a>
<span class="sourceLineNo">1405</span><a id="line.1405">        public static void emitTypedArgs(ObjExpr objx, GeneratorAdapter gen, Class[] parameterTypes, IPersistentVector args){</a>
<span class="sourceLineNo">1406</span><a id="line.1406">                for(int i = 0; i &lt; parameterTypes.length; i++)</a>
<span class="sourceLineNo">1407</span><a id="line.1407">                        {</a>
<span class="sourceLineNo">1408</span><a id="line.1408">                        Expr e = (Expr) args.nth(i);</a>
<span class="sourceLineNo">1409</span><a id="line.1409">                        try</a>
<span class="sourceLineNo">1410</span><a id="line.1410">                                {</a>
<span class="sourceLineNo">1411</span><a id="line.1411">                                final Class primc = maybePrimitiveType(e);</a>
<span class="sourceLineNo">1412</span><a id="line.1412">                                if(primc == parameterTypes[i])</a>
<span class="sourceLineNo">1413</span><a id="line.1413">                                        {</a>
<span class="sourceLineNo">1414</span><a id="line.1414">                                        final MaybePrimitiveExpr pe = (MaybePrimitiveExpr) e;</a>
<span class="sourceLineNo">1415</span><a id="line.1415">                                        pe.emitUnboxed(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">1416</span><a id="line.1416">                                        }</a>
<span class="sourceLineNo">1417</span><a id="line.1417">                                else if(primc == int.class &amp;&amp; parameterTypes[i] == long.class)</a>
<span class="sourceLineNo">1418</span><a id="line.1418">                                        {</a>
<span class="sourceLineNo">1419</span><a id="line.1419">                                        final MaybePrimitiveExpr pe = (MaybePrimitiveExpr) e;</a>
<span class="sourceLineNo">1420</span><a id="line.1420">                                        pe.emitUnboxed(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">1421</span><a id="line.1421">                                        gen.visitInsn(I2L);</a>
<span class="sourceLineNo">1422</span><a id="line.1422">                                        }</a>
<span class="sourceLineNo">1423</span><a id="line.1423">                                else if(primc == long.class &amp;&amp; parameterTypes[i] == int.class)</a>
<span class="sourceLineNo">1424</span><a id="line.1424">                                        {</a>
<span class="sourceLineNo">1425</span><a id="line.1425">                                        final MaybePrimitiveExpr pe = (MaybePrimitiveExpr) e;</a>
<span class="sourceLineNo">1426</span><a id="line.1426">                                        pe.emitUnboxed(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">1427</span><a id="line.1427">                                        if(RT.booleanCast(RT.UNCHECKED_MATH.deref()))</a>
<span class="sourceLineNo">1428</span><a id="line.1428">                                                gen.invokeStatic(RT_TYPE, Method.getMethod("int uncheckedIntCast(long)"));</a>
<span class="sourceLineNo">1429</span><a id="line.1429">                                        else</a>
<span class="sourceLineNo">1430</span><a id="line.1430">                                                gen.invokeStatic(RT_TYPE, Method.getMethod("int intCast(long)"));</a>
<span class="sourceLineNo">1431</span><a id="line.1431">                                        }</a>
<span class="sourceLineNo">1432</span><a id="line.1432">                                else if(primc == float.class &amp;&amp; parameterTypes[i] == double.class)</a>
<span class="sourceLineNo">1433</span><a id="line.1433">                                        {</a>
<span class="sourceLineNo">1434</span><a id="line.1434">                                        final MaybePrimitiveExpr pe = (MaybePrimitiveExpr) e;</a>
<span class="sourceLineNo">1435</span><a id="line.1435">                                        pe.emitUnboxed(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">1436</span><a id="line.1436">                                        gen.visitInsn(F2D);</a>
<span class="sourceLineNo">1437</span><a id="line.1437">                                        }</a>
<span class="sourceLineNo">1438</span><a id="line.1438">                                else if(primc == double.class &amp;&amp; parameterTypes[i] == float.class)</a>
<span class="sourceLineNo">1439</span><a id="line.1439">                                        {</a>
<span class="sourceLineNo">1440</span><a id="line.1440">                                        final MaybePrimitiveExpr pe = (MaybePrimitiveExpr) e;</a>
<span class="sourceLineNo">1441</span><a id="line.1441">                                        pe.emitUnboxed(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">1442</span><a id="line.1442">                                        gen.visitInsn(D2F);</a>
<span class="sourceLineNo">1443</span><a id="line.1443">                                        }</a>
<span class="sourceLineNo">1444</span><a id="line.1444">                                else</a>
<span class="sourceLineNo">1445</span><a id="line.1445">                                        {</a>
<span class="sourceLineNo">1446</span><a id="line.1446">                                        e.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">1447</span><a id="line.1447">                                        HostExpr.emitUnboxArg(objx, gen, parameterTypes[i]);</a>
<span class="sourceLineNo">1448</span><a id="line.1448">                                        }</a>
<span class="sourceLineNo">1449</span><a id="line.1449">                                }</a>
<span class="sourceLineNo">1450</span><a id="line.1450">                        catch(Exception e1)</a>
<span class="sourceLineNo">1451</span><a id="line.1451">                                {</a>
<span class="sourceLineNo">1452</span><a id="line.1452">                throw Util.sneakyThrow(e1);</a>
<span class="sourceLineNo">1453</span><a id="line.1453">                                }</a>
<span class="sourceLineNo">1454</span><a id="line.1454"></a>
<span class="sourceLineNo">1455</span><a id="line.1455">                        }</a>
<span class="sourceLineNo">1456</span><a id="line.1456">        }</a>
<span class="sourceLineNo">1457</span><a id="line.1457">}</a>
<span class="sourceLineNo">1458</span><a id="line.1458"></a>
<span class="sourceLineNo">1459</span><a id="line.1459">static class InstanceMethodExpr extends MethodExpr{</a>
<span class="sourceLineNo">1460</span><a id="line.1460">        public final Expr target;</a>
<span class="sourceLineNo">1461</span><a id="line.1461">        public final String methodName;</a>
<span class="sourceLineNo">1462</span><a id="line.1462">        public final IPersistentVector args;</a>
<span class="sourceLineNo">1463</span><a id="line.1463">        public final String source;</a>
<span class="sourceLineNo">1464</span><a id="line.1464">        public final int line;</a>
<span class="sourceLineNo">1465</span><a id="line.1465">        public final int column;</a>
<span class="sourceLineNo">1466</span><a id="line.1466">        public final Symbol tag;</a>
<span class="sourceLineNo">1467</span><a id="line.1467">        public final boolean tailPosition;</a>
<span class="sourceLineNo">1468</span><a id="line.1468">        public final java.lang.reflect.Method method;</a>
<span class="sourceLineNo">1469</span><a id="line.1469">    Class jc;</a>
<span class="sourceLineNo">1470</span><a id="line.1470"></a>
<span class="sourceLineNo">1471</span><a id="line.1471">        final static Method invokeInstanceMethodMethod =</a>
<span class="sourceLineNo">1472</span><a id="line.1472">                        Method.getMethod("Object invokeInstanceMethod(Object,String,Object[])");</a>
<span class="sourceLineNo">1473</span><a id="line.1473"></a>
<span class="sourceLineNo">1474</span><a id="line.1474"></a>
<span class="sourceLineNo">1475</span><a id="line.1475">        public InstanceMethodExpr(String source, int line, int column, Symbol tag, Expr target,</a>
<span class="sourceLineNo">1476</span><a id="line.1476">                        String methodName, IPersistentVector args, boolean tailPosition)</a>
<span class="sourceLineNo">1477</span><a id="line.1477">                        {</a>
<span class="sourceLineNo">1478</span><a id="line.1478">                this.source = source;</a>
<span class="sourceLineNo">1479</span><a id="line.1479">                this.line = line;</a>
<span class="sourceLineNo">1480</span><a id="line.1480">                this.column = column;</a>
<span class="sourceLineNo">1481</span><a id="line.1481">                this.args = args;</a>
<span class="sourceLineNo">1482</span><a id="line.1482">                this.methodName = methodName;</a>
<span class="sourceLineNo">1483</span><a id="line.1483">                this.target = target;</a>
<span class="sourceLineNo">1484</span><a id="line.1484">                this.tag = tag;</a>
<span class="sourceLineNo">1485</span><a id="line.1485">                this.tailPosition = tailPosition;</a>
<span class="sourceLineNo">1486</span><a id="line.1486">                if(target.hasJavaClass() &amp;&amp; target.getJavaClass() != null)</a>
<span class="sourceLineNo">1487</span><a id="line.1487">                        {</a>
<span class="sourceLineNo">1488</span><a id="line.1488">                        List methods = Reflector.getMethods(target.getJavaClass(), args.count(), methodName, false);</a>
<span class="sourceLineNo">1489</span><a id="line.1489">                        if(methods.isEmpty())</a>
<span class="sourceLineNo">1490</span><a id="line.1490">                                {</a>
<span class="sourceLineNo">1491</span><a id="line.1491">                                method = null;</a>
<span class="sourceLineNo">1492</span><a id="line.1492">                                if(RT.booleanCast(RT.WARN_ON_REFLECTION.deref()))</a>
<span class="sourceLineNo">1493</span><a id="line.1493">                                        {</a>
<span class="sourceLineNo">1494</span><a id="line.1494">                                        RT.errPrintWriter()</a>
<span class="sourceLineNo">1495</span><a id="line.1495">                                                .format("Reflection warning, %s:%d:%d - call to method %s on %s can't be resolved (no such method).\n",</a>
<span class="sourceLineNo">1496</span><a id="line.1496">                                                        SOURCE_PATH.deref(), line, column, methodName, target.getJavaClass().getName());</a>
<span class="sourceLineNo">1497</span><a id="line.1497">                                        }</a>
<span class="sourceLineNo">1498</span><a id="line.1498">                                }</a>
<span class="sourceLineNo">1499</span><a id="line.1499">                        else</a>
<span class="sourceLineNo">1500</span><a id="line.1500">                                {</a>
<span class="sourceLineNo">1501</span><a id="line.1501">                                int methodidx = 0;</a>
<span class="sourceLineNo">1502</span><a id="line.1502">                                if(methods.size() &gt; 1)</a>
<span class="sourceLineNo">1503</span><a id="line.1503">                                        {</a>
<span class="sourceLineNo">1504</span><a id="line.1504">                                        ArrayList&lt;Class[]&gt; params = new ArrayList();</a>
<span class="sourceLineNo">1505</span><a id="line.1505">                                        ArrayList&lt;Class&gt; rets = new ArrayList();</a>
<span class="sourceLineNo">1506</span><a id="line.1506">                                        for(int i = 0; i &lt; methods.size(); i++)</a>
<span class="sourceLineNo">1507</span><a id="line.1507">                                                {</a>
<span class="sourceLineNo">1508</span><a id="line.1508">                                                java.lang.reflect.Method m = (java.lang.reflect.Method) methods.get(i);</a>
<span class="sourceLineNo">1509</span><a id="line.1509">                                                params.add(m.getParameterTypes());</a>
<span class="sourceLineNo">1510</span><a id="line.1510">                                                rets.add(m.getReturnType());</a>
<span class="sourceLineNo">1511</span><a id="line.1511">                                                }</a>
<span class="sourceLineNo">1512</span><a id="line.1512">                                        methodidx = getMatchingParams(methodName, params, args, rets);</a>
<span class="sourceLineNo">1513</span><a id="line.1513">                                        }</a>
<span class="sourceLineNo">1514</span><a id="line.1514">                                java.lang.reflect.Method m =</a>
<span class="sourceLineNo">1515</span><a id="line.1515">                                                (java.lang.reflect.Method) (methodidx &gt;= 0 ? methods.get(methodidx) : null);</a>
<span class="sourceLineNo">1516</span><a id="line.1516">                                if(m != null &amp;&amp; !Modifier.isPublic(m.getDeclaringClass().getModifiers()))</a>
<span class="sourceLineNo">1517</span><a id="line.1517">                                        {</a>
<span class="sourceLineNo">1518</span><a id="line.1518">                                        //public method of non-public class, try to find it in hierarchy</a>
<span class="sourceLineNo">1519</span><a id="line.1519">                                        m = Reflector.getAsMethodOfPublicBase(m.getDeclaringClass(), m);</a>
<span class="sourceLineNo">1520</span><a id="line.1520">                                        }</a>
<span class="sourceLineNo">1521</span><a id="line.1521">                                method = m;</a>
<span class="sourceLineNo">1522</span><a id="line.1522">                                if(method == null &amp;&amp; RT.booleanCast(RT.WARN_ON_REFLECTION.deref()))</a>
<span class="sourceLineNo">1523</span><a id="line.1523">                                        {</a>
<span class="sourceLineNo">1524</span><a id="line.1524">                                        RT.errPrintWriter()</a>
<span class="sourceLineNo">1525</span><a id="line.1525">                                                .format("Reflection warning, %s:%d:%d - call to method %s on %s can't be resolved (argument types: %s).\n",</a>
<span class="sourceLineNo">1526</span><a id="line.1526">                                                        SOURCE_PATH.deref(), line, column, methodName, target.getJavaClass().getName(), getTypeStringForArgs(args));</a>
<span class="sourceLineNo">1527</span><a id="line.1527">                                        }</a>
<span class="sourceLineNo">1528</span><a id="line.1528">                                }</a>
<span class="sourceLineNo">1529</span><a id="line.1529">                        }</a>
<span class="sourceLineNo">1530</span><a id="line.1530">                else</a>
<span class="sourceLineNo">1531</span><a id="line.1531">                        {</a>
<span class="sourceLineNo">1532</span><a id="line.1532">                        method = null;</a>
<span class="sourceLineNo">1533</span><a id="line.1533">                        if(RT.booleanCast(RT.WARN_ON_REFLECTION.deref()))</a>
<span class="sourceLineNo">1534</span><a id="line.1534">                                {</a>
<span class="sourceLineNo">1535</span><a id="line.1535">                                RT.errPrintWriter()</a>
<span class="sourceLineNo">1536</span><a id="line.1536">                                        .format("Reflection warning, %s:%d:%d - call to method %s can't be resolved (target class is unknown).\n",</a>
<span class="sourceLineNo">1537</span><a id="line.1537">                                                SOURCE_PATH.deref(), line, column, methodName);</a>
<span class="sourceLineNo">1538</span><a id="line.1538">                                }</a>
<span class="sourceLineNo">1539</span><a id="line.1539">                        }</a>
<span class="sourceLineNo">1540</span><a id="line.1540">        }</a>
<span class="sourceLineNo">1541</span><a id="line.1541"></a>
<span class="sourceLineNo">1542</span><a id="line.1542">        public Object eval() {</a>
<span class="sourceLineNo">1543</span><a id="line.1543">                try</a>
<span class="sourceLineNo">1544</span><a id="line.1544">                        {</a>
<span class="sourceLineNo">1545</span><a id="line.1545">                        Object targetval = target.eval();</a>
<span class="sourceLineNo">1546</span><a id="line.1546">                        Object[] argvals = new Object[args.count()];</a>
<span class="sourceLineNo">1547</span><a id="line.1547">                        for(int i = 0; i &lt; args.count(); i++)</a>
<span class="sourceLineNo">1548</span><a id="line.1548">                                argvals[i] = ((Expr) args.nth(i)).eval();</a>
<span class="sourceLineNo">1549</span><a id="line.1549">                        if(method != null)</a>
<span class="sourceLineNo">1550</span><a id="line.1550">                                {</a>
<span class="sourceLineNo">1551</span><a id="line.1551">                                LinkedList ms = new LinkedList();</a>
<span class="sourceLineNo">1552</span><a id="line.1552">                                ms.add(method);</a>
<span class="sourceLineNo">1553</span><a id="line.1553">                                return Reflector.invokeMatchingMethod(methodName, ms, targetval, argvals);</a>
<span class="sourceLineNo">1554</span><a id="line.1554">                                }</a>
<span class="sourceLineNo">1555</span><a id="line.1555">                        return Reflector.invokeInstanceMethod(targetval, methodName, argvals);</a>
<span class="sourceLineNo">1556</span><a id="line.1556">                        }</a>
<span class="sourceLineNo">1557</span><a id="line.1557">                catch(Throwable e)</a>
<span class="sourceLineNo">1558</span><a id="line.1558">                        {</a>
<span class="sourceLineNo">1559</span><a id="line.1559">                        if(!(e instanceof CompilerException))</a>
<span class="sourceLineNo">1560</span><a id="line.1560">                                throw new CompilerException(source, line, column, e);</a>
<span class="sourceLineNo">1561</span><a id="line.1561">                        else</a>
<span class="sourceLineNo">1562</span><a id="line.1562">                                throw (CompilerException) e;</a>
<span class="sourceLineNo">1563</span><a id="line.1563">                        }</a>
<span class="sourceLineNo">1564</span><a id="line.1564">        }</a>
<span class="sourceLineNo">1565</span><a id="line.1565"></a>
<span class="sourceLineNo">1566</span><a id="line.1566">        public boolean canEmitPrimitive(){</a>
<span class="sourceLineNo">1567</span><a id="line.1567">                return method != null &amp;&amp; Util.isPrimitive(method.getReturnType());</a>
<span class="sourceLineNo">1568</span><a id="line.1568">        }</a>
<span class="sourceLineNo">1569</span><a id="line.1569"></a>
<span class="sourceLineNo">1570</span><a id="line.1570">        public void emitUnboxed(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">1571</span><a id="line.1571">                if(method != null)</a>
<span class="sourceLineNo">1572</span><a id="line.1572">                        {</a>
<span class="sourceLineNo">1573</span><a id="line.1573">                        Type type = Type.getType(method.getDeclaringClass());</a>
<span class="sourceLineNo">1574</span><a id="line.1574">                        target.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">1575</span><a id="line.1575">                        //if(!method.getDeclaringClass().isInterface())</a>
<span class="sourceLineNo">1576</span><a id="line.1576">                        gen.checkCast(type);</a>
<span class="sourceLineNo">1577</span><a id="line.1577">                        MethodExpr.emitTypedArgs(objx, gen, method.getParameterTypes(), args);</a>
<span class="sourceLineNo">1578</span><a id="line.1578">                        gen.visitLineNumber(line, gen.mark());</a>
<span class="sourceLineNo">1579</span><a id="line.1579">                        if(tailPosition &amp;&amp; !objx.canBeDirect)</a>
<span class="sourceLineNo">1580</span><a id="line.1580">                                {</a>
<span class="sourceLineNo">1581</span><a id="line.1581">                                ObjMethod method = (ObjMethod) METHOD.deref();</a>
<span class="sourceLineNo">1582</span><a id="line.1582">                                method.emitClearThis(gen);</a>
<span class="sourceLineNo">1583</span><a id="line.1583">                                }</a>
<span class="sourceLineNo">1584</span><a id="line.1584">                        Method m = new Method(methodName, Type.getReturnType(method), Type.getArgumentTypes(method));</a>
<span class="sourceLineNo">1585</span><a id="line.1585">                        if(method.getDeclaringClass().isInterface())</a>
<span class="sourceLineNo">1586</span><a id="line.1586">                                gen.invokeInterface(type, m);</a>
<span class="sourceLineNo">1587</span><a id="line.1587">                        else</a>
<span class="sourceLineNo">1588</span><a id="line.1588">                                gen.invokeVirtual(type, m);</a>
<span class="sourceLineNo">1589</span><a id="line.1589">                        }</a>
<span class="sourceLineNo">1590</span><a id="line.1590">                else</a>
<span class="sourceLineNo">1591</span><a id="line.1591">                        throw new UnsupportedOperationException("Unboxed emit of unknown member");</a>
<span class="sourceLineNo">1592</span><a id="line.1592">        }</a>
<span class="sourceLineNo">1593</span><a id="line.1593"></a>
<span class="sourceLineNo">1594</span><a id="line.1594">        public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">1595</span><a id="line.1595">                if(method != null)</a>
<span class="sourceLineNo">1596</span><a id="line.1596">                        {</a>
<span class="sourceLineNo">1597</span><a id="line.1597">                        Type type = Type.getType(method.getDeclaringClass());</a>
<span class="sourceLineNo">1598</span><a id="line.1598">                        target.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">1599</span><a id="line.1599">                        //if(!method.getDeclaringClass().isInterface())</a>
<span class="sourceLineNo">1600</span><a id="line.1600">                        gen.checkCast(type);</a>
<span class="sourceLineNo">1601</span><a id="line.1601">                        MethodExpr.emitTypedArgs(objx, gen, method.getParameterTypes(), args);</a>
<span class="sourceLineNo">1602</span><a id="line.1602">                        gen.visitLineNumber(line, gen.mark());</a>
<span class="sourceLineNo">1603</span><a id="line.1603">                        if(context == C.RETURN)</a>
<span class="sourceLineNo">1604</span><a id="line.1604">                                {</a>
<span class="sourceLineNo">1605</span><a id="line.1605">                                ObjMethod method = (ObjMethod) METHOD.deref();</a>
<span class="sourceLineNo">1606</span><a id="line.1606">                                method.emitClearLocals(gen);</a>
<span class="sourceLineNo">1607</span><a id="line.1607">                                }</a>
<span class="sourceLineNo">1608</span><a id="line.1608">                        Method m = new Method(methodName, Type.getReturnType(method), Type.getArgumentTypes(method));</a>
<span class="sourceLineNo">1609</span><a id="line.1609">                        if(method.getDeclaringClass().isInterface())</a>
<span class="sourceLineNo">1610</span><a id="line.1610">                                gen.invokeInterface(type, m);</a>
<span class="sourceLineNo">1611</span><a id="line.1611">                        else</a>
<span class="sourceLineNo">1612</span><a id="line.1612">                                gen.invokeVirtual(type, m);</a>
<span class="sourceLineNo">1613</span><a id="line.1613">                        //if(context != C.STATEMENT || method.getReturnType() == Void.TYPE)</a>
<span class="sourceLineNo">1614</span><a id="line.1614">                        HostExpr.emitBoxReturn(objx, gen, method.getReturnType());</a>
<span class="sourceLineNo">1615</span><a id="line.1615">                        }</a>
<span class="sourceLineNo">1616</span><a id="line.1616">                else</a>
<span class="sourceLineNo">1617</span><a id="line.1617">                        {</a>
<span class="sourceLineNo">1618</span><a id="line.1618">                        target.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">1619</span><a id="line.1619">                        gen.push(methodName);</a>
<span class="sourceLineNo">1620</span><a id="line.1620">                        emitArgsAsArray(args, objx, gen);</a>
<span class="sourceLineNo">1621</span><a id="line.1621">                        gen.visitLineNumber(line, gen.mark());</a>
<span class="sourceLineNo">1622</span><a id="line.1622">                        if(context == C.RETURN)</a>
<span class="sourceLineNo">1623</span><a id="line.1623">                                {</a>
<span class="sourceLineNo">1624</span><a id="line.1624">                                ObjMethod method = (ObjMethod) METHOD.deref();</a>
<span class="sourceLineNo">1625</span><a id="line.1625">                                method.emitClearLocals(gen);</a>
<span class="sourceLineNo">1626</span><a id="line.1626">                                }</a>
<span class="sourceLineNo">1627</span><a id="line.1627">                        gen.invokeStatic(REFLECTOR_TYPE, invokeInstanceMethodMethod);</a>
<span class="sourceLineNo">1628</span><a id="line.1628">                        }</a>
<span class="sourceLineNo">1629</span><a id="line.1629">                if(context == C.STATEMENT)</a>
<span class="sourceLineNo">1630</span><a id="line.1630">                        gen.pop();</a>
<span class="sourceLineNo">1631</span><a id="line.1631">        }</a>
<span class="sourceLineNo">1632</span><a id="line.1632"></a>
<span class="sourceLineNo">1633</span><a id="line.1633">        public boolean hasJavaClass(){</a>
<span class="sourceLineNo">1634</span><a id="line.1634">                return method != null || tag != null;</a>
<span class="sourceLineNo">1635</span><a id="line.1635">        }</a>
<span class="sourceLineNo">1636</span><a id="line.1636"></a>
<span class="sourceLineNo">1637</span><a id="line.1637">        public Class getJavaClass() {</a>
<span class="sourceLineNo">1638</span><a id="line.1638">        if (jc == null)</a>
<span class="sourceLineNo">1639</span><a id="line.1639">            jc = retType((tag!=null)?HostExpr.tagToClass(tag):null, (method!=null)?method.getReturnType():null);</a>
<span class="sourceLineNo">1640</span><a id="line.1640">        return jc;</a>
<span class="sourceLineNo">1641</span><a id="line.1641">        }</a>
<span class="sourceLineNo">1642</span><a id="line.1642">}</a>
<span class="sourceLineNo">1643</span><a id="line.1643"></a>
<span class="sourceLineNo">1644</span><a id="line.1644"></a>
<span class="sourceLineNo">1645</span><a id="line.1645">static class StaticMethodExpr extends MethodExpr{</a>
<span class="sourceLineNo">1646</span><a id="line.1646">        //final String className;</a>
<span class="sourceLineNo">1647</span><a id="line.1647">        public final Class c;</a>
<span class="sourceLineNo">1648</span><a id="line.1648">        public final String methodName;</a>
<span class="sourceLineNo">1649</span><a id="line.1649">        public final IPersistentVector args;</a>
<span class="sourceLineNo">1650</span><a id="line.1650">        public final String source;</a>
<span class="sourceLineNo">1651</span><a id="line.1651">        public final int line;</a>
<span class="sourceLineNo">1652</span><a id="line.1652">        public final int column;</a>
<span class="sourceLineNo">1653</span><a id="line.1653">        public final java.lang.reflect.Method method;</a>
<span class="sourceLineNo">1654</span><a id="line.1654">        public final Symbol tag;</a>
<span class="sourceLineNo">1655</span><a id="line.1655">        public final boolean tailPosition;</a>
<span class="sourceLineNo">1656</span><a id="line.1656">        final static Method forNameMethod = Method.getMethod("Class classForName(String)");</a>
<span class="sourceLineNo">1657</span><a id="line.1657">        final static Method invokeStaticMethodMethod =</a>
<span class="sourceLineNo">1658</span><a id="line.1658">                        Method.getMethod("Object invokeStaticMethod(Class,String,Object[])");</a>
<span class="sourceLineNo">1659</span><a id="line.1659">        final static Keyword warnOnBoxedKeyword = Keyword.intern("warn-on-boxed");</a>
<span class="sourceLineNo">1660</span><a id="line.1660">    Class jc;</a>
<span class="sourceLineNo">1661</span><a id="line.1661"></a>
<span class="sourceLineNo">1662</span><a id="line.1662">        public StaticMethodExpr(String source, int line, int column, Symbol tag, Class c,</a>
<span class="sourceLineNo">1663</span><a id="line.1663">                                String methodName, IPersistentVector args, boolean tailPosition)</a>
<span class="sourceLineNo">1664</span><a id="line.1664">                        {</a>
<span class="sourceLineNo">1665</span><a id="line.1665">                this.c = c;</a>
<span class="sourceLineNo">1666</span><a id="line.1666">                this.methodName = methodName;</a>
<span class="sourceLineNo">1667</span><a id="line.1667">                this.args = args;</a>
<span class="sourceLineNo">1668</span><a id="line.1668">                this.source = source;</a>
<span class="sourceLineNo">1669</span><a id="line.1669">                this.line = line;</a>
<span class="sourceLineNo">1670</span><a id="line.1670">                this.column = column;</a>
<span class="sourceLineNo">1671</span><a id="line.1671">                this.tag = tag;</a>
<span class="sourceLineNo">1672</span><a id="line.1672">                this.tailPosition = tailPosition;</a>
<span class="sourceLineNo">1673</span><a id="line.1673"></a>
<span class="sourceLineNo">1674</span><a id="line.1674">                List methods = Reflector.getMethods(c, args.count(), methodName, true);</a>
<span class="sourceLineNo">1675</span><a id="line.1675">                if(methods.isEmpty())</a>
<span class="sourceLineNo">1676</span><a id="line.1676">                        throw new IllegalArgumentException("No matching method " + methodName + " found taking "</a>
<span class="sourceLineNo">1677</span><a id="line.1677">                                                           + args.count() + " args for " + c);</a>
<span class="sourceLineNo">1678</span><a id="line.1678"></a>
<span class="sourceLineNo">1679</span><a id="line.1679">                int methodidx = 0;</a>
<span class="sourceLineNo">1680</span><a id="line.1680">                if(methods.size() &gt; 1)</a>
<span class="sourceLineNo">1681</span><a id="line.1681">                        {</a>
<span class="sourceLineNo">1682</span><a id="line.1682">                        ArrayList&lt;Class[]&gt; params = new ArrayList();</a>
<span class="sourceLineNo">1683</span><a id="line.1683">                        ArrayList&lt;Class&gt; rets = new ArrayList();</a>
<span class="sourceLineNo">1684</span><a id="line.1684">                        for(int i = 0; i &lt; methods.size(); i++)</a>
<span class="sourceLineNo">1685</span><a id="line.1685">                                {</a>
<span class="sourceLineNo">1686</span><a id="line.1686">                                java.lang.reflect.Method m = (java.lang.reflect.Method) methods.get(i);</a>
<span class="sourceLineNo">1687</span><a id="line.1687">                                params.add(m.getParameterTypes());</a>
<span class="sourceLineNo">1688</span><a id="line.1688">                                rets.add(m.getReturnType());</a>
<span class="sourceLineNo">1689</span><a id="line.1689">                                }</a>
<span class="sourceLineNo">1690</span><a id="line.1690">                        methodidx = getMatchingParams(methodName, params, args, rets);</a>
<span class="sourceLineNo">1691</span><a id="line.1691">                        }</a>
<span class="sourceLineNo">1692</span><a id="line.1692">                method = (java.lang.reflect.Method) (methodidx &gt;= 0 ? methods.get(methodidx) : null);</a>
<span class="sourceLineNo">1693</span><a id="line.1693">                if(method == null &amp;&amp; RT.booleanCast(RT.WARN_ON_REFLECTION.deref()))</a>
<span class="sourceLineNo">1694</span><a id="line.1694">                        {</a>
<span class="sourceLineNo">1695</span><a id="line.1695">                        RT.errPrintWriter()</a>
<span class="sourceLineNo">1696</span><a id="line.1696">                                .format("Reflection warning, %s:%d:%d - call to static method %s on %s can't be resolved (argument types: %s).\n",</a>
<span class="sourceLineNo">1697</span><a id="line.1697">                                        SOURCE_PATH.deref(), line, column, methodName, c.getName(), getTypeStringForArgs(args));</a>
<span class="sourceLineNo">1698</span><a id="line.1698">                        }</a>
<span class="sourceLineNo">1699</span><a id="line.1699">                if(method != null &amp;&amp; warnOnBoxedKeyword.equals(RT.UNCHECKED_MATH.deref()) &amp;&amp; isBoxedMath(method))</a>
<span class="sourceLineNo">1700</span><a id="line.1700">                        {</a>
<span class="sourceLineNo">1701</span><a id="line.1701">                        RT.errPrintWriter()</a>
<span class="sourceLineNo">1702</span><a id="line.1702">                                .format("Boxed math warning, %s:%d:%d - call: %s.\n",</a>
<span class="sourceLineNo">1703</span><a id="line.1703">                                                SOURCE_PATH.deref(), line, column, method.toString());</a>
<span class="sourceLineNo">1704</span><a id="line.1704">                        }</a>
<span class="sourceLineNo">1705</span><a id="line.1705">        }</a>
<span class="sourceLineNo">1706</span><a id="line.1706"></a>
<span class="sourceLineNo">1707</span><a id="line.1707">        public static boolean isBoxedMath(java.lang.reflect.Method m) {</a>
<span class="sourceLineNo">1708</span><a id="line.1708">                Class c = m.getDeclaringClass();</a>
<span class="sourceLineNo">1709</span><a id="line.1709">                if(c.equals(Numbers.class))</a>
<span class="sourceLineNo">1710</span><a id="line.1710">                        {</a>
<span class="sourceLineNo">1711</span><a id="line.1711">                        WarnBoxedMath boxedMath = m.getAnnotation(WarnBoxedMath.class);</a>
<span class="sourceLineNo">1712</span><a id="line.1712">                        if(boxedMath != null)</a>
<span class="sourceLineNo">1713</span><a id="line.1713">                                return boxedMath.value();</a>
<span class="sourceLineNo">1714</span><a id="line.1714"></a>
<span class="sourceLineNo">1715</span><a id="line.1715">                        Class[] argTypes = m.getParameterTypes();</a>
<span class="sourceLineNo">1716</span><a id="line.1716">                        for(Class argType : argTypes)</a>
<span class="sourceLineNo">1717</span><a id="line.1717">                                if(argType.equals(Object.class) || argType.equals(Number.class))</a>
<span class="sourceLineNo">1718</span><a id="line.1718">                                        return true;</a>
<span class="sourceLineNo">1719</span><a id="line.1719">                        }</a>
<span class="sourceLineNo">1720</span><a id="line.1720">                return false;</a>
<span class="sourceLineNo">1721</span><a id="line.1721">        }</a>
<span class="sourceLineNo">1722</span><a id="line.1722"></a>
<span class="sourceLineNo">1723</span><a id="line.1723">        public Object eval() {</a>
<span class="sourceLineNo">1724</span><a id="line.1724">                try</a>
<span class="sourceLineNo">1725</span><a id="line.1725">                        {</a>
<span class="sourceLineNo">1726</span><a id="line.1726">                        Object[] argvals = new Object[args.count()];</a>
<span class="sourceLineNo">1727</span><a id="line.1727">                        for(int i = 0; i &lt; args.count(); i++)</a>
<span class="sourceLineNo">1728</span><a id="line.1728">                                argvals[i] = ((Expr) args.nth(i)).eval();</a>
<span class="sourceLineNo">1729</span><a id="line.1729">                        if(method != null)</a>
<span class="sourceLineNo">1730</span><a id="line.1730">                                {</a>
<span class="sourceLineNo">1731</span><a id="line.1731">                                LinkedList ms = new LinkedList();</a>
<span class="sourceLineNo">1732</span><a id="line.1732">                                ms.add(method);</a>
<span class="sourceLineNo">1733</span><a id="line.1733">                                return Reflector.invokeMatchingMethod(methodName, ms, null, argvals);</a>
<span class="sourceLineNo">1734</span><a id="line.1734">                                }</a>
<span class="sourceLineNo">1735</span><a id="line.1735">                        return Reflector.invokeStaticMethod(c, methodName, argvals);</a>
<span class="sourceLineNo">1736</span><a id="line.1736">                        }</a>
<span class="sourceLineNo">1737</span><a id="line.1737">                catch(Throwable e)</a>
<span class="sourceLineNo">1738</span><a id="line.1738">                        {</a>
<span class="sourceLineNo">1739</span><a id="line.1739">                        if(!(e instanceof CompilerException))</a>
<span class="sourceLineNo">1740</span><a id="line.1740">                                throw new CompilerException(source, line, column, e);</a>
<span class="sourceLineNo">1741</span><a id="line.1741">                        else</a>
<span class="sourceLineNo">1742</span><a id="line.1742">                                throw (CompilerException) e;</a>
<span class="sourceLineNo">1743</span><a id="line.1743">                        }</a>
<span class="sourceLineNo">1744</span><a id="line.1744">        }</a>
<span class="sourceLineNo">1745</span><a id="line.1745"></a>
<span class="sourceLineNo">1746</span><a id="line.1746">        public boolean canEmitPrimitive(){</a>
<span class="sourceLineNo">1747</span><a id="line.1747">                return method != null &amp;&amp; Util.isPrimitive(method.getReturnType());</a>
<span class="sourceLineNo">1748</span><a id="line.1748">        }</a>
<span class="sourceLineNo">1749</span><a id="line.1749"></a>
<span class="sourceLineNo">1750</span><a id="line.1750">        public boolean canEmitIntrinsicPredicate(){</a>
<span class="sourceLineNo">1751</span><a id="line.1751">                return method != null &amp;&amp; RT.get(Intrinsics.preds, method.toString()) != null;</a>
<span class="sourceLineNo">1752</span><a id="line.1752">        }</a>
<span class="sourceLineNo">1753</span><a id="line.1753"></a>
<span class="sourceLineNo">1754</span><a id="line.1754">        public void emitIntrinsicPredicate(C context, ObjExpr objx, GeneratorAdapter gen, Label falseLabel){</a>
<span class="sourceLineNo">1755</span><a id="line.1755">                gen.visitLineNumber(line, gen.mark());</a>
<span class="sourceLineNo">1756</span><a id="line.1756">                if(method != null)</a>
<span class="sourceLineNo">1757</span><a id="line.1757">                        {</a>
<span class="sourceLineNo">1758</span><a id="line.1758">                        MethodExpr.emitTypedArgs(objx, gen, method.getParameterTypes(), args);</a>
<span class="sourceLineNo">1759</span><a id="line.1759">                        if(context == C.RETURN)</a>
<span class="sourceLineNo">1760</span><a id="line.1760">                                {</a>
<span class="sourceLineNo">1761</span><a id="line.1761">                                ObjMethod method = (ObjMethod) METHOD.deref();</a>
<span class="sourceLineNo">1762</span><a id="line.1762">                                method.emitClearLocals(gen);</a>
<span class="sourceLineNo">1763</span><a id="line.1763">                                }</a>
<span class="sourceLineNo">1764</span><a id="line.1764">                        Object[] predOps = (Object[]) RT.get(Intrinsics.preds, method.toString());</a>
<span class="sourceLineNo">1765</span><a id="line.1765">                        for(int i=0;i&lt;predOps.length-1;i++)</a>
<span class="sourceLineNo">1766</span><a id="line.1766">                                gen.visitInsn((Integer)predOps[i]);</a>
<span class="sourceLineNo">1767</span><a id="line.1767">                        gen.visitJumpInsn((Integer)predOps[predOps.length-1],falseLabel);</a>
<span class="sourceLineNo">1768</span><a id="line.1768">                        }</a>
<span class="sourceLineNo">1769</span><a id="line.1769">                else</a>
<span class="sourceLineNo">1770</span><a id="line.1770">                        throw new UnsupportedOperationException("Unboxed emit of unknown member");</a>
<span class="sourceLineNo">1771</span><a id="line.1771">        }</a>
<span class="sourceLineNo">1772</span><a id="line.1772"></a>
<span class="sourceLineNo">1773</span><a id="line.1773">        public void emitUnboxed(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">1774</span><a id="line.1774">                if(method != null)</a>
<span class="sourceLineNo">1775</span><a id="line.1775">                        {</a>
<span class="sourceLineNo">1776</span><a id="line.1776">                        MethodExpr.emitTypedArgs(objx, gen, method.getParameterTypes(), args);</a>
<span class="sourceLineNo">1777</span><a id="line.1777">                        gen.visitLineNumber(line, gen.mark());</a>
<span class="sourceLineNo">1778</span><a id="line.1778">                        //Type type = Type.getObjectType(className.replace('.', '/'));</a>
<span class="sourceLineNo">1779</span><a id="line.1779">                        if(context == C.RETURN)</a>
<span class="sourceLineNo">1780</span><a id="line.1780">                                {</a>
<span class="sourceLineNo">1781</span><a id="line.1781">                                ObjMethod method = (ObjMethod) METHOD.deref();</a>
<span class="sourceLineNo">1782</span><a id="line.1782">                                method.emitClearLocals(gen);</a>
<span class="sourceLineNo">1783</span><a id="line.1783">                                }</a>
<span class="sourceLineNo">1784</span><a id="line.1784">                        Object ops = RT.get(Intrinsics.ops, method.toString());</a>
<span class="sourceLineNo">1785</span><a id="line.1785">                        if(ops != null)</a>
<span class="sourceLineNo">1786</span><a id="line.1786">                                {</a>
<span class="sourceLineNo">1787</span><a id="line.1787">                                if(ops instanceof Object[])</a>
<span class="sourceLineNo">1788</span><a id="line.1788">                                        {</a>
<span class="sourceLineNo">1789</span><a id="line.1789">                                        for(Object op : (Object[])ops)</a>
<span class="sourceLineNo">1790</span><a id="line.1790">                                                gen.visitInsn((Integer) op);</a>
<span class="sourceLineNo">1791</span><a id="line.1791">                                        }</a>
<span class="sourceLineNo">1792</span><a id="line.1792">                                else</a>
<span class="sourceLineNo">1793</span><a id="line.1793">                                        gen.visitInsn((Integer) ops);</a>
<span class="sourceLineNo">1794</span><a id="line.1794">                                }</a>
<span class="sourceLineNo">1795</span><a id="line.1795">                        else</a>
<span class="sourceLineNo">1796</span><a id="line.1796">                                {</a>
<span class="sourceLineNo">1797</span><a id="line.1797">                                Type type = Type.getType(c);</a>
<span class="sourceLineNo">1798</span><a id="line.1798">                                Method m = new Method(methodName, Type.getReturnType(method), Type.getArgumentTypes(method));</a>
<span class="sourceLineNo">1799</span><a id="line.1799">                                gen.invokeStatic(type, m);</a>
<span class="sourceLineNo">1800</span><a id="line.1800">                                }</a>
<span class="sourceLineNo">1801</span><a id="line.1801">                        }</a>
<span class="sourceLineNo">1802</span><a id="line.1802">                else</a>
<span class="sourceLineNo">1803</span><a id="line.1803">                        throw new UnsupportedOperationException("Unboxed emit of unknown member");</a>
<span class="sourceLineNo">1804</span><a id="line.1804">        }</a>
<span class="sourceLineNo">1805</span><a id="line.1805"></a>
<span class="sourceLineNo">1806</span><a id="line.1806">        public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">1807</span><a id="line.1807">                if(method != null)</a>
<span class="sourceLineNo">1808</span><a id="line.1808">                        {</a>
<span class="sourceLineNo">1809</span><a id="line.1809">                        MethodExpr.emitTypedArgs(objx, gen, method.getParameterTypes(), args);</a>
<span class="sourceLineNo">1810</span><a id="line.1810">                        gen.visitLineNumber(line, gen.mark());</a>
<span class="sourceLineNo">1811</span><a id="line.1811">                        //Type type = Type.getObjectType(className.replace('.', '/'));</a>
<span class="sourceLineNo">1812</span><a id="line.1812">                        if(tailPosition &amp;&amp; !objx.canBeDirect)</a>
<span class="sourceLineNo">1813</span><a id="line.1813">                                {</a>
<span class="sourceLineNo">1814</span><a id="line.1814">                                ObjMethod method = (ObjMethod) METHOD.deref();</a>
<span class="sourceLineNo">1815</span><a id="line.1815">                                method.emitClearThis(gen);</a>
<span class="sourceLineNo">1816</span><a id="line.1816">                                }</a>
<span class="sourceLineNo">1817</span><a id="line.1817">                        Type type = Type.getType(c);</a>
<span class="sourceLineNo">1818</span><a id="line.1818">                        Method m = new Method(methodName, Type.getReturnType(method), Type.getArgumentTypes(method));</a>
<span class="sourceLineNo">1819</span><a id="line.1819">                        gen.visitMethodInsn(INVOKESTATIC, type.getInternalName(), methodName, m.getDescriptor(), c.isInterface());</a>
<span class="sourceLineNo">1820</span><a id="line.1820">                        //if(context != C.STATEMENT || method.getReturnType() == Void.TYPE)</a>
<span class="sourceLineNo">1821</span><a id="line.1821">                        Class retClass = method.getReturnType();</a>
<span class="sourceLineNo">1822</span><a id="line.1822">                        if(context == C.STATEMENT)</a>
<span class="sourceLineNo">1823</span><a id="line.1823">                                {</a>
<span class="sourceLineNo">1824</span><a id="line.1824">                                if(retClass == long.class || retClass == double.class)</a>
<span class="sourceLineNo">1825</span><a id="line.1825">                                        gen.pop2();</a>
<span class="sourceLineNo">1826</span><a id="line.1826">                                else if(retClass != void.class)</a>
<span class="sourceLineNo">1827</span><a id="line.1827">                                        gen.pop();</a>
<span class="sourceLineNo">1828</span><a id="line.1828">                                }</a>
<span class="sourceLineNo">1829</span><a id="line.1829">                        else</a>
<span class="sourceLineNo">1830</span><a id="line.1830">                                {</a>
<span class="sourceLineNo">1831</span><a id="line.1831">                                HostExpr.emitBoxReturn(objx, gen, method.getReturnType());</a>
<span class="sourceLineNo">1832</span><a id="line.1832">                                }</a>
<span class="sourceLineNo">1833</span><a id="line.1833">                        }</a>
<span class="sourceLineNo">1834</span><a id="line.1834">                else</a>
<span class="sourceLineNo">1835</span><a id="line.1835">                        {</a>
<span class="sourceLineNo">1836</span><a id="line.1836">                        gen.visitLineNumber(line, gen.mark());</a>
<span class="sourceLineNo">1837</span><a id="line.1837">                        gen.push(c.getName());</a>
<span class="sourceLineNo">1838</span><a id="line.1838">                        gen.invokeStatic(RT_TYPE, forNameMethod);</a>
<span class="sourceLineNo">1839</span><a id="line.1839">                        gen.push(methodName);</a>
<span class="sourceLineNo">1840</span><a id="line.1840">                        emitArgsAsArray(args, objx, gen);</a>
<span class="sourceLineNo">1841</span><a id="line.1841">                        gen.visitLineNumber(line, gen.mark());</a>
<span class="sourceLineNo">1842</span><a id="line.1842">                        if(context == C.RETURN)</a>
<span class="sourceLineNo">1843</span><a id="line.1843">                                {</a>
<span class="sourceLineNo">1844</span><a id="line.1844">                                ObjMethod method = (ObjMethod) METHOD.deref();</a>
<span class="sourceLineNo">1845</span><a id="line.1845">                                method.emitClearLocals(gen);</a>
<span class="sourceLineNo">1846</span><a id="line.1846">                                }</a>
<span class="sourceLineNo">1847</span><a id="line.1847">                        gen.invokeStatic(REFLECTOR_TYPE, invokeStaticMethodMethod);</a>
<span class="sourceLineNo">1848</span><a id="line.1848">                        if(context == C.STATEMENT)</a>
<span class="sourceLineNo">1849</span><a id="line.1849">                                gen.pop();</a>
<span class="sourceLineNo">1850</span><a id="line.1850">                        }</a>
<span class="sourceLineNo">1851</span><a id="line.1851">        }</a>
<span class="sourceLineNo">1852</span><a id="line.1852"></a>
<span class="sourceLineNo">1853</span><a id="line.1853">        public boolean hasJavaClass(){</a>
<span class="sourceLineNo">1854</span><a id="line.1854">                return method != null || tag != null;</a>
<span class="sourceLineNo">1855</span><a id="line.1855">        }</a>
<span class="sourceLineNo">1856</span><a id="line.1856"></a>
<span class="sourceLineNo">1857</span><a id="line.1857">        public Class getJavaClass() {</a>
<span class="sourceLineNo">1858</span><a id="line.1858">        if (jc == null)</a>
<span class="sourceLineNo">1859</span><a id="line.1859">            jc = retType((tag!=null)?HostExpr.tagToClass(tag):null, (method!=null)?method.getReturnType():null);</a>
<span class="sourceLineNo">1860</span><a id="line.1860">        return jc;</a>
<span class="sourceLineNo">1861</span><a id="line.1861">        }</a>
<span class="sourceLineNo">1862</span><a id="line.1862">}</a>
<span class="sourceLineNo">1863</span><a id="line.1863"></a>
<span class="sourceLineNo">1864</span><a id="line.1864">static class UnresolvedVarExpr implements Expr{</a>
<span class="sourceLineNo">1865</span><a id="line.1865">        public final Symbol symbol;</a>
<span class="sourceLineNo">1866</span><a id="line.1866"></a>
<span class="sourceLineNo">1867</span><a id="line.1867">        public UnresolvedVarExpr(Symbol symbol){</a>
<span class="sourceLineNo">1868</span><a id="line.1868">                this.symbol = symbol;</a>
<span class="sourceLineNo">1869</span><a id="line.1869">        }</a>
<span class="sourceLineNo">1870</span><a id="line.1870"></a>
<span class="sourceLineNo">1871</span><a id="line.1871">        public boolean hasJavaClass(){</a>
<span class="sourceLineNo">1872</span><a id="line.1872">                return false;</a>
<span class="sourceLineNo">1873</span><a id="line.1873">        }</a>
<span class="sourceLineNo">1874</span><a id="line.1874"></a>
<span class="sourceLineNo">1875</span><a id="line.1875">        public Class getJavaClass() {</a>
<span class="sourceLineNo">1876</span><a id="line.1876">                throw new IllegalArgumentException(</a>
<span class="sourceLineNo">1877</span><a id="line.1877">                                "UnresolvedVarExpr has no Java class");</a>
<span class="sourceLineNo">1878</span><a id="line.1878">        }</a>
<span class="sourceLineNo">1879</span><a id="line.1879"></a>
<span class="sourceLineNo">1880</span><a id="line.1880">        public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">1881</span><a id="line.1881">        }</a>
<span class="sourceLineNo">1882</span><a id="line.1882"></a>
<span class="sourceLineNo">1883</span><a id="line.1883">        public Object eval() {</a>
<span class="sourceLineNo">1884</span><a id="line.1884">                throw new IllegalArgumentException(</a>
<span class="sourceLineNo">1885</span><a id="line.1885">                                "UnresolvedVarExpr cannot be evalled");</a>
<span class="sourceLineNo">1886</span><a id="line.1886">        }</a>
<span class="sourceLineNo">1887</span><a id="line.1887">}</a>
<span class="sourceLineNo">1888</span><a id="line.1888"></a>
<span class="sourceLineNo">1889</span><a id="line.1889">static class NumberExpr extends LiteralExpr implements MaybePrimitiveExpr{</a>
<span class="sourceLineNo">1890</span><a id="line.1890">        final Number n;</a>
<span class="sourceLineNo">1891</span><a id="line.1891">        public final int id;</a>
<span class="sourceLineNo">1892</span><a id="line.1892"></a>
<span class="sourceLineNo">1893</span><a id="line.1893">        public NumberExpr(Number n){</a>
<span class="sourceLineNo">1894</span><a id="line.1894">                this.n = n;</a>
<span class="sourceLineNo">1895</span><a id="line.1895">                this.id = registerConstant(n);</a>
<span class="sourceLineNo">1896</span><a id="line.1896">        }</a>
<span class="sourceLineNo">1897</span><a id="line.1897"></a>
<span class="sourceLineNo">1898</span><a id="line.1898">        Object val(){</a>
<span class="sourceLineNo">1899</span><a id="line.1899">                return n;</a>
<span class="sourceLineNo">1900</span><a id="line.1900">        }</a>
<span class="sourceLineNo">1901</span><a id="line.1901"></a>
<span class="sourceLineNo">1902</span><a id="line.1902">        public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">1903</span><a id="line.1903">                if(context != C.STATEMENT)</a>
<span class="sourceLineNo">1904</span><a id="line.1904">                        {</a>
<span class="sourceLineNo">1905</span><a id="line.1905">                        objx.emitConstant(gen, id);</a>
<span class="sourceLineNo">1906</span><a id="line.1906">//                      emitUnboxed(context,objx,gen);</a>
<span class="sourceLineNo">1907</span><a id="line.1907">//                      HostExpr.emitBoxReturn(objx,gen,getJavaClass());</a>
<span class="sourceLineNo">1908</span><a id="line.1908">                        }</a>
<span class="sourceLineNo">1909</span><a id="line.1909">        }</a>
<span class="sourceLineNo">1910</span><a id="line.1910"></a>
<span class="sourceLineNo">1911</span><a id="line.1911">        public boolean hasJavaClass() {</a>
<span class="sourceLineNo">1912</span><a id="line.1912">                return true;</a>
<span class="sourceLineNo">1913</span><a id="line.1913">        }</a>
<span class="sourceLineNo">1914</span><a id="line.1914"></a>
<span class="sourceLineNo">1915</span><a id="line.1915">        public Class getJavaClass(){</a>
<span class="sourceLineNo">1916</span><a id="line.1916">                if(n instanceof Integer)</a>
<span class="sourceLineNo">1917</span><a id="line.1917">                        return long.class;</a>
<span class="sourceLineNo">1918</span><a id="line.1918">                else if(n instanceof Double)</a>
<span class="sourceLineNo">1919</span><a id="line.1919">                        return double.class;</a>
<span class="sourceLineNo">1920</span><a id="line.1920">                else if(n instanceof Long)</a>
<span class="sourceLineNo">1921</span><a id="line.1921">                        return long.class;</a>
<span class="sourceLineNo">1922</span><a id="line.1922">                else</a>
<span class="sourceLineNo">1923</span><a id="line.1923">                        throw new IllegalStateException("Unsupported Number type: " + n.getClass().getName());</a>
<span class="sourceLineNo">1924</span><a id="line.1924">        }</a>
<span class="sourceLineNo">1925</span><a id="line.1925"></a>
<span class="sourceLineNo">1926</span><a id="line.1926">        public boolean canEmitPrimitive(){</a>
<span class="sourceLineNo">1927</span><a id="line.1927">                return true;</a>
<span class="sourceLineNo">1928</span><a id="line.1928">        }</a>
<span class="sourceLineNo">1929</span><a id="line.1929"></a>
<span class="sourceLineNo">1930</span><a id="line.1930">        public void emitUnboxed(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">1931</span><a id="line.1931">                if(n instanceof Integer)</a>
<span class="sourceLineNo">1932</span><a id="line.1932">                        gen.push(n.longValue());</a>
<span class="sourceLineNo">1933</span><a id="line.1933">                else if(n instanceof Double)</a>
<span class="sourceLineNo">1934</span><a id="line.1934">                        gen.push(n.doubleValue());</a>
<span class="sourceLineNo">1935</span><a id="line.1935">                else if(n instanceof Long)</a>
<span class="sourceLineNo">1936</span><a id="line.1936">                        gen.push(n.longValue());</a>
<span class="sourceLineNo">1937</span><a id="line.1937">        }</a>
<span class="sourceLineNo">1938</span><a id="line.1938"></a>
<span class="sourceLineNo">1939</span><a id="line.1939">        static public Expr parse(Number form){</a>
<span class="sourceLineNo">1940</span><a id="line.1940">                if(form instanceof Integer</a>
<span class="sourceLineNo">1941</span><a id="line.1941">                        || form instanceof Double</a>
<span class="sourceLineNo">1942</span><a id="line.1942">                        || form instanceof Long)</a>
<span class="sourceLineNo">1943</span><a id="line.1943">                        return new NumberExpr(form);</a>
<span class="sourceLineNo">1944</span><a id="line.1944">                else</a>
<span class="sourceLineNo">1945</span><a id="line.1945">                        return new ConstantExpr(form);</a>
<span class="sourceLineNo">1946</span><a id="line.1946">        }</a>
<span class="sourceLineNo">1947</span><a id="line.1947">}</a>
<span class="sourceLineNo">1948</span><a id="line.1948"></a>
<span class="sourceLineNo">1949</span><a id="line.1949">static class ConstantExpr extends LiteralExpr{</a>
<span class="sourceLineNo">1950</span><a id="line.1950">        //stuff quoted vals in classloader at compile time, pull out at runtime</a>
<span class="sourceLineNo">1951</span><a id="line.1951">        //this won't work for static compilation...</a>
<span class="sourceLineNo">1952</span><a id="line.1952">        public final Object v;</a>
<span class="sourceLineNo">1953</span><a id="line.1953">        public final int id;</a>
<span class="sourceLineNo">1954</span><a id="line.1954"></a>
<span class="sourceLineNo">1955</span><a id="line.1955">        public ConstantExpr(Object v){</a>
<span class="sourceLineNo">1956</span><a id="line.1956">                this.v = v;</a>
<span class="sourceLineNo">1957</span><a id="line.1957">                this.id = registerConstant(v);</a>
<span class="sourceLineNo">1958</span><a id="line.1958">//              this.id = RT.nextID();</a>
<span class="sourceLineNo">1959</span><a id="line.1959">//              DynamicClassLoader loader = (DynamicClassLoader) LOADER.get();</a>
<span class="sourceLineNo">1960</span><a id="line.1960">//              loader.registerQuotedVal(id, v);</a>
<span class="sourceLineNo">1961</span><a id="line.1961">        }</a>
<span class="sourceLineNo">1962</span><a id="line.1962"></a>
<span class="sourceLineNo">1963</span><a id="line.1963">        Object val(){</a>
<span class="sourceLineNo">1964</span><a id="line.1964">                return v;</a>
<span class="sourceLineNo">1965</span><a id="line.1965">        }</a>
<span class="sourceLineNo">1966</span><a id="line.1966"></a>
<span class="sourceLineNo">1967</span><a id="line.1967">        public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">1968</span><a id="line.1968">                objx.emitConstant(gen, id);</a>
<span class="sourceLineNo">1969</span><a id="line.1969"></a>
<span class="sourceLineNo">1970</span><a id="line.1970">                if(context == C.STATEMENT)</a>
<span class="sourceLineNo">1971</span><a id="line.1971">                        {</a>
<span class="sourceLineNo">1972</span><a id="line.1972">                        gen.pop();</a>
<span class="sourceLineNo">1973</span><a id="line.1973">//                      gen.loadThis();</a>
<span class="sourceLineNo">1974</span><a id="line.1974">//                      gen.invokeVirtual(OBJECT_TYPE, getClassMethod);</a>
<span class="sourceLineNo">1975</span><a id="line.1975">//                      gen.invokeVirtual(CLASS_TYPE, getClassLoaderMethod);</a>
<span class="sourceLineNo">1976</span><a id="line.1976">//                      gen.checkCast(DYNAMIC_CLASSLOADER_TYPE);</a>
<span class="sourceLineNo">1977</span><a id="line.1977">//                      gen.push(id);</a>
<span class="sourceLineNo">1978</span><a id="line.1978">//                      gen.invokeVirtual(DYNAMIC_CLASSLOADER_TYPE, getQuotedValMethod);</a>
<span class="sourceLineNo">1979</span><a id="line.1979">                        }</a>
<span class="sourceLineNo">1980</span><a id="line.1980">        }</a>
<span class="sourceLineNo">1981</span><a id="line.1981"></a>
<span class="sourceLineNo">1982</span><a id="line.1982">        public boolean hasJavaClass(){</a>
<span class="sourceLineNo">1983</span><a id="line.1983">                return Modifier.isPublic(v.getClass().getModifiers());</a>
<span class="sourceLineNo">1984</span><a id="line.1984">                //return false;</a>
<span class="sourceLineNo">1985</span><a id="line.1985">        }</a>
<span class="sourceLineNo">1986</span><a id="line.1986"></a>
<span class="sourceLineNo">1987</span><a id="line.1987">        public Class getJavaClass() {</a>
<span class="sourceLineNo">1988</span><a id="line.1988">                if(v instanceof APersistentMap)</a>
<span class="sourceLineNo">1989</span><a id="line.1989">                        return APersistentMap.class;</a>
<span class="sourceLineNo">1990</span><a id="line.1990">                else if (v instanceof APersistentSet)</a>
<span class="sourceLineNo">1991</span><a id="line.1991">                        return APersistentSet.class;</a>
<span class="sourceLineNo">1992</span><a id="line.1992">                else if (v instanceof APersistentVector)</a>
<span class="sourceLineNo">1993</span><a id="line.1993">                        return APersistentVector.class;</a>
<span class="sourceLineNo">1994</span><a id="line.1994">                else</a>
<span class="sourceLineNo">1995</span><a id="line.1995">                        return v.getClass();</a>
<span class="sourceLineNo">1996</span><a id="line.1996">                //throw new IllegalArgumentException("Has no Java class");</a>
<span class="sourceLineNo">1997</span><a id="line.1997">        }</a>
<span class="sourceLineNo">1998</span><a id="line.1998"></a>
<span class="sourceLineNo">1999</span><a id="line.1999">        static class Parser implements IParser{</a>
<span class="sourceLineNo">2000</span><a id="line.2000">                static Keyword formKey = Keyword.intern("form");</a>
<span class="sourceLineNo">2001</span><a id="line.2001"></a>
<span class="sourceLineNo">2002</span><a id="line.2002">                public Expr parse(C context, Object form){</a>
<span class="sourceLineNo">2003</span><a id="line.2003">                        int argCount = RT.count(form) - 1;</a>
<span class="sourceLineNo">2004</span><a id="line.2004">                        if(argCount != 1){</a>
<span class="sourceLineNo">2005</span><a id="line.2005">                                IPersistentMap exData = new PersistentArrayMap(new Object[]{formKey, form});</a>
<span class="sourceLineNo">2006</span><a id="line.2006">                                throw new ExceptionInfo("Wrong number of args (" +</a>
<span class="sourceLineNo">2007</span><a id="line.2007">                                                        argCount +</a>
<span class="sourceLineNo">2008</span><a id="line.2008">                                                        ") passed to quote",</a>
<span class="sourceLineNo">2009</span><a id="line.2009">                                                        exData);</a>
<span class="sourceLineNo">2010</span><a id="line.2010">                        }</a>
<span class="sourceLineNo">2011</span><a id="line.2011">                        Object v = RT.second(form);</a>
<span class="sourceLineNo">2012</span><a id="line.2012"></a>
<span class="sourceLineNo">2013</span><a id="line.2013">                        if(v == null)</a>
<span class="sourceLineNo">2014</span><a id="line.2014">                                return NIL_EXPR;</a>
<span class="sourceLineNo">2015</span><a id="line.2015">                        else if(v == Boolean.TRUE)</a>
<span class="sourceLineNo">2016</span><a id="line.2016">                                return TRUE_EXPR;</a>
<span class="sourceLineNo">2017</span><a id="line.2017">                        else if(v == Boolean.FALSE)</a>
<span class="sourceLineNo">2018</span><a id="line.2018">                                return FALSE_EXPR;</a>
<span class="sourceLineNo">2019</span><a id="line.2019">                        if(v instanceof Number)</a>
<span class="sourceLineNo">2020</span><a id="line.2020">                                return NumberExpr.parse((Number)v);</a>
<span class="sourceLineNo">2021</span><a id="line.2021">                        else if(v instanceof String)</a>
<span class="sourceLineNo">2022</span><a id="line.2022">                                return new StringExpr((String) v);</a>
<span class="sourceLineNo">2023</span><a id="line.2023">                        else if(v instanceof IPersistentCollection &amp;&amp; ((IPersistentCollection) v).count() == 0)</a>
<span class="sourceLineNo">2024</span><a id="line.2024">                                return new EmptyExpr(v);</a>
<span class="sourceLineNo">2025</span><a id="line.2025">                        else</a>
<span class="sourceLineNo">2026</span><a id="line.2026">                                return new ConstantExpr(v);</a>
<span class="sourceLineNo">2027</span><a id="line.2027">                }</a>
<span class="sourceLineNo">2028</span><a id="line.2028">        }</a>
<span class="sourceLineNo">2029</span><a id="line.2029">}</a>
<span class="sourceLineNo">2030</span><a id="line.2030"></a>
<span class="sourceLineNo">2031</span><a id="line.2031">static class NilExpr extends LiteralExpr{</a>
<span class="sourceLineNo">2032</span><a id="line.2032">        Object val(){</a>
<span class="sourceLineNo">2033</span><a id="line.2033">                return null;</a>
<span class="sourceLineNo">2034</span><a id="line.2034">        }</a>
<span class="sourceLineNo">2035</span><a id="line.2035"></a>
<span class="sourceLineNo">2036</span><a id="line.2036">        public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">2037</span><a id="line.2037">                gen.visitInsn(Opcodes.ACONST_NULL);</a>
<span class="sourceLineNo">2038</span><a id="line.2038">                if(context == C.STATEMENT)</a>
<span class="sourceLineNo">2039</span><a id="line.2039">                        gen.pop();</a>
<span class="sourceLineNo">2040</span><a id="line.2040">        }</a>
<span class="sourceLineNo">2041</span><a id="line.2041"></a>
<span class="sourceLineNo">2042</span><a id="line.2042">        public boolean hasJavaClass(){</a>
<span class="sourceLineNo">2043</span><a id="line.2043">                return true;</a>
<span class="sourceLineNo">2044</span><a id="line.2044">        }</a>
<span class="sourceLineNo">2045</span><a id="line.2045"></a>
<span class="sourceLineNo">2046</span><a id="line.2046">        public Class getJavaClass() {</a>
<span class="sourceLineNo">2047</span><a id="line.2047">                return null;</a>
<span class="sourceLineNo">2048</span><a id="line.2048">        }</a>
<span class="sourceLineNo">2049</span><a id="line.2049">}</a>
<span class="sourceLineNo">2050</span><a id="line.2050"></a>
<span class="sourceLineNo">2051</span><a id="line.2051">final static NilExpr NIL_EXPR = new NilExpr();</a>
<span class="sourceLineNo">2052</span><a id="line.2052"></a>
<span class="sourceLineNo">2053</span><a id="line.2053">static class BooleanExpr extends LiteralExpr{</a>
<span class="sourceLineNo">2054</span><a id="line.2054">        public final boolean val;</a>
<span class="sourceLineNo">2055</span><a id="line.2055"></a>
<span class="sourceLineNo">2056</span><a id="line.2056"></a>
<span class="sourceLineNo">2057</span><a id="line.2057">        public BooleanExpr(boolean val){</a>
<span class="sourceLineNo">2058</span><a id="line.2058">                this.val = val;</a>
<span class="sourceLineNo">2059</span><a id="line.2059">        }</a>
<span class="sourceLineNo">2060</span><a id="line.2060"></a>
<span class="sourceLineNo">2061</span><a id="line.2061">        Object val(){</a>
<span class="sourceLineNo">2062</span><a id="line.2062">                return val ? RT.T : RT.F;</a>
<span class="sourceLineNo">2063</span><a id="line.2063">        }</a>
<span class="sourceLineNo">2064</span><a id="line.2064"></a>
<span class="sourceLineNo">2065</span><a id="line.2065">        public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">2066</span><a id="line.2066">                if(val)</a>
<span class="sourceLineNo">2067</span><a id="line.2067">                        gen.getStatic(BOOLEAN_OBJECT_TYPE, "TRUE", BOOLEAN_OBJECT_TYPE);</a>
<span class="sourceLineNo">2068</span><a id="line.2068">                else</a>
<span class="sourceLineNo">2069</span><a id="line.2069">                        gen.getStatic(BOOLEAN_OBJECT_TYPE, "FALSE", BOOLEAN_OBJECT_TYPE);</a>
<span class="sourceLineNo">2070</span><a id="line.2070">                if(context == C.STATEMENT)</a>
<span class="sourceLineNo">2071</span><a id="line.2071">                        {</a>
<span class="sourceLineNo">2072</span><a id="line.2072">                        gen.pop();</a>
<span class="sourceLineNo">2073</span><a id="line.2073">                        }</a>
<span class="sourceLineNo">2074</span><a id="line.2074">        }</a>
<span class="sourceLineNo">2075</span><a id="line.2075"></a>
<span class="sourceLineNo">2076</span><a id="line.2076">        public boolean hasJavaClass(){</a>
<span class="sourceLineNo">2077</span><a id="line.2077">                return true;</a>
<span class="sourceLineNo">2078</span><a id="line.2078">        }</a>
<span class="sourceLineNo">2079</span><a id="line.2079"></a>
<span class="sourceLineNo">2080</span><a id="line.2080">        public Class getJavaClass() {</a>
<span class="sourceLineNo">2081</span><a id="line.2081">                return Boolean.class;</a>
<span class="sourceLineNo">2082</span><a id="line.2082">        }</a>
<span class="sourceLineNo">2083</span><a id="line.2083">}</a>
<span class="sourceLineNo">2084</span><a id="line.2084"></a>
<span class="sourceLineNo">2085</span><a id="line.2085">final static BooleanExpr TRUE_EXPR = new BooleanExpr(true);</a>
<span class="sourceLineNo">2086</span><a id="line.2086">final static BooleanExpr FALSE_EXPR = new BooleanExpr(false);</a>
<span class="sourceLineNo">2087</span><a id="line.2087"></a>
<span class="sourceLineNo">2088</span><a id="line.2088">static class StringExpr extends LiteralExpr{</a>
<span class="sourceLineNo">2089</span><a id="line.2089">        public final String str;</a>
<span class="sourceLineNo">2090</span><a id="line.2090"></a>
<span class="sourceLineNo">2091</span><a id="line.2091">        public StringExpr(String str){</a>
<span class="sourceLineNo">2092</span><a id="line.2092">                this.str = str;</a>
<span class="sourceLineNo">2093</span><a id="line.2093">        }</a>
<span class="sourceLineNo">2094</span><a id="line.2094"></a>
<span class="sourceLineNo">2095</span><a id="line.2095">        Object val(){</a>
<span class="sourceLineNo">2096</span><a id="line.2096">                return str;</a>
<span class="sourceLineNo">2097</span><a id="line.2097">        }</a>
<span class="sourceLineNo">2098</span><a id="line.2098"></a>
<span class="sourceLineNo">2099</span><a id="line.2099">        public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">2100</span><a id="line.2100">                if(context != C.STATEMENT)</a>
<span class="sourceLineNo">2101</span><a id="line.2101">                        gen.push(str);</a>
<span class="sourceLineNo">2102</span><a id="line.2102">        }</a>
<span class="sourceLineNo">2103</span><a id="line.2103"></a>
<span class="sourceLineNo">2104</span><a id="line.2104">        public boolean hasJavaClass(){</a>
<span class="sourceLineNo">2105</span><a id="line.2105">                return true;</a>
<span class="sourceLineNo">2106</span><a id="line.2106">        }</a>
<span class="sourceLineNo">2107</span><a id="line.2107"></a>
<span class="sourceLineNo">2108</span><a id="line.2108">        public Class getJavaClass() {</a>
<span class="sourceLineNo">2109</span><a id="line.2109">                return String.class;</a>
<span class="sourceLineNo">2110</span><a id="line.2110">        }</a>
<span class="sourceLineNo">2111</span><a id="line.2111">}</a>
<span class="sourceLineNo">2112</span><a id="line.2112"></a>
<span class="sourceLineNo">2113</span><a id="line.2113"></a>
<span class="sourceLineNo">2114</span><a id="line.2114">static class MonitorEnterExpr extends UntypedExpr{</a>
<span class="sourceLineNo">2115</span><a id="line.2115">        final Expr target;</a>
<span class="sourceLineNo">2116</span><a id="line.2116"></a>
<span class="sourceLineNo">2117</span><a id="line.2117">        public MonitorEnterExpr(Expr target){</a>
<span class="sourceLineNo">2118</span><a id="line.2118">                this.target = target;</a>
<span class="sourceLineNo">2119</span><a id="line.2119">        }</a>
<span class="sourceLineNo">2120</span><a id="line.2120"></a>
<span class="sourceLineNo">2121</span><a id="line.2121">        public Object eval() {</a>
<span class="sourceLineNo">2122</span><a id="line.2122">                throw new UnsupportedOperationException("Can't eval monitor-enter");</a>
<span class="sourceLineNo">2123</span><a id="line.2123">        }</a>
<span class="sourceLineNo">2124</span><a id="line.2124"></a>
<span class="sourceLineNo">2125</span><a id="line.2125">        public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">2126</span><a id="line.2126">                target.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">2127</span><a id="line.2127">                gen.monitorEnter();</a>
<span class="sourceLineNo">2128</span><a id="line.2128">                NIL_EXPR.emit(context, objx, gen);</a>
<span class="sourceLineNo">2129</span><a id="line.2129">        }</a>
<span class="sourceLineNo">2130</span><a id="line.2130"></a>
<span class="sourceLineNo">2131</span><a id="line.2131">        static class Parser implements IParser{</a>
<span class="sourceLineNo">2132</span><a id="line.2132">                public Expr parse(C context, Object form) {</a>
<span class="sourceLineNo">2133</span><a id="line.2133">                        return new MonitorEnterExpr(analyze(C.EXPRESSION, RT.second(form)));</a>
<span class="sourceLineNo">2134</span><a id="line.2134">                }</a>
<span class="sourceLineNo">2135</span><a id="line.2135">        }</a>
<span class="sourceLineNo">2136</span><a id="line.2136">}</a>
<span class="sourceLineNo">2137</span><a id="line.2137"></a>
<span class="sourceLineNo">2138</span><a id="line.2138">static class MonitorExitExpr extends UntypedExpr{</a>
<span class="sourceLineNo">2139</span><a id="line.2139">        final Expr target;</a>
<span class="sourceLineNo">2140</span><a id="line.2140"></a>
<span class="sourceLineNo">2141</span><a id="line.2141">        public MonitorExitExpr(Expr target){</a>
<span class="sourceLineNo">2142</span><a id="line.2142">                this.target = target;</a>
<span class="sourceLineNo">2143</span><a id="line.2143">        }</a>
<span class="sourceLineNo">2144</span><a id="line.2144"></a>
<span class="sourceLineNo">2145</span><a id="line.2145">        public Object eval() {</a>
<span class="sourceLineNo">2146</span><a id="line.2146">                throw new UnsupportedOperationException("Can't eval monitor-exit");</a>
<span class="sourceLineNo">2147</span><a id="line.2147">        }</a>
<span class="sourceLineNo">2148</span><a id="line.2148"></a>
<span class="sourceLineNo">2149</span><a id="line.2149">        public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">2150</span><a id="line.2150">                target.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">2151</span><a id="line.2151">                gen.monitorExit();</a>
<span class="sourceLineNo">2152</span><a id="line.2152">                NIL_EXPR.emit(context, objx, gen);</a>
<span class="sourceLineNo">2153</span><a id="line.2153">        }</a>
<span class="sourceLineNo">2154</span><a id="line.2154"></a>
<span class="sourceLineNo">2155</span><a id="line.2155">        static class Parser implements IParser{</a>
<span class="sourceLineNo">2156</span><a id="line.2156">                public Expr parse(C context, Object form) {</a>
<span class="sourceLineNo">2157</span><a id="line.2157">                        return new MonitorExitExpr(analyze(C.EXPRESSION, RT.second(form)));</a>
<span class="sourceLineNo">2158</span><a id="line.2158">                }</a>
<span class="sourceLineNo">2159</span><a id="line.2159">        }</a>
<span class="sourceLineNo">2160</span><a id="line.2160"></a>
<span class="sourceLineNo">2161</span><a id="line.2161">}</a>
<span class="sourceLineNo">2162</span><a id="line.2162"></a>
<span class="sourceLineNo">2163</span><a id="line.2163">public static class TryExpr implements Expr{</a>
<span class="sourceLineNo">2164</span><a id="line.2164">        public final Expr tryExpr;</a>
<span class="sourceLineNo">2165</span><a id="line.2165">        public final Expr finallyExpr;</a>
<span class="sourceLineNo">2166</span><a id="line.2166">        public final PersistentVector catchExprs;</a>
<span class="sourceLineNo">2167</span><a id="line.2167">        public final int retLocal;</a>
<span class="sourceLineNo">2168</span><a id="line.2168">        public final int finallyLocal;</a>
<span class="sourceLineNo">2169</span><a id="line.2169"></a>
<span class="sourceLineNo">2170</span><a id="line.2170">        public static class CatchClause{</a>
<span class="sourceLineNo">2171</span><a id="line.2171">                //final String className;</a>
<span class="sourceLineNo">2172</span><a id="line.2172">                public final Class c;</a>
<span class="sourceLineNo">2173</span><a id="line.2173">                public final LocalBinding lb;</a>
<span class="sourceLineNo">2174</span><a id="line.2174">                public final Expr handler;</a>
<span class="sourceLineNo">2175</span><a id="line.2175">                Label label;</a>
<span class="sourceLineNo">2176</span><a id="line.2176">                Label endLabel;</a>
<span class="sourceLineNo">2177</span><a id="line.2177"></a>
<span class="sourceLineNo">2178</span><a id="line.2178"></a>
<span class="sourceLineNo">2179</span><a id="line.2179">                public CatchClause(Class c, LocalBinding lb, Expr handler){</a>
<span class="sourceLineNo">2180</span><a id="line.2180">                        this.c = c;</a>
<span class="sourceLineNo">2181</span><a id="line.2181">                        this.lb = lb;</a>
<span class="sourceLineNo">2182</span><a id="line.2182">                        this.handler = handler;</a>
<span class="sourceLineNo">2183</span><a id="line.2183">                }</a>
<span class="sourceLineNo">2184</span><a id="line.2184">        }</a>
<span class="sourceLineNo">2185</span><a id="line.2185"></a>
<span class="sourceLineNo">2186</span><a id="line.2186">        public TryExpr(Expr tryExpr, PersistentVector catchExprs, Expr finallyExpr, int retLocal, int finallyLocal){</a>
<span class="sourceLineNo">2187</span><a id="line.2187">                this.tryExpr = tryExpr;</a>
<span class="sourceLineNo">2188</span><a id="line.2188">                this.catchExprs = catchExprs;</a>
<span class="sourceLineNo">2189</span><a id="line.2189">                this.finallyExpr = finallyExpr;</a>
<span class="sourceLineNo">2190</span><a id="line.2190">                this.retLocal = retLocal;</a>
<span class="sourceLineNo">2191</span><a id="line.2191">                this.finallyLocal = finallyLocal;</a>
<span class="sourceLineNo">2192</span><a id="line.2192">        }</a>
<span class="sourceLineNo">2193</span><a id="line.2193"></a>
<span class="sourceLineNo">2194</span><a id="line.2194">        public Object eval() {</a>
<span class="sourceLineNo">2195</span><a id="line.2195">                throw new UnsupportedOperationException("Can't eval try");</a>
<span class="sourceLineNo">2196</span><a id="line.2196">        }</a>
<span class="sourceLineNo">2197</span><a id="line.2197"></a>
<span class="sourceLineNo">2198</span><a id="line.2198">        public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">2199</span><a id="line.2199">                Label startTry = gen.newLabel();</a>
<span class="sourceLineNo">2200</span><a id="line.2200">                Label endTry = gen.newLabel();</a>
<span class="sourceLineNo">2201</span><a id="line.2201">                Label end = gen.newLabel();</a>
<span class="sourceLineNo">2202</span><a id="line.2202">                Label ret = gen.newLabel();</a>
<span class="sourceLineNo">2203</span><a id="line.2203">                Label finallyLabel = gen.newLabel();</a>
<span class="sourceLineNo">2204</span><a id="line.2204">                for(int i = 0; i &lt; catchExprs.count(); i++)</a>
<span class="sourceLineNo">2205</span><a id="line.2205">                        {</a>
<span class="sourceLineNo">2206</span><a id="line.2206">                        CatchClause clause = (CatchClause) catchExprs.nth(i);</a>
<span class="sourceLineNo">2207</span><a id="line.2207">                        clause.label = gen.newLabel();</a>
<span class="sourceLineNo">2208</span><a id="line.2208">                        clause.endLabel = gen.newLabel();</a>
<span class="sourceLineNo">2209</span><a id="line.2209">                        }</a>
<span class="sourceLineNo">2210</span><a id="line.2210"></a>
<span class="sourceLineNo">2211</span><a id="line.2211">                gen.mark(startTry);</a>
<span class="sourceLineNo">2212</span><a id="line.2212">                tryExpr.emit(context, objx, gen);</a>
<span class="sourceLineNo">2213</span><a id="line.2213">                if(context != C.STATEMENT)</a>
<span class="sourceLineNo">2214</span><a id="line.2214">                        gen.visitVarInsn(OBJECT_TYPE.getOpcode(Opcodes.ISTORE), retLocal);</a>
<span class="sourceLineNo">2215</span><a id="line.2215">                gen.mark(endTry);</a>
<span class="sourceLineNo">2216</span><a id="line.2216">                if(finallyExpr != null)</a>
<span class="sourceLineNo">2217</span><a id="line.2217">                        finallyExpr.emit(C.STATEMENT, objx, gen);</a>
<span class="sourceLineNo">2218</span><a id="line.2218">                gen.goTo(ret);</a>
<span class="sourceLineNo">2219</span><a id="line.2219"></a>
<span class="sourceLineNo">2220</span><a id="line.2220">                for(int i = 0; i &lt; catchExprs.count(); i++)</a>
<span class="sourceLineNo">2221</span><a id="line.2221">                        {</a>
<span class="sourceLineNo">2222</span><a id="line.2222">                        CatchClause clause = (CatchClause) catchExprs.nth(i);</a>
<span class="sourceLineNo">2223</span><a id="line.2223">                        gen.mark(clause.label);</a>
<span class="sourceLineNo">2224</span><a id="line.2224">                        //exception should be on stack</a>
<span class="sourceLineNo">2225</span><a id="line.2225">                        //put in clause local</a>
<span class="sourceLineNo">2226</span><a id="line.2226">                        gen.visitVarInsn(OBJECT_TYPE.getOpcode(Opcodes.ISTORE), clause.lb.idx);</a>
<span class="sourceLineNo">2227</span><a id="line.2227">                        clause.handler.emit(context, objx, gen);</a>
<span class="sourceLineNo">2228</span><a id="line.2228">                        if(context != C.STATEMENT)</a>
<span class="sourceLineNo">2229</span><a id="line.2229">                                gen.visitVarInsn(OBJECT_TYPE.getOpcode(Opcodes.ISTORE), retLocal);</a>
<span class="sourceLineNo">2230</span><a id="line.2230">                        gen.mark(clause.endLabel);</a>
<span class="sourceLineNo">2231</span><a id="line.2231"></a>
<span class="sourceLineNo">2232</span><a id="line.2232">                        if(finallyExpr != null)</a>
<span class="sourceLineNo">2233</span><a id="line.2233">                                finallyExpr.emit(C.STATEMENT, objx, gen);</a>
<span class="sourceLineNo">2234</span><a id="line.2234">                        gen.goTo(ret);</a>
<span class="sourceLineNo">2235</span><a id="line.2235">                        }</a>
<span class="sourceLineNo">2236</span><a id="line.2236">                if(finallyExpr != null)</a>
<span class="sourceLineNo">2237</span><a id="line.2237">                        {</a>
<span class="sourceLineNo">2238</span><a id="line.2238">                        gen.mark(finallyLabel);</a>
<span class="sourceLineNo">2239</span><a id="line.2239">                        //exception should be on stack</a>
<span class="sourceLineNo">2240</span><a id="line.2240">                        gen.visitVarInsn(OBJECT_TYPE.getOpcode(Opcodes.ISTORE), finallyLocal);</a>
<span class="sourceLineNo">2241</span><a id="line.2241">                        finallyExpr.emit(C.STATEMENT, objx, gen);</a>
<span class="sourceLineNo">2242</span><a id="line.2242">                        gen.visitVarInsn(OBJECT_TYPE.getOpcode(Opcodes.ILOAD), finallyLocal);</a>
<span class="sourceLineNo">2243</span><a id="line.2243">                        gen.throwException();</a>
<span class="sourceLineNo">2244</span><a id="line.2244">                        }</a>
<span class="sourceLineNo">2245</span><a id="line.2245">                gen.mark(ret);</a>
<span class="sourceLineNo">2246</span><a id="line.2246">                if(context != C.STATEMENT)</a>
<span class="sourceLineNo">2247</span><a id="line.2247">                        gen.visitVarInsn(OBJECT_TYPE.getOpcode(Opcodes.ILOAD), retLocal);</a>
<span class="sourceLineNo">2248</span><a id="line.2248">                gen.mark(end);</a>
<span class="sourceLineNo">2249</span><a id="line.2249">                for(int i = 0; i &lt; catchExprs.count(); i++)</a>
<span class="sourceLineNo">2250</span><a id="line.2250">                        {</a>
<span class="sourceLineNo">2251</span><a id="line.2251">                        CatchClause clause = (CatchClause) catchExprs.nth(i);</a>
<span class="sourceLineNo">2252</span><a id="line.2252">                        gen.visitTryCatchBlock(startTry, endTry, clause.label, clause.c.getName().replace('.', '/'));</a>
<span class="sourceLineNo">2253</span><a id="line.2253">                        }</a>
<span class="sourceLineNo">2254</span><a id="line.2254">                if(finallyExpr != null)</a>
<span class="sourceLineNo">2255</span><a id="line.2255">                        {</a>
<span class="sourceLineNo">2256</span><a id="line.2256">                                gen.visitTryCatchBlock(startTry, endTry, finallyLabel, null);</a>
<span class="sourceLineNo">2257</span><a id="line.2257">                                for(int i = 0; i &lt; catchExprs.count(); i++)</a>
<span class="sourceLineNo">2258</span><a id="line.2258">                                        {</a>
<span class="sourceLineNo">2259</span><a id="line.2259">                                        CatchClause clause = (CatchClause) catchExprs.nth(i);</a>
<span class="sourceLineNo">2260</span><a id="line.2260">                                        gen.visitTryCatchBlock(clause.label, clause.endLabel, finallyLabel, null);</a>
<span class="sourceLineNo">2261</span><a id="line.2261">                                        }</a>
<span class="sourceLineNo">2262</span><a id="line.2262">                        }</a>
<span class="sourceLineNo">2263</span><a id="line.2263">                for(int i = 0; i &lt; catchExprs.count(); i++)</a>
<span class="sourceLineNo">2264</span><a id="line.2264">                        {</a>
<span class="sourceLineNo">2265</span><a id="line.2265">                        CatchClause clause = (CatchClause) catchExprs.nth(i);</a>
<span class="sourceLineNo">2266</span><a id="line.2266">                        gen.visitLocalVariable(clause.lb.name, "Ljava/lang/Object;", null, clause.label, clause.endLabel,</a>
<span class="sourceLineNo">2267</span><a id="line.2267">                                               clause.lb.idx);</a>
<span class="sourceLineNo">2268</span><a id="line.2268">                        }</a>
<span class="sourceLineNo">2269</span><a id="line.2269">        }</a>
<span class="sourceLineNo">2270</span><a id="line.2270"></a>
<span class="sourceLineNo">2271</span><a id="line.2271">        public boolean hasJavaClass() {</a>
<span class="sourceLineNo">2272</span><a id="line.2272">                return tryExpr.hasJavaClass();</a>
<span class="sourceLineNo">2273</span><a id="line.2273">        }</a>
<span class="sourceLineNo">2274</span><a id="line.2274"></a>
<span class="sourceLineNo">2275</span><a id="line.2275">        public Class getJavaClass() {</a>
<span class="sourceLineNo">2276</span><a id="line.2276">                return tryExpr.getJavaClass();</a>
<span class="sourceLineNo">2277</span><a id="line.2277">        }</a>
<span class="sourceLineNo">2278</span><a id="line.2278"></a>
<span class="sourceLineNo">2279</span><a id="line.2279">        static class Parser implements IParser{</a>
<span class="sourceLineNo">2280</span><a id="line.2280"></a>
<span class="sourceLineNo">2281</span><a id="line.2281">                public Expr parse(C context, Object frm) {</a>
<span class="sourceLineNo">2282</span><a id="line.2282">                        ISeq form = (ISeq) frm;</a>
<span class="sourceLineNo">2283</span><a id="line.2283">//                      if(context == C.EVAL || context == C.EXPRESSION)</a>
<span class="sourceLineNo">2284</span><a id="line.2284">                        if(context != C.RETURN)</a>
<span class="sourceLineNo">2285</span><a id="line.2285">                                return analyze(context, RT.list(RT.list(FNONCE, PersistentVector.EMPTY, form)));</a>
<span class="sourceLineNo">2286</span><a id="line.2286"></a>
<span class="sourceLineNo">2287</span><a id="line.2287">                        //(try try-expr* catch-expr* finally-expr?)</a>
<span class="sourceLineNo">2288</span><a id="line.2288">                        //catch-expr: (catch class sym expr*)</a>
<span class="sourceLineNo">2289</span><a id="line.2289">                        //finally-expr: (finally expr*)</a>
<span class="sourceLineNo">2290</span><a id="line.2290"></a>
<span class="sourceLineNo">2291</span><a id="line.2291">                        PersistentVector body = PersistentVector.EMPTY;</a>
<span class="sourceLineNo">2292</span><a id="line.2292">                        PersistentVector catches = PersistentVector.EMPTY;</a>
<span class="sourceLineNo">2293</span><a id="line.2293">            Expr bodyExpr = null;</a>
<span class="sourceLineNo">2294</span><a id="line.2294">                        Expr finallyExpr = null;</a>
<span class="sourceLineNo">2295</span><a id="line.2295">                        boolean caught = false;</a>
<span class="sourceLineNo">2296</span><a id="line.2296"></a>
<span class="sourceLineNo">2297</span><a id="line.2297">                        int retLocal = getAndIncLocalNum();</a>
<span class="sourceLineNo">2298</span><a id="line.2298">                        int finallyLocal = getAndIncLocalNum();</a>
<span class="sourceLineNo">2299</span><a id="line.2299">                        for(ISeq fs = form.next(); fs != null; fs = fs.next())</a>
<span class="sourceLineNo">2300</span><a id="line.2300">                                {</a>
<span class="sourceLineNo">2301</span><a id="line.2301">                                Object f = fs.first();</a>
<span class="sourceLineNo">2302</span><a id="line.2302">                                Object op = (f instanceof ISeq) ? ((ISeq) f).first() : null;</a>
<span class="sourceLineNo">2303</span><a id="line.2303">                                if(!Util.equals(op, CATCH) &amp;&amp; !Util.equals(op, FINALLY))</a>
<span class="sourceLineNo">2304</span><a id="line.2304">                                        {</a>
<span class="sourceLineNo">2305</span><a id="line.2305">                                        if(caught)</a>
<span class="sourceLineNo">2306</span><a id="line.2306">                                            throw Util.runtimeException("Only catch or finally clause can follow catch in try expression");</a>
<span class="sourceLineNo">2307</span><a id="line.2307">                                        body = body.cons(f);</a>
<span class="sourceLineNo">2308</span><a id="line.2308">                                        }</a>
<span class="sourceLineNo">2309</span><a id="line.2309">                                else</a>
<span class="sourceLineNo">2310</span><a id="line.2310">                                        {</a>
<span class="sourceLineNo">2311</span><a id="line.2311">                                        if(bodyExpr == null)</a>
<span class="sourceLineNo">2312</span><a id="line.2312">                                                try {</a>
<span class="sourceLineNo">2313</span><a id="line.2313">                                                        Var.pushThreadBindings(RT.map(NO_RECUR, true, METHOD_RETURN_CONTEXT, null));</a>
<span class="sourceLineNo">2314</span><a id="line.2314">                                                        bodyExpr = (new BodyExpr.Parser()).parse(context, RT.seq(body));</a>
<span class="sourceLineNo">2315</span><a id="line.2315">                                                } finally {</a>
<span class="sourceLineNo">2316</span><a id="line.2316">                                                        Var.popThreadBindings();</a>
<span class="sourceLineNo">2317</span><a id="line.2317">                                                }</a>
<span class="sourceLineNo">2318</span><a id="line.2318"></a>
<span class="sourceLineNo">2319</span><a id="line.2319">                                        if(Util.equals(op, CATCH))</a>
<span class="sourceLineNo">2320</span><a id="line.2320">                                                {</a>
<span class="sourceLineNo">2321</span><a id="line.2321">                                                Class c = HostExpr.maybeClass(RT.second(f), false);</a>
<span class="sourceLineNo">2322</span><a id="line.2322">                                                if(c == null)</a>
<span class="sourceLineNo">2323</span><a id="line.2323">                                                        throw new IllegalArgumentException("Unable to resolve classname: " + RT.second(f));</a>
<span class="sourceLineNo">2324</span><a id="line.2324">                                                if(!(RT.third(f) instanceof Symbol))</a>
<span class="sourceLineNo">2325</span><a id="line.2325">                                                        throw new IllegalArgumentException(</a>
<span class="sourceLineNo">2326</span><a id="line.2326">                                                                        "Bad binding form, expected symbol, got: " + RT.third(f));</a>
<span class="sourceLineNo">2327</span><a id="line.2327">                                                Symbol sym = (Symbol) RT.third(f);</a>
<span class="sourceLineNo">2328</span><a id="line.2328">                                                if(sym.getNamespace() != null)</a>
<span class="sourceLineNo">2329</span><a id="line.2329">                                                        throw Util.runtimeException("Can't bind qualified name:" + sym);</a>
<span class="sourceLineNo">2330</span><a id="line.2330"></a>
<span class="sourceLineNo">2331</span><a id="line.2331">                                                IPersistentMap dynamicBindings = RT.map(LOCAL_ENV, LOCAL_ENV.deref(),</a>
<span class="sourceLineNo">2332</span><a id="line.2332">                                                                                        NEXT_LOCAL_NUM, NEXT_LOCAL_NUM.deref(),</a>
<span class="sourceLineNo">2333</span><a id="line.2333">                                                                                        IN_CATCH_FINALLY, RT.T);</a>
<span class="sourceLineNo">2334</span><a id="line.2334">                                                try</a>
<span class="sourceLineNo">2335</span><a id="line.2335">                                                        {</a>
<span class="sourceLineNo">2336</span><a id="line.2336">                                                        Var.pushThreadBindings(dynamicBindings);</a>
<span class="sourceLineNo">2337</span><a id="line.2337">                                                        LocalBinding lb = registerLocal(sym,</a>
<span class="sourceLineNo">2338</span><a id="line.2338">                                                                                        (Symbol) (RT.second(f) instanceof Symbol ? RT.second(f)</a>
<span class="sourceLineNo">2339</span><a id="line.2339">                                                                                                                                 : null),</a>
<span class="sourceLineNo">2340</span><a id="line.2340">                                                                                        null,false);</a>
<span class="sourceLineNo">2341</span><a id="line.2341">                                                        Expr handler = (new BodyExpr.Parser()).parse(C.EXPRESSION, RT.next(RT.next(RT.next(f))));</a>
<span class="sourceLineNo">2342</span><a id="line.2342">                                                        catches = catches.cons(new CatchClause(c, lb, handler));</a>
<span class="sourceLineNo">2343</span><a id="line.2343">                                                        }</a>
<span class="sourceLineNo">2344</span><a id="line.2344">                                                finally</a>
<span class="sourceLineNo">2345</span><a id="line.2345">                                                        {</a>
<span class="sourceLineNo">2346</span><a id="line.2346">                                                        Var.popThreadBindings();</a>
<span class="sourceLineNo">2347</span><a id="line.2347">                                                        }</a>
<span class="sourceLineNo">2348</span><a id="line.2348">                                                caught = true;</a>
<span class="sourceLineNo">2349</span><a id="line.2349">                                                }</a>
<span class="sourceLineNo">2350</span><a id="line.2350">                                        else //finally</a>
<span class="sourceLineNo">2351</span><a id="line.2351">                                                {</a>
<span class="sourceLineNo">2352</span><a id="line.2352">                                                if(fs.next() != null)</a>
<span class="sourceLineNo">2353</span><a id="line.2353">                                                        throw Util.runtimeException("finally clause must be last in try expression");</a>
<span class="sourceLineNo">2354</span><a id="line.2354">                                                try</a>
<span class="sourceLineNo">2355</span><a id="line.2355">                                                        {</a>
<span class="sourceLineNo">2356</span><a id="line.2356">                                                        Var.pushThreadBindings(RT.map(IN_CATCH_FINALLY, RT.T));</a>
<span class="sourceLineNo">2357</span><a id="line.2357">                                                        finallyExpr = (new BodyExpr.Parser()).parse(C.STATEMENT, RT.next(f));</a>
<span class="sourceLineNo">2358</span><a id="line.2358">                                                        }</a>
<span class="sourceLineNo">2359</span><a id="line.2359">                                                finally</a>
<span class="sourceLineNo">2360</span><a id="line.2360">                                                        {</a>
<span class="sourceLineNo">2361</span><a id="line.2361">                                                        Var.popThreadBindings();</a>
<span class="sourceLineNo">2362</span><a id="line.2362">                                                        }</a>
<span class="sourceLineNo">2363</span><a id="line.2363">                                                }</a>
<span class="sourceLineNo">2364</span><a id="line.2364">                                        }</a>
<span class="sourceLineNo">2365</span><a id="line.2365">                                }</a>
<span class="sourceLineNo">2366</span><a id="line.2366">                        if(bodyExpr == null)</a>
<span class="sourceLineNo">2367</span><a id="line.2367">                                {</a>
<span class="sourceLineNo">2368</span><a id="line.2368">                                // this codepath is hit when there is neither catch or finally, e.g. (try (expr))</a>
<span class="sourceLineNo">2369</span><a id="line.2369">                                // return a body expr directly</a>
<span class="sourceLineNo">2370</span><a id="line.2370">                                try</a>
<span class="sourceLineNo">2371</span><a id="line.2371">                                        {</a>
<span class="sourceLineNo">2372</span><a id="line.2372">                                        Var.pushThreadBindings(RT.map(NO_RECUR, true));</a>
<span class="sourceLineNo">2373</span><a id="line.2373">                                        bodyExpr = (new BodyExpr.Parser()).parse(context, RT.seq(body));</a>
<span class="sourceLineNo">2374</span><a id="line.2374">                                        }</a>
<span class="sourceLineNo">2375</span><a id="line.2375">                                finally</a>
<span class="sourceLineNo">2376</span><a id="line.2376">                                        {</a>
<span class="sourceLineNo">2377</span><a id="line.2377">                                        Var.popThreadBindings();</a>
<span class="sourceLineNo">2378</span><a id="line.2378">                                        }</a>
<span class="sourceLineNo">2379</span><a id="line.2379">                                return bodyExpr;</a>
<span class="sourceLineNo">2380</span><a id="line.2380">                                }</a>
<span class="sourceLineNo">2381</span><a id="line.2381"></a>
<span class="sourceLineNo">2382</span><a id="line.2382">                        return new TryExpr(bodyExpr, catches, finallyExpr, retLocal,</a>
<span class="sourceLineNo">2383</span><a id="line.2383">                                           finallyLocal);</a>
<span class="sourceLineNo">2384</span><a id="line.2384">                }</a>
<span class="sourceLineNo">2385</span><a id="line.2385">        }</a>
<span class="sourceLineNo">2386</span><a id="line.2386">}</a>
<span class="sourceLineNo">2387</span><a id="line.2387"></a>
<span class="sourceLineNo">2388</span><a id="line.2388">//static class TryFinallyExpr implements Expr{</a>
<span class="sourceLineNo">2389</span><a id="line.2389">//      final Expr tryExpr;</a>
<span class="sourceLineNo">2390</span><a id="line.2390">//      final Expr finallyExpr;</a>
<span class="sourceLineNo">2391</span><a id="line.2391">//</a>
<span class="sourceLineNo">2392</span><a id="line.2392">//</a>
<span class="sourceLineNo">2393</span><a id="line.2393">//      public TryFinallyExpr(Expr tryExpr, Expr finallyExpr){</a>
<span class="sourceLineNo">2394</span><a id="line.2394">//              this.tryExpr = tryExpr;</a>
<span class="sourceLineNo">2395</span><a id="line.2395">//              this.finallyExpr = finallyExpr;</a>
<span class="sourceLineNo">2396</span><a id="line.2396">//      }</a>
<span class="sourceLineNo">2397</span><a id="line.2397">//</a>
<span class="sourceLineNo">2398</span><a id="line.2398">//      public Object eval() {</a>
<span class="sourceLineNo">2399</span><a id="line.2399">//              throw new UnsupportedOperationException("Can't eval try");</a>
<span class="sourceLineNo">2400</span><a id="line.2400">//      }</a>
<span class="sourceLineNo">2401</span><a id="line.2401">//</a>
<span class="sourceLineNo">2402</span><a id="line.2402">//      public void emit(C context, FnExpr fn, GeneratorAdapter gen){</a>
<span class="sourceLineNo">2403</span><a id="line.2403">//              Label startTry = gen.newLabel();</a>
<span class="sourceLineNo">2404</span><a id="line.2404">//              Label endTry = gen.newLabel();</a>
<span class="sourceLineNo">2405</span><a id="line.2405">//              Label end = gen.newLabel();</a>
<span class="sourceLineNo">2406</span><a id="line.2406">//              Label finallyLabel = gen.newLabel();</a>
<span class="sourceLineNo">2407</span><a id="line.2407">//              gen.visitTryCatchBlock(startTry, endTry, finallyLabel, null);</a>
<span class="sourceLineNo">2408</span><a id="line.2408">//              gen.mark(startTry);</a>
<span class="sourceLineNo">2409</span><a id="line.2409">//              tryExpr.emit(context, fn, gen);</a>
<span class="sourceLineNo">2410</span><a id="line.2410">//              gen.mark(endTry);</a>
<span class="sourceLineNo">2411</span><a id="line.2411">//              finallyExpr.emit(C.STATEMENT, fn, gen);</a>
<span class="sourceLineNo">2412</span><a id="line.2412">//              gen.goTo(end);</a>
<span class="sourceLineNo">2413</span><a id="line.2413">//              gen.mark(finallyLabel);</a>
<span class="sourceLineNo">2414</span><a id="line.2414">//              //exception should be on stack</a>
<span class="sourceLineNo">2415</span><a id="line.2415">//              finallyExpr.emit(C.STATEMENT, fn, gen);</a>
<span class="sourceLineNo">2416</span><a id="line.2416">//              gen.throwException();</a>
<span class="sourceLineNo">2417</span><a id="line.2417">//              gen.mark(end);</a>
<span class="sourceLineNo">2418</span><a id="line.2418">//      }</a>
<span class="sourceLineNo">2419</span><a id="line.2419">//</a>
<span class="sourceLineNo">2420</span><a id="line.2420">//      public boolean hasJavaClass() {</a>
<span class="sourceLineNo">2421</span><a id="line.2421">//              return tryExpr.hasJavaClass();</a>
<span class="sourceLineNo">2422</span><a id="line.2422">//      }</a>
<span class="sourceLineNo">2423</span><a id="line.2423">//</a>
<span class="sourceLineNo">2424</span><a id="line.2424">//      public Class getJavaClass() {</a>
<span class="sourceLineNo">2425</span><a id="line.2425">//              return tryExpr.getJavaClass();</a>
<span class="sourceLineNo">2426</span><a id="line.2426">//      }</a>
<span class="sourceLineNo">2427</span><a id="line.2427">//</a>
<span class="sourceLineNo">2428</span><a id="line.2428">//      static class Parser implements IParser{</a>
<span class="sourceLineNo">2429</span><a id="line.2429">//              public Expr parse(C context, Object frm) {</a>
<span class="sourceLineNo">2430</span><a id="line.2430">//                      ISeq form = (ISeq) frm;</a>
<span class="sourceLineNo">2431</span><a id="line.2431">//                      //(try-finally try-expr finally-expr)</a>
<span class="sourceLineNo">2432</span><a id="line.2432">//                      if(form.count() != 3)</a>
<span class="sourceLineNo">2433</span><a id="line.2433">//                              throw new IllegalArgumentException(</a>
<span class="sourceLineNo">2434</span><a id="line.2434">//                                              "Wrong number of arguments, expecting: (try-finally try-expr finally-expr) ");</a>
<span class="sourceLineNo">2435</span><a id="line.2435">//</a>
<span class="sourceLineNo">2436</span><a id="line.2436">//                      if(context == C.EVAL || context == C.EXPRESSION)</a>
<span class="sourceLineNo">2437</span><a id="line.2437">//                              return analyze(context, RT.list(RT.list(FN, PersistentVector.EMPTY, form)));</a>
<span class="sourceLineNo">2438</span><a id="line.2438">//</a>
<span class="sourceLineNo">2439</span><a id="line.2439">//                      return new TryFinallyExpr(analyze(context, RT.second(form)),</a>
<span class="sourceLineNo">2440</span><a id="line.2440">//                                                analyze(C.STATEMENT, RT.third(form)));</a>
<span class="sourceLineNo">2441</span><a id="line.2441">//              }</a>
<span class="sourceLineNo">2442</span><a id="line.2442">//      }</a>
<span class="sourceLineNo">2443</span><a id="line.2443">//}</a>
<span class="sourceLineNo">2444</span><a id="line.2444"></a>
<span class="sourceLineNo">2445</span><a id="line.2445">static class ThrowExpr extends UntypedExpr{</a>
<span class="sourceLineNo">2446</span><a id="line.2446">        public final Expr excExpr;</a>
<span class="sourceLineNo">2447</span><a id="line.2447"></a>
<span class="sourceLineNo">2448</span><a id="line.2448">        public ThrowExpr(Expr excExpr){</a>
<span class="sourceLineNo">2449</span><a id="line.2449">                this.excExpr = excExpr;</a>
<span class="sourceLineNo">2450</span><a id="line.2450">        }</a>
<span class="sourceLineNo">2451</span><a id="line.2451"></a>
<span class="sourceLineNo">2452</span><a id="line.2452"></a>
<span class="sourceLineNo">2453</span><a id="line.2453">        public Object eval() {</a>
<span class="sourceLineNo">2454</span><a id="line.2454">                throw Util.runtimeException("Can't eval throw");</a>
<span class="sourceLineNo">2455</span><a id="line.2455">        }</a>
<span class="sourceLineNo">2456</span><a id="line.2456"></a>
<span class="sourceLineNo">2457</span><a id="line.2457">        public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">2458</span><a id="line.2458">                excExpr.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">2459</span><a id="line.2459">                gen.checkCast(THROWABLE_TYPE);</a>
<span class="sourceLineNo">2460</span><a id="line.2460">                gen.throwException();</a>
<span class="sourceLineNo">2461</span><a id="line.2461">        }</a>
<span class="sourceLineNo">2462</span><a id="line.2462"></a>
<span class="sourceLineNo">2463</span><a id="line.2463">        static class Parser implements IParser{</a>
<span class="sourceLineNo">2464</span><a id="line.2464">                public Expr parse(C context, Object form) {</a>
<span class="sourceLineNo">2465</span><a id="line.2465">                        if(context == C.EVAL)</a>
<span class="sourceLineNo">2466</span><a id="line.2466">                                return analyze(context, RT.list(RT.list(FNONCE, PersistentVector.EMPTY, form)));</a>
<span class="sourceLineNo">2467</span><a id="line.2467">                        else if(RT.count(form) == 1)</a>
<span class="sourceLineNo">2468</span><a id="line.2468">                                throw Util.runtimeException("Too few arguments to throw, throw expects a single Throwable instance");</a>
<span class="sourceLineNo">2469</span><a id="line.2469">                        else if(RT.count(form) &gt; 2)</a>
<span class="sourceLineNo">2470</span><a id="line.2470">                                throw Util.runtimeException("Too many arguments to throw, throw expects a single Throwable instance");</a>
<span class="sourceLineNo">2471</span><a id="line.2471">                        return new ThrowExpr(analyze(C.EXPRESSION, RT.second(form)));</a>
<span class="sourceLineNo">2472</span><a id="line.2472">                }</a>
<span class="sourceLineNo">2473</span><a id="line.2473">        }</a>
<span class="sourceLineNo">2474</span><a id="line.2474">}</a>
<span class="sourceLineNo">2475</span><a id="line.2475"></a>
<span class="sourceLineNo">2476</span><a id="line.2476"></a>
<span class="sourceLineNo">2477</span><a id="line.2477">static public boolean subsumes(Class[] c1, Class[] c2){</a>
<span class="sourceLineNo">2478</span><a id="line.2478">        //presumes matching lengths</a>
<span class="sourceLineNo">2479</span><a id="line.2479">        Boolean better = false;</a>
<span class="sourceLineNo">2480</span><a id="line.2480">        for(int i = 0; i &lt; c1.length; i++)</a>
<span class="sourceLineNo">2481</span><a id="line.2481">                {</a>
<span class="sourceLineNo">2482</span><a id="line.2482">                if(c1[i] != c2[i])// || c2[i].isPrimitive() &amp;&amp; c1[i] == Object.class))</a>
<span class="sourceLineNo">2483</span><a id="line.2483">                        {</a>
<span class="sourceLineNo">2484</span><a id="line.2484">                        if(!c1[i].isPrimitive() &amp;&amp; c2[i].isPrimitive()</a>
<span class="sourceLineNo">2485</span><a id="line.2485">                           //|| Number.class.isAssignableFrom(c1[i]) &amp;&amp; c2[i].isPrimitive()</a>
<span class="sourceLineNo">2486</span><a id="line.2486">                           ||</a>
<span class="sourceLineNo">2487</span><a id="line.2487">                           c2[i].isAssignableFrom(c1[i]))</a>
<span class="sourceLineNo">2488</span><a id="line.2488">                                better = true;</a>
<span class="sourceLineNo">2489</span><a id="line.2489">                        else</a>
<span class="sourceLineNo">2490</span><a id="line.2490">                                return false;</a>
<span class="sourceLineNo">2491</span><a id="line.2491">                        }</a>
<span class="sourceLineNo">2492</span><a id="line.2492">                }</a>
<span class="sourceLineNo">2493</span><a id="line.2493">        return better;</a>
<span class="sourceLineNo">2494</span><a id="line.2494">}</a>
<span class="sourceLineNo">2495</span><a id="line.2495"></a>
<span class="sourceLineNo">2496</span><a id="line.2496">static String getTypeStringForArgs(IPersistentVector args){</a>
<span class="sourceLineNo">2497</span><a id="line.2497">        StringBuilder sb = new StringBuilder();</a>
<span class="sourceLineNo">2498</span><a id="line.2498">        for(int i = 0; i &lt; args.count(); i++)</a>
<span class="sourceLineNo">2499</span><a id="line.2499">                {</a>
<span class="sourceLineNo">2500</span><a id="line.2500">                Expr arg = (Expr) args.nth(i);</a>
<span class="sourceLineNo">2501</span><a id="line.2501">                if (i &gt; 0) sb.append(", ");</a>
<span class="sourceLineNo">2502</span><a id="line.2502">                sb.append((arg.hasJavaClass() &amp;&amp; arg.getJavaClass() != null) ? arg.getJavaClass().getName() : "unknown");</a>
<span class="sourceLineNo">2503</span><a id="line.2503">                }</a>
<span class="sourceLineNo">2504</span><a id="line.2504">        return sb.toString();</a>
<span class="sourceLineNo">2505</span><a id="line.2505">}</a>
<span class="sourceLineNo">2506</span><a id="line.2506"></a>
<span class="sourceLineNo">2507</span><a id="line.2507">static int getMatchingParams(String methodName, ArrayList&lt;Class[]&gt; paramlists, IPersistentVector argexprs,</a>
<span class="sourceLineNo">2508</span><a id="line.2508">                             List&lt;Class&gt; rets)</a>
<span class="sourceLineNo">2509</span><a id="line.2509">                {</a>
<span class="sourceLineNo">2510</span><a id="line.2510">        //presumes matching lengths</a>
<span class="sourceLineNo">2511</span><a id="line.2511">        int matchIdx = -1;</a>
<span class="sourceLineNo">2512</span><a id="line.2512">        boolean tied = false;</a>
<span class="sourceLineNo">2513</span><a id="line.2513">    boolean foundExact = false;</a>
<span class="sourceLineNo">2514</span><a id="line.2514">        for(int i = 0; i &lt; paramlists.size(); i++)</a>
<span class="sourceLineNo">2515</span><a id="line.2515">                {</a>
<span class="sourceLineNo">2516</span><a id="line.2516">                boolean match = true;</a>
<span class="sourceLineNo">2517</span><a id="line.2517">                ISeq aseq = argexprs.seq();</a>
<span class="sourceLineNo">2518</span><a id="line.2518">                int exact = 0;</a>
<span class="sourceLineNo">2519</span><a id="line.2519">                for(int p = 0; match &amp;&amp; p &lt; argexprs.count() &amp;&amp; aseq != null; ++p, aseq = aseq.next())</a>
<span class="sourceLineNo">2520</span><a id="line.2520">                        {</a>
<span class="sourceLineNo">2521</span><a id="line.2521">                        Expr arg = (Expr) aseq.first();</a>
<span class="sourceLineNo">2522</span><a id="line.2522">                        Class aclass = arg.hasJavaClass() ? arg.getJavaClass() : Object.class;</a>
<span class="sourceLineNo">2523</span><a id="line.2523">                        Class pclass = paramlists.get(i)[p];</a>
<span class="sourceLineNo">2524</span><a id="line.2524">                        if(arg.hasJavaClass() &amp;&amp; aclass == pclass)</a>
<span class="sourceLineNo">2525</span><a id="line.2525">                                exact++;</a>
<span class="sourceLineNo">2526</span><a id="line.2526">                        else</a>
<span class="sourceLineNo">2527</span><a id="line.2527">                                match = Reflector.paramArgTypeMatch(pclass, aclass);</a>
<span class="sourceLineNo">2528</span><a id="line.2528">                        }</a>
<span class="sourceLineNo">2529</span><a id="line.2529">                if(exact == argexprs.count())</a>
<span class="sourceLineNo">2530</span><a id="line.2530">            {</a>
<span class="sourceLineNo">2531</span><a id="line.2531">            if(!foundExact || matchIdx == -1 || rets.get(matchIdx).isAssignableFrom(rets.get(i)))</a>
<span class="sourceLineNo">2532</span><a id="line.2532">                matchIdx = i;</a>
<span class="sourceLineNo">2533</span><a id="line.2533">            tied = false;</a>
<span class="sourceLineNo">2534</span><a id="line.2534">            foundExact = true;</a>
<span class="sourceLineNo">2535</span><a id="line.2535">            }</a>
<span class="sourceLineNo">2536</span><a id="line.2536">                else if(match &amp;&amp; !foundExact)</a>
<span class="sourceLineNo">2537</span><a id="line.2537">                        {</a>
<span class="sourceLineNo">2538</span><a id="line.2538">                        if(matchIdx == -1)</a>
<span class="sourceLineNo">2539</span><a id="line.2539">                                matchIdx = i;</a>
<span class="sourceLineNo">2540</span><a id="line.2540">                        else</a>
<span class="sourceLineNo">2541</span><a id="line.2541">                                {</a>
<span class="sourceLineNo">2542</span><a id="line.2542">                                if(subsumes(paramlists.get(i), paramlists.get(matchIdx)))</a>
<span class="sourceLineNo">2543</span><a id="line.2543">                                        {</a>
<span class="sourceLineNo">2544</span><a id="line.2544">                                        matchIdx = i;</a>
<span class="sourceLineNo">2545</span><a id="line.2545">                                        tied = false;</a>
<span class="sourceLineNo">2546</span><a id="line.2546">                                        }</a>
<span class="sourceLineNo">2547</span><a id="line.2547">                                else if(Arrays.equals(paramlists.get(matchIdx), paramlists.get(i)))</a>
<span class="sourceLineNo">2548</span><a id="line.2548">                                        {</a>
<span class="sourceLineNo">2549</span><a id="line.2549">                                        if(rets.get(matchIdx).isAssignableFrom(rets.get(i)))</a>
<span class="sourceLineNo">2550</span><a id="line.2550">                                                matchIdx = i;</a>
<span class="sourceLineNo">2551</span><a id="line.2551">                                        }</a>
<span class="sourceLineNo">2552</span><a id="line.2552">                                else if(!(subsumes(paramlists.get(matchIdx), paramlists.get(i))))</a>
<span class="sourceLineNo">2553</span><a id="line.2553">                                                tied = true;</a>
<span class="sourceLineNo">2554</span><a id="line.2554">                                }</a>
<span class="sourceLineNo">2555</span><a id="line.2555">                        }</a>
<span class="sourceLineNo">2556</span><a id="line.2556">                }</a>
<span class="sourceLineNo">2557</span><a id="line.2557">        if(tied)</a>
<span class="sourceLineNo">2558</span><a id="line.2558">                throw new IllegalArgumentException("More than one matching method found: " + methodName);</a>
<span class="sourceLineNo">2559</span><a id="line.2559"></a>
<span class="sourceLineNo">2560</span><a id="line.2560">        return matchIdx;</a>
<span class="sourceLineNo">2561</span><a id="line.2561">}</a>
<span class="sourceLineNo">2562</span><a id="line.2562"></a>
<span class="sourceLineNo">2563</span><a id="line.2563">public static class NewExpr implements Expr{</a>
<span class="sourceLineNo">2564</span><a id="line.2564">        public final IPersistentVector args;</a>
<span class="sourceLineNo">2565</span><a id="line.2565">        public final Constructor ctor;</a>
<span class="sourceLineNo">2566</span><a id="line.2566">        public final Class c;</a>
<span class="sourceLineNo">2567</span><a id="line.2567">        final static Method invokeConstructorMethod =</a>
<span class="sourceLineNo">2568</span><a id="line.2568">                        Method.getMethod("Object invokeConstructor(Class,Object[])");</a>
<span class="sourceLineNo">2569</span><a id="line.2569">        final static Method forNameMethod = Method.getMethod("Class classForName(String)");</a>
<span class="sourceLineNo">2570</span><a id="line.2570"></a>
<span class="sourceLineNo">2571</span><a id="line.2571"></a>
<span class="sourceLineNo">2572</span><a id="line.2572">        public NewExpr(Class c, IPersistentVector args, int line, int column) {</a>
<span class="sourceLineNo">2573</span><a id="line.2573">                this.args = args;</a>
<span class="sourceLineNo">2574</span><a id="line.2574">                this.c = c;</a>
<span class="sourceLineNo">2575</span><a id="line.2575">                Constructor[] allctors = c.getConstructors();</a>
<span class="sourceLineNo">2576</span><a id="line.2576">                ArrayList ctors = new ArrayList();</a>
<span class="sourceLineNo">2577</span><a id="line.2577">                ArrayList&lt;Class[]&gt; params = new ArrayList();</a>
<span class="sourceLineNo">2578</span><a id="line.2578">                ArrayList&lt;Class&gt; rets = new ArrayList();</a>
<span class="sourceLineNo">2579</span><a id="line.2579">                for(int i = 0; i &lt; allctors.length; i++)</a>
<span class="sourceLineNo">2580</span><a id="line.2580">                        {</a>
<span class="sourceLineNo">2581</span><a id="line.2581">                        Constructor ctor = allctors[i];</a>
<span class="sourceLineNo">2582</span><a id="line.2582">                        if(ctor.getParameterTypes().length == args.count())</a>
<span class="sourceLineNo">2583</span><a id="line.2583">                                {</a>
<span class="sourceLineNo">2584</span><a id="line.2584">                                ctors.add(ctor);</a>
<span class="sourceLineNo">2585</span><a id="line.2585">                                params.add(ctor.getParameterTypes());</a>
<span class="sourceLineNo">2586</span><a id="line.2586">                                rets.add(c);</a>
<span class="sourceLineNo">2587</span><a id="line.2587">                                }</a>
<span class="sourceLineNo">2588</span><a id="line.2588">                        }</a>
<span class="sourceLineNo">2589</span><a id="line.2589">                if(ctors.isEmpty())</a>
<span class="sourceLineNo">2590</span><a id="line.2590">                        throw new IllegalArgumentException("No matching ctor found for " + c);</a>
<span class="sourceLineNo">2591</span><a id="line.2591"></a>
<span class="sourceLineNo">2592</span><a id="line.2592">                int ctoridx = 0;</a>
<span class="sourceLineNo">2593</span><a id="line.2593">                if(ctors.size() &gt; 1)</a>
<span class="sourceLineNo">2594</span><a id="line.2594">                        {</a>
<span class="sourceLineNo">2595</span><a id="line.2595">                        ctoridx = getMatchingParams(c.getName(), params, args, rets);</a>
<span class="sourceLineNo">2596</span><a id="line.2596">                        }</a>
<span class="sourceLineNo">2597</span><a id="line.2597"></a>
<span class="sourceLineNo">2598</span><a id="line.2598">                this.ctor = ctoridx &gt;= 0 ? (Constructor) ctors.get(ctoridx) : null;</a>
<span class="sourceLineNo">2599</span><a id="line.2599">                if(ctor == null &amp;&amp; RT.booleanCast(RT.WARN_ON_REFLECTION.deref()))</a>
<span class="sourceLineNo">2600</span><a id="line.2600">                        {</a>
<span class="sourceLineNo">2601</span><a id="line.2601">                        RT.errPrintWriter()</a>
<span class="sourceLineNo">2602</span><a id="line.2602">              .format("Reflection warning, %s:%d:%d - call to %s ctor can't be resolved.\n",</a>
<span class="sourceLineNo">2603</span><a id="line.2603">                      SOURCE_PATH.deref(), line, column, c.getName());</a>
<span class="sourceLineNo">2604</span><a id="line.2604">                        }</a>
<span class="sourceLineNo">2605</span><a id="line.2605">        }</a>
<span class="sourceLineNo">2606</span><a id="line.2606"></a>
<span class="sourceLineNo">2607</span><a id="line.2607">        public Object eval() {</a>
<span class="sourceLineNo">2608</span><a id="line.2608">                Object[] argvals = new Object[args.count()];</a>
<span class="sourceLineNo">2609</span><a id="line.2609">                for(int i = 0; i &lt; args.count(); i++)</a>
<span class="sourceLineNo">2610</span><a id="line.2610">                        argvals[i] = ((Expr) args.nth(i)).eval();</a>
<span class="sourceLineNo">2611</span><a id="line.2611">                if(this.ctor != null)</a>
<span class="sourceLineNo">2612</span><a id="line.2612">                        {</a>
<span class="sourceLineNo">2613</span><a id="line.2613">                        try</a>
<span class="sourceLineNo">2614</span><a id="line.2614">                                {</a>
<span class="sourceLineNo">2615</span><a id="line.2615">                                return ctor.newInstance(Reflector.boxArgs(ctor.getParameterTypes(), argvals));</a>
<span class="sourceLineNo">2616</span><a id="line.2616">                                }</a>
<span class="sourceLineNo">2617</span><a id="line.2617">                        catch(Exception e)</a>
<span class="sourceLineNo">2618</span><a id="line.2618">                                {</a>
<span class="sourceLineNo">2619</span><a id="line.2619">                                throw Util.sneakyThrow(e);</a>
<span class="sourceLineNo">2620</span><a id="line.2620">                                }</a>
<span class="sourceLineNo">2621</span><a id="line.2621">                        }</a>
<span class="sourceLineNo">2622</span><a id="line.2622">                return Reflector.invokeConstructor(c, argvals);</a>
<span class="sourceLineNo">2623</span><a id="line.2623">        }</a>
<span class="sourceLineNo">2624</span><a id="line.2624"></a>
<span class="sourceLineNo">2625</span><a id="line.2625">        public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">2626</span><a id="line.2626">                if(this.ctor != null)</a>
<span class="sourceLineNo">2627</span><a id="line.2627">                        {</a>
<span class="sourceLineNo">2628</span><a id="line.2628">                        Type type = getType(c);</a>
<span class="sourceLineNo">2629</span><a id="line.2629">                        gen.newInstance(type);</a>
<span class="sourceLineNo">2630</span><a id="line.2630">                        gen.dup();</a>
<span class="sourceLineNo">2631</span><a id="line.2631">                        MethodExpr.emitTypedArgs(objx, gen, ctor.getParameterTypes(), args);</a>
<span class="sourceLineNo">2632</span><a id="line.2632">                        gen.invokeConstructor(type, new Method("&lt;init&gt;", Type.getConstructorDescriptor(ctor)));</a>
<span class="sourceLineNo">2633</span><a id="line.2633">                        }</a>
<span class="sourceLineNo">2634</span><a id="line.2634">                else</a>
<span class="sourceLineNo">2635</span><a id="line.2635">                        {</a>
<span class="sourceLineNo">2636</span><a id="line.2636">                        gen.push(destubClassName(c.getName()));</a>
<span class="sourceLineNo">2637</span><a id="line.2637">                        gen.invokeStatic(RT_TYPE, forNameMethod);</a>
<span class="sourceLineNo">2638</span><a id="line.2638">                        MethodExpr.emitArgsAsArray(args, objx, gen);</a>
<span class="sourceLineNo">2639</span><a id="line.2639">                        gen.invokeStatic(REFLECTOR_TYPE, invokeConstructorMethod);</a>
<span class="sourceLineNo">2640</span><a id="line.2640">                        }</a>
<span class="sourceLineNo">2641</span><a id="line.2641">                if(context == C.STATEMENT)</a>
<span class="sourceLineNo">2642</span><a id="line.2642">                        gen.pop();</a>
<span class="sourceLineNo">2643</span><a id="line.2643">        }</a>
<span class="sourceLineNo">2644</span><a id="line.2644"></a>
<span class="sourceLineNo">2645</span><a id="line.2645">        public boolean hasJavaClass(){</a>
<span class="sourceLineNo">2646</span><a id="line.2646">                return true;</a>
<span class="sourceLineNo">2647</span><a id="line.2647">        }</a>
<span class="sourceLineNo">2648</span><a id="line.2648"></a>
<span class="sourceLineNo">2649</span><a id="line.2649">        public Class getJavaClass() {</a>
<span class="sourceLineNo">2650</span><a id="line.2650">                return c;</a>
<span class="sourceLineNo">2651</span><a id="line.2651">        }</a>
<span class="sourceLineNo">2652</span><a id="line.2652"></a>
<span class="sourceLineNo">2653</span><a id="line.2653">        static class Parser implements IParser{</a>
<span class="sourceLineNo">2654</span><a id="line.2654">                public Expr parse(C context, Object frm) {</a>
<span class="sourceLineNo">2655</span><a id="line.2655">                        int line = lineDeref();</a>
<span class="sourceLineNo">2656</span><a id="line.2656">                        int column = columnDeref();</a>
<span class="sourceLineNo">2657</span><a id="line.2657">                        ISeq form = (ISeq) frm;</a>
<span class="sourceLineNo">2658</span><a id="line.2658">                        //(new Classname args...)</a>
<span class="sourceLineNo">2659</span><a id="line.2659">                        if(form.count() &lt; 2)</a>
<span class="sourceLineNo">2660</span><a id="line.2660">                                throw Util.runtimeException("wrong number of arguments, expecting: (new Classname args...)");</a>
<span class="sourceLineNo">2661</span><a id="line.2661">                        Class c = HostExpr.maybeClass(RT.second(form), false);</a>
<span class="sourceLineNo">2662</span><a id="line.2662">                        if(c == null)</a>
<span class="sourceLineNo">2663</span><a id="line.2663">                                throw new IllegalArgumentException("Unable to resolve classname: " + RT.second(form));</a>
<span class="sourceLineNo">2664</span><a id="line.2664">                        PersistentVector args = PersistentVector.EMPTY;</a>
<span class="sourceLineNo">2665</span><a id="line.2665">                        for(ISeq s = RT.next(RT.next(form)); s != null; s = s.next())</a>
<span class="sourceLineNo">2666</span><a id="line.2666">                                args = args.cons(analyze(context == C.EVAL ? context : C.EXPRESSION, s.first()));</a>
<span class="sourceLineNo">2667</span><a id="line.2667">                        return new NewExpr(c, args, line, column);</a>
<span class="sourceLineNo">2668</span><a id="line.2668">                }</a>
<span class="sourceLineNo">2669</span><a id="line.2669">        }</a>
<span class="sourceLineNo">2670</span><a id="line.2670"></a>
<span class="sourceLineNo">2671</span><a id="line.2671">}</a>
<span class="sourceLineNo">2672</span><a id="line.2672"></a>
<span class="sourceLineNo">2673</span><a id="line.2673">public static class MetaExpr implements Expr{</a>
<span class="sourceLineNo">2674</span><a id="line.2674">        public final Expr expr;</a>
<span class="sourceLineNo">2675</span><a id="line.2675">        public final Expr meta;</a>
<span class="sourceLineNo">2676</span><a id="line.2676">        final static Type IOBJ_TYPE = Type.getType(IObj.class);</a>
<span class="sourceLineNo">2677</span><a id="line.2677">        final static Method withMetaMethod = Method.getMethod("clojure.lang.IObj withMeta(clojure.lang.IPersistentMap)");</a>
<span class="sourceLineNo">2678</span><a id="line.2678"></a>
<span class="sourceLineNo">2679</span><a id="line.2679"></a>
<span class="sourceLineNo">2680</span><a id="line.2680">        public MetaExpr(Expr expr, Expr meta){</a>
<span class="sourceLineNo">2681</span><a id="line.2681">                this.expr = expr;</a>
<span class="sourceLineNo">2682</span><a id="line.2682">                this.meta = meta;</a>
<span class="sourceLineNo">2683</span><a id="line.2683">        }</a>
<span class="sourceLineNo">2684</span><a id="line.2684"></a>
<span class="sourceLineNo">2685</span><a id="line.2685">        public Object eval() {</a>
<span class="sourceLineNo">2686</span><a id="line.2686">                return ((IObj) expr.eval()).withMeta((IPersistentMap) meta.eval());</a>
<span class="sourceLineNo">2687</span><a id="line.2687">        }</a>
<span class="sourceLineNo">2688</span><a id="line.2688"></a>
<span class="sourceLineNo">2689</span><a id="line.2689">        public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">2690</span><a id="line.2690">                expr.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">2691</span><a id="line.2691">                gen.checkCast(IOBJ_TYPE);</a>
<span class="sourceLineNo">2692</span><a id="line.2692">                meta.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">2693</span><a id="line.2693">                gen.checkCast(IPERSISTENTMAP_TYPE);</a>
<span class="sourceLineNo">2694</span><a id="line.2694">                gen.invokeInterface(IOBJ_TYPE, withMetaMethod);</a>
<span class="sourceLineNo">2695</span><a id="line.2695">                if(context == C.STATEMENT)</a>
<span class="sourceLineNo">2696</span><a id="line.2696">                        {</a>
<span class="sourceLineNo">2697</span><a id="line.2697">                        gen.pop();</a>
<span class="sourceLineNo">2698</span><a id="line.2698">                        }</a>
<span class="sourceLineNo">2699</span><a id="line.2699">        }</a>
<span class="sourceLineNo">2700</span><a id="line.2700"></a>
<span class="sourceLineNo">2701</span><a id="line.2701">        public boolean hasJavaClass() {</a>
<span class="sourceLineNo">2702</span><a id="line.2702">                return expr.hasJavaClass();</a>
<span class="sourceLineNo">2703</span><a id="line.2703">        }</a>
<span class="sourceLineNo">2704</span><a id="line.2704"></a>
<span class="sourceLineNo">2705</span><a id="line.2705">        public Class getJavaClass() {</a>
<span class="sourceLineNo">2706</span><a id="line.2706">                return expr.getJavaClass();</a>
<span class="sourceLineNo">2707</span><a id="line.2707">        }</a>
<span class="sourceLineNo">2708</span><a id="line.2708">}</a>
<span class="sourceLineNo">2709</span><a id="line.2709"></a>
<span class="sourceLineNo">2710</span><a id="line.2710">public static class IfExpr implements Expr, MaybePrimitiveExpr{</a>
<span class="sourceLineNo">2711</span><a id="line.2711">        public final Expr testExpr;</a>
<span class="sourceLineNo">2712</span><a id="line.2712">        public final Expr thenExpr;</a>
<span class="sourceLineNo">2713</span><a id="line.2713">        public final Expr elseExpr;</a>
<span class="sourceLineNo">2714</span><a id="line.2714">        public final int line;</a>
<span class="sourceLineNo">2715</span><a id="line.2715">        public final int column;</a>
<span class="sourceLineNo">2716</span><a id="line.2716"></a>
<span class="sourceLineNo">2717</span><a id="line.2717"></a>
<span class="sourceLineNo">2718</span><a id="line.2718">        public IfExpr(int line, int column, Expr testExpr, Expr thenExpr, Expr elseExpr){</a>
<span class="sourceLineNo">2719</span><a id="line.2719">                this.testExpr = testExpr;</a>
<span class="sourceLineNo">2720</span><a id="line.2720">                this.thenExpr = thenExpr;</a>
<span class="sourceLineNo">2721</span><a id="line.2721">                this.elseExpr = elseExpr;</a>
<span class="sourceLineNo">2722</span><a id="line.2722">                this.line = line;</a>
<span class="sourceLineNo">2723</span><a id="line.2723">                this.column = column;</a>
<span class="sourceLineNo">2724</span><a id="line.2724">        }</a>
<span class="sourceLineNo">2725</span><a id="line.2725"></a>
<span class="sourceLineNo">2726</span><a id="line.2726">        public Object eval() {</a>
<span class="sourceLineNo">2727</span><a id="line.2727">                Object t = testExpr.eval();</a>
<span class="sourceLineNo">2728</span><a id="line.2728">                if(t != null &amp;&amp; t != Boolean.FALSE)</a>
<span class="sourceLineNo">2729</span><a id="line.2729">                        return thenExpr.eval();</a>
<span class="sourceLineNo">2730</span><a id="line.2730">                return elseExpr.eval();</a>
<span class="sourceLineNo">2731</span><a id="line.2731">        }</a>
<span class="sourceLineNo">2732</span><a id="line.2732"></a>
<span class="sourceLineNo">2733</span><a id="line.2733">        public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">2734</span><a id="line.2734">                doEmit(context, objx, gen,false);</a>
<span class="sourceLineNo">2735</span><a id="line.2735">        }</a>
<span class="sourceLineNo">2736</span><a id="line.2736"></a>
<span class="sourceLineNo">2737</span><a id="line.2737">        public void emitUnboxed(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">2738</span><a id="line.2738">                doEmit(context, objx, gen, true);</a>
<span class="sourceLineNo">2739</span><a id="line.2739">        }</a>
<span class="sourceLineNo">2740</span><a id="line.2740"></a>
<span class="sourceLineNo">2741</span><a id="line.2741">        public void doEmit(C context, ObjExpr objx, GeneratorAdapter gen, boolean emitUnboxed){</a>
<span class="sourceLineNo">2742</span><a id="line.2742">                Label nullLabel = gen.newLabel();</a>
<span class="sourceLineNo">2743</span><a id="line.2743">                Label falseLabel = gen.newLabel();</a>
<span class="sourceLineNo">2744</span><a id="line.2744">                Label endLabel = gen.newLabel();</a>
<span class="sourceLineNo">2745</span><a id="line.2745"></a>
<span class="sourceLineNo">2746</span><a id="line.2746">                gen.visitLineNumber(line, gen.mark());</a>
<span class="sourceLineNo">2747</span><a id="line.2747"></a>
<span class="sourceLineNo">2748</span><a id="line.2748">                if(testExpr instanceof StaticMethodExpr &amp;&amp; ((StaticMethodExpr)testExpr).canEmitIntrinsicPredicate())</a>
<span class="sourceLineNo">2749</span><a id="line.2749">                        {</a>
<span class="sourceLineNo">2750</span><a id="line.2750">                        ((StaticMethodExpr) testExpr).emitIntrinsicPredicate(C.EXPRESSION, objx, gen, falseLabel);</a>
<span class="sourceLineNo">2751</span><a id="line.2751">                        }</a>
<span class="sourceLineNo">2752</span><a id="line.2752">                else if(maybePrimitiveType(testExpr) == boolean.class)</a>
<span class="sourceLineNo">2753</span><a id="line.2753">                        {</a>
<span class="sourceLineNo">2754</span><a id="line.2754">                        ((MaybePrimitiveExpr) testExpr).emitUnboxed(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">2755</span><a id="line.2755">                        gen.ifZCmp(gen.EQ, falseLabel);</a>
<span class="sourceLineNo">2756</span><a id="line.2756">                        }</a>
<span class="sourceLineNo">2757</span><a id="line.2757">                else</a>
<span class="sourceLineNo">2758</span><a id="line.2758">                        {</a>
<span class="sourceLineNo">2759</span><a id="line.2759">                        testExpr.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">2760</span><a id="line.2760">                        gen.dup();</a>
<span class="sourceLineNo">2761</span><a id="line.2761">                        gen.ifNull(nullLabel);</a>
<span class="sourceLineNo">2762</span><a id="line.2762">                        gen.getStatic(BOOLEAN_OBJECT_TYPE, "FALSE", BOOLEAN_OBJECT_TYPE);</a>
<span class="sourceLineNo">2763</span><a id="line.2763">                        gen.visitJumpInsn(IF_ACMPEQ, falseLabel);</a>
<span class="sourceLineNo">2764</span><a id="line.2764">                        }</a>
<span class="sourceLineNo">2765</span><a id="line.2765">                if(emitUnboxed)</a>
<span class="sourceLineNo">2766</span><a id="line.2766">                        ((MaybePrimitiveExpr)thenExpr).emitUnboxed(context, objx, gen);</a>
<span class="sourceLineNo">2767</span><a id="line.2767">                else</a>
<span class="sourceLineNo">2768</span><a id="line.2768">                        thenExpr.emit(context, objx, gen);</a>
<span class="sourceLineNo">2769</span><a id="line.2769">                gen.goTo(endLabel);</a>
<span class="sourceLineNo">2770</span><a id="line.2770">                gen.mark(nullLabel);</a>
<span class="sourceLineNo">2771</span><a id="line.2771">                gen.pop();</a>
<span class="sourceLineNo">2772</span><a id="line.2772">                gen.mark(falseLabel);</a>
<span class="sourceLineNo">2773</span><a id="line.2773">                if(emitUnboxed)</a>
<span class="sourceLineNo">2774</span><a id="line.2774">                        ((MaybePrimitiveExpr)elseExpr).emitUnboxed(context, objx, gen);</a>
<span class="sourceLineNo">2775</span><a id="line.2775">                else</a>
<span class="sourceLineNo">2776</span><a id="line.2776">                        elseExpr.emit(context, objx, gen);</a>
<span class="sourceLineNo">2777</span><a id="line.2777">                gen.mark(endLabel);</a>
<span class="sourceLineNo">2778</span><a id="line.2778">        }</a>
<span class="sourceLineNo">2779</span><a id="line.2779"></a>
<span class="sourceLineNo">2780</span><a id="line.2780">        public boolean hasJavaClass() {</a>
<span class="sourceLineNo">2781</span><a id="line.2781">                return thenExpr.hasJavaClass()</a>
<span class="sourceLineNo">2782</span><a id="line.2782">                       &amp;&amp; elseExpr.hasJavaClass()</a>
<span class="sourceLineNo">2783</span><a id="line.2783">                       &amp;&amp;</a>
<span class="sourceLineNo">2784</span><a id="line.2784">                       (thenExpr.getJavaClass() == elseExpr.getJavaClass()</a>
<span class="sourceLineNo">2785</span><a id="line.2785">                        || thenExpr.getJavaClass() == RECUR_CLASS</a>
<span class="sourceLineNo">2786</span><a id="line.2786">                                || elseExpr.getJavaClass() == RECUR_CLASS                       </a>
<span class="sourceLineNo">2787</span><a id="line.2787">                        || (thenExpr.getJavaClass() == null &amp;&amp; !elseExpr.getJavaClass().isPrimitive())</a>
<span class="sourceLineNo">2788</span><a id="line.2788">                        || (elseExpr.getJavaClass() == null &amp;&amp; !thenExpr.getJavaClass().isPrimitive()));</a>
<span class="sourceLineNo">2789</span><a id="line.2789">        }</a>
<span class="sourceLineNo">2790</span><a id="line.2790"></a>
<span class="sourceLineNo">2791</span><a id="line.2791">        public boolean canEmitPrimitive(){</a>
<span class="sourceLineNo">2792</span><a id="line.2792">                try</a>
<span class="sourceLineNo">2793</span><a id="line.2793">                        {</a>
<span class="sourceLineNo">2794</span><a id="line.2794">                        return thenExpr instanceof MaybePrimitiveExpr</a>
<span class="sourceLineNo">2795</span><a id="line.2795">                               &amp;&amp; elseExpr instanceof MaybePrimitiveExpr</a>
<span class="sourceLineNo">2796</span><a id="line.2796">                               &amp;&amp; (thenExpr.getJavaClass() == elseExpr.getJavaClass()</a>
<span class="sourceLineNo">2797</span><a id="line.2797">                                   || thenExpr.getJavaClass() == RECUR_CLASS</a>
<span class="sourceLineNo">2798</span><a id="line.2798">                                   || elseExpr.getJavaClass() == RECUR_CLASS)</a>
<span class="sourceLineNo">2799</span><a id="line.2799">                               &amp;&amp; ((MaybePrimitiveExpr)thenExpr).canEmitPrimitive()</a>
<span class="sourceLineNo">2800</span><a id="line.2800">                                   &amp;&amp; ((MaybePrimitiveExpr)elseExpr).canEmitPrimitive();</a>
<span class="sourceLineNo">2801</span><a id="line.2801">                        }</a>
<span class="sourceLineNo">2802</span><a id="line.2802">                catch(Exception e)</a>
<span class="sourceLineNo">2803</span><a id="line.2803">                        {</a>
<span class="sourceLineNo">2804</span><a id="line.2804">                        return false;</a>
<span class="sourceLineNo">2805</span><a id="line.2805">                        }</a>
<span class="sourceLineNo">2806</span><a id="line.2806">        }</a>
<span class="sourceLineNo">2807</span><a id="line.2807"></a>
<span class="sourceLineNo">2808</span><a id="line.2808">        public Class getJavaClass() {</a>
<span class="sourceLineNo">2809</span><a id="line.2809">                Class thenClass = thenExpr.getJavaClass();</a>
<span class="sourceLineNo">2810</span><a id="line.2810">                if(thenClass != null &amp;&amp; thenClass != RECUR_CLASS)</a>
<span class="sourceLineNo">2811</span><a id="line.2811">                        return thenClass;</a>
<span class="sourceLineNo">2812</span><a id="line.2812">                return elseExpr.getJavaClass();</a>
<span class="sourceLineNo">2813</span><a id="line.2813">        }</a>
<span class="sourceLineNo">2814</span><a id="line.2814"></a>
<span class="sourceLineNo">2815</span><a id="line.2815">        static class Parser implements IParser{</a>
<span class="sourceLineNo">2816</span><a id="line.2816">                public Expr parse(C context, Object frm) {</a>
<span class="sourceLineNo">2817</span><a id="line.2817">                        ISeq form = (ISeq) frm;</a>
<span class="sourceLineNo">2818</span><a id="line.2818">                        //(if test then) or (if test then else)</a>
<span class="sourceLineNo">2819</span><a id="line.2819">                        if(form.count() &gt; 4)</a>
<span class="sourceLineNo">2820</span><a id="line.2820">                                throw Util.runtimeException("Too many arguments to if");</a>
<span class="sourceLineNo">2821</span><a id="line.2821">                        else if(form.count() &lt; 3)</a>
<span class="sourceLineNo">2822</span><a id="line.2822">                                throw Util.runtimeException("Too few arguments to if");</a>
<span class="sourceLineNo">2823</span><a id="line.2823">            PathNode branch = new PathNode(PATHTYPE.BRANCH, (PathNode) CLEAR_PATH.get());</a>
<span class="sourceLineNo">2824</span><a id="line.2824">            Expr testexpr = analyze(context == C.EVAL ? context : C.EXPRESSION, RT.second(form));</a>
<span class="sourceLineNo">2825</span><a id="line.2825">            Expr thenexpr, elseexpr;</a>
<span class="sourceLineNo">2826</span><a id="line.2826">            try {</a>
<span class="sourceLineNo">2827</span><a id="line.2827">                Var.pushThreadBindings(</a>
<span class="sourceLineNo">2828</span><a id="line.2828">                        RT.map(CLEAR_PATH, new PathNode(PATHTYPE.PATH,branch)));</a>
<span class="sourceLineNo">2829</span><a id="line.2829">                thenexpr = analyze(context, RT.third(form));</a>
<span class="sourceLineNo">2830</span><a id="line.2830">                }</a>
<span class="sourceLineNo">2831</span><a id="line.2831">            finally{</a>
<span class="sourceLineNo">2832</span><a id="line.2832">                Var.popThreadBindings();</a>
<span class="sourceLineNo">2833</span><a id="line.2833">                }</a>
<span class="sourceLineNo">2834</span><a id="line.2834">            try {</a>
<span class="sourceLineNo">2835</span><a id="line.2835">                Var.pushThreadBindings(</a>
<span class="sourceLineNo">2836</span><a id="line.2836">                        RT.map(CLEAR_PATH, new PathNode(PATHTYPE.PATH,branch)));</a>
<span class="sourceLineNo">2837</span><a id="line.2837">                elseexpr = analyze(context, RT.fourth(form));</a>
<span class="sourceLineNo">2838</span><a id="line.2838">                }</a>
<span class="sourceLineNo">2839</span><a id="line.2839">            finally{</a>
<span class="sourceLineNo">2840</span><a id="line.2840">                Var.popThreadBindings();</a>
<span class="sourceLineNo">2841</span><a id="line.2841">                }</a>
<span class="sourceLineNo">2842</span><a id="line.2842">                        return new IfExpr(lineDeref(),</a>
<span class="sourceLineNo">2843</span><a id="line.2843">                              columnDeref(),</a>
<span class="sourceLineNo">2844</span><a id="line.2844">                                          testexpr,</a>
<span class="sourceLineNo">2845</span><a id="line.2845">                                          thenexpr,</a>
<span class="sourceLineNo">2846</span><a id="line.2846">                                          elseexpr);</a>
<span class="sourceLineNo">2847</span><a id="line.2847">                }</a>
<span class="sourceLineNo">2848</span><a id="line.2848">        }</a>
<span class="sourceLineNo">2849</span><a id="line.2849">}</a>
<span class="sourceLineNo">2850</span><a id="line.2850"></a>
<span class="sourceLineNo">2851</span><a id="line.2851">static final public IPersistentMap CHAR_MAP =</a>
<span class="sourceLineNo">2852</span><a id="line.2852">                PersistentHashMap.create('-', "_",</a>
<span class="sourceLineNo">2853</span><a id="line.2853">//                                       '.', "_DOT_",</a>
<span class="sourceLineNo">2854</span><a id="line.2854">':', "_COLON_",</a>
<span class="sourceLineNo">2855</span><a id="line.2855">'+', "_PLUS_",</a>
<span class="sourceLineNo">2856</span><a id="line.2856">'&gt;', "_GT_",</a>
<span class="sourceLineNo">2857</span><a id="line.2857">'&lt;', "_LT_",</a>
<span class="sourceLineNo">2858</span><a id="line.2858">'=', "_EQ_",</a>
<span class="sourceLineNo">2859</span><a id="line.2859">'~', "_TILDE_",</a>
<span class="sourceLineNo">2860</span><a id="line.2860">'!', "_BANG_",</a>
<span class="sourceLineNo">2861</span><a id="line.2861">'@', "_CIRCA_",</a>
<span class="sourceLineNo">2862</span><a id="line.2862">'#', "_SHARP_",</a>
<span class="sourceLineNo">2863</span><a id="line.2863">'\'', "_SINGLEQUOTE_",</a>
<span class="sourceLineNo">2864</span><a id="line.2864">'"', "_DOUBLEQUOTE_",</a>
<span class="sourceLineNo">2865</span><a id="line.2865">'%', "_PERCENT_",</a>
<span class="sourceLineNo">2866</span><a id="line.2866">'^', "_CARET_",</a>
<span class="sourceLineNo">2867</span><a id="line.2867">'&amp;', "_AMPERSAND_",</a>
<span class="sourceLineNo">2868</span><a id="line.2868">'*', "_STAR_",</a>
<span class="sourceLineNo">2869</span><a id="line.2869">'|', "_BAR_",</a>
<span class="sourceLineNo">2870</span><a id="line.2870">'{', "_LBRACE_",</a>
<span class="sourceLineNo">2871</span><a id="line.2871">'}', "_RBRACE_",</a>
<span class="sourceLineNo">2872</span><a id="line.2872">'[', "_LBRACK_",</a>
<span class="sourceLineNo">2873</span><a id="line.2873">']', "_RBRACK_",</a>
<span class="sourceLineNo">2874</span><a id="line.2874">'/', "_SLASH_",</a>
<span class="sourceLineNo">2875</span><a id="line.2875">'\\', "_BSLASH_",</a>
<span class="sourceLineNo">2876</span><a id="line.2876">'?', "_QMARK_");</a>
<span class="sourceLineNo">2877</span><a id="line.2877"></a>
<span class="sourceLineNo">2878</span><a id="line.2878">static final public IPersistentMap DEMUNGE_MAP;</a>
<span class="sourceLineNo">2879</span><a id="line.2879">static final public Pattern DEMUNGE_PATTERN;</a>
<span class="sourceLineNo">2880</span><a id="line.2880"></a>
<span class="sourceLineNo">2881</span><a id="line.2881">static {</a>
<span class="sourceLineNo">2882</span><a id="line.2882">        // DEMUNGE_MAP maps strings to characters in the opposite</a>
<span class="sourceLineNo">2883</span><a id="line.2883">        // direction that CHAR_MAP does, plus it maps "$" to '/'</a>
<span class="sourceLineNo">2884</span><a id="line.2884">        IPersistentMap m = RT.map("$", '/');</a>
<span class="sourceLineNo">2885</span><a id="line.2885">        for(ISeq s = RT.seq(CHAR_MAP); s != null; s = s.next())</a>
<span class="sourceLineNo">2886</span><a id="line.2886">                {</a>
<span class="sourceLineNo">2887</span><a id="line.2887">                IMapEntry e = (IMapEntry) s.first();</a>
<span class="sourceLineNo">2888</span><a id="line.2888">                Character origCh = (Character) e.key();</a>
<span class="sourceLineNo">2889</span><a id="line.2889">                String escapeStr = (String) e.val();</a>
<span class="sourceLineNo">2890</span><a id="line.2890">                m = m.assoc(escapeStr, origCh);</a>
<span class="sourceLineNo">2891</span><a id="line.2891">                }</a>
<span class="sourceLineNo">2892</span><a id="line.2892">        DEMUNGE_MAP = m;</a>
<span class="sourceLineNo">2893</span><a id="line.2893"></a>
<span class="sourceLineNo">2894</span><a id="line.2894">        // DEMUNGE_PATTERN searches for the first of any occurrence of</a>
<span class="sourceLineNo">2895</span><a id="line.2895">        // the strings that are keys of DEMUNGE_MAP.</a>
<span class="sourceLineNo">2896</span><a id="line.2896">        // Note: Regex matching rules mean that #"_|_COLON_" "_COLON_"</a>
<span class="sourceLineNo">2897</span><a id="line.2897">       // returns "_", but #"_COLON_|_" "_COLON_" returns "_COLON_"</a>
<span class="sourceLineNo">2898</span><a id="line.2898">       // as desired.  Sorting string keys of DEMUNGE_MAP from longest to</a>
<span class="sourceLineNo">2899</span><a id="line.2899">       // shortest ensures correct matching behavior, even if some strings are</a>
<span class="sourceLineNo">2900</span><a id="line.2900">        // prefixes of others.</a>
<span class="sourceLineNo">2901</span><a id="line.2901">        Object[] mungeStrs = RT.toArray(RT.keys(m));</a>
<span class="sourceLineNo">2902</span><a id="line.2902">        Arrays.sort(mungeStrs, new Comparator() {</a>
<span class="sourceLineNo">2903</span><a id="line.2903">                public int compare(Object s1, Object s2) {</a>
<span class="sourceLineNo">2904</span><a id="line.2904">                    return ((String) s2).length() - ((String) s1).length();</a>
<span class="sourceLineNo">2905</span><a id="line.2905">                }});</a>
<span class="sourceLineNo">2906</span><a id="line.2906">        StringBuilder sb = new StringBuilder();</a>
<span class="sourceLineNo">2907</span><a id="line.2907">        boolean first = true;</a>
<span class="sourceLineNo">2908</span><a id="line.2908">        for(Object s : mungeStrs)</a>
<span class="sourceLineNo">2909</span><a id="line.2909">                {</a>
<span class="sourceLineNo">2910</span><a id="line.2910">                String escapeStr = (String) s;</a>
<span class="sourceLineNo">2911</span><a id="line.2911">                if (!first)</a>
<span class="sourceLineNo">2912</span><a id="line.2912">                        sb.append("|");</a>
<span class="sourceLineNo">2913</span><a id="line.2913">                first = false;</a>
<span class="sourceLineNo">2914</span><a id="line.2914">                sb.append("\\Q");</a>
<span class="sourceLineNo">2915</span><a id="line.2915">                sb.append(escapeStr);</a>
<span class="sourceLineNo">2916</span><a id="line.2916">                sb.append("\\E");</a>
<span class="sourceLineNo">2917</span><a id="line.2917">                }</a>
<span class="sourceLineNo">2918</span><a id="line.2918">        DEMUNGE_PATTERN = Pattern.compile(sb.toString());</a>
<span class="sourceLineNo">2919</span><a id="line.2919">}</a>
<span class="sourceLineNo">2920</span><a id="line.2920"></a>
<span class="sourceLineNo">2921</span><a id="line.2921">static public String munge(String name){</a>
<span class="sourceLineNo">2922</span><a id="line.2922">        StringBuilder sb = new StringBuilder();</a>
<span class="sourceLineNo">2923</span><a id="line.2923">        for(char c : name.toCharArray())</a>
<span class="sourceLineNo">2924</span><a id="line.2924">                {</a>
<span class="sourceLineNo">2925</span><a id="line.2925">                String sub = (String) CHAR_MAP.valAt(c);</a>
<span class="sourceLineNo">2926</span><a id="line.2926">                if(sub != null)</a>
<span class="sourceLineNo">2927</span><a id="line.2927">                        sb.append(sub);</a>
<span class="sourceLineNo">2928</span><a id="line.2928">                else</a>
<span class="sourceLineNo">2929</span><a id="line.2929">                        sb.append(c);</a>
<span class="sourceLineNo">2930</span><a id="line.2930">                }</a>
<span class="sourceLineNo">2931</span><a id="line.2931">        return sb.toString();</a>
<span class="sourceLineNo">2932</span><a id="line.2932">}</a>
<span class="sourceLineNo">2933</span><a id="line.2933"></a>
<span class="sourceLineNo">2934</span><a id="line.2934">static public String demunge(String mungedName){</a>
<span class="sourceLineNo">2935</span><a id="line.2935">        StringBuilder sb = new StringBuilder();</a>
<span class="sourceLineNo">2936</span><a id="line.2936">        Matcher m = DEMUNGE_PATTERN.matcher(mungedName);</a>
<span class="sourceLineNo">2937</span><a id="line.2937">        int lastMatchEnd = 0;</a>
<span class="sourceLineNo">2938</span><a id="line.2938">        while (m.find())</a>
<span class="sourceLineNo">2939</span><a id="line.2939">                {</a>
<span class="sourceLineNo">2940</span><a id="line.2940">                int start = m.start();</a>
<span class="sourceLineNo">2941</span><a id="line.2941">                int end = m.end();</a>
<span class="sourceLineNo">2942</span><a id="line.2942">                // Keep everything before the match</a>
<span class="sourceLineNo">2943</span><a id="line.2943">                sb.append(mungedName.substring(lastMatchEnd, start));</a>
<span class="sourceLineNo">2944</span><a id="line.2944">                lastMatchEnd = end;</a>
<span class="sourceLineNo">2945</span><a id="line.2945">                // Replace the match with DEMUNGE_MAP result</a>
<span class="sourceLineNo">2946</span><a id="line.2946">                Character origCh = (Character) DEMUNGE_MAP.valAt(m.group());</a>
<span class="sourceLineNo">2947</span><a id="line.2947">                sb.append(origCh);</a>
<span class="sourceLineNo">2948</span><a id="line.2948">                }</a>
<span class="sourceLineNo">2949</span><a id="line.2949">        // Keep everything after the last match</a>
<span class="sourceLineNo">2950</span><a id="line.2950">        sb.append(mungedName.substring(lastMatchEnd));</a>
<span class="sourceLineNo">2951</span><a id="line.2951">        return sb.toString();</a>
<span class="sourceLineNo">2952</span><a id="line.2952">}</a>
<span class="sourceLineNo">2953</span><a id="line.2953"></a>
<span class="sourceLineNo">2954</span><a id="line.2954">public static class EmptyExpr implements Expr{</a>
<span class="sourceLineNo">2955</span><a id="line.2955">        public final Object coll;</a>
<span class="sourceLineNo">2956</span><a id="line.2956">        final static Type HASHMAP_TYPE = Type.getType(PersistentArrayMap.class);</a>
<span class="sourceLineNo">2957</span><a id="line.2957">        final static Type HASHSET_TYPE = Type.getType(PersistentHashSet.class);</a>
<span class="sourceLineNo">2958</span><a id="line.2958">        final static Type VECTOR_TYPE = Type.getType(PersistentVector.class);</a>
<span class="sourceLineNo">2959</span><a id="line.2959">    final static Type IVECTOR_TYPE = Type.getType(IPersistentVector.class);</a>
<span class="sourceLineNo">2960</span><a id="line.2960">    final static Type TUPLE_TYPE = Type.getType(Tuple.class);</a>
<span class="sourceLineNo">2961</span><a id="line.2961">        final static Type LIST_TYPE = Type.getType(PersistentList.class);</a>
<span class="sourceLineNo">2962</span><a id="line.2962">        final static Type EMPTY_LIST_TYPE = Type.getType(PersistentList.EmptyList.class);</a>
<span class="sourceLineNo">2963</span><a id="line.2963"></a>
<span class="sourceLineNo">2964</span><a id="line.2964"></a>
<span class="sourceLineNo">2965</span><a id="line.2965">        public EmptyExpr(Object coll){</a>
<span class="sourceLineNo">2966</span><a id="line.2966">                this.coll = coll;</a>
<span class="sourceLineNo">2967</span><a id="line.2967">        }</a>
<span class="sourceLineNo">2968</span><a id="line.2968"></a>
<span class="sourceLineNo">2969</span><a id="line.2969">        public Object eval() {</a>
<span class="sourceLineNo">2970</span><a id="line.2970">                return coll;</a>
<span class="sourceLineNo">2971</span><a id="line.2971">        }</a>
<span class="sourceLineNo">2972</span><a id="line.2972"></a>
<span class="sourceLineNo">2973</span><a id="line.2973">        public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">2974</span><a id="line.2974">                if(coll instanceof IPersistentList)</a>
<span class="sourceLineNo">2975</span><a id="line.2975">                        gen.getStatic(LIST_TYPE, "EMPTY", EMPTY_LIST_TYPE);</a>
<span class="sourceLineNo">2976</span><a id="line.2976">                else if(coll instanceof IPersistentVector)</a>
<span class="sourceLineNo">2977</span><a id="line.2977">                        gen.getStatic(VECTOR_TYPE, "EMPTY", VECTOR_TYPE);</a>
<span class="sourceLineNo">2978</span><a id="line.2978">                else if(coll instanceof IPersistentMap)</a>
<span class="sourceLineNo">2979</span><a id="line.2979">                                gen.getStatic(HASHMAP_TYPE, "EMPTY", HASHMAP_TYPE);</a>
<span class="sourceLineNo">2980</span><a id="line.2980">                        else if(coll instanceof IPersistentSet)</a>
<span class="sourceLineNo">2981</span><a id="line.2981">                                        gen.getStatic(HASHSET_TYPE, "EMPTY", HASHSET_TYPE);</a>
<span class="sourceLineNo">2982</span><a id="line.2982">                                else</a>
<span class="sourceLineNo">2983</span><a id="line.2983">                                        throw new UnsupportedOperationException("Unknown Collection type");</a>
<span class="sourceLineNo">2984</span><a id="line.2984">                if(context == C.STATEMENT)</a>
<span class="sourceLineNo">2985</span><a id="line.2985">                        {</a>
<span class="sourceLineNo">2986</span><a id="line.2986">                        gen.pop();</a>
<span class="sourceLineNo">2987</span><a id="line.2987">                        }</a>
<span class="sourceLineNo">2988</span><a id="line.2988">        }</a>
<span class="sourceLineNo">2989</span><a id="line.2989"></a>
<span class="sourceLineNo">2990</span><a id="line.2990">        public boolean hasJavaClass() {</a>
<span class="sourceLineNo">2991</span><a id="line.2991">                return true;</a>
<span class="sourceLineNo">2992</span><a id="line.2992">        }</a>
<span class="sourceLineNo">2993</span><a id="line.2993"></a>
<span class="sourceLineNo">2994</span><a id="line.2994">        public Class getJavaClass() {</a>
<span class="sourceLineNo">2995</span><a id="line.2995">                if(coll instanceof IPersistentList)</a>
<span class="sourceLineNo">2996</span><a id="line.2996">                        return IPersistentList.class;</a>
<span class="sourceLineNo">2997</span><a id="line.2997">                else if(coll instanceof IPersistentVector)</a>
<span class="sourceLineNo">2998</span><a id="line.2998">                        return IPersistentVector.class;</a>
<span class="sourceLineNo">2999</span><a id="line.2999">                else if(coll instanceof IPersistentMap)</a>
<span class="sourceLineNo">3000</span><a id="line.3000">                                return IPersistentMap.class;</a>
<span class="sourceLineNo">3001</span><a id="line.3001">                        else if(coll instanceof IPersistentSet)</a>
<span class="sourceLineNo">3002</span><a id="line.3002">                                        return IPersistentSet.class;</a>
<span class="sourceLineNo">3003</span><a id="line.3003">                                else</a>
<span class="sourceLineNo">3004</span><a id="line.3004">                                        throw new UnsupportedOperationException("Unknown Collection type");</a>
<span class="sourceLineNo">3005</span><a id="line.3005">        }</a>
<span class="sourceLineNo">3006</span><a id="line.3006">}</a>
<span class="sourceLineNo">3007</span><a id="line.3007"></a>
<span class="sourceLineNo">3008</span><a id="line.3008">public static class ListExpr implements Expr{</a>
<span class="sourceLineNo">3009</span><a id="line.3009">        public final IPersistentVector args;</a>
<span class="sourceLineNo">3010</span><a id="line.3010">        final static Method arrayToListMethod = Method.getMethod("clojure.lang.ISeq arrayToList(Object[])");</a>
<span class="sourceLineNo">3011</span><a id="line.3011"></a>
<span class="sourceLineNo">3012</span><a id="line.3012"></a>
<span class="sourceLineNo">3013</span><a id="line.3013">        public ListExpr(IPersistentVector args){</a>
<span class="sourceLineNo">3014</span><a id="line.3014">                this.args = args;</a>
<span class="sourceLineNo">3015</span><a id="line.3015">        }</a>
<span class="sourceLineNo">3016</span><a id="line.3016"></a>
<span class="sourceLineNo">3017</span><a id="line.3017">        public Object eval() {</a>
<span class="sourceLineNo">3018</span><a id="line.3018">                IPersistentVector ret = PersistentVector.EMPTY;</a>
<span class="sourceLineNo">3019</span><a id="line.3019">                for(int i = 0; i &lt; args.count(); i++)</a>
<span class="sourceLineNo">3020</span><a id="line.3020">                        ret = (IPersistentVector) ret.cons(((Expr) args.nth(i)).eval());</a>
<span class="sourceLineNo">3021</span><a id="line.3021">                return ret.seq();</a>
<span class="sourceLineNo">3022</span><a id="line.3022">        }</a>
<span class="sourceLineNo">3023</span><a id="line.3023"></a>
<span class="sourceLineNo">3024</span><a id="line.3024">        public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">3025</span><a id="line.3025">                MethodExpr.emitArgsAsArray(args, objx, gen);</a>
<span class="sourceLineNo">3026</span><a id="line.3026">                gen.invokeStatic(RT_TYPE, arrayToListMethod);</a>
<span class="sourceLineNo">3027</span><a id="line.3027">                if(context == C.STATEMENT)</a>
<span class="sourceLineNo">3028</span><a id="line.3028">                        gen.pop();</a>
<span class="sourceLineNo">3029</span><a id="line.3029">        }</a>
<span class="sourceLineNo">3030</span><a id="line.3030"></a>
<span class="sourceLineNo">3031</span><a id="line.3031">        public boolean hasJavaClass() {</a>
<span class="sourceLineNo">3032</span><a id="line.3032">                return true;</a>
<span class="sourceLineNo">3033</span><a id="line.3033">        }</a>
<span class="sourceLineNo">3034</span><a id="line.3034"></a>
<span class="sourceLineNo">3035</span><a id="line.3035">        public Class getJavaClass() {</a>
<span class="sourceLineNo">3036</span><a id="line.3036">                return IPersistentList.class;</a>
<span class="sourceLineNo">3037</span><a id="line.3037">        }</a>
<span class="sourceLineNo">3038</span><a id="line.3038"></a>
<span class="sourceLineNo">3039</span><a id="line.3039">}</a>
<span class="sourceLineNo">3040</span><a id="line.3040"></a>
<span class="sourceLineNo">3041</span><a id="line.3041">public static class MapExpr implements Expr{</a>
<span class="sourceLineNo">3042</span><a id="line.3042">        public final IPersistentVector keyvals;</a>
<span class="sourceLineNo">3043</span><a id="line.3043">        final static Method mapMethod = Method.getMethod("clojure.lang.IPersistentMap map(Object[])");</a>
<span class="sourceLineNo">3044</span><a id="line.3044">        final static Method mapUniqueKeysMethod = Method.getMethod("clojure.lang.IPersistentMap mapUniqueKeys(Object[])");</a>
<span class="sourceLineNo">3045</span><a id="line.3045"></a>
<span class="sourceLineNo">3046</span><a id="line.3046"></a>
<span class="sourceLineNo">3047</span><a id="line.3047">        public MapExpr(IPersistentVector keyvals){</a>
<span class="sourceLineNo">3048</span><a id="line.3048">                this.keyvals = keyvals;</a>
<span class="sourceLineNo">3049</span><a id="line.3049">        }</a>
<span class="sourceLineNo">3050</span><a id="line.3050"></a>
<span class="sourceLineNo">3051</span><a id="line.3051">        public Object eval() {</a>
<span class="sourceLineNo">3052</span><a id="line.3052">                Object[] ret = new Object[keyvals.count()];</a>
<span class="sourceLineNo">3053</span><a id="line.3053">                for(int i = 0; i &lt; keyvals.count(); i++)</a>
<span class="sourceLineNo">3054</span><a id="line.3054">                        ret[i] = ((Expr) keyvals.nth(i)).eval();</a>
<span class="sourceLineNo">3055</span><a id="line.3055">                return RT.map(ret);</a>
<span class="sourceLineNo">3056</span><a id="line.3056">        }</a>
<span class="sourceLineNo">3057</span><a id="line.3057"></a>
<span class="sourceLineNo">3058</span><a id="line.3058">        public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">3059</span><a id="line.3059">                boolean allKeysConstant = true;</a>
<span class="sourceLineNo">3060</span><a id="line.3060">                boolean allConstantKeysUnique = true;</a>
<span class="sourceLineNo">3061</span><a id="line.3061">                IPersistentSet constantKeys = PersistentHashSet.EMPTY;</a>
<span class="sourceLineNo">3062</span><a id="line.3062">                for(int i = 0; i &lt; keyvals.count(); i+=2)</a>
<span class="sourceLineNo">3063</span><a id="line.3063">                        {</a>
<span class="sourceLineNo">3064</span><a id="line.3064">                        Expr k = (Expr) keyvals.nth(i);</a>
<span class="sourceLineNo">3065</span><a id="line.3065">                        if(k instanceof LiteralExpr)</a>
<span class="sourceLineNo">3066</span><a id="line.3066">                                {</a>
<span class="sourceLineNo">3067</span><a id="line.3067">                                Object kval = k.eval();</a>
<span class="sourceLineNo">3068</span><a id="line.3068">                                if (constantKeys.contains(kval))</a>
<span class="sourceLineNo">3069</span><a id="line.3069">                                        allConstantKeysUnique = false;</a>
<span class="sourceLineNo">3070</span><a id="line.3070">                                else</a>
<span class="sourceLineNo">3071</span><a id="line.3071">                                        constantKeys = (IPersistentSet)constantKeys.cons(kval);</a>
<span class="sourceLineNo">3072</span><a id="line.3072">                                }</a>
<span class="sourceLineNo">3073</span><a id="line.3073">                        else</a>
<span class="sourceLineNo">3074</span><a id="line.3074">                                allKeysConstant = false;</a>
<span class="sourceLineNo">3075</span><a id="line.3075">                        }</a>
<span class="sourceLineNo">3076</span><a id="line.3076">                MethodExpr.emitArgsAsArray(keyvals, objx, gen);</a>
<span class="sourceLineNo">3077</span><a id="line.3077">                if((allKeysConstant &amp;&amp; allConstantKeysUnique) || (keyvals.count() &lt;= 2))</a>
<span class="sourceLineNo">3078</span><a id="line.3078">                        gen.invokeStatic(RT_TYPE, mapUniqueKeysMethod);</a>
<span class="sourceLineNo">3079</span><a id="line.3079">                else</a>
<span class="sourceLineNo">3080</span><a id="line.3080">                        gen.invokeStatic(RT_TYPE, mapMethod);</a>
<span class="sourceLineNo">3081</span><a id="line.3081">                if(context == C.STATEMENT)</a>
<span class="sourceLineNo">3082</span><a id="line.3082">                        gen.pop();</a>
<span class="sourceLineNo">3083</span><a id="line.3083">        }</a>
<span class="sourceLineNo">3084</span><a id="line.3084"></a>
<span class="sourceLineNo">3085</span><a id="line.3085">        public boolean hasJavaClass() {</a>
<span class="sourceLineNo">3086</span><a id="line.3086">                return true;</a>
<span class="sourceLineNo">3087</span><a id="line.3087">        }</a>
<span class="sourceLineNo">3088</span><a id="line.3088"></a>
<span class="sourceLineNo">3089</span><a id="line.3089">        public Class getJavaClass() {</a>
<span class="sourceLineNo">3090</span><a id="line.3090">                return IPersistentMap.class;</a>
<span class="sourceLineNo">3091</span><a id="line.3091">        }</a>
<span class="sourceLineNo">3092</span><a id="line.3092"></a>
<span class="sourceLineNo">3093</span><a id="line.3093"></a>
<span class="sourceLineNo">3094</span><a id="line.3094">        static public Expr parse(C context, IPersistentMap form) {</a>
<span class="sourceLineNo">3095</span><a id="line.3095">                IPersistentVector keyvals = PersistentVector.EMPTY;</a>
<span class="sourceLineNo">3096</span><a id="line.3096">                boolean keysConstant = true;</a>
<span class="sourceLineNo">3097</span><a id="line.3097">                boolean valsConstant = true;</a>
<span class="sourceLineNo">3098</span><a id="line.3098">                boolean allConstantKeysUnique = true;</a>
<span class="sourceLineNo">3099</span><a id="line.3099">                IPersistentSet constantKeys = PersistentHashSet.EMPTY;</a>
<span class="sourceLineNo">3100</span><a id="line.3100">                for(ISeq s = RT.seq(form); s != null; s = s.next())</a>
<span class="sourceLineNo">3101</span><a id="line.3101">                        {</a>
<span class="sourceLineNo">3102</span><a id="line.3102">                        IMapEntry e = (IMapEntry) s.first();</a>
<span class="sourceLineNo">3103</span><a id="line.3103">                        Expr k = analyze(context == C.EVAL ? context : C.EXPRESSION, e.key());</a>
<span class="sourceLineNo">3104</span><a id="line.3104">                        Expr v = analyze(context == C.EVAL ? context : C.EXPRESSION, e.val());</a>
<span class="sourceLineNo">3105</span><a id="line.3105">                        keyvals = (IPersistentVector) keyvals.cons(k);</a>
<span class="sourceLineNo">3106</span><a id="line.3106">                        keyvals = (IPersistentVector) keyvals.cons(v);</a>
<span class="sourceLineNo">3107</span><a id="line.3107">                        if(k instanceof LiteralExpr)</a>
<span class="sourceLineNo">3108</span><a id="line.3108">                                {</a>
<span class="sourceLineNo">3109</span><a id="line.3109">                                Object kval = k.eval();</a>
<span class="sourceLineNo">3110</span><a id="line.3110">                                if (constantKeys.contains(kval))</a>
<span class="sourceLineNo">3111</span><a id="line.3111">                                        allConstantKeysUnique = false;</a>
<span class="sourceLineNo">3112</span><a id="line.3112">                                else</a>
<span class="sourceLineNo">3113</span><a id="line.3113">                                        constantKeys = (IPersistentSet)constantKeys.cons(kval);</a>
<span class="sourceLineNo">3114</span><a id="line.3114">                                }</a>
<span class="sourceLineNo">3115</span><a id="line.3115">                        else</a>
<span class="sourceLineNo">3116</span><a id="line.3116">                                keysConstant = false;</a>
<span class="sourceLineNo">3117</span><a id="line.3117">                        if(!(v instanceof LiteralExpr))</a>
<span class="sourceLineNo">3118</span><a id="line.3118">                                valsConstant = false;</a>
<span class="sourceLineNo">3119</span><a id="line.3119">                        }</a>
<span class="sourceLineNo">3120</span><a id="line.3120"></a>
<span class="sourceLineNo">3121</span><a id="line.3121">                Expr ret = new MapExpr(keyvals);</a>
<span class="sourceLineNo">3122</span><a id="line.3122">                if(form instanceof IObj &amp;&amp; ((IObj) form).meta() != null)</a>
<span class="sourceLineNo">3123</span><a id="line.3123">                        return new MetaExpr(ret, MapExpr</a>
<span class="sourceLineNo">3124</span><a id="line.3124">                                        .parse(context == C.EVAL ? context : C.EXPRESSION, ((IObj) form).meta()));</a>
<span class="sourceLineNo">3125</span><a id="line.3125">                else if(keysConstant)</a>
<span class="sourceLineNo">3126</span><a id="line.3126">                        {</a>
<span class="sourceLineNo">3127</span><a id="line.3127">                        // TBD: Add more detail to exception thrown below.</a>
<span class="sourceLineNo">3128</span><a id="line.3128">                        if(!allConstantKeysUnique)</a>
<span class="sourceLineNo">3129</span><a id="line.3129">                                throw new IllegalArgumentException("Duplicate constant keys in map");</a>
<span class="sourceLineNo">3130</span><a id="line.3130">                        if(valsConstant)</a>
<span class="sourceLineNo">3131</span><a id="line.3131">                                {</a>
<span class="sourceLineNo">3132</span><a id="line.3132">                                IPersistentMap m = PersistentArrayMap.EMPTY;</a>
<span class="sourceLineNo">3133</span><a id="line.3133">                                for(int i=0;i&lt;keyvals.length();i+= 2)</a>
<span class="sourceLineNo">3134</span><a id="line.3134">                                        {</a>
<span class="sourceLineNo">3135</span><a id="line.3135">                                        m = m.assoc(((LiteralExpr)keyvals.nth(i)).val(), ((LiteralExpr)keyvals.nth(i+1)).val());</a>
<span class="sourceLineNo">3136</span><a id="line.3136">                                        }</a>
<span class="sourceLineNo">3137</span><a id="line.3137">//                              System.err.println("Constant: " + m);</a>
<span class="sourceLineNo">3138</span><a id="line.3138">                                return new ConstantExpr(m);</a>
<span class="sourceLineNo">3139</span><a id="line.3139">                                }</a>
<span class="sourceLineNo">3140</span><a id="line.3140">                        else</a>
<span class="sourceLineNo">3141</span><a id="line.3141">                                return ret;</a>
<span class="sourceLineNo">3142</span><a id="line.3142">                        }</a>
<span class="sourceLineNo">3143</span><a id="line.3143">                else</a>
<span class="sourceLineNo">3144</span><a id="line.3144">                        return ret;</a>
<span class="sourceLineNo">3145</span><a id="line.3145">        }</a>
<span class="sourceLineNo">3146</span><a id="line.3146">}</a>
<span class="sourceLineNo">3147</span><a id="line.3147"></a>
<span class="sourceLineNo">3148</span><a id="line.3148">public static class SetExpr implements Expr{</a>
<span class="sourceLineNo">3149</span><a id="line.3149">        public final IPersistentVector keys;</a>
<span class="sourceLineNo">3150</span><a id="line.3150">        final static Method setMethod = Method.getMethod("clojure.lang.IPersistentSet set(Object[])");</a>
<span class="sourceLineNo">3151</span><a id="line.3151"></a>
<span class="sourceLineNo">3152</span><a id="line.3152"></a>
<span class="sourceLineNo">3153</span><a id="line.3153">        public SetExpr(IPersistentVector keys){</a>
<span class="sourceLineNo">3154</span><a id="line.3154">                this.keys = keys;</a>
<span class="sourceLineNo">3155</span><a id="line.3155">        }</a>
<span class="sourceLineNo">3156</span><a id="line.3156"></a>
<span class="sourceLineNo">3157</span><a id="line.3157">        public Object eval() {</a>
<span class="sourceLineNo">3158</span><a id="line.3158">                Object[] ret = new Object[keys.count()];</a>
<span class="sourceLineNo">3159</span><a id="line.3159">                for(int i = 0; i &lt; keys.count(); i++)</a>
<span class="sourceLineNo">3160</span><a id="line.3160">                        ret[i] = ((Expr) keys.nth(i)).eval();</a>
<span class="sourceLineNo">3161</span><a id="line.3161">                return RT.set(ret);</a>
<span class="sourceLineNo">3162</span><a id="line.3162">        }</a>
<span class="sourceLineNo">3163</span><a id="line.3163"></a>
<span class="sourceLineNo">3164</span><a id="line.3164">        public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">3165</span><a id="line.3165">                MethodExpr.emitArgsAsArray(keys, objx, gen);</a>
<span class="sourceLineNo">3166</span><a id="line.3166">                gen.invokeStatic(RT_TYPE, setMethod);</a>
<span class="sourceLineNo">3167</span><a id="line.3167">                if(context == C.STATEMENT)</a>
<span class="sourceLineNo">3168</span><a id="line.3168">                        gen.pop();</a>
<span class="sourceLineNo">3169</span><a id="line.3169">        }</a>
<span class="sourceLineNo">3170</span><a id="line.3170"></a>
<span class="sourceLineNo">3171</span><a id="line.3171">        public boolean hasJavaClass() {</a>
<span class="sourceLineNo">3172</span><a id="line.3172">                return true;</a>
<span class="sourceLineNo">3173</span><a id="line.3173">        }</a>
<span class="sourceLineNo">3174</span><a id="line.3174"></a>
<span class="sourceLineNo">3175</span><a id="line.3175">        public Class getJavaClass() {</a>
<span class="sourceLineNo">3176</span><a id="line.3176">                return IPersistentSet.class;</a>
<span class="sourceLineNo">3177</span><a id="line.3177">        }</a>
<span class="sourceLineNo">3178</span><a id="line.3178"></a>
<span class="sourceLineNo">3179</span><a id="line.3179"></a>
<span class="sourceLineNo">3180</span><a id="line.3180">        static public Expr parse(C context, IPersistentSet form) {</a>
<span class="sourceLineNo">3181</span><a id="line.3181">                IPersistentVector keys = PersistentVector.EMPTY;</a>
<span class="sourceLineNo">3182</span><a id="line.3182">                boolean constant = true;</a>
<span class="sourceLineNo">3183</span><a id="line.3183"></a>
<span class="sourceLineNo">3184</span><a id="line.3184">                for(ISeq s = RT.seq(form); s != null; s = s.next())</a>
<span class="sourceLineNo">3185</span><a id="line.3185">                        {</a>
<span class="sourceLineNo">3186</span><a id="line.3186">                        Object e = s.first();</a>
<span class="sourceLineNo">3187</span><a id="line.3187">                        Expr expr = analyze(context == C.EVAL ? context : C.EXPRESSION, e);</a>
<span class="sourceLineNo">3188</span><a id="line.3188">                        keys = (IPersistentVector) keys.cons(expr);</a>
<span class="sourceLineNo">3189</span><a id="line.3189">                        if(!(expr instanceof LiteralExpr))</a>
<span class="sourceLineNo">3190</span><a id="line.3190">                                constant = false;</a>
<span class="sourceLineNo">3191</span><a id="line.3191">                        }</a>
<span class="sourceLineNo">3192</span><a id="line.3192">                Expr ret = new SetExpr(keys);</a>
<span class="sourceLineNo">3193</span><a id="line.3193">                if(form instanceof IObj &amp;&amp; ((IObj) form).meta() != null)</a>
<span class="sourceLineNo">3194</span><a id="line.3194">                        return new MetaExpr(ret, MapExpr</a>
<span class="sourceLineNo">3195</span><a id="line.3195">                                        .parse(context == C.EVAL ? context : C.EXPRESSION, ((IObj) form).meta()));</a>
<span class="sourceLineNo">3196</span><a id="line.3196">                else if(constant)</a>
<span class="sourceLineNo">3197</span><a id="line.3197">                        {</a>
<span class="sourceLineNo">3198</span><a id="line.3198">                        IPersistentSet set = PersistentHashSet.EMPTY;</a>
<span class="sourceLineNo">3199</span><a id="line.3199">                        for(int i=0;i&lt;keys.count();i++)</a>
<span class="sourceLineNo">3200</span><a id="line.3200">                                {</a>
<span class="sourceLineNo">3201</span><a id="line.3201">                                LiteralExpr ve = (LiteralExpr)keys.nth(i);</a>
<span class="sourceLineNo">3202</span><a id="line.3202">                                set = (IPersistentSet)set.cons(ve.val());</a>
<span class="sourceLineNo">3203</span><a id="line.3203">                                }</a>
<span class="sourceLineNo">3204</span><a id="line.3204">//                      System.err.println("Constant: " + set);</a>
<span class="sourceLineNo">3205</span><a id="line.3205">                        return new ConstantExpr(set);</a>
<span class="sourceLineNo">3206</span><a id="line.3206">                        }</a>
<span class="sourceLineNo">3207</span><a id="line.3207">                else</a>
<span class="sourceLineNo">3208</span><a id="line.3208">                        return ret;</a>
<span class="sourceLineNo">3209</span><a id="line.3209">        }</a>
<span class="sourceLineNo">3210</span><a id="line.3210">}</a>
<span class="sourceLineNo">3211</span><a id="line.3211"></a>
<span class="sourceLineNo">3212</span><a id="line.3212">public static class VectorExpr implements Expr{</a>
<span class="sourceLineNo">3213</span><a id="line.3213">        public final IPersistentVector args;</a>
<span class="sourceLineNo">3214</span><a id="line.3214">    final static Method vectorMethod = Method.getMethod("clojure.lang.IPersistentVector vector(Object[])");</a>
<span class="sourceLineNo">3215</span><a id="line.3215"></a>
<span class="sourceLineNo">3216</span><a id="line.3216">        public VectorExpr(IPersistentVector args){</a>
<span class="sourceLineNo">3217</span><a id="line.3217">                this.args = args;</a>
<span class="sourceLineNo">3218</span><a id="line.3218">        }</a>
<span class="sourceLineNo">3219</span><a id="line.3219"></a>
<span class="sourceLineNo">3220</span><a id="line.3220">        public Object eval() {</a>
<span class="sourceLineNo">3221</span><a id="line.3221">                IPersistentVector ret = PersistentVector.EMPTY;</a>
<span class="sourceLineNo">3222</span><a id="line.3222">                for(int i = 0; i &lt; args.count(); i++)</a>
<span class="sourceLineNo">3223</span><a id="line.3223">                        ret = (IPersistentVector) ret.cons(((Expr) args.nth(i)).eval());</a>
<span class="sourceLineNo">3224</span><a id="line.3224">                return ret;</a>
<span class="sourceLineNo">3225</span><a id="line.3225">        }</a>
<span class="sourceLineNo">3226</span><a id="line.3226"></a>
<span class="sourceLineNo">3227</span><a id="line.3227">        public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">3228</span><a id="line.3228">        if(args.count() &lt;= Tuple.MAX_SIZE)</a>
<span class="sourceLineNo">3229</span><a id="line.3229">            {</a>
<span class="sourceLineNo">3230</span><a id="line.3230">            for(int i = 0; i &lt; args.count(); i++) {</a>
<span class="sourceLineNo">3231</span><a id="line.3231">                        ((Expr) args.nth(i)).emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">3232</span><a id="line.3232">                        }</a>
<span class="sourceLineNo">3233</span><a id="line.3233">            gen.invokeStatic(TUPLE_TYPE, createTupleMethods[args.count()]);</a>
<span class="sourceLineNo">3234</span><a id="line.3234">            }</a>
<span class="sourceLineNo">3235</span><a id="line.3235"></a>
<span class="sourceLineNo">3236</span><a id="line.3236">        else</a>
<span class="sourceLineNo">3237</span><a id="line.3237">            {</a>
<span class="sourceLineNo">3238</span><a id="line.3238">            MethodExpr.emitArgsAsArray(args, objx, gen);</a>
<span class="sourceLineNo">3239</span><a id="line.3239">            gen.invokeStatic(RT_TYPE, vectorMethod);</a>
<span class="sourceLineNo">3240</span><a id="line.3240">            }</a>
<span class="sourceLineNo">3241</span><a id="line.3241"></a>
<span class="sourceLineNo">3242</span><a id="line.3242">        if(context == C.STATEMENT)</a>
<span class="sourceLineNo">3243</span><a id="line.3243">                        gen.pop();</a>
<span class="sourceLineNo">3244</span><a id="line.3244">        }</a>
<span class="sourceLineNo">3245</span><a id="line.3245"></a>
<span class="sourceLineNo">3246</span><a id="line.3246">        public boolean hasJavaClass() {</a>
<span class="sourceLineNo">3247</span><a id="line.3247">                return true;</a>
<span class="sourceLineNo">3248</span><a id="line.3248">        }</a>
<span class="sourceLineNo">3249</span><a id="line.3249"></a>
<span class="sourceLineNo">3250</span><a id="line.3250">        public Class getJavaClass() {</a>
<span class="sourceLineNo">3251</span><a id="line.3251">                return IPersistentVector.class;</a>
<span class="sourceLineNo">3252</span><a id="line.3252">        }</a>
<span class="sourceLineNo">3253</span><a id="line.3253"></a>
<span class="sourceLineNo">3254</span><a id="line.3254">        static public Expr parse(C context, IPersistentVector form) {</a>
<span class="sourceLineNo">3255</span><a id="line.3255">                boolean constant = true;</a>
<span class="sourceLineNo">3256</span><a id="line.3256"></a>
<span class="sourceLineNo">3257</span><a id="line.3257">                IPersistentVector args = PersistentVector.EMPTY;</a>
<span class="sourceLineNo">3258</span><a id="line.3258">                for(int i = 0; i &lt; form.count(); i++)</a>
<span class="sourceLineNo">3259</span><a id="line.3259">                        {</a>
<span class="sourceLineNo">3260</span><a id="line.3260">                        Expr v = analyze(context == C.EVAL ? context : C.EXPRESSION, form.nth(i));</a>
<span class="sourceLineNo">3261</span><a id="line.3261">                        args = (IPersistentVector) args.cons(v);</a>
<span class="sourceLineNo">3262</span><a id="line.3262">                        if(!(v instanceof LiteralExpr))</a>
<span class="sourceLineNo">3263</span><a id="line.3263">                                constant = false;</a>
<span class="sourceLineNo">3264</span><a id="line.3264">                        }</a>
<span class="sourceLineNo">3265</span><a id="line.3265">                Expr ret = new VectorExpr(args);</a>
<span class="sourceLineNo">3266</span><a id="line.3266">                if(form instanceof IObj &amp;&amp; ((IObj) form).meta() != null)</a>
<span class="sourceLineNo">3267</span><a id="line.3267">                        return new MetaExpr(ret, MapExpr</a>
<span class="sourceLineNo">3268</span><a id="line.3268">                                        .parse(context == C.EVAL ? context : C.EXPRESSION, ((IObj) form).meta()));</a>
<span class="sourceLineNo">3269</span><a id="line.3269">                else if (constant)</a>
<span class="sourceLineNo">3270</span><a id="line.3270">                        {</a>
<span class="sourceLineNo">3271</span><a id="line.3271">                        IPersistentVector rv = PersistentVector.EMPTY;</a>
<span class="sourceLineNo">3272</span><a id="line.3272">                        for(int i =0;i&lt;args.count();i++)</a>
<span class="sourceLineNo">3273</span><a id="line.3273">                                {</a>
<span class="sourceLineNo">3274</span><a id="line.3274">                                LiteralExpr ve = (LiteralExpr)args.nth(i);</a>
<span class="sourceLineNo">3275</span><a id="line.3275">                                rv = rv.cons(ve.val());</a>
<span class="sourceLineNo">3276</span><a id="line.3276">                                }</a>
<span class="sourceLineNo">3277</span><a id="line.3277">//                      System.err.println("Constant: " + rv);</a>
<span class="sourceLineNo">3278</span><a id="line.3278">                        return new ConstantExpr(rv);</a>
<span class="sourceLineNo">3279</span><a id="line.3279">                        }</a>
<span class="sourceLineNo">3280</span><a id="line.3280">                else</a>
<span class="sourceLineNo">3281</span><a id="line.3281">                        return ret;</a>
<span class="sourceLineNo">3282</span><a id="line.3282">        }</a>
<span class="sourceLineNo">3283</span><a id="line.3283"></a>
<span class="sourceLineNo">3284</span><a id="line.3284">}</a>
<span class="sourceLineNo">3285</span><a id="line.3285"></a>
<span class="sourceLineNo">3286</span><a id="line.3286">static class KeywordInvokeExpr implements Expr{</a>
<span class="sourceLineNo">3287</span><a id="line.3287">        public final KeywordExpr kw;</a>
<span class="sourceLineNo">3288</span><a id="line.3288">        public final Object tag;</a>
<span class="sourceLineNo">3289</span><a id="line.3289">        public final Expr target;</a>
<span class="sourceLineNo">3290</span><a id="line.3290">        public final int line;</a>
<span class="sourceLineNo">3291</span><a id="line.3291">        public final int column;</a>
<span class="sourceLineNo">3292</span><a id="line.3292">        public final int siteIndex;</a>
<span class="sourceLineNo">3293</span><a id="line.3293">        public final String source;</a>
<span class="sourceLineNo">3294</span><a id="line.3294">        static Type ILOOKUP_TYPE = Type.getType(ILookup.class);</a>
<span class="sourceLineNo">3295</span><a id="line.3295">    Class jc;</a>
<span class="sourceLineNo">3296</span><a id="line.3296"></a>
<span class="sourceLineNo">3297</span><a id="line.3297">        public KeywordInvokeExpr(String source, int line, int column, Symbol tag, KeywordExpr kw, Expr target){</a>
<span class="sourceLineNo">3298</span><a id="line.3298">                this.source = source;</a>
<span class="sourceLineNo">3299</span><a id="line.3299">                this.kw = kw;</a>
<span class="sourceLineNo">3300</span><a id="line.3300">                this.target = target;</a>
<span class="sourceLineNo">3301</span><a id="line.3301">                this.line = line;</a>
<span class="sourceLineNo">3302</span><a id="line.3302">                this.column = column;</a>
<span class="sourceLineNo">3303</span><a id="line.3303">                this.tag = tag;</a>
<span class="sourceLineNo">3304</span><a id="line.3304">                this.siteIndex = registerKeywordCallsite(kw.k);</a>
<span class="sourceLineNo">3305</span><a id="line.3305">        }</a>
<span class="sourceLineNo">3306</span><a id="line.3306"></a>
<span class="sourceLineNo">3307</span><a id="line.3307">        public Object eval() {</a>
<span class="sourceLineNo">3308</span><a id="line.3308">                try</a>
<span class="sourceLineNo">3309</span><a id="line.3309">                        {</a>
<span class="sourceLineNo">3310</span><a id="line.3310">                        return kw.k.invoke(target.eval());</a>
<span class="sourceLineNo">3311</span><a id="line.3311">                        }</a>
<span class="sourceLineNo">3312</span><a id="line.3312">                catch(Throwable e)</a>
<span class="sourceLineNo">3313</span><a id="line.3313">                        {</a>
<span class="sourceLineNo">3314</span><a id="line.3314">                        if(!(e instanceof CompilerException))</a>
<span class="sourceLineNo">3315</span><a id="line.3315">                                throw new CompilerException(source, line, column, e);</a>
<span class="sourceLineNo">3316</span><a id="line.3316">                        else</a>
<span class="sourceLineNo">3317</span><a id="line.3317">                                throw (CompilerException) e;</a>
<span class="sourceLineNo">3318</span><a id="line.3318">                        }</a>
<span class="sourceLineNo">3319</span><a id="line.3319">        }</a>
<span class="sourceLineNo">3320</span><a id="line.3320"></a>
<span class="sourceLineNo">3321</span><a id="line.3321">    public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">3322</span><a id="line.3322">        Label endLabel = gen.newLabel();</a>
<span class="sourceLineNo">3323</span><a id="line.3323">        Label faultLabel = gen.newLabel();</a>
<span class="sourceLineNo">3324</span><a id="line.3324"></a>
<span class="sourceLineNo">3325</span><a id="line.3325">        gen.visitLineNumber(line, gen.mark());</a>
<span class="sourceLineNo">3326</span><a id="line.3326">        gen.getStatic(objx.objtype, objx.thunkNameStatic(siteIndex),ObjExpr.ILOOKUP_THUNK_TYPE);</a>
<span class="sourceLineNo">3327</span><a id="line.3327">        gen.dup();  //thunk, thunk</a>
<span class="sourceLineNo">3328</span><a id="line.3328">        target.emit(C.EXPRESSION, objx, gen); //thunk,thunk,target</a>
<span class="sourceLineNo">3329</span><a id="line.3329">        gen.visitLineNumber(line, gen.mark());</a>
<span class="sourceLineNo">3330</span><a id="line.3330">        gen.dupX2();                          //target,thunk,thunk,target</a>
<span class="sourceLineNo">3331</span><a id="line.3331">        gen.invokeInterface(ObjExpr.ILOOKUP_THUNK_TYPE, Method.getMethod("Object get(Object)")); //target,thunk,result</a>
<span class="sourceLineNo">3332</span><a id="line.3332">        gen.dupX2();                          //result,target,thunk,result</a>
<span class="sourceLineNo">3333</span><a id="line.3333">        gen.visitJumpInsn(IF_ACMPEQ, faultLabel); //result,target</a>
<span class="sourceLineNo">3334</span><a id="line.3334">        gen.pop();                                //result</a>
<span class="sourceLineNo">3335</span><a id="line.3335">        gen.goTo(endLabel);</a>
<span class="sourceLineNo">3336</span><a id="line.3336"></a>
<span class="sourceLineNo">3337</span><a id="line.3337">        gen.mark(faultLabel);    //result,target</a>
<span class="sourceLineNo">3338</span><a id="line.3338">        gen.swap();              //target,result</a>
<span class="sourceLineNo">3339</span><a id="line.3339">        gen.pop();               //target</a>
<span class="sourceLineNo">3340</span><a id="line.3340">            gen.dup();               //target,target</a>
<span class="sourceLineNo">3341</span><a id="line.3341">        gen.getStatic(objx.objtype, objx.siteNameStatic(siteIndex),ObjExpr.KEYWORD_LOOKUPSITE_TYPE);  //target,target,site</a>
<span class="sourceLineNo">3342</span><a id="line.3342">        gen.swap();              //target,site,target</a>
<span class="sourceLineNo">3343</span><a id="line.3343">        gen.invokeInterface(ObjExpr.ILOOKUP_SITE_TYPE,</a>
<span class="sourceLineNo">3344</span><a id="line.3344">                            Method.getMethod("clojure.lang.ILookupThunk fault(Object)"));    //target,new-thunk</a>
<span class="sourceLineNo">3345</span><a id="line.3345">            gen.dup();   //target,new-thunk,new-thunk</a>
<span class="sourceLineNo">3346</span><a id="line.3346">            gen.putStatic(objx.objtype, objx.thunkNameStatic(siteIndex),ObjExpr.ILOOKUP_THUNK_TYPE);  //target,new-thunk</a>
<span class="sourceLineNo">3347</span><a id="line.3347">            gen.swap();              //new-thunk,target</a>
<span class="sourceLineNo">3348</span><a id="line.3348">            gen.invokeInterface(ObjExpr.ILOOKUP_THUNK_TYPE, Method.getMethod("Object get(Object)")); //result</a>
<span class="sourceLineNo">3349</span><a id="line.3349"></a>
<span class="sourceLineNo">3350</span><a id="line.3350">        gen.mark(endLabel);</a>
<span class="sourceLineNo">3351</span><a id="line.3351">        if(context == C.STATEMENT)</a>
<span class="sourceLineNo">3352</span><a id="line.3352">            gen.pop();</a>
<span class="sourceLineNo">3353</span><a id="line.3353">    }</a>
<span class="sourceLineNo">3354</span><a id="line.3354"></a>
<span class="sourceLineNo">3355</span><a id="line.3355">        public boolean hasJavaClass() {</a>
<span class="sourceLineNo">3356</span><a id="line.3356">                return tag != null;</a>
<span class="sourceLineNo">3357</span><a id="line.3357">        }</a>
<span class="sourceLineNo">3358</span><a id="line.3358"></a>
<span class="sourceLineNo">3359</span><a id="line.3359">        public Class getJavaClass() {</a>
<span class="sourceLineNo">3360</span><a id="line.3360">                if(jc == null)</a>
<span class="sourceLineNo">3361</span><a id="line.3361">            jc = HostExpr.tagToClass(tag);</a>
<span class="sourceLineNo">3362</span><a id="line.3362">        return jc;</a>
<span class="sourceLineNo">3363</span><a id="line.3363">        }</a>
<span class="sourceLineNo">3364</span><a id="line.3364"></a>
<span class="sourceLineNo">3365</span><a id="line.3365">}</a>
<span class="sourceLineNo">3366</span><a id="line.3366">//static class KeywordSiteInvokeExpr implements Expr{</a>
<span class="sourceLineNo">3367</span><a id="line.3367">//      public final Expr site;</a>
<span class="sourceLineNo">3368</span><a id="line.3368">//      public final Object tag;</a>
<span class="sourceLineNo">3369</span><a id="line.3369">//      public final Expr target;</a>
<span class="sourceLineNo">3370</span><a id="line.3370">//      public final int line;</a>
<span class="sourceLineNo">3371</span><a id="line.3371">//      public final int column;</a>
<span class="sourceLineNo">3372</span><a id="line.3372">//      public final String source;</a>
<span class="sourceLineNo">3373</span><a id="line.3373">//</a>
<span class="sourceLineNo">3374</span><a id="line.3374">//      public KeywordSiteInvokeExpr(String source, int line, int column, Symbol tag, Expr site, Expr target){</a>
<span class="sourceLineNo">3375</span><a id="line.3375">//              this.source = source;</a>
<span class="sourceLineNo">3376</span><a id="line.3376">//              this.site = site;</a>
<span class="sourceLineNo">3377</span><a id="line.3377">//              this.target = target;</a>
<span class="sourceLineNo">3378</span><a id="line.3378">//              this.line = line;</a>
<span class="sourceLineNo">3379</span><a id="line.3379">//              this.column = column;</a>
<span class="sourceLineNo">3380</span><a id="line.3380">//              this.tag = tag;</a>
<span class="sourceLineNo">3381</span><a id="line.3381">//      }</a>
<span class="sourceLineNo">3382</span><a id="line.3382">//</a>
<span class="sourceLineNo">3383</span><a id="line.3383">//      public Object eval() {</a>
<span class="sourceLineNo">3384</span><a id="line.3384">//              try</a>
<span class="sourceLineNo">3385</span><a id="line.3385">//                      {</a>
<span class="sourceLineNo">3386</span><a id="line.3386">//                      KeywordCallSite s = (KeywordCallSite) site.eval();</a>
<span class="sourceLineNo">3387</span><a id="line.3387">//                      return s.thunk.invoke(s,target.eval());</a>
<span class="sourceLineNo">3388</span><a id="line.3388">//                      }</a>
<span class="sourceLineNo">3389</span><a id="line.3389">//              catch(Throwable e)</a>
<span class="sourceLineNo">3390</span><a id="line.3390">//                      {</a>
<span class="sourceLineNo">3391</span><a id="line.3391">//                      if(!(e instanceof CompilerException))</a>
<span class="sourceLineNo">3392</span><a id="line.3392">//                              throw new CompilerException(source, line, column, e);</a>
<span class="sourceLineNo">3393</span><a id="line.3393">//                      else</a>
<span class="sourceLineNo">3394</span><a id="line.3394">//                              throw (CompilerException) e;</a>
<span class="sourceLineNo">3395</span><a id="line.3395">//                      }</a>
<span class="sourceLineNo">3396</span><a id="line.3396">//      }</a>
<span class="sourceLineNo">3397</span><a id="line.3397">//</a>
<span class="sourceLineNo">3398</span><a id="line.3398">//      public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">3399</span><a id="line.3399">//              gen.visitLineNumber(line, gen.mark());</a>
<span class="sourceLineNo">3400</span><a id="line.3400">//              site.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">3401</span><a id="line.3401">//              gen.dup();</a>
<span class="sourceLineNo">3402</span><a id="line.3402">//              gen.getField(Type.getType(KeywordCallSite.class),"thunk",IFN_TYPE);</a>
<span class="sourceLineNo">3403</span><a id="line.3403">//              gen.swap();</a>
<span class="sourceLineNo">3404</span><a id="line.3404">//              target.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">3405</span><a id="line.3405">//</a>
<span class="sourceLineNo">3406</span><a id="line.3406">//              gen.invokeInterface(IFN_TYPE, new Method("invoke", OBJECT_TYPE, ARG_TYPES[2]));</a>
<span class="sourceLineNo">3407</span><a id="line.3407">//              if(context == C.STATEMENT)</a>
<span class="sourceLineNo">3408</span><a id="line.3408">//                      gen.pop();</a>
<span class="sourceLineNo">3409</span><a id="line.3409">//      }</a>
<span class="sourceLineNo">3410</span><a id="line.3410">//</a>
<span class="sourceLineNo">3411</span><a id="line.3411">//      public boolean hasJavaClass() {</a>
<span class="sourceLineNo">3412</span><a id="line.3412">//              return tag != null;</a>
<span class="sourceLineNo">3413</span><a id="line.3413">//      }</a>
<span class="sourceLineNo">3414</span><a id="line.3414">//</a>
<span class="sourceLineNo">3415</span><a id="line.3415">//      public Class getJavaClass() {</a>
<span class="sourceLineNo">3416</span><a id="line.3416">//              return HostExpr.tagToClass(tag);</a>
<span class="sourceLineNo">3417</span><a id="line.3417">//      }</a>
<span class="sourceLineNo">3418</span><a id="line.3418">//</a>
<span class="sourceLineNo">3419</span><a id="line.3419">//}</a>
<span class="sourceLineNo">3420</span><a id="line.3420"></a>
<span class="sourceLineNo">3421</span><a id="line.3421">public static class InstanceOfExpr implements Expr, MaybePrimitiveExpr{</a>
<span class="sourceLineNo">3422</span><a id="line.3422">        Expr expr;</a>
<span class="sourceLineNo">3423</span><a id="line.3423">        Class c;</a>
<span class="sourceLineNo">3424</span><a id="line.3424"></a>
<span class="sourceLineNo">3425</span><a id="line.3425">        public InstanceOfExpr(Class c, Expr expr){</a>
<span class="sourceLineNo">3426</span><a id="line.3426">                this.expr = expr;</a>
<span class="sourceLineNo">3427</span><a id="line.3427">                this.c = c;</a>
<span class="sourceLineNo">3428</span><a id="line.3428">        }</a>
<span class="sourceLineNo">3429</span><a id="line.3429"></a>
<span class="sourceLineNo">3430</span><a id="line.3430">        public Object eval() {</a>
<span class="sourceLineNo">3431</span><a id="line.3431">                if(c.isInstance(expr.eval()))</a>
<span class="sourceLineNo">3432</span><a id="line.3432">                        return RT.T;</a>
<span class="sourceLineNo">3433</span><a id="line.3433">                return RT.F;</a>
<span class="sourceLineNo">3434</span><a id="line.3434">        }</a>
<span class="sourceLineNo">3435</span><a id="line.3435"></a>
<span class="sourceLineNo">3436</span><a id="line.3436">        public boolean canEmitPrimitive(){</a>
<span class="sourceLineNo">3437</span><a id="line.3437">                return true;</a>
<span class="sourceLineNo">3438</span><a id="line.3438">        }</a>
<span class="sourceLineNo">3439</span><a id="line.3439"></a>
<span class="sourceLineNo">3440</span><a id="line.3440">        public void emitUnboxed(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">3441</span><a id="line.3441">                expr.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">3442</span><a id="line.3442">                gen.instanceOf(getType(c));</a>
<span class="sourceLineNo">3443</span><a id="line.3443">        }</a>
<span class="sourceLineNo">3444</span><a id="line.3444"></a>
<span class="sourceLineNo">3445</span><a id="line.3445">        public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">3446</span><a id="line.3446">                emitUnboxed(context,objx,gen);</a>
<span class="sourceLineNo">3447</span><a id="line.3447">                HostExpr.emitBoxReturn(objx,gen,Boolean.TYPE);</a>
<span class="sourceLineNo">3448</span><a id="line.3448">                if(context == C.STATEMENT)</a>
<span class="sourceLineNo">3449</span><a id="line.3449">                        gen.pop();</a>
<span class="sourceLineNo">3450</span><a id="line.3450">        }</a>
<span class="sourceLineNo">3451</span><a id="line.3451"></a>
<span class="sourceLineNo">3452</span><a id="line.3452">        public boolean hasJavaClass() {</a>
<span class="sourceLineNo">3453</span><a id="line.3453">                return true;</a>
<span class="sourceLineNo">3454</span><a id="line.3454">        }</a>
<span class="sourceLineNo">3455</span><a id="line.3455"></a>
<span class="sourceLineNo">3456</span><a id="line.3456">        public Class getJavaClass() {</a>
<span class="sourceLineNo">3457</span><a id="line.3457">                return Boolean.TYPE;</a>
<span class="sourceLineNo">3458</span><a id="line.3458">        }</a>
<span class="sourceLineNo">3459</span><a id="line.3459"></a>
<span class="sourceLineNo">3460</span><a id="line.3460">}</a>
<span class="sourceLineNo">3461</span><a id="line.3461"></a>
<span class="sourceLineNo">3462</span><a id="line.3462">static class StaticInvokeExpr implements Expr, MaybePrimitiveExpr{</a>
<span class="sourceLineNo">3463</span><a id="line.3463">        public final Type target;</a>
<span class="sourceLineNo">3464</span><a id="line.3464">        public final Class retClass;</a>
<span class="sourceLineNo">3465</span><a id="line.3465">        public final Class[] paramclasses;</a>
<span class="sourceLineNo">3466</span><a id="line.3466">        public final Type[] paramtypes;</a>
<span class="sourceLineNo">3467</span><a id="line.3467">        public final IPersistentVector args;</a>
<span class="sourceLineNo">3468</span><a id="line.3468">        public final boolean variadic;</a>
<span class="sourceLineNo">3469</span><a id="line.3469">        public final boolean tailPosition;</a>
<span class="sourceLineNo">3470</span><a id="line.3470">        public final Object tag;</a>
<span class="sourceLineNo">3471</span><a id="line.3471">    Class jc;</a>
<span class="sourceLineNo">3472</span><a id="line.3472"></a>
<span class="sourceLineNo">3473</span><a id="line.3473">        StaticInvokeExpr(Type target, Class retClass, Class[] paramclasses, Type[] paramtypes, boolean variadic,</a>
<span class="sourceLineNo">3474</span><a id="line.3474">                         IPersistentVector args,Object tag, boolean tailPosition){</a>
<span class="sourceLineNo">3475</span><a id="line.3475">                this.target = target;</a>
<span class="sourceLineNo">3476</span><a id="line.3476">                this.retClass = retClass;</a>
<span class="sourceLineNo">3477</span><a id="line.3477">                this.paramclasses = paramclasses;</a>
<span class="sourceLineNo">3478</span><a id="line.3478">                this.paramtypes = paramtypes;</a>
<span class="sourceLineNo">3479</span><a id="line.3479">                this.args = args;</a>
<span class="sourceLineNo">3480</span><a id="line.3480">                this.variadic = variadic;</a>
<span class="sourceLineNo">3481</span><a id="line.3481">                this.tailPosition = tailPosition;</a>
<span class="sourceLineNo">3482</span><a id="line.3482">                this.tag = tag;</a>
<span class="sourceLineNo">3483</span><a id="line.3483">        }</a>
<span class="sourceLineNo">3484</span><a id="line.3484"></a>
<span class="sourceLineNo">3485</span><a id="line.3485">        public Object eval() {</a>
<span class="sourceLineNo">3486</span><a id="line.3486">                throw new UnsupportedOperationException("Can't eval StaticInvokeExpr");</a>
<span class="sourceLineNo">3487</span><a id="line.3487">        }</a>
<span class="sourceLineNo">3488</span><a id="line.3488"></a>
<span class="sourceLineNo">3489</span><a id="line.3489">        public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">3490</span><a id="line.3490">                emitUnboxed(context, objx, gen);</a>
<span class="sourceLineNo">3491</span><a id="line.3491">                if(context != C.STATEMENT)</a>
<span class="sourceLineNo">3492</span><a id="line.3492">                        HostExpr.emitBoxReturn(objx,gen,retClass);</a>
<span class="sourceLineNo">3493</span><a id="line.3493">                if(context == C.STATEMENT)</a>
<span class="sourceLineNo">3494</span><a id="line.3494">                        {</a>
<span class="sourceLineNo">3495</span><a id="line.3495">                        if(retClass == long.class || retClass == double.class)</a>
<span class="sourceLineNo">3496</span><a id="line.3496">                                gen.pop2();</a>
<span class="sourceLineNo">3497</span><a id="line.3497">                        else</a>
<span class="sourceLineNo">3498</span><a id="line.3498">                                gen.pop();</a>
<span class="sourceLineNo">3499</span><a id="line.3499">                        }</a>
<span class="sourceLineNo">3500</span><a id="line.3500">        }</a>
<span class="sourceLineNo">3501</span><a id="line.3501"></a>
<span class="sourceLineNo">3502</span><a id="line.3502">        public boolean hasJavaClass() {</a>
<span class="sourceLineNo">3503</span><a id="line.3503">                return true;</a>
<span class="sourceLineNo">3504</span><a id="line.3504">        }</a>
<span class="sourceLineNo">3505</span><a id="line.3505"></a>
<span class="sourceLineNo">3506</span><a id="line.3506">        public Class getJavaClass() {</a>
<span class="sourceLineNo">3507</span><a id="line.3507">        if(jc == null)</a>
<span class="sourceLineNo">3508</span><a id="line.3508">            jc =retType((tag!=null)?HostExpr.tagToClass(tag):null, retClass);</a>
<span class="sourceLineNo">3509</span><a id="line.3509">        return jc;</a>
<span class="sourceLineNo">3510</span><a id="line.3510">        }</a>
<span class="sourceLineNo">3511</span><a id="line.3511"></a>
<span class="sourceLineNo">3512</span><a id="line.3512">        public boolean canEmitPrimitive(){</a>
<span class="sourceLineNo">3513</span><a id="line.3513">                return retClass.isPrimitive();</a>
<span class="sourceLineNo">3514</span><a id="line.3514">        }</a>
<span class="sourceLineNo">3515</span><a id="line.3515"></a>
<span class="sourceLineNo">3516</span><a id="line.3516">        public void emitUnboxed(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">3517</span><a id="line.3517">                Method ms = new Method("invokeStatic", getReturnType(), paramtypes);</a>
<span class="sourceLineNo">3518</span><a id="line.3518">                if(variadic)</a>
<span class="sourceLineNo">3519</span><a id="line.3519">                        {</a>
<span class="sourceLineNo">3520</span><a id="line.3520">                        for(int i = 0; i &lt; paramclasses.length - 1; i++)</a>
<span class="sourceLineNo">3521</span><a id="line.3521">                                {</a>
<span class="sourceLineNo">3522</span><a id="line.3522">                                Expr e = (Expr) args.nth(i);</a>
<span class="sourceLineNo">3523</span><a id="line.3523">                                if(maybePrimitiveType(e) == paramclasses[i])</a>
<span class="sourceLineNo">3524</span><a id="line.3524">                                        {</a>
<span class="sourceLineNo">3525</span><a id="line.3525">                                        ((MaybePrimitiveExpr) e).emitUnboxed(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">3526</span><a id="line.3526">                                        }</a>
<span class="sourceLineNo">3527</span><a id="line.3527">                                else</a>
<span class="sourceLineNo">3528</span><a id="line.3528">                                        {</a>
<span class="sourceLineNo">3529</span><a id="line.3529">                                        e.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">3530</span><a id="line.3530">                                        HostExpr.emitUnboxArg(objx, gen, paramclasses[i]);</a>
<span class="sourceLineNo">3531</span><a id="line.3531">                                        }</a>
<span class="sourceLineNo">3532</span><a id="line.3532">                                }</a>
<span class="sourceLineNo">3533</span><a id="line.3533">                        IPersistentVector restArgs = RT.subvec(args,paramclasses.length - 1,args.count());</a>
<span class="sourceLineNo">3534</span><a id="line.3534">                        MethodExpr.emitArgsAsArray(restArgs,objx,gen);</a>
<span class="sourceLineNo">3535</span><a id="line.3535">                        gen.invokeStatic(Type.getType(ArraySeq.class), Method.getMethod("clojure.lang.ArraySeq create(Object[])"));</a>
<span class="sourceLineNo">3536</span><a id="line.3536">                        }</a>
<span class="sourceLineNo">3537</span><a id="line.3537">                else</a>
<span class="sourceLineNo">3538</span><a id="line.3538">                        MethodExpr.emitTypedArgs(objx, gen, paramclasses, args);</a>
<span class="sourceLineNo">3539</span><a id="line.3539"></a>
<span class="sourceLineNo">3540</span><a id="line.3540">                if(tailPosition &amp;&amp; !objx.canBeDirect)</a>
<span class="sourceLineNo">3541</span><a id="line.3541">                {</a>
<span class="sourceLineNo">3542</span><a id="line.3542">                        ObjMethod method = (ObjMethod) METHOD.deref();</a>
<span class="sourceLineNo">3543</span><a id="line.3543">                        method.emitClearThis(gen);</a>
<span class="sourceLineNo">3544</span><a id="line.3544">                }</a>
<span class="sourceLineNo">3545</span><a id="line.3545"></a>
<span class="sourceLineNo">3546</span><a id="line.3546">                gen.invokeStatic(target, ms);</a>
<span class="sourceLineNo">3547</span><a id="line.3547">        }</a>
<span class="sourceLineNo">3548</span><a id="line.3548"></a>
<span class="sourceLineNo">3549</span><a id="line.3549">        private Type getReturnType(){</a>
<span class="sourceLineNo">3550</span><a id="line.3550">                return Type.getType(retClass);</a>
<span class="sourceLineNo">3551</span><a id="line.3551">        }</a>
<span class="sourceLineNo">3552</span><a id="line.3552"></a>
<span class="sourceLineNo">3553</span><a id="line.3553">        public static Expr parse(Var v, ISeq args, Object tag, boolean tailPosition) {</a>
<span class="sourceLineNo">3554</span><a id="line.3554">                if(!v.isBound() || v.get() == null)</a>
<span class="sourceLineNo">3555</span><a id="line.3555">                        {</a>
<span class="sourceLineNo">3556</span><a id="line.3556">//                      System.out.println("Not bound: " + v);</a>
<span class="sourceLineNo">3557</span><a id="line.3557">                        return null;</a>
<span class="sourceLineNo">3558</span><a id="line.3558">                        }</a>
<span class="sourceLineNo">3559</span><a id="line.3559">                Class c = v.get().getClass();</a>
<span class="sourceLineNo">3560</span><a id="line.3560">                String cname = c.getName();</a>
<span class="sourceLineNo">3561</span><a id="line.3561">//              System.out.println("Class: " + cname);</a>
<span class="sourceLineNo">3562</span><a id="line.3562"></a>
<span class="sourceLineNo">3563</span><a id="line.3563">                java.lang.reflect.Method[] allmethods = c.getMethods();</a>
<span class="sourceLineNo">3564</span><a id="line.3564"></a>
<span class="sourceLineNo">3565</span><a id="line.3565">                boolean variadic = false;</a>
<span class="sourceLineNo">3566</span><a id="line.3566">                int argcount = RT.count(args);</a>
<span class="sourceLineNo">3567</span><a id="line.3567">                java.lang.reflect.Method method = null;</a>
<span class="sourceLineNo">3568</span><a id="line.3568">                for(java.lang.reflect.Method m : allmethods)</a>
<span class="sourceLineNo">3569</span><a id="line.3569">                        {</a>
<span class="sourceLineNo">3570</span><a id="line.3570">                        //System.out.println(m);</a>
<span class="sourceLineNo">3571</span><a id="line.3571">                        if(Modifier.isStatic(m.getModifiers()) &amp;&amp; m.getName().equals("invokeStatic"))</a>
<span class="sourceLineNo">3572</span><a id="line.3572">                                {</a>
<span class="sourceLineNo">3573</span><a id="line.3573">                                Class[] params = m.getParameterTypes();</a>
<span class="sourceLineNo">3574</span><a id="line.3574">                                if(argcount == params.length)</a>
<span class="sourceLineNo">3575</span><a id="line.3575">                                        {</a>
<span class="sourceLineNo">3576</span><a id="line.3576">                                        method = m;</a>
<span class="sourceLineNo">3577</span><a id="line.3577">                                        variadic = argcount &gt; 0 &amp;&amp; params[params.length-1] == ISeq.class;</a>
<span class="sourceLineNo">3578</span><a id="line.3578">                                        break;</a>
<span class="sourceLineNo">3579</span><a id="line.3579">                                        }</a>
<span class="sourceLineNo">3580</span><a id="line.3580">                                else if(argcount &gt; params.length</a>
<span class="sourceLineNo">3581</span><a id="line.3581">                                                &amp;&amp; params.length &gt; 0</a>
<span class="sourceLineNo">3582</span><a id="line.3582">                                                &amp;&amp; params[params.length-1] == ISeq.class)</a>
<span class="sourceLineNo">3583</span><a id="line.3583">                                        {</a>
<span class="sourceLineNo">3584</span><a id="line.3584">                                        method = m;</a>
<span class="sourceLineNo">3585</span><a id="line.3585">                                        variadic = true;</a>
<span class="sourceLineNo">3586</span><a id="line.3586">                                        break;</a>
<span class="sourceLineNo">3587</span><a id="line.3587">                                        }</a>
<span class="sourceLineNo">3588</span><a id="line.3588">                                }</a>
<span class="sourceLineNo">3589</span><a id="line.3589">                        }</a>
<span class="sourceLineNo">3590</span><a id="line.3590">                if(method == null)</a>
<span class="sourceLineNo">3591</span><a id="line.3591">                        return null;</a>
<span class="sourceLineNo">3592</span><a id="line.3592"></a>
<span class="sourceLineNo">3593</span><a id="line.3593">                Class retClass = method.getReturnType();</a>
<span class="sourceLineNo">3594</span><a id="line.3594"></a>
<span class="sourceLineNo">3595</span><a id="line.3595">                Class[] paramClasses = method.getParameterTypes();</a>
<span class="sourceLineNo">3596</span><a id="line.3596">                Type[] paramTypes = new Type[paramClasses.length];</a>
<span class="sourceLineNo">3597</span><a id="line.3597"></a>
<span class="sourceLineNo">3598</span><a id="line.3598">                for(int i = 0;i&lt;paramClasses.length;i++)</a>
<span class="sourceLineNo">3599</span><a id="line.3599">                        {</a>
<span class="sourceLineNo">3600</span><a id="line.3600">                        paramTypes[i] = Type.getType(paramClasses[i]);</a>
<span class="sourceLineNo">3601</span><a id="line.3601">                        }</a>
<span class="sourceLineNo">3602</span><a id="line.3602"></a>
<span class="sourceLineNo">3603</span><a id="line.3603">                Type target = Type.getType(c);</a>
<span class="sourceLineNo">3604</span><a id="line.3604"></a>
<span class="sourceLineNo">3605</span><a id="line.3605">                PersistentVector argv = PersistentVector.EMPTY;</a>
<span class="sourceLineNo">3606</span><a id="line.3606">                for(ISeq s = RT.seq(args); s != null; s = s.next())</a>
<span class="sourceLineNo">3607</span><a id="line.3607">                        argv = argv.cons(analyze(C.EXPRESSION, s.first()));</a>
<span class="sourceLineNo">3608</span><a id="line.3608"></a>
<span class="sourceLineNo">3609</span><a id="line.3609">                return new StaticInvokeExpr(target,retClass,paramClasses, paramTypes,variadic, argv, tag, tailPosition);</a>
<span class="sourceLineNo">3610</span><a id="line.3610">        }</a>
<span class="sourceLineNo">3611</span><a id="line.3611"></a>
<span class="sourceLineNo">3612</span><a id="line.3612">}</a>
<span class="sourceLineNo">3613</span><a id="line.3613"></a>
<span class="sourceLineNo">3614</span><a id="line.3614">static class InvokeExpr implements Expr{</a>
<span class="sourceLineNo">3615</span><a id="line.3615">        public final Expr fexpr;</a>
<span class="sourceLineNo">3616</span><a id="line.3616">        public final Object tag;</a>
<span class="sourceLineNo">3617</span><a id="line.3617">        public final IPersistentVector args;</a>
<span class="sourceLineNo">3618</span><a id="line.3618">        public final int line;</a>
<span class="sourceLineNo">3619</span><a id="line.3619">        public final int column;</a>
<span class="sourceLineNo">3620</span><a id="line.3620">        public final boolean tailPosition;</a>
<span class="sourceLineNo">3621</span><a id="line.3621">        public final String source;</a>
<span class="sourceLineNo">3622</span><a id="line.3622">        public boolean isProtocol = false;</a>
<span class="sourceLineNo">3623</span><a id="line.3623">        public boolean isDirect = false;</a>
<span class="sourceLineNo">3624</span><a id="line.3624">        public int siteIndex = -1;</a>
<span class="sourceLineNo">3625</span><a id="line.3625">        public Class protocolOn;</a>
<span class="sourceLineNo">3626</span><a id="line.3626">        public java.lang.reflect.Method onMethod;</a>
<span class="sourceLineNo">3627</span><a id="line.3627">        static Keyword onKey = Keyword.intern("on");</a>
<span class="sourceLineNo">3628</span><a id="line.3628">        static Keyword methodMapKey = Keyword.intern("method-map");</a>
<span class="sourceLineNo">3629</span><a id="line.3629">    Class jc;</a>
<span class="sourceLineNo">3630</span><a id="line.3630"></a>
<span class="sourceLineNo">3631</span><a id="line.3631">    static Object sigTag(int argcount, Var v){</a>
<span class="sourceLineNo">3632</span><a id="line.3632">        Object arglists = RT.get(RT.meta(v), arglistsKey);</a>
<span class="sourceLineNo">3633</span><a id="line.3633">        Object sigTag = null;</a>
<span class="sourceLineNo">3634</span><a id="line.3634">        for(ISeq s = RT.seq(arglists); s != null; s = s.next())</a>
<span class="sourceLineNo">3635</span><a id="line.3635">            {</a>
<span class="sourceLineNo">3636</span><a id="line.3636">            APersistentVector sig = (APersistentVector) s.first();</a>
<span class="sourceLineNo">3637</span><a id="line.3637">            int restOffset = sig.indexOf(_AMP_);</a>
<span class="sourceLineNo">3638</span><a id="line.3638">            if(argcount == sig.count() || (restOffset &gt; -1 &amp;&amp; argcount &gt;= restOffset))</a>
<span class="sourceLineNo">3639</span><a id="line.3639">                return tagOf(sig);</a>
<span class="sourceLineNo">3640</span><a id="line.3640">            }</a>
<span class="sourceLineNo">3641</span><a id="line.3641">        return null;</a>
<span class="sourceLineNo">3642</span><a id="line.3642">        }</a>
<span class="sourceLineNo">3643</span><a id="line.3643"></a>
<span class="sourceLineNo">3644</span><a id="line.3644">        public InvokeExpr(String source, int line, int column, Symbol tag, Expr fexpr, IPersistentVector args, boolean tailPosition) {</a>
<span class="sourceLineNo">3645</span><a id="line.3645">                this.source = source;</a>
<span class="sourceLineNo">3646</span><a id="line.3646">                this.fexpr = fexpr;</a>
<span class="sourceLineNo">3647</span><a id="line.3647">                this.args = args;</a>
<span class="sourceLineNo">3648</span><a id="line.3648">                this.line = line;</a>
<span class="sourceLineNo">3649</span><a id="line.3649">                this.column = column;</a>
<span class="sourceLineNo">3650</span><a id="line.3650">                this.tailPosition = tailPosition;</a>
<span class="sourceLineNo">3651</span><a id="line.3651"></a>
<span class="sourceLineNo">3652</span><a id="line.3652">                if(fexpr instanceof VarExpr)</a>
<span class="sourceLineNo">3653</span><a id="line.3653">                        {</a>
<span class="sourceLineNo">3654</span><a id="line.3654">                        Var fvar = ((VarExpr)fexpr).var;</a>
<span class="sourceLineNo">3655</span><a id="line.3655">                        Var pvar =  (Var)RT.get(fvar.meta(), protocolKey);</a>
<span class="sourceLineNo">3656</span><a id="line.3656">                        if(pvar != null &amp;&amp; PROTOCOL_CALLSITES.isBound())</a>
<span class="sourceLineNo">3657</span><a id="line.3657">                                {</a>
<span class="sourceLineNo">3658</span><a id="line.3658">                                this.isProtocol = true;</a>
<span class="sourceLineNo">3659</span><a id="line.3659">                                this.siteIndex = registerProtocolCallsite(((VarExpr)fexpr).var);</a>
<span class="sourceLineNo">3660</span><a id="line.3660">                                Object pon = RT.get(pvar.get(), onKey);</a>
<span class="sourceLineNo">3661</span><a id="line.3661">                                this.protocolOn = HostExpr.maybeClass(pon,false);</a>
<span class="sourceLineNo">3662</span><a id="line.3662">                                if(this.protocolOn != null)</a>
<span class="sourceLineNo">3663</span><a id="line.3663">                                        {</a>
<span class="sourceLineNo">3664</span><a id="line.3664">                                        IPersistentMap mmap = (IPersistentMap) RT.get(pvar.get(), methodMapKey);</a>
<span class="sourceLineNo">3665</span><a id="line.3665">                    Keyword mmapVal = (Keyword) mmap.valAt(Keyword.intern(fvar.sym));</a>
<span class="sourceLineNo">3666</span><a id="line.3666">                    if (mmapVal == null) {</a>
<span class="sourceLineNo">3667</span><a id="line.3667">                        throw new IllegalArgumentException(</a>
<span class="sourceLineNo">3668</span><a id="line.3668">                              "No method of interface: " + protocolOn.getName() +</a>
<span class="sourceLineNo">3669</span><a id="line.3669">                              " found for function: " + fvar.sym + " of protocol: " + pvar.sym +</a>
<span class="sourceLineNo">3670</span><a id="line.3670">                              " (The protocol method may have been defined before and removed.)");</a>
<span class="sourceLineNo">3671</span><a id="line.3671">                    }</a>
<span class="sourceLineNo">3672</span><a id="line.3672">                    String mname = munge(mmapVal.sym.toString());</a>
<span class="sourceLineNo">3673</span><a id="line.3673">                                        List methods = Reflector.getMethods(protocolOn, args.count() - 1, mname, false);</a>
<span class="sourceLineNo">3674</span><a id="line.3674">                                        if(methods.size() != 1)</a>
<span class="sourceLineNo">3675</span><a id="line.3675">                                                throw new IllegalArgumentException(</a>
<span class="sourceLineNo">3676</span><a id="line.3676">                                                                "No single method: " + mname + " of interface: " + protocolOn.getName() +</a>
<span class="sourceLineNo">3677</span><a id="line.3677">                                                                " found for function: " + fvar.sym + " of protocol: " + pvar.sym);</a>
<span class="sourceLineNo">3678</span><a id="line.3678">                                        this.onMethod = (java.lang.reflect.Method) methods.get(0);</a>
<span class="sourceLineNo">3679</span><a id="line.3679">                                        }</a>
<span class="sourceLineNo">3680</span><a id="line.3680">                                }</a>
<span class="sourceLineNo">3681</span><a id="line.3681">                        }</a>
<span class="sourceLineNo">3682</span><a id="line.3682">                </a>
<span class="sourceLineNo">3683</span><a id="line.3683">                if (tag != null) {</a>
<span class="sourceLineNo">3684</span><a id="line.3684">                    this.tag = tag;</a>
<span class="sourceLineNo">3685</span><a id="line.3685">                } else if (fexpr instanceof VarExpr) {</a>
<span class="sourceLineNo">3686</span><a id="line.3686">            Var v = ((VarExpr) fexpr).var;</a>
<span class="sourceLineNo">3687</span><a id="line.3687">                    Object arglists = RT.get(RT.meta(v), arglistsKey);</a>
<span class="sourceLineNo">3688</span><a id="line.3688">                    Object sigTag = sigTag(args.count(),v);</a>
<span class="sourceLineNo">3689</span><a id="line.3689">                    this.tag = sigTag == null ? ((VarExpr) fexpr).tag : sigTag;</a>
<span class="sourceLineNo">3690</span><a id="line.3690">                } else {</a>
<span class="sourceLineNo">3691</span><a id="line.3691">                    this.tag = null;</a>
<span class="sourceLineNo">3692</span><a id="line.3692">                }</a>
<span class="sourceLineNo">3693</span><a id="line.3693">        }</a>
<span class="sourceLineNo">3694</span><a id="line.3694"></a>
<span class="sourceLineNo">3695</span><a id="line.3695">        public Object eval() {</a>
<span class="sourceLineNo">3696</span><a id="line.3696">                try</a>
<span class="sourceLineNo">3697</span><a id="line.3697">                        {</a>
<span class="sourceLineNo">3698</span><a id="line.3698">                        IFn fn = (IFn) fexpr.eval();</a>
<span class="sourceLineNo">3699</span><a id="line.3699">                        PersistentVector argvs = PersistentVector.EMPTY;</a>
<span class="sourceLineNo">3700</span><a id="line.3700">                        for(int i = 0; i &lt; args.count(); i++)</a>
<span class="sourceLineNo">3701</span><a id="line.3701">                                argvs = argvs.cons(((Expr) args.nth(i)).eval());</a>
<span class="sourceLineNo">3702</span><a id="line.3702">                        return fn.applyTo(RT.seq( Util.ret1(argvs, argvs = null) ));</a>
<span class="sourceLineNo">3703</span><a id="line.3703">                        }</a>
<span class="sourceLineNo">3704</span><a id="line.3704">                catch(Throwable e)</a>
<span class="sourceLineNo">3705</span><a id="line.3705">                        {</a>
<span class="sourceLineNo">3706</span><a id="line.3706">                        if(!(e instanceof CompilerException))</a>
<span class="sourceLineNo">3707</span><a id="line.3707">                                throw new CompilerException(source, line, column, e);</a>
<span class="sourceLineNo">3708</span><a id="line.3708">                        else</a>
<span class="sourceLineNo">3709</span><a id="line.3709">                                throw (CompilerException) e;</a>
<span class="sourceLineNo">3710</span><a id="line.3710">                        }</a>
<span class="sourceLineNo">3711</span><a id="line.3711">        }</a>
<span class="sourceLineNo">3712</span><a id="line.3712"></a>
<span class="sourceLineNo">3713</span><a id="line.3713">        public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">3714</span><a id="line.3714">                if(isProtocol)</a>
<span class="sourceLineNo">3715</span><a id="line.3715">                        {</a>
<span class="sourceLineNo">3716</span><a id="line.3716">                        gen.visitLineNumber(line, gen.mark());</a>
<span class="sourceLineNo">3717</span><a id="line.3717">                        emitProto(context,objx,gen);</a>
<span class="sourceLineNo">3718</span><a id="line.3718">                        }</a>
<span class="sourceLineNo">3719</span><a id="line.3719"></a>
<span class="sourceLineNo">3720</span><a id="line.3720">                else</a>
<span class="sourceLineNo">3721</span><a id="line.3721">                        {</a>
<span class="sourceLineNo">3722</span><a id="line.3722">                        fexpr.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">3723</span><a id="line.3723">                        gen.visitLineNumber(line, gen.mark());</a>
<span class="sourceLineNo">3724</span><a id="line.3724">                        gen.checkCast(IFN_TYPE);</a>
<span class="sourceLineNo">3725</span><a id="line.3725">                        emitArgsAndCall(0, context,objx,gen);</a>
<span class="sourceLineNo">3726</span><a id="line.3726">                        }</a>
<span class="sourceLineNo">3727</span><a id="line.3727">                if(context == C.STATEMENT)</a>
<span class="sourceLineNo">3728</span><a id="line.3728">                        gen.pop();              </a>
<span class="sourceLineNo">3729</span><a id="line.3729">        }</a>
<span class="sourceLineNo">3730</span><a id="line.3730"></a>
<span class="sourceLineNo">3731</span><a id="line.3731">        public void emitProto(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">3732</span><a id="line.3732">                Label onLabel = gen.newLabel();</a>
<span class="sourceLineNo">3733</span><a id="line.3733">                Label callLabel = gen.newLabel();</a>
<span class="sourceLineNo">3734</span><a id="line.3734">                Label endLabel = gen.newLabel();</a>
<span class="sourceLineNo">3735</span><a id="line.3735"></a>
<span class="sourceLineNo">3736</span><a id="line.3736">                Var v = ((VarExpr)fexpr).var;</a>
<span class="sourceLineNo">3737</span><a id="line.3737"></a>
<span class="sourceLineNo">3738</span><a id="line.3738">                Expr e = (Expr) args.nth(0);</a>
<span class="sourceLineNo">3739</span><a id="line.3739">                e.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">3740</span><a id="line.3740">                gen.dup(); //target, target</a>
<span class="sourceLineNo">3741</span><a id="line.3741">                gen.invokeStatic(UTIL_TYPE,Method.getMethod("Class classOf(Object)")); //target,class</a>
<span class="sourceLineNo">3742</span><a id="line.3742">                gen.getStatic(objx.objtype, objx.cachedClassName(siteIndex),CLASS_TYPE); //target,class,cached-class</a>
<span class="sourceLineNo">3743</span><a id="line.3743">                gen.visitJumpInsn(IF_ACMPEQ, callLabel); //target</a>
<span class="sourceLineNo">3744</span><a id="line.3744">                if(protocolOn != null)</a>
<span class="sourceLineNo">3745</span><a id="line.3745">                        {</a>
<span class="sourceLineNo">3746</span><a id="line.3746">                        gen.dup(); //target, target                     </a>
<span class="sourceLineNo">3747</span><a id="line.3747">                        gen.instanceOf(Type.getType(protocolOn));</a>
<span class="sourceLineNo">3748</span><a id="line.3748">                        gen.ifZCmp(GeneratorAdapter.NE, onLabel);</a>
<span class="sourceLineNo">3749</span><a id="line.3749">                        }</a>
<span class="sourceLineNo">3750</span><a id="line.3750"></a>
<span class="sourceLineNo">3751</span><a id="line.3751">                gen.dup(); //target, target</a>
<span class="sourceLineNo">3752</span><a id="line.3752">                gen.invokeStatic(UTIL_TYPE,Method.getMethod("Class classOf(Object)")); //target,class</a>
<span class="sourceLineNo">3753</span><a id="line.3753">                gen.putStatic(objx.objtype, objx.cachedClassName(siteIndex),CLASS_TYPE); //target</a>
<span class="sourceLineNo">3754</span><a id="line.3754"></a>
<span class="sourceLineNo">3755</span><a id="line.3755">                gen.mark(callLabel); //target</a>
<span class="sourceLineNo">3756</span><a id="line.3756">                objx.emitVar(gen, v);</a>
<span class="sourceLineNo">3757</span><a id="line.3757">                gen.invokeVirtual(VAR_TYPE, Method.getMethod("Object getRawRoot()")); //target, proto-fn</a>
<span class="sourceLineNo">3758</span><a id="line.3758">                gen.swap();</a>
<span class="sourceLineNo">3759</span><a id="line.3759">                emitArgsAndCall(1, context,objx,gen);</a>
<span class="sourceLineNo">3760</span><a id="line.3760">                gen.goTo(endLabel);</a>
<span class="sourceLineNo">3761</span><a id="line.3761"></a>
<span class="sourceLineNo">3762</span><a id="line.3762">                gen.mark(onLabel); //target</a>
<span class="sourceLineNo">3763</span><a id="line.3763">                if(protocolOn != null)</a>
<span class="sourceLineNo">3764</span><a id="line.3764">                        {</a>
<span class="sourceLineNo">3765</span><a id="line.3765">                        gen.checkCast(Type.getType(protocolOn));</a>
<span class="sourceLineNo">3766</span><a id="line.3766">                        MethodExpr.emitTypedArgs(objx, gen, onMethod.getParameterTypes(), RT.subvec(args,1,args.count()));</a>
<span class="sourceLineNo">3767</span><a id="line.3767">                        if(context == C.RETURN)</a>
<span class="sourceLineNo">3768</span><a id="line.3768">                                {</a>
<span class="sourceLineNo">3769</span><a id="line.3769">                                ObjMethod method = (ObjMethod) METHOD.deref();</a>
<span class="sourceLineNo">3770</span><a id="line.3770">                                method.emitClearLocals(gen);</a>
<span class="sourceLineNo">3771</span><a id="line.3771">                                }</a>
<span class="sourceLineNo">3772</span><a id="line.3772">                        Method m = new Method(onMethod.getName(), Type.getReturnType(onMethod), Type.getArgumentTypes(onMethod));</a>
<span class="sourceLineNo">3773</span><a id="line.3773">                        gen.invokeInterface(Type.getType(protocolOn), m);</a>
<span class="sourceLineNo">3774</span><a id="line.3774">                        HostExpr.emitBoxReturn(objx, gen, onMethod.getReturnType());</a>
<span class="sourceLineNo">3775</span><a id="line.3775">                        }</a>
<span class="sourceLineNo">3776</span><a id="line.3776">                gen.mark(endLabel);</a>
<span class="sourceLineNo">3777</span><a id="line.3777">        }</a>
<span class="sourceLineNo">3778</span><a id="line.3778"></a>
<span class="sourceLineNo">3779</span><a id="line.3779">        void emitArgsAndCall(int firstArgToEmit, C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">3780</span><a id="line.3780">                for(int i = firstArgToEmit; i &lt; Math.min(MAX_POSITIONAL_ARITY, args.count()); i++)</a>
<span class="sourceLineNo">3781</span><a id="line.3781">                        {</a>
<span class="sourceLineNo">3782</span><a id="line.3782">                        Expr e = (Expr) args.nth(i);</a>
<span class="sourceLineNo">3783</span><a id="line.3783">                        e.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">3784</span><a id="line.3784">                        }</a>
<span class="sourceLineNo">3785</span><a id="line.3785">                if(args.count() &gt; MAX_POSITIONAL_ARITY)</a>
<span class="sourceLineNo">3786</span><a id="line.3786">                        {</a>
<span class="sourceLineNo">3787</span><a id="line.3787">                        PersistentVector restArgs = PersistentVector.EMPTY;</a>
<span class="sourceLineNo">3788</span><a id="line.3788">                        for(int i = MAX_POSITIONAL_ARITY; i &lt; args.count(); i++)</a>
<span class="sourceLineNo">3789</span><a id="line.3789">                                {</a>
<span class="sourceLineNo">3790</span><a id="line.3790">                                restArgs = restArgs.cons(args.nth(i));</a>
<span class="sourceLineNo">3791</span><a id="line.3791">                                }</a>
<span class="sourceLineNo">3792</span><a id="line.3792">                        MethodExpr.emitArgsAsArray(restArgs, objx, gen);</a>
<span class="sourceLineNo">3793</span><a id="line.3793">                        }</a>
<span class="sourceLineNo">3794</span><a id="line.3794">                gen.visitLineNumber(line, gen.mark());</a>
<span class="sourceLineNo">3795</span><a id="line.3795"></a>
<span class="sourceLineNo">3796</span><a id="line.3796">                if(tailPosition &amp;&amp; !objx.canBeDirect)</a>
<span class="sourceLineNo">3797</span><a id="line.3797">                        {</a>
<span class="sourceLineNo">3798</span><a id="line.3798">                        ObjMethod method = (ObjMethod) METHOD.deref();</a>
<span class="sourceLineNo">3799</span><a id="line.3799">                        method.emitClearThis(gen);</a>
<span class="sourceLineNo">3800</span><a id="line.3800">                        }</a>
<span class="sourceLineNo">3801</span><a id="line.3801"></a>
<span class="sourceLineNo">3802</span><a id="line.3802">                gen.invokeInterface(IFN_TYPE, new Method("invoke", OBJECT_TYPE, ARG_TYPES[Math.min(MAX_POSITIONAL_ARITY + 1,</a>
<span class="sourceLineNo">3803</span><a id="line.3803">                                                                                                   args.count())]));</a>
<span class="sourceLineNo">3804</span><a id="line.3804">        }</a>
<span class="sourceLineNo">3805</span><a id="line.3805"></a>
<span class="sourceLineNo">3806</span><a id="line.3806">        public boolean hasJavaClass() {</a>
<span class="sourceLineNo">3807</span><a id="line.3807">                return tag != null;</a>
<span class="sourceLineNo">3808</span><a id="line.3808">        }</a>
<span class="sourceLineNo">3809</span><a id="line.3809"></a>
<span class="sourceLineNo">3810</span><a id="line.3810">        public Class getJavaClass() {</a>
<span class="sourceLineNo">3811</span><a id="line.3811">        if (jc == null)</a>
<span class="sourceLineNo">3812</span><a id="line.3812">            jc = HostExpr.tagToClass(tag);</a>
<span class="sourceLineNo">3813</span><a id="line.3813">        return jc;</a>
<span class="sourceLineNo">3814</span><a id="line.3814">        }</a>
<span class="sourceLineNo">3815</span><a id="line.3815"></a>
<span class="sourceLineNo">3816</span><a id="line.3816">        static public Expr parse(C context, ISeq form) {</a>
<span class="sourceLineNo">3817</span><a id="line.3817">                boolean tailPosition = inTailCall(context);</a>
<span class="sourceLineNo">3818</span><a id="line.3818">                if(context != C.EVAL)</a>
<span class="sourceLineNo">3819</span><a id="line.3819">                        context = C.EXPRESSION;</a>
<span class="sourceLineNo">3820</span><a id="line.3820">                Expr fexpr = analyze(context, form.first());</a>
<span class="sourceLineNo">3821</span><a id="line.3821">                if(fexpr instanceof VarExpr &amp;&amp; ((VarExpr)fexpr).var.equals(INSTANCE) &amp;&amp; RT.count(form) == 3)</a>
<span class="sourceLineNo">3822</span><a id="line.3822">                        {</a>
<span class="sourceLineNo">3823</span><a id="line.3823">                        Expr sexpr = analyze(C.EXPRESSION, RT.second(form));</a>
<span class="sourceLineNo">3824</span><a id="line.3824">                        if(sexpr instanceof ConstantExpr)</a>
<span class="sourceLineNo">3825</span><a id="line.3825">                                {</a>
<span class="sourceLineNo">3826</span><a id="line.3826">                                Object val = ((ConstantExpr) sexpr).val();</a>
<span class="sourceLineNo">3827</span><a id="line.3827">                                if(val instanceof Class)</a>
<span class="sourceLineNo">3828</span><a id="line.3828">                                        {</a>
<span class="sourceLineNo">3829</span><a id="line.3829">                                        return new InstanceOfExpr((Class) val, analyze(context, RT.third(form)));</a>
<span class="sourceLineNo">3830</span><a id="line.3830">                                        }</a>
<span class="sourceLineNo">3831</span><a id="line.3831">                                }</a>
<span class="sourceLineNo">3832</span><a id="line.3832">                        }</a>
<span class="sourceLineNo">3833</span><a id="line.3833"></a>
<span class="sourceLineNo">3834</span><a id="line.3834">                if(RT.booleanCast(getCompilerOption(directLinkingKey))</a>
<span class="sourceLineNo">3835</span><a id="line.3835">           &amp;&amp; fexpr instanceof VarExpr</a>
<span class="sourceLineNo">3836</span><a id="line.3836">           &amp;&amp; context != C.EVAL)</a>
<span class="sourceLineNo">3837</span><a id="line.3837">                        {</a>
<span class="sourceLineNo">3838</span><a id="line.3838">                        Var v = ((VarExpr)fexpr).var;</a>
<span class="sourceLineNo">3839</span><a id="line.3839">            if(!v.isDynamic() &amp;&amp; !RT.booleanCast(RT.get(v.meta(), redefKey, false)))</a>
<span class="sourceLineNo">3840</span><a id="line.3840">                {</a>
<span class="sourceLineNo">3841</span><a id="line.3841">                Symbol formtag = tagOf(form);</a>
<span class="sourceLineNo">3842</span><a id="line.3842">                Object arglists = RT.get(RT.meta(v), arglistsKey);</a>
<span class="sourceLineNo">3843</span><a id="line.3843">                int arity = RT.count(form.next());</a>
<span class="sourceLineNo">3844</span><a id="line.3844">                Object sigtag = sigTag(arity, v);</a>
<span class="sourceLineNo">3845</span><a id="line.3845">                Object vtag = RT.get(RT.meta(v), RT.TAG_KEY);</a>
<span class="sourceLineNo">3846</span><a id="line.3846">                Expr ret = StaticInvokeExpr</a>
<span class="sourceLineNo">3847</span><a id="line.3847">                        .parse(v, RT.next(form), formtag != null ? formtag : sigtag != null ? sigtag : vtag, tailPosition);</a>
<span class="sourceLineNo">3848</span><a id="line.3848">                if(ret != null)</a>
<span class="sourceLineNo">3849</span><a id="line.3849">                    {</a>
<span class="sourceLineNo">3850</span><a id="line.3850">//                                  System.out.println("invoke direct: " + v);</a>
<span class="sourceLineNo">3851</span><a id="line.3851">                    return ret;</a>
<span class="sourceLineNo">3852</span><a id="line.3852">                    }</a>
<span class="sourceLineNo">3853</span><a id="line.3853">//                System.out.println("NOT direct: " + v);</a>
<span class="sourceLineNo">3854</span><a id="line.3854">                }</a>
<span class="sourceLineNo">3855</span><a id="line.3855">                        }</a>
<span class="sourceLineNo">3856</span><a id="line.3856"></a>
<span class="sourceLineNo">3857</span><a id="line.3857">                if(fexpr instanceof VarExpr &amp;&amp; context != C.EVAL)</a>
<span class="sourceLineNo">3858</span><a id="line.3858">                        {</a>
<span class="sourceLineNo">3859</span><a id="line.3859">                        Var v = ((VarExpr)fexpr).var;</a>
<span class="sourceLineNo">3860</span><a id="line.3860">                        Object arglists = RT.get(RT.meta(v), arglistsKey);</a>
<span class="sourceLineNo">3861</span><a id="line.3861">                        int arity = RT.count(form.next());</a>
<span class="sourceLineNo">3862</span><a id="line.3862">                        for(ISeq s = RT.seq(arglists); s != null; s = s.next())</a>
<span class="sourceLineNo">3863</span><a id="line.3863">                                {</a>
<span class="sourceLineNo">3864</span><a id="line.3864">                                IPersistentVector args = (IPersistentVector) s.first();</a>
<span class="sourceLineNo">3865</span><a id="line.3865">                                if(args.count() == arity)</a>
<span class="sourceLineNo">3866</span><a id="line.3866">                                        {</a>
<span class="sourceLineNo">3867</span><a id="line.3867">                                        String primc = FnMethod.primInterface(args);</a>
<span class="sourceLineNo">3868</span><a id="line.3868">                                        if(primc != null)</a>
<span class="sourceLineNo">3869</span><a id="line.3869">                                                return analyze(context,</a>
<span class="sourceLineNo">3870</span><a id="line.3870">                                                               ((IObj)RT.listStar(Symbol.intern(".invokePrim"),</a>
<span class="sourceLineNo">3871</span><a id="line.3871">                                                                                  ((Symbol) form.first()).withMeta(RT.map(RT.TAG_KEY, Symbol.intern(primc))),</a>
<span class="sourceLineNo">3872</span><a id="line.3872">                                                                                  form.next())).withMeta((IPersistentMap)RT.conj(RT.meta(v), RT.meta(form))));</a>
<span class="sourceLineNo">3873</span><a id="line.3873">                                        break;</a>
<span class="sourceLineNo">3874</span><a id="line.3874">                                        }</a>
<span class="sourceLineNo">3875</span><a id="line.3875">                                }</a>
<span class="sourceLineNo">3876</span><a id="line.3876">                        }</a>
<span class="sourceLineNo">3877</span><a id="line.3877"></a>
<span class="sourceLineNo">3878</span><a id="line.3878">                if(fexpr instanceof KeywordExpr &amp;&amp; RT.count(form) == 2 &amp;&amp; KEYWORD_CALLSITES.isBound())</a>
<span class="sourceLineNo">3879</span><a id="line.3879">                        {</a>
<span class="sourceLineNo">3880</span><a id="line.3880">//                      fexpr = new ConstantExpr(new KeywordCallSite(((KeywordExpr)fexpr).k));</a>
<span class="sourceLineNo">3881</span><a id="line.3881">                        Expr target = analyze(context, RT.second(form));</a>
<span class="sourceLineNo">3882</span><a id="line.3882">                        return new KeywordInvokeExpr((String) SOURCE.deref(), lineDeref(), columnDeref(), tagOf(form),</a>
<span class="sourceLineNo">3883</span><a id="line.3883">                                                     (KeywordExpr) fexpr, target);</a>
<span class="sourceLineNo">3884</span><a id="line.3884">                        }</a>
<span class="sourceLineNo">3885</span><a id="line.3885">                PersistentVector args = PersistentVector.EMPTY;</a>
<span class="sourceLineNo">3886</span><a id="line.3886">                for(ISeq s = RT.seq(form.next()); s != null; s = s.next())</a>
<span class="sourceLineNo">3887</span><a id="line.3887">                        {</a>
<span class="sourceLineNo">3888</span><a id="line.3888">                        args = args.cons(analyze(context, s.first()));</a>
<span class="sourceLineNo">3889</span><a id="line.3889">                        }</a>
<span class="sourceLineNo">3890</span><a id="line.3890">//              if(args.count() &gt; MAX_POSITIONAL_ARITY)</a>
<span class="sourceLineNo">3891</span><a id="line.3891">//                      throw new IllegalArgumentException(</a>
<span class="sourceLineNo">3892</span><a id="line.3892">//                                      String.format("No more than %d args supported", MAX_POSITIONAL_ARITY));</a>
<span class="sourceLineNo">3893</span><a id="line.3893"></a>
<span class="sourceLineNo">3894</span><a id="line.3894">                return new InvokeExpr((String) SOURCE.deref(), lineDeref(), columnDeref(), tagOf(form), fexpr, args, tailPosition);</a>
<span class="sourceLineNo">3895</span><a id="line.3895">        }</a>
<span class="sourceLineNo">3896</span><a id="line.3896">}</a>
<span class="sourceLineNo">3897</span><a id="line.3897"></a>
<span class="sourceLineNo">3898</span><a id="line.3898">static class SourceDebugExtensionAttribute extends Attribute{</a>
<span class="sourceLineNo">3899</span><a id="line.3899">        public SourceDebugExtensionAttribute(){</a>
<span class="sourceLineNo">3900</span><a id="line.3900">                super("SourceDebugExtension");</a>
<span class="sourceLineNo">3901</span><a id="line.3901">        }</a>
<span class="sourceLineNo">3902</span><a id="line.3902"></a>
<span class="sourceLineNo">3903</span><a id="line.3903">        void writeSMAP(ClassWriter cw, String smap){</a>
<span class="sourceLineNo">3904</span><a id="line.3904">                ByteVector bv = write(cw, null, -1, -1, -1);</a>
<span class="sourceLineNo">3905</span><a id="line.3905">                bv.putUTF8(smap);</a>
<span class="sourceLineNo">3906</span><a id="line.3906">        }</a>
<span class="sourceLineNo">3907</span><a id="line.3907">}</a>
<span class="sourceLineNo">3908</span><a id="line.3908"></a>
<span class="sourceLineNo">3909</span><a id="line.3909">static public class FnExpr extends ObjExpr{</a>
<span class="sourceLineNo">3910</span><a id="line.3910">        final static Type aFnType = Type.getType(AFunction.class);</a>
<span class="sourceLineNo">3911</span><a id="line.3911">        final static Type restFnType = Type.getType(RestFn.class);</a>
<span class="sourceLineNo">3912</span><a id="line.3912">        //if there is a variadic overload (there can only be one) it is stored here</a>
<span class="sourceLineNo">3913</span><a id="line.3913">        FnMethod variadicMethod = null;</a>
<span class="sourceLineNo">3914</span><a id="line.3914">        IPersistentCollection methods;</a>
<span class="sourceLineNo">3915</span><a id="line.3915">        private boolean hasPrimSigs;</a>
<span class="sourceLineNo">3916</span><a id="line.3916">        private boolean hasMeta;</a>
<span class="sourceLineNo">3917</span><a id="line.3917">    private boolean hasEnclosingMethod;</a>
<span class="sourceLineNo">3918</span><a id="line.3918">        //      String superName = null;</a>
<span class="sourceLineNo">3919</span><a id="line.3919">    Class jc;</a>
<span class="sourceLineNo">3920</span><a id="line.3920"></a>
<span class="sourceLineNo">3921</span><a id="line.3921">        public FnExpr(Object tag){</a>
<span class="sourceLineNo">3922</span><a id="line.3922">                super(tag);</a>
<span class="sourceLineNo">3923</span><a id="line.3923">        }</a>
<span class="sourceLineNo">3924</span><a id="line.3924"></a>
<span class="sourceLineNo">3925</span><a id="line.3925">        public boolean hasJavaClass() {</a>
<span class="sourceLineNo">3926</span><a id="line.3926">                return true;</a>
<span class="sourceLineNo">3927</span><a id="line.3927">        }</a>
<span class="sourceLineNo">3928</span><a id="line.3928"></a>
<span class="sourceLineNo">3929</span><a id="line.3929">        boolean supportsMeta(){</a>
<span class="sourceLineNo">3930</span><a id="line.3930">                return hasMeta;</a>
<span class="sourceLineNo">3931</span><a id="line.3931">        }</a>
<span class="sourceLineNo">3932</span><a id="line.3932"></a>
<span class="sourceLineNo">3933</span><a id="line.3933">        public Class getJavaClass() {</a>
<span class="sourceLineNo">3934</span><a id="line.3934">        if (jc == null)</a>
<span class="sourceLineNo">3935</span><a id="line.3935">            jc = tag != null ? HostExpr.tagToClass(tag) : AFunction.class;</a>
<span class="sourceLineNo">3936</span><a id="line.3936">        return jc;</a>
<span class="sourceLineNo">3937</span><a id="line.3937">        }</a>
<span class="sourceLineNo">3938</span><a id="line.3938"></a>
<span class="sourceLineNo">3939</span><a id="line.3939">        protected void emitMethods(ClassVisitor cv){</a>
<span class="sourceLineNo">3940</span><a id="line.3940">                //override of invoke/doInvoke for each method</a>
<span class="sourceLineNo">3941</span><a id="line.3941">                for(ISeq s = RT.seq(methods); s != null; s = s.next())</a>
<span class="sourceLineNo">3942</span><a id="line.3942">                        {</a>
<span class="sourceLineNo">3943</span><a id="line.3943">                        ObjMethod method = (ObjMethod) s.first();</a>
<span class="sourceLineNo">3944</span><a id="line.3944">                        method.emit(this, cv);</a>
<span class="sourceLineNo">3945</span><a id="line.3945">                        }</a>
<span class="sourceLineNo">3946</span><a id="line.3946"></a>
<span class="sourceLineNo">3947</span><a id="line.3947">                if(isVariadic())</a>
<span class="sourceLineNo">3948</span><a id="line.3948">                        {</a>
<span class="sourceLineNo">3949</span><a id="line.3949">                        GeneratorAdapter gen = new GeneratorAdapter(ACC_PUBLIC,</a>
<span class="sourceLineNo">3950</span><a id="line.3950">                                                                    Method.getMethod("int getRequiredArity()"),</a>
<span class="sourceLineNo">3951</span><a id="line.3951">                                                                    null,</a>
<span class="sourceLineNo">3952</span><a id="line.3952">                                                                    null,</a>
<span class="sourceLineNo">3953</span><a id="line.3953">                                                                    cv);</a>
<span class="sourceLineNo">3954</span><a id="line.3954">                        gen.visitCode();</a>
<span class="sourceLineNo">3955</span><a id="line.3955">                        gen.push(variadicMethod.reqParms.count());</a>
<span class="sourceLineNo">3956</span><a id="line.3956">                        gen.returnValue();</a>
<span class="sourceLineNo">3957</span><a id="line.3957">                        gen.endMethod();</a>
<span class="sourceLineNo">3958</span><a id="line.3958">                        }</a>
<span class="sourceLineNo">3959</span><a id="line.3959">        }</a>
<span class="sourceLineNo">3960</span><a id="line.3960"></a>
<span class="sourceLineNo">3961</span><a id="line.3961">        static Expr parse(C context, ISeq form, String name) {</a>
<span class="sourceLineNo">3962</span><a id="line.3962">                ISeq origForm = form;</a>
<span class="sourceLineNo">3963</span><a id="line.3963">                FnExpr fn = new FnExpr(tagOf(form));</a>
<span class="sourceLineNo">3964</span><a id="line.3964">                Keyword retkey = Keyword.intern(null, "rettag");</a>
<span class="sourceLineNo">3965</span><a id="line.3965">                Object rettag = RT.get(RT.meta(form), retkey);</a>
<span class="sourceLineNo">3966</span><a id="line.3966">                fn.src = form;</a>
<span class="sourceLineNo">3967</span><a id="line.3967">                ObjMethod enclosingMethod = (ObjMethod) METHOD.deref();</a>
<span class="sourceLineNo">3968</span><a id="line.3968">        fn.hasEnclosingMethod = enclosingMethod != null;</a>
<span class="sourceLineNo">3969</span><a id="line.3969">                if(((IMeta) form.first()).meta() != null)</a>
<span class="sourceLineNo">3970</span><a id="line.3970">                        {</a>
<span class="sourceLineNo">3971</span><a id="line.3971">                        fn.onceOnly = RT.booleanCast(RT.get(RT.meta(form.first()), Keyword.intern(null, "once")));</a>
<span class="sourceLineNo">3972</span><a id="line.3972">//                      fn.superName = (String) RT.get(RT.meta(form.first()), Keyword.intern(null, "super-name"));</a>
<span class="sourceLineNo">3973</span><a id="line.3973">                        }</a>
<span class="sourceLineNo">3974</span><a id="line.3974">                //fn.thisName = name;</a>
<span class="sourceLineNo">3975</span><a id="line.3975"></a>
<span class="sourceLineNo">3976</span><a id="line.3976">                String basename = (enclosingMethod != null ?</a>
<span class="sourceLineNo">3977</span><a id="line.3977">                                  enclosingMethod.objx.name</a>
<span class="sourceLineNo">3978</span><a id="line.3978">                                  : (munge(currentNS().name.name))) + "$";</a>
<span class="sourceLineNo">3979</span><a id="line.3979"></a>
<span class="sourceLineNo">3980</span><a id="line.3980">                Symbol nm = null;</a>
<span class="sourceLineNo">3981</span><a id="line.3981"></a>
<span class="sourceLineNo">3982</span><a id="line.3982">                if(RT.second(form) instanceof Symbol) {</a>
<span class="sourceLineNo">3983</span><a id="line.3983">                        nm = (Symbol) RT.second(form);</a>
<span class="sourceLineNo">3984</span><a id="line.3984">                        name = nm.name + "__" + RT.nextID();</a>
<span class="sourceLineNo">3985</span><a id="line.3985">                } else {</a>
<span class="sourceLineNo">3986</span><a id="line.3986">                        if(name == null)</a>
<span class="sourceLineNo">3987</span><a id="line.3987">                                name = "fn__" + RT.nextID();</a>
<span class="sourceLineNo">3988</span><a id="line.3988">                        else if (enclosingMethod != null)</a>
<span class="sourceLineNo">3989</span><a id="line.3989">                                name += "__" + RT.nextID();</a>
<span class="sourceLineNo">3990</span><a id="line.3990">                }</a>
<span class="sourceLineNo">3991</span><a id="line.3991"></a>
<span class="sourceLineNo">3992</span><a id="line.3992">                String simpleName = munge(name).replace(".", "_DOT_");</a>
<span class="sourceLineNo">3993</span><a id="line.3993"></a>
<span class="sourceLineNo">3994</span><a id="line.3994">                fn.name = basename + simpleName;</a>
<span class="sourceLineNo">3995</span><a id="line.3995">                fn.internalName = fn.name.replace('.', '/');</a>
<span class="sourceLineNo">3996</span><a id="line.3996">                fn.objtype = Type.getObjectType(fn.internalName);</a>
<span class="sourceLineNo">3997</span><a id="line.3997">                ArrayList&lt;String&gt; prims = new ArrayList();</a>
<span class="sourceLineNo">3998</span><a id="line.3998">                try</a>
<span class="sourceLineNo">3999</span><a id="line.3999">                        {</a>
<span class="sourceLineNo">4000</span><a id="line.4000">                        Var.pushThreadBindings(</a>
<span class="sourceLineNo">4001</span><a id="line.4001">                                        RT.mapUniqueKeys(CONSTANTS, PersistentVector.EMPTY,</a>
<span class="sourceLineNo">4002</span><a id="line.4002">                                               CONSTANT_IDS, new IdentityHashMap(),</a>
<span class="sourceLineNo">4003</span><a id="line.4003">                                               KEYWORDS, PersistentHashMap.EMPTY,</a>
<span class="sourceLineNo">4004</span><a id="line.4004">                                               VARS, PersistentHashMap.EMPTY,</a>
<span class="sourceLineNo">4005</span><a id="line.4005">                                               KEYWORD_CALLSITES, PersistentVector.EMPTY,</a>
<span class="sourceLineNo">4006</span><a id="line.4006">                                               PROTOCOL_CALLSITES, PersistentVector.EMPTY,</a>
<span class="sourceLineNo">4007</span><a id="line.4007">                                               VAR_CALLSITES, emptyVarCallSites(),</a>
<span class="sourceLineNo">4008</span><a id="line.4008">                                               NO_RECUR, null</a>
<span class="sourceLineNo">4009</span><a id="line.4009">                                        ));</a>
<span class="sourceLineNo">4010</span><a id="line.4010"></a>
<span class="sourceLineNo">4011</span><a id="line.4011">                        //arglist might be preceded by symbol naming this fn</a>
<span class="sourceLineNo">4012</span><a id="line.4012">                        if(nm != null)</a>
<span class="sourceLineNo">4013</span><a id="line.4013">                                {</a>
<span class="sourceLineNo">4014</span><a id="line.4014">                                fn.thisName = nm.name;</a>
<span class="sourceLineNo">4015</span><a id="line.4015">                                form = RT.cons(FN, RT.next(RT.next(form)));</a>
<span class="sourceLineNo">4016</span><a id="line.4016">                                }</a>
<span class="sourceLineNo">4017</span><a id="line.4017"></a>
<span class="sourceLineNo">4018</span><a id="line.4018">                        //now (fn [args] body...) or (fn ([args] body...) ([args2] body2...) ...)</a>
<span class="sourceLineNo">4019</span><a id="line.4019">                        //turn former into latter</a>
<span class="sourceLineNo">4020</span><a id="line.4020">                        if(RT.second(form) instanceof IPersistentVector)</a>
<span class="sourceLineNo">4021</span><a id="line.4021">                                form = RT.list(FN, RT.next(form));</a>
<span class="sourceLineNo">4022</span><a id="line.4022">                        fn.line = lineDeref();</a>
<span class="sourceLineNo">4023</span><a id="line.4023">                        fn.column = columnDeref();</a>
<span class="sourceLineNo">4024</span><a id="line.4024">                        FnMethod[] methodArray = new FnMethod[MAX_POSITIONAL_ARITY + 1];</a>
<span class="sourceLineNo">4025</span><a id="line.4025">                        FnMethod variadicMethod = null;</a>
<span class="sourceLineNo">4026</span><a id="line.4026">                        boolean usesThis = false;</a>
<span class="sourceLineNo">4027</span><a id="line.4027">                        for(ISeq s = RT.next(form); s != null; s = RT.next(s))</a>
<span class="sourceLineNo">4028</span><a id="line.4028">                                {</a>
<span class="sourceLineNo">4029</span><a id="line.4029">                                FnMethod f = FnMethod.parse(fn, (ISeq) RT.first(s), rettag);</a>
<span class="sourceLineNo">4030</span><a id="line.4030">                                if(f.usesThis)</a>
<span class="sourceLineNo">4031</span><a id="line.4031">                                        {</a>
<span class="sourceLineNo">4032</span><a id="line.4032">//                                      System.out.println(fn.name + " use this");</a>
<span class="sourceLineNo">4033</span><a id="line.4033">                                        usesThis = true;</a>
<span class="sourceLineNo">4034</span><a id="line.4034">                                        }</a>
<span class="sourceLineNo">4035</span><a id="line.4035">                                if(f.isVariadic())</a>
<span class="sourceLineNo">4036</span><a id="line.4036">                                        {</a>
<span class="sourceLineNo">4037</span><a id="line.4037">                                        if(variadicMethod == null)</a>
<span class="sourceLineNo">4038</span><a id="line.4038">                                                variadicMethod = f;</a>
<span class="sourceLineNo">4039</span><a id="line.4039">                                        else</a>
<span class="sourceLineNo">4040</span><a id="line.4040">                                                throw Util.runtimeException("Can't have more than 1 variadic overload");</a>
<span class="sourceLineNo">4041</span><a id="line.4041">                                        }</a>
<span class="sourceLineNo">4042</span><a id="line.4042">                                else if(methodArray[f.reqParms.count()] == null)</a>
<span class="sourceLineNo">4043</span><a id="line.4043">                                        methodArray[f.reqParms.count()] = f;</a>
<span class="sourceLineNo">4044</span><a id="line.4044">                                else</a>
<span class="sourceLineNo">4045</span><a id="line.4045">                                        throw Util.runtimeException("Can't have 2 overloads with same arity");</a>
<span class="sourceLineNo">4046</span><a id="line.4046">                                if(f.prim != null)</a>
<span class="sourceLineNo">4047</span><a id="line.4047">                                        prims.add(f.prim);</a>
<span class="sourceLineNo">4048</span><a id="line.4048">                                }</a>
<span class="sourceLineNo">4049</span><a id="line.4049">                        if(variadicMethod != null)</a>
<span class="sourceLineNo">4050</span><a id="line.4050">                                {</a>
<span class="sourceLineNo">4051</span><a id="line.4051">                                for(int i = variadicMethod.reqParms.count() + 1; i &lt;= MAX_POSITIONAL_ARITY; i++)</a>
<span class="sourceLineNo">4052</span><a id="line.4052">                                        if(methodArray[i] != null)</a>
<span class="sourceLineNo">4053</span><a id="line.4053">                                                throw Util.runtimeException(</a>
<span class="sourceLineNo">4054</span><a id="line.4054">                                                                "Can't have fixed arity function with more params than variadic function");</a>
<span class="sourceLineNo">4055</span><a id="line.4055">                                }</a>
<span class="sourceLineNo">4056</span><a id="line.4056"></a>
<span class="sourceLineNo">4057</span><a id="line.4057">                        fn.canBeDirect = !fn.hasEnclosingMethod &amp;&amp; fn.closes.count() == 0 &amp;&amp; !usesThis;</a>
<span class="sourceLineNo">4058</span><a id="line.4058"></a>
<span class="sourceLineNo">4059</span><a id="line.4059">                        IPersistentCollection methods = null;</a>
<span class="sourceLineNo">4060</span><a id="line.4060">                        for(int i = 0; i &lt; methodArray.length; i++)</a>
<span class="sourceLineNo">4061</span><a id="line.4061">                                if(methodArray[i] != null)</a>
<span class="sourceLineNo">4062</span><a id="line.4062">                                        methods = RT.conj(methods, methodArray[i]);</a>
<span class="sourceLineNo">4063</span><a id="line.4063">                        if(variadicMethod != null)</a>
<span class="sourceLineNo">4064</span><a id="line.4064">                                methods = RT.conj(methods, variadicMethod);</a>
<span class="sourceLineNo">4065</span><a id="line.4065"></a>
<span class="sourceLineNo">4066</span><a id="line.4066">                        if(fn.canBeDirect){</a>
<span class="sourceLineNo">4067</span><a id="line.4067">                                for(FnMethod fm : (Collection&lt;FnMethod&gt;)methods)</a>
<span class="sourceLineNo">4068</span><a id="line.4068">                                        {</a>
<span class="sourceLineNo">4069</span><a id="line.4069">                                        if(fm.locals != null)</a>
<span class="sourceLineNo">4070</span><a id="line.4070">                                                {</a>
<span class="sourceLineNo">4071</span><a id="line.4071">                                                for(LocalBinding lb : (Collection&lt;LocalBinding&gt;)RT.keys(fm.locals))</a>
<span class="sourceLineNo">4072</span><a id="line.4072">                                                        {</a>
<span class="sourceLineNo">4073</span><a id="line.4073">                                                        if(lb.isArg)</a>
<span class="sourceLineNo">4074</span><a id="line.4074">                                                                lb.idx -= 1;</a>
<span class="sourceLineNo">4075</span><a id="line.4075">                                                        }</a>
<span class="sourceLineNo">4076</span><a id="line.4076">                                                }</a>
<span class="sourceLineNo">4077</span><a id="line.4077">                                        }</a>
<span class="sourceLineNo">4078</span><a id="line.4078">                                }</a>
<span class="sourceLineNo">4079</span><a id="line.4079"></a>
<span class="sourceLineNo">4080</span><a id="line.4080">                        fn.methods = methods;</a>
<span class="sourceLineNo">4081</span><a id="line.4081">                        fn.variadicMethod = variadicMethod;</a>
<span class="sourceLineNo">4082</span><a id="line.4082">                        fn.keywords = (IPersistentMap) KEYWORDS.deref();</a>
<span class="sourceLineNo">4083</span><a id="line.4083">                        fn.vars = (IPersistentMap) VARS.deref();</a>
<span class="sourceLineNo">4084</span><a id="line.4084">                        fn.constants = (PersistentVector) CONSTANTS.deref();</a>
<span class="sourceLineNo">4085</span><a id="line.4085">                        fn.keywordCallsites = (IPersistentVector) KEYWORD_CALLSITES.deref();</a>
<span class="sourceLineNo">4086</span><a id="line.4086">                        fn.protocolCallsites = (IPersistentVector) PROTOCOL_CALLSITES.deref();</a>
<span class="sourceLineNo">4087</span><a id="line.4087">                        fn.varCallsites = (IPersistentSet) VAR_CALLSITES.deref();</a>
<span class="sourceLineNo">4088</span><a id="line.4088"></a>
<span class="sourceLineNo">4089</span><a id="line.4089">                        fn.constantsID = RT.nextID();</a>
<span class="sourceLineNo">4090</span><a id="line.4090">//                      DynamicClassLoader loader = (DynamicClassLoader) LOADER.get();</a>
<span class="sourceLineNo">4091</span><a id="line.4091">//                      loader.registerConstants(fn.constantsID, fn.constants.toArray());</a>
<span class="sourceLineNo">4092</span><a id="line.4092">                        }</a>
<span class="sourceLineNo">4093</span><a id="line.4093">                finally</a>
<span class="sourceLineNo">4094</span><a id="line.4094">                        {</a>
<span class="sourceLineNo">4095</span><a id="line.4095">                        Var.popThreadBindings();</a>
<span class="sourceLineNo">4096</span><a id="line.4096">                        }</a>
<span class="sourceLineNo">4097</span><a id="line.4097">                fn.hasPrimSigs = prims.size() &gt; 0;</a>
<span class="sourceLineNo">4098</span><a id="line.4098">                IPersistentMap fmeta = RT.meta(origForm);</a>
<span class="sourceLineNo">4099</span><a id="line.4099">                if(fmeta != null)</a>
<span class="sourceLineNo">4100</span><a id="line.4100">                        fmeta = fmeta.without(RT.LINE_KEY).without(RT.COLUMN_KEY).without(RT.FILE_KEY).without(retkey);</a>
<span class="sourceLineNo">4101</span><a id="line.4101"></a>
<span class="sourceLineNo">4102</span><a id="line.4102">                fn.hasMeta = RT.count(fmeta) &gt; 0;</a>
<span class="sourceLineNo">4103</span><a id="line.4103"></a>
<span class="sourceLineNo">4104</span><a id="line.4104">                try</a>
<span class="sourceLineNo">4105</span><a id="line.4105">                        {</a>
<span class="sourceLineNo">4106</span><a id="line.4106">                        fn.compile(fn.isVariadic() ? "clojure/lang/RestFn" : "clojure/lang/AFunction",</a>
<span class="sourceLineNo">4107</span><a id="line.4107">                                   (prims.size() == 0)?</a>
<span class="sourceLineNo">4108</span><a id="line.4108">                                    null</a>
<span class="sourceLineNo">4109</span><a id="line.4109">                                                :prims.toArray(new String[prims.size()]),</a>
<span class="sourceLineNo">4110</span><a id="line.4110">                                    fn.onceOnly);</a>
<span class="sourceLineNo">4111</span><a id="line.4111">                        }</a>
<span class="sourceLineNo">4112</span><a id="line.4112">                catch(IOException e)</a>
<span class="sourceLineNo">4113</span><a id="line.4113">                        {</a>
<span class="sourceLineNo">4114</span><a id="line.4114">                        throw Util.sneakyThrow(e);</a>
<span class="sourceLineNo">4115</span><a id="line.4115">                        }</a>
<span class="sourceLineNo">4116</span><a id="line.4116">                fn.getCompiledClass();</a>
<span class="sourceLineNo">4117</span><a id="line.4117"></a>
<span class="sourceLineNo">4118</span><a id="line.4118">                if(fn.supportsMeta())</a>
<span class="sourceLineNo">4119</span><a id="line.4119">                        {</a>
<span class="sourceLineNo">4120</span><a id="line.4120">                        //System.err.println(name + " supports meta");</a>
<span class="sourceLineNo">4121</span><a id="line.4121">                        return new MetaExpr(fn, MapExpr</a>
<span class="sourceLineNo">4122</span><a id="line.4122">                                        .parse(context == C.EVAL ? context : C.EXPRESSION, fmeta));</a>
<span class="sourceLineNo">4123</span><a id="line.4123">                        }</a>
<span class="sourceLineNo">4124</span><a id="line.4124">                else</a>
<span class="sourceLineNo">4125</span><a id="line.4125">                        return fn;</a>
<span class="sourceLineNo">4126</span><a id="line.4126">        }</a>
<span class="sourceLineNo">4127</span><a id="line.4127"></a>
<span class="sourceLineNo">4128</span><a id="line.4128">        public final ObjMethod variadicMethod(){</a>
<span class="sourceLineNo">4129</span><a id="line.4129">                return variadicMethod;</a>
<span class="sourceLineNo">4130</span><a id="line.4130">        }</a>
<span class="sourceLineNo">4131</span><a id="line.4131"></a>
<span class="sourceLineNo">4132</span><a id="line.4132">        boolean isVariadic(){</a>
<span class="sourceLineNo">4133</span><a id="line.4133">                return variadicMethod != null;</a>
<span class="sourceLineNo">4134</span><a id="line.4134">        }</a>
<span class="sourceLineNo">4135</span><a id="line.4135"></a>
<span class="sourceLineNo">4136</span><a id="line.4136">        public final IPersistentCollection methods(){</a>
<span class="sourceLineNo">4137</span><a id="line.4137">                return methods;</a>
<span class="sourceLineNo">4138</span><a id="line.4138">        }</a>
<span class="sourceLineNo">4139</span><a id="line.4139"></a>
<span class="sourceLineNo">4140</span><a id="line.4140">        public void emitForDefn(ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">4141</span><a id="line.4141">//              if(!hasPrimSigs &amp;&amp; closes.count() == 0)</a>
<span class="sourceLineNo">4142</span><a id="line.4142">//                      {</a>
<span class="sourceLineNo">4143</span><a id="line.4143">//                      Type thunkType = Type.getType(FnLoaderThunk.class);</a>
<span class="sourceLineNo">4144</span><a id="line.4144">////                    presumes var on stack</a>
<span class="sourceLineNo">4145</span><a id="line.4145">//                      gen.dup();</a>
<span class="sourceLineNo">4146</span><a id="line.4146">//                      gen.newInstance(thunkType);</a>
<span class="sourceLineNo">4147</span><a id="line.4147">//                      gen.dupX1();</a>
<span class="sourceLineNo">4148</span><a id="line.4148">//                      gen.swap();</a>
<span class="sourceLineNo">4149</span><a id="line.4149">//                      gen.push(internalName.replace('/','.'));</a>
<span class="sourceLineNo">4150</span><a id="line.4150">//                      gen.invokeConstructor(thunkType,Method.getMethod("void &lt;init&gt;(clojure.lang.Var,String)"));</a>
<span class="sourceLineNo">4151</span><a id="line.4151">//                      }</a>
<span class="sourceLineNo">4152</span><a id="line.4152">//              else</a>
<span class="sourceLineNo">4153</span><a id="line.4153">                        emit(C.EXPRESSION,objx,gen);</a>
<span class="sourceLineNo">4154</span><a id="line.4154">        }</a>
<span class="sourceLineNo">4155</span><a id="line.4155">}</a>
<span class="sourceLineNo">4156</span><a id="line.4156"></a>
<span class="sourceLineNo">4157</span><a id="line.4157">static public class ObjExpr implements Expr{</a>
<span class="sourceLineNo">4158</span><a id="line.4158">        static final String CONST_PREFIX = "const__";</a>
<span class="sourceLineNo">4159</span><a id="line.4159">        String name;</a>
<span class="sourceLineNo">4160</span><a id="line.4160">        //String simpleName;</a>
<span class="sourceLineNo">4161</span><a id="line.4161">        String internalName;</a>
<span class="sourceLineNo">4162</span><a id="line.4162">        String thisName;</a>
<span class="sourceLineNo">4163</span><a id="line.4163">        Type objtype;</a>
<span class="sourceLineNo">4164</span><a id="line.4164">        public final Object tag;</a>
<span class="sourceLineNo">4165</span><a id="line.4165">        //localbinding-&gt;itself</a>
<span class="sourceLineNo">4166</span><a id="line.4166">        IPersistentMap closes = PersistentHashMap.EMPTY;</a>
<span class="sourceLineNo">4167</span><a id="line.4167">    //localbndingexprs</a>
<span class="sourceLineNo">4168</span><a id="line.4168">    IPersistentVector closesExprs = PersistentVector.EMPTY;</a>
<span class="sourceLineNo">4169</span><a id="line.4169">        //symbols</a>
<span class="sourceLineNo">4170</span><a id="line.4170">        IPersistentSet volatiles = PersistentHashSet.EMPTY;</a>
<span class="sourceLineNo">4171</span><a id="line.4171"></a>
<span class="sourceLineNo">4172</span><a id="line.4172">        //symbol-&gt;lb</a>
<span class="sourceLineNo">4173</span><a id="line.4173">        IPersistentMap fields = null;</a>
<span class="sourceLineNo">4174</span><a id="line.4174"></a>
<span class="sourceLineNo">4175</span><a id="line.4175">        //hinted fields</a>
<span class="sourceLineNo">4176</span><a id="line.4176">        IPersistentVector hintedFields = PersistentVector.EMPTY;</a>
<span class="sourceLineNo">4177</span><a id="line.4177"></a>
<span class="sourceLineNo">4178</span><a id="line.4178">        //Keyword-&gt;KeywordExpr</a>
<span class="sourceLineNo">4179</span><a id="line.4179">        IPersistentMap keywords = PersistentHashMap.EMPTY;</a>
<span class="sourceLineNo">4180</span><a id="line.4180">        IPersistentMap vars = PersistentHashMap.EMPTY;</a>
<span class="sourceLineNo">4181</span><a id="line.4181">        Class compiledClass;</a>
<span class="sourceLineNo">4182</span><a id="line.4182">        int line;</a>
<span class="sourceLineNo">4183</span><a id="line.4183">        int column;</a>
<span class="sourceLineNo">4184</span><a id="line.4184">        PersistentVector constants;</a>
<span class="sourceLineNo">4185</span><a id="line.4185">    IPersistentSet usedConstants = PersistentHashSet.EMPTY;</a>
<span class="sourceLineNo">4186</span><a id="line.4186"></a>
<span class="sourceLineNo">4187</span><a id="line.4187">        int constantsID;</a>
<span class="sourceLineNo">4188</span><a id="line.4188">        int altCtorDrops = 0;</a>
<span class="sourceLineNo">4189</span><a id="line.4189"></a>
<span class="sourceLineNo">4190</span><a id="line.4190">        IPersistentVector keywordCallsites;</a>
<span class="sourceLineNo">4191</span><a id="line.4191">        IPersistentVector protocolCallsites;</a>
<span class="sourceLineNo">4192</span><a id="line.4192">        IPersistentSet varCallsites;</a>
<span class="sourceLineNo">4193</span><a id="line.4193">        boolean onceOnly = false;</a>
<span class="sourceLineNo">4194</span><a id="line.4194"></a>
<span class="sourceLineNo">4195</span><a id="line.4195">        Object src;</a>
<span class="sourceLineNo">4196</span><a id="line.4196"></a>
<span class="sourceLineNo">4197</span><a id="line.4197">    IPersistentMap opts = PersistentHashMap.EMPTY;</a>
<span class="sourceLineNo">4198</span><a id="line.4198"></a>
<span class="sourceLineNo">4199</span><a id="line.4199">        final static Method voidctor = Method.getMethod("void &lt;init&gt;()");</a>
<span class="sourceLineNo">4200</span><a id="line.4200">        protected IPersistentMap classMeta;</a>
<span class="sourceLineNo">4201</span><a id="line.4201">        protected boolean canBeDirect;</a>
<span class="sourceLineNo">4202</span><a id="line.4202"></a>
<span class="sourceLineNo">4203</span><a id="line.4203">        public final String name(){</a>
<span class="sourceLineNo">4204</span><a id="line.4204">                return name;</a>
<span class="sourceLineNo">4205</span><a id="line.4205">        }</a>
<span class="sourceLineNo">4206</span><a id="line.4206"></a>
<span class="sourceLineNo">4207</span><a id="line.4207">//      public final String simpleName(){</a>
<span class="sourceLineNo">4208</span><a id="line.4208">//              return simpleName;</a>
<span class="sourceLineNo">4209</span><a id="line.4209">//      }</a>
<span class="sourceLineNo">4210</span><a id="line.4210"></a>
<span class="sourceLineNo">4211</span><a id="line.4211">        public final String internalName(){</a>
<span class="sourceLineNo">4212</span><a id="line.4212">                return internalName;</a>
<span class="sourceLineNo">4213</span><a id="line.4213">        }</a>
<span class="sourceLineNo">4214</span><a id="line.4214"></a>
<span class="sourceLineNo">4215</span><a id="line.4215">        public final String thisName(){</a>
<span class="sourceLineNo">4216</span><a id="line.4216">                return thisName;</a>
<span class="sourceLineNo">4217</span><a id="line.4217">        }</a>
<span class="sourceLineNo">4218</span><a id="line.4218"></a>
<span class="sourceLineNo">4219</span><a id="line.4219">        public final Type objtype(){</a>
<span class="sourceLineNo">4220</span><a id="line.4220">                return objtype;</a>
<span class="sourceLineNo">4221</span><a id="line.4221">        }</a>
<span class="sourceLineNo">4222</span><a id="line.4222"></a>
<span class="sourceLineNo">4223</span><a id="line.4223">        public final IPersistentMap closes(){</a>
<span class="sourceLineNo">4224</span><a id="line.4224">                return closes;</a>
<span class="sourceLineNo">4225</span><a id="line.4225">        }</a>
<span class="sourceLineNo">4226</span><a id="line.4226"></a>
<span class="sourceLineNo">4227</span><a id="line.4227">        public final IPersistentMap keywords(){</a>
<span class="sourceLineNo">4228</span><a id="line.4228">                return keywords;</a>
<span class="sourceLineNo">4229</span><a id="line.4229">        }</a>
<span class="sourceLineNo">4230</span><a id="line.4230"></a>
<span class="sourceLineNo">4231</span><a id="line.4231">        public final IPersistentMap vars(){</a>
<span class="sourceLineNo">4232</span><a id="line.4232">                return vars;</a>
<span class="sourceLineNo">4233</span><a id="line.4233">        }</a>
<span class="sourceLineNo">4234</span><a id="line.4234"></a>
<span class="sourceLineNo">4235</span><a id="line.4235">        public final Class compiledClass(){</a>
<span class="sourceLineNo">4236</span><a id="line.4236">                return compiledClass;</a>
<span class="sourceLineNo">4237</span><a id="line.4237">        }</a>
<span class="sourceLineNo">4238</span><a id="line.4238"></a>
<span class="sourceLineNo">4239</span><a id="line.4239">        public final int line(){</a>
<span class="sourceLineNo">4240</span><a id="line.4240">                return line;</a>
<span class="sourceLineNo">4241</span><a id="line.4241">        }</a>
<span class="sourceLineNo">4242</span><a id="line.4242"></a>
<span class="sourceLineNo">4243</span><a id="line.4243">        public final int column(){</a>
<span class="sourceLineNo">4244</span><a id="line.4244">                return column;</a>
<span class="sourceLineNo">4245</span><a id="line.4245">        }</a>
<span class="sourceLineNo">4246</span><a id="line.4246"></a>
<span class="sourceLineNo">4247</span><a id="line.4247">        public final PersistentVector constants(){</a>
<span class="sourceLineNo">4248</span><a id="line.4248">                return constants;</a>
<span class="sourceLineNo">4249</span><a id="line.4249">        }</a>
<span class="sourceLineNo">4250</span><a id="line.4250"></a>
<span class="sourceLineNo">4251</span><a id="line.4251">        public final int constantsID(){</a>
<span class="sourceLineNo">4252</span><a id="line.4252">                return constantsID;</a>
<span class="sourceLineNo">4253</span><a id="line.4253">        }</a>
<span class="sourceLineNo">4254</span><a id="line.4254"></a>
<span class="sourceLineNo">4255</span><a id="line.4255">        final static Method kwintern = Method.getMethod("clojure.lang.Keyword intern(String, String)");</a>
<span class="sourceLineNo">4256</span><a id="line.4256">        final static Method symintern = Method.getMethod("clojure.lang.Symbol intern(String)");</a>
<span class="sourceLineNo">4257</span><a id="line.4257">        final static Method varintern =</a>
<span class="sourceLineNo">4258</span><a id="line.4258">                        Method.getMethod("clojure.lang.Var intern(clojure.lang.Symbol, clojure.lang.Symbol)");</a>
<span class="sourceLineNo">4259</span><a id="line.4259"></a>
<span class="sourceLineNo">4260</span><a id="line.4260">        final static Type DYNAMIC_CLASSLOADER_TYPE = Type.getType(DynamicClassLoader.class);</a>
<span class="sourceLineNo">4261</span><a id="line.4261">        final static Method getClassMethod = Method.getMethod("Class getClass()");</a>
<span class="sourceLineNo">4262</span><a id="line.4262">        final static Method getClassLoaderMethod = Method.getMethod("ClassLoader getClassLoader()");</a>
<span class="sourceLineNo">4263</span><a id="line.4263">        final static Method getConstantsMethod = Method.getMethod("Object[] getConstants(int)");</a>
<span class="sourceLineNo">4264</span><a id="line.4264">        final static Method readStringMethod = Method.getMethod("Object readString(String)");</a>
<span class="sourceLineNo">4265</span><a id="line.4265"></a>
<span class="sourceLineNo">4266</span><a id="line.4266">        final static Type ILOOKUP_SITE_TYPE = Type.getType(ILookupSite.class);</a>
<span class="sourceLineNo">4267</span><a id="line.4267">        final static Type ILOOKUP_THUNK_TYPE = Type.getType(ILookupThunk.class);</a>
<span class="sourceLineNo">4268</span><a id="line.4268">        final static Type KEYWORD_LOOKUPSITE_TYPE = Type.getType(KeywordLookupSite.class);</a>
<span class="sourceLineNo">4269</span><a id="line.4269"></a>
<span class="sourceLineNo">4270</span><a id="line.4270">        private DynamicClassLoader loader;</a>
<span class="sourceLineNo">4271</span><a id="line.4271">        private byte[] bytecode;</a>
<span class="sourceLineNo">4272</span><a id="line.4272"></a>
<span class="sourceLineNo">4273</span><a id="line.4273">        public ObjExpr(Object tag){</a>
<span class="sourceLineNo">4274</span><a id="line.4274">                this.tag = tag;</a>
<span class="sourceLineNo">4275</span><a id="line.4275">        }</a>
<span class="sourceLineNo">4276</span><a id="line.4276"></a>
<span class="sourceLineNo">4277</span><a id="line.4277">        static String trimGenID(String name){</a>
<span class="sourceLineNo">4278</span><a id="line.4278">                int i = name.lastIndexOf("__");</a>
<span class="sourceLineNo">4279</span><a id="line.4279">                return i==-1?name:name.substring(0,i);</a>
<span class="sourceLineNo">4280</span><a id="line.4280">        }</a>
<span class="sourceLineNo">4281</span><a id="line.4281">        </a>
<span class="sourceLineNo">4282</span><a id="line.4282"></a>
<span class="sourceLineNo">4283</span><a id="line.4283"></a>
<span class="sourceLineNo">4284</span><a id="line.4284">        Type[] ctorTypes(){</a>
<span class="sourceLineNo">4285</span><a id="line.4285">                IPersistentVector tv = !supportsMeta()?PersistentVector.EMPTY:RT.vector(IPERSISTENTMAP_TYPE);</a>
<span class="sourceLineNo">4286</span><a id="line.4286">                for(ISeq s = RT.keys(closes); s != null; s = s.next())</a>
<span class="sourceLineNo">4287</span><a id="line.4287">                        {</a>
<span class="sourceLineNo">4288</span><a id="line.4288">                        LocalBinding lb = (LocalBinding) s.first();</a>
<span class="sourceLineNo">4289</span><a id="line.4289">                        if(lb.getPrimitiveType() != null)</a>
<span class="sourceLineNo">4290</span><a id="line.4290">                                tv = tv.cons(Type.getType(lb.getPrimitiveType()));</a>
<span class="sourceLineNo">4291</span><a id="line.4291">                        else</a>
<span class="sourceLineNo">4292</span><a id="line.4292">                                tv = tv.cons(OBJECT_TYPE);</a>
<span class="sourceLineNo">4293</span><a id="line.4293">                        }</a>
<span class="sourceLineNo">4294</span><a id="line.4294">                Type[] ret = new Type[tv.count()];</a>
<span class="sourceLineNo">4295</span><a id="line.4295">                for(int i = 0; i &lt; tv.count(); i++)</a>
<span class="sourceLineNo">4296</span><a id="line.4296">                        ret[i] = (Type) tv.nth(i);</a>
<span class="sourceLineNo">4297</span><a id="line.4297">                return ret;</a>
<span class="sourceLineNo">4298</span><a id="line.4298">        }</a>
<span class="sourceLineNo">4299</span><a id="line.4299"></a>
<span class="sourceLineNo">4300</span><a id="line.4300">        void compile(String superName, String[] interfaceNames, boolean oneTimeUse) throws IOException{</a>
<span class="sourceLineNo">4301</span><a id="line.4301">                //create bytecode for a class</a>
<span class="sourceLineNo">4302</span><a id="line.4302">                //with name current_ns.defname[$letname]+</a>
<span class="sourceLineNo">4303</span><a id="line.4303">                //anonymous fns get names fn__id</a>
<span class="sourceLineNo">4304</span><a id="line.4304">                //derived from AFn/RestFn</a>
<span class="sourceLineNo">4305</span><a id="line.4305">                ClassWriter cw = classWriter();</a>
<span class="sourceLineNo">4306</span><a id="line.4306">//              ClassWriter cw = new ClassWriter(0);</a>
<span class="sourceLineNo">4307</span><a id="line.4307">                ClassVisitor cv = cw;</a>
<span class="sourceLineNo">4308</span><a id="line.4308">//              ClassVisitor cv = new TraceClassVisitor(new CheckClassAdapter(cw), new PrintWriter(System.out));</a>
<span class="sourceLineNo">4309</span><a id="line.4309">                //ClassVisitor cv = new TraceClassVisitor(cw, new PrintWriter(System.out));</a>
<span class="sourceLineNo">4310</span><a id="line.4310">                cv.visit(V1_8, ACC_PUBLIC + ACC_SUPER + ACC_FINAL, internalName, null,superName,interfaceNames);</a>
<span class="sourceLineNo">4311</span><a id="line.4311">//                       superName != null ? superName :</a>
<span class="sourceLineNo">4312</span><a id="line.4312">//                       (isVariadic() ? "clojure/lang/RestFn" : "clojure/lang/AFunction"), null);</a>
<span class="sourceLineNo">4313</span><a id="line.4313">                String source = (String) SOURCE.deref();</a>
<span class="sourceLineNo">4314</span><a id="line.4314">                int lineBefore = (Integer) LINE_BEFORE.deref();</a>
<span class="sourceLineNo">4315</span><a id="line.4315">                int lineAfter = (Integer) LINE_AFTER.deref() + 1;</a>
<span class="sourceLineNo">4316</span><a id="line.4316">                int columnBefore = (Integer) COLUMN_BEFORE.deref();</a>
<span class="sourceLineNo">4317</span><a id="line.4317">                int columnAfter = (Integer) COLUMN_AFTER.deref() + 1;</a>
<span class="sourceLineNo">4318</span><a id="line.4318"></a>
<span class="sourceLineNo">4319</span><a id="line.4319">                if(source != null &amp;&amp; SOURCE_PATH.deref() != null)</a>
<span class="sourceLineNo">4320</span><a id="line.4320">                        {</a>
<span class="sourceLineNo">4321</span><a id="line.4321">                        //cv.visitSource(source, null);</a>
<span class="sourceLineNo">4322</span><a id="line.4322">                        String smap = "SMAP\n" +</a>
<span class="sourceLineNo">4323</span><a id="line.4323">                                      ((source.lastIndexOf('.') &gt; 0) ?</a>
<span class="sourceLineNo">4324</span><a id="line.4324">                                       source.substring(0, source.lastIndexOf('.'))</a>
<span class="sourceLineNo">4325</span><a id="line.4325">                                        :source)</a>
<span class="sourceLineNo">4326</span><a id="line.4326">                                               //                      : simpleName)</a>
<span class="sourceLineNo">4327</span><a id="line.4327">                                      + ".java\n" +</a>
<span class="sourceLineNo">4328</span><a id="line.4328">                                      "Clojure\n" +</a>
<span class="sourceLineNo">4329</span><a id="line.4329">                                      "*S Clojure\n" +</a>
<span class="sourceLineNo">4330</span><a id="line.4330">                                      "*F\n" +</a>
<span class="sourceLineNo">4331</span><a id="line.4331">                                      "+ 1 " + source + "\n" +</a>
<span class="sourceLineNo">4332</span><a id="line.4332">                                      (String) SOURCE_PATH.deref() + "\n" +</a>
<span class="sourceLineNo">4333</span><a id="line.4333">                                      "*L\n" +</a>
<span class="sourceLineNo">4334</span><a id="line.4334">                                      String.format("%d#1,%d:%d\n", lineBefore, lineAfter - lineBefore, lineBefore) +</a>
<span class="sourceLineNo">4335</span><a id="line.4335">                                      "*E";</a>
<span class="sourceLineNo">4336</span><a id="line.4336">                        cv.visitSource(source, smap);</a>
<span class="sourceLineNo">4337</span><a id="line.4337">                        }</a>
<span class="sourceLineNo">4338</span><a id="line.4338">                addAnnotation(cv, classMeta);</a>
<span class="sourceLineNo">4339</span><a id="line.4339"></a>
<span class="sourceLineNo">4340</span><a id="line.4340"></a>
<span class="sourceLineNo">4341</span><a id="line.4341">//              for(int i=0;i&lt;varCallsites.count();i++)</a>
<span class="sourceLineNo">4342</span><a id="line.4342">//                      {</a>
<span class="sourceLineNo">4343</span><a id="line.4343">//                      cv.visitField(ACC_PRIVATE + ACC_STATIC + ACC_FINAL</a>
<span class="sourceLineNo">4344</span><a id="line.4344">//                                      , varCallsiteName(i), IFN_TYPE.getDescriptor(), null, null);</a>
<span class="sourceLineNo">4345</span><a id="line.4345">//                      }</a>
<span class="sourceLineNo">4346</span><a id="line.4346"></a>
<span class="sourceLineNo">4347</span><a id="line.4347"></a>
<span class="sourceLineNo">4348</span><a id="line.4348">                if(supportsMeta())</a>
<span class="sourceLineNo">4349</span><a id="line.4349">                        {</a>
<span class="sourceLineNo">4350</span><a id="line.4350">                        cv.visitField(ACC_FINAL, "__meta", IPERSISTENTMAP_TYPE.getDescriptor(), null, null);</a>
<span class="sourceLineNo">4351</span><a id="line.4351">                        }</a>
<span class="sourceLineNo">4352</span><a id="line.4352">                //instance fields for closed-overs</a>
<span class="sourceLineNo">4353</span><a id="line.4353">                for(ISeq s = RT.keys(closes); s != null; s = s.next())</a>
<span class="sourceLineNo">4354</span><a id="line.4354">                        {</a>
<span class="sourceLineNo">4355</span><a id="line.4355">                        LocalBinding lb = (LocalBinding) s.first();</a>
<span class="sourceLineNo">4356</span><a id="line.4356">                        if(isDeftype())</a>
<span class="sourceLineNo">4357</span><a id="line.4357">                                {</a>
<span class="sourceLineNo">4358</span><a id="line.4358">                                int access = isVolatile(lb) ? ACC_VOLATILE :</a>
<span class="sourceLineNo">4359</span><a id="line.4359">                                             isMutable(lb) ? 0 :</a>
<span class="sourceLineNo">4360</span><a id="line.4360">                                             (ACC_PUBLIC + ACC_FINAL);</a>
<span class="sourceLineNo">4361</span><a id="line.4361">                                FieldVisitor fv;</a>
<span class="sourceLineNo">4362</span><a id="line.4362">                                if(lb.getPrimitiveType() != null)</a>
<span class="sourceLineNo">4363</span><a id="line.4363">                                        fv = cv.visitField(access</a>
<span class="sourceLineNo">4364</span><a id="line.4364">                                                        , lb.name, Type.getType(lb.getPrimitiveType()).getDescriptor(),</a>
<span class="sourceLineNo">4365</span><a id="line.4365">                                                                  null, null);</a>
<span class="sourceLineNo">4366</span><a id="line.4366">                                else</a>
<span class="sourceLineNo">4367</span><a id="line.4367">                                //todo - when closed-overs are fields, use more specific types here and in ctor and emitLocal?</a>
<span class="sourceLineNo">4368</span><a id="line.4368">                                        fv = cv.visitField(access</a>
<span class="sourceLineNo">4369</span><a id="line.4369">                                                        , lb.name, OBJECT_TYPE.getDescriptor(), null, null);</a>
<span class="sourceLineNo">4370</span><a id="line.4370">                                addAnnotation(fv, RT.meta(lb.sym));</a>
<span class="sourceLineNo">4371</span><a id="line.4371">                                }</a>
<span class="sourceLineNo">4372</span><a id="line.4372">                        else</a>
<span class="sourceLineNo">4373</span><a id="line.4373">                                {</a>
<span class="sourceLineNo">4374</span><a id="line.4374">                                //todo - only enable this non-private+writability for letfns where we need it</a>
<span class="sourceLineNo">4375</span><a id="line.4375">                                if(lb.getPrimitiveType() != null)</a>
<span class="sourceLineNo">4376</span><a id="line.4376">                                        cv.visitField(0 + (isVolatile(lb) ? ACC_VOLATILE : 0)</a>
<span class="sourceLineNo">4377</span><a id="line.4377">                                                        , lb.name, Type.getType(lb.getPrimitiveType()).getDescriptor(),</a>
<span class="sourceLineNo">4378</span><a id="line.4378">                                                                  null, null);</a>
<span class="sourceLineNo">4379</span><a id="line.4379">                                else</a>
<span class="sourceLineNo">4380</span><a id="line.4380">                                        cv.visitField(0 //+ (oneTimeUse ? 0 : ACC_FINAL)</a>
<span class="sourceLineNo">4381</span><a id="line.4381">                                                        , lb.name, OBJECT_TYPE.getDescriptor(), null, null);</a>
<span class="sourceLineNo">4382</span><a id="line.4382">                                }</a>
<span class="sourceLineNo">4383</span><a id="line.4383">                        }</a>
<span class="sourceLineNo">4384</span><a id="line.4384"></a>
<span class="sourceLineNo">4385</span><a id="line.4385">                //static fields for callsites and thunks</a>
<span class="sourceLineNo">4386</span><a id="line.4386">                for(int i=0;i&lt;protocolCallsites.count();i++)</a>
<span class="sourceLineNo">4387</span><a id="line.4387">                        {</a>
<span class="sourceLineNo">4388</span><a id="line.4388">                        cv.visitField(ACC_PRIVATE + ACC_STATIC, cachedClassName(i), CLASS_TYPE.getDescriptor(), null, null);</a>
<span class="sourceLineNo">4389</span><a id="line.4389">                        }</a>
<span class="sourceLineNo">4390</span><a id="line.4390"></a>
<span class="sourceLineNo">4391</span><a id="line.4391">                //ctor that takes closed-overs and inits base + fields</a>
<span class="sourceLineNo">4392</span><a id="line.4392">                Method m = new Method("&lt;init&gt;", Type.VOID_TYPE, ctorTypes());</a>
<span class="sourceLineNo">4393</span><a id="line.4393">                GeneratorAdapter ctorgen = new GeneratorAdapter(ACC_PUBLIC,</a>
<span class="sourceLineNo">4394</span><a id="line.4394">                                                                m,</a>
<span class="sourceLineNo">4395</span><a id="line.4395">                                                                null,</a>
<span class="sourceLineNo">4396</span><a id="line.4396">                                                                null,</a>
<span class="sourceLineNo">4397</span><a id="line.4397">                                                                cv);</a>
<span class="sourceLineNo">4398</span><a id="line.4398">                Label start = ctorgen.newLabel();</a>
<span class="sourceLineNo">4399</span><a id="line.4399">                Label end = ctorgen.newLabel();</a>
<span class="sourceLineNo">4400</span><a id="line.4400">                ctorgen.visitCode();</a>
<span class="sourceLineNo">4401</span><a id="line.4401">                ctorgen.visitLineNumber(line, ctorgen.mark());</a>
<span class="sourceLineNo">4402</span><a id="line.4402">                ctorgen.visitLabel(start);</a>
<span class="sourceLineNo">4403</span><a id="line.4403">                ctorgen.loadThis();</a>
<span class="sourceLineNo">4404</span><a id="line.4404">//              if(superName != null)</a>
<span class="sourceLineNo">4405</span><a id="line.4405">                        ctorgen.invokeConstructor(Type.getObjectType(superName), voidctor);</a>
<span class="sourceLineNo">4406</span><a id="line.4406">//              else if(isVariadic()) //RestFn ctor takes reqArity arg</a>
<span class="sourceLineNo">4407</span><a id="line.4407">//                      {</a>
<span class="sourceLineNo">4408</span><a id="line.4408">//                      ctorgen.push(variadicMethod.reqParms.count());</a>
<span class="sourceLineNo">4409</span><a id="line.4409">//                      ctorgen.invokeConstructor(restFnType, restfnctor);</a>
<span class="sourceLineNo">4410</span><a id="line.4410">//                      }</a>
<span class="sourceLineNo">4411</span><a id="line.4411">//              else</a>
<span class="sourceLineNo">4412</span><a id="line.4412">//                      ctorgen.invokeConstructor(aFnType, voidctor);</a>
<span class="sourceLineNo">4413</span><a id="line.4413"></a>
<span class="sourceLineNo">4414</span><a id="line.4414">//              if(vars.count() &gt; 0)</a>
<span class="sourceLineNo">4415</span><a id="line.4415">//                      {</a>
<span class="sourceLineNo">4416</span><a id="line.4416">//                      ctorgen.loadThis();</a>
<span class="sourceLineNo">4417</span><a id="line.4417">//                      ctorgen.getStatic(VAR_TYPE,"rev",Type.INT_TYPE);</a>
<span class="sourceLineNo">4418</span><a id="line.4418">//                      ctorgen.push(-1);</a>
<span class="sourceLineNo">4419</span><a id="line.4419">//                      ctorgen.visitInsn(Opcodes.IADD);</a>
<span class="sourceLineNo">4420</span><a id="line.4420">//                      ctorgen.putField(objtype, "__varrev__", Type.INT_TYPE);</a>
<span class="sourceLineNo">4421</span><a id="line.4421">//                      }</a>
<span class="sourceLineNo">4422</span><a id="line.4422"></a>
<span class="sourceLineNo">4423</span><a id="line.4423">                if(supportsMeta())</a>
<span class="sourceLineNo">4424</span><a id="line.4424">                        {</a>
<span class="sourceLineNo">4425</span><a id="line.4425">                        ctorgen.loadThis();</a>
<span class="sourceLineNo">4426</span><a id="line.4426">                        ctorgen.visitVarInsn(IPERSISTENTMAP_TYPE.getOpcode(Opcodes.ILOAD), 1);</a>
<span class="sourceLineNo">4427</span><a id="line.4427">                        ctorgen.putField(objtype, "__meta", IPERSISTENTMAP_TYPE);</a>
<span class="sourceLineNo">4428</span><a id="line.4428">                        }</a>
<span class="sourceLineNo">4429</span><a id="line.4429"></a>
<span class="sourceLineNo">4430</span><a id="line.4430">                int a = supportsMeta()?2:1;</a>
<span class="sourceLineNo">4431</span><a id="line.4431">                for(ISeq s = RT.keys(closes); s != null; s = s.next(), ++a)</a>
<span class="sourceLineNo">4432</span><a id="line.4432">                        {</a>
<span class="sourceLineNo">4433</span><a id="line.4433">                        LocalBinding lb = (LocalBinding) s.first();</a>
<span class="sourceLineNo">4434</span><a id="line.4434">                        ctorgen.loadThis();</a>
<span class="sourceLineNo">4435</span><a id="line.4435">                        Class primc = lb.getPrimitiveType();</a>
<span class="sourceLineNo">4436</span><a id="line.4436">                        if(primc != null)</a>
<span class="sourceLineNo">4437</span><a id="line.4437">                                {</a>
<span class="sourceLineNo">4438</span><a id="line.4438">                                ctorgen.visitVarInsn(Type.getType(primc).getOpcode(Opcodes.ILOAD), a);</a>
<span class="sourceLineNo">4439</span><a id="line.4439">                                ctorgen.putField(objtype, lb.name, Type.getType(primc));</a>
<span class="sourceLineNo">4440</span><a id="line.4440">                                if(primc == Long.TYPE || primc == Double.TYPE)</a>
<span class="sourceLineNo">4441</span><a id="line.4441">                                        ++a;</a>
<span class="sourceLineNo">4442</span><a id="line.4442">                                }</a>
<span class="sourceLineNo">4443</span><a id="line.4443">                        else</a>
<span class="sourceLineNo">4444</span><a id="line.4444">                                {</a>
<span class="sourceLineNo">4445</span><a id="line.4445">                                ctorgen.visitVarInsn(OBJECT_TYPE.getOpcode(Opcodes.ILOAD), a);</a>
<span class="sourceLineNo">4446</span><a id="line.4446">                                ctorgen.putField(objtype, lb.name, OBJECT_TYPE);</a>
<span class="sourceLineNo">4447</span><a id="line.4447">                                }</a>
<span class="sourceLineNo">4448</span><a id="line.4448">            closesExprs = closesExprs.cons(new LocalBindingExpr(lb, null));</a>
<span class="sourceLineNo">4449</span><a id="line.4449">                        }</a>
<span class="sourceLineNo">4450</span><a id="line.4450"></a>
<span class="sourceLineNo">4451</span><a id="line.4451"></a>
<span class="sourceLineNo">4452</span><a id="line.4452">                ctorgen.visitLabel(end);</a>
<span class="sourceLineNo">4453</span><a id="line.4453"></a>
<span class="sourceLineNo">4454</span><a id="line.4454">                ctorgen.returnValue();</a>
<span class="sourceLineNo">4455</span><a id="line.4455"></a>
<span class="sourceLineNo">4456</span><a id="line.4456">                ctorgen.endMethod();</a>
<span class="sourceLineNo">4457</span><a id="line.4457"></a>
<span class="sourceLineNo">4458</span><a id="line.4458">                if(altCtorDrops &gt; 0)</a>
<span class="sourceLineNo">4459</span><a id="line.4459">                        {</a>
<span class="sourceLineNo">4460</span><a id="line.4460">                                        //ctor that takes closed-overs and inits base + fields</a>
<span class="sourceLineNo">4461</span><a id="line.4461">                        Type[] ctorTypes = ctorTypes();</a>
<span class="sourceLineNo">4462</span><a id="line.4462">                        Type[] altCtorTypes = new Type[ctorTypes.length-altCtorDrops];</a>
<span class="sourceLineNo">4463</span><a id="line.4463">                        for(int i=0;i&lt;altCtorTypes.length;i++)</a>
<span class="sourceLineNo">4464</span><a id="line.4464">                                altCtorTypes[i] = ctorTypes[i];</a>
<span class="sourceLineNo">4465</span><a id="line.4465">                        Method alt = new Method("&lt;init&gt;", Type.VOID_TYPE, altCtorTypes);</a>
<span class="sourceLineNo">4466</span><a id="line.4466">                        ctorgen = new GeneratorAdapter(ACC_PUBLIC,</a>
<span class="sourceLineNo">4467</span><a id="line.4467">                                                                                                                        alt,</a>
<span class="sourceLineNo">4468</span><a id="line.4468">                                                                                                                        null,</a>
<span class="sourceLineNo">4469</span><a id="line.4469">                                                                                                                        null,</a>
<span class="sourceLineNo">4470</span><a id="line.4470">                                                                                                                        cv);</a>
<span class="sourceLineNo">4471</span><a id="line.4471">                        ctorgen.visitCode();</a>
<span class="sourceLineNo">4472</span><a id="line.4472">                        ctorgen.loadThis();</a>
<span class="sourceLineNo">4473</span><a id="line.4473">                        ctorgen.loadArgs();</a>
<span class="sourceLineNo">4474</span><a id="line.4474"></a>
<span class="sourceLineNo">4475</span><a id="line.4475">                        ctorgen.visitInsn(Opcodes.ACONST_NULL); //__meta</a>
<span class="sourceLineNo">4476</span><a id="line.4476">                        ctorgen.visitInsn(Opcodes.ACONST_NULL); //__extmap</a>
<span class="sourceLineNo">4477</span><a id="line.4477">                        ctorgen.visitInsn(Opcodes.ICONST_0); //__hash</a>
<span class="sourceLineNo">4478</span><a id="line.4478">                        ctorgen.visitInsn(Opcodes.ICONST_0); //__hasheq</a>
<span class="sourceLineNo">4479</span><a id="line.4479"></a>
<span class="sourceLineNo">4480</span><a id="line.4480">                        ctorgen.invokeConstructor(objtype, new Method("&lt;init&gt;", Type.VOID_TYPE, ctorTypes));</a>
<span class="sourceLineNo">4481</span><a id="line.4481"></a>
<span class="sourceLineNo">4482</span><a id="line.4482">                        ctorgen.returnValue();</a>
<span class="sourceLineNo">4483</span><a id="line.4483">                        ctorgen.endMethod();</a>
<span class="sourceLineNo">4484</span><a id="line.4484"></a>
<span class="sourceLineNo">4485</span><a id="line.4485">            // alt ctor no __hash, __hasheq</a>
<span class="sourceLineNo">4486</span><a id="line.4486">                        altCtorTypes = new Type[ctorTypes.length-2];</a>
<span class="sourceLineNo">4487</span><a id="line.4487">                        for(int i=0;i&lt;altCtorTypes.length;i++)</a>
<span class="sourceLineNo">4488</span><a id="line.4488">                                altCtorTypes[i] = ctorTypes[i];</a>
<span class="sourceLineNo">4489</span><a id="line.4489"></a>
<span class="sourceLineNo">4490</span><a id="line.4490">                        alt = new Method("&lt;init&gt;", Type.VOID_TYPE, altCtorTypes);</a>
<span class="sourceLineNo">4491</span><a id="line.4491">                        ctorgen = new GeneratorAdapter(ACC_PUBLIC,</a>
<span class="sourceLineNo">4492</span><a id="line.4492">                                                                                                                        alt,</a>
<span class="sourceLineNo">4493</span><a id="line.4493">                                                                                                                        null,</a>
<span class="sourceLineNo">4494</span><a id="line.4494">                                                                                                                        null,</a>
<span class="sourceLineNo">4495</span><a id="line.4495">                                                                                                                        cv);</a>
<span class="sourceLineNo">4496</span><a id="line.4496">                        ctorgen.visitCode();</a>
<span class="sourceLineNo">4497</span><a id="line.4497">                        ctorgen.loadThis();</a>
<span class="sourceLineNo">4498</span><a id="line.4498">                        ctorgen.loadArgs();</a>
<span class="sourceLineNo">4499</span><a id="line.4499"></a>
<span class="sourceLineNo">4500</span><a id="line.4500">                        ctorgen.visitInsn(Opcodes.ICONST_0); //__hash</a>
<span class="sourceLineNo">4501</span><a id="line.4501">                        ctorgen.visitInsn(Opcodes.ICONST_0); //__hasheq</a>
<span class="sourceLineNo">4502</span><a id="line.4502"></a>
<span class="sourceLineNo">4503</span><a id="line.4503">                        ctorgen.invokeConstructor(objtype, new Method("&lt;init&gt;", Type.VOID_TYPE, ctorTypes));</a>
<span class="sourceLineNo">4504</span><a id="line.4504"></a>
<span class="sourceLineNo">4505</span><a id="line.4505">                        ctorgen.returnValue();</a>
<span class="sourceLineNo">4506</span><a id="line.4506">                        ctorgen.endMethod();</a>
<span class="sourceLineNo">4507</span><a id="line.4507">                        }</a>
<span class="sourceLineNo">4508</span><a id="line.4508"></a>
<span class="sourceLineNo">4509</span><a id="line.4509">                if(supportsMeta())</a>
<span class="sourceLineNo">4510</span><a id="line.4510">                        {</a>
<span class="sourceLineNo">4511</span><a id="line.4511">                        //ctor that takes closed-overs but not meta</a>
<span class="sourceLineNo">4512</span><a id="line.4512">                        Type[] ctorTypes = ctorTypes();</a>
<span class="sourceLineNo">4513</span><a id="line.4513">                        Type[] noMetaCtorTypes = new Type[ctorTypes.length-1];</a>
<span class="sourceLineNo">4514</span><a id="line.4514">                        for(int i=1;i&lt;ctorTypes.length;i++)</a>
<span class="sourceLineNo">4515</span><a id="line.4515">                                noMetaCtorTypes[i-1] = ctorTypes[i];</a>
<span class="sourceLineNo">4516</span><a id="line.4516">                        Method alt = new Method("&lt;init&gt;", Type.VOID_TYPE, noMetaCtorTypes);</a>
<span class="sourceLineNo">4517</span><a id="line.4517">                        ctorgen = new GeneratorAdapter(ACC_PUBLIC,</a>
<span class="sourceLineNo">4518</span><a id="line.4518">                                                                                                                        alt,</a>
<span class="sourceLineNo">4519</span><a id="line.4519">                                                                                                                        null,</a>
<span class="sourceLineNo">4520</span><a id="line.4520">                                                                                                                        null,</a>
<span class="sourceLineNo">4521</span><a id="line.4521">                                                                                                                        cv);</a>
<span class="sourceLineNo">4522</span><a id="line.4522">                        ctorgen.visitCode();</a>
<span class="sourceLineNo">4523</span><a id="line.4523">                        ctorgen.loadThis();</a>
<span class="sourceLineNo">4524</span><a id="line.4524">                        ctorgen.visitInsn(Opcodes.ACONST_NULL); //null meta</a>
<span class="sourceLineNo">4525</span><a id="line.4525">                        ctorgen.loadArgs();</a>
<span class="sourceLineNo">4526</span><a id="line.4526">                        ctorgen.invokeConstructor(objtype, new Method("&lt;init&gt;", Type.VOID_TYPE, ctorTypes));</a>
<span class="sourceLineNo">4527</span><a id="line.4527"></a>
<span class="sourceLineNo">4528</span><a id="line.4528">                        ctorgen.returnValue();</a>
<span class="sourceLineNo">4529</span><a id="line.4529">                        ctorgen.endMethod();</a>
<span class="sourceLineNo">4530</span><a id="line.4530"></a>
<span class="sourceLineNo">4531</span><a id="line.4531">                        //meta()</a>
<span class="sourceLineNo">4532</span><a id="line.4532">                        Method meth = Method.getMethod("clojure.lang.IPersistentMap meta()");</a>
<span class="sourceLineNo">4533</span><a id="line.4533"></a>
<span class="sourceLineNo">4534</span><a id="line.4534">                        GeneratorAdapter gen = new GeneratorAdapter(ACC_PUBLIC,</a>
<span class="sourceLineNo">4535</span><a id="line.4535">                                                                                                meth,</a>
<span class="sourceLineNo">4536</span><a id="line.4536">                                                                                                null,</a>
<span class="sourceLineNo">4537</span><a id="line.4537">                                                                                                null,</a>
<span class="sourceLineNo">4538</span><a id="line.4538">                                                                                                cv);</a>
<span class="sourceLineNo">4539</span><a id="line.4539">                        gen.visitCode();</a>
<span class="sourceLineNo">4540</span><a id="line.4540">                        gen.loadThis();</a>
<span class="sourceLineNo">4541</span><a id="line.4541">                        gen.getField(objtype,"__meta",IPERSISTENTMAP_TYPE);</a>
<span class="sourceLineNo">4542</span><a id="line.4542"></a>
<span class="sourceLineNo">4543</span><a id="line.4543">                        gen.returnValue();</a>
<span class="sourceLineNo">4544</span><a id="line.4544">                        gen.endMethod();</a>
<span class="sourceLineNo">4545</span><a id="line.4545"></a>
<span class="sourceLineNo">4546</span><a id="line.4546">                        //withMeta()</a>
<span class="sourceLineNo">4547</span><a id="line.4547">                        meth = Method.getMethod("clojure.lang.IObj withMeta(clojure.lang.IPersistentMap)");</a>
<span class="sourceLineNo">4548</span><a id="line.4548"></a>
<span class="sourceLineNo">4549</span><a id="line.4549">                        gen = new GeneratorAdapter(ACC_PUBLIC,</a>
<span class="sourceLineNo">4550</span><a id="line.4550">                                                                                                meth,</a>
<span class="sourceLineNo">4551</span><a id="line.4551">                                                                                                null,</a>
<span class="sourceLineNo">4552</span><a id="line.4552">                                                                                                null,</a>
<span class="sourceLineNo">4553</span><a id="line.4553">                                                                                                cv);</a>
<span class="sourceLineNo">4554</span><a id="line.4554">                        gen.visitCode();</a>
<span class="sourceLineNo">4555</span><a id="line.4555">                        gen.newInstance(objtype);</a>
<span class="sourceLineNo">4556</span><a id="line.4556">                        gen.dup();</a>
<span class="sourceLineNo">4557</span><a id="line.4557">                        gen.loadArg(0);</a>
<span class="sourceLineNo">4558</span><a id="line.4558"></a>
<span class="sourceLineNo">4559</span><a id="line.4559">                        for(ISeq s = RT.keys(closes); s != null; s = s.next(), ++a)</a>
<span class="sourceLineNo">4560</span><a id="line.4560">                                {</a>
<span class="sourceLineNo">4561</span><a id="line.4561">                                LocalBinding lb = (LocalBinding) s.first();</a>
<span class="sourceLineNo">4562</span><a id="line.4562">                                gen.loadThis();</a>
<span class="sourceLineNo">4563</span><a id="line.4563">                                Class primc = lb.getPrimitiveType();</a>
<span class="sourceLineNo">4564</span><a id="line.4564">                                if(primc != null)</a>
<span class="sourceLineNo">4565</span><a id="line.4565">                                        {</a>
<span class="sourceLineNo">4566</span><a id="line.4566">                                        gen.getField(objtype, lb.name, Type.getType(primc));</a>
<span class="sourceLineNo">4567</span><a id="line.4567">                                        }</a>
<span class="sourceLineNo">4568</span><a id="line.4568">                                else</a>
<span class="sourceLineNo">4569</span><a id="line.4569">                                        {</a>
<span class="sourceLineNo">4570</span><a id="line.4570">                                        gen.getField(objtype, lb.name, OBJECT_TYPE);</a>
<span class="sourceLineNo">4571</span><a id="line.4571">                                        }</a>
<span class="sourceLineNo">4572</span><a id="line.4572">                                }</a>
<span class="sourceLineNo">4573</span><a id="line.4573"></a>
<span class="sourceLineNo">4574</span><a id="line.4574">                        gen.invokeConstructor(objtype, new Method("&lt;init&gt;", Type.VOID_TYPE, ctorTypes));</a>
<span class="sourceLineNo">4575</span><a id="line.4575">                        gen.returnValue();</a>
<span class="sourceLineNo">4576</span><a id="line.4576">                        gen.endMethod();</a>
<span class="sourceLineNo">4577</span><a id="line.4577">                        }</a>
<span class="sourceLineNo">4578</span><a id="line.4578"></a>
<span class="sourceLineNo">4579</span><a id="line.4579">                emitStatics(cv);</a>
<span class="sourceLineNo">4580</span><a id="line.4580">                emitMethods(cv);</a>
<span class="sourceLineNo">4581</span><a id="line.4581"></a>
<span class="sourceLineNo">4582</span><a id="line.4582">        //static fields for constants</a>
<span class="sourceLineNo">4583</span><a id="line.4583">        for(int i = 0; i &lt; constants.count(); i++)</a>
<span class="sourceLineNo">4584</span><a id="line.4584">            {</a>
<span class="sourceLineNo">4585</span><a id="line.4585">            if(usedConstants.contains(i))</a>
<span class="sourceLineNo">4586</span><a id="line.4586">                cv.visitField(ACC_PUBLIC + ACC_FINAL</a>
<span class="sourceLineNo">4587</span><a id="line.4587">                          + ACC_STATIC, constantName(i), constantType(i).getDescriptor(),</a>
<span class="sourceLineNo">4588</span><a id="line.4588">                          null, null);</a>
<span class="sourceLineNo">4589</span><a id="line.4589">            }</a>
<span class="sourceLineNo">4590</span><a id="line.4590"></a>
<span class="sourceLineNo">4591</span><a id="line.4591">        //static fields for lookup sites</a>
<span class="sourceLineNo">4592</span><a id="line.4592">        for(int i = 0; i &lt; keywordCallsites.count(); i++)</a>
<span class="sourceLineNo">4593</span><a id="line.4593">            {</a>
<span class="sourceLineNo">4594</span><a id="line.4594">            cv.visitField(ACC_FINAL</a>
<span class="sourceLineNo">4595</span><a id="line.4595">                          + ACC_STATIC, siteNameStatic(i), KEYWORD_LOOKUPSITE_TYPE.getDescriptor(),</a>
<span class="sourceLineNo">4596</span><a id="line.4596">                          null, null);</a>
<span class="sourceLineNo">4597</span><a id="line.4597">            cv.visitField(ACC_STATIC, thunkNameStatic(i), ILOOKUP_THUNK_TYPE.getDescriptor(),</a>
<span class="sourceLineNo">4598</span><a id="line.4598">                          null, null);</a>
<span class="sourceLineNo">4599</span><a id="line.4599">            }</a>
<span class="sourceLineNo">4600</span><a id="line.4600"></a>
<span class="sourceLineNo">4601</span><a id="line.4601">        //static init for constants, keywords and vars</a>
<span class="sourceLineNo">4602</span><a id="line.4602">        GeneratorAdapter clinitgen = new GeneratorAdapter(ACC_PUBLIC + ACC_STATIC,</a>
<span class="sourceLineNo">4603</span><a id="line.4603">                                                          Method.getMethod("void &lt;clinit&gt; ()"),</a>
<span class="sourceLineNo">4604</span><a id="line.4604">                                                          null,</a>
<span class="sourceLineNo">4605</span><a id="line.4605">                                                          null,</a>
<span class="sourceLineNo">4606</span><a id="line.4606">                                                          cv);</a>
<span class="sourceLineNo">4607</span><a id="line.4607">        clinitgen.visitCode();</a>
<span class="sourceLineNo">4608</span><a id="line.4608">        clinitgen.visitLineNumber(line, clinitgen.mark());</a>
<span class="sourceLineNo">4609</span><a id="line.4609"></a>
<span class="sourceLineNo">4610</span><a id="line.4610">        if(constants.count() &gt; 0)</a>
<span class="sourceLineNo">4611</span><a id="line.4611">            {</a>
<span class="sourceLineNo">4612</span><a id="line.4612">            emitConstants(clinitgen);</a>
<span class="sourceLineNo">4613</span><a id="line.4613">            }</a>
<span class="sourceLineNo">4614</span><a id="line.4614"></a>
<span class="sourceLineNo">4615</span><a id="line.4615">        if(keywordCallsites.count() &gt; 0)</a>
<span class="sourceLineNo">4616</span><a id="line.4616">            emitKeywordCallsites(clinitgen);</a>
<span class="sourceLineNo">4617</span><a id="line.4617"></a>
<span class="sourceLineNo">4618</span><a id="line.4618">                /*</a>
<span class="sourceLineNo">4619</span><a id="line.4619">                for(int i=0;i&lt;varCallsites.count();i++)</a>
<span class="sourceLineNo">4620</span><a id="line.4620">                        {</a>
<span class="sourceLineNo">4621</span><a id="line.4621">                        Label skipLabel = clinitgen.newLabel();</a>
<span class="sourceLineNo">4622</span><a id="line.4622">                        Label endLabel = clinitgen.newLabel();</a>
<span class="sourceLineNo">4623</span><a id="line.4623">                        Var var = (Var) varCallsites.nth(i);</a>
<span class="sourceLineNo">4624</span><a id="line.4624">                        clinitgen.push(var.ns.name.toString());</a>
<span class="sourceLineNo">4625</span><a id="line.4625">                        clinitgen.push(var.sym.toString());</a>
<span class="sourceLineNo">4626</span><a id="line.4626">                        clinitgen.invokeStatic(RT_TYPE, Method.getMethod("clojure.lang.Var var(String,String)"));</a>
<span class="sourceLineNo">4627</span><a id="line.4627">                        clinitgen.dup();</a>
<span class="sourceLineNo">4628</span><a id="line.4628">                        clinitgen.invokeVirtual(VAR_TYPE,Method.getMethod("boolean hasRoot()"));</a>
<span class="sourceLineNo">4629</span><a id="line.4629">                        clinitgen.ifZCmp(GeneratorAdapter.EQ,skipLabel);</a>
<span class="sourceLineNo">4630</span><a id="line.4630"></a>
<span class="sourceLineNo">4631</span><a id="line.4631">                        clinitgen.invokeVirtual(VAR_TYPE,Method.getMethod("Object getRoot()"));</a>
<span class="sourceLineNo">4632</span><a id="line.4632">                  clinitgen.dup();</a>
<span class="sourceLineNo">4633</span><a id="line.4633">                  clinitgen.instanceOf(AFUNCTION_TYPE);</a>
<span class="sourceLineNo">4634</span><a id="line.4634">                  clinitgen.ifZCmp(GeneratorAdapter.EQ,skipLabel);</a>
<span class="sourceLineNo">4635</span><a id="line.4635">                        clinitgen.checkCast(IFN_TYPE);</a>
<span class="sourceLineNo">4636</span><a id="line.4636">                        clinitgen.putStatic(objtype, varCallsiteName(i), IFN_TYPE);</a>
<span class="sourceLineNo">4637</span><a id="line.4637">                        clinitgen.goTo(endLabel);</a>
<span class="sourceLineNo">4638</span><a id="line.4638"></a>
<span class="sourceLineNo">4639</span><a id="line.4639">                        clinitgen.mark(skipLabel);</a>
<span class="sourceLineNo">4640</span><a id="line.4640">                        clinitgen.pop();</a>
<span class="sourceLineNo">4641</span><a id="line.4641"></a>
<span class="sourceLineNo">4642</span><a id="line.4642">                        clinitgen.mark(endLabel);</a>
<span class="sourceLineNo">4643</span><a id="line.4643">                        }</a>
<span class="sourceLineNo">4644</span><a id="line.4644">              */</a>
<span class="sourceLineNo">4645</span><a id="line.4645"></a>
<span class="sourceLineNo">4646</span><a id="line.4646">        if(isDeftype() &amp;&amp; RT.booleanCast(RT.get(opts, loadNs))) {</a>
<span class="sourceLineNo">4647</span><a id="line.4647">              String nsname = ((Symbol)RT.second(src)).getNamespace();</a>
<span class="sourceLineNo">4648</span><a id="line.4648">              if (!nsname.equals("clojure.core")) {</a>
<span class="sourceLineNo">4649</span><a id="line.4649">                  clinitgen.push("clojure.core");</a>
<span class="sourceLineNo">4650</span><a id="line.4650">                  clinitgen.push("require");</a>
<span class="sourceLineNo">4651</span><a id="line.4651">                  clinitgen.invokeStatic(RT_TYPE, Method.getMethod("clojure.lang.Var var(String,String)"));</a>
<span class="sourceLineNo">4652</span><a id="line.4652">                  clinitgen.invokeVirtual(VAR_TYPE,Method.getMethod("Object getRawRoot()"));</a>
<span class="sourceLineNo">4653</span><a id="line.4653">                  clinitgen.checkCast(IFN_TYPE);</a>
<span class="sourceLineNo">4654</span><a id="line.4654">                  clinitgen.push(nsname);</a>
<span class="sourceLineNo">4655</span><a id="line.4655">                  clinitgen.invokeStatic(SYMBOL_TYPE, Method.getMethod("clojure.lang.Symbol create(String)"));</a>
<span class="sourceLineNo">4656</span><a id="line.4656">                  clinitgen.invokeInterface(IFN_TYPE, Method.getMethod("Object invoke(Object)"));</a>
<span class="sourceLineNo">4657</span><a id="line.4657">                  clinitgen.pop();</a>
<span class="sourceLineNo">4658</span><a id="line.4658">              }</a>
<span class="sourceLineNo">4659</span><a id="line.4659">          }</a>
<span class="sourceLineNo">4660</span><a id="line.4660"></a>
<span class="sourceLineNo">4661</span><a id="line.4661">        clinitgen.returnValue();</a>
<span class="sourceLineNo">4662</span><a id="line.4662"></a>
<span class="sourceLineNo">4663</span><a id="line.4663">        clinitgen.endMethod();</a>
<span class="sourceLineNo">4664</span><a id="line.4664"></a>
<span class="sourceLineNo">4665</span><a id="line.4665">                //end of class</a>
<span class="sourceLineNo">4666</span><a id="line.4666">                cv.visitEnd();</a>
<span class="sourceLineNo">4667</span><a id="line.4667"></a>
<span class="sourceLineNo">4668</span><a id="line.4668">                bytecode = cw.toByteArray();</a>
<span class="sourceLineNo">4669</span><a id="line.4669">                if(RT.booleanCast(COMPILE_FILES.deref()))</a>
<span class="sourceLineNo">4670</span><a id="line.4670">                        writeClassFile(internalName, bytecode);</a>
<span class="sourceLineNo">4671</span><a id="line.4671">//              else</a>
<span class="sourceLineNo">4672</span><a id="line.4672">//                      getCompiledClass();</a>
<span class="sourceLineNo">4673</span><a id="line.4673">        }</a>
<span class="sourceLineNo">4674</span><a id="line.4674"></a>
<span class="sourceLineNo">4675</span><a id="line.4675">        private void emitKeywordCallsites(GeneratorAdapter clinitgen){</a>
<span class="sourceLineNo">4676</span><a id="line.4676">                for(int i=0;i&lt;keywordCallsites.count();i++)</a>
<span class="sourceLineNo">4677</span><a id="line.4677">                        {</a>
<span class="sourceLineNo">4678</span><a id="line.4678">                        Keyword k = (Keyword) keywordCallsites.nth(i);</a>
<span class="sourceLineNo">4679</span><a id="line.4679">                        clinitgen.newInstance(KEYWORD_LOOKUPSITE_TYPE);</a>
<span class="sourceLineNo">4680</span><a id="line.4680">                        clinitgen.dup();</a>
<span class="sourceLineNo">4681</span><a id="line.4681">                        emitValue(k,clinitgen);</a>
<span class="sourceLineNo">4682</span><a id="line.4682">                        clinitgen.invokeConstructor(KEYWORD_LOOKUPSITE_TYPE,</a>
<span class="sourceLineNo">4683</span><a id="line.4683">                                                    Method.getMethod("void &lt;init&gt;(clojure.lang.Keyword)"));</a>
<span class="sourceLineNo">4684</span><a id="line.4684">                        clinitgen.dup();</a>
<span class="sourceLineNo">4685</span><a id="line.4685">                        clinitgen.putStatic(objtype, siteNameStatic(i), KEYWORD_LOOKUPSITE_TYPE);</a>
<span class="sourceLineNo">4686</span><a id="line.4686">                        clinitgen.putStatic(objtype, thunkNameStatic(i), ILOOKUP_THUNK_TYPE);</a>
<span class="sourceLineNo">4687</span><a id="line.4687">                        }</a>
<span class="sourceLineNo">4688</span><a id="line.4688">        }</a>
<span class="sourceLineNo">4689</span><a id="line.4689"></a>
<span class="sourceLineNo">4690</span><a id="line.4690">        protected void emitStatics(ClassVisitor gen){</a>
<span class="sourceLineNo">4691</span><a id="line.4691">        }</a>
<span class="sourceLineNo">4692</span><a id="line.4692"></a>
<span class="sourceLineNo">4693</span><a id="line.4693">        protected void emitMethods(ClassVisitor gen){</a>
<span class="sourceLineNo">4694</span><a id="line.4694">        }</a>
<span class="sourceLineNo">4695</span><a id="line.4695"></a>
<span class="sourceLineNo">4696</span><a id="line.4696">        void emitListAsObjectArray(Object value, GeneratorAdapter gen){</a>
<span class="sourceLineNo">4697</span><a id="line.4697">                gen.push(((List) value).size());</a>
<span class="sourceLineNo">4698</span><a id="line.4698">                gen.newArray(OBJECT_TYPE);</a>
<span class="sourceLineNo">4699</span><a id="line.4699">                int i = 0;</a>
<span class="sourceLineNo">4700</span><a id="line.4700">                for(Iterator it = ((List) value).iterator(); it.hasNext(); i++)</a>
<span class="sourceLineNo">4701</span><a id="line.4701">                        {</a>
<span class="sourceLineNo">4702</span><a id="line.4702">                        gen.dup();</a>
<span class="sourceLineNo">4703</span><a id="line.4703">                        gen.push(i);</a>
<span class="sourceLineNo">4704</span><a id="line.4704">                        emitValue(it.next(), gen);</a>
<span class="sourceLineNo">4705</span><a id="line.4705">                        gen.arrayStore(OBJECT_TYPE);</a>
<span class="sourceLineNo">4706</span><a id="line.4706">                        }</a>
<span class="sourceLineNo">4707</span><a id="line.4707">        }</a>
<span class="sourceLineNo">4708</span><a id="line.4708"></a>
<span class="sourceLineNo">4709</span><a id="line.4709">        void emitValue(Object value, GeneratorAdapter gen){</a>
<span class="sourceLineNo">4710</span><a id="line.4710">                boolean partial = true;</a>
<span class="sourceLineNo">4711</span><a id="line.4711">                //System.out.println(value.getClass().toString());</a>
<span class="sourceLineNo">4712</span><a id="line.4712"></a>
<span class="sourceLineNo">4713</span><a id="line.4713">                if(value == null)</a>
<span class="sourceLineNo">4714</span><a id="line.4714">                        gen.visitInsn(Opcodes.ACONST_NULL);</a>
<span class="sourceLineNo">4715</span><a id="line.4715">                else if(value instanceof String)</a>
<span class="sourceLineNo">4716</span><a id="line.4716">                        {</a>
<span class="sourceLineNo">4717</span><a id="line.4717">                        gen.push((String) value);</a>
<span class="sourceLineNo">4718</span><a id="line.4718">                        }</a>
<span class="sourceLineNo">4719</span><a id="line.4719">                else if(value instanceof Boolean)</a>
<span class="sourceLineNo">4720</span><a id="line.4720">                        {</a>
<span class="sourceLineNo">4721</span><a id="line.4721">                        if(((Boolean) value).booleanValue())</a>
<span class="sourceLineNo">4722</span><a id="line.4722">                                gen.getStatic(BOOLEAN_OBJECT_TYPE, "TRUE", BOOLEAN_OBJECT_TYPE);</a>
<span class="sourceLineNo">4723</span><a id="line.4723">                        else</a>
<span class="sourceLineNo">4724</span><a id="line.4724">                                gen.getStatic(BOOLEAN_OBJECT_TYPE,"FALSE",BOOLEAN_OBJECT_TYPE);</a>
<span class="sourceLineNo">4725</span><a id="line.4725">                        }</a>
<span class="sourceLineNo">4726</span><a id="line.4726">                else if(value instanceof Integer)</a>
<span class="sourceLineNo">4727</span><a id="line.4727">                        {</a>
<span class="sourceLineNo">4728</span><a id="line.4728">                        gen.push(((Integer) value).intValue());</a>
<span class="sourceLineNo">4729</span><a id="line.4729">                        gen.invokeStatic(Type.getType(Integer.class), Method.getMethod("Integer valueOf(int)"));</a>
<span class="sourceLineNo">4730</span><a id="line.4730">                        }</a>
<span class="sourceLineNo">4731</span><a id="line.4731">                else if(value instanceof Long)</a>
<span class="sourceLineNo">4732</span><a id="line.4732">                        {</a>
<span class="sourceLineNo">4733</span><a id="line.4733">                        gen.push(((Long) value).longValue());</a>
<span class="sourceLineNo">4734</span><a id="line.4734">                        gen.invokeStatic(Type.getType(Long.class), Method.getMethod("Long valueOf(long)"));</a>
<span class="sourceLineNo">4735</span><a id="line.4735">                        }</a>
<span class="sourceLineNo">4736</span><a id="line.4736">                else if(value instanceof Double)</a>
<span class="sourceLineNo">4737</span><a id="line.4737">                                {</a>
<span class="sourceLineNo">4738</span><a id="line.4738">                                gen.push(((Double) value).doubleValue());</a>
<span class="sourceLineNo">4739</span><a id="line.4739">                                gen.invokeStatic(Type.getType(Double.class), Method.getMethod("Double valueOf(double)"));</a>
<span class="sourceLineNo">4740</span><a id="line.4740">                                }</a>
<span class="sourceLineNo">4741</span><a id="line.4741">                else if(value instanceof Character)</a>
<span class="sourceLineNo">4742</span><a id="line.4742">                                {</a>
<span class="sourceLineNo">4743</span><a id="line.4743">                                gen.push(((Character) value).charValue());</a>
<span class="sourceLineNo">4744</span><a id="line.4744">                                gen.invokeStatic(Type.getType(Character.class), Method.getMethod("Character valueOf(char)"));</a>
<span class="sourceLineNo">4745</span><a id="line.4745">                                }</a>
<span class="sourceLineNo">4746</span><a id="line.4746">                else if(value instanceof Class)</a>
<span class="sourceLineNo">4747</span><a id="line.4747">                        {</a>
<span class="sourceLineNo">4748</span><a id="line.4748">                        Class cc = (Class)value;</a>
<span class="sourceLineNo">4749</span><a id="line.4749">                        if(cc.isPrimitive())</a>
<span class="sourceLineNo">4750</span><a id="line.4750">                                {</a>
<span class="sourceLineNo">4751</span><a id="line.4751">                                Type bt;</a>
<span class="sourceLineNo">4752</span><a id="line.4752">                                if ( cc == boolean.class ) bt = Type.getType(Boolean.class);</a>
<span class="sourceLineNo">4753</span><a id="line.4753">                                else if ( cc == byte.class ) bt = Type.getType(Byte.class);</a>
<span class="sourceLineNo">4754</span><a id="line.4754">                                else if ( cc == char.class ) bt = Type.getType(Character.class);</a>
<span class="sourceLineNo">4755</span><a id="line.4755">                                else if ( cc == double.class ) bt = Type.getType(Double.class);</a>
<span class="sourceLineNo">4756</span><a id="line.4756">                                else if ( cc == float.class ) bt = Type.getType(Float.class);</a>
<span class="sourceLineNo">4757</span><a id="line.4757">                                else if ( cc == int.class ) bt = Type.getType(Integer.class);</a>
<span class="sourceLineNo">4758</span><a id="line.4758">                                else if ( cc == long.class ) bt = Type.getType(Long.class);</a>
<span class="sourceLineNo">4759</span><a id="line.4759">                                else if ( cc == short.class ) bt = Type.getType(Short.class);</a>
<span class="sourceLineNo">4760</span><a id="line.4760">                                else throw Util.runtimeException(</a>
<span class="sourceLineNo">4761</span><a id="line.4761">                                                "Can't embed unknown primitive in code: " + value);</a>
<span class="sourceLineNo">4762</span><a id="line.4762">                                gen.getStatic( bt, "TYPE", Type.getType(Class.class) );</a>
<span class="sourceLineNo">4763</span><a id="line.4763">                                }</a>
<span class="sourceLineNo">4764</span><a id="line.4764">                        else</a>
<span class="sourceLineNo">4765</span><a id="line.4765">                                {</a>
<span class="sourceLineNo">4766</span><a id="line.4766">                                gen.push(destubClassName(cc.getName()));</a>
<span class="sourceLineNo">4767</span><a id="line.4767">                                gen.invokeStatic(RT_TYPE, Method.getMethod("Class classForName(String)"));</a>
<span class="sourceLineNo">4768</span><a id="line.4768">                                }</a>
<span class="sourceLineNo">4769</span><a id="line.4769">                        }</a>
<span class="sourceLineNo">4770</span><a id="line.4770">                else if(value instanceof Symbol)</a>
<span class="sourceLineNo">4771</span><a id="line.4771">                        {</a>
<span class="sourceLineNo">4772</span><a id="line.4772">                        gen.push(((Symbol) value).ns);</a>
<span class="sourceLineNo">4773</span><a id="line.4773">                        gen.push(((Symbol) value).name);</a>
<span class="sourceLineNo">4774</span><a id="line.4774">                        gen.invokeStatic(Type.getType(Symbol.class),</a>
<span class="sourceLineNo">4775</span><a id="line.4775">                                                         Method.getMethod("clojure.lang.Symbol intern(String,String)"));</a>
<span class="sourceLineNo">4776</span><a id="line.4776">                        }</a>
<span class="sourceLineNo">4777</span><a id="line.4777">                else if(value instanceof Keyword)</a>
<span class="sourceLineNo">4778</span><a id="line.4778">                        {</a>
<span class="sourceLineNo">4779</span><a id="line.4779">                        gen.push(((Keyword) value).sym.ns);</a>
<span class="sourceLineNo">4780</span><a id="line.4780">                        gen.push(((Keyword) value).sym.name);</a>
<span class="sourceLineNo">4781</span><a id="line.4781">                        gen.invokeStatic(RT_TYPE,</a>
<span class="sourceLineNo">4782</span><a id="line.4782">                                                         Method.getMethod("clojure.lang.Keyword keyword(String,String)"));</a>
<span class="sourceLineNo">4783</span><a id="line.4783">                        }</a>
<span class="sourceLineNo">4784</span><a id="line.4784">//                                              else if(value instanceof KeywordCallSite)</a>
<span class="sourceLineNo">4785</span><a id="line.4785">//                                                              {</a>
<span class="sourceLineNo">4786</span><a id="line.4786">//                                                              emitValue(((KeywordCallSite) value).k.sym, gen);</a>
<span class="sourceLineNo">4787</span><a id="line.4787">//                                                              gen.invokeStatic(Type.getType(KeywordCallSite.class),</a>
<span class="sourceLineNo">4788</span><a id="line.4788">//                                                                               Method.getMethod("clojure.lang.KeywordCallSite create(clojure.lang.Symbol)"));</a>
<span class="sourceLineNo">4789</span><a id="line.4789">//                                                              }</a>
<span class="sourceLineNo">4790</span><a id="line.4790">                else if(value instanceof Var)</a>
<span class="sourceLineNo">4791</span><a id="line.4791">                        {</a>
<span class="sourceLineNo">4792</span><a id="line.4792">                        Var var = (Var) value;</a>
<span class="sourceLineNo">4793</span><a id="line.4793">                        gen.push(var.ns.name.toString());</a>
<span class="sourceLineNo">4794</span><a id="line.4794">                        gen.push(var.sym.toString());</a>
<span class="sourceLineNo">4795</span><a id="line.4795">                        gen.invokeStatic(RT_TYPE, Method.getMethod("clojure.lang.Var var(String,String)"));</a>
<span class="sourceLineNo">4796</span><a id="line.4796">                        }</a>
<span class="sourceLineNo">4797</span><a id="line.4797">                else if(value instanceof IType)</a>
<span class="sourceLineNo">4798</span><a id="line.4798">                        {</a>
<span class="sourceLineNo">4799</span><a id="line.4799">                        Method ctor = new Method("&lt;init&gt;", Type.getConstructorDescriptor(value.getClass().getConstructors()[0]));</a>
<span class="sourceLineNo">4800</span><a id="line.4800">                        gen.newInstance(Type.getType(value.getClass()));</a>
<span class="sourceLineNo">4801</span><a id="line.4801">                        gen.dup();</a>
<span class="sourceLineNo">4802</span><a id="line.4802">                        IPersistentVector fields = (IPersistentVector) Reflector.invokeStaticMethod(value.getClass(), "getBasis", new Object[]{});</a>
<span class="sourceLineNo">4803</span><a id="line.4803">                        for(ISeq s = RT.seq(fields); s != null; s = s.next())</a>
<span class="sourceLineNo">4804</span><a id="line.4804">                                {</a>
<span class="sourceLineNo">4805</span><a id="line.4805">                                Symbol field = (Symbol) s.first();</a>
<span class="sourceLineNo">4806</span><a id="line.4806">                                Class k = tagClass(tagOf(field));</a>
<span class="sourceLineNo">4807</span><a id="line.4807">                                Object val = Reflector.getInstanceField(value, munge(field.name));</a>
<span class="sourceLineNo">4808</span><a id="line.4808">                                emitValue(val, gen);</a>
<span class="sourceLineNo">4809</span><a id="line.4809"></a>
<span class="sourceLineNo">4810</span><a id="line.4810">                                if(k.isPrimitive())</a>
<span class="sourceLineNo">4811</span><a id="line.4811">                                        {</a>
<span class="sourceLineNo">4812</span><a id="line.4812">                                        Type b = Type.getType(boxClass(k));</a>
<span class="sourceLineNo">4813</span><a id="line.4813">                                        String p = Type.getType(k).getDescriptor();</a>
<span class="sourceLineNo">4814</span><a id="line.4814">                                        String n = k.getName();</a>
<span class="sourceLineNo">4815</span><a id="line.4815"></a>
<span class="sourceLineNo">4816</span><a id="line.4816">                                        gen.invokeVirtual(b, new Method(n+"Value", "()"+p));</a>
<span class="sourceLineNo">4817</span><a id="line.4817">                                        }</a>
<span class="sourceLineNo">4818</span><a id="line.4818">                                }</a>
<span class="sourceLineNo">4819</span><a id="line.4819">                        gen.invokeConstructor(Type.getType(value.getClass()), ctor);</a>
<span class="sourceLineNo">4820</span><a id="line.4820">                        }</a>
<span class="sourceLineNo">4821</span><a id="line.4821">                else if(value instanceof IRecord)</a>
<span class="sourceLineNo">4822</span><a id="line.4822">                        {</a>
<span class="sourceLineNo">4823</span><a id="line.4823">                        Method createMethod = Method.getMethod(value.getClass().getName() + " create(clojure.lang.IPersistentMap)");</a>
<span class="sourceLineNo">4824</span><a id="line.4824">            emitValue(PersistentArrayMap.create((java.util.Map) value), gen);</a>
<span class="sourceLineNo">4825</span><a id="line.4825">                        gen.invokeStatic(getType(value.getClass()), createMethod);</a>
<span class="sourceLineNo">4826</span><a id="line.4826">                        }</a>
<span class="sourceLineNo">4827</span><a id="line.4827">                else if(value instanceof IPersistentMap)</a>
<span class="sourceLineNo">4828</span><a id="line.4828">                        {</a>
<span class="sourceLineNo">4829</span><a id="line.4829">                        List entries = new ArrayList();</a>
<span class="sourceLineNo">4830</span><a id="line.4830">                        for(Map.Entry entry : (Set&lt;Map.Entry&gt;) ((Map) value).entrySet())</a>
<span class="sourceLineNo">4831</span><a id="line.4831">                                {</a>
<span class="sourceLineNo">4832</span><a id="line.4832">                                entries.add(entry.getKey());</a>
<span class="sourceLineNo">4833</span><a id="line.4833">                                entries.add(entry.getValue());</a>
<span class="sourceLineNo">4834</span><a id="line.4834">                                }</a>
<span class="sourceLineNo">4835</span><a id="line.4835">                        emitListAsObjectArray(entries, gen);</a>
<span class="sourceLineNo">4836</span><a id="line.4836">                        gen.invokeStatic(RT_TYPE,</a>
<span class="sourceLineNo">4837</span><a id="line.4837">                                                         Method.getMethod("clojure.lang.IPersistentMap map(Object[])"));</a>
<span class="sourceLineNo">4838</span><a id="line.4838">                        }</a>
<span class="sourceLineNo">4839</span><a id="line.4839">                else if(value instanceof IPersistentVector)</a>
<span class="sourceLineNo">4840</span><a id="line.4840">                        {</a>
<span class="sourceLineNo">4841</span><a id="line.4841">            IPersistentVector args = (IPersistentVector) value;</a>
<span class="sourceLineNo">4842</span><a id="line.4842">            if(args.count() &lt;= Tuple.MAX_SIZE)</a>
<span class="sourceLineNo">4843</span><a id="line.4843">                {</a>
<span class="sourceLineNo">4844</span><a id="line.4844">                for(int i = 0; i &lt; args.count(); i++) {</a>
<span class="sourceLineNo">4845</span><a id="line.4845">                                emitValue(args.nth(i), gen);</a>
<span class="sourceLineNo">4846</span><a id="line.4846">                                }</a>
<span class="sourceLineNo">4847</span><a id="line.4847">                gen.invokeStatic(TUPLE_TYPE, createTupleMethods[args.count()]);</a>
<span class="sourceLineNo">4848</span><a id="line.4848">                }</a>
<span class="sourceLineNo">4849</span><a id="line.4849">            else</a>
<span class="sourceLineNo">4850</span><a id="line.4850">                {</a>
<span class="sourceLineNo">4851</span><a id="line.4851">                emitListAsObjectArray(value, gen);</a>
<span class="sourceLineNo">4852</span><a id="line.4852">                gen.invokeStatic(RT_TYPE, Method.getMethod(</a>
<span class="sourceLineNo">4853</span><a id="line.4853">                        "clojure.lang.IPersistentVector vector(Object[])"));</a>
<span class="sourceLineNo">4854</span><a id="line.4854">                }</a>
<span class="sourceLineNo">4855</span><a id="line.4855">                        }</a>
<span class="sourceLineNo">4856</span><a id="line.4856">                else if(value instanceof PersistentHashSet)</a>
<span class="sourceLineNo">4857</span><a id="line.4857">                        {</a>
<span class="sourceLineNo">4858</span><a id="line.4858">                        ISeq vs = RT.seq(value);</a>
<span class="sourceLineNo">4859</span><a id="line.4859">                        if(vs == null)</a>
<span class="sourceLineNo">4860</span><a id="line.4860">                                gen.getStatic(Type.getType(PersistentHashSet.class),"EMPTY",Type.getType(PersistentHashSet.class));</a>
<span class="sourceLineNo">4861</span><a id="line.4861">                        else</a>
<span class="sourceLineNo">4862</span><a id="line.4862">                                {</a>
<span class="sourceLineNo">4863</span><a id="line.4863">                                emitListAsObjectArray(vs, gen);</a>
<span class="sourceLineNo">4864</span><a id="line.4864">                                gen.invokeStatic(Type.getType(PersistentHashSet.class), Method.getMethod(</a>
<span class="sourceLineNo">4865</span><a id="line.4865">                                        "clojure.lang.PersistentHashSet create(Object[])"));</a>
<span class="sourceLineNo">4866</span><a id="line.4866">                                }</a>
<span class="sourceLineNo">4867</span><a id="line.4867">                        }</a>
<span class="sourceLineNo">4868</span><a id="line.4868">                else if(value instanceof ISeq || value instanceof IPersistentList)</a>
<span class="sourceLineNo">4869</span><a id="line.4869">                        {</a>
<span class="sourceLineNo">4870</span><a id="line.4870">                        emitListAsObjectArray(value, gen);</a>
<span class="sourceLineNo">4871</span><a id="line.4871">                        gen.invokeStatic(Type.getType(java.util.Arrays.class),</a>
<span class="sourceLineNo">4872</span><a id="line.4872">                                                         Method.getMethod("java.util.List asList(Object[])"));</a>
<span class="sourceLineNo">4873</span><a id="line.4873">                        gen.invokeStatic(Type.getType(PersistentList.class),</a>
<span class="sourceLineNo">4874</span><a id="line.4874">                                                         Method.getMethod(</a>
<span class="sourceLineNo">4875</span><a id="line.4875">                                                                         "clojure.lang.IPersistentList create(java.util.List)"));</a>
<span class="sourceLineNo">4876</span><a id="line.4876">                        }</a>
<span class="sourceLineNo">4877</span><a id="line.4877">                else if(value instanceof Pattern)</a>
<span class="sourceLineNo">4878</span><a id="line.4878">                        {</a>
<span class="sourceLineNo">4879</span><a id="line.4879">                        emitValue(value.toString(), gen);</a>
<span class="sourceLineNo">4880</span><a id="line.4880">                        gen.invokeStatic(Type.getType(Pattern.class),</a>
<span class="sourceLineNo">4881</span><a id="line.4881">                                                         Method.getMethod("java.util.regex.Pattern compile(String)"));</a>
<span class="sourceLineNo">4882</span><a id="line.4882">                        }</a>
<span class="sourceLineNo">4883</span><a id="line.4883">                else</a>
<span class="sourceLineNo">4884</span><a id="line.4884">                        {</a>
<span class="sourceLineNo">4885</span><a id="line.4885">                        String cs = null;</a>
<span class="sourceLineNo">4886</span><a id="line.4886">                        try</a>
<span class="sourceLineNo">4887</span><a id="line.4887">                                {</a>
<span class="sourceLineNo">4888</span><a id="line.4888">                                cs = RT.printString(value);</a>
<span class="sourceLineNo">4889</span><a id="line.4889">//                              System.out.println("WARNING SLOW CODE: " + Util.classOf(value) + " -&gt; " + cs);</a>
<span class="sourceLineNo">4890</span><a id="line.4890">                                }</a>
<span class="sourceLineNo">4891</span><a id="line.4891">                        catch(Exception e)</a>
<span class="sourceLineNo">4892</span><a id="line.4892">                                {</a>
<span class="sourceLineNo">4893</span><a id="line.4893">                                throw Util.runtimeException(</a>
<span class="sourceLineNo">4894</span><a id="line.4894">                                                "Can't embed object in code, maybe print-dup not defined: " +</a>
<span class="sourceLineNo">4895</span><a id="line.4895">                                                value);</a>
<span class="sourceLineNo">4896</span><a id="line.4896">                                }</a>
<span class="sourceLineNo">4897</span><a id="line.4897">                        if(cs.length() == 0)</a>
<span class="sourceLineNo">4898</span><a id="line.4898">                                throw Util.runtimeException(</a>
<span class="sourceLineNo">4899</span><a id="line.4899">                                                "Can't embed unreadable object in code: " + value);</a>
<span class="sourceLineNo">4900</span><a id="line.4900"></a>
<span class="sourceLineNo">4901</span><a id="line.4901">                        if(cs.startsWith("#&lt;"))</a>
<span class="sourceLineNo">4902</span><a id="line.4902">                                throw Util.runtimeException(</a>
<span class="sourceLineNo">4903</span><a id="line.4903">                                                "Can't embed unreadable object in code: " + cs);</a>
<span class="sourceLineNo">4904</span><a id="line.4904"></a>
<span class="sourceLineNo">4905</span><a id="line.4905">                        gen.push(cs);</a>
<span class="sourceLineNo">4906</span><a id="line.4906">                        gen.invokeStatic(RT_TYPE, readStringMethod);</a>
<span class="sourceLineNo">4907</span><a id="line.4907">                        partial = false;</a>
<span class="sourceLineNo">4908</span><a id="line.4908">                        }</a>
<span class="sourceLineNo">4909</span><a id="line.4909"></a>
<span class="sourceLineNo">4910</span><a id="line.4910">                if(partial)</a>
<span class="sourceLineNo">4911</span><a id="line.4911">                        {</a>
<span class="sourceLineNo">4912</span><a id="line.4912">                        if(value instanceof IObj &amp;&amp; RT.count(((IObj) value).meta()) &gt; 0)</a>
<span class="sourceLineNo">4913</span><a id="line.4913">                                {</a>
<span class="sourceLineNo">4914</span><a id="line.4914">                                gen.checkCast(IOBJ_TYPE);</a>
<span class="sourceLineNo">4915</span><a id="line.4915">                Object m = ((IObj) value).meta();</a>
<span class="sourceLineNo">4916</span><a id="line.4916">                                emitValue(elideMeta(m), gen);</a>
<span class="sourceLineNo">4917</span><a id="line.4917">                                gen.checkCast(IPERSISTENTMAP_TYPE);</a>
<span class="sourceLineNo">4918</span><a id="line.4918">                                gen.invokeInterface(IOBJ_TYPE,</a>
<span class="sourceLineNo">4919</span><a id="line.4919">                                                    Method.getMethod("clojure.lang.IObj withMeta(clojure.lang.IPersistentMap)"));</a>
<span class="sourceLineNo">4920</span><a id="line.4920">                                }</a>
<span class="sourceLineNo">4921</span><a id="line.4921">                        }</a>
<span class="sourceLineNo">4922</span><a id="line.4922">        }</a>
<span class="sourceLineNo">4923</span><a id="line.4923"></a>
<span class="sourceLineNo">4924</span><a id="line.4924"></a>
<span class="sourceLineNo">4925</span><a id="line.4925">        void emitConstants(GeneratorAdapter clinitgen){</a>
<span class="sourceLineNo">4926</span><a id="line.4926">                try</a>
<span class="sourceLineNo">4927</span><a id="line.4927">                        {</a>
<span class="sourceLineNo">4928</span><a id="line.4928">                        Var.pushThreadBindings(RT.map(RT.PRINT_DUP, RT.T));</a>
<span class="sourceLineNo">4929</span><a id="line.4929"></a>
<span class="sourceLineNo">4930</span><a id="line.4930">                        for(int i = 0; i &lt; constants.count(); i++)</a>
<span class="sourceLineNo">4931</span><a id="line.4931">                                {</a>
<span class="sourceLineNo">4932</span><a id="line.4932">                if(usedConstants.contains(i))</a>
<span class="sourceLineNo">4933</span><a id="line.4933">                    {</a>
<span class="sourceLineNo">4934</span><a id="line.4934">                    emitValue(constants.nth(i), clinitgen);</a>
<span class="sourceLineNo">4935</span><a id="line.4935">                    clinitgen.checkCast(constantType(i));</a>
<span class="sourceLineNo">4936</span><a id="line.4936">                    clinitgen.putStatic(objtype, constantName(i), constantType(i));</a>
<span class="sourceLineNo">4937</span><a id="line.4937">                    }</a>
<span class="sourceLineNo">4938</span><a id="line.4938">                                }</a>
<span class="sourceLineNo">4939</span><a id="line.4939">                        }</a>
<span class="sourceLineNo">4940</span><a id="line.4940">                finally</a>
<span class="sourceLineNo">4941</span><a id="line.4941">                        {</a>
<span class="sourceLineNo">4942</span><a id="line.4942">                        Var.popThreadBindings();</a>
<span class="sourceLineNo">4943</span><a id="line.4943">                        }</a>
<span class="sourceLineNo">4944</span><a id="line.4944">        }</a>
<span class="sourceLineNo">4945</span><a id="line.4945"></a>
<span class="sourceLineNo">4946</span><a id="line.4946">        boolean isMutable(LocalBinding lb){</a>
<span class="sourceLineNo">4947</span><a id="line.4947">                return isVolatile(lb) ||</a>
<span class="sourceLineNo">4948</span><a id="line.4948">                       RT.booleanCast(RT.contains(fields, lb.sym)) &amp;&amp;</a>
<span class="sourceLineNo">4949</span><a id="line.4949">                       RT.booleanCast(RT.get(lb.sym.meta(), Keyword.intern("unsynchronized-mutable")));</a>
<span class="sourceLineNo">4950</span><a id="line.4950">        }</a>
<span class="sourceLineNo">4951</span><a id="line.4951"></a>
<span class="sourceLineNo">4952</span><a id="line.4952">        boolean isVolatile(LocalBinding lb){</a>
<span class="sourceLineNo">4953</span><a id="line.4953">                return RT.booleanCast(RT.contains(fields, lb.sym)) &amp;&amp;</a>
<span class="sourceLineNo">4954</span><a id="line.4954">                       RT.booleanCast(RT.get(lb.sym.meta(), Keyword.intern("volatile-mutable")));</a>
<span class="sourceLineNo">4955</span><a id="line.4955">        }</a>
<span class="sourceLineNo">4956</span><a id="line.4956"></a>
<span class="sourceLineNo">4957</span><a id="line.4957">        boolean isDeftype(){</a>
<span class="sourceLineNo">4958</span><a id="line.4958">                return fields != null;</a>
<span class="sourceLineNo">4959</span><a id="line.4959">        }</a>
<span class="sourceLineNo">4960</span><a id="line.4960"></a>
<span class="sourceLineNo">4961</span><a id="line.4961">        boolean supportsMeta(){</a>
<span class="sourceLineNo">4962</span><a id="line.4962">                return !isDeftype();</a>
<span class="sourceLineNo">4963</span><a id="line.4963">        }</a>
<span class="sourceLineNo">4964</span><a id="line.4964">        void emitClearCloses(GeneratorAdapter gen){</a>
<span class="sourceLineNo">4965</span><a id="line.4965">//              int a = 1;</a>
<span class="sourceLineNo">4966</span><a id="line.4966">//              for(ISeq s = RT.keys(closes); s != null; s = s.next(), ++a)</a>
<span class="sourceLineNo">4967</span><a id="line.4967">//                      {</a>
<span class="sourceLineNo">4968</span><a id="line.4968">//                      LocalBinding lb = (LocalBinding) s.first();</a>
<span class="sourceLineNo">4969</span><a id="line.4969">//                      Class primc = lb.getPrimitiveType();</a>
<span class="sourceLineNo">4970</span><a id="line.4970">//                      if(primc == null)</a>
<span class="sourceLineNo">4971</span><a id="line.4971">//                              {</a>
<span class="sourceLineNo">4972</span><a id="line.4972">//                              gen.loadThis();</a>
<span class="sourceLineNo">4973</span><a id="line.4973">//                              gen.visitInsn(Opcodes.ACONST_NULL);</a>
<span class="sourceLineNo">4974</span><a id="line.4974">//                              gen.putField(objtype, lb.name, OBJECT_TYPE);</a>
<span class="sourceLineNo">4975</span><a id="line.4975">//                              }</a>
<span class="sourceLineNo">4976</span><a id="line.4976">//                      }</a>
<span class="sourceLineNo">4977</span><a id="line.4977">        }</a>
<span class="sourceLineNo">4978</span><a id="line.4978"></a>
<span class="sourceLineNo">4979</span><a id="line.4979">        synchronized Class getCompiledClass(){</a>
<span class="sourceLineNo">4980</span><a id="line.4980">                if(compiledClass == null)</a>
<span class="sourceLineNo">4981</span><a id="line.4981">//                      if(RT.booleanCast(COMPILE_FILES.deref()))</a>
<span class="sourceLineNo">4982</span><a id="line.4982">//                              compiledClass = RT.classForName(name);//loader.defineClass(name, bytecode);</a>
<span class="sourceLineNo">4983</span><a id="line.4983">//                      else</a>
<span class="sourceLineNo">4984</span><a id="line.4984">                                {</a>
<span class="sourceLineNo">4985</span><a id="line.4985">                                loader = (DynamicClassLoader) LOADER.deref();</a>
<span class="sourceLineNo">4986</span><a id="line.4986">                                compiledClass = loader.defineClass(name, bytecode, src);</a>
<span class="sourceLineNo">4987</span><a id="line.4987">                                }</a>
<span class="sourceLineNo">4988</span><a id="line.4988">                return compiledClass;</a>
<span class="sourceLineNo">4989</span><a id="line.4989">        }</a>
<span class="sourceLineNo">4990</span><a id="line.4990"></a>
<span class="sourceLineNo">4991</span><a id="line.4991">        public Object eval() {</a>
<span class="sourceLineNo">4992</span><a id="line.4992">                if(isDeftype())</a>
<span class="sourceLineNo">4993</span><a id="line.4993">                        return null;</a>
<span class="sourceLineNo">4994</span><a id="line.4994">                try</a>
<span class="sourceLineNo">4995</span><a id="line.4995">                        {</a>
<span class="sourceLineNo">4996</span><a id="line.4996">                        return getCompiledClass().newInstance();</a>
<span class="sourceLineNo">4997</span><a id="line.4997">                        }</a>
<span class="sourceLineNo">4998</span><a id="line.4998">                catch(Exception e)</a>
<span class="sourceLineNo">4999</span><a id="line.4999">                        {</a>
<span class="sourceLineNo">5000</span><a id="line.5000">                        throw Util.sneakyThrow(e);</a>
<span class="sourceLineNo">5001</span><a id="line.5001">                        }</a>
<span class="sourceLineNo">5002</span><a id="line.5002">        }</a>
<span class="sourceLineNo">5003</span><a id="line.5003"></a>
<span class="sourceLineNo">5004</span><a id="line.5004">        public void emitLetFnInits(GeneratorAdapter gen, ObjExpr objx, IPersistentSet letFnLocals){</a>
<span class="sourceLineNo">5005</span><a id="line.5005">                //objx arg is enclosing objx, not this</a>
<span class="sourceLineNo">5006</span><a id="line.5006">                gen.checkCast(objtype);</a>
<span class="sourceLineNo">5007</span><a id="line.5007"></a>
<span class="sourceLineNo">5008</span><a id="line.5008">                for(ISeq s = RT.keys(closes); s != null; s = s.next())</a>
<span class="sourceLineNo">5009</span><a id="line.5009">                        {</a>
<span class="sourceLineNo">5010</span><a id="line.5010">                        LocalBinding lb = (LocalBinding) s.first();</a>
<span class="sourceLineNo">5011</span><a id="line.5011">                        if(letFnLocals.contains(lb))</a>
<span class="sourceLineNo">5012</span><a id="line.5012">                                {</a>
<span class="sourceLineNo">5013</span><a id="line.5013">                                Class primc = lb.getPrimitiveType();</a>
<span class="sourceLineNo">5014</span><a id="line.5014">                                gen.dup();</a>
<span class="sourceLineNo">5015</span><a id="line.5015">                                if(primc != null)</a>
<span class="sourceLineNo">5016</span><a id="line.5016">                                        {</a>
<span class="sourceLineNo">5017</span><a id="line.5017">                                        objx.emitUnboxedLocal(gen, lb);</a>
<span class="sourceLineNo">5018</span><a id="line.5018">                                        gen.putField(objtype, lb.name, Type.getType(primc));</a>
<span class="sourceLineNo">5019</span><a id="line.5019">                                        }</a>
<span class="sourceLineNo">5020</span><a id="line.5020">                                else</a>
<span class="sourceLineNo">5021</span><a id="line.5021">                                        {</a>
<span class="sourceLineNo">5022</span><a id="line.5022">                                        objx.emitLocal(gen, lb, false);</a>
<span class="sourceLineNo">5023</span><a id="line.5023">                                        gen.putField(objtype, lb.name, OBJECT_TYPE);</a>
<span class="sourceLineNo">5024</span><a id="line.5024">                                        }</a>
<span class="sourceLineNo">5025</span><a id="line.5025">                                }</a>
<span class="sourceLineNo">5026</span><a id="line.5026">                        }</a>
<span class="sourceLineNo">5027</span><a id="line.5027">                gen.pop();</a>
<span class="sourceLineNo">5028</span><a id="line.5028"></a>
<span class="sourceLineNo">5029</span><a id="line.5029">        }</a>
<span class="sourceLineNo">5030</span><a id="line.5030"></a>
<span class="sourceLineNo">5031</span><a id="line.5031">        public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">5032</span><a id="line.5032">                //emitting a Fn means constructing an instance, feeding closed-overs from enclosing scope, if any</a>
<span class="sourceLineNo">5033</span><a id="line.5033">                //objx arg is enclosing objx, not this</a>
<span class="sourceLineNo">5034</span><a id="line.5034">//              getCompiledClass();</a>
<span class="sourceLineNo">5035</span><a id="line.5035">                if(isDeftype())</a>
<span class="sourceLineNo">5036</span><a id="line.5036">                        {</a>
<span class="sourceLineNo">5037</span><a id="line.5037">                        gen.visitInsn(Opcodes.ACONST_NULL);</a>
<span class="sourceLineNo">5038</span><a id="line.5038">                        }</a>
<span class="sourceLineNo">5039</span><a id="line.5039">                else</a>
<span class="sourceLineNo">5040</span><a id="line.5040">                        {</a>
<span class="sourceLineNo">5041</span><a id="line.5041">                        gen.newInstance(objtype);</a>
<span class="sourceLineNo">5042</span><a id="line.5042">                        gen.dup();</a>
<span class="sourceLineNo">5043</span><a id="line.5043">                        if(supportsMeta())</a>
<span class="sourceLineNo">5044</span><a id="line.5044">                                gen.visitInsn(Opcodes.ACONST_NULL);</a>
<span class="sourceLineNo">5045</span><a id="line.5045">                        for(ISeq s = RT.seq(closesExprs); s != null; s = s.next())</a>
<span class="sourceLineNo">5046</span><a id="line.5046">                                {</a>
<span class="sourceLineNo">5047</span><a id="line.5047">                LocalBindingExpr lbe = (LocalBindingExpr) s.first();</a>
<span class="sourceLineNo">5048</span><a id="line.5048">                                LocalBinding lb = lbe.b;</a>
<span class="sourceLineNo">5049</span><a id="line.5049">                                if(lb.getPrimitiveType() != null)</a>
<span class="sourceLineNo">5050</span><a id="line.5050">                                        objx.emitUnboxedLocal(gen, lb);</a>
<span class="sourceLineNo">5051</span><a id="line.5051">                                else</a>
<span class="sourceLineNo">5052</span><a id="line.5052">                                        objx.emitLocal(gen, lb, lbe.shouldClear);</a>
<span class="sourceLineNo">5053</span><a id="line.5053">                                }</a>
<span class="sourceLineNo">5054</span><a id="line.5054">                        gen.invokeConstructor(objtype, new Method("&lt;init&gt;", Type.VOID_TYPE, ctorTypes()));</a>
<span class="sourceLineNo">5055</span><a id="line.5055">                        }</a>
<span class="sourceLineNo">5056</span><a id="line.5056">                if(context == C.STATEMENT)</a>
<span class="sourceLineNo">5057</span><a id="line.5057">                        gen.pop();</a>
<span class="sourceLineNo">5058</span><a id="line.5058">        }</a>
<span class="sourceLineNo">5059</span><a id="line.5059"></a>
<span class="sourceLineNo">5060</span><a id="line.5060">        public boolean hasJavaClass() {</a>
<span class="sourceLineNo">5061</span><a id="line.5061">                return true;</a>
<span class="sourceLineNo">5062</span><a id="line.5062">        }</a>
<span class="sourceLineNo">5063</span><a id="line.5063"></a>
<span class="sourceLineNo">5064</span><a id="line.5064">    Class jc;</a>
<span class="sourceLineNo">5065</span><a id="line.5065">        public Class getJavaClass() {</a>
<span class="sourceLineNo">5066</span><a id="line.5066">                if (jc == null)</a>
<span class="sourceLineNo">5067</span><a id="line.5067">            jc = (compiledClass != null) ? compiledClass</a>
<span class="sourceLineNo">5068</span><a id="line.5068">                : (tag != null) ? HostExpr.tagToClass(tag)</a>
<span class="sourceLineNo">5069</span><a id="line.5069">                : IFn.class;</a>
<span class="sourceLineNo">5070</span><a id="line.5070">        return jc;</a>
<span class="sourceLineNo">5071</span><a id="line.5071">        }</a>
<span class="sourceLineNo">5072</span><a id="line.5072"></a>
<span class="sourceLineNo">5073</span><a id="line.5073">        public void emitAssignLocal(GeneratorAdapter gen, LocalBinding lb,Expr val){</a>
<span class="sourceLineNo">5074</span><a id="line.5074">                if(!isMutable(lb))</a>
<span class="sourceLineNo">5075</span><a id="line.5075">                        throw new IllegalArgumentException("Cannot assign to non-mutable: " + lb.name);</a>
<span class="sourceLineNo">5076</span><a id="line.5076">                Class primc = lb.getPrimitiveType();</a>
<span class="sourceLineNo">5077</span><a id="line.5077">                gen.loadThis();</a>
<span class="sourceLineNo">5078</span><a id="line.5078">                if(primc != null)</a>
<span class="sourceLineNo">5079</span><a id="line.5079">                        {</a>
<span class="sourceLineNo">5080</span><a id="line.5080">                        if(!(val instanceof MaybePrimitiveExpr &amp;&amp; ((MaybePrimitiveExpr) val).canEmitPrimitive()))</a>
<span class="sourceLineNo">5081</span><a id="line.5081">                                throw new IllegalArgumentException("Must assign primitive to primitive mutable: " + lb.name);</a>
<span class="sourceLineNo">5082</span><a id="line.5082">                        MaybePrimitiveExpr me = (MaybePrimitiveExpr) val;</a>
<span class="sourceLineNo">5083</span><a id="line.5083">                        me.emitUnboxed(C.EXPRESSION, this, gen);</a>
<span class="sourceLineNo">5084</span><a id="line.5084">                        gen.putField(objtype, lb.name, Type.getType(primc));</a>
<span class="sourceLineNo">5085</span><a id="line.5085">                        }</a>
<span class="sourceLineNo">5086</span><a id="line.5086">                else</a>
<span class="sourceLineNo">5087</span><a id="line.5087">                        {</a>
<span class="sourceLineNo">5088</span><a id="line.5088">                        val.emit(C.EXPRESSION, this, gen);</a>
<span class="sourceLineNo">5089</span><a id="line.5089">                        gen.putField(objtype, lb.name, OBJECT_TYPE);</a>
<span class="sourceLineNo">5090</span><a id="line.5090">                        }</a>
<span class="sourceLineNo">5091</span><a id="line.5091">        }</a>
<span class="sourceLineNo">5092</span><a id="line.5092"></a>
<span class="sourceLineNo">5093</span><a id="line.5093">        private void emitLocal(GeneratorAdapter gen, LocalBinding lb, boolean clear){</a>
<span class="sourceLineNo">5094</span><a id="line.5094">                if(closes.containsKey(lb))</a>
<span class="sourceLineNo">5095</span><a id="line.5095">                        {</a>
<span class="sourceLineNo">5096</span><a id="line.5096">                        Class primc = lb.getPrimitiveType();</a>
<span class="sourceLineNo">5097</span><a id="line.5097">                        gen.loadThis();</a>
<span class="sourceLineNo">5098</span><a id="line.5098">                        if(primc != null)</a>
<span class="sourceLineNo">5099</span><a id="line.5099">                                {</a>
<span class="sourceLineNo">5100</span><a id="line.5100">                                gen.getField(objtype, lb.name, Type.getType(primc));</a>
<span class="sourceLineNo">5101</span><a id="line.5101">                                HostExpr.emitBoxReturn(this, gen, primc);</a>
<span class="sourceLineNo">5102</span><a id="line.5102">                                }</a>
<span class="sourceLineNo">5103</span><a id="line.5103">                        else</a>
<span class="sourceLineNo">5104</span><a id="line.5104">                                {</a>
<span class="sourceLineNo">5105</span><a id="line.5105">                                gen.getField(objtype, lb.name, OBJECT_TYPE);</a>
<span class="sourceLineNo">5106</span><a id="line.5106">                                if(onceOnly &amp;&amp; clear &amp;&amp; lb.canBeCleared)</a>
<span class="sourceLineNo">5107</span><a id="line.5107">                                        {</a>
<span class="sourceLineNo">5108</span><a id="line.5108">                                        gen.loadThis();</a>
<span class="sourceLineNo">5109</span><a id="line.5109">                                        gen.visitInsn(Opcodes.ACONST_NULL);</a>
<span class="sourceLineNo">5110</span><a id="line.5110">                                        gen.putField(objtype, lb.name, OBJECT_TYPE);</a>
<span class="sourceLineNo">5111</span><a id="line.5111">                                        }</a>
<span class="sourceLineNo">5112</span><a id="line.5112">                                }</a>
<span class="sourceLineNo">5113</span><a id="line.5113">                        }</a>
<span class="sourceLineNo">5114</span><a id="line.5114">                else</a>
<span class="sourceLineNo">5115</span><a id="line.5115">                        {</a>
<span class="sourceLineNo">5116</span><a id="line.5116">                        int argoff = canBeDirect ?0:1;</a>
<span class="sourceLineNo">5117</span><a id="line.5117">                        Class primc = lb.getPrimitiveType();</a>
<span class="sourceLineNo">5118</span><a id="line.5118">//            String rep = lb.sym.name + " " + lb.toString().substring(lb.toString().lastIndexOf('@'));</a>
<span class="sourceLineNo">5119</span><a id="line.5119">                        if(lb.isArg)</a>
<span class="sourceLineNo">5120</span><a id="line.5120">                                {</a>
<span class="sourceLineNo">5121</span><a id="line.5121">                                gen.loadArg(lb.idx-argoff);</a>
<span class="sourceLineNo">5122</span><a id="line.5122">                                if(primc != null)</a>
<span class="sourceLineNo">5123</span><a id="line.5123">                                        HostExpr.emitBoxReturn(this, gen, primc);</a>
<span class="sourceLineNo">5124</span><a id="line.5124">                else</a>
<span class="sourceLineNo">5125</span><a id="line.5125">                    {</a>
<span class="sourceLineNo">5126</span><a id="line.5126">                    if(clear &amp;&amp; lb.canBeCleared)</a>
<span class="sourceLineNo">5127</span><a id="line.5127">                        {</a>
<span class="sourceLineNo">5128</span><a id="line.5128">//                        System.out.println("clear: " + rep);</a>
<span class="sourceLineNo">5129</span><a id="line.5129">                        gen.visitInsn(Opcodes.ACONST_NULL);</a>
<span class="sourceLineNo">5130</span><a id="line.5130">                        gen.storeArg(lb.idx - argoff);</a>
<span class="sourceLineNo">5131</span><a id="line.5131">                        }</a>
<span class="sourceLineNo">5132</span><a id="line.5132">                    else</a>
<span class="sourceLineNo">5133</span><a id="line.5133">                        {</a>
<span class="sourceLineNo">5134</span><a id="line.5134">//                        System.out.println("use: " + rep);</a>
<span class="sourceLineNo">5135</span><a id="line.5135">                        }</a>
<span class="sourceLineNo">5136</span><a id="line.5136">                    }     </a>
<span class="sourceLineNo">5137</span><a id="line.5137">                                }</a>
<span class="sourceLineNo">5138</span><a id="line.5138">                        else</a>
<span class="sourceLineNo">5139</span><a id="line.5139">                                {</a>
<span class="sourceLineNo">5140</span><a id="line.5140">                                if(primc != null)</a>
<span class="sourceLineNo">5141</span><a id="line.5141">                                        {</a>
<span class="sourceLineNo">5142</span><a id="line.5142">                                        gen.visitVarInsn(Type.getType(primc).getOpcode(Opcodes.ILOAD), lb.idx);</a>
<span class="sourceLineNo">5143</span><a id="line.5143">                                        HostExpr.emitBoxReturn(this, gen, primc);</a>
<span class="sourceLineNo">5144</span><a id="line.5144">                                        }</a>
<span class="sourceLineNo">5145</span><a id="line.5145">                                else</a>
<span class="sourceLineNo">5146</span><a id="line.5146">                    {</a>
<span class="sourceLineNo">5147</span><a id="line.5147">                                        gen.visitVarInsn(OBJECT_TYPE.getOpcode(Opcodes.ILOAD), lb.idx);</a>
<span class="sourceLineNo">5148</span><a id="line.5148">                    if(clear &amp;&amp; lb.canBeCleared)</a>
<span class="sourceLineNo">5149</span><a id="line.5149">                        {</a>
<span class="sourceLineNo">5150</span><a id="line.5150">//                        System.out.println("clear: " + rep);</a>
<span class="sourceLineNo">5151</span><a id="line.5151">                        gen.visitInsn(Opcodes.ACONST_NULL);</a>
<span class="sourceLineNo">5152</span><a id="line.5152">                        gen.visitVarInsn(OBJECT_TYPE.getOpcode(Opcodes.ISTORE), lb.idx);</a>
<span class="sourceLineNo">5153</span><a id="line.5153">                        }</a>
<span class="sourceLineNo">5154</span><a id="line.5154">                    else</a>
<span class="sourceLineNo">5155</span><a id="line.5155">                        {</a>
<span class="sourceLineNo">5156</span><a id="line.5156">//                        System.out.println("use: " + rep);</a>
<span class="sourceLineNo">5157</span><a id="line.5157">                        }</a>
<span class="sourceLineNo">5158</span><a id="line.5158">                    }</a>
<span class="sourceLineNo">5159</span><a id="line.5159">                                }</a>
<span class="sourceLineNo">5160</span><a id="line.5160">                        }</a>
<span class="sourceLineNo">5161</span><a id="line.5161">        }</a>
<span class="sourceLineNo">5162</span><a id="line.5162"></a>
<span class="sourceLineNo">5163</span><a id="line.5163">        private void emitUnboxedLocal(GeneratorAdapter gen, LocalBinding lb){</a>
<span class="sourceLineNo">5164</span><a id="line.5164">                int argoff = canBeDirect ?0:1;</a>
<span class="sourceLineNo">5165</span><a id="line.5165">                Class primc = lb.getPrimitiveType();</a>
<span class="sourceLineNo">5166</span><a id="line.5166">                if(closes.containsKey(lb))</a>
<span class="sourceLineNo">5167</span><a id="line.5167">                        {</a>
<span class="sourceLineNo">5168</span><a id="line.5168">                        gen.loadThis();</a>
<span class="sourceLineNo">5169</span><a id="line.5169">                        gen.getField(objtype, lb.name, Type.getType(primc));</a>
<span class="sourceLineNo">5170</span><a id="line.5170">                        }</a>
<span class="sourceLineNo">5171</span><a id="line.5171">                else if(lb.isArg)</a>
<span class="sourceLineNo">5172</span><a id="line.5172">                        gen.loadArg(lb.idx-argoff);</a>
<span class="sourceLineNo">5173</span><a id="line.5173">                else</a>
<span class="sourceLineNo">5174</span><a id="line.5174">                        gen.visitVarInsn(Type.getType(primc).getOpcode(Opcodes.ILOAD), lb.idx);</a>
<span class="sourceLineNo">5175</span><a id="line.5175">        }</a>
<span class="sourceLineNo">5176</span><a id="line.5176"></a>
<span class="sourceLineNo">5177</span><a id="line.5177">        public void emitVar(GeneratorAdapter gen, Var var){</a>
<span class="sourceLineNo">5178</span><a id="line.5178">                Integer i = (Integer) vars.valAt(var);</a>
<span class="sourceLineNo">5179</span><a id="line.5179">                emitConstant(gen, i);</a>
<span class="sourceLineNo">5180</span><a id="line.5180">                //gen.getStatic(fntype, munge(var.sym.toString()), VAR_TYPE);</a>
<span class="sourceLineNo">5181</span><a id="line.5181">        }</a>
<span class="sourceLineNo">5182</span><a id="line.5182"></a>
<span class="sourceLineNo">5183</span><a id="line.5183">        final static Method varGetMethod = Method.getMethod("Object get()");</a>
<span class="sourceLineNo">5184</span><a id="line.5184">        final static Method varGetRawMethod = Method.getMethod("Object getRawRoot()");</a>
<span class="sourceLineNo">5185</span><a id="line.5185"></a>
<span class="sourceLineNo">5186</span><a id="line.5186">        public void emitVarValue(GeneratorAdapter gen, Var v){</a>
<span class="sourceLineNo">5187</span><a id="line.5187">                Integer i = (Integer) vars.valAt(v);</a>
<span class="sourceLineNo">5188</span><a id="line.5188">                if(!v.isDynamic())</a>
<span class="sourceLineNo">5189</span><a id="line.5189">                        {</a>
<span class="sourceLineNo">5190</span><a id="line.5190">                        emitConstant(gen, i);</a>
<span class="sourceLineNo">5191</span><a id="line.5191">                        gen.invokeVirtual(VAR_TYPE, varGetRawMethod);</a>
<span class="sourceLineNo">5192</span><a id="line.5192">                        }</a>
<span class="sourceLineNo">5193</span><a id="line.5193">                else</a>
<span class="sourceLineNo">5194</span><a id="line.5194">                        {</a>
<span class="sourceLineNo">5195</span><a id="line.5195">                        emitConstant(gen, i);</a>
<span class="sourceLineNo">5196</span><a id="line.5196">                        gen.invokeVirtual(VAR_TYPE, varGetMethod);</a>
<span class="sourceLineNo">5197</span><a id="line.5197">                        }</a>
<span class="sourceLineNo">5198</span><a id="line.5198">        }</a>
<span class="sourceLineNo">5199</span><a id="line.5199"></a>
<span class="sourceLineNo">5200</span><a id="line.5200">        public void emitKeyword(GeneratorAdapter gen, Keyword k){</a>
<span class="sourceLineNo">5201</span><a id="line.5201">                Integer i = (Integer) keywords.valAt(k);</a>
<span class="sourceLineNo">5202</span><a id="line.5202">                emitConstant(gen, i);</a>
<span class="sourceLineNo">5203</span><a id="line.5203">//              gen.getStatic(fntype, munge(k.sym.toString()), KEYWORD_TYPE);</a>
<span class="sourceLineNo">5204</span><a id="line.5204">        }</a>
<span class="sourceLineNo">5205</span><a id="line.5205"></a>
<span class="sourceLineNo">5206</span><a id="line.5206">        public void emitConstant(GeneratorAdapter gen, int id){</a>
<span class="sourceLineNo">5207</span><a id="line.5207">        usedConstants = (IPersistentSet) usedConstants.cons(id);</a>
<span class="sourceLineNo">5208</span><a id="line.5208">                gen.getStatic(objtype, constantName(id), constantType(id));</a>
<span class="sourceLineNo">5209</span><a id="line.5209">        }</a>
<span class="sourceLineNo">5210</span><a id="line.5210"></a>
<span class="sourceLineNo">5211</span><a id="line.5211"></a>
<span class="sourceLineNo">5212</span><a id="line.5212">        String constantName(int id){</a>
<span class="sourceLineNo">5213</span><a id="line.5213">                return CONST_PREFIX + id;</a>
<span class="sourceLineNo">5214</span><a id="line.5214">        }</a>
<span class="sourceLineNo">5215</span><a id="line.5215"></a>
<span class="sourceLineNo">5216</span><a id="line.5216">        String siteName(int n){</a>
<span class="sourceLineNo">5217</span><a id="line.5217">                return "__site__" + n;</a>
<span class="sourceLineNo">5218</span><a id="line.5218">        }</a>
<span class="sourceLineNo">5219</span><a id="line.5219"></a>
<span class="sourceLineNo">5220</span><a id="line.5220">        String siteNameStatic(int n){</a>
<span class="sourceLineNo">5221</span><a id="line.5221">                return siteName(n) + "__";</a>
<span class="sourceLineNo">5222</span><a id="line.5222">        }</a>
<span class="sourceLineNo">5223</span><a id="line.5223"></a>
<span class="sourceLineNo">5224</span><a id="line.5224">        String thunkName(int n){</a>
<span class="sourceLineNo">5225</span><a id="line.5225">                return "__thunk__" + n;</a>
<span class="sourceLineNo">5226</span><a id="line.5226">        }</a>
<span class="sourceLineNo">5227</span><a id="line.5227"></a>
<span class="sourceLineNo">5228</span><a id="line.5228">        String cachedClassName(int n){</a>
<span class="sourceLineNo">5229</span><a id="line.5229">                return "__cached_class__" + n;</a>
<span class="sourceLineNo">5230</span><a id="line.5230">        }</a>
<span class="sourceLineNo">5231</span><a id="line.5231"></a>
<span class="sourceLineNo">5232</span><a id="line.5232">        String cachedVarName(int n){</a>
<span class="sourceLineNo">5233</span><a id="line.5233">                return "__cached_var__" + n;</a>
<span class="sourceLineNo">5234</span><a id="line.5234">        }</a>
<span class="sourceLineNo">5235</span><a id="line.5235"></a>
<span class="sourceLineNo">5236</span><a id="line.5236">        String varCallsiteName(int n){</a>
<span class="sourceLineNo">5237</span><a id="line.5237">                return "__var__callsite__" + n;</a>
<span class="sourceLineNo">5238</span><a id="line.5238">        }</a>
<span class="sourceLineNo">5239</span><a id="line.5239"></a>
<span class="sourceLineNo">5240</span><a id="line.5240">        String thunkNameStatic(int n){</a>
<span class="sourceLineNo">5241</span><a id="line.5241">                return thunkName(n) + "__";</a>
<span class="sourceLineNo">5242</span><a id="line.5242">        }</a>
<span class="sourceLineNo">5243</span><a id="line.5243"></a>
<span class="sourceLineNo">5244</span><a id="line.5244">        Type constantType(int id){</a>
<span class="sourceLineNo">5245</span><a id="line.5245">                Object o = constants.nth(id);</a>
<span class="sourceLineNo">5246</span><a id="line.5246">                Class c = clojure.lang.Util.classOf(o);</a>
<span class="sourceLineNo">5247</span><a id="line.5247">                if(c!= null &amp;&amp; Modifier.isPublic(c.getModifiers()))</a>
<span class="sourceLineNo">5248</span><a id="line.5248">                        {</a>
<span class="sourceLineNo">5249</span><a id="line.5249">                        //can't emit derived fn types due to visibility</a>
<span class="sourceLineNo">5250</span><a id="line.5250">                        if(LazySeq.class.isAssignableFrom(c))</a>
<span class="sourceLineNo">5251</span><a id="line.5251">                                return Type.getType(ISeq.class);</a>
<span class="sourceLineNo">5252</span><a id="line.5252">                        else if(c == Keyword.class)</a>
<span class="sourceLineNo">5253</span><a id="line.5253">                                return Type.getType(Keyword.class);</a>
<span class="sourceLineNo">5254</span><a id="line.5254">//                      else if(c == KeywordCallSite.class)</a>
<span class="sourceLineNo">5255</span><a id="line.5255">//                              return Type.getType(KeywordCallSite.class);</a>
<span class="sourceLineNo">5256</span><a id="line.5256">                        else if(RestFn.class.isAssignableFrom(c))</a>
<span class="sourceLineNo">5257</span><a id="line.5257">                                return Type.getType(RestFn.class);</a>
<span class="sourceLineNo">5258</span><a id="line.5258">                        else if(AFn.class.isAssignableFrom(c))</a>
<span class="sourceLineNo">5259</span><a id="line.5259">                                        return Type.getType(AFn.class);</a>
<span class="sourceLineNo">5260</span><a id="line.5260">                                else if(c == Var.class)</a>
<span class="sourceLineNo">5261</span><a id="line.5261">                                                return Type.getType(Var.class);</a>
<span class="sourceLineNo">5262</span><a id="line.5262">                                        else if(c == String.class)</a>
<span class="sourceLineNo">5263</span><a id="line.5263">                                                        return Type.getType(String.class);</a>
<span class="sourceLineNo">5264</span><a id="line.5264"></a>
<span class="sourceLineNo">5265</span><a id="line.5265">//                      return Type.getType(c);</a>
<span class="sourceLineNo">5266</span><a id="line.5266">                        }</a>
<span class="sourceLineNo">5267</span><a id="line.5267">                return OBJECT_TYPE;</a>
<span class="sourceLineNo">5268</span><a id="line.5268">        }</a>
<span class="sourceLineNo">5269</span><a id="line.5269"></a>
<span class="sourceLineNo">5270</span><a id="line.5270">}</a>
<span class="sourceLineNo">5271</span><a id="line.5271"></a>
<span class="sourceLineNo">5272</span><a id="line.5272">enum PATHTYPE {</a>
<span class="sourceLineNo">5273</span><a id="line.5273">    PATH, BRANCH;</a>
<span class="sourceLineNo">5274</span><a id="line.5274">}</a>
<span class="sourceLineNo">5275</span><a id="line.5275"></a>
<span class="sourceLineNo">5276</span><a id="line.5276">static class PathNode{</a>
<span class="sourceLineNo">5277</span><a id="line.5277">    final PATHTYPE type;</a>
<span class="sourceLineNo">5278</span><a id="line.5278">    final PathNode parent;</a>
<span class="sourceLineNo">5279</span><a id="line.5279"></a>
<span class="sourceLineNo">5280</span><a id="line.5280">    PathNode(PATHTYPE type, PathNode parent) {</a>
<span class="sourceLineNo">5281</span><a id="line.5281">        this.type = type;</a>
<span class="sourceLineNo">5282</span><a id="line.5282">        this.parent = parent;</a>
<span class="sourceLineNo">5283</span><a id="line.5283">    }</a>
<span class="sourceLineNo">5284</span><a id="line.5284">}</a>
<span class="sourceLineNo">5285</span><a id="line.5285"></a>
<span class="sourceLineNo">5286</span><a id="line.5286">static PathNode clearPathRoot(){</a>
<span class="sourceLineNo">5287</span><a id="line.5287">    return (PathNode) CLEAR_ROOT.get();</a>
<span class="sourceLineNo">5288</span><a id="line.5288">}</a>
<span class="sourceLineNo">5289</span><a id="line.5289">    </a>
<span class="sourceLineNo">5290</span><a id="line.5290">enum PSTATE{</a>
<span class="sourceLineNo">5291</span><a id="line.5291">        REQ, REST, DONE</a>
<span class="sourceLineNo">5292</span><a id="line.5292">}</a>
<span class="sourceLineNo">5293</span><a id="line.5293"></a>
<span class="sourceLineNo">5294</span><a id="line.5294">public static class FnMethod extends ObjMethod{</a>
<span class="sourceLineNo">5295</span><a id="line.5295">        //localbinding-&gt;localbinding</a>
<span class="sourceLineNo">5296</span><a id="line.5296">        PersistentVector reqParms = PersistentVector.EMPTY;</a>
<span class="sourceLineNo">5297</span><a id="line.5297">        LocalBinding restParm = null;</a>
<span class="sourceLineNo">5298</span><a id="line.5298">        Type[] argtypes;</a>
<span class="sourceLineNo">5299</span><a id="line.5299">        Class[] argclasses;</a>
<span class="sourceLineNo">5300</span><a id="line.5300">        Class retClass;</a>
<span class="sourceLineNo">5301</span><a id="line.5301">        String prim ;</a>
<span class="sourceLineNo">5302</span><a id="line.5302"></a>
<span class="sourceLineNo">5303</span><a id="line.5303">        public FnMethod(ObjExpr objx, ObjMethod parent){</a>
<span class="sourceLineNo">5304</span><a id="line.5304">                super(objx, parent);</a>
<span class="sourceLineNo">5305</span><a id="line.5305">        }</a>
<span class="sourceLineNo">5306</span><a id="line.5306"></a>
<span class="sourceLineNo">5307</span><a id="line.5307">        static public char classChar(Object x){</a>
<span class="sourceLineNo">5308</span><a id="line.5308">                Class c = null;</a>
<span class="sourceLineNo">5309</span><a id="line.5309">                if(x instanceof Class)</a>
<span class="sourceLineNo">5310</span><a id="line.5310">                        c = (Class) x;</a>
<span class="sourceLineNo">5311</span><a id="line.5311">                else if(x instanceof Symbol)</a>
<span class="sourceLineNo">5312</span><a id="line.5312">                        c = primClass((Symbol) x);</a>
<span class="sourceLineNo">5313</span><a id="line.5313">                if(c == null || !c.isPrimitive())</a>
<span class="sourceLineNo">5314</span><a id="line.5314">                        return 'O';</a>
<span class="sourceLineNo">5315</span><a id="line.5315">                if(c == long.class)</a>
<span class="sourceLineNo">5316</span><a id="line.5316">                        return 'L';</a>
<span class="sourceLineNo">5317</span><a id="line.5317">                if(c == double.class)</a>
<span class="sourceLineNo">5318</span><a id="line.5318">                        return 'D';</a>
<span class="sourceLineNo">5319</span><a id="line.5319">                throw new IllegalArgumentException("Only long and double primitives are supported");</a>
<span class="sourceLineNo">5320</span><a id="line.5320">        }</a>
<span class="sourceLineNo">5321</span><a id="line.5321"></a>
<span class="sourceLineNo">5322</span><a id="line.5322">        static public String primInterface(IPersistentVector arglist) {</a>
<span class="sourceLineNo">5323</span><a id="line.5323">                StringBuilder sb = new StringBuilder();</a>
<span class="sourceLineNo">5324</span><a id="line.5324">                for(int i=0;i&lt;arglist.count();i++)</a>
<span class="sourceLineNo">5325</span><a id="line.5325">                        sb.append(classChar(tagOf(arglist.nth(i))));</a>
<span class="sourceLineNo">5326</span><a id="line.5326">                sb.append(classChar(tagOf(arglist)));</a>
<span class="sourceLineNo">5327</span><a id="line.5327">                String ret = sb.toString();</a>
<span class="sourceLineNo">5328</span><a id="line.5328">                boolean prim = ret.contains("L") || ret.contains("D");</a>
<span class="sourceLineNo">5329</span><a id="line.5329">                if(prim &amp;&amp; arglist.count() &gt; 4)</a>
<span class="sourceLineNo">5330</span><a id="line.5330">                        throw new IllegalArgumentException("fns taking primitives support only 4 or fewer args");</a>
<span class="sourceLineNo">5331</span><a id="line.5331">                if(prim)</a>
<span class="sourceLineNo">5332</span><a id="line.5332">                        return "clojure.lang.IFn$" + ret;</a>
<span class="sourceLineNo">5333</span><a id="line.5333">                return null;</a>
<span class="sourceLineNo">5334</span><a id="line.5334">        }</a>
<span class="sourceLineNo">5335</span><a id="line.5335"></a>
<span class="sourceLineNo">5336</span><a id="line.5336">        static FnMethod parse(ObjExpr objx, ISeq form, Object rettag) {</a>
<span class="sourceLineNo">5337</span><a id="line.5337">                //([args] body...)</a>
<span class="sourceLineNo">5338</span><a id="line.5338">                IPersistentVector parms = (IPersistentVector) RT.first(form);</a>
<span class="sourceLineNo">5339</span><a id="line.5339">                ISeq body = RT.next(form);</a>
<span class="sourceLineNo">5340</span><a id="line.5340">                try</a>
<span class="sourceLineNo">5341</span><a id="line.5341">                        {</a>
<span class="sourceLineNo">5342</span><a id="line.5342">                        FnMethod method = new FnMethod(objx, (ObjMethod) METHOD.deref());</a>
<span class="sourceLineNo">5343</span><a id="line.5343">                        method.line = lineDeref();</a>
<span class="sourceLineNo">5344</span><a id="line.5344">                        method.column = columnDeref();</a>
<span class="sourceLineNo">5345</span><a id="line.5345">                        //register as the current method and set up a new env frame</a>
<span class="sourceLineNo">5346</span><a id="line.5346">            PathNode pnode =  (PathNode) CLEAR_PATH.get();</a>
<span class="sourceLineNo">5347</span><a id="line.5347">                        if(pnode == null)</a>
<span class="sourceLineNo">5348</span><a id="line.5348">                                pnode = new PathNode(PATHTYPE.PATH,null);</a>
<span class="sourceLineNo">5349</span><a id="line.5349">                        Var.pushThreadBindings(</a>
<span class="sourceLineNo">5350</span><a id="line.5350">                                        RT.mapUniqueKeys(</a>
<span class="sourceLineNo">5351</span><a id="line.5351">                                                        METHOD, method,</a>
<span class="sourceLineNo">5352</span><a id="line.5352">                                                        LOCAL_ENV, LOCAL_ENV.deref(),</a>
<span class="sourceLineNo">5353</span><a id="line.5353">                                                        LOOP_LOCALS, null,</a>
<span class="sourceLineNo">5354</span><a id="line.5354">                                                        NEXT_LOCAL_NUM, 0</a>
<span class="sourceLineNo">5355</span><a id="line.5355">                            ,CLEAR_PATH, pnode</a>
<span class="sourceLineNo">5356</span><a id="line.5356">                            ,CLEAR_ROOT, pnode</a>
<span class="sourceLineNo">5357</span><a id="line.5357">                            ,CLEAR_SITES, PersistentHashMap.EMPTY</a>
<span class="sourceLineNo">5358</span><a id="line.5358">                            ,METHOD_RETURN_CONTEXT, RT.T</a>
<span class="sourceLineNo">5359</span><a id="line.5359">                        ));</a>
<span class="sourceLineNo">5360</span><a id="line.5360"></a>
<span class="sourceLineNo">5361</span><a id="line.5361">                        method.prim = primInterface(parms);</a>
<span class="sourceLineNo">5362</span><a id="line.5362">                        if(method.prim != null)</a>
<span class="sourceLineNo">5363</span><a id="line.5363">                                method.prim = method.prim.replace('.', '/');</a>
<span class="sourceLineNo">5364</span><a id="line.5364"></a>
<span class="sourceLineNo">5365</span><a id="line.5365">                        if(rettag instanceof String)</a>
<span class="sourceLineNo">5366</span><a id="line.5366">                                rettag = Symbol.intern(null, (String) rettag);</a>
<span class="sourceLineNo">5367</span><a id="line.5367">            if(!(rettag instanceof Symbol))</a>
<span class="sourceLineNo">5368</span><a id="line.5368">                rettag = null;</a>
<span class="sourceLineNo">5369</span><a id="line.5369">            if(rettag != null)</a>
<span class="sourceLineNo">5370</span><a id="line.5370">                {</a>
<span class="sourceLineNo">5371</span><a id="line.5371">                String retstr = ((Symbol)rettag).getName();</a>
<span class="sourceLineNo">5372</span><a id="line.5372">                if(!(retstr.equals("long") || retstr.equals("double")))</a>
<span class="sourceLineNo">5373</span><a id="line.5373">                   rettag = null;</a>
<span class="sourceLineNo">5374</span><a id="line.5374">                }</a>
<span class="sourceLineNo">5375</span><a id="line.5375">                        method.retClass = tagClass(tagOf(parms)!=null?tagOf(parms):rettag);</a>
<span class="sourceLineNo">5376</span><a id="line.5376">                        if(method.retClass.isPrimitive()){</a>
<span class="sourceLineNo">5377</span><a id="line.5377">                if(!(method.retClass == double.class || method.retClass == long.class))</a>
<span class="sourceLineNo">5378</span><a id="line.5378">                    throw new IllegalArgumentException("Only long and double primitives are supported");</a>
<span class="sourceLineNo">5379</span><a id="line.5379">            }</a>
<span class="sourceLineNo">5380</span><a id="line.5380">            else</a>
<span class="sourceLineNo">5381</span><a id="line.5381">                method.retClass = Object.class;</a>
<span class="sourceLineNo">5382</span><a id="line.5382">                        //register 'this' as local 0</a>
<span class="sourceLineNo">5383</span><a id="line.5383">                        //registerLocal(THISFN, null, null);</a>
<span class="sourceLineNo">5384</span><a id="line.5384">//                      if(!canBeDirect)</a>
<span class="sourceLineNo">5385</span><a id="line.5385">//                              {</a>
<span class="sourceLineNo">5386</span><a id="line.5386">                                if(objx.thisName != null)</a>
<span class="sourceLineNo">5387</span><a id="line.5387">                                        registerLocal(Symbol.intern(objx.thisName), null, null,false);</a>
<span class="sourceLineNo">5388</span><a id="line.5388">                                else</a>
<span class="sourceLineNo">5389</span><a id="line.5389">                                        getAndIncLocalNum();</a>
<span class="sourceLineNo">5390</span><a id="line.5390">//                              }</a>
<span class="sourceLineNo">5391</span><a id="line.5391">                        PSTATE state = PSTATE.REQ;</a>
<span class="sourceLineNo">5392</span><a id="line.5392">                        PersistentVector argLocals = PersistentVector.EMPTY;</a>
<span class="sourceLineNo">5393</span><a id="line.5393">                        ArrayList&lt;Type&gt; argtypes = new ArrayList();</a>
<span class="sourceLineNo">5394</span><a id="line.5394">                        ArrayList&lt;Class&gt; argclasses = new ArrayList();</a>
<span class="sourceLineNo">5395</span><a id="line.5395">                        for(int i = 0; i &lt; parms.count(); i++)</a>
<span class="sourceLineNo">5396</span><a id="line.5396">                                {</a>
<span class="sourceLineNo">5397</span><a id="line.5397">                                if(!(parms.nth(i) instanceof Symbol))</a>
<span class="sourceLineNo">5398</span><a id="line.5398">                                        throw new IllegalArgumentException("fn params must be Symbols");</a>
<span class="sourceLineNo">5399</span><a id="line.5399">                                Symbol p = (Symbol) parms.nth(i);</a>
<span class="sourceLineNo">5400</span><a id="line.5400">                                if(p.getNamespace() != null)</a>
<span class="sourceLineNo">5401</span><a id="line.5401">                                        throw Util.runtimeException("Can't use qualified name as parameter: " + p);</a>
<span class="sourceLineNo">5402</span><a id="line.5402">                                if(p.equals(_AMP_))</a>
<span class="sourceLineNo">5403</span><a id="line.5403">                                        {</a>
<span class="sourceLineNo">5404</span><a id="line.5404">//                                      if(canBeDirect)</a>
<span class="sourceLineNo">5405</span><a id="line.5405">//                                              throw Util.runtimeException("Variadic fns cannot be static");</a>
<span class="sourceLineNo">5406</span><a id="line.5406">                                        if(state == PSTATE.REQ)</a>
<span class="sourceLineNo">5407</span><a id="line.5407">                                                state = PSTATE.REST;</a>
<span class="sourceLineNo">5408</span><a id="line.5408">                                        else</a>
<span class="sourceLineNo">5409</span><a id="line.5409">                                                throw Util.runtimeException("Invalid parameter list");</a>
<span class="sourceLineNo">5410</span><a id="line.5410">                                        }</a>
<span class="sourceLineNo">5411</span><a id="line.5411"></a>
<span class="sourceLineNo">5412</span><a id="line.5412">                                else</a>
<span class="sourceLineNo">5413</span><a id="line.5413">                                        {</a>
<span class="sourceLineNo">5414</span><a id="line.5414">                                        Class pc = primClass(tagClass(tagOf(p)));</a>
<span class="sourceLineNo">5415</span><a id="line.5415">//                                      if(pc.isPrimitive() &amp;&amp; !canBeDirect)</a>
<span class="sourceLineNo">5416</span><a id="line.5416">//                                              {</a>
<span class="sourceLineNo">5417</span><a id="line.5417">//                                              pc = Object.class;</a>
<span class="sourceLineNo">5418</span><a id="line.5418">//                                              p = (Symbol) ((IObj) p).withMeta((IPersistentMap) RT.assoc(RT.meta(p), RT.TAG_KEY, null));</a>
<span class="sourceLineNo">5419</span><a id="line.5419">//                                              }</a>
<span class="sourceLineNo">5420</span><a id="line.5420">//                                              throw Util.runtimeException("Non-static fn can't have primitive parameter: " + p);</a>
<span class="sourceLineNo">5421</span><a id="line.5421">                                        if(pc.isPrimitive() &amp;&amp; !(pc == double.class || pc == long.class))</a>
<span class="sourceLineNo">5422</span><a id="line.5422">                                                throw new IllegalArgumentException("Only long and double primitives are supported: " + p);</a>
<span class="sourceLineNo">5423</span><a id="line.5423"></a>
<span class="sourceLineNo">5424</span><a id="line.5424">                                        if(state == PSTATE.REST &amp;&amp; tagOf(p) != null)</a>
<span class="sourceLineNo">5425</span><a id="line.5425">                                                throw Util.runtimeException("&amp; arg cannot have type hint");</a>
<span class="sourceLineNo">5426</span><a id="line.5426">                                        if(state == PSTATE.REST &amp;&amp; method.prim != null)</a>
<span class="sourceLineNo">5427</span><a id="line.5427">                                                throw Util.runtimeException("fns taking primitives cannot be variadic");</a>
<span class="sourceLineNo">5428</span><a id="line.5428">                                                                </a>
<span class="sourceLineNo">5429</span><a id="line.5429">                                        if(state == PSTATE.REST)</a>
<span class="sourceLineNo">5430</span><a id="line.5430">                                                pc = ISeq.class;</a>
<span class="sourceLineNo">5431</span><a id="line.5431">                                        argtypes.add(Type.getType(pc));</a>
<span class="sourceLineNo">5432</span><a id="line.5432">                                        argclasses.add(pc);</a>
<span class="sourceLineNo">5433</span><a id="line.5433">                                        LocalBinding lb = pc.isPrimitive() ?</a>
<span class="sourceLineNo">5434</span><a id="line.5434">                                                          registerLocal(p, null, new MethodParamExpr(pc), true)</a>
<span class="sourceLineNo">5435</span><a id="line.5435">                                                                   : registerLocal(p, state == PSTATE.REST ? ISEQ : tagOf(p), null, true);</a>
<span class="sourceLineNo">5436</span><a id="line.5436">                                        argLocals = argLocals.cons(lb);</a>
<span class="sourceLineNo">5437</span><a id="line.5437">                                        switch(state)</a>
<span class="sourceLineNo">5438</span><a id="line.5438">                                                {</a>
<span class="sourceLineNo">5439</span><a id="line.5439">                                                case REQ:</a>
<span class="sourceLineNo">5440</span><a id="line.5440">                                                        method.reqParms = method.reqParms.cons(lb);</a>
<span class="sourceLineNo">5441</span><a id="line.5441">                                                        break;</a>
<span class="sourceLineNo">5442</span><a id="line.5442">                                                case REST:</a>
<span class="sourceLineNo">5443</span><a id="line.5443">                                                        method.restParm = lb;</a>
<span class="sourceLineNo">5444</span><a id="line.5444">                                                        state = PSTATE.DONE;</a>
<span class="sourceLineNo">5445</span><a id="line.5445">                                                        break;</a>
<span class="sourceLineNo">5446</span><a id="line.5446"></a>
<span class="sourceLineNo">5447</span><a id="line.5447">                                                default:</a>
<span class="sourceLineNo">5448</span><a id="line.5448">                                                        throw Util.runtimeException("Unexpected parameter");</a>
<span class="sourceLineNo">5449</span><a id="line.5449">                                                }</a>
<span class="sourceLineNo">5450</span><a id="line.5450">                                        }</a>
<span class="sourceLineNo">5451</span><a id="line.5451">                                }</a>
<span class="sourceLineNo">5452</span><a id="line.5452">                        if(method.reqParms.count() &gt; MAX_POSITIONAL_ARITY)</a>
<span class="sourceLineNo">5453</span><a id="line.5453">                                throw Util.runtimeException("Can't specify more than " + MAX_POSITIONAL_ARITY + " params");</a>
<span class="sourceLineNo">5454</span><a id="line.5454">                        LOOP_LOCALS.set(argLocals);</a>
<span class="sourceLineNo">5455</span><a id="line.5455">                        method.argLocals = argLocals;</a>
<span class="sourceLineNo">5456</span><a id="line.5456">//                      if(canBeDirect)</a>
<span class="sourceLineNo">5457</span><a id="line.5457">                        method.argtypes = argtypes.toArray(new Type[argtypes.size()]);</a>
<span class="sourceLineNo">5458</span><a id="line.5458">                        method.argclasses = argclasses.toArray(new Class[argtypes.size()]);</a>
<span class="sourceLineNo">5459</span><a id="line.5459">                        if(method.prim != null)</a>
<span class="sourceLineNo">5460</span><a id="line.5460">                                {</a>
<span class="sourceLineNo">5461</span><a id="line.5461">                                for(int i = 0; i &lt; method.argclasses.length; i++)</a>
<span class="sourceLineNo">5462</span><a id="line.5462">                                        {</a>
<span class="sourceLineNo">5463</span><a id="line.5463">                                        if(method.argclasses[i] == long.class || method.argclasses[i] == double.class)</a>
<span class="sourceLineNo">5464</span><a id="line.5464">                                                getAndIncLocalNum();</a>
<span class="sourceLineNo">5465</span><a id="line.5465">                                        }</a>
<span class="sourceLineNo">5466</span><a id="line.5466">                                }</a>
<span class="sourceLineNo">5467</span><a id="line.5467">                        method.body = (new BodyExpr.Parser()).parse(C.RETURN, body);</a>
<span class="sourceLineNo">5468</span><a id="line.5468">                        return method;</a>
<span class="sourceLineNo">5469</span><a id="line.5469">                        }</a>
<span class="sourceLineNo">5470</span><a id="line.5470">                finally</a>
<span class="sourceLineNo">5471</span><a id="line.5471">                        {</a>
<span class="sourceLineNo">5472</span><a id="line.5472">                        Var.popThreadBindings();</a>
<span class="sourceLineNo">5473</span><a id="line.5473">                        }</a>
<span class="sourceLineNo">5474</span><a id="line.5474">        }</a>
<span class="sourceLineNo">5475</span><a id="line.5475"></a>
<span class="sourceLineNo">5476</span><a id="line.5476">        public void emit(ObjExpr fn, ClassVisitor cv){</a>
<span class="sourceLineNo">5477</span><a id="line.5477">                if(fn.canBeDirect)</a>
<span class="sourceLineNo">5478</span><a id="line.5478">                        {</a>
<span class="sourceLineNo">5479</span><a id="line.5479">//                      System.out.println("emit static: " + fn.name);</a>
<span class="sourceLineNo">5480</span><a id="line.5480">                        doEmitStatic(fn, cv);</a>
<span class="sourceLineNo">5481</span><a id="line.5481">                        }</a>
<span class="sourceLineNo">5482</span><a id="line.5482">                else if(prim != null)</a>
<span class="sourceLineNo">5483</span><a id="line.5483">                        {</a>
<span class="sourceLineNo">5484</span><a id="line.5484">//                      System.out.println("emit prim: " + fn.name);</a>
<span class="sourceLineNo">5485</span><a id="line.5485">                        doEmitPrim(fn, cv);</a>
<span class="sourceLineNo">5486</span><a id="line.5486">                        }</a>
<span class="sourceLineNo">5487</span><a id="line.5487">                else</a>
<span class="sourceLineNo">5488</span><a id="line.5488">                        {</a>
<span class="sourceLineNo">5489</span><a id="line.5489">//                      System.out.println("emit normal: " + fn.name);</a>
<span class="sourceLineNo">5490</span><a id="line.5490">                        doEmit(fn,cv);</a>
<span class="sourceLineNo">5491</span><a id="line.5491">                        }</a>
<span class="sourceLineNo">5492</span><a id="line.5492">        }</a>
<span class="sourceLineNo">5493</span><a id="line.5493"></a>
<span class="sourceLineNo">5494</span><a id="line.5494">        public void doEmitStatic(ObjExpr fn, ClassVisitor cv){</a>
<span class="sourceLineNo">5495</span><a id="line.5495">//              System.out.println("emit static:" + fn.name);</a>
<span class="sourceLineNo">5496</span><a id="line.5496">                Type returnType = Type.getType(retClass);</a>
<span class="sourceLineNo">5497</span><a id="line.5497">//              if (retClass == double.class || retClass == long.class)</a>
<span class="sourceLineNo">5498</span><a id="line.5498">//                      returnType = getReturnType();</a>
<span class="sourceLineNo">5499</span><a id="line.5499">//              else returnType = OBJECT_TYPE;</a>
<span class="sourceLineNo">5500</span><a id="line.5500"></a>
<span class="sourceLineNo">5501</span><a id="line.5501">                Method ms = new Method("invokeStatic", returnType, argtypes);</a>
<span class="sourceLineNo">5502</span><a id="line.5502"></a>
<span class="sourceLineNo">5503</span><a id="line.5503">                GeneratorAdapter gen = new GeneratorAdapter(ACC_PUBLIC + ACC_STATIC,</a>
<span class="sourceLineNo">5504</span><a id="line.5504">                                                            ms,</a>
<span class="sourceLineNo">5505</span><a id="line.5505">                                                            null,</a>
<span class="sourceLineNo">5506</span><a id="line.5506">                                                            //todo don't hardwire this</a>
<span class="sourceLineNo">5507</span><a id="line.5507">                                                            EXCEPTION_TYPES,</a>
<span class="sourceLineNo">5508</span><a id="line.5508">                                                            cv);</a>
<span class="sourceLineNo">5509</span><a id="line.5509">                gen.visitCode();</a>
<span class="sourceLineNo">5510</span><a id="line.5510">                Label loopLabel = gen.mark();</a>
<span class="sourceLineNo">5511</span><a id="line.5511">                gen.visitLineNumber(line, loopLabel);</a>
<span class="sourceLineNo">5512</span><a id="line.5512">                try</a>
<span class="sourceLineNo">5513</span><a id="line.5513">                        {</a>
<span class="sourceLineNo">5514</span><a id="line.5514">                        Var.pushThreadBindings(RT.map(LOOP_LABEL, loopLabel, METHOD, this));</a>
<span class="sourceLineNo">5515</span><a id="line.5515">                        emitBody(objx, gen, retClass, body);</a>
<span class="sourceLineNo">5516</span><a id="line.5516"></a>
<span class="sourceLineNo">5517</span><a id="line.5517">                        Label end = gen.mark();</a>
<span class="sourceLineNo">5518</span><a id="line.5518">                        for(ISeq lbs = argLocals.seq(); lbs != null; lbs = lbs.next())</a>
<span class="sourceLineNo">5519</span><a id="line.5519">                                {</a>
<span class="sourceLineNo">5520</span><a id="line.5520">                                LocalBinding lb = (LocalBinding) lbs.first();</a>
<span class="sourceLineNo">5521</span><a id="line.5521">                                gen.visitLocalVariable(lb.name, argtypes[lb.idx].getDescriptor(), null, loopLabel, end, lb.idx);</a>
<span class="sourceLineNo">5522</span><a id="line.5522">                                }</a>
<span class="sourceLineNo">5523</span><a id="line.5523">                        }</a>
<span class="sourceLineNo">5524</span><a id="line.5524">                finally</a>
<span class="sourceLineNo">5525</span><a id="line.5525">                        {</a>
<span class="sourceLineNo">5526</span><a id="line.5526">                        Var.popThreadBindings();</a>
<span class="sourceLineNo">5527</span><a id="line.5527">                        }</a>
<span class="sourceLineNo">5528</span><a id="line.5528"></a>
<span class="sourceLineNo">5529</span><a id="line.5529">                gen.returnValue();</a>
<span class="sourceLineNo">5530</span><a id="line.5530">                //gen.visitMaxs(1, 1);</a>
<span class="sourceLineNo">5531</span><a id="line.5531">                gen.endMethod();</a>
<span class="sourceLineNo">5532</span><a id="line.5532"></a>
<span class="sourceLineNo">5533</span><a id="line.5533">        //generate the regular invoke, calling the static method</a>
<span class="sourceLineNo">5534</span><a id="line.5534">                Method m = new Method(getMethodName(), OBJECT_TYPE, getArgTypes());</a>
<span class="sourceLineNo">5535</span><a id="line.5535"></a>
<span class="sourceLineNo">5536</span><a id="line.5536">                gen = new GeneratorAdapter(ACC_PUBLIC,</a>
<span class="sourceLineNo">5537</span><a id="line.5537">                                           m,</a>
<span class="sourceLineNo">5538</span><a id="line.5538">                                           null,</a>
<span class="sourceLineNo">5539</span><a id="line.5539">                                           //todo don't hardwire this</a>
<span class="sourceLineNo">5540</span><a id="line.5540">                                           EXCEPTION_TYPES,</a>
<span class="sourceLineNo">5541</span><a id="line.5541">                                           cv);</a>
<span class="sourceLineNo">5542</span><a id="line.5542">                gen.visitCode();</a>
<span class="sourceLineNo">5543</span><a id="line.5543">                for(int i = 0; i &lt; argtypes.length; i++)</a>
<span class="sourceLineNo">5544</span><a id="line.5544">                        {</a>
<span class="sourceLineNo">5545</span><a id="line.5545">                        gen.loadArg(i);</a>
<span class="sourceLineNo">5546</span><a id="line.5546">                        HostExpr.emitUnboxArg(fn, gen, argclasses[i]);</a>
<span class="sourceLineNo">5547</span><a id="line.5547">            if(!argclasses[i].isPrimitive())</a>
<span class="sourceLineNo">5548</span><a id="line.5548">                {</a>
<span class="sourceLineNo">5549</span><a id="line.5549">                gen.visitInsn(Opcodes.ACONST_NULL);</a>
<span class="sourceLineNo">5550</span><a id="line.5550">                gen.storeArg(i);</a>
<span class="sourceLineNo">5551</span><a id="line.5551">                }</a>
<span class="sourceLineNo">5552</span><a id="line.5552">                        }</a>
<span class="sourceLineNo">5553</span><a id="line.5553">                Label callLabel = gen.mark();</a>
<span class="sourceLineNo">5554</span><a id="line.5554">                gen.visitLineNumber(line, callLabel);</a>
<span class="sourceLineNo">5555</span><a id="line.5555">                gen.invokeStatic(objx.objtype, ms);</a>
<span class="sourceLineNo">5556</span><a id="line.5556">                gen.box(returnType);</a>
<span class="sourceLineNo">5557</span><a id="line.5557"></a>
<span class="sourceLineNo">5558</span><a id="line.5558"></a>
<span class="sourceLineNo">5559</span><a id="line.5559">                gen.returnValue();</a>
<span class="sourceLineNo">5560</span><a id="line.5560">                //gen.visitMaxs(1, 1);</a>
<span class="sourceLineNo">5561</span><a id="line.5561">                gen.endMethod();</a>
<span class="sourceLineNo">5562</span><a id="line.5562"></a>
<span class="sourceLineNo">5563</span><a id="line.5563">                //generate primInvoke if prim</a>
<span class="sourceLineNo">5564</span><a id="line.5564">                if(prim != null)</a>
<span class="sourceLineNo">5565</span><a id="line.5565">                        {</a>
<span class="sourceLineNo">5566</span><a id="line.5566">                        if (retClass == double.class || retClass == long.class)</a>
<span class="sourceLineNo">5567</span><a id="line.5567">                                returnType = getReturnType();</a>
<span class="sourceLineNo">5568</span><a id="line.5568">                        else returnType = OBJECT_TYPE;</a>
<span class="sourceLineNo">5569</span><a id="line.5569"></a>
<span class="sourceLineNo">5570</span><a id="line.5570">                        Method pm = new Method("invokePrim", returnType, argtypes);</a>
<span class="sourceLineNo">5571</span><a id="line.5571"></a>
<span class="sourceLineNo">5572</span><a id="line.5572">                        gen = new GeneratorAdapter(ACC_PUBLIC + ACC_FINAL,</a>
<span class="sourceLineNo">5573</span><a id="line.5573">                                                   pm,</a>
<span class="sourceLineNo">5574</span><a id="line.5574">                                                   null,</a>
<span class="sourceLineNo">5575</span><a id="line.5575">                                                   //todo don't hardwire this</a>
<span class="sourceLineNo">5576</span><a id="line.5576">                                                   EXCEPTION_TYPES,</a>
<span class="sourceLineNo">5577</span><a id="line.5577">                                                   cv);</a>
<span class="sourceLineNo">5578</span><a id="line.5578">                        gen.visitCode();</a>
<span class="sourceLineNo">5579</span><a id="line.5579">                        for(int i = 0; i &lt; argtypes.length; i++)</a>
<span class="sourceLineNo">5580</span><a id="line.5580">                                {</a>
<span class="sourceLineNo">5581</span><a id="line.5581">                                gen.loadArg(i);</a>
<span class="sourceLineNo">5582</span><a id="line.5582">                if(!argclasses[i].isPrimitive())</a>
<span class="sourceLineNo">5583</span><a id="line.5583">                    {</a>
<span class="sourceLineNo">5584</span><a id="line.5584">                    gen.visitInsn(Opcodes.ACONST_NULL);</a>
<span class="sourceLineNo">5585</span><a id="line.5585">                    gen.storeArg(i);</a>
<span class="sourceLineNo">5586</span><a id="line.5586">                    }</a>
<span class="sourceLineNo">5587</span><a id="line.5587">                                }</a>
<span class="sourceLineNo">5588</span><a id="line.5588">                        gen.invokeStatic(objx.objtype, ms);</a>
<span class="sourceLineNo">5589</span><a id="line.5589"></a>
<span class="sourceLineNo">5590</span><a id="line.5590">                        gen.returnValue();</a>
<span class="sourceLineNo">5591</span><a id="line.5591">                        //gen.visitMaxs(1, 1);</a>
<span class="sourceLineNo">5592</span><a id="line.5592">                        gen.endMethod();</a>
<span class="sourceLineNo">5593</span><a id="line.5593">                        }</a>
<span class="sourceLineNo">5594</span><a id="line.5594"></a>
<span class="sourceLineNo">5595</span><a id="line.5595"></a>
<span class="sourceLineNo">5596</span><a id="line.5596">        }</a>
<span class="sourceLineNo">5597</span><a id="line.5597"></a>
<span class="sourceLineNo">5598</span><a id="line.5598">        public void doEmitPrim(ObjExpr fn, ClassVisitor cv){</a>
<span class="sourceLineNo">5599</span><a id="line.5599">                Type returnType;</a>
<span class="sourceLineNo">5600</span><a id="line.5600">                if (retClass == double.class || retClass == long.class)</a>
<span class="sourceLineNo">5601</span><a id="line.5601">                        returnType = getReturnType();</a>
<span class="sourceLineNo">5602</span><a id="line.5602">                else returnType = OBJECT_TYPE;</a>
<span class="sourceLineNo">5603</span><a id="line.5603">                Method ms = new Method("invokePrim", returnType, argtypes);</a>
<span class="sourceLineNo">5604</span><a id="line.5604"></a>
<span class="sourceLineNo">5605</span><a id="line.5605">                GeneratorAdapter gen = new GeneratorAdapter(ACC_PUBLIC + ACC_FINAL,</a>
<span class="sourceLineNo">5606</span><a id="line.5606">                                                            ms,</a>
<span class="sourceLineNo">5607</span><a id="line.5607">                                                            null,</a>
<span class="sourceLineNo">5608</span><a id="line.5608">                                                            //todo don't hardwire this</a>
<span class="sourceLineNo">5609</span><a id="line.5609">                                                            EXCEPTION_TYPES,</a>
<span class="sourceLineNo">5610</span><a id="line.5610">                                                            cv);</a>
<span class="sourceLineNo">5611</span><a id="line.5611">                gen.visitCode();</a>
<span class="sourceLineNo">5612</span><a id="line.5612"></a>
<span class="sourceLineNo">5613</span><a id="line.5613">                Label loopLabel = gen.mark();</a>
<span class="sourceLineNo">5614</span><a id="line.5614">                gen.visitLineNumber(line, loopLabel);</a>
<span class="sourceLineNo">5615</span><a id="line.5615">                try</a>
<span class="sourceLineNo">5616</span><a id="line.5616">                        {</a>
<span class="sourceLineNo">5617</span><a id="line.5617">                        Var.pushThreadBindings(RT.map(LOOP_LABEL, loopLabel, METHOD, this));</a>
<span class="sourceLineNo">5618</span><a id="line.5618">                        emitBody(objx, gen, retClass, body);</a>
<span class="sourceLineNo">5619</span><a id="line.5619"></a>
<span class="sourceLineNo">5620</span><a id="line.5620">                        Label end = gen.mark();</a>
<span class="sourceLineNo">5621</span><a id="line.5621">                        gen.visitLocalVariable("this", "Ljava/lang/Object;", null, loopLabel, end, 0);</a>
<span class="sourceLineNo">5622</span><a id="line.5622">                        for(ISeq lbs = argLocals.seq(); lbs != null; lbs = lbs.next())</a>
<span class="sourceLineNo">5623</span><a id="line.5623">                                {</a>
<span class="sourceLineNo">5624</span><a id="line.5624">                                LocalBinding lb = (LocalBinding) lbs.first();</a>
<span class="sourceLineNo">5625</span><a id="line.5625">                                gen.visitLocalVariable(lb.name, argtypes[lb.idx-1].getDescriptor(), null, loopLabel, end, lb.idx);</a>
<span class="sourceLineNo">5626</span><a id="line.5626">                                }</a>
<span class="sourceLineNo">5627</span><a id="line.5627">                        }</a>
<span class="sourceLineNo">5628</span><a id="line.5628">                finally</a>
<span class="sourceLineNo">5629</span><a id="line.5629">                        {</a>
<span class="sourceLineNo">5630</span><a id="line.5630">                        Var.popThreadBindings();</a>
<span class="sourceLineNo">5631</span><a id="line.5631">                        }</a>
<span class="sourceLineNo">5632</span><a id="line.5632"></a>
<span class="sourceLineNo">5633</span><a id="line.5633">                gen.returnValue();</a>
<span class="sourceLineNo">5634</span><a id="line.5634">                //gen.visitMaxs(1, 1);</a>
<span class="sourceLineNo">5635</span><a id="line.5635">                gen.endMethod();</a>
<span class="sourceLineNo">5636</span><a id="line.5636"></a>
<span class="sourceLineNo">5637</span><a id="line.5637">        //generate the regular invoke, calling the prim method</a>
<span class="sourceLineNo">5638</span><a id="line.5638">                Method m = new Method(getMethodName(), OBJECT_TYPE, getArgTypes());</a>
<span class="sourceLineNo">5639</span><a id="line.5639"></a>
<span class="sourceLineNo">5640</span><a id="line.5640">                gen = new GeneratorAdapter(ACC_PUBLIC,</a>
<span class="sourceLineNo">5641</span><a id="line.5641">                                           m,</a>
<span class="sourceLineNo">5642</span><a id="line.5642">                                           null,</a>
<span class="sourceLineNo">5643</span><a id="line.5643">                                           //todo don't hardwire this</a>
<span class="sourceLineNo">5644</span><a id="line.5644">                                           EXCEPTION_TYPES,</a>
<span class="sourceLineNo">5645</span><a id="line.5645">                                           cv);</a>
<span class="sourceLineNo">5646</span><a id="line.5646">                gen.visitCode();</a>
<span class="sourceLineNo">5647</span><a id="line.5647">                gen.loadThis();</a>
<span class="sourceLineNo">5648</span><a id="line.5648">                for(int i = 0; i &lt; argtypes.length; i++)</a>
<span class="sourceLineNo">5649</span><a id="line.5649">                        {</a>
<span class="sourceLineNo">5650</span><a id="line.5650">                        gen.loadArg(i);</a>
<span class="sourceLineNo">5651</span><a id="line.5651">                        HostExpr.emitUnboxArg(fn, gen, argclasses[i]);</a>
<span class="sourceLineNo">5652</span><a id="line.5652">                        }</a>
<span class="sourceLineNo">5653</span><a id="line.5653">                gen.invokeInterface(Type.getType("L"+prim+";"), ms);</a>
<span class="sourceLineNo">5654</span><a id="line.5654">                gen.box(getReturnType());</a>
<span class="sourceLineNo">5655</span><a id="line.5655"></a>
<span class="sourceLineNo">5656</span><a id="line.5656"></a>
<span class="sourceLineNo">5657</span><a id="line.5657">                gen.returnValue();</a>
<span class="sourceLineNo">5658</span><a id="line.5658">                //gen.visitMaxs(1, 1);</a>
<span class="sourceLineNo">5659</span><a id="line.5659">                gen.endMethod();</a>
<span class="sourceLineNo">5660</span><a id="line.5660"></a>
<span class="sourceLineNo">5661</span><a id="line.5661">        }</a>
<span class="sourceLineNo">5662</span><a id="line.5662">        public void doEmit(ObjExpr fn, ClassVisitor cv){</a>
<span class="sourceLineNo">5663</span><a id="line.5663">                Method m = new Method(getMethodName(), getReturnType(), getArgTypes());</a>
<span class="sourceLineNo">5664</span><a id="line.5664"></a>
<span class="sourceLineNo">5665</span><a id="line.5665">                GeneratorAdapter gen = new GeneratorAdapter(ACC_PUBLIC,</a>
<span class="sourceLineNo">5666</span><a id="line.5666">                                                            m,</a>
<span class="sourceLineNo">5667</span><a id="line.5667">                                                            null,</a>
<span class="sourceLineNo">5668</span><a id="line.5668">                                                            //todo don't hardwire this</a>
<span class="sourceLineNo">5669</span><a id="line.5669">                                                            EXCEPTION_TYPES,</a>
<span class="sourceLineNo">5670</span><a id="line.5670">                                                            cv);</a>
<span class="sourceLineNo">5671</span><a id="line.5671">                gen.visitCode();</a>
<span class="sourceLineNo">5672</span><a id="line.5672"></a>
<span class="sourceLineNo">5673</span><a id="line.5673">                Label loopLabel = gen.mark();</a>
<span class="sourceLineNo">5674</span><a id="line.5674">                gen.visitLineNumber(line, loopLabel);</a>
<span class="sourceLineNo">5675</span><a id="line.5675">                try</a>
<span class="sourceLineNo">5676</span><a id="line.5676">                        {</a>
<span class="sourceLineNo">5677</span><a id="line.5677">                        Var.pushThreadBindings(RT.map(LOOP_LABEL, loopLabel, METHOD, this));</a>
<span class="sourceLineNo">5678</span><a id="line.5678"></a>
<span class="sourceLineNo">5679</span><a id="line.5679">                        body.emit(C.RETURN, fn, gen);</a>
<span class="sourceLineNo">5680</span><a id="line.5680">                        Label end = gen.mark();</a>
<span class="sourceLineNo">5681</span><a id="line.5681"></a>
<span class="sourceLineNo">5682</span><a id="line.5682">                        gen.visitLocalVariable("this", "Ljava/lang/Object;", null, loopLabel, end, 0);</a>
<span class="sourceLineNo">5683</span><a id="line.5683">                        for(ISeq lbs = argLocals.seq(); lbs != null; lbs = lbs.next())</a>
<span class="sourceLineNo">5684</span><a id="line.5684">                                {</a>
<span class="sourceLineNo">5685</span><a id="line.5685">                                LocalBinding lb = (LocalBinding) lbs.first();</a>
<span class="sourceLineNo">5686</span><a id="line.5686">                                gen.visitLocalVariable(lb.name, "Ljava/lang/Object;", null, loopLabel, end, lb.idx);</a>
<span class="sourceLineNo">5687</span><a id="line.5687">                                }</a>
<span class="sourceLineNo">5688</span><a id="line.5688">                        }</a>
<span class="sourceLineNo">5689</span><a id="line.5689">                finally</a>
<span class="sourceLineNo">5690</span><a id="line.5690">                        {</a>
<span class="sourceLineNo">5691</span><a id="line.5691">                        Var.popThreadBindings();</a>
<span class="sourceLineNo">5692</span><a id="line.5692">                        }</a>
<span class="sourceLineNo">5693</span><a id="line.5693"></a>
<span class="sourceLineNo">5694</span><a id="line.5694">                gen.returnValue();</a>
<span class="sourceLineNo">5695</span><a id="line.5695">                //gen.visitMaxs(1, 1);</a>
<span class="sourceLineNo">5696</span><a id="line.5696">                gen.endMethod();</a>
<span class="sourceLineNo">5697</span><a id="line.5697">        }</a>
<span class="sourceLineNo">5698</span><a id="line.5698"></a>
<span class="sourceLineNo">5699</span><a id="line.5699"></a>
<span class="sourceLineNo">5700</span><a id="line.5700"></a>
<span class="sourceLineNo">5701</span><a id="line.5701">        public final PersistentVector reqParms(){</a>
<span class="sourceLineNo">5702</span><a id="line.5702">                return reqParms;</a>
<span class="sourceLineNo">5703</span><a id="line.5703">        }</a>
<span class="sourceLineNo">5704</span><a id="line.5704"></a>
<span class="sourceLineNo">5705</span><a id="line.5705">        public final LocalBinding restParm(){</a>
<span class="sourceLineNo">5706</span><a id="line.5706">                return restParm;</a>
<span class="sourceLineNo">5707</span><a id="line.5707">        }</a>
<span class="sourceLineNo">5708</span><a id="line.5708"></a>
<span class="sourceLineNo">5709</span><a id="line.5709">        boolean isVariadic(){</a>
<span class="sourceLineNo">5710</span><a id="line.5710">                return restParm != null;</a>
<span class="sourceLineNo">5711</span><a id="line.5711">        }</a>
<span class="sourceLineNo">5712</span><a id="line.5712"></a>
<span class="sourceLineNo">5713</span><a id="line.5713">        int numParams(){</a>
<span class="sourceLineNo">5714</span><a id="line.5714">                return reqParms.count() + (isVariadic() ? 1 : 0);</a>
<span class="sourceLineNo">5715</span><a id="line.5715">        }</a>
<span class="sourceLineNo">5716</span><a id="line.5716"></a>
<span class="sourceLineNo">5717</span><a id="line.5717">        String getMethodName(){</a>
<span class="sourceLineNo">5718</span><a id="line.5718">                return isVariadic()?"doInvoke":"invoke";</a>
<span class="sourceLineNo">5719</span><a id="line.5719">        }</a>
<span class="sourceLineNo">5720</span><a id="line.5720"></a>
<span class="sourceLineNo">5721</span><a id="line.5721">        Type getReturnType(){</a>
<span class="sourceLineNo">5722</span><a id="line.5722">                if(prim != null) //objx.isStatic)</a>
<span class="sourceLineNo">5723</span><a id="line.5723">                        return Type.getType(retClass);</a>
<span class="sourceLineNo">5724</span><a id="line.5724">                return OBJECT_TYPE;</a>
<span class="sourceLineNo">5725</span><a id="line.5725">        }</a>
<span class="sourceLineNo">5726</span><a id="line.5726"></a>
<span class="sourceLineNo">5727</span><a id="line.5727">        Type[] getArgTypes(){</a>
<span class="sourceLineNo">5728</span><a id="line.5728">                if(isVariadic() &amp;&amp; reqParms.count() == MAX_POSITIONAL_ARITY)</a>
<span class="sourceLineNo">5729</span><a id="line.5729">                        {</a>
<span class="sourceLineNo">5730</span><a id="line.5730">                        Type[] ret = new Type[MAX_POSITIONAL_ARITY + 1];</a>
<span class="sourceLineNo">5731</span><a id="line.5731">                        for(int i = 0;i&lt;MAX_POSITIONAL_ARITY + 1;i++)</a>
<span class="sourceLineNo">5732</span><a id="line.5732">                                ret[i] = OBJECT_TYPE;</a>
<span class="sourceLineNo">5733</span><a id="line.5733">                        return ret;</a>
<span class="sourceLineNo">5734</span><a id="line.5734">                        }</a>
<span class="sourceLineNo">5735</span><a id="line.5735">                return  ARG_TYPES[numParams()];</a>
<span class="sourceLineNo">5736</span><a id="line.5736">        }</a>
<span class="sourceLineNo">5737</span><a id="line.5737"></a>
<span class="sourceLineNo">5738</span><a id="line.5738">        void emitClearLocals(GeneratorAdapter gen){</a>
<span class="sourceLineNo">5739</span><a id="line.5739">//              for(int i = 1; i &lt; numParams() + 1; i++)</a>
<span class="sourceLineNo">5740</span><a id="line.5740">//                      {</a>
<span class="sourceLineNo">5741</span><a id="line.5741">//                      if(!localsUsedInCatchFinally.contains(i))</a>
<span class="sourceLineNo">5742</span><a id="line.5742">//                              {</a>
<span class="sourceLineNo">5743</span><a id="line.5743">//                              gen.visitInsn(Opcodes.ACONST_NULL);</a>
<span class="sourceLineNo">5744</span><a id="line.5744">//                              gen.visitVarInsn(OBJECT_TYPE.getOpcode(Opcodes.ISTORE), i);</a>
<span class="sourceLineNo">5745</span><a id="line.5745">//                              }</a>
<span class="sourceLineNo">5746</span><a id="line.5746">//                      }</a>
<span class="sourceLineNo">5747</span><a id="line.5747">//              for(int i = numParams() + 1; i &lt; maxLocal + 1; i++)</a>
<span class="sourceLineNo">5748</span><a id="line.5748">//                      {</a>
<span class="sourceLineNo">5749</span><a id="line.5749">//                      if(!localsUsedInCatchFinally.contains(i))</a>
<span class="sourceLineNo">5750</span><a id="line.5750">//                              {</a>
<span class="sourceLineNo">5751</span><a id="line.5751">//                              LocalBinding b = (LocalBinding) RT.get(indexlocals, i);</a>
<span class="sourceLineNo">5752</span><a id="line.5752">//                              if(b == null || maybePrimitiveType(b.init) == null)</a>
<span class="sourceLineNo">5753</span><a id="line.5753">//                                      {</a>
<span class="sourceLineNo">5754</span><a id="line.5754">//                                      gen.visitInsn(Opcodes.ACONST_NULL);</a>
<span class="sourceLineNo">5755</span><a id="line.5755">//                                      gen.visitVarInsn(OBJECT_TYPE.getOpcode(Opcodes.ISTORE), i);</a>
<span class="sourceLineNo">5756</span><a id="line.5756">//                                      }</a>
<span class="sourceLineNo">5757</span><a id="line.5757">//                              }</a>
<span class="sourceLineNo">5758</span><a id="line.5758">//                      }</a>
<span class="sourceLineNo">5759</span><a id="line.5759">//              if(((FnExpr)objx).onceOnly)</a>
<span class="sourceLineNo">5760</span><a id="line.5760">//                      {</a>
<span class="sourceLineNo">5761</span><a id="line.5761">//                      objx.emitClearCloses(gen);</a>
<span class="sourceLineNo">5762</span><a id="line.5762">//                      }</a>
<span class="sourceLineNo">5763</span><a id="line.5763">        }</a>
<span class="sourceLineNo">5764</span><a id="line.5764">}</a>
<span class="sourceLineNo">5765</span><a id="line.5765"></a>
<span class="sourceLineNo">5766</span><a id="line.5766">abstract public static class ObjMethod{</a>
<span class="sourceLineNo">5767</span><a id="line.5767">        //when closures are defined inside other closures,</a>
<span class="sourceLineNo">5768</span><a id="line.5768">        //the closed over locals need to be propagated to the enclosing objx</a>
<span class="sourceLineNo">5769</span><a id="line.5769">        public final ObjMethod parent;</a>
<span class="sourceLineNo">5770</span><a id="line.5770">        //localbinding-&gt;localbinding</a>
<span class="sourceLineNo">5771</span><a id="line.5771">        IPersistentMap locals = null;</a>
<span class="sourceLineNo">5772</span><a id="line.5772">        //num-&gt;localbinding</a>
<span class="sourceLineNo">5773</span><a id="line.5773">        IPersistentMap indexlocals = null;</a>
<span class="sourceLineNo">5774</span><a id="line.5774">        Expr body = null;</a>
<span class="sourceLineNo">5775</span><a id="line.5775">        ObjExpr objx;</a>
<span class="sourceLineNo">5776</span><a id="line.5776">        PersistentVector argLocals;</a>
<span class="sourceLineNo">5777</span><a id="line.5777">        int maxLocal = 0;</a>
<span class="sourceLineNo">5778</span><a id="line.5778">        int line;</a>
<span class="sourceLineNo">5779</span><a id="line.5779">        int column;</a>
<span class="sourceLineNo">5780</span><a id="line.5780">        boolean usesThis = false;</a>
<span class="sourceLineNo">5781</span><a id="line.5781">        PersistentHashSet localsUsedInCatchFinally = PersistentHashSet.EMPTY;</a>
<span class="sourceLineNo">5782</span><a id="line.5782">        protected IPersistentMap methodMeta;</a>
<span class="sourceLineNo">5783</span><a id="line.5783"></a>
<span class="sourceLineNo">5784</span><a id="line.5784"></a>
<span class="sourceLineNo">5785</span><a id="line.5785">        public final IPersistentMap locals(){</a>
<span class="sourceLineNo">5786</span><a id="line.5786">                return locals;</a>
<span class="sourceLineNo">5787</span><a id="line.5787">        }</a>
<span class="sourceLineNo">5788</span><a id="line.5788"></a>
<span class="sourceLineNo">5789</span><a id="line.5789">        public final Expr body(){</a>
<span class="sourceLineNo">5790</span><a id="line.5790">                return body;</a>
<span class="sourceLineNo">5791</span><a id="line.5791">        }</a>
<span class="sourceLineNo">5792</span><a id="line.5792"></a>
<span class="sourceLineNo">5793</span><a id="line.5793">        public final ObjExpr objx(){</a>
<span class="sourceLineNo">5794</span><a id="line.5794">                return objx;</a>
<span class="sourceLineNo">5795</span><a id="line.5795">        }</a>
<span class="sourceLineNo">5796</span><a id="line.5796"></a>
<span class="sourceLineNo">5797</span><a id="line.5797">        public final PersistentVector argLocals(){</a>
<span class="sourceLineNo">5798</span><a id="line.5798">                return argLocals;</a>
<span class="sourceLineNo">5799</span><a id="line.5799">        }</a>
<span class="sourceLineNo">5800</span><a id="line.5800"></a>
<span class="sourceLineNo">5801</span><a id="line.5801">        public final int maxLocal(){</a>
<span class="sourceLineNo">5802</span><a id="line.5802">                return maxLocal;</a>
<span class="sourceLineNo">5803</span><a id="line.5803">        }</a>
<span class="sourceLineNo">5804</span><a id="line.5804"></a>
<span class="sourceLineNo">5805</span><a id="line.5805">        public final int line(){</a>
<span class="sourceLineNo">5806</span><a id="line.5806">                return line;</a>
<span class="sourceLineNo">5807</span><a id="line.5807">        }</a>
<span class="sourceLineNo">5808</span><a id="line.5808"></a>
<span class="sourceLineNo">5809</span><a id="line.5809">        public final int column(){</a>
<span class="sourceLineNo">5810</span><a id="line.5810">                return column;</a>
<span class="sourceLineNo">5811</span><a id="line.5811">        }</a>
<span class="sourceLineNo">5812</span><a id="line.5812"></a>
<span class="sourceLineNo">5813</span><a id="line.5813">        public ObjMethod(ObjExpr objx, ObjMethod parent){</a>
<span class="sourceLineNo">5814</span><a id="line.5814">                this.parent = parent;</a>
<span class="sourceLineNo">5815</span><a id="line.5815">                this.objx = objx;</a>
<span class="sourceLineNo">5816</span><a id="line.5816">        }</a>
<span class="sourceLineNo">5817</span><a id="line.5817"></a>
<span class="sourceLineNo">5818</span><a id="line.5818">        static void emitBody(ObjExpr objx, GeneratorAdapter gen, Class retClass, Expr body) {</a>
<span class="sourceLineNo">5819</span><a id="line.5819">                        MaybePrimitiveExpr be = (MaybePrimitiveExpr) body;</a>
<span class="sourceLineNo">5820</span><a id="line.5820">                        if(Util.isPrimitive(retClass) &amp;&amp; be.canEmitPrimitive())</a>
<span class="sourceLineNo">5821</span><a id="line.5821">                                {</a>
<span class="sourceLineNo">5822</span><a id="line.5822">                                Class bc = maybePrimitiveType(be);</a>
<span class="sourceLineNo">5823</span><a id="line.5823">                                if(bc == retClass)</a>
<span class="sourceLineNo">5824</span><a id="line.5824">                                        be.emitUnboxed(C.RETURN, objx, gen);</a>
<span class="sourceLineNo">5825</span><a id="line.5825">                                else if(retClass == long.class &amp;&amp; bc == int.class)</a>
<span class="sourceLineNo">5826</span><a id="line.5826">                                        {</a>
<span class="sourceLineNo">5827</span><a id="line.5827">                                        be.emitUnboxed(C.RETURN, objx, gen);</a>
<span class="sourceLineNo">5828</span><a id="line.5828">                                        gen.visitInsn(I2L);</a>
<span class="sourceLineNo">5829</span><a id="line.5829">                                        }</a>
<span class="sourceLineNo">5830</span><a id="line.5830">                                else if(retClass == double.class &amp;&amp; bc == float.class)</a>
<span class="sourceLineNo">5831</span><a id="line.5831">                                        {</a>
<span class="sourceLineNo">5832</span><a id="line.5832">                                        be.emitUnboxed(C.RETURN, objx, gen);</a>
<span class="sourceLineNo">5833</span><a id="line.5833">                                        gen.visitInsn(F2D);</a>
<span class="sourceLineNo">5834</span><a id="line.5834">                                        }</a>
<span class="sourceLineNo">5835</span><a id="line.5835">                                else if(retClass == int.class &amp;&amp; bc == long.class)</a>
<span class="sourceLineNo">5836</span><a id="line.5836">                                        {</a>
<span class="sourceLineNo">5837</span><a id="line.5837">                                        be.emitUnboxed(C.RETURN, objx, gen);</a>
<span class="sourceLineNo">5838</span><a id="line.5838">                                        gen.invokeStatic(RT_TYPE, Method.getMethod("int intCast(long)"));</a>
<span class="sourceLineNo">5839</span><a id="line.5839">                                        }</a>
<span class="sourceLineNo">5840</span><a id="line.5840">                                else if(retClass == float.class &amp;&amp; bc == double.class)</a>
<span class="sourceLineNo">5841</span><a id="line.5841">                                        {</a>
<span class="sourceLineNo">5842</span><a id="line.5842">                                        be.emitUnboxed(C.RETURN, objx, gen);</a>
<span class="sourceLineNo">5843</span><a id="line.5843">                                        gen.visitInsn(D2F);</a>
<span class="sourceLineNo">5844</span><a id="line.5844">                                        }</a>
<span class="sourceLineNo">5845</span><a id="line.5845">                                else</a>
<span class="sourceLineNo">5846</span><a id="line.5846">                                        throw new IllegalArgumentException("Mismatched primitive return, expected: "</a>
<span class="sourceLineNo">5847</span><a id="line.5847">                                                                           + retClass + ", had: " + be.getJavaClass());</a>
<span class="sourceLineNo">5848</span><a id="line.5848">                                }</a>
<span class="sourceLineNo">5849</span><a id="line.5849">                        else</a>
<span class="sourceLineNo">5850</span><a id="line.5850">                                {</a>
<span class="sourceLineNo">5851</span><a id="line.5851">                                body.emit(C.RETURN, objx, gen);</a>
<span class="sourceLineNo">5852</span><a id="line.5852">                                if(retClass == void.class)</a>
<span class="sourceLineNo">5853</span><a id="line.5853">                                        {</a>
<span class="sourceLineNo">5854</span><a id="line.5854">                                        gen.pop();</a>
<span class="sourceLineNo">5855</span><a id="line.5855">                                        }</a>
<span class="sourceLineNo">5856</span><a id="line.5856">                                else</a>
<span class="sourceLineNo">5857</span><a id="line.5857">                                        gen.unbox(Type.getType(retClass));</a>
<span class="sourceLineNo">5858</span><a id="line.5858">                                }</a>
<span class="sourceLineNo">5859</span><a id="line.5859">        }</a>
<span class="sourceLineNo">5860</span><a id="line.5860">        abstract int numParams();</a>
<span class="sourceLineNo">5861</span><a id="line.5861">        abstract String getMethodName();</a>
<span class="sourceLineNo">5862</span><a id="line.5862">        abstract Type getReturnType();</a>
<span class="sourceLineNo">5863</span><a id="line.5863">        abstract Type[] getArgTypes();</a>
<span class="sourceLineNo">5864</span><a id="line.5864"></a>
<span class="sourceLineNo">5865</span><a id="line.5865">        public void emit(ObjExpr fn, ClassVisitor cv){</a>
<span class="sourceLineNo">5866</span><a id="line.5866">                Method m = new Method(getMethodName(), getReturnType(), getArgTypes());</a>
<span class="sourceLineNo">5867</span><a id="line.5867"></a>
<span class="sourceLineNo">5868</span><a id="line.5868">                GeneratorAdapter gen = new GeneratorAdapter(ACC_PUBLIC,</a>
<span class="sourceLineNo">5869</span><a id="line.5869">                                                            m,</a>
<span class="sourceLineNo">5870</span><a id="line.5870">                                                            null,</a>
<span class="sourceLineNo">5871</span><a id="line.5871">                                                            //todo don't hardwire this</a>
<span class="sourceLineNo">5872</span><a id="line.5872">                                                            EXCEPTION_TYPES,</a>
<span class="sourceLineNo">5873</span><a id="line.5873">                                                            cv);</a>
<span class="sourceLineNo">5874</span><a id="line.5874">                gen.visitCode();</a>
<span class="sourceLineNo">5875</span><a id="line.5875"></a>
<span class="sourceLineNo">5876</span><a id="line.5876">                Label loopLabel = gen.mark();</a>
<span class="sourceLineNo">5877</span><a id="line.5877">                gen.visitLineNumber(line, loopLabel);</a>
<span class="sourceLineNo">5878</span><a id="line.5878">                try</a>
<span class="sourceLineNo">5879</span><a id="line.5879">                        {</a>
<span class="sourceLineNo">5880</span><a id="line.5880">                        Var.pushThreadBindings(RT.map(LOOP_LABEL, loopLabel, METHOD, this));</a>
<span class="sourceLineNo">5881</span><a id="line.5881"></a>
<span class="sourceLineNo">5882</span><a id="line.5882">                        body.emit(C.RETURN, fn, gen);</a>
<span class="sourceLineNo">5883</span><a id="line.5883">                        Label end = gen.mark();</a>
<span class="sourceLineNo">5884</span><a id="line.5884">                        gen.visitLocalVariable("this", "Ljava/lang/Object;", null, loopLabel, end, 0);</a>
<span class="sourceLineNo">5885</span><a id="line.5885">                        for(ISeq lbs = argLocals.seq(); lbs != null; lbs = lbs.next())</a>
<span class="sourceLineNo">5886</span><a id="line.5886">                                {</a>
<span class="sourceLineNo">5887</span><a id="line.5887">                                LocalBinding lb = (LocalBinding) lbs.first();</a>
<span class="sourceLineNo">5888</span><a id="line.5888">                                gen.visitLocalVariable(lb.name, "Ljava/lang/Object;", null, loopLabel, end, lb.idx);</a>
<span class="sourceLineNo">5889</span><a id="line.5889">                                }</a>
<span class="sourceLineNo">5890</span><a id="line.5890">                        }</a>
<span class="sourceLineNo">5891</span><a id="line.5891">                finally</a>
<span class="sourceLineNo">5892</span><a id="line.5892">                        {</a>
<span class="sourceLineNo">5893</span><a id="line.5893">                        Var.popThreadBindings();</a>
<span class="sourceLineNo">5894</span><a id="line.5894">                        }</a>
<span class="sourceLineNo">5895</span><a id="line.5895"></a>
<span class="sourceLineNo">5896</span><a id="line.5896">                gen.returnValue();</a>
<span class="sourceLineNo">5897</span><a id="line.5897">                //gen.visitMaxs(1, 1);</a>
<span class="sourceLineNo">5898</span><a id="line.5898">                gen.endMethod();</a>
<span class="sourceLineNo">5899</span><a id="line.5899">        }</a>
<span class="sourceLineNo">5900</span><a id="line.5900"></a>
<span class="sourceLineNo">5901</span><a id="line.5901">    void emitClearLocals(GeneratorAdapter gen){</a>
<span class="sourceLineNo">5902</span><a id="line.5902">    }</a>
<span class="sourceLineNo">5903</span><a id="line.5903">    </a>
<span class="sourceLineNo">5904</span><a id="line.5904">        void emitClearLocalsOld(GeneratorAdapter gen){</a>
<span class="sourceLineNo">5905</span><a id="line.5905">                for(int i=0;i&lt;argLocals.count();i++)</a>
<span class="sourceLineNo">5906</span><a id="line.5906">                        {</a>
<span class="sourceLineNo">5907</span><a id="line.5907">                        LocalBinding lb = (LocalBinding) argLocals.nth(i);</a>
<span class="sourceLineNo">5908</span><a id="line.5908">                        if(!localsUsedInCatchFinally.contains(lb.idx) &amp;&amp; lb.getPrimitiveType() == null)</a>
<span class="sourceLineNo">5909</span><a id="line.5909">                                {</a>
<span class="sourceLineNo">5910</span><a id="line.5910">                                gen.visitInsn(Opcodes.ACONST_NULL);</a>
<span class="sourceLineNo">5911</span><a id="line.5911">                                gen.storeArg(lb.idx - 1);</a>
<span class="sourceLineNo">5912</span><a id="line.5912">                                }</a>
<span class="sourceLineNo">5913</span><a id="line.5913"></a>
<span class="sourceLineNo">5914</span><a id="line.5914">                        }</a>
<span class="sourceLineNo">5915</span><a id="line.5915">//              for(int i = 1; i &lt; numParams() + 1; i++)</a>
<span class="sourceLineNo">5916</span><a id="line.5916">//                      {</a>
<span class="sourceLineNo">5917</span><a id="line.5917">//                      if(!localsUsedInCatchFinally.contains(i))</a>
<span class="sourceLineNo">5918</span><a id="line.5918">//                              {</a>
<span class="sourceLineNo">5919</span><a id="line.5919">//                              gen.visitInsn(Opcodes.ACONST_NULL);</a>
<span class="sourceLineNo">5920</span><a id="line.5920">//                              gen.visitVarInsn(OBJECT_TYPE.getOpcode(Opcodes.ISTORE), i);</a>
<span class="sourceLineNo">5921</span><a id="line.5921">//                              }</a>
<span class="sourceLineNo">5922</span><a id="line.5922">//                      }</a>
<span class="sourceLineNo">5923</span><a id="line.5923">                for(int i = numParams() + 1; i &lt; maxLocal + 1; i++)</a>
<span class="sourceLineNo">5924</span><a id="line.5924">                        {</a>
<span class="sourceLineNo">5925</span><a id="line.5925">                        if(!localsUsedInCatchFinally.contains(i))</a>
<span class="sourceLineNo">5926</span><a id="line.5926">                                {</a>
<span class="sourceLineNo">5927</span><a id="line.5927">                                LocalBinding b = (LocalBinding) RT.get(indexlocals, i);</a>
<span class="sourceLineNo">5928</span><a id="line.5928">                                if(b == null || maybePrimitiveType(b.init) == null)</a>
<span class="sourceLineNo">5929</span><a id="line.5929">                                        {</a>
<span class="sourceLineNo">5930</span><a id="line.5930">                                        gen.visitInsn(Opcodes.ACONST_NULL);</a>
<span class="sourceLineNo">5931</span><a id="line.5931">                                        gen.visitVarInsn(OBJECT_TYPE.getOpcode(Opcodes.ISTORE), i);</a>
<span class="sourceLineNo">5932</span><a id="line.5932">                                        }</a>
<span class="sourceLineNo">5933</span><a id="line.5933">                                }</a>
<span class="sourceLineNo">5934</span><a id="line.5934">                        }</a>
<span class="sourceLineNo">5935</span><a id="line.5935">        }</a>
<span class="sourceLineNo">5936</span><a id="line.5936"></a>
<span class="sourceLineNo">5937</span><a id="line.5937">        void emitClearThis(GeneratorAdapter gen) {</a>
<span class="sourceLineNo">5938</span><a id="line.5938">                gen.visitInsn(Opcodes.ACONST_NULL);</a>
<span class="sourceLineNo">5939</span><a id="line.5939">                gen.visitVarInsn(Opcodes.ASTORE, 0);</a>
<span class="sourceLineNo">5940</span><a id="line.5940">        }</a>
<span class="sourceLineNo">5941</span><a id="line.5941">}</a>
<span class="sourceLineNo">5942</span><a id="line.5942"></a>
<span class="sourceLineNo">5943</span><a id="line.5943">public static class LocalBinding{</a>
<span class="sourceLineNo">5944</span><a id="line.5944">        public final Symbol sym;</a>
<span class="sourceLineNo">5945</span><a id="line.5945">        public final Symbol tag;</a>
<span class="sourceLineNo">5946</span><a id="line.5946">        public Expr init;</a>
<span class="sourceLineNo">5947</span><a id="line.5947">        int idx;</a>
<span class="sourceLineNo">5948</span><a id="line.5948">        public final String name;</a>
<span class="sourceLineNo">5949</span><a id="line.5949">        public final boolean isArg;</a>
<span class="sourceLineNo">5950</span><a id="line.5950">    public final PathNode clearPathRoot;</a>
<span class="sourceLineNo">5951</span><a id="line.5951">        public boolean canBeCleared = !RT.booleanCast(getCompilerOption(disableLocalsClearingKey));</a>
<span class="sourceLineNo">5952</span><a id="line.5952">        public boolean recurMistmatch = false;</a>
<span class="sourceLineNo">5953</span><a id="line.5953">    public boolean used = false;</a>
<span class="sourceLineNo">5954</span><a id="line.5954"></a>
<span class="sourceLineNo">5955</span><a id="line.5955">    public LocalBinding(int num, Symbol sym, Symbol tag, Expr init, boolean isArg,PathNode clearPathRoot)</a>
<span class="sourceLineNo">5956</span><a id="line.5956">                {</a>
<span class="sourceLineNo">5957</span><a id="line.5957">                if(maybePrimitiveType(init) != null &amp;&amp; tag != null)</a>
<span class="sourceLineNo">5958</span><a id="line.5958">                        throw new UnsupportedOperationException("Can't type hint a local with a primitive initializer");</a>
<span class="sourceLineNo">5959</span><a id="line.5959">                this.idx = num;</a>
<span class="sourceLineNo">5960</span><a id="line.5960">                this.sym = sym;</a>
<span class="sourceLineNo">5961</span><a id="line.5961">                this.tag = tag;</a>
<span class="sourceLineNo">5962</span><a id="line.5962">                this.init = init;</a>
<span class="sourceLineNo">5963</span><a id="line.5963">                this.isArg = isArg;</a>
<span class="sourceLineNo">5964</span><a id="line.5964">        this.clearPathRoot = clearPathRoot;</a>
<span class="sourceLineNo">5965</span><a id="line.5965">                name = munge(sym.name);</a>
<span class="sourceLineNo">5966</span><a id="line.5966">        }</a>
<span class="sourceLineNo">5967</span><a id="line.5967"></a>
<span class="sourceLineNo">5968</span><a id="line.5968">    Boolean hjc;</a>
<span class="sourceLineNo">5969</span><a id="line.5969"></a>
<span class="sourceLineNo">5970</span><a id="line.5970">        public boolean hasJavaClass() {</a>
<span class="sourceLineNo">5971</span><a id="line.5971">        if (hjc == null)</a>
<span class="sourceLineNo">5972</span><a id="line.5972">            {</a>
<span class="sourceLineNo">5973</span><a id="line.5973">                if(init != null &amp;&amp; init.hasJavaClass() &amp;&amp; Util.isPrimitive(init.getJavaClass()) &amp;&amp; !(init instanceof MaybePrimitiveExpr))</a>
<span class="sourceLineNo">5974</span><a id="line.5974">                   hjc =  false;</a>
<span class="sourceLineNo">5975</span><a id="line.5975">                else</a>
<span class="sourceLineNo">5976</span><a id="line.5976">                    hjc = tag != null || (init != null &amp;&amp; init.hasJavaClass());</a>
<span class="sourceLineNo">5977</span><a id="line.5977">            }</a>
<span class="sourceLineNo">5978</span><a id="line.5978">        return hjc;</a>
<span class="sourceLineNo">5979</span><a id="line.5979">    }</a>
<span class="sourceLineNo">5980</span><a id="line.5980"></a>
<span class="sourceLineNo">5981</span><a id="line.5981">    Class jc;</a>
<span class="sourceLineNo">5982</span><a id="line.5982"></a>
<span class="sourceLineNo">5983</span><a id="line.5983">        public Class getJavaClass() {</a>
<span class="sourceLineNo">5984</span><a id="line.5984">                if (jc == null)</a>
<span class="sourceLineNo">5985</span><a id="line.5985">            jc = tag != null ? HostExpr.tagToClass(tag) : init.getJavaClass();</a>
<span class="sourceLineNo">5986</span><a id="line.5986">        return jc;</a>
<span class="sourceLineNo">5987</span><a id="line.5987">        }</a>
<span class="sourceLineNo">5988</span><a id="line.5988"></a>
<span class="sourceLineNo">5989</span><a id="line.5989">        public Class getPrimitiveType(){</a>
<span class="sourceLineNo">5990</span><a id="line.5990">                return maybePrimitiveType(init);</a>
<span class="sourceLineNo">5991</span><a id="line.5991">        }</a>
<span class="sourceLineNo">5992</span><a id="line.5992">}</a>
<span class="sourceLineNo">5993</span><a id="line.5993"></a>
<span class="sourceLineNo">5994</span><a id="line.5994">public static class LocalBindingExpr implements Expr, MaybePrimitiveExpr, AssignableExpr{</a>
<span class="sourceLineNo">5995</span><a id="line.5995">        public final LocalBinding b;</a>
<span class="sourceLineNo">5996</span><a id="line.5996">        public final Symbol tag;</a>
<span class="sourceLineNo">5997</span><a id="line.5997"></a>
<span class="sourceLineNo">5998</span><a id="line.5998">    public final PathNode clearPath;</a>
<span class="sourceLineNo">5999</span><a id="line.5999">    public final PathNode clearRoot;</a>
<span class="sourceLineNo">6000</span><a id="line.6000">    public boolean shouldClear = false;</a>
<span class="sourceLineNo">6001</span><a id="line.6001"></a>
<span class="sourceLineNo">6002</span><a id="line.6002"></a>
<span class="sourceLineNo">6003</span><a id="line.6003">        public LocalBindingExpr(LocalBinding b, Symbol tag)</a>
<span class="sourceLineNo">6004</span><a id="line.6004">            {</a>
<span class="sourceLineNo">6005</span><a id="line.6005">                if(b.getPrimitiveType() != null &amp;&amp; tag != null)</a>
<span class="sourceLineNo">6006</span><a id="line.6006">                        throw new UnsupportedOperationException("Can't type hint a primitive local");</a>
<span class="sourceLineNo">6007</span><a id="line.6007">                this.b = b;</a>
<span class="sourceLineNo">6008</span><a id="line.6008">                this.tag = tag;</a>
<span class="sourceLineNo">6009</span><a id="line.6009"></a>
<span class="sourceLineNo">6010</span><a id="line.6010">        this.clearPath = (PathNode)CLEAR_PATH.get();</a>
<span class="sourceLineNo">6011</span><a id="line.6011">        this.clearRoot = (PathNode)CLEAR_ROOT.get();</a>
<span class="sourceLineNo">6012</span><a id="line.6012">        IPersistentCollection sites = (IPersistentCollection) RT.get(CLEAR_SITES.get(),b);</a>
<span class="sourceLineNo">6013</span><a id="line.6013">        b.used = true;</a>
<span class="sourceLineNo">6014</span><a id="line.6014"></a>
<span class="sourceLineNo">6015</span><a id="line.6015">        if(b.idx &gt; 0)</a>
<span class="sourceLineNo">6016</span><a id="line.6016">            {</a>
<span class="sourceLineNo">6017</span><a id="line.6017">//            Object dummy;</a>
<span class="sourceLineNo">6018</span><a id="line.6018"></a>
<span class="sourceLineNo">6019</span><a id="line.6019">            if(sites != null)</a>
<span class="sourceLineNo">6020</span><a id="line.6020">                {</a>
<span class="sourceLineNo">6021</span><a id="line.6021">                for(ISeq s = sites.seq();s!=null;s = s.next())</a>
<span class="sourceLineNo">6022</span><a id="line.6022">                    {</a>
<span class="sourceLineNo">6023</span><a id="line.6023">                    LocalBindingExpr o = (LocalBindingExpr) s.first();</a>
<span class="sourceLineNo">6024</span><a id="line.6024">                    PathNode common = commonPath(clearPath,o.clearPath);</a>
<span class="sourceLineNo">6025</span><a id="line.6025">                    if(common != null &amp;&amp; common.type == PATHTYPE.PATH)</a>
<span class="sourceLineNo">6026</span><a id="line.6026">                        o.shouldClear = false;</a>
<span class="sourceLineNo">6027</span><a id="line.6027">//                    else</a>
<span class="sourceLineNo">6028</span><a id="line.6028">//                        dummy = null;</a>
<span class="sourceLineNo">6029</span><a id="line.6029">                    }</a>
<span class="sourceLineNo">6030</span><a id="line.6030">                }</a>
<span class="sourceLineNo">6031</span><a id="line.6031"></a>
<span class="sourceLineNo">6032</span><a id="line.6032">            if(clearRoot == b.clearPathRoot)</a>
<span class="sourceLineNo">6033</span><a id="line.6033">                {</a>
<span class="sourceLineNo">6034</span><a id="line.6034">                this.shouldClear = true;</a>
<span class="sourceLineNo">6035</span><a id="line.6035">                sites = RT.conj(sites,this);</a>
<span class="sourceLineNo">6036</span><a id="line.6036">                CLEAR_SITES.set(RT.assoc(CLEAR_SITES.get(), b, sites));</a>
<span class="sourceLineNo">6037</span><a id="line.6037">                }</a>
<span class="sourceLineNo">6038</span><a id="line.6038">//            else</a>
<span class="sourceLineNo">6039</span><a id="line.6039">//                dummy = null;</a>
<span class="sourceLineNo">6040</span><a id="line.6040">            }</a>
<span class="sourceLineNo">6041</span><a id="line.6041">            }</a>
<span class="sourceLineNo">6042</span><a id="line.6042"></a>
<span class="sourceLineNo">6043</span><a id="line.6043">        public Object eval() {</a>
<span class="sourceLineNo">6044</span><a id="line.6044">                throw new UnsupportedOperationException("Can't eval locals");</a>
<span class="sourceLineNo">6045</span><a id="line.6045">        }</a>
<span class="sourceLineNo">6046</span><a id="line.6046"></a>
<span class="sourceLineNo">6047</span><a id="line.6047">        public boolean canEmitPrimitive(){</a>
<span class="sourceLineNo">6048</span><a id="line.6048">                return b.getPrimitiveType() != null;</a>
<span class="sourceLineNo">6049</span><a id="line.6049">        }</a>
<span class="sourceLineNo">6050</span><a id="line.6050"></a>
<span class="sourceLineNo">6051</span><a id="line.6051">        public void emitUnboxed(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">6052</span><a id="line.6052">                objx.emitUnboxedLocal(gen, b);</a>
<span class="sourceLineNo">6053</span><a id="line.6053">        }</a>
<span class="sourceLineNo">6054</span><a id="line.6054"></a>
<span class="sourceLineNo">6055</span><a id="line.6055">        public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">6056</span><a id="line.6056">                if(context != C.STATEMENT)</a>
<span class="sourceLineNo">6057</span><a id="line.6057">                        objx.emitLocal(gen, b, shouldClear);</a>
<span class="sourceLineNo">6058</span><a id="line.6058">        }</a>
<span class="sourceLineNo">6059</span><a id="line.6059"></a>
<span class="sourceLineNo">6060</span><a id="line.6060">        public Object evalAssign(Expr val) {</a>
<span class="sourceLineNo">6061</span><a id="line.6061">                throw new UnsupportedOperationException("Can't eval locals");</a>
<span class="sourceLineNo">6062</span><a id="line.6062">        }</a>
<span class="sourceLineNo">6063</span><a id="line.6063"></a>
<span class="sourceLineNo">6064</span><a id="line.6064">        public void emitAssign(C context, ObjExpr objx, GeneratorAdapter gen, Expr val){</a>
<span class="sourceLineNo">6065</span><a id="line.6065">                objx.emitAssignLocal(gen, b,val);</a>
<span class="sourceLineNo">6066</span><a id="line.6066">                if(context != C.STATEMENT)</a>
<span class="sourceLineNo">6067</span><a id="line.6067">                        objx.emitLocal(gen, b, false);</a>
<span class="sourceLineNo">6068</span><a id="line.6068">        }</a>
<span class="sourceLineNo">6069</span><a id="line.6069"></a>
<span class="sourceLineNo">6070</span><a id="line.6070">        public boolean hasJavaClass() {</a>
<span class="sourceLineNo">6071</span><a id="line.6071">                return tag != null || b.hasJavaClass();</a>
<span class="sourceLineNo">6072</span><a id="line.6072">        }</a>
<span class="sourceLineNo">6073</span><a id="line.6073"></a>
<span class="sourceLineNo">6074</span><a id="line.6074">    Class jc;</a>
<span class="sourceLineNo">6075</span><a id="line.6075">        public Class getJavaClass() {</a>
<span class="sourceLineNo">6076</span><a id="line.6076">        if (jc == null) {</a>
<span class="sourceLineNo">6077</span><a id="line.6077">            if(tag != null)</a>
<span class="sourceLineNo">6078</span><a id="line.6078">                jc = HostExpr.tagToClass(tag);</a>
<span class="sourceLineNo">6079</span><a id="line.6079">            else</a>
<span class="sourceLineNo">6080</span><a id="line.6080">                jc = b.getJavaClass();</a>
<span class="sourceLineNo">6081</span><a id="line.6081">        }</a>
<span class="sourceLineNo">6082</span><a id="line.6082">        return jc;</a>
<span class="sourceLineNo">6083</span><a id="line.6083">        }</a>
<span class="sourceLineNo">6084</span><a id="line.6084"></a>
<span class="sourceLineNo">6085</span><a id="line.6085"></a>
<span class="sourceLineNo">6086</span><a id="line.6086">}</a>
<span class="sourceLineNo">6087</span><a id="line.6087"></a>
<span class="sourceLineNo">6088</span><a id="line.6088">public static class BodyExpr implements Expr, MaybePrimitiveExpr{</a>
<span class="sourceLineNo">6089</span><a id="line.6089">        PersistentVector exprs;</a>
<span class="sourceLineNo">6090</span><a id="line.6090"></a>
<span class="sourceLineNo">6091</span><a id="line.6091">        public final PersistentVector exprs(){</a>
<span class="sourceLineNo">6092</span><a id="line.6092">                return exprs;</a>
<span class="sourceLineNo">6093</span><a id="line.6093">        }</a>
<span class="sourceLineNo">6094</span><a id="line.6094"></a>
<span class="sourceLineNo">6095</span><a id="line.6095">        public BodyExpr(PersistentVector exprs){</a>
<span class="sourceLineNo">6096</span><a id="line.6096">                this.exprs = exprs;</a>
<span class="sourceLineNo">6097</span><a id="line.6097">        }</a>
<span class="sourceLineNo">6098</span><a id="line.6098"></a>
<span class="sourceLineNo">6099</span><a id="line.6099">        static class Parser implements IParser{</a>
<span class="sourceLineNo">6100</span><a id="line.6100">                public Expr parse(C context, Object frms) {</a>
<span class="sourceLineNo">6101</span><a id="line.6101">                        ISeq forms = (ISeq) frms;</a>
<span class="sourceLineNo">6102</span><a id="line.6102">                        if(Util.equals(RT.first(forms), DO))</a>
<span class="sourceLineNo">6103</span><a id="line.6103">                                forms = RT.next(forms);</a>
<span class="sourceLineNo">6104</span><a id="line.6104">                        PersistentVector exprs = PersistentVector.EMPTY;</a>
<span class="sourceLineNo">6105</span><a id="line.6105">                        for(; forms != null; forms = forms.next())</a>
<span class="sourceLineNo">6106</span><a id="line.6106">                                {</a>
<span class="sourceLineNo">6107</span><a id="line.6107">                                Expr e = (context != C.EVAL &amp;&amp;</a>
<span class="sourceLineNo">6108</span><a id="line.6108">                                          (context == C.STATEMENT || forms.next() != null)) ?</a>
<span class="sourceLineNo">6109</span><a id="line.6109">                                         analyze(C.STATEMENT, forms.first())</a>
<span class="sourceLineNo">6110</span><a id="line.6110">                                                                                            :</a>
<span class="sourceLineNo">6111</span><a id="line.6111">                                         analyze(context, forms.first());</a>
<span class="sourceLineNo">6112</span><a id="line.6112">                                exprs = exprs.cons(e);</a>
<span class="sourceLineNo">6113</span><a id="line.6113">                                }</a>
<span class="sourceLineNo">6114</span><a id="line.6114">                        if(exprs.count() == 0)</a>
<span class="sourceLineNo">6115</span><a id="line.6115">                                exprs = exprs.cons(NIL_EXPR);</a>
<span class="sourceLineNo">6116</span><a id="line.6116">                        return new BodyExpr(exprs);</a>
<span class="sourceLineNo">6117</span><a id="line.6117">                }</a>
<span class="sourceLineNo">6118</span><a id="line.6118">        }</a>
<span class="sourceLineNo">6119</span><a id="line.6119"></a>
<span class="sourceLineNo">6120</span><a id="line.6120">        public Object eval() {</a>
<span class="sourceLineNo">6121</span><a id="line.6121">                Object ret = null;</a>
<span class="sourceLineNo">6122</span><a id="line.6122">                for(Object o : exprs)</a>
<span class="sourceLineNo">6123</span><a id="line.6123">                        {</a>
<span class="sourceLineNo">6124</span><a id="line.6124">                        Expr e = (Expr) o;</a>
<span class="sourceLineNo">6125</span><a id="line.6125">                        ret = e.eval();</a>
<span class="sourceLineNo">6126</span><a id="line.6126">                        }</a>
<span class="sourceLineNo">6127</span><a id="line.6127">                return ret;</a>
<span class="sourceLineNo">6128</span><a id="line.6128">        }</a>
<span class="sourceLineNo">6129</span><a id="line.6129"></a>
<span class="sourceLineNo">6130</span><a id="line.6130">        public boolean canEmitPrimitive(){</a>
<span class="sourceLineNo">6131</span><a id="line.6131">                return lastExpr() instanceof MaybePrimitiveExpr &amp;&amp; ((MaybePrimitiveExpr)lastExpr()).canEmitPrimitive();</a>
<span class="sourceLineNo">6132</span><a id="line.6132">        }</a>
<span class="sourceLineNo">6133</span><a id="line.6133"></a>
<span class="sourceLineNo">6134</span><a id="line.6134">        public void emitUnboxed(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">6135</span><a id="line.6135">                for(int i = 0; i &lt; exprs.count() - 1; i++)</a>
<span class="sourceLineNo">6136</span><a id="line.6136">                        {</a>
<span class="sourceLineNo">6137</span><a id="line.6137">                        Expr e = (Expr) exprs.nth(i);</a>
<span class="sourceLineNo">6138</span><a id="line.6138">                        e.emit(C.STATEMENT, objx, gen);</a>
<span class="sourceLineNo">6139</span><a id="line.6139">                        }</a>
<span class="sourceLineNo">6140</span><a id="line.6140">                MaybePrimitiveExpr last = (MaybePrimitiveExpr) exprs.nth(exprs.count() - 1);</a>
<span class="sourceLineNo">6141</span><a id="line.6141">                last.emitUnboxed(context, objx, gen);</a>
<span class="sourceLineNo">6142</span><a id="line.6142">        }</a>
<span class="sourceLineNo">6143</span><a id="line.6143"></a>
<span class="sourceLineNo">6144</span><a id="line.6144">        public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">6145</span><a id="line.6145">                for(int i = 0; i &lt; exprs.count() - 1; i++)</a>
<span class="sourceLineNo">6146</span><a id="line.6146">                        {</a>
<span class="sourceLineNo">6147</span><a id="line.6147">                        Expr e = (Expr) exprs.nth(i);</a>
<span class="sourceLineNo">6148</span><a id="line.6148">                        e.emit(C.STATEMENT, objx, gen);</a>
<span class="sourceLineNo">6149</span><a id="line.6149">                        }</a>
<span class="sourceLineNo">6150</span><a id="line.6150">                Expr last = (Expr) exprs.nth(exprs.count() - 1);</a>
<span class="sourceLineNo">6151</span><a id="line.6151">                last.emit(context, objx, gen);</a>
<span class="sourceLineNo">6152</span><a id="line.6152">        }</a>
<span class="sourceLineNo">6153</span><a id="line.6153"></a>
<span class="sourceLineNo">6154</span><a id="line.6154">        public boolean hasJavaClass() {</a>
<span class="sourceLineNo">6155</span><a id="line.6155">                return lastExpr().hasJavaClass();</a>
<span class="sourceLineNo">6156</span><a id="line.6156">        }</a>
<span class="sourceLineNo">6157</span><a id="line.6157"></a>
<span class="sourceLineNo">6158</span><a id="line.6158">        public Class getJavaClass() {</a>
<span class="sourceLineNo">6159</span><a id="line.6159">                return lastExpr().getJavaClass();</a>
<span class="sourceLineNo">6160</span><a id="line.6160">        }</a>
<span class="sourceLineNo">6161</span><a id="line.6161"></a>
<span class="sourceLineNo">6162</span><a id="line.6162">        private Expr lastExpr(){</a>
<span class="sourceLineNo">6163</span><a id="line.6163">                return (Expr) exprs.nth(exprs.count() - 1);</a>
<span class="sourceLineNo">6164</span><a id="line.6164">        }</a>
<span class="sourceLineNo">6165</span><a id="line.6165">}</a>
<span class="sourceLineNo">6166</span><a id="line.6166"></a>
<span class="sourceLineNo">6167</span><a id="line.6167">public static class BindingInit{</a>
<span class="sourceLineNo">6168</span><a id="line.6168">        LocalBinding binding;</a>
<span class="sourceLineNo">6169</span><a id="line.6169">        Expr init;</a>
<span class="sourceLineNo">6170</span><a id="line.6170"></a>
<span class="sourceLineNo">6171</span><a id="line.6171">        public final LocalBinding binding(){</a>
<span class="sourceLineNo">6172</span><a id="line.6172">                return binding;</a>
<span class="sourceLineNo">6173</span><a id="line.6173">        }</a>
<span class="sourceLineNo">6174</span><a id="line.6174"></a>
<span class="sourceLineNo">6175</span><a id="line.6175">        public final Expr init(){</a>
<span class="sourceLineNo">6176</span><a id="line.6176">                return init;</a>
<span class="sourceLineNo">6177</span><a id="line.6177">        }</a>
<span class="sourceLineNo">6178</span><a id="line.6178"></a>
<span class="sourceLineNo">6179</span><a id="line.6179">        public BindingInit(LocalBinding binding, Expr init){</a>
<span class="sourceLineNo">6180</span><a id="line.6180">                this.binding = binding;</a>
<span class="sourceLineNo">6181</span><a id="line.6181">                this.init = init;</a>
<span class="sourceLineNo">6182</span><a id="line.6182">        }</a>
<span class="sourceLineNo">6183</span><a id="line.6183">}</a>
<span class="sourceLineNo">6184</span><a id="line.6184"></a>
<span class="sourceLineNo">6185</span><a id="line.6185">public static class LetFnExpr implements Expr{</a>
<span class="sourceLineNo">6186</span><a id="line.6186">        public final PersistentVector bindingInits;</a>
<span class="sourceLineNo">6187</span><a id="line.6187">        public final Expr body;</a>
<span class="sourceLineNo">6188</span><a id="line.6188"></a>
<span class="sourceLineNo">6189</span><a id="line.6189">        public LetFnExpr(PersistentVector bindingInits, Expr body){</a>
<span class="sourceLineNo">6190</span><a id="line.6190">                this.bindingInits = bindingInits;</a>
<span class="sourceLineNo">6191</span><a id="line.6191">                this.body = body;</a>
<span class="sourceLineNo">6192</span><a id="line.6192">        }</a>
<span class="sourceLineNo">6193</span><a id="line.6193"></a>
<span class="sourceLineNo">6194</span><a id="line.6194">        static class Parser implements IParser{</a>
<span class="sourceLineNo">6195</span><a id="line.6195">                public Expr parse(C context, Object frm) {</a>
<span class="sourceLineNo">6196</span><a id="line.6196">                        ISeq form = (ISeq) frm;</a>
<span class="sourceLineNo">6197</span><a id="line.6197">                        //(letfns* [var (fn [args] body) ...] body...)</a>
<span class="sourceLineNo">6198</span><a id="line.6198">                        if(!(RT.second(form) instanceof IPersistentVector))</a>
<span class="sourceLineNo">6199</span><a id="line.6199">                                throw new IllegalArgumentException("Bad binding form, expected vector");</a>
<span class="sourceLineNo">6200</span><a id="line.6200"></a>
<span class="sourceLineNo">6201</span><a id="line.6201">                        IPersistentVector bindings = (IPersistentVector) RT.second(form);</a>
<span class="sourceLineNo">6202</span><a id="line.6202">                        if((bindings.count() % 2) != 0)</a>
<span class="sourceLineNo">6203</span><a id="line.6203">                                throw new IllegalArgumentException("Bad binding form, expected matched symbol expression pairs");</a>
<span class="sourceLineNo">6204</span><a id="line.6204"></a>
<span class="sourceLineNo">6205</span><a id="line.6205">                        ISeq body = RT.next(RT.next(form));</a>
<span class="sourceLineNo">6206</span><a id="line.6206"></a>
<span class="sourceLineNo">6207</span><a id="line.6207">                        if(context == C.EVAL)</a>
<span class="sourceLineNo">6208</span><a id="line.6208">                                return analyze(context, RT.list(RT.list(FNONCE, PersistentVector.EMPTY, form)));</a>
<span class="sourceLineNo">6209</span><a id="line.6209"></a>
<span class="sourceLineNo">6210</span><a id="line.6210">                        IPersistentMap dynamicBindings = RT.map(LOCAL_ENV, LOCAL_ENV.deref(),</a>
<span class="sourceLineNo">6211</span><a id="line.6211">                                                                NEXT_LOCAL_NUM, NEXT_LOCAL_NUM.deref());</a>
<span class="sourceLineNo">6212</span><a id="line.6212"></a>
<span class="sourceLineNo">6213</span><a id="line.6213">                        try</a>
<span class="sourceLineNo">6214</span><a id="line.6214">                                {</a>
<span class="sourceLineNo">6215</span><a id="line.6215">                                Var.pushThreadBindings(dynamicBindings);</a>
<span class="sourceLineNo">6216</span><a id="line.6216"></a>
<span class="sourceLineNo">6217</span><a id="line.6217">                                //pre-seed env (like Lisp labels)</a>
<span class="sourceLineNo">6218</span><a id="line.6218">                                PersistentVector lbs = PersistentVector.EMPTY;</a>
<span class="sourceLineNo">6219</span><a id="line.6219">                                for(int i = 0; i &lt; bindings.count(); i += 2)</a>
<span class="sourceLineNo">6220</span><a id="line.6220">                                        {</a>
<span class="sourceLineNo">6221</span><a id="line.6221">                                        if(!(bindings.nth(i) instanceof Symbol))</a>
<span class="sourceLineNo">6222</span><a id="line.6222">                                                throw new IllegalArgumentException(</a>
<span class="sourceLineNo">6223</span><a id="line.6223">                                                                "Bad binding form, expected symbol, got: " + bindings.nth(i));</a>
<span class="sourceLineNo">6224</span><a id="line.6224">                                        Symbol sym = (Symbol) bindings.nth(i);</a>
<span class="sourceLineNo">6225</span><a id="line.6225">                                        if(sym.getNamespace() != null)</a>
<span class="sourceLineNo">6226</span><a id="line.6226">                                                throw Util.runtimeException("Can't let qualified name: " + sym);</a>
<span class="sourceLineNo">6227</span><a id="line.6227">                                        LocalBinding lb = registerLocal(sym, tagOf(sym), null,false);</a>
<span class="sourceLineNo">6228</span><a id="line.6228">                                        lb.canBeCleared = false;</a>
<span class="sourceLineNo">6229</span><a id="line.6229">                                        lbs = lbs.cons(lb);</a>
<span class="sourceLineNo">6230</span><a id="line.6230">                                        }</a>
<span class="sourceLineNo">6231</span><a id="line.6231">                                PersistentVector bindingInits = PersistentVector.EMPTY;</a>
<span class="sourceLineNo">6232</span><a id="line.6232">                                for(int i = 0; i &lt; bindings.count(); i += 2)</a>
<span class="sourceLineNo">6233</span><a id="line.6233">                                        {</a>
<span class="sourceLineNo">6234</span><a id="line.6234">                                        Symbol sym = (Symbol) bindings.nth(i);</a>
<span class="sourceLineNo">6235</span><a id="line.6235">                                        Expr init = analyze(C.EXPRESSION, bindings.nth(i + 1), sym.name);</a>
<span class="sourceLineNo">6236</span><a id="line.6236">                                        LocalBinding lb = (LocalBinding) lbs.nth(i / 2);</a>
<span class="sourceLineNo">6237</span><a id="line.6237">                                        lb.init = init;</a>
<span class="sourceLineNo">6238</span><a id="line.6238">                                        BindingInit bi = new BindingInit(lb, init);</a>
<span class="sourceLineNo">6239</span><a id="line.6239">                                        bindingInits = bindingInits.cons(bi);</a>
<span class="sourceLineNo">6240</span><a id="line.6240">                                        }</a>
<span class="sourceLineNo">6241</span><a id="line.6241">                                return new LetFnExpr(bindingInits, (new BodyExpr.Parser()).parse(context, body));</a>
<span class="sourceLineNo">6242</span><a id="line.6242">                                }</a>
<span class="sourceLineNo">6243</span><a id="line.6243">                        finally</a>
<span class="sourceLineNo">6244</span><a id="line.6244">                                {</a>
<span class="sourceLineNo">6245</span><a id="line.6245">                                Var.popThreadBindings();</a>
<span class="sourceLineNo">6246</span><a id="line.6246">                                }</a>
<span class="sourceLineNo">6247</span><a id="line.6247">                }</a>
<span class="sourceLineNo">6248</span><a id="line.6248">        }</a>
<span class="sourceLineNo">6249</span><a id="line.6249"></a>
<span class="sourceLineNo">6250</span><a id="line.6250">        public Object eval() {</a>
<span class="sourceLineNo">6251</span><a id="line.6251">                throw new UnsupportedOperationException("Can't eval letfns");</a>
<span class="sourceLineNo">6252</span><a id="line.6252">        }</a>
<span class="sourceLineNo">6253</span><a id="line.6253"></a>
<span class="sourceLineNo">6254</span><a id="line.6254">        public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">6255</span><a id="line.6255">                for(int i = 0; i &lt; bindingInits.count(); i++)</a>
<span class="sourceLineNo">6256</span><a id="line.6256">                        {</a>
<span class="sourceLineNo">6257</span><a id="line.6257">                        BindingInit bi = (BindingInit) bindingInits.nth(i);</a>
<span class="sourceLineNo">6258</span><a id="line.6258">                        gen.visitInsn(Opcodes.ACONST_NULL);</a>
<span class="sourceLineNo">6259</span><a id="line.6259">                        gen.visitVarInsn(OBJECT_TYPE.getOpcode(Opcodes.ISTORE), bi.binding.idx);</a>
<span class="sourceLineNo">6260</span><a id="line.6260">                        }</a>
<span class="sourceLineNo">6261</span><a id="line.6261"></a>
<span class="sourceLineNo">6262</span><a id="line.6262">                IPersistentSet lbset = PersistentHashSet.EMPTY;</a>
<span class="sourceLineNo">6263</span><a id="line.6263"></a>
<span class="sourceLineNo">6264</span><a id="line.6264">                for(int i = 0; i &lt; bindingInits.count(); i++)</a>
<span class="sourceLineNo">6265</span><a id="line.6265">                        {</a>
<span class="sourceLineNo">6266</span><a id="line.6266">                        BindingInit bi = (BindingInit) bindingInits.nth(i);</a>
<span class="sourceLineNo">6267</span><a id="line.6267">                        lbset = (IPersistentSet) lbset.cons(bi.binding);</a>
<span class="sourceLineNo">6268</span><a id="line.6268">                        bi.init.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">6269</span><a id="line.6269">                        gen.visitVarInsn(OBJECT_TYPE.getOpcode(Opcodes.ISTORE), bi.binding.idx);</a>
<span class="sourceLineNo">6270</span><a id="line.6270">                        }</a>
<span class="sourceLineNo">6271</span><a id="line.6271"></a>
<span class="sourceLineNo">6272</span><a id="line.6272">                for(int i = 0; i &lt; bindingInits.count(); i++)</a>
<span class="sourceLineNo">6273</span><a id="line.6273">                        {</a>
<span class="sourceLineNo">6274</span><a id="line.6274">                        BindingInit bi = (BindingInit) bindingInits.nth(i);</a>
<span class="sourceLineNo">6275</span><a id="line.6275">                        ObjExpr fe = (ObjExpr) bi.init;</a>
<span class="sourceLineNo">6276</span><a id="line.6276">                        gen.visitVarInsn(OBJECT_TYPE.getOpcode(Opcodes.ILOAD), bi.binding.idx);</a>
<span class="sourceLineNo">6277</span><a id="line.6277">                        fe.emitLetFnInits(gen, objx, lbset);</a>
<span class="sourceLineNo">6278</span><a id="line.6278">                        }</a>
<span class="sourceLineNo">6279</span><a id="line.6279"></a>
<span class="sourceLineNo">6280</span><a id="line.6280">                Label loopLabel = gen.mark();</a>
<span class="sourceLineNo">6281</span><a id="line.6281"></a>
<span class="sourceLineNo">6282</span><a id="line.6282">                body.emit(context, objx, gen);</a>
<span class="sourceLineNo">6283</span><a id="line.6283"></a>
<span class="sourceLineNo">6284</span><a id="line.6284">                Label end = gen.mark();</a>
<span class="sourceLineNo">6285</span><a id="line.6285">//              gen.visitLocalVariable("this", "Ljava/lang/Object;", null, loopLabel, end, 0);</a>
<span class="sourceLineNo">6286</span><a id="line.6286">                for(ISeq bis = bindingInits.seq(); bis != null; bis = bis.next())</a>
<span class="sourceLineNo">6287</span><a id="line.6287">                        {</a>
<span class="sourceLineNo">6288</span><a id="line.6288">                        BindingInit bi = (BindingInit) bis.first();</a>
<span class="sourceLineNo">6289</span><a id="line.6289">                        String lname = bi.binding.name;</a>
<span class="sourceLineNo">6290</span><a id="line.6290">                        if(lname.endsWith("__auto__"))</a>
<span class="sourceLineNo">6291</span><a id="line.6291">                                lname += RT.nextID();</a>
<span class="sourceLineNo">6292</span><a id="line.6292">                        Class primc = maybePrimitiveType(bi.init);</a>
<span class="sourceLineNo">6293</span><a id="line.6293">                        if(primc != null)</a>
<span class="sourceLineNo">6294</span><a id="line.6294">                                gen.visitLocalVariable(lname, Type.getDescriptor(primc), null, loopLabel, end,</a>
<span class="sourceLineNo">6295</span><a id="line.6295">                                                       bi.binding.idx);</a>
<span class="sourceLineNo">6296</span><a id="line.6296">                        else</a>
<span class="sourceLineNo">6297</span><a id="line.6297">                                gen.visitLocalVariable(lname, "Ljava/lang/Object;", null, loopLabel, end, bi.binding.idx);</a>
<span class="sourceLineNo">6298</span><a id="line.6298">                        }</a>
<span class="sourceLineNo">6299</span><a id="line.6299">        }</a>
<span class="sourceLineNo">6300</span><a id="line.6300"></a>
<span class="sourceLineNo">6301</span><a id="line.6301">        public boolean hasJavaClass() {</a>
<span class="sourceLineNo">6302</span><a id="line.6302">                return body.hasJavaClass();</a>
<span class="sourceLineNo">6303</span><a id="line.6303">        }</a>
<span class="sourceLineNo">6304</span><a id="line.6304"></a>
<span class="sourceLineNo">6305</span><a id="line.6305">        public Class getJavaClass() {</a>
<span class="sourceLineNo">6306</span><a id="line.6306">                return body.getJavaClass();</a>
<span class="sourceLineNo">6307</span><a id="line.6307">        }</a>
<span class="sourceLineNo">6308</span><a id="line.6308">}</a>
<span class="sourceLineNo">6309</span><a id="line.6309"></a>
<span class="sourceLineNo">6310</span><a id="line.6310">public static class LetExpr implements Expr, MaybePrimitiveExpr{</a>
<span class="sourceLineNo">6311</span><a id="line.6311">        public final PersistentVector bindingInits;</a>
<span class="sourceLineNo">6312</span><a id="line.6312">        public final Expr body;</a>
<span class="sourceLineNo">6313</span><a id="line.6313">        public final boolean isLoop;</a>
<span class="sourceLineNo">6314</span><a id="line.6314"></a>
<span class="sourceLineNo">6315</span><a id="line.6315">        public LetExpr(PersistentVector bindingInits, Expr body, boolean isLoop){</a>
<span class="sourceLineNo">6316</span><a id="line.6316">                this.bindingInits = bindingInits;</a>
<span class="sourceLineNo">6317</span><a id="line.6317">                this.body = body;</a>
<span class="sourceLineNo">6318</span><a id="line.6318">                this.isLoop = isLoop;</a>
<span class="sourceLineNo">6319</span><a id="line.6319">        }</a>
<span class="sourceLineNo">6320</span><a id="line.6320"></a>
<span class="sourceLineNo">6321</span><a id="line.6321">        static class Parser implements IParser{</a>
<span class="sourceLineNo">6322</span><a id="line.6322">                public Expr parse(C context, Object frm) {</a>
<span class="sourceLineNo">6323</span><a id="line.6323">                        ISeq form = (ISeq) frm;</a>
<span class="sourceLineNo">6324</span><a id="line.6324">                        //(let [var val var2 val2 ...] body...)</a>
<span class="sourceLineNo">6325</span><a id="line.6325">                        boolean isLoop = RT.first(form).equals(LOOP);</a>
<span class="sourceLineNo">6326</span><a id="line.6326">                        if(!(RT.second(form) instanceof IPersistentVector))</a>
<span class="sourceLineNo">6327</span><a id="line.6327">                                throw new IllegalArgumentException("Bad binding form, expected vector");</a>
<span class="sourceLineNo">6328</span><a id="line.6328"></a>
<span class="sourceLineNo">6329</span><a id="line.6329">                        IPersistentVector bindings = (IPersistentVector) RT.second(form);</a>
<span class="sourceLineNo">6330</span><a id="line.6330">                        if((bindings.count() % 2) != 0)</a>
<span class="sourceLineNo">6331</span><a id="line.6331">                                throw new IllegalArgumentException("Bad binding form, expected matched symbol expression pairs");</a>
<span class="sourceLineNo">6332</span><a id="line.6332"></a>
<span class="sourceLineNo">6333</span><a id="line.6333">                        ISeq body = RT.next(RT.next(form));</a>
<span class="sourceLineNo">6334</span><a id="line.6334"></a>
<span class="sourceLineNo">6335</span><a id="line.6335">                        if(context == C.EVAL</a>
<span class="sourceLineNo">6336</span><a id="line.6336">                           || (context == C.EXPRESSION &amp;&amp; isLoop))</a>
<span class="sourceLineNo">6337</span><a id="line.6337">                                return analyze(context, RT.list(RT.list(FNONCE, PersistentVector.EMPTY, form)));</a>
<span class="sourceLineNo">6338</span><a id="line.6338"></a>
<span class="sourceLineNo">6339</span><a id="line.6339">                        ObjMethod method = (ObjMethod) METHOD.deref();</a>
<span class="sourceLineNo">6340</span><a id="line.6340">                        IPersistentMap backupMethodLocals = method.locals;</a>
<span class="sourceLineNo">6341</span><a id="line.6341">                        IPersistentMap backupMethodIndexLocals = method.indexlocals;</a>
<span class="sourceLineNo">6342</span><a id="line.6342">                        IPersistentVector recurMismatches = PersistentVector.EMPTY;</a>
<span class="sourceLineNo">6343</span><a id="line.6343">                        for (int i = 0; i &lt; bindings.count()/2; i++)</a>
<span class="sourceLineNo">6344</span><a id="line.6344">                                {</a>
<span class="sourceLineNo">6345</span><a id="line.6345">                                recurMismatches = recurMismatches.cons(RT.F);</a>
<span class="sourceLineNo">6346</span><a id="line.6346">                                }</a>
<span class="sourceLineNo">6347</span><a id="line.6347"></a>
<span class="sourceLineNo">6348</span><a id="line.6348">                        //may repeat once for each binding with a mismatch, return breaks</a>
<span class="sourceLineNo">6349</span><a id="line.6349">                        while(true){</a>
<span class="sourceLineNo">6350</span><a id="line.6350">                                IPersistentMap dynamicBindings = RT.map(LOCAL_ENV, LOCAL_ENV.deref(),</a>
<span class="sourceLineNo">6351</span><a id="line.6351">                                                                                                                NEXT_LOCAL_NUM, NEXT_LOCAL_NUM.deref());</a>
<span class="sourceLineNo">6352</span><a id="line.6352">                                method.locals = backupMethodLocals;</a>
<span class="sourceLineNo">6353</span><a id="line.6353">                                method.indexlocals = backupMethodIndexLocals;</a>
<span class="sourceLineNo">6354</span><a id="line.6354"></a>
<span class="sourceLineNo">6355</span><a id="line.6355">                                PathNode looproot = new PathNode(PATHTYPE.PATH, (PathNode) CLEAR_PATH.get());</a>
<span class="sourceLineNo">6356</span><a id="line.6356">                                PathNode clearroot = new PathNode(PATHTYPE.PATH,looproot);</a>
<span class="sourceLineNo">6357</span><a id="line.6357">                                PathNode clearpath = new PathNode(PATHTYPE.PATH,looproot);</a>
<span class="sourceLineNo">6358</span><a id="line.6358">                                if(isLoop)</a>
<span class="sourceLineNo">6359</span><a id="line.6359">                                        dynamicBindings = dynamicBindings.assoc(LOOP_LOCALS, null);</a>
<span class="sourceLineNo">6360</span><a id="line.6360"></a>
<span class="sourceLineNo">6361</span><a id="line.6361">                                try</a>
<span class="sourceLineNo">6362</span><a id="line.6362">                                        {</a>
<span class="sourceLineNo">6363</span><a id="line.6363">                                        Var.pushThreadBindings(dynamicBindings);</a>
<span class="sourceLineNo">6364</span><a id="line.6364"></a>
<span class="sourceLineNo">6365</span><a id="line.6365">                                        PersistentVector bindingInits = PersistentVector.EMPTY;</a>
<span class="sourceLineNo">6366</span><a id="line.6366">                                        PersistentVector loopLocals = PersistentVector.EMPTY;</a>
<span class="sourceLineNo">6367</span><a id="line.6367">                                        for(int i = 0; i &lt; bindings.count(); i += 2)</a>
<span class="sourceLineNo">6368</span><a id="line.6368">                                                {</a>
<span class="sourceLineNo">6369</span><a id="line.6369">                                                if(!(bindings.nth(i) instanceof Symbol))</a>
<span class="sourceLineNo">6370</span><a id="line.6370">                                                        throw new IllegalArgumentException(</a>
<span class="sourceLineNo">6371</span><a id="line.6371">                                                                        "Bad binding form, expected symbol, got: " + bindings.nth(i));</a>
<span class="sourceLineNo">6372</span><a id="line.6372">                                                Symbol sym = (Symbol) bindings.nth(i);</a>
<span class="sourceLineNo">6373</span><a id="line.6373">                                                if(sym.getNamespace() != null)</a>
<span class="sourceLineNo">6374</span><a id="line.6374">                                                        throw Util.runtimeException("Can't let qualified name: " + sym);</a>
<span class="sourceLineNo">6375</span><a id="line.6375">                                                Expr init = analyze(C.EXPRESSION, bindings.nth(i + 1), sym.name);</a>
<span class="sourceLineNo">6376</span><a id="line.6376">                                                if(isLoop)</a>
<span class="sourceLineNo">6377</span><a id="line.6377">                                                        {</a>
<span class="sourceLineNo">6378</span><a id="line.6378">                                                        if(recurMismatches != null &amp;&amp; RT.booleanCast(recurMismatches.nth(i/2)))</a>
<span class="sourceLineNo">6379</span><a id="line.6379">                                                                {</a>
<span class="sourceLineNo">6380</span><a id="line.6380">                                                                init = new StaticMethodExpr("", 0, 0, null, RT.class, "box", RT.vector(init), false);</a>
<span class="sourceLineNo">6381</span><a id="line.6381">                                                                if(RT.booleanCast(RT.WARN_ON_REFLECTION.deref()))</a>
<span class="sourceLineNo">6382</span><a id="line.6382">                                                                        RT.errPrintWriter().println("Auto-boxing loop arg: " + sym);</a>
<span class="sourceLineNo">6383</span><a id="line.6383">                                                                }</a>
<span class="sourceLineNo">6384</span><a id="line.6384">                                                        else if(maybePrimitiveType(init) == int.class)</a>
<span class="sourceLineNo">6385</span><a id="line.6385">                                                                init = new StaticMethodExpr("", 0, 0, null, RT.class, "longCast", RT.vector(init), false);</a>
<span class="sourceLineNo">6386</span><a id="line.6386">                                                        else if(maybePrimitiveType(init) == float.class)</a>
<span class="sourceLineNo">6387</span><a id="line.6387">                                                                init = new StaticMethodExpr("", 0, 0, null, RT.class, "doubleCast", RT.vector(init), false);</a>
<span class="sourceLineNo">6388</span><a id="line.6388">                                                        }</a>
<span class="sourceLineNo">6389</span><a id="line.6389">                                                //sequential enhancement of env (like Lisp let*)</a>
<span class="sourceLineNo">6390</span><a id="line.6390">                                                try</a>
<span class="sourceLineNo">6391</span><a id="line.6391">                                                        {</a>
<span class="sourceLineNo">6392</span><a id="line.6392">                                                        if(isLoop)</a>
<span class="sourceLineNo">6393</span><a id="line.6393">                                                                {</a>
<span class="sourceLineNo">6394</span><a id="line.6394">                                    Var.pushThreadBindings(</a>
<span class="sourceLineNo">6395</span><a id="line.6395">                                                                        RT.map(CLEAR_PATH, clearpath,</a>
<span class="sourceLineNo">6396</span><a id="line.6396">                                               CLEAR_ROOT, clearroot,</a>
<span class="sourceLineNo">6397</span><a id="line.6397">                                               NO_RECUR, null));</a>
<span class="sourceLineNo">6398</span><a id="line.6398"></a>
<span class="sourceLineNo">6399</span><a id="line.6399">                                                                }</a>
<span class="sourceLineNo">6400</span><a id="line.6400">                                                        LocalBinding lb = registerLocal(sym, tagOf(sym), init,false);</a>
<span class="sourceLineNo">6401</span><a id="line.6401">                                                        BindingInit bi = new BindingInit(lb, init);</a>
<span class="sourceLineNo">6402</span><a id="line.6402">                                                        bindingInits = bindingInits.cons(bi);</a>
<span class="sourceLineNo">6403</span><a id="line.6403">                                                        if(isLoop)</a>
<span class="sourceLineNo">6404</span><a id="line.6404">                                                                loopLocals = loopLocals.cons(lb);</a>
<span class="sourceLineNo">6405</span><a id="line.6405">                                                        }</a>
<span class="sourceLineNo">6406</span><a id="line.6406">                                                finally</a>
<span class="sourceLineNo">6407</span><a id="line.6407">                                                        {</a>
<span class="sourceLineNo">6408</span><a id="line.6408">                                                        if(isLoop)</a>
<span class="sourceLineNo">6409</span><a id="line.6409">                                                            Var.popThreadBindings();</a>
<span class="sourceLineNo">6410</span><a id="line.6410">                                                        }</a>
<span class="sourceLineNo">6411</span><a id="line.6411">                                                }</a>
<span class="sourceLineNo">6412</span><a id="line.6412">                                        if(isLoop)</a>
<span class="sourceLineNo">6413</span><a id="line.6413">                                                LOOP_LOCALS.set(loopLocals);</a>
<span class="sourceLineNo">6414</span><a id="line.6414">                                        Expr bodyExpr;</a>
<span class="sourceLineNo">6415</span><a id="line.6415">                                        boolean moreMismatches = false;</a>
<span class="sourceLineNo">6416</span><a id="line.6416">                                        try {</a>
<span class="sourceLineNo">6417</span><a id="line.6417">                                                if(isLoop)</a>
<span class="sourceLineNo">6418</span><a id="line.6418">                                                        {</a>
<span class="sourceLineNo">6419</span><a id="line.6419">                            Object methodReturnContext = context == C.RETURN ? METHOD_RETURN_CONTEXT.deref() : null;</a>
<span class="sourceLineNo">6420</span><a id="line.6420">                            Var.pushThreadBindings(</a>
<span class="sourceLineNo">6421</span><a id="line.6421">                                                                RT.map(CLEAR_PATH, clearpath,</a>
<span class="sourceLineNo">6422</span><a id="line.6422">                                       CLEAR_ROOT, clearroot,</a>
<span class="sourceLineNo">6423</span><a id="line.6423">                                       NO_RECUR, null,</a>
<span class="sourceLineNo">6424</span><a id="line.6424">                                       METHOD_RETURN_CONTEXT, methodReturnContext));</a>
<span class="sourceLineNo">6425</span><a id="line.6425">                                                       </a>
<span class="sourceLineNo">6426</span><a id="line.6426">                                                        }</a>
<span class="sourceLineNo">6427</span><a id="line.6427">                                                bodyExpr = (new BodyExpr.Parser()).parse(isLoop ? C.RETURN : context, body);</a>
<span class="sourceLineNo">6428</span><a id="line.6428">                                                }</a>
<span class="sourceLineNo">6429</span><a id="line.6429">                                        finally{</a>
<span class="sourceLineNo">6430</span><a id="line.6430">                                                if(isLoop)</a>
<span class="sourceLineNo">6431</span><a id="line.6431">                                                        {</a>
<span class="sourceLineNo">6432</span><a id="line.6432">                                                    Var.popThreadBindings();</a>
<span class="sourceLineNo">6433</span><a id="line.6433">                                                        for(int i = 0;i&lt; loopLocals.count();i++)</a>
<span class="sourceLineNo">6434</span><a id="line.6434">                                                                {</a>
<span class="sourceLineNo">6435</span><a id="line.6435">                                                                LocalBinding lb = (LocalBinding) loopLocals.nth(i);</a>
<span class="sourceLineNo">6436</span><a id="line.6436">                                                                if(lb.recurMistmatch)</a>
<span class="sourceLineNo">6437</span><a id="line.6437">                                                                        {</a>
<span class="sourceLineNo">6438</span><a id="line.6438">                                                                        recurMismatches = (IPersistentVector)recurMismatches.assoc(i, RT.T);</a>
<span class="sourceLineNo">6439</span><a id="line.6439">                                                                        moreMismatches = true;</a>
<span class="sourceLineNo">6440</span><a id="line.6440">                                                                        }</a>
<span class="sourceLineNo">6441</span><a id="line.6441">                                                                }</a>
<span class="sourceLineNo">6442</span><a id="line.6442">                                                        }</a>
<span class="sourceLineNo">6443</span><a id="line.6443">                                                }</a>
<span class="sourceLineNo">6444</span><a id="line.6444">                                        if(!moreMismatches)</a>
<span class="sourceLineNo">6445</span><a id="line.6445">                                                return new LetExpr(bindingInits, bodyExpr, isLoop);</a>
<span class="sourceLineNo">6446</span><a id="line.6446">                                        }</a>
<span class="sourceLineNo">6447</span><a id="line.6447">                                finally</a>
<span class="sourceLineNo">6448</span><a id="line.6448">                                        {</a>
<span class="sourceLineNo">6449</span><a id="line.6449">                                        Var.popThreadBindings();</a>
<span class="sourceLineNo">6450</span><a id="line.6450">                                        }</a>
<span class="sourceLineNo">6451</span><a id="line.6451">                        }</a>
<span class="sourceLineNo">6452</span><a id="line.6452">                }</a>
<span class="sourceLineNo">6453</span><a id="line.6453">        }</a>
<span class="sourceLineNo">6454</span><a id="line.6454"></a>
<span class="sourceLineNo">6455</span><a id="line.6455">        public Object eval() {</a>
<span class="sourceLineNo">6456</span><a id="line.6456">                throw new UnsupportedOperationException("Can't eval let/loop");</a>
<span class="sourceLineNo">6457</span><a id="line.6457">        }</a>
<span class="sourceLineNo">6458</span><a id="line.6458"></a>
<span class="sourceLineNo">6459</span><a id="line.6459">        public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">6460</span><a id="line.6460">                doEmit(context, objx, gen, false);</a>
<span class="sourceLineNo">6461</span><a id="line.6461">        }</a>
<span class="sourceLineNo">6462</span><a id="line.6462"></a>
<span class="sourceLineNo">6463</span><a id="line.6463">        public void emitUnboxed(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">6464</span><a id="line.6464">                doEmit(context, objx, gen, true);</a>
<span class="sourceLineNo">6465</span><a id="line.6465">        }</a>
<span class="sourceLineNo">6466</span><a id="line.6466"></a>
<span class="sourceLineNo">6467</span><a id="line.6467"></a>
<span class="sourceLineNo">6468</span><a id="line.6468">        public void doEmit(C context, ObjExpr objx, GeneratorAdapter gen, boolean emitUnboxed){</a>
<span class="sourceLineNo">6469</span><a id="line.6469">                HashMap&lt;BindingInit, Label&gt; bindingLabels = new HashMap();</a>
<span class="sourceLineNo">6470</span><a id="line.6470">                for(int i = 0; i &lt; bindingInits.count(); i++)</a>
<span class="sourceLineNo">6471</span><a id="line.6471">                        {</a>
<span class="sourceLineNo">6472</span><a id="line.6472">                        BindingInit bi = (BindingInit) bindingInits.nth(i);</a>
<span class="sourceLineNo">6473</span><a id="line.6473">                        Class primc = maybePrimitiveType(bi.init);</a>
<span class="sourceLineNo">6474</span><a id="line.6474">                        if(primc != null)</a>
<span class="sourceLineNo">6475</span><a id="line.6475">                                {</a>
<span class="sourceLineNo">6476</span><a id="line.6476">                                ((MaybePrimitiveExpr) bi.init).emitUnboxed(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">6477</span><a id="line.6477">                                gen.visitVarInsn(Type.getType(primc).getOpcode(Opcodes.ISTORE), bi.binding.idx);</a>
<span class="sourceLineNo">6478</span><a id="line.6478">                                }</a>
<span class="sourceLineNo">6479</span><a id="line.6479">                        else</a>
<span class="sourceLineNo">6480</span><a id="line.6480">                                {</a>
<span class="sourceLineNo">6481</span><a id="line.6481">                                bi.init.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">6482</span><a id="line.6482">                                if (!bi.binding.used &amp;&amp; bi.binding.canBeCleared)</a>
<span class="sourceLineNo">6483</span><a id="line.6483">                                        gen.pop();</a>
<span class="sourceLineNo">6484</span><a id="line.6484">                                else</a>
<span class="sourceLineNo">6485</span><a id="line.6485">                                        gen.visitVarInsn(OBJECT_TYPE.getOpcode(Opcodes.ISTORE), bi.binding.idx);</a>
<span class="sourceLineNo">6486</span><a id="line.6486">                                }</a>
<span class="sourceLineNo">6487</span><a id="line.6487">                        bindingLabels.put(bi, gen.mark());</a>
<span class="sourceLineNo">6488</span><a id="line.6488">                        }</a>
<span class="sourceLineNo">6489</span><a id="line.6489">                Label loopLabel = gen.mark();</a>
<span class="sourceLineNo">6490</span><a id="line.6490">                if(isLoop)</a>
<span class="sourceLineNo">6491</span><a id="line.6491">                        {</a>
<span class="sourceLineNo">6492</span><a id="line.6492">                        try</a>
<span class="sourceLineNo">6493</span><a id="line.6493">                                {</a>
<span class="sourceLineNo">6494</span><a id="line.6494">                                Var.pushThreadBindings(RT.map(LOOP_LABEL, loopLabel));</a>
<span class="sourceLineNo">6495</span><a id="line.6495">                                if(emitUnboxed)</a>
<span class="sourceLineNo">6496</span><a id="line.6496">                                        ((MaybePrimitiveExpr)body).emitUnboxed(context, objx, gen);</a>
<span class="sourceLineNo">6497</span><a id="line.6497">                                else</a>
<span class="sourceLineNo">6498</span><a id="line.6498">                                        body.emit(context, objx, gen);</a>
<span class="sourceLineNo">6499</span><a id="line.6499">                                }</a>
<span class="sourceLineNo">6500</span><a id="line.6500">                        finally</a>
<span class="sourceLineNo">6501</span><a id="line.6501">                                {</a>
<span class="sourceLineNo">6502</span><a id="line.6502">                                Var.popThreadBindings();</a>
<span class="sourceLineNo">6503</span><a id="line.6503">                                }</a>
<span class="sourceLineNo">6504</span><a id="line.6504">                        }</a>
<span class="sourceLineNo">6505</span><a id="line.6505">                else</a>
<span class="sourceLineNo">6506</span><a id="line.6506">                        {</a>
<span class="sourceLineNo">6507</span><a id="line.6507">                        if(emitUnboxed)</a>
<span class="sourceLineNo">6508</span><a id="line.6508">                                ((MaybePrimitiveExpr)body).emitUnboxed(context, objx, gen);</a>
<span class="sourceLineNo">6509</span><a id="line.6509">                        else</a>
<span class="sourceLineNo">6510</span><a id="line.6510">                                body.emit(context, objx, gen);</a>
<span class="sourceLineNo">6511</span><a id="line.6511">                        }</a>
<span class="sourceLineNo">6512</span><a id="line.6512">                Label end = gen.mark();</a>
<span class="sourceLineNo">6513</span><a id="line.6513">//              gen.visitLocalVariable("this", "Ljava/lang/Object;", null, loopLabel, end, 0);</a>
<span class="sourceLineNo">6514</span><a id="line.6514">                for(ISeq bis = bindingInits.seq(); bis != null; bis = bis.next())</a>
<span class="sourceLineNo">6515</span><a id="line.6515">                        {</a>
<span class="sourceLineNo">6516</span><a id="line.6516">                        BindingInit bi = (BindingInit) bis.first();</a>
<span class="sourceLineNo">6517</span><a id="line.6517">                        String lname = bi.binding.name;</a>
<span class="sourceLineNo">6518</span><a id="line.6518">                        if(lname.endsWith("__auto__"))</a>
<span class="sourceLineNo">6519</span><a id="line.6519">                                lname += RT.nextID();</a>
<span class="sourceLineNo">6520</span><a id="line.6520">                        Class primc = maybePrimitiveType(bi.init);</a>
<span class="sourceLineNo">6521</span><a id="line.6521">                        if(primc != null)</a>
<span class="sourceLineNo">6522</span><a id="line.6522">                                gen.visitLocalVariable(lname, Type.getDescriptor(primc), null, bindingLabels.get(bi), end,</a>
<span class="sourceLineNo">6523</span><a id="line.6523">                                                       bi.binding.idx);</a>
<span class="sourceLineNo">6524</span><a id="line.6524">                        else</a>
<span class="sourceLineNo">6525</span><a id="line.6525">                                gen.visitLocalVariable(lname, "Ljava/lang/Object;", null, bindingLabels.get(bi), end, bi.binding.idx);</a>
<span class="sourceLineNo">6526</span><a id="line.6526">                        }</a>
<span class="sourceLineNo">6527</span><a id="line.6527">        }</a>
<span class="sourceLineNo">6528</span><a id="line.6528"></a>
<span class="sourceLineNo">6529</span><a id="line.6529">        public boolean hasJavaClass() {</a>
<span class="sourceLineNo">6530</span><a id="line.6530">                return body.hasJavaClass();</a>
<span class="sourceLineNo">6531</span><a id="line.6531">        }</a>
<span class="sourceLineNo">6532</span><a id="line.6532"></a>
<span class="sourceLineNo">6533</span><a id="line.6533">        public Class getJavaClass() {</a>
<span class="sourceLineNo">6534</span><a id="line.6534">                return body.getJavaClass();</a>
<span class="sourceLineNo">6535</span><a id="line.6535">        }</a>
<span class="sourceLineNo">6536</span><a id="line.6536"></a>
<span class="sourceLineNo">6537</span><a id="line.6537">        public boolean canEmitPrimitive(){</a>
<span class="sourceLineNo">6538</span><a id="line.6538">                return body instanceof MaybePrimitiveExpr &amp;&amp; ((MaybePrimitiveExpr)body).canEmitPrimitive();</a>
<span class="sourceLineNo">6539</span><a id="line.6539">        }</a>
<span class="sourceLineNo">6540</span><a id="line.6540"></a>
<span class="sourceLineNo">6541</span><a id="line.6541">}</a>
<span class="sourceLineNo">6542</span><a id="line.6542"></a>
<span class="sourceLineNo">6543</span><a id="line.6543">public static class RecurExpr implements Expr, MaybePrimitiveExpr{</a>
<span class="sourceLineNo">6544</span><a id="line.6544">        public final IPersistentVector args;</a>
<span class="sourceLineNo">6545</span><a id="line.6545">        public final IPersistentVector loopLocals;</a>
<span class="sourceLineNo">6546</span><a id="line.6546">        final int line;</a>
<span class="sourceLineNo">6547</span><a id="line.6547">        final int column;</a>
<span class="sourceLineNo">6548</span><a id="line.6548">        final String source;</a>
<span class="sourceLineNo">6549</span><a id="line.6549"></a>
<span class="sourceLineNo">6550</span><a id="line.6550"></a>
<span class="sourceLineNo">6551</span><a id="line.6551">        public RecurExpr(IPersistentVector loopLocals, IPersistentVector args, int line, int column, String source){</a>
<span class="sourceLineNo">6552</span><a id="line.6552">                this.loopLocals = loopLocals;</a>
<span class="sourceLineNo">6553</span><a id="line.6553">                this.args = args;</a>
<span class="sourceLineNo">6554</span><a id="line.6554">                this.line = line;</a>
<span class="sourceLineNo">6555</span><a id="line.6555">                this.column = column;</a>
<span class="sourceLineNo">6556</span><a id="line.6556">                this.source = source;</a>
<span class="sourceLineNo">6557</span><a id="line.6557">        }</a>
<span class="sourceLineNo">6558</span><a id="line.6558"></a>
<span class="sourceLineNo">6559</span><a id="line.6559">        public Object eval() {</a>
<span class="sourceLineNo">6560</span><a id="line.6560">                throw new UnsupportedOperationException("Can't eval recur");</a>
<span class="sourceLineNo">6561</span><a id="line.6561">        }</a>
<span class="sourceLineNo">6562</span><a id="line.6562"></a>
<span class="sourceLineNo">6563</span><a id="line.6563">        public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">6564</span><a id="line.6564">                Label loopLabel = (Label) LOOP_LABEL.deref();</a>
<span class="sourceLineNo">6565</span><a id="line.6565">                if(loopLabel == null)</a>
<span class="sourceLineNo">6566</span><a id="line.6566">                        throw new IllegalStateException();</a>
<span class="sourceLineNo">6567</span><a id="line.6567">                for(int i = 0; i &lt; loopLocals.count(); i++)</a>
<span class="sourceLineNo">6568</span><a id="line.6568">                        {</a>
<span class="sourceLineNo">6569</span><a id="line.6569">                        LocalBinding lb = (LocalBinding) loopLocals.nth(i);</a>
<span class="sourceLineNo">6570</span><a id="line.6570">                        Expr arg = (Expr) args.nth(i);</a>
<span class="sourceLineNo">6571</span><a id="line.6571">                        if(lb.getPrimitiveType() != null)</a>
<span class="sourceLineNo">6572</span><a id="line.6572">                                {</a>
<span class="sourceLineNo">6573</span><a id="line.6573">                                Class primc = lb.getPrimitiveType();</a>
<span class="sourceLineNo">6574</span><a id="line.6574">                                final Class pc = maybePrimitiveType(arg);</a>
<span class="sourceLineNo">6575</span><a id="line.6575">                                if(pc == primc)</a>
<span class="sourceLineNo">6576</span><a id="line.6576">                                        ((MaybePrimitiveExpr) arg).emitUnboxed(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">6577</span><a id="line.6577">                                else if(primc == long.class &amp;&amp; pc == int.class)</a>
<span class="sourceLineNo">6578</span><a id="line.6578">                                        {</a>
<span class="sourceLineNo">6579</span><a id="line.6579">                                        ((MaybePrimitiveExpr) arg).emitUnboxed(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">6580</span><a id="line.6580">                                        gen.visitInsn(I2L);</a>
<span class="sourceLineNo">6581</span><a id="line.6581">                                        }</a>
<span class="sourceLineNo">6582</span><a id="line.6582">                                else if(primc == double.class &amp;&amp; pc == float.class)</a>
<span class="sourceLineNo">6583</span><a id="line.6583">                                        {</a>
<span class="sourceLineNo">6584</span><a id="line.6584">                                        ((MaybePrimitiveExpr) arg).emitUnboxed(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">6585</span><a id="line.6585">                                        gen.visitInsn(F2D);</a>
<span class="sourceLineNo">6586</span><a id="line.6586">                                        }</a>
<span class="sourceLineNo">6587</span><a id="line.6587">                                else if(primc == int.class &amp;&amp; pc == long.class)</a>
<span class="sourceLineNo">6588</span><a id="line.6588">                                        {</a>
<span class="sourceLineNo">6589</span><a id="line.6589">                                        ((MaybePrimitiveExpr) arg).emitUnboxed(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">6590</span><a id="line.6590">                                        gen.invokeStatic(RT_TYPE, Method.getMethod("int intCast(long)"));</a>
<span class="sourceLineNo">6591</span><a id="line.6591">                                        }</a>
<span class="sourceLineNo">6592</span><a id="line.6592">                                else if(primc == float.class &amp;&amp; pc == double.class)</a>
<span class="sourceLineNo">6593</span><a id="line.6593">                                        {</a>
<span class="sourceLineNo">6594</span><a id="line.6594">                                        ((MaybePrimitiveExpr) arg).emitUnboxed(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">6595</span><a id="line.6595">                                        gen.visitInsn(D2F);</a>
<span class="sourceLineNo">6596</span><a id="line.6596">                                        }</a>
<span class="sourceLineNo">6597</span><a id="line.6597">                                else</a>
<span class="sourceLineNo">6598</span><a id="line.6598">                                        {</a>
<span class="sourceLineNo">6599</span><a id="line.6599">//                                      if(true)//RT.booleanCast(RT.WARN_ON_REFLECTION.deref()))</a>
<span class="sourceLineNo">6600</span><a id="line.6600">                                                throw new IllegalArgumentException</a>
<span class="sourceLineNo">6601</span><a id="line.6601">//                                              RT.errPrintWriter().println</a>
<span class="sourceLineNo">6602</span><a id="line.6602">                                                        (//source + ":" + line +</a>
<span class="sourceLineNo">6603</span><a id="line.6603">                                                         " recur arg for primitive local: " +</a>
<span class="sourceLineNo">6604</span><a id="line.6604">                                                                           lb.name + " is not matching primitive, had: " +</a>
<span class="sourceLineNo">6605</span><a id="line.6605">                                                                                                                        (arg.hasJavaClass() ? arg.getJavaClass().getName():"Object") +</a>
<span class="sourceLineNo">6606</span><a id="line.6606">                                                                                                                        ", needed: " +</a>
<span class="sourceLineNo">6607</span><a id="line.6607">                                                                                                                        primc.getName());</a>
<span class="sourceLineNo">6608</span><a id="line.6608">//                                      arg.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">6609</span><a id="line.6609">//                                      HostExpr.emitUnboxArg(objx,gen,primc);</a>
<span class="sourceLineNo">6610</span><a id="line.6610">                                        }</a>
<span class="sourceLineNo">6611</span><a id="line.6611">                                }</a>
<span class="sourceLineNo">6612</span><a id="line.6612">                        else</a>
<span class="sourceLineNo">6613</span><a id="line.6613">                                {</a>
<span class="sourceLineNo">6614</span><a id="line.6614">                                arg.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">6615</span><a id="line.6615">                                }</a>
<span class="sourceLineNo">6616</span><a id="line.6616">                        }</a>
<span class="sourceLineNo">6617</span><a id="line.6617"></a>
<span class="sourceLineNo">6618</span><a id="line.6618">                for(int i = loopLocals.count() - 1; i &gt;= 0; i--)</a>
<span class="sourceLineNo">6619</span><a id="line.6619">                        {</a>
<span class="sourceLineNo">6620</span><a id="line.6620">                        LocalBinding lb = (LocalBinding) loopLocals.nth(i);</a>
<span class="sourceLineNo">6621</span><a id="line.6621">                        Class primc = lb.getPrimitiveType();</a>
<span class="sourceLineNo">6622</span><a id="line.6622">                        if(lb.isArg)</a>
<span class="sourceLineNo">6623</span><a id="line.6623">                                gen.storeArg(lb.idx-(objx.canBeDirect ?0:1));</a>
<span class="sourceLineNo">6624</span><a id="line.6624">                        else</a>
<span class="sourceLineNo">6625</span><a id="line.6625">                                {</a>
<span class="sourceLineNo">6626</span><a id="line.6626">                                if(primc != null)</a>
<span class="sourceLineNo">6627</span><a id="line.6627">                                        gen.visitVarInsn(Type.getType(primc).getOpcode(Opcodes.ISTORE), lb.idx);</a>
<span class="sourceLineNo">6628</span><a id="line.6628">                                else</a>
<span class="sourceLineNo">6629</span><a id="line.6629">                                        gen.visitVarInsn(OBJECT_TYPE.getOpcode(Opcodes.ISTORE), lb.idx);</a>
<span class="sourceLineNo">6630</span><a id="line.6630">                                }</a>
<span class="sourceLineNo">6631</span><a id="line.6631">                        }</a>
<span class="sourceLineNo">6632</span><a id="line.6632"></a>
<span class="sourceLineNo">6633</span><a id="line.6633">                gen.goTo(loopLabel);</a>
<span class="sourceLineNo">6634</span><a id="line.6634">        }</a>
<span class="sourceLineNo">6635</span><a id="line.6635"></a>
<span class="sourceLineNo">6636</span><a id="line.6636">        public boolean hasJavaClass() {</a>
<span class="sourceLineNo">6637</span><a id="line.6637">                return true;</a>
<span class="sourceLineNo">6638</span><a id="line.6638">        }</a>
<span class="sourceLineNo">6639</span><a id="line.6639"></a>
<span class="sourceLineNo">6640</span><a id="line.6640">        public Class getJavaClass() {</a>
<span class="sourceLineNo">6641</span><a id="line.6641">                return RECUR_CLASS;</a>
<span class="sourceLineNo">6642</span><a id="line.6642">        }</a>
<span class="sourceLineNo">6643</span><a id="line.6643"></a>
<span class="sourceLineNo">6644</span><a id="line.6644">        static class Parser implements IParser{</a>
<span class="sourceLineNo">6645</span><a id="line.6645">                public Expr parse(C context, Object frm) {</a>
<span class="sourceLineNo">6646</span><a id="line.6646">                        int line = lineDeref();</a>
<span class="sourceLineNo">6647</span><a id="line.6647">                        int column = columnDeref();</a>
<span class="sourceLineNo">6648</span><a id="line.6648">                        String source = (String) SOURCE.deref();</a>
<span class="sourceLineNo">6649</span><a id="line.6649"></a>
<span class="sourceLineNo">6650</span><a id="line.6650">                        ISeq form = (ISeq) frm;</a>
<span class="sourceLineNo">6651</span><a id="line.6651">                        IPersistentVector loopLocals = (IPersistentVector) LOOP_LOCALS.deref();</a>
<span class="sourceLineNo">6652</span><a id="line.6652">                        if(context != C.RETURN || loopLocals == null)</a>
<span class="sourceLineNo">6653</span><a id="line.6653">                                throw new UnsupportedOperationException("Can only recur from tail position");</a>
<span class="sourceLineNo">6654</span><a id="line.6654">                        if(NO_RECUR.deref() != null)</a>
<span class="sourceLineNo">6655</span><a id="line.6655">                            throw new UnsupportedOperationException("Cannot recur across try");</a>
<span class="sourceLineNo">6656</span><a id="line.6656">                        PersistentVector args = PersistentVector.EMPTY;</a>
<span class="sourceLineNo">6657</span><a id="line.6657">                        for(ISeq s = RT.seq(form.next()); s != null; s = s.next())</a>
<span class="sourceLineNo">6658</span><a id="line.6658">                                {</a>
<span class="sourceLineNo">6659</span><a id="line.6659">                                args = args.cons(analyze(C.EXPRESSION, s.first()));</a>
<span class="sourceLineNo">6660</span><a id="line.6660">                                }</a>
<span class="sourceLineNo">6661</span><a id="line.6661">                        if(args.count() != loopLocals.count())</a>
<span class="sourceLineNo">6662</span><a id="line.6662">                                throw new IllegalArgumentException(</a>
<span class="sourceLineNo">6663</span><a id="line.6663">                                                String.format("Mismatched argument count to recur, expected: %d args, got: %d",</a>
<span class="sourceLineNo">6664</span><a id="line.6664">                                                              loopLocals.count(), args.count()));</a>
<span class="sourceLineNo">6665</span><a id="line.6665">                        for(int i = 0;i&lt; loopLocals.count();i++)</a>
<span class="sourceLineNo">6666</span><a id="line.6666">                                {</a>
<span class="sourceLineNo">6667</span><a id="line.6667">                                LocalBinding lb = (LocalBinding) loopLocals.nth(i);</a>
<span class="sourceLineNo">6668</span><a id="line.6668">                                Class primc = lb.getPrimitiveType();</a>
<span class="sourceLineNo">6669</span><a id="line.6669">                                if(primc != null)</a>
<span class="sourceLineNo">6670</span><a id="line.6670">                                        {</a>
<span class="sourceLineNo">6671</span><a id="line.6671">                                        boolean mismatch = false;</a>
<span class="sourceLineNo">6672</span><a id="line.6672">                                        final Class pc = maybePrimitiveType((Expr) args.nth(i));</a>
<span class="sourceLineNo">6673</span><a id="line.6673">                                        if(primc == long.class)</a>
<span class="sourceLineNo">6674</span><a id="line.6674">                                                {</a>
<span class="sourceLineNo">6675</span><a id="line.6675">                                                if(!(pc == long.class</a>
<span class="sourceLineNo">6676</span><a id="line.6676">                                                        || pc == int.class</a>
<span class="sourceLineNo">6677</span><a id="line.6677">                                                        || pc == short.class</a>
<span class="sourceLineNo">6678</span><a id="line.6678">                                                        || pc == char.class</a>
<span class="sourceLineNo">6679</span><a id="line.6679">                                                        || pc == byte.class))</a>
<span class="sourceLineNo">6680</span><a id="line.6680">                                                        mismatch = true;</a>
<span class="sourceLineNo">6681</span><a id="line.6681">                                                }</a>
<span class="sourceLineNo">6682</span><a id="line.6682">                                        else if(primc == double.class)</a>
<span class="sourceLineNo">6683</span><a id="line.6683">                                                {</a>
<span class="sourceLineNo">6684</span><a id="line.6684">                                                if(!(pc == double.class</a>
<span class="sourceLineNo">6685</span><a id="line.6685">                                                        || pc == float.class))</a>
<span class="sourceLineNo">6686</span><a id="line.6686">                                                        mismatch = true;</a>
<span class="sourceLineNo">6687</span><a id="line.6687">                                                }</a>
<span class="sourceLineNo">6688</span><a id="line.6688">                                        if(mismatch)</a>
<span class="sourceLineNo">6689</span><a id="line.6689">                                                {</a>
<span class="sourceLineNo">6690</span><a id="line.6690">                                                lb.recurMistmatch = true;</a>
<span class="sourceLineNo">6691</span><a id="line.6691">                                                if(RT.booleanCast(RT.WARN_ON_REFLECTION.deref()))</a>
<span class="sourceLineNo">6692</span><a id="line.6692">                                                        RT.errPrintWriter().println</a>
<span class="sourceLineNo">6693</span><a id="line.6693">                                                                (source + ":" + line +</a>
<span class="sourceLineNo">6694</span><a id="line.6694">                                                                 " recur arg for primitive local: " +</a>
<span class="sourceLineNo">6695</span><a id="line.6695">                                                                                   lb.name + " is not matching primitive, had: " +</a>
<span class="sourceLineNo">6696</span><a id="line.6696">                                                                                                                        (pc != null ? pc.getName():"Object") +</a>
<span class="sourceLineNo">6697</span><a id="line.6697">                                                                                                                        ", needed: " +</a>
<span class="sourceLineNo">6698</span><a id="line.6698">                                                                                                                        primc.getName());</a>
<span class="sourceLineNo">6699</span><a id="line.6699">                                                }</a>
<span class="sourceLineNo">6700</span><a id="line.6700">                                        }</a>
<span class="sourceLineNo">6701</span><a id="line.6701">                                }</a>
<span class="sourceLineNo">6702</span><a id="line.6702">                        return new RecurExpr(loopLocals, args, line, column, source);</a>
<span class="sourceLineNo">6703</span><a id="line.6703">                }</a>
<span class="sourceLineNo">6704</span><a id="line.6704">        }</a>
<span class="sourceLineNo">6705</span><a id="line.6705"></a>
<span class="sourceLineNo">6706</span><a id="line.6706">        public boolean canEmitPrimitive() {</a>
<span class="sourceLineNo">6707</span><a id="line.6707">                return true;</a>
<span class="sourceLineNo">6708</span><a id="line.6708">        }</a>
<span class="sourceLineNo">6709</span><a id="line.6709"></a>
<span class="sourceLineNo">6710</span><a id="line.6710">        public void emitUnboxed(C context, ObjExpr objx, GeneratorAdapter gen) {</a>
<span class="sourceLineNo">6711</span><a id="line.6711">                emit(context, objx, gen);</a>
<span class="sourceLineNo">6712</span><a id="line.6712">        }</a>
<span class="sourceLineNo">6713</span><a id="line.6713">}</a>
<span class="sourceLineNo">6714</span><a id="line.6714"></a>
<span class="sourceLineNo">6715</span><a id="line.6715">private static LocalBinding registerLocal(Symbol sym, Symbol tag, Expr init, boolean isArg) {</a>
<span class="sourceLineNo">6716</span><a id="line.6716">        int num = getAndIncLocalNum();</a>
<span class="sourceLineNo">6717</span><a id="line.6717">        LocalBinding b = new LocalBinding(num, sym, tag, init, isArg, clearPathRoot());</a>
<span class="sourceLineNo">6718</span><a id="line.6718">        IPersistentMap localsMap = (IPersistentMap) LOCAL_ENV.deref();</a>
<span class="sourceLineNo">6719</span><a id="line.6719">        LOCAL_ENV.set(RT.assoc(localsMap, b.sym, b));</a>
<span class="sourceLineNo">6720</span><a id="line.6720">        ObjMethod method = (ObjMethod) METHOD.deref();</a>
<span class="sourceLineNo">6721</span><a id="line.6721">        method.locals = (IPersistentMap) RT.assoc(method.locals, b, b);</a>
<span class="sourceLineNo">6722</span><a id="line.6722">        method.indexlocals = (IPersistentMap) RT.assoc(method.indexlocals, num, b);</a>
<span class="sourceLineNo">6723</span><a id="line.6723">        return b;</a>
<span class="sourceLineNo">6724</span><a id="line.6724">}</a>
<span class="sourceLineNo">6725</span><a id="line.6725"></a>
<span class="sourceLineNo">6726</span><a id="line.6726">private static int getAndIncLocalNum(){</a>
<span class="sourceLineNo">6727</span><a id="line.6727">        int num = ((Number) NEXT_LOCAL_NUM.deref()).intValue();</a>
<span class="sourceLineNo">6728</span><a id="line.6728">        ObjMethod m = (ObjMethod) METHOD.deref();</a>
<span class="sourceLineNo">6729</span><a id="line.6729">        if(num &gt; m.maxLocal)</a>
<span class="sourceLineNo">6730</span><a id="line.6730">                m.maxLocal = num;</a>
<span class="sourceLineNo">6731</span><a id="line.6731">        NEXT_LOCAL_NUM.set(num + 1);</a>
<span class="sourceLineNo">6732</span><a id="line.6732">        return num;</a>
<span class="sourceLineNo">6733</span><a id="line.6733">}</a>
<span class="sourceLineNo">6734</span><a id="line.6734"></a>
<span class="sourceLineNo">6735</span><a id="line.6735">public static Expr analyze(C context, Object form) {</a>
<span class="sourceLineNo">6736</span><a id="line.6736">        return analyze(context, form, null);</a>
<span class="sourceLineNo">6737</span><a id="line.6737">}</a>
<span class="sourceLineNo">6738</span><a id="line.6738"></a>
<span class="sourceLineNo">6739</span><a id="line.6739">private static Expr analyze(C context, Object form, String name) {</a>
<span class="sourceLineNo">6740</span><a id="line.6740">        //todo symbol macro expansion?</a>
<span class="sourceLineNo">6741</span><a id="line.6741">        try</a>
<span class="sourceLineNo">6742</span><a id="line.6742">                {</a>
<span class="sourceLineNo">6743</span><a id="line.6743">                if(form instanceof LazySeq)</a>
<span class="sourceLineNo">6744</span><a id="line.6744">                        {</a>
<span class="sourceLineNo">6745</span><a id="line.6745">                        Object mform = form;</a>
<span class="sourceLineNo">6746</span><a id="line.6746">                        form = RT.seq(form);</a>
<span class="sourceLineNo">6747</span><a id="line.6747">                        if(form == null)</a>
<span class="sourceLineNo">6748</span><a id="line.6748">                                form = PersistentList.EMPTY;</a>
<span class="sourceLineNo">6749</span><a id="line.6749">                        form = ((IObj)form).withMeta(RT.meta(mform));</a>
<span class="sourceLineNo">6750</span><a id="line.6750">                        }</a>
<span class="sourceLineNo">6751</span><a id="line.6751">                if(form == null)</a>
<span class="sourceLineNo">6752</span><a id="line.6752">                        return NIL_EXPR;</a>
<span class="sourceLineNo">6753</span><a id="line.6753">                else if(form == Boolean.TRUE)</a>
<span class="sourceLineNo">6754</span><a id="line.6754">                        return TRUE_EXPR;</a>
<span class="sourceLineNo">6755</span><a id="line.6755">                else if(form == Boolean.FALSE)</a>
<span class="sourceLineNo">6756</span><a id="line.6756">                                return FALSE_EXPR;</a>
<span class="sourceLineNo">6757</span><a id="line.6757">                Class fclass = form.getClass();</a>
<span class="sourceLineNo">6758</span><a id="line.6758">                if(fclass == Symbol.class)</a>
<span class="sourceLineNo">6759</span><a id="line.6759">                        return analyzeSymbol((Symbol) form);</a>
<span class="sourceLineNo">6760</span><a id="line.6760">                else if(fclass == Keyword.class)</a>
<span class="sourceLineNo">6761</span><a id="line.6761">                        return registerKeyword((Keyword) form);</a>
<span class="sourceLineNo">6762</span><a id="line.6762">                else if(form instanceof Number)</a>
<span class="sourceLineNo">6763</span><a id="line.6763">                        return NumberExpr.parse((Number) form);</a>
<span class="sourceLineNo">6764</span><a id="line.6764">                else if(fclass == String.class)</a>
<span class="sourceLineNo">6765</span><a id="line.6765">                                return new StringExpr(((String) form).intern());</a>
<span class="sourceLineNo">6766</span><a id="line.6766">//      else if(fclass == Character.class)</a>
<span class="sourceLineNo">6767</span><a id="line.6767">//              return new CharExpr((Character) form);</a>
<span class="sourceLineNo">6768</span><a id="line.6768">                else if(form instanceof IPersistentCollection</a>
<span class="sourceLineNo">6769</span><a id="line.6769">                &amp;&amp; !(form instanceof IRecord)</a>
<span class="sourceLineNo">6770</span><a id="line.6770">                &amp;&amp; !(form instanceof IType)</a>
<span class="sourceLineNo">6771</span><a id="line.6771">                &amp;&amp; ((IPersistentCollection) form).count() == 0)</a>
<span class="sourceLineNo">6772</span><a id="line.6772">                                {</a>
<span class="sourceLineNo">6773</span><a id="line.6773">                                Expr ret = new EmptyExpr(form);</a>
<span class="sourceLineNo">6774</span><a id="line.6774">                                if(RT.meta(form) != null)</a>
<span class="sourceLineNo">6775</span><a id="line.6775">                                        ret = new MetaExpr(ret, MapExpr</a>
<span class="sourceLineNo">6776</span><a id="line.6776">                                                        .parse(context == C.EVAL ? context : C.EXPRESSION, ((IObj) form).meta()));</a>
<span class="sourceLineNo">6777</span><a id="line.6777">                                return ret;</a>
<span class="sourceLineNo">6778</span><a id="line.6778">                                }</a>
<span class="sourceLineNo">6779</span><a id="line.6779">                else if(form instanceof ISeq)</a>
<span class="sourceLineNo">6780</span><a id="line.6780">                                return analyzeSeq(context, (ISeq) form, name);</a>
<span class="sourceLineNo">6781</span><a id="line.6781">                else if(form instanceof IPersistentVector)</a>
<span class="sourceLineNo">6782</span><a id="line.6782">                                return VectorExpr.parse(context, (IPersistentVector) form);</a>
<span class="sourceLineNo">6783</span><a id="line.6783">                else if(form instanceof IRecord)</a>
<span class="sourceLineNo">6784</span><a id="line.6784">                                return new ConstantExpr(form);</a>
<span class="sourceLineNo">6785</span><a id="line.6785">                else if(form instanceof IType)</a>
<span class="sourceLineNo">6786</span><a id="line.6786">                                return new ConstantExpr(form);</a>
<span class="sourceLineNo">6787</span><a id="line.6787">                else if(form instanceof IPersistentMap)</a>
<span class="sourceLineNo">6788</span><a id="line.6788">                                return MapExpr.parse(context, (IPersistentMap) form);</a>
<span class="sourceLineNo">6789</span><a id="line.6789">                else if(form instanceof IPersistentSet)</a>
<span class="sourceLineNo">6790</span><a id="line.6790">                                return SetExpr.parse(context, (IPersistentSet) form);</a>
<span class="sourceLineNo">6791</span><a id="line.6791"></a>
<span class="sourceLineNo">6792</span><a id="line.6792">//      else</a>
<span class="sourceLineNo">6793</span><a id="line.6793">                //throw new UnsupportedOperationException();</a>
<span class="sourceLineNo">6794</span><a id="line.6794">                return new ConstantExpr(form);</a>
<span class="sourceLineNo">6795</span><a id="line.6795">                }</a>
<span class="sourceLineNo">6796</span><a id="line.6796">        catch(Throwable e)</a>
<span class="sourceLineNo">6797</span><a id="line.6797">                {</a>
<span class="sourceLineNo">6798</span><a id="line.6798">                if(!(e instanceof CompilerException))</a>
<span class="sourceLineNo">6799</span><a id="line.6799">                        throw new CompilerException((String) SOURCE_PATH.deref(), lineDeref(), columnDeref(), e);</a>
<span class="sourceLineNo">6800</span><a id="line.6800">                else</a>
<span class="sourceLineNo">6801</span><a id="line.6801">                        throw (CompilerException) e;</a>
<span class="sourceLineNo">6802</span><a id="line.6802">                }</a>
<span class="sourceLineNo">6803</span><a id="line.6803">}</a>
<span class="sourceLineNo">6804</span><a id="line.6804"></a>
<span class="sourceLineNo">6805</span><a id="line.6805">static public class CompilerException extends RuntimeException implements IExceptionInfo{</a>
<span class="sourceLineNo">6806</span><a id="line.6806">        final public String source;</a>
<span class="sourceLineNo">6807</span><a id="line.6807">        </a>
<span class="sourceLineNo">6808</span><a id="line.6808">        final public int line;</a>
<span class="sourceLineNo">6809</span><a id="line.6809"></a>
<span class="sourceLineNo">6810</span><a id="line.6810">        final public Object data;</a>
<span class="sourceLineNo">6811</span><a id="line.6811"></a>
<span class="sourceLineNo">6812</span><a id="line.6812">    // Error keys</a>
<span class="sourceLineNo">6813</span><a id="line.6813">    final static public String ERR_NS = "clojure.error";</a>
<span class="sourceLineNo">6814</span><a id="line.6814">    final static public Keyword ERR_SOURCE = Keyword.intern(ERR_NS, "source"); // :clojure.error/source</a>
<span class="sourceLineNo">6815</span><a id="line.6815">    final static public Keyword ERR_LINE = Keyword.intern(ERR_NS, "line");     // :clojure.error/line</a>
<span class="sourceLineNo">6816</span><a id="line.6816">    final static public Keyword ERR_COLUMN = Keyword.intern(ERR_NS, "column"); // :clojure.error/column</a>
<span class="sourceLineNo">6817</span><a id="line.6817">    final static public Keyword ERR_PHASE = Keyword.intern(ERR_NS, "phase");   // :clojure.error/phase</a>
<span class="sourceLineNo">6818</span><a id="line.6818">    final static public Keyword ERR_SYMBOL = Keyword.intern(ERR_NS, "symbol"); // :clojure.error/symbol</a>
<span class="sourceLineNo">6819</span><a id="line.6819"></a>
<span class="sourceLineNo">6820</span><a id="line.6820">    // Compile error phases</a>
<span class="sourceLineNo">6821</span><a id="line.6821">    final static public Keyword PHASE_READ = Keyword.intern(null, "read");                // :read</a>
<span class="sourceLineNo">6822</span><a id="line.6822">    final static public Keyword PHASE_MACROEXPAND = Keyword.intern(null, "macroexpand");  // :macroexpand</a>
<span class="sourceLineNo">6823</span><a id="line.6823">    final static public Keyword PHASE_COMPILE = Keyword.intern(null, "compile");          // :compile</a>
<span class="sourceLineNo">6824</span><a id="line.6824"></a>
<span class="sourceLineNo">6825</span><a id="line.6825">        final static public Keyword SPEC_PROBLEMS = Keyword.intern("clojure.spec.alpha", "problems");</a>
<span class="sourceLineNo">6826</span><a id="line.6826"></a>
<span class="sourceLineNo">6827</span><a id="line.6827">    // Class compile exception</a>
<span class="sourceLineNo">6828</span><a id="line.6828">        public CompilerException(String source, int line, int column, Throwable cause){</a>
<span class="sourceLineNo">6829</span><a id="line.6829">                this(source, line, column, null, cause);</a>
<span class="sourceLineNo">6830</span><a id="line.6830">        }</a>
<span class="sourceLineNo">6831</span><a id="line.6831"></a>
<span class="sourceLineNo">6832</span><a id="line.6832">        public CompilerException(String source, int line, int column, Symbol sym, Throwable cause){</a>
<span class="sourceLineNo">6833</span><a id="line.6833">                this(source, line, column, sym, PHASE_COMPILE, cause);</a>
<span class="sourceLineNo">6834</span><a id="line.6834">        }</a>
<span class="sourceLineNo">6835</span><a id="line.6835"></a>
<span class="sourceLineNo">6836</span><a id="line.6836">        public CompilerException(String source, int line, int column, Symbol sym, Keyword phase, Throwable cause){</a>
<span class="sourceLineNo">6837</span><a id="line.6837">                super(makeMsg(source, line, column, sym, phase, cause), cause);</a>
<span class="sourceLineNo">6838</span><a id="line.6838">                this.source = source;</a>
<span class="sourceLineNo">6839</span><a id="line.6839">                this.line = line;</a>
<span class="sourceLineNo">6840</span><a id="line.6840">                Associative m = RT.map(ERR_LINE, line, ERR_COLUMN, column, ERR_PHASE, phase);</a>
<span class="sourceLineNo">6841</span><a id="line.6841">                if(source != null) m = RT.assoc(m, ERR_SOURCE, source);</a>
<span class="sourceLineNo">6842</span><a id="line.6842">                if(sym != null) m = RT.assoc(m, ERR_SYMBOL, sym);</a>
<span class="sourceLineNo">6843</span><a id="line.6843">                this.data = m;</a>
<span class="sourceLineNo">6844</span><a id="line.6844">        }</a>
<span class="sourceLineNo">6845</span><a id="line.6845"></a>
<span class="sourceLineNo">6846</span><a id="line.6846">        public IPersistentMap getData(){</a>
<span class="sourceLineNo">6847</span><a id="line.6847">                return (IPersistentMap)data;</a>
<span class="sourceLineNo">6848</span><a id="line.6848">        }</a>
<span class="sourceLineNo">6849</span><a id="line.6849"></a>
<span class="sourceLineNo">6850</span><a id="line.6850">        private static String verb(Keyword phase) {</a>
<span class="sourceLineNo">6851</span><a id="line.6851">                if(PHASE_COMPILE.equals(phase)){</a>
<span class="sourceLineNo">6852</span><a id="line.6852">                        return "compiling";</a>
<span class="sourceLineNo">6853</span><a id="line.6853">                } else if(PHASE_READ.equals(phase)){</a>
<span class="sourceLineNo">6854</span><a id="line.6854">                        return "reading source";</a>
<span class="sourceLineNo">6855</span><a id="line.6855">                } else {</a>
<span class="sourceLineNo">6856</span><a id="line.6856">                        return "macroexpanding";</a>
<span class="sourceLineNo">6857</span><a id="line.6857">                }</a>
<span class="sourceLineNo">6858</span><a id="line.6858">        }</a>
<span class="sourceLineNo">6859</span><a id="line.6859"></a>
<span class="sourceLineNo">6860</span><a id="line.6860">        private static boolean isMacroSyntaxCheck(Throwable e) {</a>
<span class="sourceLineNo">6861</span><a id="line.6861">                return e instanceof IllegalArgumentException ||</a>
<span class="sourceLineNo">6862</span><a id="line.6862">                                e instanceof IllegalStateException ||</a>
<span class="sourceLineNo">6863</span><a id="line.6863">                                e instanceof ExceptionInfo ||</a>
<span class="sourceLineNo">6864</span><a id="line.6864">                                e.getClass().equals(Exception.class);</a>
<span class="sourceLineNo">6865</span><a id="line.6865">        }</a>
<span class="sourceLineNo">6866</span><a id="line.6866"></a>
<span class="sourceLineNo">6867</span><a id="line.6867">        public static String makeMsg(String source, int line, int column, Symbol sym, Keyword phase, Throwable cause){</a>
<span class="sourceLineNo">6868</span><a id="line.6868">                return (phase == PHASE_MACROEXPAND &amp;&amp; ! isMacroSyntaxCheck(cause) ? "Unexpected error " : "Syntax error ") +</a>
<span class="sourceLineNo">6869</span><a id="line.6869">                                verb(phase) + " " + (sym != null ? sym + " " : "") +</a>
<span class="sourceLineNo">6870</span><a id="line.6870">                                "at (" + (source != null &amp;&amp; !source.equals("NO_SOURCE_PATH") ? (source + ":") : "") +</a>
<span class="sourceLineNo">6871</span><a id="line.6871">                                line + ":" + column + ").";</a>
<span class="sourceLineNo">6872</span><a id="line.6872">        }</a>
<span class="sourceLineNo">6873</span><a id="line.6873"></a>
<span class="sourceLineNo">6874</span><a id="line.6874">        private static boolean isSpecError(Throwable t) {</a>
<span class="sourceLineNo">6875</span><a id="line.6875">                return (t instanceof IExceptionInfo) &amp;&amp; RT.get(((IExceptionInfo) t).getData(), SPEC_PROBLEMS) != null;</a>
<span class="sourceLineNo">6876</span><a id="line.6876">        }</a>
<span class="sourceLineNo">6877</span><a id="line.6877"></a>
<span class="sourceLineNo">6878</span><a id="line.6878">        public String toString(){</a>
<span class="sourceLineNo">6879</span><a id="line.6879">                Throwable cause = getCause();</a>
<span class="sourceLineNo">6880</span><a id="line.6880">                if(cause != null) {</a>
<span class="sourceLineNo">6881</span><a id="line.6881">                        final String delim = (RT.get(data, ERR_PHASE) == PHASE_MACROEXPAND &amp;&amp; isSpecError(cause)) ? " " : "\n";</a>
<span class="sourceLineNo">6882</span><a id="line.6882">                        if(RT.get(data, ERR_PHASE) == PHASE_MACROEXPAND &amp;&amp; ! isMacroSyntaxCheck(cause)) {</a>
<span class="sourceLineNo">6883</span><a id="line.6883">                                return String.format("%s%sCause: %s %s", getMessage(), delim, cause.getClass().getSimpleName(), cause.getMessage());</a>
<span class="sourceLineNo">6884</span><a id="line.6884">                        } else {</a>
<span class="sourceLineNo">6885</span><a id="line.6885">                                return String.format("%s%sCause: %s", getMessage(), delim, cause.getMessage());</a>
<span class="sourceLineNo">6886</span><a id="line.6886">                        }</a>
<span class="sourceLineNo">6887</span><a id="line.6887">                } else {</a>
<span class="sourceLineNo">6888</span><a id="line.6888">                        return getMessage();</a>
<span class="sourceLineNo">6889</span><a id="line.6889">                }</a>
<span class="sourceLineNo">6890</span><a id="line.6890">        }</a>
<span class="sourceLineNo">6891</span><a id="line.6891">}</a>
<span class="sourceLineNo">6892</span><a id="line.6892"></a>
<span class="sourceLineNo">6893</span><a id="line.6893">static public Var isMacro(Object op) {</a>
<span class="sourceLineNo">6894</span><a id="line.6894">        //no local macros for now</a>
<span class="sourceLineNo">6895</span><a id="line.6895">        if(op instanceof Symbol &amp;&amp; referenceLocal((Symbol) op) != null)</a>
<span class="sourceLineNo">6896</span><a id="line.6896">                return null;</a>
<span class="sourceLineNo">6897</span><a id="line.6897">        if(op instanceof Symbol || op instanceof Var)</a>
<span class="sourceLineNo">6898</span><a id="line.6898">                {</a>
<span class="sourceLineNo">6899</span><a id="line.6899">                Var v = (op instanceof Var) ? (Var) op : lookupVar((Symbol) op, false, false);</a>
<span class="sourceLineNo">6900</span><a id="line.6900">                if(v != null &amp;&amp; v.isMacro())</a>
<span class="sourceLineNo">6901</span><a id="line.6901">                        {</a>
<span class="sourceLineNo">6902</span><a id="line.6902">                        if(v.ns != currentNS() &amp;&amp; !v.isPublic())</a>
<span class="sourceLineNo">6903</span><a id="line.6903">                                throw new IllegalStateException("var: " + v + " is not public");</a>
<span class="sourceLineNo">6904</span><a id="line.6904">                        return v;</a>
<span class="sourceLineNo">6905</span><a id="line.6905">                        }</a>
<span class="sourceLineNo">6906</span><a id="line.6906">                }</a>
<span class="sourceLineNo">6907</span><a id="line.6907">        return null;</a>
<span class="sourceLineNo">6908</span><a id="line.6908">}</a>
<span class="sourceLineNo">6909</span><a id="line.6909"></a>
<span class="sourceLineNo">6910</span><a id="line.6910">static public IFn isInline(Object op, int arity) {</a>
<span class="sourceLineNo">6911</span><a id="line.6911">        //no local inlines for now</a>
<span class="sourceLineNo">6912</span><a id="line.6912">        if(op instanceof Symbol &amp;&amp; referenceLocal((Symbol) op) != null)</a>
<span class="sourceLineNo">6913</span><a id="line.6913">                return null;</a>
<span class="sourceLineNo">6914</span><a id="line.6914">        if(op instanceof Symbol || op instanceof Var)</a>
<span class="sourceLineNo">6915</span><a id="line.6915">                {</a>
<span class="sourceLineNo">6916</span><a id="line.6916">                Var v = (op instanceof Var) ? (Var) op : lookupVar((Symbol) op, false);</a>
<span class="sourceLineNo">6917</span><a id="line.6917">                if(v != null)</a>
<span class="sourceLineNo">6918</span><a id="line.6918">                        {</a>
<span class="sourceLineNo">6919</span><a id="line.6919">                        if(v.ns != currentNS() &amp;&amp; !v.isPublic())</a>
<span class="sourceLineNo">6920</span><a id="line.6920">                                throw new IllegalStateException("var: " + v + " is not public");</a>
<span class="sourceLineNo">6921</span><a id="line.6921">                        IFn ret = (IFn) RT.get(v.meta(), inlineKey);</a>
<span class="sourceLineNo">6922</span><a id="line.6922">                        if(ret != null)</a>
<span class="sourceLineNo">6923</span><a id="line.6923">                                {</a>
<span class="sourceLineNo">6924</span><a id="line.6924">                                IFn arityPred = (IFn) RT.get(v.meta(), inlineAritiesKey);</a>
<span class="sourceLineNo">6925</span><a id="line.6925">                                if(arityPred == null || RT.booleanCast(arityPred.invoke(arity)))</a>
<span class="sourceLineNo">6926</span><a id="line.6926">                                        return ret;</a>
<span class="sourceLineNo">6927</span><a id="line.6927">                                }</a>
<span class="sourceLineNo">6928</span><a id="line.6928">                        }</a>
<span class="sourceLineNo">6929</span><a id="line.6929">                }</a>
<span class="sourceLineNo">6930</span><a id="line.6930">        return null;</a>
<span class="sourceLineNo">6931</span><a id="line.6931">}</a>
<span class="sourceLineNo">6932</span><a id="line.6932"></a>
<span class="sourceLineNo">6933</span><a id="line.6933">public static boolean namesStaticMember(Symbol sym){</a>
<span class="sourceLineNo">6934</span><a id="line.6934">        return sym.ns != null &amp;&amp; namespaceFor(sym) == null;</a>
<span class="sourceLineNo">6935</span><a id="line.6935">}</a>
<span class="sourceLineNo">6936</span><a id="line.6936"></a>
<span class="sourceLineNo">6937</span><a id="line.6937">public static Object preserveTag(ISeq src, Object dst) {</a>
<span class="sourceLineNo">6938</span><a id="line.6938">        Symbol tag = tagOf(src);</a>
<span class="sourceLineNo">6939</span><a id="line.6939">        if (tag != null &amp;&amp; dst instanceof IObj) {</a>
<span class="sourceLineNo">6940</span><a id="line.6940">                IPersistentMap meta = RT.meta(dst);</a>
<span class="sourceLineNo">6941</span><a id="line.6941">                return ((IObj) dst).withMeta((IPersistentMap) RT.assoc(meta, RT.TAG_KEY, tag));</a>
<span class="sourceLineNo">6942</span><a id="line.6942">        }</a>
<span class="sourceLineNo">6943</span><a id="line.6943">        return dst;</a>
<span class="sourceLineNo">6944</span><a id="line.6944">}</a>
<span class="sourceLineNo">6945</span><a id="line.6945"></a>
<span class="sourceLineNo">6946</span><a id="line.6946">private static volatile Var MACRO_CHECK = null;</a>
<span class="sourceLineNo">6947</span><a id="line.6947">private static volatile boolean MACRO_CHECK_LOADING = false;</a>
<span class="sourceLineNo">6948</span><a id="line.6948">private static final Object MACRO_CHECK_LOCK = new Object();</a>
<span class="sourceLineNo">6949</span><a id="line.6949"></a>
<span class="sourceLineNo">6950</span><a id="line.6950">private static Var ensureMacroCheck() throws ClassNotFoundException, IOException {</a>
<span class="sourceLineNo">6951</span><a id="line.6951">        if(MACRO_CHECK == null) {</a>
<span class="sourceLineNo">6952</span><a id="line.6952">                synchronized(MACRO_CHECK_LOCK) {</a>
<span class="sourceLineNo">6953</span><a id="line.6953">                        if(MACRO_CHECK == null) {</a>
<span class="sourceLineNo">6954</span><a id="line.6954">                                MACRO_CHECK_LOADING = true;</a>
<span class="sourceLineNo">6955</span><a id="line.6955">                                RT.load("clojure/spec/alpha");</a>
<span class="sourceLineNo">6956</span><a id="line.6956">                                RT.load("clojure/core/specs/alpha");</a>
<span class="sourceLineNo">6957</span><a id="line.6957">                                MACRO_CHECK = Var.find(Symbol.intern("clojure.spec.alpha", "macroexpand-check"));</a>
<span class="sourceLineNo">6958</span><a id="line.6958">                                MACRO_CHECK_LOADING = false;</a>
<span class="sourceLineNo">6959</span><a id="line.6959">                        }</a>
<span class="sourceLineNo">6960</span><a id="line.6960">                }</a>
<span class="sourceLineNo">6961</span><a id="line.6961">        }</a>
<span class="sourceLineNo">6962</span><a id="line.6962">        return MACRO_CHECK;</a>
<span class="sourceLineNo">6963</span><a id="line.6963">}</a>
<span class="sourceLineNo">6964</span><a id="line.6964"></a>
<span class="sourceLineNo">6965</span><a id="line.6965">public static void checkSpecs(Var v, ISeq form) {</a>
<span class="sourceLineNo">6966</span><a id="line.6966">        if(RT.CHECK_SPECS &amp;&amp; !MACRO_CHECK_LOADING) {</a>
<span class="sourceLineNo">6967</span><a id="line.6967">                try {</a>
<span class="sourceLineNo">6968</span><a id="line.6968">                        ensureMacroCheck().applyTo(RT.cons(v, RT.list(form.next())));</a>
<span class="sourceLineNo">6969</span><a id="line.6969">                } catch(Exception e) {</a>
<span class="sourceLineNo">6970</span><a id="line.6970">                        throw new CompilerException((String) SOURCE_PATH.deref(), lineDeref(), columnDeref(), v.toSymbol(), CompilerException.PHASE_MACROEXPAND, e);</a>
<span class="sourceLineNo">6971</span><a id="line.6971">                }</a>
<span class="sourceLineNo">6972</span><a id="line.6972">        }</a>
<span class="sourceLineNo">6973</span><a id="line.6973">}</a>
<span class="sourceLineNo">6974</span><a id="line.6974"></a>
<span class="sourceLineNo">6975</span><a id="line.6975">public static Object macroexpand1(Object x) {</a>
<span class="sourceLineNo">6976</span><a id="line.6976">        if(x instanceof ISeq)</a>
<span class="sourceLineNo">6977</span><a id="line.6977">                {</a>
<span class="sourceLineNo">6978</span><a id="line.6978">                ISeq form = (ISeq) x;</a>
<span class="sourceLineNo">6979</span><a id="line.6979">                Object op = RT.first(form);</a>
<span class="sourceLineNo">6980</span><a id="line.6980">                if(isSpecial(op))</a>
<span class="sourceLineNo">6981</span><a id="line.6981">                        return x;</a>
<span class="sourceLineNo">6982</span><a id="line.6982">                //macro expansion</a>
<span class="sourceLineNo">6983</span><a id="line.6983">                Var v = isMacro(op);</a>
<span class="sourceLineNo">6984</span><a id="line.6984">                if(v != null)</a>
<span class="sourceLineNo">6985</span><a id="line.6985">                        {</a>
<span class="sourceLineNo">6986</span><a id="line.6986">                                checkSpecs(v, form);</a>
<span class="sourceLineNo">6987</span><a id="line.6987"></a>
<span class="sourceLineNo">6988</span><a id="line.6988">                                try</a>
<span class="sourceLineNo">6989</span><a id="line.6989">                                        {</a>
<span class="sourceLineNo">6990</span><a id="line.6990">                    ISeq args = RT.cons(form, RT.cons(Compiler.LOCAL_ENV.get(), form.next()));</a>
<span class="sourceLineNo">6991</span><a id="line.6991">                                        return v.applyTo(args);</a>
<span class="sourceLineNo">6992</span><a id="line.6992">                                        }</a>
<span class="sourceLineNo">6993</span><a id="line.6993">                                catch(ArityException e)</a>
<span class="sourceLineNo">6994</span><a id="line.6994">                                        {</a>
<span class="sourceLineNo">6995</span><a id="line.6995">                                                // hide the 2 extra params for a macro</a>
<span class="sourceLineNo">6996</span><a id="line.6996">                                                if(e.name.equals(munge(v.ns.name.name) + "$" + munge(v.sym.name))) {</a>
<span class="sourceLineNo">6997</span><a id="line.6997">                                                        throw new ArityException(e.actual - 2, e.name);</a>
<span class="sourceLineNo">6998</span><a id="line.6998">                                                } else {</a>
<span class="sourceLineNo">6999</span><a id="line.6999">                                                        throw e;</a>
<span class="sourceLineNo">7000</span><a id="line.7000">                                                }</a>
<span class="sourceLineNo">7001</span><a id="line.7001">                                        }</a>
<span class="sourceLineNo">7002</span><a id="line.7002">                                catch(Throwable e)</a>
<span class="sourceLineNo">7003</span><a id="line.7003">                                    {</a>
<span class="sourceLineNo">7004</span><a id="line.7004">                                                if(e instanceof CompilerException) {</a>
<span class="sourceLineNo">7005</span><a id="line.7005">                                                        throw (CompilerException)e;</a>
<span class="sourceLineNo">7006</span><a id="line.7006">                                                } else {</a>
<span class="sourceLineNo">7007</span><a id="line.7007">                                                        throw new CompilerException((String) SOURCE_PATH.deref(), lineDeref(), columnDeref(),</a>
<span class="sourceLineNo">7008</span><a id="line.7008">                                                                        (op instanceof Symbol ? (Symbol) op : null),</a>
<span class="sourceLineNo">7009</span><a id="line.7009">                                                                        CompilerException.PHASE_MACROEXPAND,</a>
<span class="sourceLineNo">7010</span><a id="line.7010">                                                                        e);</a>
<span class="sourceLineNo">7011</span><a id="line.7011">                                                }</a>
<span class="sourceLineNo">7012</span><a id="line.7012">                                        }</a>
<span class="sourceLineNo">7013</span><a id="line.7013">                        } else</a>
<span class="sourceLineNo">7014</span><a id="line.7014">                        {</a>
<span class="sourceLineNo">7015</span><a id="line.7015">                        if(op instanceof Symbol)</a>
<span class="sourceLineNo">7016</span><a id="line.7016">                                {</a>
<span class="sourceLineNo">7017</span><a id="line.7017">                                Symbol sym = (Symbol) op;</a>
<span class="sourceLineNo">7018</span><a id="line.7018">                                String sname = sym.name;</a>
<span class="sourceLineNo">7019</span><a id="line.7019">                                //(.substring s 2 5) =&gt; (. s substring 2 5)</a>
<span class="sourceLineNo">7020</span><a id="line.7020">                                if(sym.name.charAt(0) == '.')</a>
<span class="sourceLineNo">7021</span><a id="line.7021">                                        {</a>
<span class="sourceLineNo">7022</span><a id="line.7022">                                        if(RT.length(form) &lt; 2)</a>
<span class="sourceLineNo">7023</span><a id="line.7023">                                                throw new IllegalArgumentException(</a>
<span class="sourceLineNo">7024</span><a id="line.7024">                                                                "Malformed member expression, expecting (.member target ...)");</a>
<span class="sourceLineNo">7025</span><a id="line.7025">                                        Symbol meth = Symbol.intern(sname.substring(1));</a>
<span class="sourceLineNo">7026</span><a id="line.7026">                                        Object target = RT.second(form);</a>
<span class="sourceLineNo">7027</span><a id="line.7027">                                        if(HostExpr.maybeClass(target, false) != null)</a>
<span class="sourceLineNo">7028</span><a id="line.7028">                                                {</a>
<span class="sourceLineNo">7029</span><a id="line.7029">                                                target = ((IObj)RT.list(IDENTITY, target)).withMeta(RT.map(RT.TAG_KEY,CLASS));</a>
<span class="sourceLineNo">7030</span><a id="line.7030">                                                }</a>
<span class="sourceLineNo">7031</span><a id="line.7031">                                        return preserveTag(form, RT.listStar(DOT, target, meth, form.next().next()));</a>
<span class="sourceLineNo">7032</span><a id="line.7032">                                        }</a>
<span class="sourceLineNo">7033</span><a id="line.7033">                                else if(namesStaticMember(sym))</a>
<span class="sourceLineNo">7034</span><a id="line.7034">                                        {</a>
<span class="sourceLineNo">7035</span><a id="line.7035">                                        Symbol target = Symbol.intern(sym.ns);</a>
<span class="sourceLineNo">7036</span><a id="line.7036">                                        Class c = HostExpr.maybeClass(target, false);</a>
<span class="sourceLineNo">7037</span><a id="line.7037">                                        if(c != null)</a>
<span class="sourceLineNo">7038</span><a id="line.7038">                                                {</a>
<span class="sourceLineNo">7039</span><a id="line.7039">                                                Symbol meth = Symbol.intern(sym.name);</a>
<span class="sourceLineNo">7040</span><a id="line.7040">                                                return preserveTag(form, RT.listStar(DOT, target, meth, form.next()));</a>
<span class="sourceLineNo">7041</span><a id="line.7041">                                                }</a>
<span class="sourceLineNo">7042</span><a id="line.7042">                                        }</a>
<span class="sourceLineNo">7043</span><a id="line.7043">                                else</a>
<span class="sourceLineNo">7044</span><a id="line.7044">                                        {</a>
<span class="sourceLineNo">7045</span><a id="line.7045">                                        //(s.substring 2 5) =&gt; (. s substring 2 5)</a>
<span class="sourceLineNo">7046</span><a id="line.7046">                                        //also (package.class.name ...) (. package.class name ...)</a>
<span class="sourceLineNo">7047</span><a id="line.7047">                                        int idx = sname.lastIndexOf('.');</a>
<span class="sourceLineNo">7048</span><a id="line.7048">//                                      if(idx &gt; 0 &amp;&amp; idx &lt; sname.length() - 1)</a>
<span class="sourceLineNo">7049</span><a id="line.7049">//                                              {</a>
<span class="sourceLineNo">7050</span><a id="line.7050">//                                              Symbol target = Symbol.intern(sname.substring(0, idx));</a>
<span class="sourceLineNo">7051</span><a id="line.7051">//                                              Symbol meth = Symbol.intern(sname.substring(idx + 1));</a>
<span class="sourceLineNo">7052</span><a id="line.7052">//                                              return RT.listStar(DOT, target, meth, form.rest());</a>
<span class="sourceLineNo">7053</span><a id="line.7053">//                                              }</a>
<span class="sourceLineNo">7054</span><a id="line.7054">                                        //(StringBuilder. "foo") =&gt; (new StringBuilder "foo")   </a>
<span class="sourceLineNo">7055</span><a id="line.7055">                                        //else </a>
<span class="sourceLineNo">7056</span><a id="line.7056">                                        if(idx == sname.length() - 1)</a>
<span class="sourceLineNo">7057</span><a id="line.7057">                                                return RT.listStar(NEW, Symbol.intern(sname.substring(0, idx)), form.next());</a>
<span class="sourceLineNo">7058</span><a id="line.7058">                                        }</a>
<span class="sourceLineNo">7059</span><a id="line.7059">                                }</a>
<span class="sourceLineNo">7060</span><a id="line.7060">                        }</a>
<span class="sourceLineNo">7061</span><a id="line.7061">                }</a>
<span class="sourceLineNo">7062</span><a id="line.7062">        return x;</a>
<span class="sourceLineNo">7063</span><a id="line.7063">}</a>
<span class="sourceLineNo">7064</span><a id="line.7064"></a>
<span class="sourceLineNo">7065</span><a id="line.7065">static Object macroexpand(Object form) {</a>
<span class="sourceLineNo">7066</span><a id="line.7066">        Object exf = macroexpand1(form);</a>
<span class="sourceLineNo">7067</span><a id="line.7067">        if(exf != form)</a>
<span class="sourceLineNo">7068</span><a id="line.7068">                return macroexpand(exf);</a>
<span class="sourceLineNo">7069</span><a id="line.7069">        return form;</a>
<span class="sourceLineNo">7070</span><a id="line.7070">}</a>
<span class="sourceLineNo">7071</span><a id="line.7071"></a>
<span class="sourceLineNo">7072</span><a id="line.7072">private static Expr analyzeSeq(C context, ISeq form, String name) {</a>
<span class="sourceLineNo">7073</span><a id="line.7073">        Object line = lineDeref();</a>
<span class="sourceLineNo">7074</span><a id="line.7074">        Object column = columnDeref();</a>
<span class="sourceLineNo">7075</span><a id="line.7075">        if(RT.meta(form) != null &amp;&amp; RT.meta(form).containsKey(RT.LINE_KEY))</a>
<span class="sourceLineNo">7076</span><a id="line.7076">                line = RT.meta(form).valAt(RT.LINE_KEY);</a>
<span class="sourceLineNo">7077</span><a id="line.7077">        if(RT.meta(form) != null &amp;&amp; RT.meta(form).containsKey(RT.COLUMN_KEY))</a>
<span class="sourceLineNo">7078</span><a id="line.7078">                column = RT.meta(form).valAt(RT.COLUMN_KEY);</a>
<span class="sourceLineNo">7079</span><a id="line.7079">        Var.pushThreadBindings(</a>
<span class="sourceLineNo">7080</span><a id="line.7080">                        RT.map(LINE, line, COLUMN, column));</a>
<span class="sourceLineNo">7081</span><a id="line.7081">        Object op = null;</a>
<span class="sourceLineNo">7082</span><a id="line.7082">        try</a>
<span class="sourceLineNo">7083</span><a id="line.7083">                {</a>
<span class="sourceLineNo">7084</span><a id="line.7084">                Object me = macroexpand1(form);</a>
<span class="sourceLineNo">7085</span><a id="line.7085">                if(me != form)</a>
<span class="sourceLineNo">7086</span><a id="line.7086">                        return analyze(context, me, name);</a>
<span class="sourceLineNo">7087</span><a id="line.7087"></a>
<span class="sourceLineNo">7088</span><a id="line.7088">                op = RT.first(form);</a>
<span class="sourceLineNo">7089</span><a id="line.7089">                if(op == null)</a>
<span class="sourceLineNo">7090</span><a id="line.7090">                        throw new IllegalArgumentException("Can't call nil, form: " + form);</a>
<span class="sourceLineNo">7091</span><a id="line.7091">                IFn inline = isInline(op, RT.count(RT.next(form)));</a>
<span class="sourceLineNo">7092</span><a id="line.7092">                if(inline != null)</a>
<span class="sourceLineNo">7093</span><a id="line.7093">                        return analyze(context, preserveTag(form, inline.applyTo(RT.next(form))));</a>
<span class="sourceLineNo">7094</span><a id="line.7094">                IParser p;</a>
<span class="sourceLineNo">7095</span><a id="line.7095">                if(op.equals(FN))</a>
<span class="sourceLineNo">7096</span><a id="line.7096">                        return FnExpr.parse(context, form, name);</a>
<span class="sourceLineNo">7097</span><a id="line.7097">                else if((p = (IParser) specials.valAt(op)) != null)</a>
<span class="sourceLineNo">7098</span><a id="line.7098">                        return p.parse(context, form);</a>
<span class="sourceLineNo">7099</span><a id="line.7099">                else</a>
<span class="sourceLineNo">7100</span><a id="line.7100">                        return InvokeExpr.parse(context, form);</a>
<span class="sourceLineNo">7101</span><a id="line.7101">                }</a>
<span class="sourceLineNo">7102</span><a id="line.7102">        catch(Throwable e)</a>
<span class="sourceLineNo">7103</span><a id="line.7103">                {</a>
<span class="sourceLineNo">7104</span><a id="line.7104">                Symbol s = (op != null &amp;&amp; op instanceof Symbol) ? (Symbol)op : null;</a>
<span class="sourceLineNo">7105</span><a id="line.7105">                if(!(e instanceof CompilerException)) {</a>
<span class="sourceLineNo">7106</span><a id="line.7106">                        throw new CompilerException((String) SOURCE_PATH.deref(), lineDeref(), columnDeref(), s, e);</a>
<span class="sourceLineNo">7107</span><a id="line.7107">                }</a>
<span class="sourceLineNo">7108</span><a id="line.7108">                else</a>
<span class="sourceLineNo">7109</span><a id="line.7109">                        throw (CompilerException) e;</a>
<span class="sourceLineNo">7110</span><a id="line.7110">                }</a>
<span class="sourceLineNo">7111</span><a id="line.7111">        finally</a>
<span class="sourceLineNo">7112</span><a id="line.7112">                {</a>
<span class="sourceLineNo">7113</span><a id="line.7113">                Var.popThreadBindings();</a>
<span class="sourceLineNo">7114</span><a id="line.7114">                }</a>
<span class="sourceLineNo">7115</span><a id="line.7115">}</a>
<span class="sourceLineNo">7116</span><a id="line.7116"></a>
<span class="sourceLineNo">7117</span><a id="line.7117">// DEPRECATED</a>
<span class="sourceLineNo">7118</span><a id="line.7118">static String errorMsg(String source, int line, int column, String s){</a>
<span class="sourceLineNo">7119</span><a id="line.7119">        return String.format("%s, compiling:(%s:%d:%d)", s, source, line, column);</a>
<span class="sourceLineNo">7120</span><a id="line.7120">}</a>
<span class="sourceLineNo">7121</span><a id="line.7121"></a>
<span class="sourceLineNo">7122</span><a id="line.7122">public static Object eval(Object form) {</a>
<span class="sourceLineNo">7123</span><a id="line.7123">        return eval(form, true);</a>
<span class="sourceLineNo">7124</span><a id="line.7124">}</a>
<span class="sourceLineNo">7125</span><a id="line.7125"></a>
<span class="sourceLineNo">7126</span><a id="line.7126">public static Object eval(Object form, boolean freshLoader) {</a>
<span class="sourceLineNo">7127</span><a id="line.7127">        boolean createdLoader = false;</a>
<span class="sourceLineNo">7128</span><a id="line.7128">        if(true)//!LOADER.isBound())</a>
<span class="sourceLineNo">7129</span><a id="line.7129">                {</a>
<span class="sourceLineNo">7130</span><a id="line.7130">                Var.pushThreadBindings(RT.map(LOADER, RT.makeClassLoader()));</a>
<span class="sourceLineNo">7131</span><a id="line.7131">                createdLoader = true;</a>
<span class="sourceLineNo">7132</span><a id="line.7132">                }</a>
<span class="sourceLineNo">7133</span><a id="line.7133">        try</a>
<span class="sourceLineNo">7134</span><a id="line.7134">                {</a>
<span class="sourceLineNo">7135</span><a id="line.7135">                Object line = lineDeref();</a>
<span class="sourceLineNo">7136</span><a id="line.7136">                Object column = columnDeref();</a>
<span class="sourceLineNo">7137</span><a id="line.7137">                if(RT.meta(form) != null &amp;&amp; RT.meta(form).containsKey(RT.LINE_KEY))</a>
<span class="sourceLineNo">7138</span><a id="line.7138">                        line = RT.meta(form).valAt(RT.LINE_KEY);</a>
<span class="sourceLineNo">7139</span><a id="line.7139">                if(RT.meta(form) != null &amp;&amp; RT.meta(form).containsKey(RT.COLUMN_KEY))</a>
<span class="sourceLineNo">7140</span><a id="line.7140">                        column = RT.meta(form).valAt(RT.COLUMN_KEY);</a>
<span class="sourceLineNo">7141</span><a id="line.7141">                Var.pushThreadBindings(RT.map(LINE, line, COLUMN, column));</a>
<span class="sourceLineNo">7142</span><a id="line.7142">                try</a>
<span class="sourceLineNo">7143</span><a id="line.7143">                        {</a>
<span class="sourceLineNo">7144</span><a id="line.7144">                        form = macroexpand(form);</a>
<span class="sourceLineNo">7145</span><a id="line.7145">                        if(form instanceof ISeq &amp;&amp; Util.equals(RT.first(form), DO))</a>
<span class="sourceLineNo">7146</span><a id="line.7146">                                {</a>
<span class="sourceLineNo">7147</span><a id="line.7147">                                ISeq s = RT.next(form);</a>
<span class="sourceLineNo">7148</span><a id="line.7148">                                for(; RT.next(s) != null; s = RT.next(s))</a>
<span class="sourceLineNo">7149</span><a id="line.7149">                                        eval(RT.first(s), false);</a>
<span class="sourceLineNo">7150</span><a id="line.7150">                                return eval(RT.first(s), false);</a>
<span class="sourceLineNo">7151</span><a id="line.7151">                                }</a>
<span class="sourceLineNo">7152</span><a id="line.7152">                        else if((form instanceof IType) ||</a>
<span class="sourceLineNo">7153</span><a id="line.7153">                                        (form instanceof IPersistentCollection</a>
<span class="sourceLineNo">7154</span><a id="line.7154">                                        &amp;&amp; !(RT.first(form) instanceof Symbol</a>
<span class="sourceLineNo">7155</span><a id="line.7155">                                                &amp;&amp; ((Symbol) RT.first(form)).name.startsWith("def"))))</a>
<span class="sourceLineNo">7156</span><a id="line.7156">                                {</a>
<span class="sourceLineNo">7157</span><a id="line.7157">                                ObjExpr fexpr = (ObjExpr) analyze(C.EXPRESSION, RT.list(FN, PersistentVector.EMPTY, form),</a>
<span class="sourceLineNo">7158</span><a id="line.7158">                                                                                                        "eval" + RT.nextID());</a>
<span class="sourceLineNo">7159</span><a id="line.7159">                                IFn fn = (IFn) fexpr.eval();</a>
<span class="sourceLineNo">7160</span><a id="line.7160">                                return fn.invoke();</a>
<span class="sourceLineNo">7161</span><a id="line.7161">                                }</a>
<span class="sourceLineNo">7162</span><a id="line.7162">                        else</a>
<span class="sourceLineNo">7163</span><a id="line.7163">                                {</a>
<span class="sourceLineNo">7164</span><a id="line.7164">                                Expr expr = analyze(C.EVAL, form);</a>
<span class="sourceLineNo">7165</span><a id="line.7165">                                return expr.eval();</a>
<span class="sourceLineNo">7166</span><a id="line.7166">                                }</a>
<span class="sourceLineNo">7167</span><a id="line.7167">                        }</a>
<span class="sourceLineNo">7168</span><a id="line.7168">                finally</a>
<span class="sourceLineNo">7169</span><a id="line.7169">                        {</a>
<span class="sourceLineNo">7170</span><a id="line.7170">                        Var.popThreadBindings();</a>
<span class="sourceLineNo">7171</span><a id="line.7171">                        }</a>
<span class="sourceLineNo">7172</span><a id="line.7172">                }</a>
<span class="sourceLineNo">7173</span><a id="line.7173"></a>
<span class="sourceLineNo">7174</span><a id="line.7174">        finally</a>
<span class="sourceLineNo">7175</span><a id="line.7175">                {</a>
<span class="sourceLineNo">7176</span><a id="line.7176">                if(createdLoader)</a>
<span class="sourceLineNo">7177</span><a id="line.7177">                        Var.popThreadBindings();</a>
<span class="sourceLineNo">7178</span><a id="line.7178">                }</a>
<span class="sourceLineNo">7179</span><a id="line.7179">}</a>
<span class="sourceLineNo">7180</span><a id="line.7180"></a>
<span class="sourceLineNo">7181</span><a id="line.7181">private static int registerConstant(Object o){</a>
<span class="sourceLineNo">7182</span><a id="line.7182">        if(!CONSTANTS.isBound())</a>
<span class="sourceLineNo">7183</span><a id="line.7183">                return -1;</a>
<span class="sourceLineNo">7184</span><a id="line.7184">        PersistentVector v = (PersistentVector) CONSTANTS.deref();</a>
<span class="sourceLineNo">7185</span><a id="line.7185">        IdentityHashMap&lt;Object,Integer&gt; ids = (IdentityHashMap&lt;Object,Integer&gt;) CONSTANT_IDS.deref();</a>
<span class="sourceLineNo">7186</span><a id="line.7186">        Integer i = ids.get(o);</a>
<span class="sourceLineNo">7187</span><a id="line.7187">        if(i != null)</a>
<span class="sourceLineNo">7188</span><a id="line.7188">                return i;</a>
<span class="sourceLineNo">7189</span><a id="line.7189">        CONSTANTS.set(RT.conj(v, o));</a>
<span class="sourceLineNo">7190</span><a id="line.7190">        ids.put(o, v.count());</a>
<span class="sourceLineNo">7191</span><a id="line.7191">        return v.count();</a>
<span class="sourceLineNo">7192</span><a id="line.7192">}</a>
<span class="sourceLineNo">7193</span><a id="line.7193"></a>
<span class="sourceLineNo">7194</span><a id="line.7194">private static KeywordExpr registerKeyword(Keyword keyword){</a>
<span class="sourceLineNo">7195</span><a id="line.7195">        if(!KEYWORDS.isBound())</a>
<span class="sourceLineNo">7196</span><a id="line.7196">                return new KeywordExpr(keyword);</a>
<span class="sourceLineNo">7197</span><a id="line.7197"></a>
<span class="sourceLineNo">7198</span><a id="line.7198">        IPersistentMap keywordsMap = (IPersistentMap) KEYWORDS.deref();</a>
<span class="sourceLineNo">7199</span><a id="line.7199">        Object id = RT.get(keywordsMap, keyword);</a>
<span class="sourceLineNo">7200</span><a id="line.7200">        if(id == null)</a>
<span class="sourceLineNo">7201</span><a id="line.7201">                {</a>
<span class="sourceLineNo">7202</span><a id="line.7202">                KEYWORDS.set(RT.assoc(keywordsMap, keyword, registerConstant(keyword)));</a>
<span class="sourceLineNo">7203</span><a id="line.7203">                }</a>
<span class="sourceLineNo">7204</span><a id="line.7204">        return new KeywordExpr(keyword);</a>
<span class="sourceLineNo">7205</span><a id="line.7205">//      KeywordExpr ke = (KeywordExpr) RT.get(keywordsMap, keyword);</a>
<span class="sourceLineNo">7206</span><a id="line.7206">//      if(ke == null)</a>
<span class="sourceLineNo">7207</span><a id="line.7207">//              KEYWORDS.set(RT.assoc(keywordsMap, keyword, ke = new KeywordExpr(keyword)));</a>
<span class="sourceLineNo">7208</span><a id="line.7208">//      return ke;</a>
<span class="sourceLineNo">7209</span><a id="line.7209">}</a>
<span class="sourceLineNo">7210</span><a id="line.7210"></a>
<span class="sourceLineNo">7211</span><a id="line.7211">private static int registerKeywordCallsite(Keyword keyword){</a>
<span class="sourceLineNo">7212</span><a id="line.7212">        if(!KEYWORD_CALLSITES.isBound())</a>
<span class="sourceLineNo">7213</span><a id="line.7213">                throw new IllegalAccessError("KEYWORD_CALLSITES is not bound");</a>
<span class="sourceLineNo">7214</span><a id="line.7214"></a>
<span class="sourceLineNo">7215</span><a id="line.7215">        IPersistentVector keywordCallsites = (IPersistentVector) KEYWORD_CALLSITES.deref();</a>
<span class="sourceLineNo">7216</span><a id="line.7216"></a>
<span class="sourceLineNo">7217</span><a id="line.7217">        keywordCallsites = keywordCallsites.cons(keyword);</a>
<span class="sourceLineNo">7218</span><a id="line.7218">        KEYWORD_CALLSITES.set(keywordCallsites);</a>
<span class="sourceLineNo">7219</span><a id="line.7219">        return keywordCallsites.count()-1;</a>
<span class="sourceLineNo">7220</span><a id="line.7220">}</a>
<span class="sourceLineNo">7221</span><a id="line.7221"></a>
<span class="sourceLineNo">7222</span><a id="line.7222">private static int registerProtocolCallsite(Var v){</a>
<span class="sourceLineNo">7223</span><a id="line.7223">        if(!PROTOCOL_CALLSITES.isBound())</a>
<span class="sourceLineNo">7224</span><a id="line.7224">                throw new IllegalAccessError("PROTOCOL_CALLSITES is not bound");</a>
<span class="sourceLineNo">7225</span><a id="line.7225"></a>
<span class="sourceLineNo">7226</span><a id="line.7226">        IPersistentVector protocolCallsites = (IPersistentVector) PROTOCOL_CALLSITES.deref();</a>
<span class="sourceLineNo">7227</span><a id="line.7227"></a>
<span class="sourceLineNo">7228</span><a id="line.7228">        protocolCallsites = protocolCallsites.cons(v);</a>
<span class="sourceLineNo">7229</span><a id="line.7229">        PROTOCOL_CALLSITES.set(protocolCallsites);</a>
<span class="sourceLineNo">7230</span><a id="line.7230">        return protocolCallsites.count()-1;</a>
<span class="sourceLineNo">7231</span><a id="line.7231">}</a>
<span class="sourceLineNo">7232</span><a id="line.7232"></a>
<span class="sourceLineNo">7233</span><a id="line.7233">private static void registerVarCallsite(Var v){</a>
<span class="sourceLineNo">7234</span><a id="line.7234">        if(!VAR_CALLSITES.isBound())</a>
<span class="sourceLineNo">7235</span><a id="line.7235">                throw new IllegalAccessError("VAR_CALLSITES is not bound");</a>
<span class="sourceLineNo">7236</span><a id="line.7236"></a>
<span class="sourceLineNo">7237</span><a id="line.7237">        IPersistentCollection varCallsites = (IPersistentCollection) VAR_CALLSITES.deref();</a>
<span class="sourceLineNo">7238</span><a id="line.7238"></a>
<span class="sourceLineNo">7239</span><a id="line.7239">        varCallsites = varCallsites.cons(v);</a>
<span class="sourceLineNo">7240</span><a id="line.7240">        VAR_CALLSITES.set(varCallsites);</a>
<span class="sourceLineNo">7241</span><a id="line.7241">//      return varCallsites.count()-1;</a>
<span class="sourceLineNo">7242</span><a id="line.7242">}</a>
<span class="sourceLineNo">7243</span><a id="line.7243"></a>
<span class="sourceLineNo">7244</span><a id="line.7244">static ISeq fwdPath(PathNode p1){</a>
<span class="sourceLineNo">7245</span><a id="line.7245">    ISeq ret = null;</a>
<span class="sourceLineNo">7246</span><a id="line.7246">    for(;p1 != null;p1 = p1.parent)</a>
<span class="sourceLineNo">7247</span><a id="line.7247">        ret = RT.cons(p1,ret);</a>
<span class="sourceLineNo">7248</span><a id="line.7248">    return ret;</a>
<span class="sourceLineNo">7249</span><a id="line.7249">}</a>
<span class="sourceLineNo">7250</span><a id="line.7250"></a>
<span class="sourceLineNo">7251</span><a id="line.7251">static PathNode commonPath(PathNode n1, PathNode n2){</a>
<span class="sourceLineNo">7252</span><a id="line.7252">    ISeq xp = fwdPath(n1);</a>
<span class="sourceLineNo">7253</span><a id="line.7253">    ISeq yp = fwdPath(n2);</a>
<span class="sourceLineNo">7254</span><a id="line.7254">    if(RT.first(xp) != RT.first(yp))</a>
<span class="sourceLineNo">7255</span><a id="line.7255">        return null;</a>
<span class="sourceLineNo">7256</span><a id="line.7256">    while(RT.second(xp) != null &amp;&amp; RT.second(xp) == RT.second(yp))</a>
<span class="sourceLineNo">7257</span><a id="line.7257">        {</a>
<span class="sourceLineNo">7258</span><a id="line.7258">        xp = xp.next();</a>
<span class="sourceLineNo">7259</span><a id="line.7259">        yp = yp.next();</a>
<span class="sourceLineNo">7260</span><a id="line.7260">        }</a>
<span class="sourceLineNo">7261</span><a id="line.7261">    return (PathNode) RT.first(xp);</a>
<span class="sourceLineNo">7262</span><a id="line.7262">}</a>
<span class="sourceLineNo">7263</span><a id="line.7263"></a>
<span class="sourceLineNo">7264</span><a id="line.7264">static void addAnnotation(Object visitor, IPersistentMap meta){</a>
<span class="sourceLineNo">7265</span><a id="line.7265">        if(meta != null &amp;&amp; ADD_ANNOTATIONS.isBound())</a>
<span class="sourceLineNo">7266</span><a id="line.7266">                 ADD_ANNOTATIONS.invoke(visitor, meta);</a>
<span class="sourceLineNo">7267</span><a id="line.7267">}</a>
<span class="sourceLineNo">7268</span><a id="line.7268"></a>
<span class="sourceLineNo">7269</span><a id="line.7269">static void addParameterAnnotation(Object visitor, IPersistentMap meta, int i){</a>
<span class="sourceLineNo">7270</span><a id="line.7270">        if(meta != null &amp;&amp; ADD_ANNOTATIONS.isBound())</a>
<span class="sourceLineNo">7271</span><a id="line.7271">                 ADD_ANNOTATIONS.invoke(visitor, meta, i);</a>
<span class="sourceLineNo">7272</span><a id="line.7272">}</a>
<span class="sourceLineNo">7273</span><a id="line.7273"></a>
<span class="sourceLineNo">7274</span><a id="line.7274">private static Expr analyzeSymbol(Symbol sym) {</a>
<span class="sourceLineNo">7275</span><a id="line.7275">        Symbol tag = tagOf(sym);</a>
<span class="sourceLineNo">7276</span><a id="line.7276">        if(sym.ns == null) //ns-qualified syms are always Vars</a>
<span class="sourceLineNo">7277</span><a id="line.7277">                {</a>
<span class="sourceLineNo">7278</span><a id="line.7278">                LocalBinding b = referenceLocal(sym);</a>
<span class="sourceLineNo">7279</span><a id="line.7279">                if(b != null)</a>
<span class="sourceLineNo">7280</span><a id="line.7280">            {</a>
<span class="sourceLineNo">7281</span><a id="line.7281">            return new LocalBindingExpr(b, tag);</a>
<span class="sourceLineNo">7282</span><a id="line.7282">            }</a>
<span class="sourceLineNo">7283</span><a id="line.7283">                }</a>
<span class="sourceLineNo">7284</span><a id="line.7284">        else</a>
<span class="sourceLineNo">7285</span><a id="line.7285">                {</a>
<span class="sourceLineNo">7286</span><a id="line.7286">                if(namespaceFor(sym) == null)</a>
<span class="sourceLineNo">7287</span><a id="line.7287">                        {</a>
<span class="sourceLineNo">7288</span><a id="line.7288">                        Symbol nsSym = Symbol.intern(sym.ns);</a>
<span class="sourceLineNo">7289</span><a id="line.7289">                        Class c = HostExpr.maybeClass(nsSym, false);</a>
<span class="sourceLineNo">7290</span><a id="line.7290">                        if(c != null)</a>
<span class="sourceLineNo">7291</span><a id="line.7291">                                {</a>
<span class="sourceLineNo">7292</span><a id="line.7292">                                if(Reflector.getField(c, sym.name, true) != null)</a>
<span class="sourceLineNo">7293</span><a id="line.7293">                                        return new StaticFieldExpr(lineDeref(), columnDeref(), c, sym.name, tag);</a>
<span class="sourceLineNo">7294</span><a id="line.7294">                                throw Util.runtimeException("Unable to find static field: " + sym.name + " in " + c);</a>
<span class="sourceLineNo">7295</span><a id="line.7295">                                }</a>
<span class="sourceLineNo">7296</span><a id="line.7296">                        }</a>
<span class="sourceLineNo">7297</span><a id="line.7297">                }</a>
<span class="sourceLineNo">7298</span><a id="line.7298">        //Var v = lookupVar(sym, false);</a>
<span class="sourceLineNo">7299</span><a id="line.7299">//      Var v = lookupVar(sym, false);</a>
<span class="sourceLineNo">7300</span><a id="line.7300">//      if(v != null)</a>
<span class="sourceLineNo">7301</span><a id="line.7301">//              return new VarExpr(v, tag);</a>
<span class="sourceLineNo">7302</span><a id="line.7302">        Object o = resolve(sym);</a>
<span class="sourceLineNo">7303</span><a id="line.7303">        if(o instanceof Var)</a>
<span class="sourceLineNo">7304</span><a id="line.7304">                {</a>
<span class="sourceLineNo">7305</span><a id="line.7305">                Var v = (Var) o;</a>
<span class="sourceLineNo">7306</span><a id="line.7306">                if(isMacro(v) != null)</a>
<span class="sourceLineNo">7307</span><a id="line.7307">                        throw Util.runtimeException("Can't take value of a macro: " + v);</a>
<span class="sourceLineNo">7308</span><a id="line.7308">                if(RT.booleanCast(RT.get(v.meta(),RT.CONST_KEY)))</a>
<span class="sourceLineNo">7309</span><a id="line.7309">                        return analyze(C.EXPRESSION, RT.list(QUOTE, v.get()));</a>
<span class="sourceLineNo">7310</span><a id="line.7310">                registerVar(v);</a>
<span class="sourceLineNo">7311</span><a id="line.7311">                return new VarExpr(v, tag);</a>
<span class="sourceLineNo">7312</span><a id="line.7312">                }</a>
<span class="sourceLineNo">7313</span><a id="line.7313">        else if(o instanceof Class)</a>
<span class="sourceLineNo">7314</span><a id="line.7314">                return new ConstantExpr(o);</a>
<span class="sourceLineNo">7315</span><a id="line.7315">        else if(o instanceof Symbol)</a>
<span class="sourceLineNo">7316</span><a id="line.7316">                        return new UnresolvedVarExpr((Symbol) o);</a>
<span class="sourceLineNo">7317</span><a id="line.7317"></a>
<span class="sourceLineNo">7318</span><a id="line.7318">        throw Util.runtimeException("Unable to resolve symbol: " + sym + " in this context");</a>
<span class="sourceLineNo">7319</span><a id="line.7319"></a>
<span class="sourceLineNo">7320</span><a id="line.7320">}</a>
<span class="sourceLineNo">7321</span><a id="line.7321"></a>
<span class="sourceLineNo">7322</span><a id="line.7322">static String destubClassName(String className){</a>
<span class="sourceLineNo">7323</span><a id="line.7323">        //skip over prefix + '.' or '/'</a>
<span class="sourceLineNo">7324</span><a id="line.7324">        if(className.startsWith(COMPILE_STUB_PREFIX))</a>
<span class="sourceLineNo">7325</span><a id="line.7325">                return className.substring(COMPILE_STUB_PREFIX.length()+1);</a>
<span class="sourceLineNo">7326</span><a id="line.7326">        return className;</a>
<span class="sourceLineNo">7327</span><a id="line.7327">}</a>
<span class="sourceLineNo">7328</span><a id="line.7328"></a>
<span class="sourceLineNo">7329</span><a id="line.7329">static Type getType(Class c){</a>
<span class="sourceLineNo">7330</span><a id="line.7330">        String descriptor = Type.getType(c).getDescriptor();</a>
<span class="sourceLineNo">7331</span><a id="line.7331">        if(descriptor.startsWith("L"))</a>
<span class="sourceLineNo">7332</span><a id="line.7332">                descriptor = "L" + destubClassName(descriptor.substring(1));</a>
<span class="sourceLineNo">7333</span><a id="line.7333">        return Type.getType(descriptor);</a>
<span class="sourceLineNo">7334</span><a id="line.7334">}</a>
<span class="sourceLineNo">7335</span><a id="line.7335"></a>
<span class="sourceLineNo">7336</span><a id="line.7336">static Object resolve(Symbol sym, boolean allowPrivate) {</a>
<span class="sourceLineNo">7337</span><a id="line.7337">        return resolveIn(currentNS(), sym, allowPrivate);</a>
<span class="sourceLineNo">7338</span><a id="line.7338">}</a>
<span class="sourceLineNo">7339</span><a id="line.7339"></a>
<span class="sourceLineNo">7340</span><a id="line.7340">static Object resolve(Symbol sym) {</a>
<span class="sourceLineNo">7341</span><a id="line.7341">        return resolveIn(currentNS(), sym, false);</a>
<span class="sourceLineNo">7342</span><a id="line.7342">}</a>
<span class="sourceLineNo">7343</span><a id="line.7343"></a>
<span class="sourceLineNo">7344</span><a id="line.7344">static Namespace namespaceFor(Symbol sym){</a>
<span class="sourceLineNo">7345</span><a id="line.7345">        return namespaceFor(currentNS(), sym);</a>
<span class="sourceLineNo">7346</span><a id="line.7346">}</a>
<span class="sourceLineNo">7347</span><a id="line.7347"></a>
<span class="sourceLineNo">7348</span><a id="line.7348">static Namespace namespaceFor(Namespace inns, Symbol sym){</a>
<span class="sourceLineNo">7349</span><a id="line.7349">        //note, presumes non-nil sym.ns</a>
<span class="sourceLineNo">7350</span><a id="line.7350">        // first check against currentNS' aliases...</a>
<span class="sourceLineNo">7351</span><a id="line.7351">        Symbol nsSym = Symbol.intern(sym.ns);</a>
<span class="sourceLineNo">7352</span><a id="line.7352">        Namespace ns = inns.lookupAlias(nsSym);</a>
<span class="sourceLineNo">7353</span><a id="line.7353">        if(ns == null)</a>
<span class="sourceLineNo">7354</span><a id="line.7354">                {</a>
<span class="sourceLineNo">7355</span><a id="line.7355">                // ...otherwise check the Namespaces map.</a>
<span class="sourceLineNo">7356</span><a id="line.7356">                ns = Namespace.find(nsSym);</a>
<span class="sourceLineNo">7357</span><a id="line.7357">                }</a>
<span class="sourceLineNo">7358</span><a id="line.7358">        return ns;</a>
<span class="sourceLineNo">7359</span><a id="line.7359">}</a>
<span class="sourceLineNo">7360</span><a id="line.7360"></a>
<span class="sourceLineNo">7361</span><a id="line.7361">static public Object resolveIn(Namespace n, Symbol sym, boolean allowPrivate) {</a>
<span class="sourceLineNo">7362</span><a id="line.7362">        //note - ns-qualified vars must already exist</a>
<span class="sourceLineNo">7363</span><a id="line.7363">        if(sym.ns != null)</a>
<span class="sourceLineNo">7364</span><a id="line.7364">                {</a>
<span class="sourceLineNo">7365</span><a id="line.7365">                Namespace ns = namespaceFor(n, sym);</a>
<span class="sourceLineNo">7366</span><a id="line.7366">                if(ns == null)</a>
<span class="sourceLineNo">7367</span><a id="line.7367">                        throw Util.runtimeException("No such namespace: " + sym.ns);</a>
<span class="sourceLineNo">7368</span><a id="line.7368"></a>
<span class="sourceLineNo">7369</span><a id="line.7369">                Var v = ns.findInternedVar(Symbol.intern(sym.name));</a>
<span class="sourceLineNo">7370</span><a id="line.7370">                if(v == null)</a>
<span class="sourceLineNo">7371</span><a id="line.7371">                        throw Util.runtimeException("No such var: " + sym);</a>
<span class="sourceLineNo">7372</span><a id="line.7372">                else if(v.ns != currentNS() &amp;&amp; !v.isPublic() &amp;&amp; !allowPrivate)</a>
<span class="sourceLineNo">7373</span><a id="line.7373">                        throw new IllegalStateException("var: " + sym + " is not public");</a>
<span class="sourceLineNo">7374</span><a id="line.7374">                return v;</a>
<span class="sourceLineNo">7375</span><a id="line.7375">                }</a>
<span class="sourceLineNo">7376</span><a id="line.7376">        else if(sym.name.indexOf('.') &gt; 0 || sym.name.charAt(0) == '[')</a>
<span class="sourceLineNo">7377</span><a id="line.7377">                {</a>
<span class="sourceLineNo">7378</span><a id="line.7378">                return RT.classForName(sym.name);</a>
<span class="sourceLineNo">7379</span><a id="line.7379">                }</a>
<span class="sourceLineNo">7380</span><a id="line.7380">        else if(sym.equals(NS))</a>
<span class="sourceLineNo">7381</span><a id="line.7381">                        return RT.NS_VAR;</a>
<span class="sourceLineNo">7382</span><a id="line.7382">        else if(sym.equals(IN_NS))</a>
<span class="sourceLineNo">7383</span><a id="line.7383">                        return RT.IN_NS_VAR;</a>
<span class="sourceLineNo">7384</span><a id="line.7384">        else</a>
<span class="sourceLineNo">7385</span><a id="line.7385">                {</a>
<span class="sourceLineNo">7386</span><a id="line.7386">                if(Util.equals(sym, COMPILE_STUB_SYM.get()))</a>
<span class="sourceLineNo">7387</span><a id="line.7387">                        return COMPILE_STUB_CLASS.get();</a>
<span class="sourceLineNo">7388</span><a id="line.7388">                Object o = n.getMapping(sym);</a>
<span class="sourceLineNo">7389</span><a id="line.7389">                if(o == null)</a>
<span class="sourceLineNo">7390</span><a id="line.7390">                        {</a>
<span class="sourceLineNo">7391</span><a id="line.7391">                        if(RT.booleanCast(RT.ALLOW_UNRESOLVED_VARS.deref()))</a>
<span class="sourceLineNo">7392</span><a id="line.7392">                                {</a>
<span class="sourceLineNo">7393</span><a id="line.7393">                                return sym;</a>
<span class="sourceLineNo">7394</span><a id="line.7394">                                }</a>
<span class="sourceLineNo">7395</span><a id="line.7395">                        else</a>
<span class="sourceLineNo">7396</span><a id="line.7396">                                {</a>
<span class="sourceLineNo">7397</span><a id="line.7397">                                throw Util.runtimeException("Unable to resolve symbol: " + sym + " in this context");</a>
<span class="sourceLineNo">7398</span><a id="line.7398">                                }</a>
<span class="sourceLineNo">7399</span><a id="line.7399">                        }</a>
<span class="sourceLineNo">7400</span><a id="line.7400">                return o;</a>
<span class="sourceLineNo">7401</span><a id="line.7401">                }</a>
<span class="sourceLineNo">7402</span><a id="line.7402">}</a>
<span class="sourceLineNo">7403</span><a id="line.7403"></a>
<span class="sourceLineNo">7404</span><a id="line.7404"></a>
<span class="sourceLineNo">7405</span><a id="line.7405">static public Object maybeResolveIn(Namespace n, Symbol sym) {</a>
<span class="sourceLineNo">7406</span><a id="line.7406">        //note - ns-qualified vars must already exist</a>
<span class="sourceLineNo">7407</span><a id="line.7407">        if(sym.ns != null)</a>
<span class="sourceLineNo">7408</span><a id="line.7408">                {</a>
<span class="sourceLineNo">7409</span><a id="line.7409">                Namespace ns = namespaceFor(n, sym);</a>
<span class="sourceLineNo">7410</span><a id="line.7410">                if(ns == null)</a>
<span class="sourceLineNo">7411</span><a id="line.7411">                        return null;</a>
<span class="sourceLineNo">7412</span><a id="line.7412">                Var v = ns.findInternedVar(Symbol.intern(sym.name));</a>
<span class="sourceLineNo">7413</span><a id="line.7413">                if(v == null)</a>
<span class="sourceLineNo">7414</span><a id="line.7414">                        return null;</a>
<span class="sourceLineNo">7415</span><a id="line.7415">                return v;</a>
<span class="sourceLineNo">7416</span><a id="line.7416">                }</a>
<span class="sourceLineNo">7417</span><a id="line.7417">        else if(sym.name.indexOf('.') &gt; 0 &amp;&amp; !sym.name.endsWith(".") </a>
<span class="sourceLineNo">7418</span><a id="line.7418">                        || sym.name.charAt(0) == '[')</a>
<span class="sourceLineNo">7419</span><a id="line.7419">                {</a>
<span class="sourceLineNo">7420</span><a id="line.7420">                try {</a>
<span class="sourceLineNo">7421</span><a id="line.7421">                        return RT.classForName(sym.name);</a>
<span class="sourceLineNo">7422</span><a id="line.7422">                } catch (Exception e) {</a>
<span class="sourceLineNo">7423</span><a id="line.7423">                        if (e instanceof ClassNotFoundException)</a>
<span class="sourceLineNo">7424</span><a id="line.7424">                                return null;</a>
<span class="sourceLineNo">7425</span><a id="line.7425">                        else</a>
<span class="sourceLineNo">7426</span><a id="line.7426">                                return Util.sneakyThrow(e);</a>
<span class="sourceLineNo">7427</span><a id="line.7427">                        }</a>
<span class="sourceLineNo">7428</span><a id="line.7428">                }</a>
<span class="sourceLineNo">7429</span><a id="line.7429">        else if(sym.equals(NS))</a>
<span class="sourceLineNo">7430</span><a id="line.7430">                        return RT.NS_VAR;</a>
<span class="sourceLineNo">7431</span><a id="line.7431">                else if(sym.equals(IN_NS))</a>
<span class="sourceLineNo">7432</span><a id="line.7432">                                return RT.IN_NS_VAR;</a>
<span class="sourceLineNo">7433</span><a id="line.7433">                        else</a>
<span class="sourceLineNo">7434</span><a id="line.7434">                                {</a>
<span class="sourceLineNo">7435</span><a id="line.7435">                                Object o = n.getMapping(sym);</a>
<span class="sourceLineNo">7436</span><a id="line.7436">                                return o;</a>
<span class="sourceLineNo">7437</span><a id="line.7437">                                }</a>
<span class="sourceLineNo">7438</span><a id="line.7438">}</a>
<span class="sourceLineNo">7439</span><a id="line.7439"></a>
<span class="sourceLineNo">7440</span><a id="line.7440"></a>
<span class="sourceLineNo">7441</span><a id="line.7441">static Var lookupVar(Symbol sym, boolean internNew, boolean registerMacro) {</a>
<span class="sourceLineNo">7442</span><a id="line.7442">        Var var = null;</a>
<span class="sourceLineNo">7443</span><a id="line.7443"></a>
<span class="sourceLineNo">7444</span><a id="line.7444">        //note - ns-qualified vars in other namespaces must already exist</a>
<span class="sourceLineNo">7445</span><a id="line.7445">        if(sym.ns != null)</a>
<span class="sourceLineNo">7446</span><a id="line.7446">                {</a>
<span class="sourceLineNo">7447</span><a id="line.7447">                Namespace ns = namespaceFor(sym);</a>
<span class="sourceLineNo">7448</span><a id="line.7448">                if(ns == null)</a>
<span class="sourceLineNo">7449</span><a id="line.7449">                        return null;</a>
<span class="sourceLineNo">7450</span><a id="line.7450">                //throw Util.runtimeException("No such namespace: " + sym.ns);</a>
<span class="sourceLineNo">7451</span><a id="line.7451">                Symbol name = Symbol.intern(sym.name);</a>
<span class="sourceLineNo">7452</span><a id="line.7452">                if(internNew &amp;&amp; ns == currentNS())</a>
<span class="sourceLineNo">7453</span><a id="line.7453">                        var = currentNS().intern(name);</a>
<span class="sourceLineNo">7454</span><a id="line.7454">                else</a>
<span class="sourceLineNo">7455</span><a id="line.7455">                        var = ns.findInternedVar(name);</a>
<span class="sourceLineNo">7456</span><a id="line.7456">                }</a>
<span class="sourceLineNo">7457</span><a id="line.7457">        else if(sym.equals(NS))</a>
<span class="sourceLineNo">7458</span><a id="line.7458">                var = RT.NS_VAR;</a>
<span class="sourceLineNo">7459</span><a id="line.7459">        else if(sym.equals(IN_NS))</a>
<span class="sourceLineNo">7460</span><a id="line.7460">                        var = RT.IN_NS_VAR;</a>
<span class="sourceLineNo">7461</span><a id="line.7461">                else</a>
<span class="sourceLineNo">7462</span><a id="line.7462">                        {</a>
<span class="sourceLineNo">7463</span><a id="line.7463">                        //is it mapped?</a>
<span class="sourceLineNo">7464</span><a id="line.7464">                        Object o = currentNS().getMapping(sym);</a>
<span class="sourceLineNo">7465</span><a id="line.7465">                        if(o == null)</a>
<span class="sourceLineNo">7466</span><a id="line.7466">                                {</a>
<span class="sourceLineNo">7467</span><a id="line.7467">                                //introduce a new var in the current ns</a>
<span class="sourceLineNo">7468</span><a id="line.7468">                                if(internNew)</a>
<span class="sourceLineNo">7469</span><a id="line.7469">                                        var = currentNS().intern(Symbol.intern(sym.name));</a>
<span class="sourceLineNo">7470</span><a id="line.7470">                                        }</a>
<span class="sourceLineNo">7471</span><a id="line.7471">                        else if(o instanceof Var)</a>
<span class="sourceLineNo">7472</span><a id="line.7472">                                {</a>
<span class="sourceLineNo">7473</span><a id="line.7473">                                var = (Var) o;</a>
<span class="sourceLineNo">7474</span><a id="line.7474">                                }</a>
<span class="sourceLineNo">7475</span><a id="line.7475">                        else</a>
<span class="sourceLineNo">7476</span><a id="line.7476">                                {</a>
<span class="sourceLineNo">7477</span><a id="line.7477">                                throw Util.runtimeException("Expecting var, but " + sym + " is mapped to " + o);</a>
<span class="sourceLineNo">7478</span><a id="line.7478">                                }</a>
<span class="sourceLineNo">7479</span><a id="line.7479">                        }</a>
<span class="sourceLineNo">7480</span><a id="line.7480">        if(var != null &amp;&amp; (!var.isMacro() || registerMacro))</a>
<span class="sourceLineNo">7481</span><a id="line.7481">                registerVar(var);</a>
<span class="sourceLineNo">7482</span><a id="line.7482">        return var;</a>
<span class="sourceLineNo">7483</span><a id="line.7483">}</a>
<span class="sourceLineNo">7484</span><a id="line.7484">static Var lookupVar(Symbol sym, boolean internNew) {</a>
<span class="sourceLineNo">7485</span><a id="line.7485">    return lookupVar(sym, internNew, true);</a>
<span class="sourceLineNo">7486</span><a id="line.7486">}</a>
<span class="sourceLineNo">7487</span><a id="line.7487"></a>
<span class="sourceLineNo">7488</span><a id="line.7488">private static void registerVar(Var var) {</a>
<span class="sourceLineNo">7489</span><a id="line.7489">        if(!VARS.isBound())</a>
<span class="sourceLineNo">7490</span><a id="line.7490">                return;</a>
<span class="sourceLineNo">7491</span><a id="line.7491">        IPersistentMap varsMap = (IPersistentMap) VARS.deref();</a>
<span class="sourceLineNo">7492</span><a id="line.7492">        Object id = RT.get(varsMap, var);</a>
<span class="sourceLineNo">7493</span><a id="line.7493">        if(id == null)</a>
<span class="sourceLineNo">7494</span><a id="line.7494">                {</a>
<span class="sourceLineNo">7495</span><a id="line.7495">                VARS.set(RT.assoc(varsMap, var, registerConstant(var)));</a>
<span class="sourceLineNo">7496</span><a id="line.7496">                }</a>
<span class="sourceLineNo">7497</span><a id="line.7497">//      if(varsMap != null &amp;&amp; RT.get(varsMap, var) == null)</a>
<span class="sourceLineNo">7498</span><a id="line.7498">//              VARS.set(RT.assoc(varsMap, var, var));</a>
<span class="sourceLineNo">7499</span><a id="line.7499">}</a>
<span class="sourceLineNo">7500</span><a id="line.7500"></a>
<span class="sourceLineNo">7501</span><a id="line.7501">static Namespace currentNS(){</a>
<span class="sourceLineNo">7502</span><a id="line.7502">        return (Namespace) RT.CURRENT_NS.deref();</a>
<span class="sourceLineNo">7503</span><a id="line.7503">}</a>
<span class="sourceLineNo">7504</span><a id="line.7504"></a>
<span class="sourceLineNo">7505</span><a id="line.7505">static void closeOver(LocalBinding b, ObjMethod method){</a>
<span class="sourceLineNo">7506</span><a id="line.7506">        if(b != null &amp;&amp; method != null)</a>
<span class="sourceLineNo">7507</span><a id="line.7507">                {</a>
<span class="sourceLineNo">7508</span><a id="line.7508">        LocalBinding lb = (LocalBinding) RT.get(method.locals, b);</a>
<span class="sourceLineNo">7509</span><a id="line.7509">                if(lb == null)</a>
<span class="sourceLineNo">7510</span><a id="line.7510">                        {</a>
<span class="sourceLineNo">7511</span><a id="line.7511">                        method.objx.closes = (IPersistentMap) RT.assoc(method.objx.closes, b, b);</a>
<span class="sourceLineNo">7512</span><a id="line.7512">                        closeOver(b, method.parent);</a>
<span class="sourceLineNo">7513</span><a id="line.7513">                        }</a>
<span class="sourceLineNo">7514</span><a id="line.7514">                else {</a>
<span class="sourceLineNo">7515</span><a id="line.7515">            if(lb.idx == 0)</a>
<span class="sourceLineNo">7516</span><a id="line.7516">                method.usesThis = true;</a>
<span class="sourceLineNo">7517</span><a id="line.7517">            if(IN_CATCH_FINALLY.deref() != null)</a>
<span class="sourceLineNo">7518</span><a id="line.7518">                {</a>
<span class="sourceLineNo">7519</span><a id="line.7519">                method.localsUsedInCatchFinally = (PersistentHashSet) method.localsUsedInCatchFinally.cons(b.idx);</a>
<span class="sourceLineNo">7520</span><a id="line.7520">                }</a>
<span class="sourceLineNo">7521</span><a id="line.7521">            }</a>
<span class="sourceLineNo">7522</span><a id="line.7522">                }</a>
<span class="sourceLineNo">7523</span><a id="line.7523">}</a>
<span class="sourceLineNo">7524</span><a id="line.7524"></a>
<span class="sourceLineNo">7525</span><a id="line.7525"></a>
<span class="sourceLineNo">7526</span><a id="line.7526">static LocalBinding referenceLocal(Symbol sym) {</a>
<span class="sourceLineNo">7527</span><a id="line.7527">        if(!LOCAL_ENV.isBound())</a>
<span class="sourceLineNo">7528</span><a id="line.7528">                return null;</a>
<span class="sourceLineNo">7529</span><a id="line.7529">        LocalBinding b = (LocalBinding) RT.get(LOCAL_ENV.deref(), sym);</a>
<span class="sourceLineNo">7530</span><a id="line.7530">        if(b != null)</a>
<span class="sourceLineNo">7531</span><a id="line.7531">                {</a>
<span class="sourceLineNo">7532</span><a id="line.7532">                ObjMethod method = (ObjMethod) METHOD.deref();</a>
<span class="sourceLineNo">7533</span><a id="line.7533">                if(b.idx == 0)</a>
<span class="sourceLineNo">7534</span><a id="line.7534">                        method.usesThis = true;</a>
<span class="sourceLineNo">7535</span><a id="line.7535">                closeOver(b, method);</a>
<span class="sourceLineNo">7536</span><a id="line.7536">                }</a>
<span class="sourceLineNo">7537</span><a id="line.7537">        return b;</a>
<span class="sourceLineNo">7538</span><a id="line.7538">}</a>
<span class="sourceLineNo">7539</span><a id="line.7539"></a>
<span class="sourceLineNo">7540</span><a id="line.7540">private static Symbol tagOf(Object o){</a>
<span class="sourceLineNo">7541</span><a id="line.7541">        Object tag = RT.get(RT.meta(o), RT.TAG_KEY);</a>
<span class="sourceLineNo">7542</span><a id="line.7542">        if(tag instanceof Symbol)</a>
<span class="sourceLineNo">7543</span><a id="line.7543">                return (Symbol) tag;</a>
<span class="sourceLineNo">7544</span><a id="line.7544">        else if(tag instanceof String)</a>
<span class="sourceLineNo">7545</span><a id="line.7545">                return Symbol.intern(null, (String) tag);</a>
<span class="sourceLineNo">7546</span><a id="line.7546">        return null;</a>
<span class="sourceLineNo">7547</span><a id="line.7547">}</a>
<span class="sourceLineNo">7548</span><a id="line.7548"></a>
<span class="sourceLineNo">7549</span><a id="line.7549">public static Object loadFile(String file) throws IOException{</a>
<span class="sourceLineNo">7550</span><a id="line.7550">//      File fo = new File(file);</a>
<span class="sourceLineNo">7551</span><a id="line.7551">//      if(!fo.exists())</a>
<span class="sourceLineNo">7552</span><a id="line.7552">//              return null;</a>
<span class="sourceLineNo">7553</span><a id="line.7553"></a>
<span class="sourceLineNo">7554</span><a id="line.7554">        FileInputStream f = new FileInputStream(file);</a>
<span class="sourceLineNo">7555</span><a id="line.7555">        try</a>
<span class="sourceLineNo">7556</span><a id="line.7556">                {</a>
<span class="sourceLineNo">7557</span><a id="line.7557">                return load(new InputStreamReader(f, RT.UTF8), new File(file).getAbsolutePath(), (new File(file)).getName());</a>
<span class="sourceLineNo">7558</span><a id="line.7558">                }</a>
<span class="sourceLineNo">7559</span><a id="line.7559">        finally</a>
<span class="sourceLineNo">7560</span><a id="line.7560">                {</a>
<span class="sourceLineNo">7561</span><a id="line.7561">                f.close();</a>
<span class="sourceLineNo">7562</span><a id="line.7562">                }</a>
<span class="sourceLineNo">7563</span><a id="line.7563">}</a>
<span class="sourceLineNo">7564</span><a id="line.7564"></a>
<span class="sourceLineNo">7565</span><a id="line.7565">public static Object load(Reader rdr) {</a>
<span class="sourceLineNo">7566</span><a id="line.7566">        return load(rdr, null, "NO_SOURCE_FILE");</a>
<span class="sourceLineNo">7567</span><a id="line.7567">}</a>
<span class="sourceLineNo">7568</span><a id="line.7568"></a>
<span class="sourceLineNo">7569</span><a id="line.7569">static void consumeWhitespaces(LineNumberingPushbackReader pushbackReader) {</a>
<span class="sourceLineNo">7570</span><a id="line.7570">        int ch = LispReader.read1(pushbackReader);</a>
<span class="sourceLineNo">7571</span><a id="line.7571">        while(LispReader.isWhitespace(ch))</a>
<span class="sourceLineNo">7572</span><a id="line.7572">                ch = LispReader.read1(pushbackReader);</a>
<span class="sourceLineNo">7573</span><a id="line.7573">        LispReader.unread(pushbackReader, ch);</a>
<span class="sourceLineNo">7574</span><a id="line.7574">}</a>
<span class="sourceLineNo">7575</span><a id="line.7575"></a>
<span class="sourceLineNo">7576</span><a id="line.7576">private static final Object OPTS_COND_ALLOWED = RT.mapUniqueKeys(LispReader.OPT_READ_COND, LispReader.COND_ALLOW);</a>
<span class="sourceLineNo">7577</span><a id="line.7577">private static Object readerOpts(String sourceName) {</a>
<span class="sourceLineNo">7578</span><a id="line.7578">    if(sourceName != null &amp;&amp; sourceName.endsWith(".cljc"))</a>
<span class="sourceLineNo">7579</span><a id="line.7579">        return OPTS_COND_ALLOWED;</a>
<span class="sourceLineNo">7580</span><a id="line.7580">    else</a>
<span class="sourceLineNo">7581</span><a id="line.7581">        return null;</a>
<span class="sourceLineNo">7582</span><a id="line.7582">}</a>
<span class="sourceLineNo">7583</span><a id="line.7583"></a>
<span class="sourceLineNo">7584</span><a id="line.7584">public static Object load(Reader rdr, String sourcePath, String sourceName) {</a>
<span class="sourceLineNo">7585</span><a id="line.7585">        Object EOF = new Object();</a>
<span class="sourceLineNo">7586</span><a id="line.7586">        Object ret = null;</a>
<span class="sourceLineNo">7587</span><a id="line.7587">        LineNumberingPushbackReader pushbackReader =</a>
<span class="sourceLineNo">7588</span><a id="line.7588">                        (rdr instanceof LineNumberingPushbackReader) ? (LineNumberingPushbackReader) rdr :</a>
<span class="sourceLineNo">7589</span><a id="line.7589">                        new LineNumberingPushbackReader(rdr);</a>
<span class="sourceLineNo">7590</span><a id="line.7590">        consumeWhitespaces(pushbackReader);</a>
<span class="sourceLineNo">7591</span><a id="line.7591">        Var.pushThreadBindings(</a>
<span class="sourceLineNo">7592</span><a id="line.7592">                        RT.mapUniqueKeys(LOADER, RT.makeClassLoader(),</a>
<span class="sourceLineNo">7593</span><a id="line.7593">                               SOURCE_PATH, sourcePath,</a>
<span class="sourceLineNo">7594</span><a id="line.7594">                               SOURCE, sourceName,</a>
<span class="sourceLineNo">7595</span><a id="line.7595">                               METHOD, null,</a>
<span class="sourceLineNo">7596</span><a id="line.7596">                               LOCAL_ENV, null,</a>
<span class="sourceLineNo">7597</span><a id="line.7597">                                        LOOP_LOCALS, null,</a>
<span class="sourceLineNo">7598</span><a id="line.7598">                                        NEXT_LOCAL_NUM, 0,</a>
<span class="sourceLineNo">7599</span><a id="line.7599">                                        RT.READEVAL, RT.T,</a>
<span class="sourceLineNo">7600</span><a id="line.7600">                               RT.CURRENT_NS, RT.CURRENT_NS.deref(),</a>
<span class="sourceLineNo">7601</span><a id="line.7601">                               LINE_BEFORE, pushbackReader.getLineNumber(),</a>
<span class="sourceLineNo">7602</span><a id="line.7602">                               COLUMN_BEFORE, pushbackReader.getColumnNumber(),</a>
<span class="sourceLineNo">7603</span><a id="line.7603">                               LINE_AFTER, pushbackReader.getLineNumber(),</a>
<span class="sourceLineNo">7604</span><a id="line.7604">                               COLUMN_AFTER, pushbackReader.getColumnNumber()</a>
<span class="sourceLineNo">7605</span><a id="line.7605">                               ,RT.UNCHECKED_MATH, RT.UNCHECKED_MATH.deref()</a>
<span class="sourceLineNo">7606</span><a id="line.7606">                                        ,RT.WARN_ON_REFLECTION, RT.WARN_ON_REFLECTION.deref()</a>
<span class="sourceLineNo">7607</span><a id="line.7607">                               ,RT.DATA_READERS, RT.DATA_READERS.deref()</a>
<span class="sourceLineNo">7608</span><a id="line.7608">                        ));</a>
<span class="sourceLineNo">7609</span><a id="line.7609"></a>
<span class="sourceLineNo">7610</span><a id="line.7610">        Object readerOpts = readerOpts(sourceName);</a>
<span class="sourceLineNo">7611</span><a id="line.7611">        try</a>
<span class="sourceLineNo">7612</span><a id="line.7612">                {</a>
<span class="sourceLineNo">7613</span><a id="line.7613">                for(Object r = LispReader.read(pushbackReader, false, EOF, false, readerOpts); r != EOF;</a>
<span class="sourceLineNo">7614</span><a id="line.7614">                        r = LispReader.read(pushbackReader, false, EOF, false, readerOpts))</a>
<span class="sourceLineNo">7615</span><a id="line.7615">                        {</a>
<span class="sourceLineNo">7616</span><a id="line.7616">                        consumeWhitespaces(pushbackReader);</a>
<span class="sourceLineNo">7617</span><a id="line.7617">                        LINE_AFTER.set(pushbackReader.getLineNumber());</a>
<span class="sourceLineNo">7618</span><a id="line.7618">                        COLUMN_AFTER.set(pushbackReader.getColumnNumber());</a>
<span class="sourceLineNo">7619</span><a id="line.7619">                        ret = eval(r,false);</a>
<span class="sourceLineNo">7620</span><a id="line.7620">                        LINE_BEFORE.set(pushbackReader.getLineNumber());</a>
<span class="sourceLineNo">7621</span><a id="line.7621">                        COLUMN_BEFORE.set(pushbackReader.getColumnNumber());</a>
<span class="sourceLineNo">7622</span><a id="line.7622">                        }</a>
<span class="sourceLineNo">7623</span><a id="line.7623">                }</a>
<span class="sourceLineNo">7624</span><a id="line.7624">        catch(LispReader.ReaderException e)</a>
<span class="sourceLineNo">7625</span><a id="line.7625">                {</a>
<span class="sourceLineNo">7626</span><a id="line.7626">                throw new CompilerException(sourcePath, e.line, e.column, null, CompilerException.PHASE_READ, e.getCause());</a>
<span class="sourceLineNo">7627</span><a id="line.7627">                }</a>
<span class="sourceLineNo">7628</span><a id="line.7628">        catch(Throwable e)</a>
<span class="sourceLineNo">7629</span><a id="line.7629">                {</a>
<span class="sourceLineNo">7630</span><a id="line.7630">                if(!(e instanceof CompilerException))</a>
<span class="sourceLineNo">7631</span><a id="line.7631">                        throw new CompilerException(sourcePath, (Integer) LINE_BEFORE.deref(), (Integer) COLUMN_BEFORE.deref(), e);</a>
<span class="sourceLineNo">7632</span><a id="line.7632">                else</a>
<span class="sourceLineNo">7633</span><a id="line.7633">                        throw (CompilerException) e;</a>
<span class="sourceLineNo">7634</span><a id="line.7634">                }</a>
<span class="sourceLineNo">7635</span><a id="line.7635">        finally</a>
<span class="sourceLineNo">7636</span><a id="line.7636">                {</a>
<span class="sourceLineNo">7637</span><a id="line.7637">                Var.popThreadBindings();</a>
<span class="sourceLineNo">7638</span><a id="line.7638">                }</a>
<span class="sourceLineNo">7639</span><a id="line.7639">        return ret;</a>
<span class="sourceLineNo">7640</span><a id="line.7640">}</a>
<span class="sourceLineNo">7641</span><a id="line.7641"></a>
<span class="sourceLineNo">7642</span><a id="line.7642">static public void writeClassFile(String internalName, byte[] bytecode) throws IOException{</a>
<span class="sourceLineNo">7643</span><a id="line.7643">        String genPath = (String) COMPILE_PATH.deref();</a>
<span class="sourceLineNo">7644</span><a id="line.7644">        if(genPath == null)</a>
<span class="sourceLineNo">7645</span><a id="line.7645">                throw Util.runtimeException("*compile-path* not set");</a>
<span class="sourceLineNo">7646</span><a id="line.7646">        String[] dirs = internalName.split("/");</a>
<span class="sourceLineNo">7647</span><a id="line.7647">        String p = genPath;</a>
<span class="sourceLineNo">7648</span><a id="line.7648">        for(int i = 0; i &lt; dirs.length - 1; i++)</a>
<span class="sourceLineNo">7649</span><a id="line.7649">                {</a>
<span class="sourceLineNo">7650</span><a id="line.7650">                p += File.separator + dirs[i];</a>
<span class="sourceLineNo">7651</span><a id="line.7651">                (new File(p)).mkdir();</a>
<span class="sourceLineNo">7652</span><a id="line.7652">                }</a>
<span class="sourceLineNo">7653</span><a id="line.7653">        String path = genPath + File.separator + internalName + ".class";</a>
<span class="sourceLineNo">7654</span><a id="line.7654">        File cf = new File(path);</a>
<span class="sourceLineNo">7655</span><a id="line.7655">        cf.createNewFile();</a>
<span class="sourceLineNo">7656</span><a id="line.7656">        FileOutputStream cfs = new FileOutputStream(cf);</a>
<span class="sourceLineNo">7657</span><a id="line.7657">        try</a>
<span class="sourceLineNo">7658</span><a id="line.7658">                {</a>
<span class="sourceLineNo">7659</span><a id="line.7659">                cfs.write(bytecode);</a>
<span class="sourceLineNo">7660</span><a id="line.7660">                cfs.flush();</a>
<span class="sourceLineNo">7661</span><a id="line.7661">                }</a>
<span class="sourceLineNo">7662</span><a id="line.7662">        finally</a>
<span class="sourceLineNo">7663</span><a id="line.7663">                {</a>
<span class="sourceLineNo">7664</span><a id="line.7664">                cfs.close();</a>
<span class="sourceLineNo">7665</span><a id="line.7665">                }</a>
<span class="sourceLineNo">7666</span><a id="line.7666">}</a>
<span class="sourceLineNo">7667</span><a id="line.7667"></a>
<span class="sourceLineNo">7668</span><a id="line.7668">public static void pushNS(){</a>
<span class="sourceLineNo">7669</span><a id="line.7669">        Var.pushThreadBindings(PersistentHashMap.create(Var.intern(Symbol.intern("clojure.core"),</a>
<span class="sourceLineNo">7670</span><a id="line.7670">                                                                   Symbol.intern("*ns*")).setDynamic(), null));</a>
<span class="sourceLineNo">7671</span><a id="line.7671">}</a>
<span class="sourceLineNo">7672</span><a id="line.7672"></a>
<span class="sourceLineNo">7673</span><a id="line.7673">public static void pushNSandLoader(ClassLoader loader){</a>
<span class="sourceLineNo">7674</span><a id="line.7674">        Var.pushThreadBindings(RT.map(Var.intern(Symbol.intern("clojure.core"),</a>
<span class="sourceLineNo">7675</span><a id="line.7675">                                                 Symbol.intern("*ns*")).setDynamic(),</a>
<span class="sourceLineNo">7676</span><a id="line.7676">                                      null,</a>
<span class="sourceLineNo">7677</span><a id="line.7677">                                      RT.FN_LOADER_VAR, loader,</a>
<span class="sourceLineNo">7678</span><a id="line.7678">                                      RT.READEVAL, RT.T</a>
<span class="sourceLineNo">7679</span><a id="line.7679">                                      ));</a>
<span class="sourceLineNo">7680</span><a id="line.7680">}</a>
<span class="sourceLineNo">7681</span><a id="line.7681"></a>
<span class="sourceLineNo">7682</span><a id="line.7682">public static ILookupThunk getLookupThunk(Object target, Keyword k){</a>
<span class="sourceLineNo">7683</span><a id="line.7683">        return null;  //To change body of created methods use File | Settings | File Templates.</a>
<span class="sourceLineNo">7684</span><a id="line.7684">}</a>
<span class="sourceLineNo">7685</span><a id="line.7685"></a>
<span class="sourceLineNo">7686</span><a id="line.7686">static void compile1(GeneratorAdapter gen, ObjExpr objx, Object form) {</a>
<span class="sourceLineNo">7687</span><a id="line.7687">        Object line = lineDeref();</a>
<span class="sourceLineNo">7688</span><a id="line.7688">        Object column = columnDeref();</a>
<span class="sourceLineNo">7689</span><a id="line.7689">        if(RT.meta(form) != null &amp;&amp; RT.meta(form).containsKey(RT.LINE_KEY))</a>
<span class="sourceLineNo">7690</span><a id="line.7690">                line = RT.meta(form).valAt(RT.LINE_KEY);</a>
<span class="sourceLineNo">7691</span><a id="line.7691">        if(RT.meta(form) != null &amp;&amp; RT.meta(form).containsKey(RT.COLUMN_KEY))</a>
<span class="sourceLineNo">7692</span><a id="line.7692">                column = RT.meta(form).valAt(RT.COLUMN_KEY);</a>
<span class="sourceLineNo">7693</span><a id="line.7693">        Var.pushThreadBindings(</a>
<span class="sourceLineNo">7694</span><a id="line.7694">                        RT.map(LINE, line, COLUMN, column</a>
<span class="sourceLineNo">7695</span><a id="line.7695">                               ,LOADER, RT.makeClassLoader()</a>
<span class="sourceLineNo">7696</span><a id="line.7696">                        ));</a>
<span class="sourceLineNo">7697</span><a id="line.7697">        try</a>
<span class="sourceLineNo">7698</span><a id="line.7698">                {</a>
<span class="sourceLineNo">7699</span><a id="line.7699">                form = macroexpand(form);</a>
<span class="sourceLineNo">7700</span><a id="line.7700">                if(form instanceof ISeq &amp;&amp; Util.equals(RT.first(form), DO))</a>
<span class="sourceLineNo">7701</span><a id="line.7701">                        {</a>
<span class="sourceLineNo">7702</span><a id="line.7702">                        for(ISeq s = RT.next(form); s != null; s = RT.next(s))</a>
<span class="sourceLineNo">7703</span><a id="line.7703">                                {</a>
<span class="sourceLineNo">7704</span><a id="line.7704">                                compile1(gen, objx, RT.first(s));</a>
<span class="sourceLineNo">7705</span><a id="line.7705">                                }</a>
<span class="sourceLineNo">7706</span><a id="line.7706">                        }</a>
<span class="sourceLineNo">7707</span><a id="line.7707">                else</a>
<span class="sourceLineNo">7708</span><a id="line.7708">                        {</a>
<span class="sourceLineNo">7709</span><a id="line.7709">                        Expr expr = analyze(C.EVAL, form);</a>
<span class="sourceLineNo">7710</span><a id="line.7710">                        objx.keywords = (IPersistentMap) KEYWORDS.deref();</a>
<span class="sourceLineNo">7711</span><a id="line.7711">                        objx.vars = (IPersistentMap) VARS.deref();</a>
<span class="sourceLineNo">7712</span><a id="line.7712">                        objx.constants = (PersistentVector) CONSTANTS.deref();</a>
<span class="sourceLineNo">7713</span><a id="line.7713">                        expr.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">7714</span><a id="line.7714">                        expr.eval();</a>
<span class="sourceLineNo">7715</span><a id="line.7715">                        }</a>
<span class="sourceLineNo">7716</span><a id="line.7716">                }</a>
<span class="sourceLineNo">7717</span><a id="line.7717">        finally</a>
<span class="sourceLineNo">7718</span><a id="line.7718">                {</a>
<span class="sourceLineNo">7719</span><a id="line.7719">                Var.popThreadBindings();</a>
<span class="sourceLineNo">7720</span><a id="line.7720">                }</a>
<span class="sourceLineNo">7721</span><a id="line.7721">}</a>
<span class="sourceLineNo">7722</span><a id="line.7722"></a>
<span class="sourceLineNo">7723</span><a id="line.7723">public static Object compile(Reader rdr, String sourcePath, String sourceName) throws IOException{</a>
<span class="sourceLineNo">7724</span><a id="line.7724">        if(COMPILE_PATH.deref() == null)</a>
<span class="sourceLineNo">7725</span><a id="line.7725">                throw Util.runtimeException("*compile-path* not set");</a>
<span class="sourceLineNo">7726</span><a id="line.7726"></a>
<span class="sourceLineNo">7727</span><a id="line.7727">        Object EOF = new Object();</a>
<span class="sourceLineNo">7728</span><a id="line.7728">        Object ret = null;</a>
<span class="sourceLineNo">7729</span><a id="line.7729">        LineNumberingPushbackReader pushbackReader =</a>
<span class="sourceLineNo">7730</span><a id="line.7730">                        (rdr instanceof LineNumberingPushbackReader) ? (LineNumberingPushbackReader) rdr :</a>
<span class="sourceLineNo">7731</span><a id="line.7731">                        new LineNumberingPushbackReader(rdr);</a>
<span class="sourceLineNo">7732</span><a id="line.7732">        Var.pushThreadBindings(</a>
<span class="sourceLineNo">7733</span><a id="line.7733">                        RT.mapUniqueKeys(SOURCE_PATH, sourcePath,</a>
<span class="sourceLineNo">7734</span><a id="line.7734">                               SOURCE, sourceName,</a>
<span class="sourceLineNo">7735</span><a id="line.7735">                               METHOD, null,</a>
<span class="sourceLineNo">7736</span><a id="line.7736">                               LOCAL_ENV, null,</a>
<span class="sourceLineNo">7737</span><a id="line.7737">                                        LOOP_LOCALS, null,</a>
<span class="sourceLineNo">7738</span><a id="line.7738">                                        NEXT_LOCAL_NUM, 0,</a>
<span class="sourceLineNo">7739</span><a id="line.7739">                                        RT.READEVAL, RT.T,</a>
<span class="sourceLineNo">7740</span><a id="line.7740">                                        RT.CURRENT_NS, RT.CURRENT_NS.deref(),</a>
<span class="sourceLineNo">7741</span><a id="line.7741">                               LINE_BEFORE, pushbackReader.getLineNumber(),</a>
<span class="sourceLineNo">7742</span><a id="line.7742">                               COLUMN_BEFORE, pushbackReader.getColumnNumber(),</a>
<span class="sourceLineNo">7743</span><a id="line.7743">                               LINE_AFTER, pushbackReader.getLineNumber(),</a>
<span class="sourceLineNo">7744</span><a id="line.7744">                               COLUMN_AFTER, pushbackReader.getColumnNumber(),</a>
<span class="sourceLineNo">7745</span><a id="line.7745">                               CONSTANTS, PersistentVector.EMPTY,</a>
<span class="sourceLineNo">7746</span><a id="line.7746">                               CONSTANT_IDS, new IdentityHashMap(),</a>
<span class="sourceLineNo">7747</span><a id="line.7747">                               KEYWORDS, PersistentHashMap.EMPTY,</a>
<span class="sourceLineNo">7748</span><a id="line.7748">                               VARS, PersistentHashMap.EMPTY</a>
<span class="sourceLineNo">7749</span><a id="line.7749">                                        ,RT.UNCHECKED_MATH, RT.UNCHECKED_MATH.deref()</a>
<span class="sourceLineNo">7750</span><a id="line.7750">                                        ,RT.WARN_ON_REFLECTION, RT.WARN_ON_REFLECTION.deref()</a>
<span class="sourceLineNo">7751</span><a id="line.7751">                                        ,RT.DATA_READERS, RT.DATA_READERS.deref()</a>
<span class="sourceLineNo">7752</span><a id="line.7752">                           //    ,LOADER, RT.makeClassLoader()</a>
<span class="sourceLineNo">7753</span><a id="line.7753">                        ));</a>
<span class="sourceLineNo">7754</span><a id="line.7754"></a>
<span class="sourceLineNo">7755</span><a id="line.7755">        try</a>
<span class="sourceLineNo">7756</span><a id="line.7756">                {</a>
<span class="sourceLineNo">7757</span><a id="line.7757">                //generate loader class</a>
<span class="sourceLineNo">7758</span><a id="line.7758">                ObjExpr objx = new ObjExpr(null);</a>
<span class="sourceLineNo">7759</span><a id="line.7759">                objx.internalName = sourcePath.replace(File.separator, "/").substring(0, sourcePath.lastIndexOf('.'))</a>
<span class="sourceLineNo">7760</span><a id="line.7760">                                  + RT.LOADER_SUFFIX;</a>
<span class="sourceLineNo">7761</span><a id="line.7761"></a>
<span class="sourceLineNo">7762</span><a id="line.7762">                objx.objtype = Type.getObjectType(objx.internalName);</a>
<span class="sourceLineNo">7763</span><a id="line.7763">                ClassWriter cw = classWriter();</a>
<span class="sourceLineNo">7764</span><a id="line.7764">                ClassVisitor cv = cw;</a>
<span class="sourceLineNo">7765</span><a id="line.7765">                cv.visit(V1_8, ACC_PUBLIC + ACC_SUPER, objx.internalName, null, "java/lang/Object", null);</a>
<span class="sourceLineNo">7766</span><a id="line.7766"></a>
<span class="sourceLineNo">7767</span><a id="line.7767">                //static load method</a>
<span class="sourceLineNo">7768</span><a id="line.7768">                GeneratorAdapter gen = new GeneratorAdapter(ACC_PUBLIC + ACC_STATIC,</a>
<span class="sourceLineNo">7769</span><a id="line.7769">                                                            Method.getMethod("void load ()"),</a>
<span class="sourceLineNo">7770</span><a id="line.7770">                                                            null,</a>
<span class="sourceLineNo">7771</span><a id="line.7771">                                                            null,</a>
<span class="sourceLineNo">7772</span><a id="line.7772">                                                            cv);</a>
<span class="sourceLineNo">7773</span><a id="line.7773">                gen.visitCode();</a>
<span class="sourceLineNo">7774</span><a id="line.7774"></a>
<span class="sourceLineNo">7775</span><a id="line.7775">                Object readerOpts = readerOpts(sourceName);</a>
<span class="sourceLineNo">7776</span><a id="line.7776">                for(Object r = LispReader.read(pushbackReader, false, EOF, false, readerOpts); r != EOF;</a>
<span class="sourceLineNo">7777</span><a id="line.7777">                        r = LispReader.read(pushbackReader, false, EOF, false, readerOpts))</a>
<span class="sourceLineNo">7778</span><a id="line.7778">                        {</a>
<span class="sourceLineNo">7779</span><a id="line.7779">                                LINE_AFTER.set(pushbackReader.getLineNumber());</a>
<span class="sourceLineNo">7780</span><a id="line.7780">                                COLUMN_AFTER.set(pushbackReader.getColumnNumber());</a>
<span class="sourceLineNo">7781</span><a id="line.7781">                                compile1(gen, objx, r);</a>
<span class="sourceLineNo">7782</span><a id="line.7782">                                LINE_BEFORE.set(pushbackReader.getLineNumber());</a>
<span class="sourceLineNo">7783</span><a id="line.7783">                                COLUMN_BEFORE.set(pushbackReader.getColumnNumber());</a>
<span class="sourceLineNo">7784</span><a id="line.7784">                        }</a>
<span class="sourceLineNo">7785</span><a id="line.7785">                //end of load</a>
<span class="sourceLineNo">7786</span><a id="line.7786">                gen.returnValue();</a>
<span class="sourceLineNo">7787</span><a id="line.7787">                gen.endMethod();</a>
<span class="sourceLineNo">7788</span><a id="line.7788"></a>
<span class="sourceLineNo">7789</span><a id="line.7789">                //static fields for constants</a>
<span class="sourceLineNo">7790</span><a id="line.7790">                for(int i = 0; i &lt; objx.constants.count(); i++)</a>
<span class="sourceLineNo">7791</span><a id="line.7791">                        {</a>
<span class="sourceLineNo">7792</span><a id="line.7792">            if(objx.usedConstants.contains(i))</a>
<span class="sourceLineNo">7793</span><a id="line.7793">                            cv.visitField(ACC_PUBLIC + ACC_FINAL + ACC_STATIC, objx.constantName(i), objx.constantType(i).getDescriptor(),</a>
<span class="sourceLineNo">7794</span><a id="line.7794">                                      null, null);</a>
<span class="sourceLineNo">7795</span><a id="line.7795">                        }</a>
<span class="sourceLineNo">7796</span><a id="line.7796"></a>
<span class="sourceLineNo">7797</span><a id="line.7797">                final int INITS_PER = 100;</a>
<span class="sourceLineNo">7798</span><a id="line.7798">                int numInits =  objx.constants.count() / INITS_PER;</a>
<span class="sourceLineNo">7799</span><a id="line.7799">                if(objx.constants.count() % INITS_PER != 0)</a>
<span class="sourceLineNo">7800</span><a id="line.7800">                        ++numInits;</a>
<span class="sourceLineNo">7801</span><a id="line.7801"></a>
<span class="sourceLineNo">7802</span><a id="line.7802">                for(int n = 0;n&lt;numInits;n++)</a>
<span class="sourceLineNo">7803</span><a id="line.7803">                        {</a>
<span class="sourceLineNo">7804</span><a id="line.7804">                        GeneratorAdapter clinitgen = new GeneratorAdapter(ACC_PUBLIC + ACC_STATIC,</a>
<span class="sourceLineNo">7805</span><a id="line.7805">                                                                          Method.getMethod("void __init" + n + "()"),</a>
<span class="sourceLineNo">7806</span><a id="line.7806">                                                                          null,</a>
<span class="sourceLineNo">7807</span><a id="line.7807">                                                                          null,</a>
<span class="sourceLineNo">7808</span><a id="line.7808">                                                                          cv);</a>
<span class="sourceLineNo">7809</span><a id="line.7809">                        clinitgen.visitCode();</a>
<span class="sourceLineNo">7810</span><a id="line.7810">                        try</a>
<span class="sourceLineNo">7811</span><a id="line.7811">                                {</a>
<span class="sourceLineNo">7812</span><a id="line.7812">                                Var.pushThreadBindings(RT.map(RT.PRINT_DUP, RT.T));</a>
<span class="sourceLineNo">7813</span><a id="line.7813"></a>
<span class="sourceLineNo">7814</span><a id="line.7814">                                for(int i = n*INITS_PER; i &lt; objx.constants.count() &amp;&amp; i &lt; (n+1)*INITS_PER; i++)</a>
<span class="sourceLineNo">7815</span><a id="line.7815">                                        {</a>
<span class="sourceLineNo">7816</span><a id="line.7816">                    if(objx.usedConstants.contains(i))</a>
<span class="sourceLineNo">7817</span><a id="line.7817">                        {</a>
<span class="sourceLineNo">7818</span><a id="line.7818">                        objx.emitValue(objx.constants.nth(i), clinitgen);</a>
<span class="sourceLineNo">7819</span><a id="line.7819">                        clinitgen.checkCast(objx.constantType(i));</a>
<span class="sourceLineNo">7820</span><a id="line.7820">                        clinitgen.putStatic(objx.objtype, objx.constantName(i), objx.constantType(i));</a>
<span class="sourceLineNo">7821</span><a id="line.7821">                        }</a>
<span class="sourceLineNo">7822</span><a id="line.7822">                                        }</a>
<span class="sourceLineNo">7823</span><a id="line.7823">                                }</a>
<span class="sourceLineNo">7824</span><a id="line.7824">                        finally</a>
<span class="sourceLineNo">7825</span><a id="line.7825">                                {</a>
<span class="sourceLineNo">7826</span><a id="line.7826">                                Var.popThreadBindings();</a>
<span class="sourceLineNo">7827</span><a id="line.7827">                                }</a>
<span class="sourceLineNo">7828</span><a id="line.7828">                        clinitgen.returnValue();</a>
<span class="sourceLineNo">7829</span><a id="line.7829">                        clinitgen.endMethod();</a>
<span class="sourceLineNo">7830</span><a id="line.7830">                        }</a>
<span class="sourceLineNo">7831</span><a id="line.7831"></a>
<span class="sourceLineNo">7832</span><a id="line.7832">                //static init for constants, keywords and vars</a>
<span class="sourceLineNo">7833</span><a id="line.7833">                GeneratorAdapter clinitgen = new GeneratorAdapter(ACC_PUBLIC + ACC_STATIC,</a>
<span class="sourceLineNo">7834</span><a id="line.7834">                                                                  Method.getMethod("void &lt;clinit&gt; ()"),</a>
<span class="sourceLineNo">7835</span><a id="line.7835">                                                                  null,</a>
<span class="sourceLineNo">7836</span><a id="line.7836">                                                                  null,</a>
<span class="sourceLineNo">7837</span><a id="line.7837">                                                                  cv);</a>
<span class="sourceLineNo">7838</span><a id="line.7838">                clinitgen.visitCode();</a>
<span class="sourceLineNo">7839</span><a id="line.7839">                Label startTry = clinitgen.newLabel();</a>
<span class="sourceLineNo">7840</span><a id="line.7840">                Label endTry = clinitgen.newLabel();</a>
<span class="sourceLineNo">7841</span><a id="line.7841">                Label end = clinitgen.newLabel();</a>
<span class="sourceLineNo">7842</span><a id="line.7842">                Label finallyLabel = clinitgen.newLabel();</a>
<span class="sourceLineNo">7843</span><a id="line.7843"></a>
<span class="sourceLineNo">7844</span><a id="line.7844">//              if(objx.constants.count() &gt; 0)</a>
<span class="sourceLineNo">7845</span><a id="line.7845">//                      {</a>
<span class="sourceLineNo">7846</span><a id="line.7846">//                      objx.emitConstants(clinitgen);</a>
<span class="sourceLineNo">7847</span><a id="line.7847">//                      }</a>
<span class="sourceLineNo">7848</span><a id="line.7848">                for(int n = 0;n&lt;numInits;n++)</a>
<span class="sourceLineNo">7849</span><a id="line.7849">                        clinitgen.invokeStatic(objx.objtype, Method.getMethod("void __init" + n + "()"));</a>
<span class="sourceLineNo">7850</span><a id="line.7850"></a>
<span class="sourceLineNo">7851</span><a id="line.7851">                clinitgen.push(objx.internalName.replace('/','.'));</a>
<span class="sourceLineNo">7852</span><a id="line.7852">                clinitgen.invokeStatic(RT_TYPE, Method.getMethod("Class classForName(String)"));</a>
<span class="sourceLineNo">7853</span><a id="line.7853">                clinitgen.invokeVirtual(CLASS_TYPE,Method.getMethod("ClassLoader getClassLoader()"));</a>
<span class="sourceLineNo">7854</span><a id="line.7854">                clinitgen.invokeStatic(Type.getType(Compiler.class), Method.getMethod("void pushNSandLoader(ClassLoader)"));</a>
<span class="sourceLineNo">7855</span><a id="line.7855">                clinitgen.mark(startTry);</a>
<span class="sourceLineNo">7856</span><a id="line.7856">                clinitgen.invokeStatic(objx.objtype, Method.getMethod("void load()"));</a>
<span class="sourceLineNo">7857</span><a id="line.7857">                clinitgen.mark(endTry);</a>
<span class="sourceLineNo">7858</span><a id="line.7858">                clinitgen.invokeStatic(VAR_TYPE, Method.getMethod("void popThreadBindings()"));</a>
<span class="sourceLineNo">7859</span><a id="line.7859">                clinitgen.goTo(end);</a>
<span class="sourceLineNo">7860</span><a id="line.7860"></a>
<span class="sourceLineNo">7861</span><a id="line.7861">                clinitgen.mark(finallyLabel);</a>
<span class="sourceLineNo">7862</span><a id="line.7862">                //exception should be on stack</a>
<span class="sourceLineNo">7863</span><a id="line.7863">                clinitgen.invokeStatic(VAR_TYPE, Method.getMethod("void popThreadBindings()"));</a>
<span class="sourceLineNo">7864</span><a id="line.7864">                clinitgen.throwException();</a>
<span class="sourceLineNo">7865</span><a id="line.7865">                clinitgen.mark(end);</a>
<span class="sourceLineNo">7866</span><a id="line.7866">                clinitgen.visitTryCatchBlock(startTry, endTry, finallyLabel, null);</a>
<span class="sourceLineNo">7867</span><a id="line.7867"></a>
<span class="sourceLineNo">7868</span><a id="line.7868">                //end of static init</a>
<span class="sourceLineNo">7869</span><a id="line.7869">                clinitgen.returnValue();</a>
<span class="sourceLineNo">7870</span><a id="line.7870">                clinitgen.endMethod();</a>
<span class="sourceLineNo">7871</span><a id="line.7871"></a>
<span class="sourceLineNo">7872</span><a id="line.7872">                //end of class</a>
<span class="sourceLineNo">7873</span><a id="line.7873">                cv.visitEnd();</a>
<span class="sourceLineNo">7874</span><a id="line.7874"></a>
<span class="sourceLineNo">7875</span><a id="line.7875">                writeClassFile(objx.internalName, cw.toByteArray());</a>
<span class="sourceLineNo">7876</span><a id="line.7876">                }</a>
<span class="sourceLineNo">7877</span><a id="line.7877">        catch(LispReader.ReaderException e)</a>
<span class="sourceLineNo">7878</span><a id="line.7878">                {</a>
<span class="sourceLineNo">7879</span><a id="line.7879">                throw new CompilerException(sourcePath, e.line, e.column, e.getCause());</a>
<span class="sourceLineNo">7880</span><a id="line.7880">                }</a>
<span class="sourceLineNo">7881</span><a id="line.7881">        finally</a>
<span class="sourceLineNo">7882</span><a id="line.7882">                {</a>
<span class="sourceLineNo">7883</span><a id="line.7883">                Var.popThreadBindings();</a>
<span class="sourceLineNo">7884</span><a id="line.7884">                }</a>
<span class="sourceLineNo">7885</span><a id="line.7885">        return ret;</a>
<span class="sourceLineNo">7886</span><a id="line.7886">}</a>
<span class="sourceLineNo">7887</span><a id="line.7887"></a>
<span class="sourceLineNo">7888</span><a id="line.7888"></a>
<span class="sourceLineNo">7889</span><a id="line.7889">static public class NewInstanceExpr extends ObjExpr{</a>
<span class="sourceLineNo">7890</span><a id="line.7890">        //IPersistentMap optionsMap = PersistentArrayMap.EMPTY;</a>
<span class="sourceLineNo">7891</span><a id="line.7891">        IPersistentCollection methods;</a>
<span class="sourceLineNo">7892</span><a id="line.7892"></a>
<span class="sourceLineNo">7893</span><a id="line.7893">        Map&lt;IPersistentVector,java.lang.reflect.Method&gt; mmap;</a>
<span class="sourceLineNo">7894</span><a id="line.7894">        Map&lt;IPersistentVector,Set&lt;Class&gt;&gt; covariants;</a>
<span class="sourceLineNo">7895</span><a id="line.7895"></a>
<span class="sourceLineNo">7896</span><a id="line.7896">        public NewInstanceExpr(Object tag){</a>
<span class="sourceLineNo">7897</span><a id="line.7897">                super(tag);</a>
<span class="sourceLineNo">7898</span><a id="line.7898">        }</a>
<span class="sourceLineNo">7899</span><a id="line.7899"></a>
<span class="sourceLineNo">7900</span><a id="line.7900">        static class DeftypeParser implements IParser{</a>
<span class="sourceLineNo">7901</span><a id="line.7901">                public Expr parse(C context, final Object frm) {</a>
<span class="sourceLineNo">7902</span><a id="line.7902">                        ISeq rform = (ISeq) frm;</a>
<span class="sourceLineNo">7903</span><a id="line.7903">                        //(deftype* tagname classname [fields] :implements [interfaces] :tag tagname methods*)</a>
<span class="sourceLineNo">7904</span><a id="line.7904">                        rform = RT.next(rform);</a>
<span class="sourceLineNo">7905</span><a id="line.7905">                        String tagname = ((Symbol) rform.first()).getName();</a>
<span class="sourceLineNo">7906</span><a id="line.7906">                        rform = rform.next();</a>
<span class="sourceLineNo">7907</span><a id="line.7907">                        Symbol classname = (Symbol) rform.first();</a>
<span class="sourceLineNo">7908</span><a id="line.7908">                        rform = rform.next();</a>
<span class="sourceLineNo">7909</span><a id="line.7909">                        IPersistentVector fields = (IPersistentVector) rform.first();</a>
<span class="sourceLineNo">7910</span><a id="line.7910">                        rform = rform.next();</a>
<span class="sourceLineNo">7911</span><a id="line.7911">                        IPersistentMap opts = PersistentHashMap.EMPTY;</a>
<span class="sourceLineNo">7912</span><a id="line.7912">                        while(rform != null &amp;&amp; rform.first() instanceof Keyword)</a>
<span class="sourceLineNo">7913</span><a id="line.7913">                                {</a>
<span class="sourceLineNo">7914</span><a id="line.7914">                                opts = opts.assoc(rform.first(), RT.second(rform));</a>
<span class="sourceLineNo">7915</span><a id="line.7915">                                rform = rform.next().next();</a>
<span class="sourceLineNo">7916</span><a id="line.7916">                                }</a>
<span class="sourceLineNo">7917</span><a id="line.7917"></a>
<span class="sourceLineNo">7918</span><a id="line.7918">                        ObjExpr ret = build((IPersistentVector)RT.get(opts,implementsKey,PersistentVector.EMPTY),fields,null,tagname, classname,</a>
<span class="sourceLineNo">7919</span><a id="line.7919">                                     (Symbol) RT.get(opts,RT.TAG_KEY),rform, frm, opts);</a>
<span class="sourceLineNo">7920</span><a id="line.7920">                        return ret;</a>
<span class="sourceLineNo">7921</span><a id="line.7921">                }</a>
<span class="sourceLineNo">7922</span><a id="line.7922">        }</a>
<span class="sourceLineNo">7923</span><a id="line.7923"></a>
<span class="sourceLineNo">7924</span><a id="line.7924">        static class ReifyParser implements IParser{</a>
<span class="sourceLineNo">7925</span><a id="line.7925">        public Expr parse(C context, Object frm) {</a>
<span class="sourceLineNo">7926</span><a id="line.7926">                //(reify this-name? [interfaces] (method-name [args] body)*)</a>
<span class="sourceLineNo">7927</span><a id="line.7927">                ISeq form = (ISeq) frm;</a>
<span class="sourceLineNo">7928</span><a id="line.7928">                ObjMethod enclosingMethod = (ObjMethod) METHOD.deref();</a>
<span class="sourceLineNo">7929</span><a id="line.7929">                String basename = enclosingMethod != null ?</a>
<span class="sourceLineNo">7930</span><a id="line.7930">                                  (trimGenID(enclosingMethod.objx.name) + "$")</a>
<span class="sourceLineNo">7931</span><a id="line.7931">                                 : (munge(currentNS().name.name) + "$");</a>
<span class="sourceLineNo">7932</span><a id="line.7932">                String simpleName = "reify__" + RT.nextID();</a>
<span class="sourceLineNo">7933</span><a id="line.7933">                String classname = basename + simpleName;</a>
<span class="sourceLineNo">7934</span><a id="line.7934"></a>
<span class="sourceLineNo">7935</span><a id="line.7935">                ISeq rform = RT.next(form);</a>
<span class="sourceLineNo">7936</span><a id="line.7936"></a>
<span class="sourceLineNo">7937</span><a id="line.7937">                IPersistentVector interfaces = ((IPersistentVector) RT.first(rform)).cons(Symbol.intern("clojure.lang.IObj"));</a>
<span class="sourceLineNo">7938</span><a id="line.7938"></a>
<span class="sourceLineNo">7939</span><a id="line.7939"></a>
<span class="sourceLineNo">7940</span><a id="line.7940">                rform = RT.next(rform);</a>
<span class="sourceLineNo">7941</span><a id="line.7941"></a>
<span class="sourceLineNo">7942</span><a id="line.7942"></a>
<span class="sourceLineNo">7943</span><a id="line.7943">                ObjExpr ret = build(interfaces, null, null, classname, Symbol.intern(classname), null, rform, frm, null);</a>
<span class="sourceLineNo">7944</span><a id="line.7944">                if(frm instanceof IObj &amp;&amp; ((IObj) frm).meta() != null)</a>
<span class="sourceLineNo">7945</span><a id="line.7945">                        return new MetaExpr(ret, MapExpr</a>
<span class="sourceLineNo">7946</span><a id="line.7946">                                        .parse(context == C.EVAL ? context : C.EXPRESSION, ((IObj) frm).meta()));</a>
<span class="sourceLineNo">7947</span><a id="line.7947">                else</a>
<span class="sourceLineNo">7948</span><a id="line.7948">                        return ret;</a>
<span class="sourceLineNo">7949</span><a id="line.7949">        }</a>
<span class="sourceLineNo">7950</span><a id="line.7950">        }</a>
<span class="sourceLineNo">7951</span><a id="line.7951"></a>
<span class="sourceLineNo">7952</span><a id="line.7952">        static ObjExpr build(IPersistentVector interfaceSyms, IPersistentVector fieldSyms, Symbol thisSym,</a>
<span class="sourceLineNo">7953</span><a id="line.7953">                             String tagName, Symbol className,</a>
<span class="sourceLineNo">7954</span><a id="line.7954">                          Symbol typeTag, ISeq methodForms, Object frm, IPersistentMap opts) {</a>
<span class="sourceLineNo">7955</span><a id="line.7955">                NewInstanceExpr ret = new NewInstanceExpr(null);</a>
<span class="sourceLineNo">7956</span><a id="line.7956"></a>
<span class="sourceLineNo">7957</span><a id="line.7957">                ret.src = frm;</a>
<span class="sourceLineNo">7958</span><a id="line.7958">                ret.name = className.toString();</a>
<span class="sourceLineNo">7959</span><a id="line.7959">                ret.classMeta = RT.meta(className);</a>
<span class="sourceLineNo">7960</span><a id="line.7960">                ret.internalName = ret.name.replace('.', '/');</a>
<span class="sourceLineNo">7961</span><a id="line.7961">                ret.objtype = Type.getObjectType(ret.internalName);</a>
<span class="sourceLineNo">7962</span><a id="line.7962">                ret.opts = opts;</a>
<span class="sourceLineNo">7963</span><a id="line.7963"></a>
<span class="sourceLineNo">7964</span><a id="line.7964">                if(thisSym != null)</a>
<span class="sourceLineNo">7965</span><a id="line.7965">                        ret.thisName = thisSym.name;</a>
<span class="sourceLineNo">7966</span><a id="line.7966"></a>
<span class="sourceLineNo">7967</span><a id="line.7967">                if(fieldSyms != null)</a>
<span class="sourceLineNo">7968</span><a id="line.7968">                        {</a>
<span class="sourceLineNo">7969</span><a id="line.7969">                        IPersistentMap fmap = PersistentHashMap.EMPTY;</a>
<span class="sourceLineNo">7970</span><a id="line.7970">                        Object[] closesvec = new Object[2 * fieldSyms.count()];</a>
<span class="sourceLineNo">7971</span><a id="line.7971">                        for(int i=0;i&lt;fieldSyms.count();i++)</a>
<span class="sourceLineNo">7972</span><a id="line.7972">                                {</a>
<span class="sourceLineNo">7973</span><a id="line.7973">                                Symbol sym = (Symbol) fieldSyms.nth(i);</a>
<span class="sourceLineNo">7974</span><a id="line.7974">                                LocalBinding lb = new LocalBinding(-1, sym, null,</a>
<span class="sourceLineNo">7975</span><a id="line.7975">                                                                   new MethodParamExpr(tagClass(tagOf(sym))),false,null);</a>
<span class="sourceLineNo">7976</span><a id="line.7976">                                fmap = fmap.assoc(sym, lb);</a>
<span class="sourceLineNo">7977</span><a id="line.7977">                                closesvec[i*2] = lb;</a>
<span class="sourceLineNo">7978</span><a id="line.7978">                                closesvec[i*2 + 1] = lb;</a>
<span class="sourceLineNo">7979</span><a id="line.7979">                                }</a>
<span class="sourceLineNo">7980</span><a id="line.7980"></a>
<span class="sourceLineNo">7981</span><a id="line.7981">                        //todo - inject __meta et al into closes - when?</a>
<span class="sourceLineNo">7982</span><a id="line.7982">                        //use array map to preserve ctor order</a>
<span class="sourceLineNo">7983</span><a id="line.7983">                        ret.closes = new PersistentArrayMap(closesvec);</a>
<span class="sourceLineNo">7984</span><a id="line.7984">                        ret.fields = fmap;</a>
<span class="sourceLineNo">7985</span><a id="line.7985">                        for(int i=fieldSyms.count()-1;i &gt;= 0 &amp;&amp; (((Symbol)fieldSyms.nth(i)).name.equals("__meta")</a>
<span class="sourceLineNo">7986</span><a id="line.7986">                                                     || ((Symbol)fieldSyms.nth(i)).name.equals("__extmap")</a>
<span class="sourceLineNo">7987</span><a id="line.7987">                                                     || ((Symbol)fieldSyms.nth(i)).name.equals("__hash")</a>
<span class="sourceLineNo">7988</span><a id="line.7988">                                                     || ((Symbol)fieldSyms.nth(i)).name.equals("__hasheq")</a>
<span class="sourceLineNo">7989</span><a id="line.7989">                                                     );--i)</a>
<span class="sourceLineNo">7990</span><a id="line.7990">                                ret.altCtorDrops++;</a>
<span class="sourceLineNo">7991</span><a id="line.7991">                        }</a>
<span class="sourceLineNo">7992</span><a id="line.7992">                //todo - set up volatiles</a>
<span class="sourceLineNo">7993</span><a id="line.7993">//              ret.volatiles = PersistentHashSet.create(RT.seq(RT.get(ret.optionsMap, volatileKey)));</a>
<span class="sourceLineNo">7994</span><a id="line.7994"></a>
<span class="sourceLineNo">7995</span><a id="line.7995">                PersistentVector interfaces = PersistentVector.EMPTY;</a>
<span class="sourceLineNo">7996</span><a id="line.7996">                for(ISeq s = RT.seq(interfaceSyms);s!=null;s = s.next())</a>
<span class="sourceLineNo">7997</span><a id="line.7997">                        {</a>
<span class="sourceLineNo">7998</span><a id="line.7998">                        Class c = (Class) resolve((Symbol) s.first());</a>
<span class="sourceLineNo">7999</span><a id="line.7999">                        if(!c.isInterface())</a>
<span class="sourceLineNo">8000</span><a id="line.8000">                                throw new IllegalArgumentException("only interfaces are supported, had: " + c.getName());</a>
<span class="sourceLineNo">8001</span><a id="line.8001">                        interfaces = interfaces.cons(c);</a>
<span class="sourceLineNo">8002</span><a id="line.8002">                        }</a>
<span class="sourceLineNo">8003</span><a id="line.8003">                Class superClass = Object.class;</a>
<span class="sourceLineNo">8004</span><a id="line.8004">                Map[] mc = gatherMethods(superClass,RT.seq(interfaces));</a>
<span class="sourceLineNo">8005</span><a id="line.8005">                Map overrideables = mc[0];</a>
<span class="sourceLineNo">8006</span><a id="line.8006">                Map covariants = mc[1];</a>
<span class="sourceLineNo">8007</span><a id="line.8007">                ret.mmap = overrideables;</a>
<span class="sourceLineNo">8008</span><a id="line.8008">                ret.covariants = covariants;</a>
<span class="sourceLineNo">8009</span><a id="line.8009">                </a>
<span class="sourceLineNo">8010</span><a id="line.8010">                String[] inames = interfaceNames(interfaces);</a>
<span class="sourceLineNo">8011</span><a id="line.8011"></a>
<span class="sourceLineNo">8012</span><a id="line.8012">                Class stub = compileStub(slashname(superClass),ret, inames, frm);</a>
<span class="sourceLineNo">8013</span><a id="line.8013">                Symbol thistag = Symbol.intern(null,stub.getName());</a>
<span class="sourceLineNo">8014</span><a id="line.8014"></a>
<span class="sourceLineNo">8015</span><a id="line.8015">                try</a>
<span class="sourceLineNo">8016</span><a id="line.8016">                        {</a>
<span class="sourceLineNo">8017</span><a id="line.8017">                        Var.pushThreadBindings(</a>
<span class="sourceLineNo">8018</span><a id="line.8018">                                        RT.mapUniqueKeys(CONSTANTS, PersistentVector.EMPTY,</a>
<span class="sourceLineNo">8019</span><a id="line.8019">                                               CONSTANT_IDS, new IdentityHashMap(),</a>
<span class="sourceLineNo">8020</span><a id="line.8020">                                               KEYWORDS, PersistentHashMap.EMPTY,</a>
<span class="sourceLineNo">8021</span><a id="line.8021">                                               VARS, PersistentHashMap.EMPTY,</a>
<span class="sourceLineNo">8022</span><a id="line.8022">                                               KEYWORD_CALLSITES, PersistentVector.EMPTY,</a>
<span class="sourceLineNo">8023</span><a id="line.8023">                                               PROTOCOL_CALLSITES, PersistentVector.EMPTY,</a>
<span class="sourceLineNo">8024</span><a id="line.8024">                                               VAR_CALLSITES, emptyVarCallSites(),</a>
<span class="sourceLineNo">8025</span><a id="line.8025">                                               NO_RECUR, null));</a>
<span class="sourceLineNo">8026</span><a id="line.8026">                        if(ret.isDeftype())</a>
<span class="sourceLineNo">8027</span><a id="line.8027">                                {</a>
<span class="sourceLineNo">8028</span><a id="line.8028">                                Var.pushThreadBindings(RT.mapUniqueKeys(METHOD, null,</a>
<span class="sourceLineNo">8029</span><a id="line.8029">                                                              LOCAL_ENV, ret.fields</a>
<span class="sourceLineNo">8030</span><a id="line.8030">                                                , COMPILE_STUB_SYM, Symbol.intern(null, tagName)</a>
<span class="sourceLineNo">8031</span><a id="line.8031">                                                , COMPILE_STUB_CLASS, stub));</a>
<span class="sourceLineNo">8032</span><a id="line.8032"></a>
<span class="sourceLineNo">8033</span><a id="line.8033">                                ret.hintedFields = RT.subvec(fieldSyms, 0, fieldSyms.count() - ret.altCtorDrops);</a>
<span class="sourceLineNo">8034</span><a id="line.8034">                                }</a>
<span class="sourceLineNo">8035</span><a id="line.8035"></a>
<span class="sourceLineNo">8036</span><a id="line.8036">                        //now (methodname [args] body)*</a>
<span class="sourceLineNo">8037</span><a id="line.8037">                        ret.line = lineDeref();</a>
<span class="sourceLineNo">8038</span><a id="line.8038">                        ret.column = columnDeref();</a>
<span class="sourceLineNo">8039</span><a id="line.8039">                        IPersistentCollection methods = null;</a>
<span class="sourceLineNo">8040</span><a id="line.8040">                        for(ISeq s = methodForms; s != null; s = RT.next(s))</a>
<span class="sourceLineNo">8041</span><a id="line.8041">                                {</a>
<span class="sourceLineNo">8042</span><a id="line.8042">                                NewInstanceMethod m = NewInstanceMethod.parse(ret, (ISeq) RT.first(s),thistag, overrideables);</a>
<span class="sourceLineNo">8043</span><a id="line.8043">                                methods = RT.conj(methods, m);</a>
<span class="sourceLineNo">8044</span><a id="line.8044">                                }</a>
<span class="sourceLineNo">8045</span><a id="line.8045"></a>
<span class="sourceLineNo">8046</span><a id="line.8046"></a>
<span class="sourceLineNo">8047</span><a id="line.8047">                        ret.methods = methods;</a>
<span class="sourceLineNo">8048</span><a id="line.8048">                        ret.keywords = (IPersistentMap) KEYWORDS.deref();</a>
<span class="sourceLineNo">8049</span><a id="line.8049">                        ret.vars = (IPersistentMap) VARS.deref();</a>
<span class="sourceLineNo">8050</span><a id="line.8050">                        ret.constants = (PersistentVector) CONSTANTS.deref();</a>
<span class="sourceLineNo">8051</span><a id="line.8051">                        ret.constantsID = RT.nextID();</a>
<span class="sourceLineNo">8052</span><a id="line.8052">                        ret.keywordCallsites = (IPersistentVector) KEYWORD_CALLSITES.deref();</a>
<span class="sourceLineNo">8053</span><a id="line.8053">                        ret.protocolCallsites = (IPersistentVector) PROTOCOL_CALLSITES.deref();</a>
<span class="sourceLineNo">8054</span><a id="line.8054">                        ret.varCallsites = (IPersistentSet) VAR_CALLSITES.deref();</a>
<span class="sourceLineNo">8055</span><a id="line.8055">                        }</a>
<span class="sourceLineNo">8056</span><a id="line.8056">                finally</a>
<span class="sourceLineNo">8057</span><a id="line.8057">                        {</a>
<span class="sourceLineNo">8058</span><a id="line.8058">                        if(ret.isDeftype())</a>
<span class="sourceLineNo">8059</span><a id="line.8059">                                Var.popThreadBindings();</a>
<span class="sourceLineNo">8060</span><a id="line.8060">                        Var.popThreadBindings();</a>
<span class="sourceLineNo">8061</span><a id="line.8061">                        }</a>
<span class="sourceLineNo">8062</span><a id="line.8062"></a>
<span class="sourceLineNo">8063</span><a id="line.8063">                try</a>
<span class="sourceLineNo">8064</span><a id="line.8064">                        {</a>
<span class="sourceLineNo">8065</span><a id="line.8065">                        ret.compile(slashname(superClass),inames,false);</a>
<span class="sourceLineNo">8066</span><a id="line.8066">                        }</a>
<span class="sourceLineNo">8067</span><a id="line.8067">                catch(IOException e)</a>
<span class="sourceLineNo">8068</span><a id="line.8068">                        {</a>
<span class="sourceLineNo">8069</span><a id="line.8069">                        throw Util.sneakyThrow(e);</a>
<span class="sourceLineNo">8070</span><a id="line.8070">                        }</a>
<span class="sourceLineNo">8071</span><a id="line.8071">                ret.getCompiledClass();</a>
<span class="sourceLineNo">8072</span><a id="line.8072">                return ret;</a>
<span class="sourceLineNo">8073</span><a id="line.8073">                }</a>
<span class="sourceLineNo">8074</span><a id="line.8074"></a>
<span class="sourceLineNo">8075</span><a id="line.8075">        /***</a>
<span class="sourceLineNo">8076</span><a id="line.8076">         * Current host interop uses reflection, which requires pre-existing classes</a>
<span class="sourceLineNo">8077</span><a id="line.8077">         * Work around this by:</a>
<span class="sourceLineNo">8078</span><a id="line.8078">         * Generate a stub class that has the same interfaces and fields as the class we are generating.</a>
<span class="sourceLineNo">8079</span><a id="line.8079">         * Use it as a type hint for this, and bind the simple name of the class to this stub (in resolve etc)</a>
<span class="sourceLineNo">8080</span><a id="line.8080">         * Unmunge the name (using a magic prefix) on any code gen for classes</a>
<span class="sourceLineNo">8081</span><a id="line.8081">         */</a>
<span class="sourceLineNo">8082</span><a id="line.8082">        static Class compileStub(String superName, NewInstanceExpr ret, String[] interfaceNames, Object frm){</a>
<span class="sourceLineNo">8083</span><a id="line.8083">            ClassWriter cw = classWriter();</a>
<span class="sourceLineNo">8084</span><a id="line.8084">            ClassVisitor cv = cw;</a>
<span class="sourceLineNo">8085</span><a id="line.8085">                cv.visit(V1_8, ACC_PUBLIC + ACC_SUPER, COMPILE_STUB_PREFIX + "/" + ret.internalName,</a>
<span class="sourceLineNo">8086</span><a id="line.8086">                         null,superName,interfaceNames);</a>
<span class="sourceLineNo">8087</span><a id="line.8087"></a>
<span class="sourceLineNo">8088</span><a id="line.8088">                //instance fields for closed-overs</a>
<span class="sourceLineNo">8089</span><a id="line.8089">                for(ISeq s = RT.keys(ret.closes); s != null; s = s.next())</a>
<span class="sourceLineNo">8090</span><a id="line.8090">                        {</a>
<span class="sourceLineNo">8091</span><a id="line.8091">                        LocalBinding lb = (LocalBinding) s.first();</a>
<span class="sourceLineNo">8092</span><a id="line.8092">                        int access = ACC_PUBLIC + (ret.isVolatile(lb) ? ACC_VOLATILE :</a>
<span class="sourceLineNo">8093</span><a id="line.8093">                                                   ret.isMutable(lb) ? 0 :</a>
<span class="sourceLineNo">8094</span><a id="line.8094">                                                   ACC_FINAL);</a>
<span class="sourceLineNo">8095</span><a id="line.8095">                        if(lb.getPrimitiveType() != null)</a>
<span class="sourceLineNo">8096</span><a id="line.8096">                                cv.visitField(access</a>
<span class="sourceLineNo">8097</span><a id="line.8097">                                                , lb.name, Type.getType(lb.getPrimitiveType()).getDescriptor(),</a>
<span class="sourceLineNo">8098</span><a id="line.8098">                                                          null, null);</a>
<span class="sourceLineNo">8099</span><a id="line.8099">                        else</a>
<span class="sourceLineNo">8100</span><a id="line.8100">                        //todo - when closed-overs are fields, use more specific types here and in ctor and emitLocal?</a>
<span class="sourceLineNo">8101</span><a id="line.8101">                                cv.visitField(access</a>
<span class="sourceLineNo">8102</span><a id="line.8102">                                                , lb.name, OBJECT_TYPE.getDescriptor(), null, null);</a>
<span class="sourceLineNo">8103</span><a id="line.8103">                        }</a>
<span class="sourceLineNo">8104</span><a id="line.8104"></a>
<span class="sourceLineNo">8105</span><a id="line.8105">                //ctor that takes closed-overs and does nothing</a>
<span class="sourceLineNo">8106</span><a id="line.8106">                Method m = new Method("&lt;init&gt;", Type.VOID_TYPE, ret.ctorTypes());</a>
<span class="sourceLineNo">8107</span><a id="line.8107">                GeneratorAdapter ctorgen = new GeneratorAdapter(ACC_PUBLIC,</a>
<span class="sourceLineNo">8108</span><a id="line.8108">                                                                m,</a>
<span class="sourceLineNo">8109</span><a id="line.8109">                                                                null,</a>
<span class="sourceLineNo">8110</span><a id="line.8110">                                                                null,</a>
<span class="sourceLineNo">8111</span><a id="line.8111">                                                                cv);</a>
<span class="sourceLineNo">8112</span><a id="line.8112">                ctorgen.visitCode();</a>
<span class="sourceLineNo">8113</span><a id="line.8113">                ctorgen.loadThis();</a>
<span class="sourceLineNo">8114</span><a id="line.8114">                ctorgen.invokeConstructor(Type.getObjectType(superName), voidctor);</a>
<span class="sourceLineNo">8115</span><a id="line.8115">                ctorgen.returnValue();</a>
<span class="sourceLineNo">8116</span><a id="line.8116">                ctorgen.endMethod();</a>
<span class="sourceLineNo">8117</span><a id="line.8117"></a>
<span class="sourceLineNo">8118</span><a id="line.8118">                if(ret.altCtorDrops &gt; 0)</a>
<span class="sourceLineNo">8119</span><a id="line.8119">                        {</a>
<span class="sourceLineNo">8120</span><a id="line.8120">                        Type[] ctorTypes = ret.ctorTypes();</a>
<span class="sourceLineNo">8121</span><a id="line.8121">                        Type[] altCtorTypes = new Type[ctorTypes.length-ret.altCtorDrops];</a>
<span class="sourceLineNo">8122</span><a id="line.8122">                        for(int i=0;i&lt;altCtorTypes.length;i++)</a>
<span class="sourceLineNo">8123</span><a id="line.8123">                                altCtorTypes[i] = ctorTypes[i];</a>
<span class="sourceLineNo">8124</span><a id="line.8124">                        Method alt = new Method("&lt;init&gt;", Type.VOID_TYPE, altCtorTypes);</a>
<span class="sourceLineNo">8125</span><a id="line.8125">                        ctorgen = new GeneratorAdapter(ACC_PUBLIC,</a>
<span class="sourceLineNo">8126</span><a id="line.8126">                                                                                                                        alt,</a>
<span class="sourceLineNo">8127</span><a id="line.8127">                                                                                                                        null,</a>
<span class="sourceLineNo">8128</span><a id="line.8128">                                                                                                                        null,</a>
<span class="sourceLineNo">8129</span><a id="line.8129">                                                                                                                        cv);</a>
<span class="sourceLineNo">8130</span><a id="line.8130">                        ctorgen.visitCode();</a>
<span class="sourceLineNo">8131</span><a id="line.8131">                        ctorgen.loadThis();</a>
<span class="sourceLineNo">8132</span><a id="line.8132">                        ctorgen.loadArgs();</a>
<span class="sourceLineNo">8133</span><a id="line.8133"></a>
<span class="sourceLineNo">8134</span><a id="line.8134">                        ctorgen.visitInsn(Opcodes.ACONST_NULL); //__meta</a>
<span class="sourceLineNo">8135</span><a id="line.8135">                        ctorgen.visitInsn(Opcodes.ACONST_NULL); //__extmap</a>
<span class="sourceLineNo">8136</span><a id="line.8136">                        ctorgen.visitInsn(Opcodes.ICONST_0); //__hash</a>
<span class="sourceLineNo">8137</span><a id="line.8137">                        ctorgen.visitInsn(Opcodes.ICONST_0); //__hasheq</a>
<span class="sourceLineNo">8138</span><a id="line.8138"></a>
<span class="sourceLineNo">8139</span><a id="line.8139">                        ctorgen.invokeConstructor(Type.getObjectType(COMPILE_STUB_PREFIX + "/" + ret.internalName),</a>
<span class="sourceLineNo">8140</span><a id="line.8140">                                                  new Method("&lt;init&gt;", Type.VOID_TYPE, ctorTypes));</a>
<span class="sourceLineNo">8141</span><a id="line.8141"></a>
<span class="sourceLineNo">8142</span><a id="line.8142">                        ctorgen.returnValue();</a>
<span class="sourceLineNo">8143</span><a id="line.8143">                        ctorgen.endMethod();</a>
<span class="sourceLineNo">8144</span><a id="line.8144"></a>
<span class="sourceLineNo">8145</span><a id="line.8145">            // alt ctor no __hash, __hasheq</a>
<span class="sourceLineNo">8146</span><a id="line.8146">                        altCtorTypes = new Type[ctorTypes.length-2];</a>
<span class="sourceLineNo">8147</span><a id="line.8147">                        for(int i=0;i&lt;altCtorTypes.length;i++)</a>
<span class="sourceLineNo">8148</span><a id="line.8148">                                altCtorTypes[i] = ctorTypes[i];</a>
<span class="sourceLineNo">8149</span><a id="line.8149"></a>
<span class="sourceLineNo">8150</span><a id="line.8150">                        alt = new Method("&lt;init&gt;", Type.VOID_TYPE, altCtorTypes);</a>
<span class="sourceLineNo">8151</span><a id="line.8151">                        ctorgen = new GeneratorAdapter(ACC_PUBLIC,</a>
<span class="sourceLineNo">8152</span><a id="line.8152">                                                                                                                        alt,</a>
<span class="sourceLineNo">8153</span><a id="line.8153">                                                                                                                        null,</a>
<span class="sourceLineNo">8154</span><a id="line.8154">                                                                                                                        null,</a>
<span class="sourceLineNo">8155</span><a id="line.8155">                                                                                                                        cv);</a>
<span class="sourceLineNo">8156</span><a id="line.8156">                        ctorgen.visitCode();</a>
<span class="sourceLineNo">8157</span><a id="line.8157">                        ctorgen.loadThis();</a>
<span class="sourceLineNo">8158</span><a id="line.8158">                        ctorgen.loadArgs();</a>
<span class="sourceLineNo">8159</span><a id="line.8159"></a>
<span class="sourceLineNo">8160</span><a id="line.8160">                        ctorgen.visitInsn(Opcodes.ICONST_0); //__hash</a>
<span class="sourceLineNo">8161</span><a id="line.8161">                        ctorgen.visitInsn(Opcodes.ICONST_0); //__hasheq</a>
<span class="sourceLineNo">8162</span><a id="line.8162"></a>
<span class="sourceLineNo">8163</span><a id="line.8163">                        ctorgen.invokeConstructor(Type.getObjectType(COMPILE_STUB_PREFIX + "/" + ret.internalName),</a>
<span class="sourceLineNo">8164</span><a id="line.8164">                                                  new Method("&lt;init&gt;", Type.VOID_TYPE, ctorTypes));</a>
<span class="sourceLineNo">8165</span><a id="line.8165"></a>
<span class="sourceLineNo">8166</span><a id="line.8166">                        ctorgen.returnValue();</a>
<span class="sourceLineNo">8167</span><a id="line.8167">                        ctorgen.endMethod();</a>
<span class="sourceLineNo">8168</span><a id="line.8168">                        }</a>
<span class="sourceLineNo">8169</span><a id="line.8169">                //end of class</a>
<span class="sourceLineNo">8170</span><a id="line.8170">                cv.visitEnd();</a>
<span class="sourceLineNo">8171</span><a id="line.8171"></a>
<span class="sourceLineNo">8172</span><a id="line.8172">                byte[] bytecode = cw.toByteArray();</a>
<span class="sourceLineNo">8173</span><a id="line.8173">                DynamicClassLoader loader = (DynamicClassLoader) LOADER.deref();</a>
<span class="sourceLineNo">8174</span><a id="line.8174">                return loader.defineClass(COMPILE_STUB_PREFIX + "." + ret.name, bytecode, frm);</a>
<span class="sourceLineNo">8175</span><a id="line.8175">        }</a>
<span class="sourceLineNo">8176</span><a id="line.8176"></a>
<span class="sourceLineNo">8177</span><a id="line.8177">        static String[] interfaceNames(IPersistentVector interfaces){</a>
<span class="sourceLineNo">8178</span><a id="line.8178">                int icnt = interfaces.count();</a>
<span class="sourceLineNo">8179</span><a id="line.8179">                String[] inames = icnt &gt; 0 ? new String[icnt] : null;</a>
<span class="sourceLineNo">8180</span><a id="line.8180">                for(int i=0;i&lt;icnt;i++)</a>
<span class="sourceLineNo">8181</span><a id="line.8181">                        inames[i] = slashname((Class) interfaces.nth(i));</a>
<span class="sourceLineNo">8182</span><a id="line.8182">                return inames;</a>
<span class="sourceLineNo">8183</span><a id="line.8183">        }</a>
<span class="sourceLineNo">8184</span><a id="line.8184"></a>
<span class="sourceLineNo">8185</span><a id="line.8185"></a>
<span class="sourceLineNo">8186</span><a id="line.8186">        static String slashname(Class c){</a>
<span class="sourceLineNo">8187</span><a id="line.8187">                return c.getName().replace('.', '/');</a>
<span class="sourceLineNo">8188</span><a id="line.8188">        }</a>
<span class="sourceLineNo">8189</span><a id="line.8189"></a>
<span class="sourceLineNo">8190</span><a id="line.8190">        protected void emitStatics(ClassVisitor cv) {</a>
<span class="sourceLineNo">8191</span><a id="line.8191">                if(this.isDeftype())</a>
<span class="sourceLineNo">8192</span><a id="line.8192">                        {</a>
<span class="sourceLineNo">8193</span><a id="line.8193">                        //getBasis()</a>
<span class="sourceLineNo">8194</span><a id="line.8194">                        Method meth = Method.getMethod("clojure.lang.IPersistentVector getBasis()");</a>
<span class="sourceLineNo">8195</span><a id="line.8195">                        GeneratorAdapter gen = new GeneratorAdapter(ACC_PUBLIC + ACC_STATIC,</a>
<span class="sourceLineNo">8196</span><a id="line.8196">                                                                                                meth,</a>
<span class="sourceLineNo">8197</span><a id="line.8197">                                                                                                null,</a>
<span class="sourceLineNo">8198</span><a id="line.8198">                                                                                                null,</a>
<span class="sourceLineNo">8199</span><a id="line.8199">                                                                                                cv);</a>
<span class="sourceLineNo">8200</span><a id="line.8200">                        emitValue(hintedFields, gen);</a>
<span class="sourceLineNo">8201</span><a id="line.8201">                        gen.returnValue();</a>
<span class="sourceLineNo">8202</span><a id="line.8202">                        gen.endMethod();</a>
<span class="sourceLineNo">8203</span><a id="line.8203"></a>
<span class="sourceLineNo">8204</span><a id="line.8204">                        if (this.isDeftype() &amp;&amp; this.fields.count() &gt; this.hintedFields.count())</a>
<span class="sourceLineNo">8205</span><a id="line.8205">                                {</a>
<span class="sourceLineNo">8206</span><a id="line.8206">                                //create(IPersistentMap)</a>
<span class="sourceLineNo">8207</span><a id="line.8207">                                String className = name.replace('.', '/');</a>
<span class="sourceLineNo">8208</span><a id="line.8208">                                int i = 1;</a>
<span class="sourceLineNo">8209</span><a id="line.8209">                                int fieldCount = hintedFields.count();</a>
<span class="sourceLineNo">8210</span><a id="line.8210"></a>
<span class="sourceLineNo">8211</span><a id="line.8211">                                MethodVisitor mv = cv.visitMethod(ACC_PUBLIC + ACC_STATIC, "create", "(Lclojure/lang/IPersistentMap;)L"+className+";", null, null);</a>
<span class="sourceLineNo">8212</span><a id="line.8212">                                mv.visitCode();</a>
<span class="sourceLineNo">8213</span><a id="line.8213"></a>
<span class="sourceLineNo">8214</span><a id="line.8214">                                for(ISeq s = RT.seq(hintedFields); s!=null; s=s.next(), i++)</a>
<span class="sourceLineNo">8215</span><a id="line.8215">                                        {</a>
<span class="sourceLineNo">8216</span><a id="line.8216">                                        String bName = ((Symbol)s.first()).name;</a>
<span class="sourceLineNo">8217</span><a id="line.8217">                                        Class k = tagClass(tagOf(s.first()));</a>
<span class="sourceLineNo">8218</span><a id="line.8218"></a>
<span class="sourceLineNo">8219</span><a id="line.8219">                                        mv.visitVarInsn(ALOAD, 0);</a>
<span class="sourceLineNo">8220</span><a id="line.8220">                                        mv.visitLdcInsn(bName);</a>
<span class="sourceLineNo">8221</span><a id="line.8221">                                        mv.visitMethodInsn(INVOKESTATIC, "clojure/lang/Keyword", "intern", "(Ljava/lang/String;)Lclojure/lang/Keyword;");</a>
<span class="sourceLineNo">8222</span><a id="line.8222">                                        mv.visitInsn(ACONST_NULL);</a>
<span class="sourceLineNo">8223</span><a id="line.8223">                                        mv.visitMethodInsn(INVOKEINTERFACE, "clojure/lang/IPersistentMap", "valAt", "(Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object;");</a>
<span class="sourceLineNo">8224</span><a id="line.8224">                                        if(k.isPrimitive())</a>
<span class="sourceLineNo">8225</span><a id="line.8225">                                                {</a>
<span class="sourceLineNo">8226</span><a id="line.8226">                                                mv.visitTypeInsn(CHECKCAST, Type.getType(boxClass(k)).getInternalName());</a>
<span class="sourceLineNo">8227</span><a id="line.8227">                                                }</a>
<span class="sourceLineNo">8228</span><a id="line.8228">                                        mv.visitVarInsn(ASTORE, i);</a>
<span class="sourceLineNo">8229</span><a id="line.8229">                                        mv.visitVarInsn(ALOAD, 0);</a>
<span class="sourceLineNo">8230</span><a id="line.8230">                                        mv.visitLdcInsn(bName);</a>
<span class="sourceLineNo">8231</span><a id="line.8231">                                        mv.visitMethodInsn(INVOKESTATIC, "clojure/lang/Keyword", "intern", "(Ljava/lang/String;)Lclojure/lang/Keyword;");</a>
<span class="sourceLineNo">8232</span><a id="line.8232">                                        mv.visitMethodInsn(INVOKEINTERFACE, "clojure/lang/IPersistentMap", "without", "(Ljava/lang/Object;)Lclojure/lang/IPersistentMap;");</a>
<span class="sourceLineNo">8233</span><a id="line.8233">                                        mv.visitVarInsn(ASTORE, 0);</a>
<span class="sourceLineNo">8234</span><a id="line.8234">                                        }</a>
<span class="sourceLineNo">8235</span><a id="line.8235"></a>
<span class="sourceLineNo">8236</span><a id="line.8236">                                mv.visitTypeInsn(Opcodes.NEW, className);</a>
<span class="sourceLineNo">8237</span><a id="line.8237">                                mv.visitInsn(DUP);</a>
<span class="sourceLineNo">8238</span><a id="line.8238"></a>
<span class="sourceLineNo">8239</span><a id="line.8239">                                Method ctor = new Method("&lt;init&gt;", Type.VOID_TYPE, ctorTypes());</a>
<span class="sourceLineNo">8240</span><a id="line.8240"></a>
<span class="sourceLineNo">8241</span><a id="line.8241">                                if(hintedFields.count() &gt; 0)</a>
<span class="sourceLineNo">8242</span><a id="line.8242">                                        for(i=1; i&lt;=fieldCount; i++)</a>
<span class="sourceLineNo">8243</span><a id="line.8243">                                                {</a>
<span class="sourceLineNo">8244</span><a id="line.8244">                                                mv.visitVarInsn(ALOAD, i);</a>
<span class="sourceLineNo">8245</span><a id="line.8245">                                                Class k = tagClass(tagOf(hintedFields.nth(i-1)));</a>
<span class="sourceLineNo">8246</span><a id="line.8246">                                                if(k.isPrimitive())</a>
<span class="sourceLineNo">8247</span><a id="line.8247">                                                        {</a>
<span class="sourceLineNo">8248</span><a id="line.8248">                                                        String b = Type.getType(boxClass(k)).getInternalName();</a>
<span class="sourceLineNo">8249</span><a id="line.8249">                                                        String p = Type.getType(k).getDescriptor();</a>
<span class="sourceLineNo">8250</span><a id="line.8250">                                                        String n = k.getName();</a>
<span class="sourceLineNo">8251</span><a id="line.8251"></a>
<span class="sourceLineNo">8252</span><a id="line.8252">                                                        mv.visitMethodInsn(INVOKEVIRTUAL, b, n+"Value", "()"+p);</a>
<span class="sourceLineNo">8253</span><a id="line.8253">                                                        }</a>
<span class="sourceLineNo">8254</span><a id="line.8254">                                                }</a>
<span class="sourceLineNo">8255</span><a id="line.8255"></a>
<span class="sourceLineNo">8256</span><a id="line.8256">                                mv.visitInsn(ACONST_NULL); //__meta</a>
<span class="sourceLineNo">8257</span><a id="line.8257">                                mv.visitVarInsn(ALOAD, 0); //__extmap</a>
<span class="sourceLineNo">8258</span><a id="line.8258">                                mv.visitMethodInsn(INVOKESTATIC, "clojure/lang/RT", "seqOrElse", "(Ljava/lang/Object;)Ljava/lang/Object;");</a>
<span class="sourceLineNo">8259</span><a id="line.8259">                                mv.visitInsn(ICONST_0); //__hash</a>
<span class="sourceLineNo">8260</span><a id="line.8260">                                mv.visitInsn(ICONST_0); //__hasheq</a>
<span class="sourceLineNo">8261</span><a id="line.8261">                                mv.visitMethodInsn(INVOKESPECIAL, className, "&lt;init&gt;", ctor.getDescriptor());</a>
<span class="sourceLineNo">8262</span><a id="line.8262">                                mv.visitInsn(ARETURN);</a>
<span class="sourceLineNo">8263</span><a id="line.8263">                                mv.visitMaxs(4+fieldCount, 1+fieldCount);</a>
<span class="sourceLineNo">8264</span><a id="line.8264">                                mv.visitEnd();</a>
<span class="sourceLineNo">8265</span><a id="line.8265">                                }</a>
<span class="sourceLineNo">8266</span><a id="line.8266">                        }</a>
<span class="sourceLineNo">8267</span><a id="line.8267">        }</a>
<span class="sourceLineNo">8268</span><a id="line.8268"></a>
<span class="sourceLineNo">8269</span><a id="line.8269">        protected void emitMethods(ClassVisitor cv){</a>
<span class="sourceLineNo">8270</span><a id="line.8270">                for(ISeq s = RT.seq(methods); s != null; s = s.next())</a>
<span class="sourceLineNo">8271</span><a id="line.8271">                        {</a>
<span class="sourceLineNo">8272</span><a id="line.8272">                        ObjMethod method = (ObjMethod) s.first();</a>
<span class="sourceLineNo">8273</span><a id="line.8273">                        method.emit(this, cv);</a>
<span class="sourceLineNo">8274</span><a id="line.8274">                        }</a>
<span class="sourceLineNo">8275</span><a id="line.8275">                //emit bridge methods</a>
<span class="sourceLineNo">8276</span><a id="line.8276">                for(Map.Entry&lt;IPersistentVector,Set&lt;Class&gt;&gt; e : covariants.entrySet())</a>
<span class="sourceLineNo">8277</span><a id="line.8277">                        {</a>
<span class="sourceLineNo">8278</span><a id="line.8278">                        java.lang.reflect.Method m = mmap.get(e.getKey());</a>
<span class="sourceLineNo">8279</span><a id="line.8279">                        Class[] params = m.getParameterTypes();</a>
<span class="sourceLineNo">8280</span><a id="line.8280">                        Type[] argTypes = new Type[params.length];</a>
<span class="sourceLineNo">8281</span><a id="line.8281"></a>
<span class="sourceLineNo">8282</span><a id="line.8282">                        for(int i = 0; i &lt; params.length; i++)</a>
<span class="sourceLineNo">8283</span><a id="line.8283">                                {</a>
<span class="sourceLineNo">8284</span><a id="line.8284">                                argTypes[i] = Type.getType(params[i]);</a>
<span class="sourceLineNo">8285</span><a id="line.8285">                                }</a>
<span class="sourceLineNo">8286</span><a id="line.8286"></a>
<span class="sourceLineNo">8287</span><a id="line.8287">                        Method target = new Method(m.getName(), Type.getType(m.getReturnType()), argTypes);</a>
<span class="sourceLineNo">8288</span><a id="line.8288"></a>
<span class="sourceLineNo">8289</span><a id="line.8289">                        for(Class retType : e.getValue())</a>
<span class="sourceLineNo">8290</span><a id="line.8290">                                {</a>
<span class="sourceLineNo">8291</span><a id="line.8291">                        Method meth = new Method(m.getName(), Type.getType(retType), argTypes);</a>
<span class="sourceLineNo">8292</span><a id="line.8292"></a>
<span class="sourceLineNo">8293</span><a id="line.8293">                                GeneratorAdapter gen = new GeneratorAdapter(ACC_PUBLIC + ACC_BRIDGE,</a>
<span class="sourceLineNo">8294</span><a id="line.8294">                                                            meth,</a>
<span class="sourceLineNo">8295</span><a id="line.8295">                                                            null,</a>
<span class="sourceLineNo">8296</span><a id="line.8296">                                                            //todo don't hardwire this</a>
<span class="sourceLineNo">8297</span><a id="line.8297">                                                            EXCEPTION_TYPES,</a>
<span class="sourceLineNo">8298</span><a id="line.8298">                                                            cv);</a>
<span class="sourceLineNo">8299</span><a id="line.8299">                                gen.visitCode();</a>
<span class="sourceLineNo">8300</span><a id="line.8300">                                gen.loadThis();</a>
<span class="sourceLineNo">8301</span><a id="line.8301">                                gen.loadArgs();</a>
<span class="sourceLineNo">8302</span><a id="line.8302">                                gen.invokeInterface(Type.getType(m.getDeclaringClass()),target);</a>
<span class="sourceLineNo">8303</span><a id="line.8303">                                gen.returnValue();</a>
<span class="sourceLineNo">8304</span><a id="line.8304">                                gen.endMethod();</a>
<span class="sourceLineNo">8305</span><a id="line.8305">                                }</a>
<span class="sourceLineNo">8306</span><a id="line.8306">                        }</a>
<span class="sourceLineNo">8307</span><a id="line.8307">        }</a>
<span class="sourceLineNo">8308</span><a id="line.8308"></a>
<span class="sourceLineNo">8309</span><a id="line.8309">        static public IPersistentVector msig(java.lang.reflect.Method m){</a>
<span class="sourceLineNo">8310</span><a id="line.8310">                return RT.vector(m.getName(), RT.seq(m.getParameterTypes()),m.getReturnType());</a>
<span class="sourceLineNo">8311</span><a id="line.8311">        }</a>
<span class="sourceLineNo">8312</span><a id="line.8312"></a>
<span class="sourceLineNo">8313</span><a id="line.8313">        static void considerMethod(java.lang.reflect.Method m, Map mm){</a>
<span class="sourceLineNo">8314</span><a id="line.8314">                IPersistentVector mk = msig(m);</a>
<span class="sourceLineNo">8315</span><a id="line.8315">                int mods = m.getModifiers();</a>
<span class="sourceLineNo">8316</span><a id="line.8316"></a>
<span class="sourceLineNo">8317</span><a id="line.8317">                if(!(mm.containsKey(mk)</a>
<span class="sourceLineNo">8318</span><a id="line.8318">                    || !(Modifier.isPublic(mods) || Modifier.isProtected(mods))</a>
<span class="sourceLineNo">8319</span><a id="line.8319">                    || Modifier.isStatic(mods)</a>
<span class="sourceLineNo">8320</span><a id="line.8320">                    || Modifier.isFinal(mods)))</a>
<span class="sourceLineNo">8321</span><a id="line.8321">                        {</a>
<span class="sourceLineNo">8322</span><a id="line.8322">                                mm.put(mk, m);</a>
<span class="sourceLineNo">8323</span><a id="line.8323">                        }</a>
<span class="sourceLineNo">8324</span><a id="line.8324">        }</a>
<span class="sourceLineNo">8325</span><a id="line.8325"></a>
<span class="sourceLineNo">8326</span><a id="line.8326">        static void gatherMethods(Class c, Map mm){</a>
<span class="sourceLineNo">8327</span><a id="line.8327">                for(; c != null; c = c.getSuperclass())</a>
<span class="sourceLineNo">8328</span><a id="line.8328">                        {</a>
<span class="sourceLineNo">8329</span><a id="line.8329">                        for(java.lang.reflect.Method m : c.getDeclaredMethods())</a>
<span class="sourceLineNo">8330</span><a id="line.8330">                                considerMethod(m, mm);</a>
<span class="sourceLineNo">8331</span><a id="line.8331">                        for(java.lang.reflect.Method m : c.getMethods())</a>
<span class="sourceLineNo">8332</span><a id="line.8332">                                considerMethod(m, mm);</a>
<span class="sourceLineNo">8333</span><a id="line.8333">                        }</a>
<span class="sourceLineNo">8334</span><a id="line.8334">        }</a>
<span class="sourceLineNo">8335</span><a id="line.8335"></a>
<span class="sourceLineNo">8336</span><a id="line.8336">        static public Map[] gatherMethods(Class sc, ISeq interfaces){</a>
<span class="sourceLineNo">8337</span><a id="line.8337">                Map allm = new HashMap();</a>
<span class="sourceLineNo">8338</span><a id="line.8338">                gatherMethods(sc, allm);</a>
<span class="sourceLineNo">8339</span><a id="line.8339">                for(; interfaces != null; interfaces = interfaces.next())</a>
<span class="sourceLineNo">8340</span><a id="line.8340">                        gatherMethods((Class) interfaces.first(), allm);</a>
<span class="sourceLineNo">8341</span><a id="line.8341"></a>
<span class="sourceLineNo">8342</span><a id="line.8342">                Map&lt;IPersistentVector,java.lang.reflect.Method&gt; mm = new HashMap&lt;IPersistentVector,java.lang.reflect.Method&gt;();</a>
<span class="sourceLineNo">8343</span><a id="line.8343">                Map&lt;IPersistentVector,Set&lt;Class&gt;&gt; covariants = new HashMap&lt;IPersistentVector,Set&lt;Class&gt;&gt;();</a>
<span class="sourceLineNo">8344</span><a id="line.8344">                for(Object o : allm.entrySet())</a>
<span class="sourceLineNo">8345</span><a id="line.8345">                        {</a>
<span class="sourceLineNo">8346</span><a id="line.8346">                        Map.Entry e = (Map.Entry) o;</a>
<span class="sourceLineNo">8347</span><a id="line.8347">                        IPersistentVector mk = (IPersistentVector) e.getKey();</a>
<span class="sourceLineNo">8348</span><a id="line.8348">                        mk = (IPersistentVector) mk.pop();</a>
<span class="sourceLineNo">8349</span><a id="line.8349">                        java.lang.reflect.Method m = (java.lang.reflect.Method) e.getValue();</a>
<span class="sourceLineNo">8350</span><a id="line.8350">                        if(mm.containsKey(mk)) //covariant return</a>
<span class="sourceLineNo">8351</span><a id="line.8351">                                {</a>
<span class="sourceLineNo">8352</span><a id="line.8352">                                Set&lt;Class&gt; cvs = covariants.get(mk);</a>
<span class="sourceLineNo">8353</span><a id="line.8353">                                if(cvs == null)</a>
<span class="sourceLineNo">8354</span><a id="line.8354">                                        {</a>
<span class="sourceLineNo">8355</span><a id="line.8355">                                        cvs = new HashSet&lt;Class&gt;();</a>
<span class="sourceLineNo">8356</span><a id="line.8356">                                        covariants.put(mk,cvs);</a>
<span class="sourceLineNo">8357</span><a id="line.8357">                                        }</a>
<span class="sourceLineNo">8358</span><a id="line.8358">                                java.lang.reflect.Method om = mm.get(mk);</a>
<span class="sourceLineNo">8359</span><a id="line.8359">                                if(om.getReturnType().isAssignableFrom(m.getReturnType()))</a>
<span class="sourceLineNo">8360</span><a id="line.8360">                                        {</a>
<span class="sourceLineNo">8361</span><a id="line.8361">                                        cvs.add(om.getReturnType());</a>
<span class="sourceLineNo">8362</span><a id="line.8362">                                        mm.put(mk, m);</a>
<span class="sourceLineNo">8363</span><a id="line.8363">                                        }</a>
<span class="sourceLineNo">8364</span><a id="line.8364">                                else</a>
<span class="sourceLineNo">8365</span><a id="line.8365">                                        cvs.add(m.getReturnType());</a>
<span class="sourceLineNo">8366</span><a id="line.8366">                                }</a>
<span class="sourceLineNo">8367</span><a id="line.8367">                        else</a>
<span class="sourceLineNo">8368</span><a id="line.8368">                                mm.put(mk, m);</a>
<span class="sourceLineNo">8369</span><a id="line.8369">                        }</a>
<span class="sourceLineNo">8370</span><a id="line.8370">                return new Map[]{mm,covariants};</a>
<span class="sourceLineNo">8371</span><a id="line.8371">        }</a>
<span class="sourceLineNo">8372</span><a id="line.8372">}</a>
<span class="sourceLineNo">8373</span><a id="line.8373"></a>
<span class="sourceLineNo">8374</span><a id="line.8374">public static class NewInstanceMethod extends ObjMethod{</a>
<span class="sourceLineNo">8375</span><a id="line.8375">        String name;</a>
<span class="sourceLineNo">8376</span><a id="line.8376">        Type[] argTypes;</a>
<span class="sourceLineNo">8377</span><a id="line.8377">        Type retType;</a>
<span class="sourceLineNo">8378</span><a id="line.8378">        Class retClass;</a>
<span class="sourceLineNo">8379</span><a id="line.8379">        Class[] exclasses;</a>
<span class="sourceLineNo">8380</span><a id="line.8380"></a>
<span class="sourceLineNo">8381</span><a id="line.8381">        static Symbol dummyThis = Symbol.intern(null,"dummy_this_dlskjsdfower");</a>
<span class="sourceLineNo">8382</span><a id="line.8382">        private IPersistentVector parms;</a>
<span class="sourceLineNo">8383</span><a id="line.8383"></a>
<span class="sourceLineNo">8384</span><a id="line.8384">        public NewInstanceMethod(ObjExpr objx, ObjMethod parent){</a>
<span class="sourceLineNo">8385</span><a id="line.8385">                super(objx, parent);</a>
<span class="sourceLineNo">8386</span><a id="line.8386">        }</a>
<span class="sourceLineNo">8387</span><a id="line.8387"></a>
<span class="sourceLineNo">8388</span><a id="line.8388">        int numParams(){</a>
<span class="sourceLineNo">8389</span><a id="line.8389">                return argLocals.count();</a>
<span class="sourceLineNo">8390</span><a id="line.8390">        }</a>
<span class="sourceLineNo">8391</span><a id="line.8391"></a>
<span class="sourceLineNo">8392</span><a id="line.8392">        String getMethodName(){</a>
<span class="sourceLineNo">8393</span><a id="line.8393">                return name;</a>
<span class="sourceLineNo">8394</span><a id="line.8394">        }</a>
<span class="sourceLineNo">8395</span><a id="line.8395"></a>
<span class="sourceLineNo">8396</span><a id="line.8396">        Type getReturnType(){</a>
<span class="sourceLineNo">8397</span><a id="line.8397">                return retType;</a>
<span class="sourceLineNo">8398</span><a id="line.8398">        }</a>
<span class="sourceLineNo">8399</span><a id="line.8399"></a>
<span class="sourceLineNo">8400</span><a id="line.8400">        Type[] getArgTypes(){</a>
<span class="sourceLineNo">8401</span><a id="line.8401">                return argTypes;</a>
<span class="sourceLineNo">8402</span><a id="line.8402">        }</a>
<span class="sourceLineNo">8403</span><a id="line.8403"></a>
<span class="sourceLineNo">8404</span><a id="line.8404"></a>
<span class="sourceLineNo">8405</span><a id="line.8405"></a>
<span class="sourceLineNo">8406</span><a id="line.8406">        static public IPersistentVector msig(String name,Class[] paramTypes){</a>
<span class="sourceLineNo">8407</span><a id="line.8407">                return RT.vector(name,RT.seq(paramTypes));</a>
<span class="sourceLineNo">8408</span><a id="line.8408">        }</a>
<span class="sourceLineNo">8409</span><a id="line.8409"></a>
<span class="sourceLineNo">8410</span><a id="line.8410">        static NewInstanceMethod parse(ObjExpr objx, ISeq form, Symbol thistag,</a>
<span class="sourceLineNo">8411</span><a id="line.8411">                                       Map overrideables) {</a>
<span class="sourceLineNo">8412</span><a id="line.8412">                //(methodname [this-name args*] body...)</a>
<span class="sourceLineNo">8413</span><a id="line.8413">                //this-name might be nil</a>
<span class="sourceLineNo">8414</span><a id="line.8414">                NewInstanceMethod method = new NewInstanceMethod(objx, (ObjMethod) METHOD.deref());</a>
<span class="sourceLineNo">8415</span><a id="line.8415">                Symbol dotname = (Symbol)RT.first(form);</a>
<span class="sourceLineNo">8416</span><a id="line.8416">                Symbol name = (Symbol) Symbol.intern(null,munge(dotname.name)).withMeta(RT.meta(dotname));</a>
<span class="sourceLineNo">8417</span><a id="line.8417">                IPersistentVector parms = (IPersistentVector) RT.second(form);</a>
<span class="sourceLineNo">8418</span><a id="line.8418">                if(parms.count() == 0)</a>
<span class="sourceLineNo">8419</span><a id="line.8419">                        {</a>
<span class="sourceLineNo">8420</span><a id="line.8420">                        throw new IllegalArgumentException("Must supply at least one argument for 'this' in: " + dotname);</a>
<span class="sourceLineNo">8421</span><a id="line.8421">                        }</a>
<span class="sourceLineNo">8422</span><a id="line.8422">                Symbol thisName = (Symbol) parms.nth(0);</a>
<span class="sourceLineNo">8423</span><a id="line.8423">                parms = RT.subvec(parms,1,parms.count());</a>
<span class="sourceLineNo">8424</span><a id="line.8424">                ISeq body = RT.next(RT.next(form));</a>
<span class="sourceLineNo">8425</span><a id="line.8425">                try</a>
<span class="sourceLineNo">8426</span><a id="line.8426">                        {</a>
<span class="sourceLineNo">8427</span><a id="line.8427">                        method.line = lineDeref();</a>
<span class="sourceLineNo">8428</span><a id="line.8428">                        method.column = columnDeref();</a>
<span class="sourceLineNo">8429</span><a id="line.8429">                        //register as the current method and set up a new env frame</a>
<span class="sourceLineNo">8430</span><a id="line.8430">            PathNode pnode =  new PathNode(PATHTYPE.PATH, (PathNode) CLEAR_PATH.get());</a>
<span class="sourceLineNo">8431</span><a id="line.8431">                        Var.pushThreadBindings(</a>
<span class="sourceLineNo">8432</span><a id="line.8432">                                        RT.mapUniqueKeys(</a>
<span class="sourceLineNo">8433</span><a id="line.8433">                                                        METHOD, method,</a>
<span class="sourceLineNo">8434</span><a id="line.8434">                                                        LOCAL_ENV, LOCAL_ENV.deref(),</a>
<span class="sourceLineNo">8435</span><a id="line.8435">                                                        LOOP_LOCALS, null,</a>
<span class="sourceLineNo">8436</span><a id="line.8436">                                                        NEXT_LOCAL_NUM, 0</a>
<span class="sourceLineNo">8437</span><a id="line.8437">                            ,CLEAR_PATH, pnode</a>
<span class="sourceLineNo">8438</span><a id="line.8438">                            ,CLEAR_ROOT, pnode</a>
<span class="sourceLineNo">8439</span><a id="line.8439">                            ,CLEAR_SITES, PersistentHashMap.EMPTY</a>
<span class="sourceLineNo">8440</span><a id="line.8440">                            ,METHOD_RETURN_CONTEXT, RT.T</a>
<span class="sourceLineNo">8441</span><a id="line.8441">                    ));</a>
<span class="sourceLineNo">8442</span><a id="line.8442"></a>
<span class="sourceLineNo">8443</span><a id="line.8443">                        //register 'this' as local 0</a>
<span class="sourceLineNo">8444</span><a id="line.8444">                        if(thisName != null)</a>
<span class="sourceLineNo">8445</span><a id="line.8445">                                registerLocal((thisName == null) ? dummyThis:thisName,thistag, null,false);</a>
<span class="sourceLineNo">8446</span><a id="line.8446">                        else</a>
<span class="sourceLineNo">8447</span><a id="line.8447">                                getAndIncLocalNum();</a>
<span class="sourceLineNo">8448</span><a id="line.8448"></a>
<span class="sourceLineNo">8449</span><a id="line.8449">                        PersistentVector argLocals = PersistentVector.EMPTY;</a>
<span class="sourceLineNo">8450</span><a id="line.8450">                        method.retClass = tagClass(tagOf(name));</a>
<span class="sourceLineNo">8451</span><a id="line.8451">                        method.argTypes = new Type[parms.count()];</a>
<span class="sourceLineNo">8452</span><a id="line.8452">                        boolean hinted = tagOf(name) != null;</a>
<span class="sourceLineNo">8453</span><a id="line.8453">                        Class[] pclasses = new Class[parms.count()];</a>
<span class="sourceLineNo">8454</span><a id="line.8454">                        Symbol[] psyms = new Symbol[parms.count()];</a>
<span class="sourceLineNo">8455</span><a id="line.8455"></a>
<span class="sourceLineNo">8456</span><a id="line.8456">                        for(int i = 0; i &lt; parms.count(); i++)</a>
<span class="sourceLineNo">8457</span><a id="line.8457">                                {</a>
<span class="sourceLineNo">8458</span><a id="line.8458">                                if(!(parms.nth(i) instanceof Symbol))</a>
<span class="sourceLineNo">8459</span><a id="line.8459">                                        throw new IllegalArgumentException("params must be Symbols");</a>
<span class="sourceLineNo">8460</span><a id="line.8460">                                Symbol p = (Symbol) parms.nth(i);</a>
<span class="sourceLineNo">8461</span><a id="line.8461">                                Object tag = tagOf(p);</a>
<span class="sourceLineNo">8462</span><a id="line.8462">                                if(tag != null)</a>
<span class="sourceLineNo">8463</span><a id="line.8463">                                        hinted = true;</a>
<span class="sourceLineNo">8464</span><a id="line.8464">                                if(p.getNamespace() != null)</a>
<span class="sourceLineNo">8465</span><a id="line.8465">                                        p = Symbol.intern(p.name);</a>
<span class="sourceLineNo">8466</span><a id="line.8466">                                Class pclass = tagClass(tag);</a>
<span class="sourceLineNo">8467</span><a id="line.8467">                                pclasses[i] = pclass;</a>
<span class="sourceLineNo">8468</span><a id="line.8468">                                psyms[i] = p;</a>
<span class="sourceLineNo">8469</span><a id="line.8469">                                }</a>
<span class="sourceLineNo">8470</span><a id="line.8470">                        Map matches = findMethodsWithNameAndArity(name.name, parms.count(), overrideables);</a>
<span class="sourceLineNo">8471</span><a id="line.8471">                        Object mk = msig(name.name, pclasses);</a>
<span class="sourceLineNo">8472</span><a id="line.8472">                        java.lang.reflect.Method m = null;</a>
<span class="sourceLineNo">8473</span><a id="line.8473">                        if(matches.size() &gt; 0)</a>
<span class="sourceLineNo">8474</span><a id="line.8474">                                {</a>
<span class="sourceLineNo">8475</span><a id="line.8475">                                //multiple methods</a>
<span class="sourceLineNo">8476</span><a id="line.8476">                                if(matches.size() &gt; 1)</a>
<span class="sourceLineNo">8477</span><a id="line.8477">                                        {</a>
<span class="sourceLineNo">8478</span><a id="line.8478">                                        //must be hinted and match one method</a>
<span class="sourceLineNo">8479</span><a id="line.8479">                                        if(!hinted)</a>
<span class="sourceLineNo">8480</span><a id="line.8480">                                                throw new IllegalArgumentException("Must hint overloaded method: " + name.name);</a>
<span class="sourceLineNo">8481</span><a id="line.8481">                                        m = (java.lang.reflect.Method) matches.get(mk);</a>
<span class="sourceLineNo">8482</span><a id="line.8482">                                        if(m == null)</a>
<span class="sourceLineNo">8483</span><a id="line.8483">                                                throw new IllegalArgumentException("Can't find matching overloaded method: " + name.name);</a>
<span class="sourceLineNo">8484</span><a id="line.8484">                                        if(m.getReturnType() != method.retClass)</a>
<span class="sourceLineNo">8485</span><a id="line.8485">                                                throw new IllegalArgumentException("Mismatched return type: " + name.name +</a>
<span class="sourceLineNo">8486</span><a id="line.8486">                                                ", expected: " + m.getReturnType().getName()  + ", had: " + method.retClass.getName());</a>
<span class="sourceLineNo">8487</span><a id="line.8487">                                        }</a>
<span class="sourceLineNo">8488</span><a id="line.8488">                                else  //one match</a>
<span class="sourceLineNo">8489</span><a id="line.8489">                                        {</a>
<span class="sourceLineNo">8490</span><a id="line.8490">                                        //if hinted, validate match,</a>
<span class="sourceLineNo">8491</span><a id="line.8491">                                        if(hinted)</a>
<span class="sourceLineNo">8492</span><a id="line.8492">                                                {</a>
<span class="sourceLineNo">8493</span><a id="line.8493">                                                m = (java.lang.reflect.Method) matches.get(mk);</a>
<span class="sourceLineNo">8494</span><a id="line.8494">                                                if(m == null)</a>
<span class="sourceLineNo">8495</span><a id="line.8495">                                                        throw new IllegalArgumentException("Can't find matching method: " + name.name +</a>
<span class="sourceLineNo">8496</span><a id="line.8496">                                                                                           ", leave off hints for auto match.");</a>
<span class="sourceLineNo">8497</span><a id="line.8497">                                                if(m.getReturnType() != method.retClass)</a>
<span class="sourceLineNo">8498</span><a id="line.8498">                                                        throw new IllegalArgumentException("Mismatched return type: " + name.name +</a>
<span class="sourceLineNo">8499</span><a id="line.8499">                                                        ", expected: " + m.getReturnType().getName()  + ", had: " + method.retClass.getName());</a>
<span class="sourceLineNo">8500</span><a id="line.8500">                                                }</a>
<span class="sourceLineNo">8501</span><a id="line.8501">                                        else //adopt found method sig</a>
<span class="sourceLineNo">8502</span><a id="line.8502">                                                {</a>
<span class="sourceLineNo">8503</span><a id="line.8503">                                                m = (java.lang.reflect.Method) matches.values().iterator().next();</a>
<span class="sourceLineNo">8504</span><a id="line.8504">                                                method.retClass = m.getReturnType();</a>
<span class="sourceLineNo">8505</span><a id="line.8505">                                                pclasses = m.getParameterTypes();</a>
<span class="sourceLineNo">8506</span><a id="line.8506">                                                }</a>
<span class="sourceLineNo">8507</span><a id="line.8507">                                        }</a>
<span class="sourceLineNo">8508</span><a id="line.8508">                                }</a>
<span class="sourceLineNo">8509</span><a id="line.8509">//                      else if(findMethodsWithName(name.name,allmethods).size()&gt;0)</a>
<span class="sourceLineNo">8510</span><a id="line.8510">//                              throw new IllegalArgumentException("Can't override/overload method: " + name.name);</a>
<span class="sourceLineNo">8511</span><a id="line.8511">                        else</a>
<span class="sourceLineNo">8512</span><a id="line.8512">                                throw new IllegalArgumentException("Can't define method not in interfaces: " + name.name);</a>
<span class="sourceLineNo">8513</span><a id="line.8513"></a>
<span class="sourceLineNo">8514</span><a id="line.8514">                        //else</a>
<span class="sourceLineNo">8515</span><a id="line.8515">                                //validate unque name+arity among additional methods</a>
<span class="sourceLineNo">8516</span><a id="line.8516"></a>
<span class="sourceLineNo">8517</span><a id="line.8517">                        method.retType = Type.getType(method.retClass);</a>
<span class="sourceLineNo">8518</span><a id="line.8518">                        method.exclasses = m.getExceptionTypes();</a>
<span class="sourceLineNo">8519</span><a id="line.8519"></a>
<span class="sourceLineNo">8520</span><a id="line.8520">                        for(int i = 0; i &lt; parms.count(); i++)</a>
<span class="sourceLineNo">8521</span><a id="line.8521">                                {</a>
<span class="sourceLineNo">8522</span><a id="line.8522">                                LocalBinding lb = registerLocal(psyms[i], null, new MethodParamExpr(pclasses[i]),true);</a>
<span class="sourceLineNo">8523</span><a id="line.8523">                                argLocals = argLocals.assocN(i,lb);</a>
<span class="sourceLineNo">8524</span><a id="line.8524">                                method.argTypes[i] = Type.getType(pclasses[i]);</a>
<span class="sourceLineNo">8525</span><a id="line.8525">                                }</a>
<span class="sourceLineNo">8526</span><a id="line.8526">                        for(int i = 0; i &lt; parms.count(); i++)</a>
<span class="sourceLineNo">8527</span><a id="line.8527">                                {</a>
<span class="sourceLineNo">8528</span><a id="line.8528">                                if(pclasses[i] == long.class || pclasses[i] == double.class)</a>
<span class="sourceLineNo">8529</span><a id="line.8529">                                        getAndIncLocalNum();</a>
<span class="sourceLineNo">8530</span><a id="line.8530">                                }</a>
<span class="sourceLineNo">8531</span><a id="line.8531">                        LOOP_LOCALS.set(argLocals);</a>
<span class="sourceLineNo">8532</span><a id="line.8532">                        method.name = name.name;</a>
<span class="sourceLineNo">8533</span><a id="line.8533">                        method.methodMeta = RT.meta(name);</a>
<span class="sourceLineNo">8534</span><a id="line.8534">                        method.parms = parms;</a>
<span class="sourceLineNo">8535</span><a id="line.8535">                        method.argLocals = argLocals;</a>
<span class="sourceLineNo">8536</span><a id="line.8536">                        method.body = (new BodyExpr.Parser()).parse(C.RETURN, body);</a>
<span class="sourceLineNo">8537</span><a id="line.8537">                        return method;</a>
<span class="sourceLineNo">8538</span><a id="line.8538">                        }</a>
<span class="sourceLineNo">8539</span><a id="line.8539">                finally</a>
<span class="sourceLineNo">8540</span><a id="line.8540">                        {</a>
<span class="sourceLineNo">8541</span><a id="line.8541">                        Var.popThreadBindings();</a>
<span class="sourceLineNo">8542</span><a id="line.8542">                        }</a>
<span class="sourceLineNo">8543</span><a id="line.8543">        }</a>
<span class="sourceLineNo">8544</span><a id="line.8544"></a>
<span class="sourceLineNo">8545</span><a id="line.8545">        private static Map findMethodsWithNameAndArity(String name, int arity, Map mm){</a>
<span class="sourceLineNo">8546</span><a id="line.8546">                Map ret = new HashMap();</a>
<span class="sourceLineNo">8547</span><a id="line.8547">                for(Object o : mm.entrySet())</a>
<span class="sourceLineNo">8548</span><a id="line.8548">                        {</a>
<span class="sourceLineNo">8549</span><a id="line.8549">                        Map.Entry e = (Map.Entry) o;</a>
<span class="sourceLineNo">8550</span><a id="line.8550">                        java.lang.reflect.Method m = (java.lang.reflect.Method) e.getValue();</a>
<span class="sourceLineNo">8551</span><a id="line.8551">                        if(name.equals(m.getName()) &amp;&amp; m.getParameterTypes().length == arity)</a>
<span class="sourceLineNo">8552</span><a id="line.8552">                                ret.put(e.getKey(), e.getValue());</a>
<span class="sourceLineNo">8553</span><a id="line.8553">                        }</a>
<span class="sourceLineNo">8554</span><a id="line.8554">                return ret;</a>
<span class="sourceLineNo">8555</span><a id="line.8555">        }</a>
<span class="sourceLineNo">8556</span><a id="line.8556"></a>
<span class="sourceLineNo">8557</span><a id="line.8557">        private static Map findMethodsWithName(String name, Map mm){</a>
<span class="sourceLineNo">8558</span><a id="line.8558">                Map ret = new HashMap();</a>
<span class="sourceLineNo">8559</span><a id="line.8559">                for(Object o : mm.entrySet())</a>
<span class="sourceLineNo">8560</span><a id="line.8560">                        {</a>
<span class="sourceLineNo">8561</span><a id="line.8561">                        Map.Entry e = (Map.Entry) o;</a>
<span class="sourceLineNo">8562</span><a id="line.8562">                        java.lang.reflect.Method m = (java.lang.reflect.Method) e.getValue();</a>
<span class="sourceLineNo">8563</span><a id="line.8563">                        if(name.equals(m.getName()))</a>
<span class="sourceLineNo">8564</span><a id="line.8564">                                ret.put(e.getKey(), e.getValue());</a>
<span class="sourceLineNo">8565</span><a id="line.8565">                        }</a>
<span class="sourceLineNo">8566</span><a id="line.8566">                return ret;</a>
<span class="sourceLineNo">8567</span><a id="line.8567">        }</a>
<span class="sourceLineNo">8568</span><a id="line.8568"></a>
<span class="sourceLineNo">8569</span><a id="line.8569">        public void emit(ObjExpr obj, ClassVisitor cv){</a>
<span class="sourceLineNo">8570</span><a id="line.8570">                Method m = new Method(getMethodName(), getReturnType(), getArgTypes());</a>
<span class="sourceLineNo">8571</span><a id="line.8571"></a>
<span class="sourceLineNo">8572</span><a id="line.8572">                Type[] extypes = null;</a>
<span class="sourceLineNo">8573</span><a id="line.8573">                if(exclasses.length &gt; 0)</a>
<span class="sourceLineNo">8574</span><a id="line.8574">                        {</a>
<span class="sourceLineNo">8575</span><a id="line.8575">                        extypes = new Type[exclasses.length];</a>
<span class="sourceLineNo">8576</span><a id="line.8576">                        for(int i=0;i&lt;exclasses.length;i++)</a>
<span class="sourceLineNo">8577</span><a id="line.8577">                                extypes[i] = Type.getType(exclasses[i]);</a>
<span class="sourceLineNo">8578</span><a id="line.8578">                        }</a>
<span class="sourceLineNo">8579</span><a id="line.8579">                GeneratorAdapter gen = new GeneratorAdapter(ACC_PUBLIC,</a>
<span class="sourceLineNo">8580</span><a id="line.8580">                                                            m,</a>
<span class="sourceLineNo">8581</span><a id="line.8581">                                                            null,</a>
<span class="sourceLineNo">8582</span><a id="line.8582">                                                            extypes,</a>
<span class="sourceLineNo">8583</span><a id="line.8583">                                                            cv);</a>
<span class="sourceLineNo">8584</span><a id="line.8584">                addAnnotation(gen,methodMeta);</a>
<span class="sourceLineNo">8585</span><a id="line.8585">                for(int i = 0; i &lt; parms.count(); i++)</a>
<span class="sourceLineNo">8586</span><a id="line.8586">                        {</a>
<span class="sourceLineNo">8587</span><a id="line.8587">                        IPersistentMap meta = RT.meta(parms.nth(i));</a>
<span class="sourceLineNo">8588</span><a id="line.8588">                        addParameterAnnotation(gen, meta, i);</a>
<span class="sourceLineNo">8589</span><a id="line.8589">                        }</a>
<span class="sourceLineNo">8590</span><a id="line.8590">                gen.visitCode();</a>
<span class="sourceLineNo">8591</span><a id="line.8591"></a>
<span class="sourceLineNo">8592</span><a id="line.8592">                Label loopLabel = gen.mark();</a>
<span class="sourceLineNo">8593</span><a id="line.8593"></a>
<span class="sourceLineNo">8594</span><a id="line.8594">                gen.visitLineNumber(line, loopLabel);</a>
<span class="sourceLineNo">8595</span><a id="line.8595">                try</a>
<span class="sourceLineNo">8596</span><a id="line.8596">                        {</a>
<span class="sourceLineNo">8597</span><a id="line.8597">                        Var.pushThreadBindings(RT.map(LOOP_LABEL, loopLabel, METHOD, this));</a>
<span class="sourceLineNo">8598</span><a id="line.8598"></a>
<span class="sourceLineNo">8599</span><a id="line.8599">                        emitBody(objx, gen, retClass, body);</a>
<span class="sourceLineNo">8600</span><a id="line.8600">                        Label end = gen.mark();</a>
<span class="sourceLineNo">8601</span><a id="line.8601">                        gen.visitLocalVariable("this", obj.objtype.getDescriptor(), null, loopLabel, end, 0);</a>
<span class="sourceLineNo">8602</span><a id="line.8602">                        for(ISeq lbs = argLocals.seq(); lbs != null; lbs = lbs.next())</a>
<span class="sourceLineNo">8603</span><a id="line.8603">                                {</a>
<span class="sourceLineNo">8604</span><a id="line.8604">                                LocalBinding lb = (LocalBinding) lbs.first();</a>
<span class="sourceLineNo">8605</span><a id="line.8605">                                gen.visitLocalVariable(lb.name, argTypes[lb.idx-1].getDescriptor(), null, loopLabel, end, lb.idx);</a>
<span class="sourceLineNo">8606</span><a id="line.8606">                                }</a>
<span class="sourceLineNo">8607</span><a id="line.8607">                        }</a>
<span class="sourceLineNo">8608</span><a id="line.8608">                finally</a>
<span class="sourceLineNo">8609</span><a id="line.8609">                        {</a>
<span class="sourceLineNo">8610</span><a id="line.8610">                        Var.popThreadBindings();</a>
<span class="sourceLineNo">8611</span><a id="line.8611">                        }</a>
<span class="sourceLineNo">8612</span><a id="line.8612"></a>
<span class="sourceLineNo">8613</span><a id="line.8613">                gen.returnValue();</a>
<span class="sourceLineNo">8614</span><a id="line.8614">                //gen.visitMaxs(1, 1);</a>
<span class="sourceLineNo">8615</span><a id="line.8615">                gen.endMethod();</a>
<span class="sourceLineNo">8616</span><a id="line.8616">        }</a>
<span class="sourceLineNo">8617</span><a id="line.8617">}</a>
<span class="sourceLineNo">8618</span><a id="line.8618"></a>
<span class="sourceLineNo">8619</span><a id="line.8619">    static boolean inty(Class c){</a>
<span class="sourceLineNo">8620</span><a id="line.8620">        return c == int.class</a>
<span class="sourceLineNo">8621</span><a id="line.8621">                || c == short.class</a>
<span class="sourceLineNo">8622</span><a id="line.8622">                || c == byte.class</a>
<span class="sourceLineNo">8623</span><a id="line.8623">                || c == char.class;</a>
<span class="sourceLineNo">8624</span><a id="line.8624">    }</a>
<span class="sourceLineNo">8625</span><a id="line.8625"></a>
<span class="sourceLineNo">8626</span><a id="line.8626">    static Class retType(Class tc, Class ret){</a>
<span class="sourceLineNo">8627</span><a id="line.8627">        if(tc == null)</a>
<span class="sourceLineNo">8628</span><a id="line.8628">            return ret;</a>
<span class="sourceLineNo">8629</span><a id="line.8629">        if(ret == null)</a>
<span class="sourceLineNo">8630</span><a id="line.8630">            return tc;</a>
<span class="sourceLineNo">8631</span><a id="line.8631">        if(ret.isPrimitive() &amp;&amp; tc.isPrimitive()){</a>
<span class="sourceLineNo">8632</span><a id="line.8632">            if((inty(ret) &amp;&amp; inty(tc)) || (ret == tc))</a>
<span class="sourceLineNo">8633</span><a id="line.8633">                return tc;</a>
<span class="sourceLineNo">8634</span><a id="line.8634">            throw new UnsupportedOperationException("Cannot coerce " + ret +</a>
<span class="sourceLineNo">8635</span><a id="line.8635">                                                    " to " + tc + ", use a cast instead");</a>
<span class="sourceLineNo">8636</span><a id="line.8636">            }</a>
<span class="sourceLineNo">8637</span><a id="line.8637">        return tc;</a>
<span class="sourceLineNo">8638</span><a id="line.8638">    }</a>
<span class="sourceLineNo">8639</span><a id="line.8639"></a>
<span class="sourceLineNo">8640</span><a id="line.8640">        static Class primClass(Symbol sym){</a>
<span class="sourceLineNo">8641</span><a id="line.8641">                if(sym == null)</a>
<span class="sourceLineNo">8642</span><a id="line.8642">                        return null;</a>
<span class="sourceLineNo">8643</span><a id="line.8643">                Class c = null;</a>
<span class="sourceLineNo">8644</span><a id="line.8644">                if(sym.name.equals("int"))</a>
<span class="sourceLineNo">8645</span><a id="line.8645">                        c = int.class;</a>
<span class="sourceLineNo">8646</span><a id="line.8646">                else if(sym.name.equals("long"))</a>
<span class="sourceLineNo">8647</span><a id="line.8647">                        c = long.class;</a>
<span class="sourceLineNo">8648</span><a id="line.8648">                else if(sym.name.equals("float"))</a>
<span class="sourceLineNo">8649</span><a id="line.8649">                        c = float.class;</a>
<span class="sourceLineNo">8650</span><a id="line.8650">                else if(sym.name.equals("double"))</a>
<span class="sourceLineNo">8651</span><a id="line.8651">                        c = double.class;</a>
<span class="sourceLineNo">8652</span><a id="line.8652">                else if(sym.name.equals("char"))</a>
<span class="sourceLineNo">8653</span><a id="line.8653">                        c = char.class;</a>
<span class="sourceLineNo">8654</span><a id="line.8654">                else if(sym.name.equals("short"))</a>
<span class="sourceLineNo">8655</span><a id="line.8655">                        c = short.class;</a>
<span class="sourceLineNo">8656</span><a id="line.8656">                else if(sym.name.equals("byte"))</a>
<span class="sourceLineNo">8657</span><a id="line.8657">                        c = byte.class;</a>
<span class="sourceLineNo">8658</span><a id="line.8658">                else if(sym.name.equals("boolean"))</a>
<span class="sourceLineNo">8659</span><a id="line.8659">                        c = boolean.class;</a>
<span class="sourceLineNo">8660</span><a id="line.8660">                else if(sym.name.equals("void"))</a>
<span class="sourceLineNo">8661</span><a id="line.8661">                        c = void.class;</a>
<span class="sourceLineNo">8662</span><a id="line.8662">                return c;</a>
<span class="sourceLineNo">8663</span><a id="line.8663">        }</a>
<span class="sourceLineNo">8664</span><a id="line.8664"></a>
<span class="sourceLineNo">8665</span><a id="line.8665">        static Class tagClass(Object tag) {</a>
<span class="sourceLineNo">8666</span><a id="line.8666">                if(tag == null)</a>
<span class="sourceLineNo">8667</span><a id="line.8667">                        return Object.class;</a>
<span class="sourceLineNo">8668</span><a id="line.8668">                Class c = null;</a>
<span class="sourceLineNo">8669</span><a id="line.8669">                if(tag instanceof Symbol)</a>
<span class="sourceLineNo">8670</span><a id="line.8670">                        c = primClass((Symbol) tag);</a>
<span class="sourceLineNo">8671</span><a id="line.8671">                if(c == null)</a>
<span class="sourceLineNo">8672</span><a id="line.8672">                        c = HostExpr.tagToClass(tag);</a>
<span class="sourceLineNo">8673</span><a id="line.8673">                return c;</a>
<span class="sourceLineNo">8674</span><a id="line.8674">        }</a>
<span class="sourceLineNo">8675</span><a id="line.8675"></a>
<span class="sourceLineNo">8676</span><a id="line.8676">        static Class primClass(Class c){</a>
<span class="sourceLineNo">8677</span><a id="line.8677">                return c.isPrimitive()?c:Object.class;</a>
<span class="sourceLineNo">8678</span><a id="line.8678">        }</a>
<span class="sourceLineNo">8679</span><a id="line.8679"></a>
<span class="sourceLineNo">8680</span><a id="line.8680">        static Class boxClass(Class p) {</a>
<span class="sourceLineNo">8681</span><a id="line.8681">                if(!p.isPrimitive())</a>
<span class="sourceLineNo">8682</span><a id="line.8682">                        return p;</a>
<span class="sourceLineNo">8683</span><a id="line.8683"></a>
<span class="sourceLineNo">8684</span><a id="line.8684">                Class c = null;</a>
<span class="sourceLineNo">8685</span><a id="line.8685"></a>
<span class="sourceLineNo">8686</span><a id="line.8686">                if(p == Integer.TYPE)</a>
<span class="sourceLineNo">8687</span><a id="line.8687">                        c = Integer.class;</a>
<span class="sourceLineNo">8688</span><a id="line.8688">                else if(p == Long.TYPE)</a>
<span class="sourceLineNo">8689</span><a id="line.8689">                        c = Long.class;</a>
<span class="sourceLineNo">8690</span><a id="line.8690">                else if(p == Float.TYPE)</a>
<span class="sourceLineNo">8691</span><a id="line.8691">                        c = Float.class;</a>
<span class="sourceLineNo">8692</span><a id="line.8692">                else if(p == Double.TYPE)</a>
<span class="sourceLineNo">8693</span><a id="line.8693">                        c = Double.class;</a>
<span class="sourceLineNo">8694</span><a id="line.8694">                else if(p == Character.TYPE)</a>
<span class="sourceLineNo">8695</span><a id="line.8695">                        c = Character.class;</a>
<span class="sourceLineNo">8696</span><a id="line.8696">                else if(p == Short.TYPE)</a>
<span class="sourceLineNo">8697</span><a id="line.8697">                        c = Short.class;</a>
<span class="sourceLineNo">8698</span><a id="line.8698">                else if(p == Byte.TYPE)</a>
<span class="sourceLineNo">8699</span><a id="line.8699">                        c = Byte.class;</a>
<span class="sourceLineNo">8700</span><a id="line.8700">                else if(p == Boolean.TYPE)</a>
<span class="sourceLineNo">8701</span><a id="line.8701">                        c = Boolean.class;</a>
<span class="sourceLineNo">8702</span><a id="line.8702"></a>
<span class="sourceLineNo">8703</span><a id="line.8703">                return c;</a>
<span class="sourceLineNo">8704</span><a id="line.8704">        }</a>
<span class="sourceLineNo">8705</span><a id="line.8705"></a>
<span class="sourceLineNo">8706</span><a id="line.8706">static public class MethodParamExpr implements Expr, MaybePrimitiveExpr{</a>
<span class="sourceLineNo">8707</span><a id="line.8707">        final Class c;</a>
<span class="sourceLineNo">8708</span><a id="line.8708"></a>
<span class="sourceLineNo">8709</span><a id="line.8709">        public MethodParamExpr(Class c){</a>
<span class="sourceLineNo">8710</span><a id="line.8710">                this.c = c;</a>
<span class="sourceLineNo">8711</span><a id="line.8711">        }</a>
<span class="sourceLineNo">8712</span><a id="line.8712"></a>
<span class="sourceLineNo">8713</span><a id="line.8713">        public Object eval() {</a>
<span class="sourceLineNo">8714</span><a id="line.8714">                throw Util.runtimeException("Can't eval");</a>
<span class="sourceLineNo">8715</span><a id="line.8715">        }</a>
<span class="sourceLineNo">8716</span><a id="line.8716"></a>
<span class="sourceLineNo">8717</span><a id="line.8717">        public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">8718</span><a id="line.8718">                throw Util.runtimeException("Can't emit");</a>
<span class="sourceLineNo">8719</span><a id="line.8719">        }</a>
<span class="sourceLineNo">8720</span><a id="line.8720"></a>
<span class="sourceLineNo">8721</span><a id="line.8721">        public boolean hasJavaClass() {</a>
<span class="sourceLineNo">8722</span><a id="line.8722">                return c != null;</a>
<span class="sourceLineNo">8723</span><a id="line.8723">        }</a>
<span class="sourceLineNo">8724</span><a id="line.8724"></a>
<span class="sourceLineNo">8725</span><a id="line.8725">        public Class getJavaClass() {</a>
<span class="sourceLineNo">8726</span><a id="line.8726">                return c;</a>
<span class="sourceLineNo">8727</span><a id="line.8727">        }</a>
<span class="sourceLineNo">8728</span><a id="line.8728"></a>
<span class="sourceLineNo">8729</span><a id="line.8729">        public boolean canEmitPrimitive(){</a>
<span class="sourceLineNo">8730</span><a id="line.8730">                return Util.isPrimitive(c);</a>
<span class="sourceLineNo">8731</span><a id="line.8731">        }</a>
<span class="sourceLineNo">8732</span><a id="line.8732"></a>
<span class="sourceLineNo">8733</span><a id="line.8733">        public void emitUnboxed(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">8734</span><a id="line.8734">                throw Util.runtimeException("Can't emit");</a>
<span class="sourceLineNo">8735</span><a id="line.8735">        }</a>
<span class="sourceLineNo">8736</span><a id="line.8736">}</a>
<span class="sourceLineNo">8737</span><a id="line.8737"></a>
<span class="sourceLineNo">8738</span><a id="line.8738">public static class CaseExpr implements Expr, MaybePrimitiveExpr{</a>
<span class="sourceLineNo">8739</span><a id="line.8739">        public final LocalBindingExpr expr;</a>
<span class="sourceLineNo">8740</span><a id="line.8740">        public final int shift, mask, low, high;</a>
<span class="sourceLineNo">8741</span><a id="line.8741">        public final Expr defaultExpr;</a>
<span class="sourceLineNo">8742</span><a id="line.8742">        public final SortedMap&lt;Integer,Expr&gt; tests;</a>
<span class="sourceLineNo">8743</span><a id="line.8743">        public final HashMap&lt;Integer,Expr&gt; thens;</a>
<span class="sourceLineNo">8744</span><a id="line.8744">        public final Keyword switchType;</a>
<span class="sourceLineNo">8745</span><a id="line.8745">        public final Keyword testType;</a>
<span class="sourceLineNo">8746</span><a id="line.8746">        public final Set&lt;Integer&gt; skipCheck;</a>
<span class="sourceLineNo">8747</span><a id="line.8747">        public final Class returnType;</a>
<span class="sourceLineNo">8748</span><a id="line.8748">        public final int line;</a>
<span class="sourceLineNo">8749</span><a id="line.8749">        public final int column;</a>
<span class="sourceLineNo">8750</span><a id="line.8750"></a>
<span class="sourceLineNo">8751</span><a id="line.8751">        final static Type NUMBER_TYPE = Type.getType(Number.class);</a>
<span class="sourceLineNo">8752</span><a id="line.8752">        final static Method intValueMethod = Method.getMethod("int intValue()");</a>
<span class="sourceLineNo">8753</span><a id="line.8753"></a>
<span class="sourceLineNo">8754</span><a id="line.8754">        final static Method hashMethod = Method.getMethod("int hash(Object)");</a>
<span class="sourceLineNo">8755</span><a id="line.8755">        final static Method hashCodeMethod = Method.getMethod("int hashCode()");</a>
<span class="sourceLineNo">8756</span><a id="line.8756">        final static Method equivMethod = Method.getMethod("boolean equiv(Object, Object)");</a>
<span class="sourceLineNo">8757</span><a id="line.8757">    final static Keyword compactKey = Keyword.intern(null, "compact");</a>
<span class="sourceLineNo">8758</span><a id="line.8758">    final static Keyword sparseKey = Keyword.intern(null, "sparse");</a>
<span class="sourceLineNo">8759</span><a id="line.8759">    final static Keyword hashIdentityKey = Keyword.intern(null, "hash-identity");</a>
<span class="sourceLineNo">8760</span><a id="line.8760">    final static Keyword hashEquivKey = Keyword.intern(null, "hash-equiv");</a>
<span class="sourceLineNo">8761</span><a id="line.8761">    final static Keyword intKey = Keyword.intern(null, "int");</a>
<span class="sourceLineNo">8762</span><a id="line.8762">        //(case* expr shift mask default map&lt;minhash, [test then]&gt; table-type test-type skip-check?)</a>
<span class="sourceLineNo">8763</span><a id="line.8763">        public CaseExpr(int line, int column, LocalBindingExpr expr, int shift, int mask, int low, int high, Expr defaultExpr,</a>
<span class="sourceLineNo">8764</span><a id="line.8764">                SortedMap&lt;Integer,Expr&gt; tests,HashMap&lt;Integer,Expr&gt; thens, Keyword switchType, Keyword testType, Set&lt;Integer&gt; skipCheck){</a>
<span class="sourceLineNo">8765</span><a id="line.8765">                this.expr = expr;</a>
<span class="sourceLineNo">8766</span><a id="line.8766">                this.shift = shift;</a>
<span class="sourceLineNo">8767</span><a id="line.8767">                this.mask = mask;</a>
<span class="sourceLineNo">8768</span><a id="line.8768">                this.low = low;</a>
<span class="sourceLineNo">8769</span><a id="line.8769">                this.high = high;</a>
<span class="sourceLineNo">8770</span><a id="line.8770">                this.defaultExpr = defaultExpr;</a>
<span class="sourceLineNo">8771</span><a id="line.8771">                this.tests = tests;</a>
<span class="sourceLineNo">8772</span><a id="line.8772">                this.thens = thens;</a>
<span class="sourceLineNo">8773</span><a id="line.8773">                this.line = line;</a>
<span class="sourceLineNo">8774</span><a id="line.8774">                this.column = column;</a>
<span class="sourceLineNo">8775</span><a id="line.8775">                if (switchType != compactKey &amp;&amp; switchType != sparseKey)</a>
<span class="sourceLineNo">8776</span><a id="line.8776">                    throw new IllegalArgumentException("Unexpected switch type: "+switchType);</a>
<span class="sourceLineNo">8777</span><a id="line.8777">                this.switchType = switchType;</a>
<span class="sourceLineNo">8778</span><a id="line.8778">        if (testType != intKey &amp;&amp; testType != hashEquivKey &amp;&amp; testType != hashIdentityKey)</a>
<span class="sourceLineNo">8779</span><a id="line.8779">            throw new IllegalArgumentException("Unexpected test type: "+switchType);</a>
<span class="sourceLineNo">8780</span><a id="line.8780">                this.testType = testType;</a>
<span class="sourceLineNo">8781</span><a id="line.8781">                this.skipCheck = skipCheck;</a>
<span class="sourceLineNo">8782</span><a id="line.8782">                Collection&lt;Expr&gt; returns = new ArrayList(thens.values());</a>
<span class="sourceLineNo">8783</span><a id="line.8783">                returns.add(defaultExpr);</a>
<span class="sourceLineNo">8784</span><a id="line.8784">                this.returnType = maybeJavaClass(returns);</a>
<span class="sourceLineNo">8785</span><a id="line.8785">        if(RT.count(skipCheck) &gt; 0 &amp;&amp; RT.booleanCast(RT.WARN_ON_REFLECTION.deref()))</a>
<span class="sourceLineNo">8786</span><a id="line.8786">            {</a>
<span class="sourceLineNo">8787</span><a id="line.8787">            RT.errPrintWriter()</a>
<span class="sourceLineNo">8788</span><a id="line.8788">              .format("Performance warning, %s:%d:%d - hash collision of some case test constants; if selected, those entries will be tested sequentially.\n",</a>
<span class="sourceLineNo">8789</span><a id="line.8789">                      SOURCE_PATH.deref(), line, column);</a>
<span class="sourceLineNo">8790</span><a id="line.8790">            }</a>
<span class="sourceLineNo">8791</span><a id="line.8791">        }</a>
<span class="sourceLineNo">8792</span><a id="line.8792"></a>
<span class="sourceLineNo">8793</span><a id="line.8793">        public boolean hasJavaClass(){</a>
<span class="sourceLineNo">8794</span><a id="line.8794">            return returnType != null;</a>
<span class="sourceLineNo">8795</span><a id="line.8795">        }</a>
<span class="sourceLineNo">8796</span><a id="line.8796"></a>
<span class="sourceLineNo">8797</span><a id="line.8797">        public boolean canEmitPrimitive(){</a>
<span class="sourceLineNo">8798</span><a id="line.8798">        return Util.isPrimitive(returnType);</a>
<span class="sourceLineNo">8799</span><a id="line.8799">        }</a>
<span class="sourceLineNo">8800</span><a id="line.8800"></a>
<span class="sourceLineNo">8801</span><a id="line.8801">        public Class getJavaClass(){</a>
<span class="sourceLineNo">8802</span><a id="line.8802">            return returnType;</a>
<span class="sourceLineNo">8803</span><a id="line.8803">        }</a>
<span class="sourceLineNo">8804</span><a id="line.8804"></a>
<span class="sourceLineNo">8805</span><a id="line.8805">        public Object eval() {</a>
<span class="sourceLineNo">8806</span><a id="line.8806">                throw new UnsupportedOperationException("Can't eval case");</a>
<span class="sourceLineNo">8807</span><a id="line.8807">        }</a>
<span class="sourceLineNo">8808</span><a id="line.8808"></a>
<span class="sourceLineNo">8809</span><a id="line.8809">    public void emit(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">8810</span><a id="line.8810">        doEmit(context, objx, gen, false);</a>
<span class="sourceLineNo">8811</span><a id="line.8811">    }</a>
<span class="sourceLineNo">8812</span><a id="line.8812"></a>
<span class="sourceLineNo">8813</span><a id="line.8813">    public void emitUnboxed(C context, ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">8814</span><a id="line.8814">        doEmit(context, objx, gen, true);</a>
<span class="sourceLineNo">8815</span><a id="line.8815">    }</a>
<span class="sourceLineNo">8816</span><a id="line.8816"></a>
<span class="sourceLineNo">8817</span><a id="line.8817">        public void doEmit(C context, ObjExpr objx, GeneratorAdapter gen, boolean emitUnboxed){</a>
<span class="sourceLineNo">8818</span><a id="line.8818">                Label defaultLabel = gen.newLabel();</a>
<span class="sourceLineNo">8819</span><a id="line.8819">                Label endLabel = gen.newLabel();</a>
<span class="sourceLineNo">8820</span><a id="line.8820">                SortedMap&lt;Integer,Label&gt; labels = new TreeMap();</a>
<span class="sourceLineNo">8821</span><a id="line.8821"></a>
<span class="sourceLineNo">8822</span><a id="line.8822">                for(Integer i : tests.keySet())</a>
<span class="sourceLineNo">8823</span><a id="line.8823">                        {</a>
<span class="sourceLineNo">8824</span><a id="line.8824">                        labels.put(i, gen.newLabel());</a>
<span class="sourceLineNo">8825</span><a id="line.8825">                        }</a>
<span class="sourceLineNo">8826</span><a id="line.8826"></a>
<span class="sourceLineNo">8827</span><a id="line.8827">        gen.visitLineNumber(line, gen.mark());</a>
<span class="sourceLineNo">8828</span><a id="line.8828"></a>
<span class="sourceLineNo">8829</span><a id="line.8829">        Class primExprClass = maybePrimitiveType(expr);</a>
<span class="sourceLineNo">8830</span><a id="line.8830">        Type primExprType = primExprClass == null ? null : Type.getType(primExprClass);</a>
<span class="sourceLineNo">8831</span><a id="line.8831"></a>
<span class="sourceLineNo">8832</span><a id="line.8832">        if (testType == intKey)</a>
<span class="sourceLineNo">8833</span><a id="line.8833">                    emitExprForInts(objx, gen, primExprType, defaultLabel);</a>
<span class="sourceLineNo">8834</span><a id="line.8834">        else</a>
<span class="sourceLineNo">8835</span><a id="line.8835">            emitExprForHashes(objx, gen);</a>
<span class="sourceLineNo">8836</span><a id="line.8836"></a>
<span class="sourceLineNo">8837</span><a id="line.8837">        if (switchType == sparseKey)</a>
<span class="sourceLineNo">8838</span><a id="line.8838">            {</a>
<span class="sourceLineNo">8839</span><a id="line.8839">            Label[] la = new Label[labels.size()];</a>
<span class="sourceLineNo">8840</span><a id="line.8840">            la = labels.values().toArray(la);</a>
<span class="sourceLineNo">8841</span><a id="line.8841">            int[] ints = Numbers.int_array(tests.keySet());</a>
<span class="sourceLineNo">8842</span><a id="line.8842">            gen.visitLookupSwitchInsn(defaultLabel, ints, la);</a>
<span class="sourceLineNo">8843</span><a id="line.8843">            }</a>
<span class="sourceLineNo">8844</span><a id="line.8844">        else</a>
<span class="sourceLineNo">8845</span><a id="line.8845">            {</a>
<span class="sourceLineNo">8846</span><a id="line.8846">            Label[] la = new Label[(high-low)+1];</a>
<span class="sourceLineNo">8847</span><a id="line.8847">            for(int i=low;i&lt;=high;i++)</a>
<span class="sourceLineNo">8848</span><a id="line.8848">                {</a>
<span class="sourceLineNo">8849</span><a id="line.8849">                la[i-low] = labels.containsKey(i) ? labels.get(i) : defaultLabel;</a>
<span class="sourceLineNo">8850</span><a id="line.8850">                }</a>
<span class="sourceLineNo">8851</span><a id="line.8851">            gen.visitTableSwitchInsn(low, high, defaultLabel, la);</a>
<span class="sourceLineNo">8852</span><a id="line.8852">            }</a>
<span class="sourceLineNo">8853</span><a id="line.8853"></a>
<span class="sourceLineNo">8854</span><a id="line.8854">                for(Integer i : labels.keySet())</a>
<span class="sourceLineNo">8855</span><a id="line.8855">                        {</a>
<span class="sourceLineNo">8856</span><a id="line.8856">                        gen.mark(labels.get(i));</a>
<span class="sourceLineNo">8857</span><a id="line.8857">                        if (testType == intKey)</a>
<span class="sourceLineNo">8858</span><a id="line.8858">                            emitThenForInts(objx, gen, primExprType, tests.get(i), thens.get(i), defaultLabel, emitUnboxed);</a>
<span class="sourceLineNo">8859</span><a id="line.8859">                        else if (RT.contains(skipCheck, i) == RT.T)</a>
<span class="sourceLineNo">8860</span><a id="line.8860">                            emitExpr(objx, gen, thens.get(i), emitUnboxed);</a>
<span class="sourceLineNo">8861</span><a id="line.8861">                        else</a>
<span class="sourceLineNo">8862</span><a id="line.8862">                            emitThenForHashes(objx, gen, tests.get(i), thens.get(i), defaultLabel, emitUnboxed);</a>
<span class="sourceLineNo">8863</span><a id="line.8863">                        gen.goTo(endLabel);</a>
<span class="sourceLineNo">8864</span><a id="line.8864">                        }</a>
<span class="sourceLineNo">8865</span><a id="line.8865"></a>
<span class="sourceLineNo">8866</span><a id="line.8866">                gen.mark(defaultLabel);</a>
<span class="sourceLineNo">8867</span><a id="line.8867">                emitExpr(objx, gen, defaultExpr, emitUnboxed);</a>
<span class="sourceLineNo">8868</span><a id="line.8868">                gen.mark(endLabel);</a>
<span class="sourceLineNo">8869</span><a id="line.8869">                if(context == C.STATEMENT)</a>
<span class="sourceLineNo">8870</span><a id="line.8870">                        gen.pop();</a>
<span class="sourceLineNo">8871</span><a id="line.8871">        }</a>
<span class="sourceLineNo">8872</span><a id="line.8872"></a>
<span class="sourceLineNo">8873</span><a id="line.8873">        private boolean isShiftMasked(){</a>
<span class="sourceLineNo">8874</span><a id="line.8874">            return  mask != 0;</a>
<span class="sourceLineNo">8875</span><a id="line.8875">        }</a>
<span class="sourceLineNo">8876</span><a id="line.8876"></a>
<span class="sourceLineNo">8877</span><a id="line.8877">        private void emitShiftMask(GeneratorAdapter gen){</a>
<span class="sourceLineNo">8878</span><a id="line.8878">            if (isShiftMasked())</a>
<span class="sourceLineNo">8879</span><a id="line.8879">                {</a>
<span class="sourceLineNo">8880</span><a id="line.8880">            gen.push(shift);</a>
<span class="sourceLineNo">8881</span><a id="line.8881">            gen.visitInsn(ISHR);</a>
<span class="sourceLineNo">8882</span><a id="line.8882">            gen.push(mask);</a>
<span class="sourceLineNo">8883</span><a id="line.8883">            gen.visitInsn(IAND);</a>
<span class="sourceLineNo">8884</span><a id="line.8884">                }</a>
<span class="sourceLineNo">8885</span><a id="line.8885">        }</a>
<span class="sourceLineNo">8886</span><a id="line.8886"></a>
<span class="sourceLineNo">8887</span><a id="line.8887">    private void emitExprForInts(ObjExpr objx, GeneratorAdapter gen, Type exprType, Label defaultLabel){</a>
<span class="sourceLineNo">8888</span><a id="line.8888">        if (exprType == null)</a>
<span class="sourceLineNo">8889</span><a id="line.8889">            {</a>
<span class="sourceLineNo">8890</span><a id="line.8890">            if(RT.booleanCast(RT.WARN_ON_REFLECTION.deref()))</a>
<span class="sourceLineNo">8891</span><a id="line.8891">                {</a>
<span class="sourceLineNo">8892</span><a id="line.8892">                RT.errPrintWriter()</a>
<span class="sourceLineNo">8893</span><a id="line.8893">                  .format("Performance warning, %s:%d:%d - case has int tests, but tested expression is not primitive.\n",</a>
<span class="sourceLineNo">8894</span><a id="line.8894">                          SOURCE_PATH.deref(), line, column);</a>
<span class="sourceLineNo">8895</span><a id="line.8895">                }</a>
<span class="sourceLineNo">8896</span><a id="line.8896">            expr.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">8897</span><a id="line.8897">            gen.instanceOf(NUMBER_TYPE);</a>
<span class="sourceLineNo">8898</span><a id="line.8898">            gen.ifZCmp(GeneratorAdapter.EQ, defaultLabel);</a>
<span class="sourceLineNo">8899</span><a id="line.8899">            expr.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">8900</span><a id="line.8900">            gen.checkCast(NUMBER_TYPE);</a>
<span class="sourceLineNo">8901</span><a id="line.8901">            gen.invokeVirtual(NUMBER_TYPE, intValueMethod);</a>
<span class="sourceLineNo">8902</span><a id="line.8902">            emitShiftMask(gen);</a>
<span class="sourceLineNo">8903</span><a id="line.8903">            }</a>
<span class="sourceLineNo">8904</span><a id="line.8904">        else if (exprType == Type.LONG_TYPE</a>
<span class="sourceLineNo">8905</span><a id="line.8905">                || exprType == Type.INT_TYPE</a>
<span class="sourceLineNo">8906</span><a id="line.8906">                || exprType == Type.SHORT_TYPE</a>
<span class="sourceLineNo">8907</span><a id="line.8907">                || exprType == Type.BYTE_TYPE)</a>
<span class="sourceLineNo">8908</span><a id="line.8908">            {</a>
<span class="sourceLineNo">8909</span><a id="line.8909">            expr.emitUnboxed(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">8910</span><a id="line.8910">            gen.cast(exprType, Type.INT_TYPE);</a>
<span class="sourceLineNo">8911</span><a id="line.8911">            emitShiftMask(gen);</a>
<span class="sourceLineNo">8912</span><a id="line.8912">            }</a>
<span class="sourceLineNo">8913</span><a id="line.8913">        else</a>
<span class="sourceLineNo">8914</span><a id="line.8914">            {</a>
<span class="sourceLineNo">8915</span><a id="line.8915">            gen.goTo(defaultLabel);</a>
<span class="sourceLineNo">8916</span><a id="line.8916">            }</a>
<span class="sourceLineNo">8917</span><a id="line.8917">    }</a>
<span class="sourceLineNo">8918</span><a id="line.8918"></a>
<span class="sourceLineNo">8919</span><a id="line.8919">    private void emitThenForInts(ObjExpr objx, GeneratorAdapter gen, Type exprType, Expr test, Expr then, Label defaultLabel, boolean emitUnboxed){</a>
<span class="sourceLineNo">8920</span><a id="line.8920">        if (exprType == null)</a>
<span class="sourceLineNo">8921</span><a id="line.8921">            {</a>
<span class="sourceLineNo">8922</span><a id="line.8922">            expr.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">8923</span><a id="line.8923">            test.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">8924</span><a id="line.8924">            gen.invokeStatic(UTIL_TYPE, equivMethod);</a>
<span class="sourceLineNo">8925</span><a id="line.8925">            gen.ifZCmp(GeneratorAdapter.EQ, defaultLabel);</a>
<span class="sourceLineNo">8926</span><a id="line.8926">            emitExpr(objx, gen, then, emitUnboxed);</a>
<span class="sourceLineNo">8927</span><a id="line.8927">            }</a>
<span class="sourceLineNo">8928</span><a id="line.8928">        else if (exprType == Type.LONG_TYPE)</a>
<span class="sourceLineNo">8929</span><a id="line.8929">            {</a>
<span class="sourceLineNo">8930</span><a id="line.8930">            ((NumberExpr)test).emitUnboxed(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">8931</span><a id="line.8931">            expr.emitUnboxed(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">8932</span><a id="line.8932">            gen.ifCmp(Type.LONG_TYPE, GeneratorAdapter.NE, defaultLabel);</a>
<span class="sourceLineNo">8933</span><a id="line.8933">            emitExpr(objx, gen, then, emitUnboxed);</a>
<span class="sourceLineNo">8934</span><a id="line.8934">            }</a>
<span class="sourceLineNo">8935</span><a id="line.8935">        else if (exprType == Type.INT_TYPE</a>
<span class="sourceLineNo">8936</span><a id="line.8936">                || exprType == Type.SHORT_TYPE</a>
<span class="sourceLineNo">8937</span><a id="line.8937">                || exprType == Type.BYTE_TYPE)</a>
<span class="sourceLineNo">8938</span><a id="line.8938">            {</a>
<span class="sourceLineNo">8939</span><a id="line.8939">            if (isShiftMasked())</a>
<span class="sourceLineNo">8940</span><a id="line.8940">                {</a>
<span class="sourceLineNo">8941</span><a id="line.8941">                ((NumberExpr)test).emitUnboxed(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">8942</span><a id="line.8942">                expr.emitUnboxed(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">8943</span><a id="line.8943">                gen.cast(exprType, Type.LONG_TYPE);</a>
<span class="sourceLineNo">8944</span><a id="line.8944">                gen.ifCmp(Type.LONG_TYPE, GeneratorAdapter.NE, defaultLabel);</a>
<span class="sourceLineNo">8945</span><a id="line.8945">                }</a>
<span class="sourceLineNo">8946</span><a id="line.8946">            // else direct match</a>
<span class="sourceLineNo">8947</span><a id="line.8947">            emitExpr(objx, gen, then, emitUnboxed);</a>
<span class="sourceLineNo">8948</span><a id="line.8948">            }</a>
<span class="sourceLineNo">8949</span><a id="line.8949">        else</a>
<span class="sourceLineNo">8950</span><a id="line.8950">            {</a>
<span class="sourceLineNo">8951</span><a id="line.8951">            gen.goTo(defaultLabel);</a>
<span class="sourceLineNo">8952</span><a id="line.8952">            }</a>
<span class="sourceLineNo">8953</span><a id="line.8953">    }</a>
<span class="sourceLineNo">8954</span><a id="line.8954"></a>
<span class="sourceLineNo">8955</span><a id="line.8955">    private void emitExprForHashes(ObjExpr objx, GeneratorAdapter gen){</a>
<span class="sourceLineNo">8956</span><a id="line.8956">        expr.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">8957</span><a id="line.8957">        gen.invokeStatic(UTIL_TYPE,hashMethod);</a>
<span class="sourceLineNo">8958</span><a id="line.8958">        emitShiftMask(gen);</a>
<span class="sourceLineNo">8959</span><a id="line.8959">    }</a>
<span class="sourceLineNo">8960</span><a id="line.8960"></a>
<span class="sourceLineNo">8961</span><a id="line.8961">    private void emitThenForHashes(ObjExpr objx, GeneratorAdapter gen, Expr test, Expr then, Label defaultLabel, boolean emitUnboxed){</a>
<span class="sourceLineNo">8962</span><a id="line.8962">        expr.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">8963</span><a id="line.8963">        test.emit(C.EXPRESSION, objx, gen);</a>
<span class="sourceLineNo">8964</span><a id="line.8964">        if(testType == hashIdentityKey)</a>
<span class="sourceLineNo">8965</span><a id="line.8965">            {</a>
<span class="sourceLineNo">8966</span><a id="line.8966">            gen.visitJumpInsn(IF_ACMPNE, defaultLabel);</a>
<span class="sourceLineNo">8967</span><a id="line.8967">            }</a>
<span class="sourceLineNo">8968</span><a id="line.8968">        else</a>
<span class="sourceLineNo">8969</span><a id="line.8969">            {</a>
<span class="sourceLineNo">8970</span><a id="line.8970">            gen.invokeStatic(UTIL_TYPE, equivMethod);</a>
<span class="sourceLineNo">8971</span><a id="line.8971">            gen.ifZCmp(GeneratorAdapter.EQ, defaultLabel);</a>
<span class="sourceLineNo">8972</span><a id="line.8972">            }</a>
<span class="sourceLineNo">8973</span><a id="line.8973">        emitExpr(objx, gen, then, emitUnboxed);</a>
<span class="sourceLineNo">8974</span><a id="line.8974">    }</a>
<span class="sourceLineNo">8975</span><a id="line.8975"></a>
<span class="sourceLineNo">8976</span><a id="line.8976">    private static void emitExpr(ObjExpr objx, GeneratorAdapter gen, Expr expr, boolean emitUnboxed){</a>
<span class="sourceLineNo">8977</span><a id="line.8977">        if (emitUnboxed &amp;&amp; expr instanceof MaybePrimitiveExpr)</a>
<span class="sourceLineNo">8978</span><a id="line.8978">            ((MaybePrimitiveExpr)expr).emitUnboxed(C.EXPRESSION,objx,gen);</a>
<span class="sourceLineNo">8979</span><a id="line.8979">        else</a>
<span class="sourceLineNo">8980</span><a id="line.8980">            expr.emit(C.EXPRESSION,objx,gen);</a>
<span class="sourceLineNo">8981</span><a id="line.8981">    }</a>
<span class="sourceLineNo">8982</span><a id="line.8982"></a>
<span class="sourceLineNo">8983</span><a id="line.8983"></a>
<span class="sourceLineNo">8984</span><a id="line.8984">        static class Parser implements IParser{</a>
<span class="sourceLineNo">8985</span><a id="line.8985">                //(case* expr shift mask default map&lt;minhash, [test then]&gt; table-type test-type skip-check?)</a>
<span class="sourceLineNo">8986</span><a id="line.8986">                //prepared by case macro and presumed correct</a>
<span class="sourceLineNo">8987</span><a id="line.8987">                //case macro binds actual expr in let so expr is always a local,</a>
<span class="sourceLineNo">8988</span><a id="line.8988">                //no need to worry about multiple evaluation</a>
<span class="sourceLineNo">8989</span><a id="line.8989">                public Expr parse(C context, Object frm) {</a>
<span class="sourceLineNo">8990</span><a id="line.8990">                        ISeq form = (ISeq) frm;</a>
<span class="sourceLineNo">8991</span><a id="line.8991">                        if(context == C.EVAL)</a>
<span class="sourceLineNo">8992</span><a id="line.8992">                                return analyze(context, RT.list(RT.list(FNONCE, PersistentVector.EMPTY, form)));</a>
<span class="sourceLineNo">8993</span><a id="line.8993">                        IPersistentVector args = LazilyPersistentVector.create(form.next());</a>
<span class="sourceLineNo">8994</span><a id="line.8994"></a>
<span class="sourceLineNo">8995</span><a id="line.8995">                        Object exprForm = args.nth(0);</a>
<span class="sourceLineNo">8996</span><a id="line.8996">                        int shift = ((Number)args.nth(1)).intValue();</a>
<span class="sourceLineNo">8997</span><a id="line.8997">                        int mask = ((Number)args.nth(2)).intValue();</a>
<span class="sourceLineNo">8998</span><a id="line.8998">                        Object defaultForm = args.nth(3);</a>
<span class="sourceLineNo">8999</span><a id="line.8999">                        Map caseMap = (Map)args.nth(4);</a>
<span class="sourceLineNo">9000</span><a id="line.9000">                        Keyword switchType = ((Keyword)args.nth(5));</a>
<span class="sourceLineNo">9001</span><a id="line.9001">                        Keyword testType = ((Keyword)args.nth(6));</a>
<span class="sourceLineNo">9002</span><a id="line.9002">                        Set skipCheck = RT.count(args) &lt; 8 ? null : (Set)args.nth(7);</a>
<span class="sourceLineNo">9003</span><a id="line.9003"></a>
<span class="sourceLineNo">9004</span><a id="line.9004">            ISeq keys = RT.keys(caseMap);</a>
<span class="sourceLineNo">9005</span><a id="line.9005">            int low = ((Number)RT.first(keys)).intValue();</a>
<span class="sourceLineNo">9006</span><a id="line.9006">            int high = ((Number)RT.nth(keys, RT.count(keys)-1)).intValue();</a>
<span class="sourceLineNo">9007</span><a id="line.9007"></a>
<span class="sourceLineNo">9008</span><a id="line.9008">            LocalBindingExpr testexpr = (LocalBindingExpr) analyze(C.EXPRESSION, exprForm);</a>
<span class="sourceLineNo">9009</span><a id="line.9009">                        testexpr.shouldClear = false;</a>
<span class="sourceLineNo">9010</span><a id="line.9010"></a>
<span class="sourceLineNo">9011</span><a id="line.9011">            SortedMap&lt;Integer,Expr&gt; tests = new TreeMap();</a>
<span class="sourceLineNo">9012</span><a id="line.9012">            HashMap&lt;Integer,Expr&gt; thens = new HashMap();</a>
<span class="sourceLineNo">9013</span><a id="line.9013"></a>
<span class="sourceLineNo">9014</span><a id="line.9014">            PathNode branch = new PathNode(PATHTYPE.BRANCH, (PathNode) CLEAR_PATH.get());</a>
<span class="sourceLineNo">9015</span><a id="line.9015"></a>
<span class="sourceLineNo">9016</span><a id="line.9016">                        for(Object o : caseMap.entrySet())</a>
<span class="sourceLineNo">9017</span><a id="line.9017">                                {</a>
<span class="sourceLineNo">9018</span><a id="line.9018">                                Map.Entry e = (Map.Entry) o;</a>
<span class="sourceLineNo">9019</span><a id="line.9019">                                Integer minhash = ((Number)e.getKey()).intValue();</a>
<span class="sourceLineNo">9020</span><a id="line.9020">                Object pair = e.getValue(); // [test-val then-expr]</a>
<span class="sourceLineNo">9021</span><a id="line.9021">                Expr testExpr = testType == intKey</a>
<span class="sourceLineNo">9022</span><a id="line.9022">                                    ? NumberExpr.parse(((Number)RT.first(pair)).intValue())</a>
<span class="sourceLineNo">9023</span><a id="line.9023">                                    : new ConstantExpr(RT.first(pair));</a>
<span class="sourceLineNo">9024</span><a id="line.9024">                tests.put(minhash, testExpr);</a>
<span class="sourceLineNo">9025</span><a id="line.9025"></a>
<span class="sourceLineNo">9026</span><a id="line.9026">                Expr thenExpr;</a>
<span class="sourceLineNo">9027</span><a id="line.9027">                try {</a>
<span class="sourceLineNo">9028</span><a id="line.9028">                    Var.pushThreadBindings(</a>
<span class="sourceLineNo">9029</span><a id="line.9029">                            RT.map(CLEAR_PATH, new PathNode(PATHTYPE.PATH,branch)));</a>
<span class="sourceLineNo">9030</span><a id="line.9030">                    thenExpr = analyze(context, RT.second(pair));</a>
<span class="sourceLineNo">9031</span><a id="line.9031">                    }</a>
<span class="sourceLineNo">9032</span><a id="line.9032">                finally{</a>
<span class="sourceLineNo">9033</span><a id="line.9033">                    Var.popThreadBindings();</a>
<span class="sourceLineNo">9034</span><a id="line.9034">                    }</a>
<span class="sourceLineNo">9035</span><a id="line.9035">                                thens.put(minhash, thenExpr);</a>
<span class="sourceLineNo">9036</span><a id="line.9036">                                }</a>
<span class="sourceLineNo">9037</span><a id="line.9037">            </a>
<span class="sourceLineNo">9038</span><a id="line.9038">            Expr defaultExpr;</a>
<span class="sourceLineNo">9039</span><a id="line.9039">            try {</a>
<span class="sourceLineNo">9040</span><a id="line.9040">                Var.pushThreadBindings(</a>
<span class="sourceLineNo">9041</span><a id="line.9041">                        RT.map(CLEAR_PATH, new PathNode(PATHTYPE.PATH,branch)));</a>
<span class="sourceLineNo">9042</span><a id="line.9042">                defaultExpr = analyze(context, args.nth(3));</a>
<span class="sourceLineNo">9043</span><a id="line.9043">                }</a>
<span class="sourceLineNo">9044</span><a id="line.9044">            finally{</a>
<span class="sourceLineNo">9045</span><a id="line.9045">                Var.popThreadBindings();</a>
<span class="sourceLineNo">9046</span><a id="line.9046">                }</a>
<span class="sourceLineNo">9047</span><a id="line.9047"></a>
<span class="sourceLineNo">9048</span><a id="line.9048">            int line = ((Number)LINE.deref()).intValue();</a>
<span class="sourceLineNo">9049</span><a id="line.9049">            int column = ((Number)COLUMN.deref()).intValue();</a>
<span class="sourceLineNo">9050</span><a id="line.9050">                        return new CaseExpr(line, column, testexpr, shift, mask, low, high,</a>
<span class="sourceLineNo">9051</span><a id="line.9051">                                defaultExpr, tests, thens, switchType, testType, skipCheck);</a>
<span class="sourceLineNo">9052</span><a id="line.9052">                }</a>
<span class="sourceLineNo">9053</span><a id="line.9053">        }</a>
<span class="sourceLineNo">9054</span><a id="line.9054">}</a>
<span class="sourceLineNo">9055</span><a id="line.9055"></a>
<span class="sourceLineNo">9056</span><a id="line.9056">static IPersistentCollection emptyVarCallSites(){return PersistentHashSet.EMPTY;}</a>
<span class="sourceLineNo">9057</span><a id="line.9057"></a>
<span class="sourceLineNo">9058</span><a id="line.9058">    static public ClassWriter classWriter() {</a>
<span class="sourceLineNo">9059</span><a id="line.9059">        return new ClassWriter(ClassWriter.COMPUTE_MAXS + ClassWriter.COMPUTE_FRAMES) {</a>
<span class="sourceLineNo">9060</span><a id="line.9060">                        protected String getCommonSuperClass (final String type1, final String type2) {</a>
<span class="sourceLineNo">9061</span><a id="line.9061">                                return "java/lang/Object";</a>
<span class="sourceLineNo">9062</span><a id="line.9062">//                      if (!(type1.equals("java/lang/Object") || type2.equals("java/lang/Object"))) {</a>
<span class="sourceLineNo">9063</span><a id="line.9063">//                                      RT.errPrintWriter()</a>
<span class="sourceLineNo">9064</span><a id="line.9064">//                                                      .format("stack map frame \"%s\" and \"%s\" on %s:%d:%d \n",</a>
<span class="sourceLineNo">9065</span><a id="line.9065">//                                                                      type1, type2,</a>
<span class="sourceLineNo">9066</span><a id="line.9066">//                                                                      SOURCE_PATH.deref(), LINE.deref(), COLUMN.deref());</a>
<span class="sourceLineNo">9067</span><a id="line.9067">//                              }</a>
<span class="sourceLineNo">9068</span><a id="line.9068">                    }</a>
<span class="sourceLineNo">9069</span><a id="line.9069">                };</a>
<span class="sourceLineNo">9070</span><a id="line.9070">    }</a>
<span class="sourceLineNo">9071</span><a id="line.9071">}</a>




























































</pre>
</div>
</main>
</body>
</html>
